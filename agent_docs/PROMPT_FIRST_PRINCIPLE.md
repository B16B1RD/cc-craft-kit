# プロンプトファースト原則

> **最重要**: cc-craft-kit の開発では、「プロンプトで済ませられることはプロンプトで済ませる」が最優先原則です。
>
> スクリプト（.ts）は、Claude Code のツールで実現不可能な場合の**最終手段**です。

## 開発前チェックリスト

**新機能および機能改善を設計・実装する前に、必ずこのチェックリストを確認してください。**

### Step 1: プロンプトで実現できるか確認（まずここから）

以下の**いずれか**に該当する場合、プロンプトベース（.md）で設計・実装してください:

- [ ] ファイル読み書き（Read/Write/Edit ツール）
- [ ] サブエージェント・スキル起動（Task/Skill ツール）
- [ ] Bash コマンド実行（`npm run lint`, `git status` など）
- [ ] ユーザー向けメッセージ表示
- [ ] ステートレスな処理（状態を保持しない）

**1つでも該当すれば、プロンプトベースの設計・実装を選択してください。**

### Step 2: スクリプトが本当に必要か確認（最終手段）

以下に該当し、**かつ**プロンプトで実現不可能な場合のみ、スクリプト（.ts）で設計・実装してください:

- データベース操作（Kysely が必要）
- GitHub API 呼び出し（Octokit が必要）
- イベント駆動処理（EventBus が必要）
- ファイル監視・バックグラウンド処理（Chokidar が必要）

## 判断フローチャート

```text
新機能の設計・実装開始
       │
       ▼
┌─────────────────────────────────────────────────┐
│ Q1: Claude Code のツールで完結できる？          │
│    （Read/Write/Edit/Glob/Grep/Bash/Task/Skill）│
└─────────────────────────────────────────────────┘
       │
   ┌───┴────────┐
  YES           NO
   │            │
   ▼            ▼
┌──────────┐  ┌─────────────────────────────────────┐
│プロンプト│  │ Q2: なぜ完結できない？              │
│ (.md)    │  │                                     │
│          │  │ ・DB操作が必要 → スクリプト(.ts)    │
│ 推奨     │  │ ・GitHub API → スクリプト(.ts)      │
└──────────┘  │ ・EventBus → スクリプト(.ts)        │
              │ ・ファイル監視 → スクリプト(.ts)    │
              │ ・その他 → Q1に戻って再検討         │
              └─────────────────────────────────────┘
```

## Claude Code の機能境界

### Claude Code でできること（プロンプトで実現）

| 機能                 | ツール          | 例                           |
|----------------------|-----------------|------------------------------|
| ファイル読み込み     | Read            | 仕様書の内容確認             |
| ファイル書き込み     | Write           | テンプレート生成             |
| ファイル編集         | Edit            | セクション追記               |
| ファイル検索         | Glob            | パターンマッチング           |
| 内容検索             | Grep            | コード内検索                 |
| コマンド実行         | Bash            | `npm run lint`, `git status` |
| サブエージェント起動 | Task            | コードレビュー、テスト生成   |
| スキル起動           | Skill           | 型チェック、スキーマ検証     |
| ユーザー質問         | AskUserQuestion | 確認ダイアログ               |

### Claude Code でできないこと（スクリプトが必要）

| 機能             | 理由                             | 必要なライブラリ |
|------------------|----------------------------------|------------------|
| データベース操作 | 型安全なクエリ、トランザクション | Kysely           |
| GitHub API       | 認証、レート制限、GraphQL        | Octokit          |
| イベント駆動     | 非同期イベント、ハンドラー登録   | EventEmitter2    |
| ファイル監視     | 継続的な変更検知                 | Chokidar         |

## 設計・実装方法の選択早見表

| やりたいこと     | 設計・実装方法 | 理由                               |
|------------------|----------------|------------------------------------|
| ファイル読み書き | プロンプト     | Read/Write/Edit で十分             |
| コードレビュー   | プロンプト     | Task で code-reviewer 起動         |
| テスト生成       | プロンプト     | Task で test-generator 起動        |
| リファクタリング | プロンプト     | Task で refactoring-assistant 起動 |
| 型チェック       | プロンプト     | Skill で typescript-eslint 起動    |
| 要件分析         | プロンプト     | Task で requirements-analyzer 起動 |
| 設計             | プロンプト     | Task で architect-designer 起動    |
| 図生成           | プロンプト     | Skill で architecture-diagram 起動 |
| 要件定義書生成   | プロンプト     | Skill で requirements-doc 起動     |
| Bash 実行        | プロンプト     | Bash ツールで直接実行              |
| ガイダンス表示   | プロンプト     | メッセージ出力のみ                 |
| DB 操作          | スクリプト     | Kysely が必要                      |
| GitHub API       | スクリプト     | Octokit が必要                     |
| イベント発火     | スクリプト     | EventBus が必要                    |
| ファイル監視     | スクリプト     | Chokidar が必要                    |

## 3層アーキテクチャ

```
プロンプト層 (.md)
  ↓
スクリプト層 (.ts)
  ↓
コア層 (src/core/**)
```

### プロンプト層（.md）

- **役割**: ユーザー向けドキュメント、自動実行フロー定義
- **場所**: `src/slash-commands/*.md`
- **内容**:
  - コマンドの説明と使用例
  - 引数の説明
  - 自動実行フローの定義（Task/Skill/Tool呼び出し）
- **例**: `code-review.md`, `refactor.md`

### スクリプト層（.ts）

- **役割**: CLIエントリーポイント、データベース操作、GitHub API呼び出し、イベント発火
- **場所**: `src/commands/**/*.ts`
- **内容**:
  - 引数パース・バリデーション
  - データベースCRUD操作
  - GitHub API呼び出し
  - EventBus によるイベント発火
- **例**: `spec/create.ts`, `github/issue-create.ts`

### コア層（src/core/**）

- **役割**: 低レベルインフラストラクチャ、共通ライブラリ
- **場所**: `src/core/**`
- **内容**:
  - データベース接続管理 (`database/`)
  - イベントバス (`workflow/`)
  - バリデーション (`validation/`)
  - Git統合 (`git/`)
  - ファイル監視 (`filesystem/`)

## 処理フロー例

### コードレビュー

```
/cft:code-review src/**/*.ts
  ↓
code-review.md (プロンプト層)
  - ファイルパターン解決 (Glob)
  - code-reviewer サブエージェント起動 (Task)
  ↓
code-reviewer (サブエージェント)
  - Read ツールで対象ファイル読み込み
  - コード品質分析
  - Edit ツールで修正提案
  ↓
結果表示
```

### 仕様書作成

```
/cft:spec-create "新機能の実装"
  ↓
spec-create.md (プロンプト層)
  - コマンド実行指示
  ↓
spec/create.ts (スクリプト層)
  - 引数バリデーション（Zod）
  - データベースに仕様書レコード作成（Kysely）
  - spec.created イベント発火（EventBus）
  ↓
EventBus (コア層)
  - ブランチ作成ハンドラー起動
  - ファイルシステムハンドラー起動
  ↓
結果: 仕様書ファイル作成、Gitブランチ作成、イベント通知
```

## プロンプトとスクリプトの使い分け

### プロンプトで実装する処理

- サブエージェント・スキル起動
- ファイル読み書き（Read/Write/Edit ツール）
- 軽量な検証・表示処理
- Bash コマンド実行（npm run lint など）

### スクリプトで実装する処理

- データベース操作（CRUD、トランザクション）
- GitHub API 呼び出し
- イベント発火・ハンドラー登録
- ファイル監視・バックグラウンド実行
- 複雑な Zod スキーマ検証
