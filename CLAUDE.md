# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## プロジェクト概要

cc-craft-kit は、Claude Code 上で仕様駆動開発（SDD）を実現する開発支援ツールキット。
詳細は README.md と docs/ARCHITECTURE.md を参照してください。

## 開発フロー

### ソースコード編集

1. `src/` 配下のファイルを編集
2. `npm run sync:dogfood` で `.cc-craft-kit/` へ同期
3. スラッシュコマンド `/cft:*` で動作確認

注意: `src/` を編集したら必ず `npm run sync:dogfood` を実行してください。

### よく使うコマンド

```bash

# 型チェック

npm run typecheck

# 全テスト実行

npm test

# ESLint実行

npm run lint

# ESLint自動修正

npm run lint:fix

# ソースコード同期

npm run sync:dogfood
npm run check:sync

# データベースマイグレーション

npm run db:migrate
```

## コーディング規約

### TypeScript

- strict mode を有効にして、すべての型チェックを厳格に実施すること
- `any`型は禁止。`unknown`または具体的な型定義を使用すること
- camelCase（変数・関数）、PascalCase（クラス・型・インターフェース）の命名規則に従うこと
- インデントは 2 スペースを使用すること

### ファイル構成

- 単一責任の原則に従い、1 ファイル 1 責務とすること
- `index.ts`で公開 API を明示的にエクスポートして、モジュールを整理すること
- モジュール内は相対パス、外部は絶対パス（`.js`拡張子必須）を使用すること

### エラーハンドリング

- `src/core/errors/`の標準エラークラスを使用すること
- エラーメッセージにはトークンなどのセンシティブ情報を含めないこと
- ログレベルは `debug` → `info` → `warn` → `error` を適切に使い分けること

### セキュリティ

- すべての CLI コマンド引数は適切に検証すること（Zod スキーマ等）
- SQL インジェクション対策として、Kysely のパラメータ化クエリのみを使用すること
- HTML 出力時は必ずサニタイゼーションを実施すること
- 認証情報は環境変数（`.env`）で管理し、コードに直接記述しないこと

### データベース接続の安全性

データベース破損を防ぐための厳格なルール。

1. **`getDatabase()` の使用**
   - データベース接続は **必ず** `getDatabase()` を使用すること
   - `config` パラメータは指定しないこと（デフォルトパスを使用）
   - 異なるパスが必要な場合は、必ず `closeDatabase()` を先に呼び出すこと

2. **禁止事項**
   - `createDatabase()` を直接呼び出さないこと
   - `getDatabase({ databasePath: ... })` のように明示的なパス指定をしないこと
   - 複数のデータベースインスタンスを同時に作成しないこと

## テスト戦略

### 単体テスト

- テストファイルは `tests/`ディレクトリに`src/`と同じ構造で配置すること
- ファイル名は `*.test.ts` とすること
- データベース、GitHub API は必ずモック化すること
- カバレッジ目標は 80%以上を目指すこと

### テスト実行時の注意

- データベースは`:memory:`モードでテスト
- GitHub API 呼び出しは必ずモック化（レート制限回避）
- **Git 操作は必ずモック化すること**（テスト実行時にブランチが変更されることを防止）

## 開発時の注意事項

### ソースコード管理

- すべてのコード編集は `src/` で行う。`.cc-craft-kit/` 配下のファイルは自動生成されるため、直接編集しない
- スラッシュコマンド定義を `src/slash-commands/` で管理する
- 同期を忘れない。`src/` を編集したら `npm run sync:dogfood` を実行する
- 型エラーは即座に修正する。`npx tsc --noEmit` でエラーが出た場合は、同期前に修正すること

## トラブルシューティング

### コマンドが起動しない

1. `npx tsc --noEmit` で型エラーがないか確認
2. `.env` ファイルが正しく設定されているか確認
3. `npm run sync:dogfood` で同期が正常に完了しているか確認

### データベースエラー

1. `.cc-craft-kit/cc-craft-kit.db`が破損している可能性 → 削除して`npm run db:migrate`で再初期化
2. マイグレーションの順序エラー → マイグレーションファイルの連番を確認

## スクリプトとプロンプトの使い分け指針

### プロンプトファースト原則

cc-craft-kit の開発では、「プロンプトで済ませられることはプロンプトで済ませる」という基本原則に従います。

### スクリプト実装が必要な処理

以下の処理は、**TypeScript スクリプトで実装**してください:

1. **データベース操作**
   - Kysely の型安全性が必要
   - トランザクション管理が必要
   - 例: `spec/create.ts`, `spec/phase.ts`

2. **GitHub API 呼び出し**
   - Octokit の認証・レート制限管理が必要
   - 複雑なクエリ（GraphQL）
   - 例: `github/issue-create.ts`

3. **イベント駆動処理**
   - EventBus の初期化・ハンドラー登録
   - 非同期イベント発火
   - 例: `spec/create.ts` (spec.created イベント)

4. **ファイル監視・長時間実行**
   - Chokidar によるファイル監視
   - バックグラウンドプロセス
   - 例: `watch.ts`

5. **複雑なバリデーション**
   - Zod スキーマ検証
   - プレースホルダー検出
   - フェーズ遷移検証
   - 例: `sync/check.ts`, `spec/phase.ts`

### プロンプトベースで実装すべき処理

以下の処理は、**カスタムスラッシュコマンド (.md) で実装**してください:

1. **軽量な検証・表示処理**
   - 引数の簡単な検証
   - ユーザー向けメッセージ表示
   - 例: ガイダンス表示、簡単なファイル操作

2. **サブエージェント・スキル起動**
   - Task/Skill ツールによる起動
   - ファイルパターン解決（Glob）
   - 結果の構造化表示
   - 例: `code-review.md`, `refactor.md`, `test-generate.md`

3. **単純なファイル操作**
   - Read/Write/Edit ツール
   - 例: テンプレート生成、簡単な設定ファイル更新

### 判断基準チェックリスト

新しい機能を実装する際は、以下のチェックリストを使用してください。

#### スクリプト実装が必要か？

- [ ] データベース操作（CRUD、トランザクション）が必要
- [ ] GitHub API 呼び出しが必要
- [ ] イベント発火・ハンドラー登録が必要
- [ ] ファイル監視・バックグラウンド実行が必要
- [ ] 複雑な Zod スキーマ検証が必要
- [ ] 型安全性が重要（TypeScript の型推論が必要）

→ **1つでも該当すれば、スクリプト実装を選択**

#### プロンプトベースで十分か?

- [ ] 単純な引数検証のみ
- [ ] サブエージェント・スキル起動が主目的
- [ ] ファイル読み書きのみ（Read/Write/Edit ツール）
- [ ] ユーザー向けメッセージ表示が主目的
- [ ] Bash コマンド実行のみ（npm run lint など）

→ **すべて該当すれば、プロンプトベース実装を選択**

## 参考ドキュメント

- [ARCHITECTURE.md](./docs/ARCHITECTURE.md) - 詳細なアーキテクチャ設計
- [QUICK_START.md](./docs/QUICK_START.md) - クイックスタートガイド
