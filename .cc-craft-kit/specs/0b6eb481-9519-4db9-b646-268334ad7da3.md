# PR の作成はドラフト状態で作成

**仕様書 ID:** 0b6eb481-9519-4db9-b646-268334ad7da3
**フェーズ:** design
**作成日時:** 2025/12/01 00:00:00
**更新日時:** 2025/12/01 18:35:00

---

## 1. 背景と目的

### 背景

現在、PR の作成は Ready 状態で作成されているが、これをデフォルトでドラフト状態で作成するように変更する。

cc-craft-kit では、仕様書の completed フェーズへの移行時や task done サブコマンド実行時に `gh pr create` コマンドで PR を作成している。現状では `--draft` フラグはオプション扱いとなっており、明示的に指定しない限り Ready 状態で PR が作成される。

しかし、PR を最初から Ready 状態で作成すると、以下の問題が発生する可能性がある：
- レビュアーに通知が飛び、まだ準備が整っていない PR をレビューしてしまう
- CI/CD が即座に実行され、不要なリソース消費が発生する
- PR の説明やコミット整理が完了する前にマージされるリスク

### 目的

PR 作成時のデフォルト動作をドラフト状態に変更し、レビュー準備が整ってから明示的に Ready 状態に変更できるようにする。これにより、より安全で計画的な PR ワークフローを実現する。

---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `gh pr create` コマンド実行時にデフォルトで `--draft` フラグが付与される
- [ ] 既存の `--draft` フラグ指定のロジックを削除または反転させる

### 機能要件

- [ ] spec-phase.md の completed フェーズで pr-creator スキル実行時にドラフト PR が作成される
- [ ] task.md の done サブコマンドで PR 作成時にドラフト PR が作成される
- [ ] 必要に応じて `--ready` フラグで Ready 状態の PR を作成できる（オプション）

### 非機能要件

- [ ] 既存の PR 作成フローとの互換性を維持する
- [ ] ドキュメント（コマンドヘルプ等）を更新する

---

## 4. 制約条件

- GitHub CLI (gh) がインストールされていること
- `gh pr create --draft` オプションが利用可能な gh CLI バージョンであること
- プロンプトファースト原則に従い、プロンプト層（.md ファイル）の変更で対応する

---

## 5. 依存関係

### 変更対象ファイル

- `.cc-craft-kit/slash-commands/spec-phase.md` - completed フェーズでの PR 作成処理
- `.cc-craft-kit/slash-commands/task.md` - task done サブコマンドでの PR 作成処理
- `.cc-craft-kit/skills/pr-creator.md` - pr-creator スキルの定義

### 関連コンポーネント

- `src/integrations/github/pull-request.ts` - PR URL 記録（変更不要の可能性あり）
- `src/integrations/github/pr-cleanup.ts` - PR マージ後処理（変更不要）

---

## 6. 参考情報

- [GitHub CLI - gh pr create](https://cli.github.com/manual/gh_pr_create)
- task.md Line 513-521: 現在の PR 作成処理
- spec-phase.md Line 511-518: completed フェーズでの pr-creator スキル呼び出し

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
PR 作成フロー（現在）
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  spec-phase.md (completed)                                      │
│       ↓                                                         │
│  pr-creator スキル                                              │
│       ↓                                                         │
│  gh pr create --title --body --base                            │
│       ↓                                                 ← Ready │
│  PR 作成完了                                                     │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  task.md (done サブコマンド)                                     │
│       ↓                                                         │
│  gh pr create --title --body --repo [--draft]                   │
│       ↓                              ← 条件付き Draft           │
│  PR 作成完了                                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

PR 作成フロー（変更後）
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  spec-phase.md (completed)                                      │
│       ↓                                                         │
│  pr-creator スキル                                              │
│       ↓                                                         │
│  gh pr create --title --body --base --draft                    │
│       ↓                                                ← Draft  │
│  PR 作成完了                                                     │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  task.md (done サブコマンド)                                     │
│       ↓                                                         │
│  gh pr create --title --body --repo --draft                     │
│       ↓                                                ← Draft  │
│  PR 作成完了                                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 設計方針

**プロンプトファースト原則に従い、プロンプト層（.md ファイル）のみで対応**

- スクリプト（.ts）の追加・変更は不要
- 既存の Bash + GitHub CLI パターンを維持
- `--draft` フラグをデフォルトで追加

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `.claude/skills/pr-creator/SKILL.md` | Line 114-117: `gh pr create` コマンドに `--draft` フラグを追加 |
| `.cc-craft-kit/slash-commands/task.md` | Line 518-521: デフォルトで `--draft` を付与、フラグロジック反転 |

#### 変更詳細

**1. pr-creator スキル (Line 114-117)**

変更前:
```bash
gh pr create \
  --title "<タイトル>" \
  --body "<本文>" \
  --base "$BASE_BRANCH"
```

変更後:
```bash
gh pr create \
  --title "<タイトル>" \
  --body "<本文>" \
  --base "$BASE_BRANCH" \
  --draft
```

**2. task.md done サブコマンド (Line 518-521)**

変更前:
```bash
gh pr create --title "$ISSUE_TITLE" --body "Closes #$ISSUE_NUMBER" --repo "$REPO"
```
> `--draft` フラグがある場合は `--draft` オプションを追加。

変更後:
```bash
gh pr create --title "$ISSUE_TITLE" --body "Closes #$ISSUE_NUMBER" --repo "$REPO" --draft
```
> `--ready` フラグがある場合は `--draft` オプションを削除し、Ready 状態で PR を作成。

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| pr-creator で PR 作成 | Ready 状態 | Draft 状態 | pr-creator/SKILL.md:114-117 |
| task done で PR 作成 | Ready 状態（デフォルト）| Draft 状態（デフォルト） | task.md:518 |
| Ready 状態での PR 作成 | 未サポート | `--ready` フラグで対応 | task.md:521 |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| pr-creator スキル | `--draft` フラグ付きで PR 作成 | 手動テスト: `/cft:spec-phase <spec-id> completed` |
| task done サブコマンド | デフォルトでドラフト PR 作成 | 手動テスト: `/cft:task done <issue-number>` |
| `--ready` フラグ | Ready 状態で PR 作成 | 手動テスト: `/cft:task done <issue-number> --ready` |
| 後方互換性 | 既存ワークフローが動作 | 既存テストスクリプトの実行 |

### 7.5 移行計画

#### Phase 1: pr-creator スキル変更

1. `.claude/skills/pr-creator/SKILL.md` の `gh pr create` コマンドに `--draft` フラグを追加
2. ドキュメントにドラフト PR 作成の説明を追記

#### Phase 2: task.md done サブコマンド変更

1. `.cc-craft-kit/slash-commands/task.md` の `gh pr create` コマンドに `--draft` フラグを追加
2. `--draft` フラグのロジックを `--ready` フラグに反転
3. ドキュメントにフラグの説明を追記

---

## 8. 実装タスクリスト

### Phase 1: pr-creator スキル変更

- [ ] pr-creator スキルの `gh pr create` コマンドに `--draft` フラグを追加
- [ ] pr-creator スキルのドキュメントにドラフト PR 作成の説明を追記

### Phase 2: task.md done サブコマンド変更

- [ ] task.md の `gh pr create` コマンドに `--draft` フラグを追加
- [ ] `--draft` フラグのロジックを `--ready` フラグに反転
- [ ] task.md のドキュメントにフラグの説明を追記

### Phase 3: 検証

- [ ] pr-creator スキルで Draft PR が作成されることを確認
- [ ] task done でデフォルトで Draft PR が作成されることを確認
- [ ] `--ready` フラグで Ready 状態の PR が作成されることを確認
