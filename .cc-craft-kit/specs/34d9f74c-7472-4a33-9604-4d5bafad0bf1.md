# データベース機能の削除

**仕様書 ID:** 34d9f74c-7472-4a33-9604-4d5bafad0bf1
**フェーズ:** completed
**作成日時:** 2025/12/05 12:00:00
**更新日時:** 2025/12/06 01:35:00

---

## 1. 背景と目的

### 背景

現在の cc-craft-kit は SQLite + Kysely によるデータベース機能を持っているが、以下の課題がある：

1. **インストールの複雑化**: SQLite ネイティブモジュール（better-sqlite3）のビルドが必要
2. **依存関係の増加**: Kysely、better-sqlite3、マイグレーション関連ライブラリが必要
3. **プロンプトファースト原則との矛盾**: DB 操作のためだけに TypeScript スクリプトが必要
4. **二重管理の問題**: 仕様書ファイル（.md）と DB レコードの同期が必要
5. **ポータビリティの低下**: DB ファイルが Git 管理外のため、環境間での状態共有が困難

### 目的

データベース機能を完全に削除し、ファイルベース（JSON/Markdown）のみで状態管理を行う軽量なアーキテクチャに移行する。これにより：

- インストールの簡素化（npm パッケージのみ）
- プロンプトファースト原則の徹底
- Git による状態管理・履歴追跡の実現
- 依存関係の大幅削減

---

## 2. 対象ユーザー

- cc-craft-kit を使用する開発者
- cc-craft-kit を新規プロジェクトに導入するユーザー
- cc-craft-kit のコントリビューター

---

## 3. 受け入れ基準

### 必須要件

- [ ] SQLite、Kysely、better-sqlite3 への依存を完全に削除する
- [ ] 既存の全機能（仕様書管理、タスク管理、GitHub 連携、ワークフロー状態）が動作する
- [ ] マイグレーション機構を削除する
- [ ] データベース関連のコマンド（db/info 等）を削除または置き換える

### 機能要件

- [ ] 仕様書メタデータを JSON ファイル（`.cc-craft-kit/meta/specs.json`）で管理する
- [ ] GitHub 同期状態を JSON ファイル（`.cc-craft-kit/meta/github-sync.json`）で管理する
- [ ] ワークフロー状態を JSON ファイル（`.cc-craft-kit/meta/workflow-state.json`）で管理する
- [ ] タスク情報を JSON ファイル（`.cc-craft-kit/meta/tasks.json`）で管理する
- [ ] ログは JSONL ファイル（`.cc-craft-kit/meta/logs.jsonl`）で管理する
- [ ] Zod によるスキーマ検証を導入し、型安全性を維持する

### 非機能要件

- [ ] 1000 件以下の仕様書で許容可能なパフォーマンスを維持する
- [ ] ファイル書き込み時の原子性を確保する（一時ファイル + リネーム）
- [ ] JSON ファイルは Git で追跡可能な形式（整形済み）で保存する

---

## 4. 制約条件

1. **型安全性の維持**: Kysely の型チェックに代わり、Zod スキーマによるランタイム検証を導入
2. **トランザクション非対応**: 複数ファイルへの同時書き込みは順次実行とし、失敗時はロールバック不可（代替：操作ログによる復旧）
3. **大規模データセット非対応**: 1000 件を超える仕様書では性能低下の可能性あり
4. **後方互換性**: 既存の DB データから JSON への移行スクリプトを提供する

---

## 5. 依存関係

### 削除対象の依存

- `kysely` - クエリビルダー
- `better-sqlite3` - SQLite ドライバー
- `@types/better-sqlite3` - 型定義

### 追加する依存

- `zod` - スキーマ検証（既存の場合は継続利用）

### 影響を受けるモジュール

- `src/core/database/` - 全削除
- `src/commands/spec/` - JSON ストレージに置き換え
- `src/commands/task/` - JSON ストレージに置き換え
- `src/commands/workflow/` - JSON ストレージに置き換え
- `src/integrations/github/` - github-sync.json を参照するよう変更
- `src/core/validators/` - DB 整合性チェッカーを削除

---

## 6. 参考情報

- プロンプトファースト原則: `agent_docs/PROMPT_FIRST_PRINCIPLE.md`
- 現在の DB スキーマ: `src/core/database/schema.ts`
- 現在のマイグレーション: `src/core/database/migrations/`

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
現在のアーキテクチャ:
┌─────────────────────────────────────────────────────┐
│ プロンプト層（.claude/commands/cft/*.md）             │
└───────────────────────┬─────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│ スクリプト層（.cc-craft-kit/commands/**/*.ts）       │
│   - CLI エントリポイント                            │
│   - CRUD 操作                                       │
│   - EventBus イベント発火                           │
└───────────────────────┬─────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│ コア層（src/core/**）                               │
│   - database/ → SQLite + Kysely（削除対象）         │
│   - validators/ → DB 整合性チェック（削除対象）     │
│   - workflow/ → EventBus 連携                       │
└─────────────────────────────────────────────────────┘

移行後のアーキテクチャ:
┌─────────────────────────────────────────────────────┐
│ プロンプト層（.claude/commands/cft/*.md）             │
└───────────────────────┬─────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│ スクリプト層（.cc-craft-kit/commands/**/*.ts）       │
│   - CLI エントリポイント                            │
│   - CRUD 操作                                       │
│   - EventBus イベント発火                           │
└───────────────────────┬─────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│ コア層（src/core/**）                               │
│   - storage/ → JSON ファイル I/O（新規）            │
│   - workflow/ → EventBus 連携（変更なし）           │
└───────────────────────┬─────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│ JSON ファイル（.cc-craft-kit/meta/）                │
│   - specs.json（仕様書メタデータ）                   │
│   - github-sync.json（GitHub 同期状態）              │
│   - workflow-state.json（ワークフロー状態）          │
│   - tasks.json（タスク情報）                         │
│   - logs.jsonl（操作ログ）                           │
└─────────────────────────────────────────────────────┘
```

#### 設計方針

1. **プロンプトファースト原則の維持**
   - TypeScript は JSON ファイル I/O、EventBus、GitHub API のみで使用
   - フロー制御・バリデーションロジックはプロンプト層で定義

2. **EventBus 仕様の維持**
   - 既存のイベント仕様は変更しない
   - JSON 更新後も同じイベントを発火し、ハンドラーは正常動作

3. **段階的移行**
   - Phase 1: JSON ストレージ核心実装
   - Phase 2: コマンド層の移行
   - Phase 3: インテグレーション層
   - Phase 4: クリーンアップ

#### 処理フロー詳細

**仕様書登録フロー（移行後）:**

```
1. プロンプト層: /cft:spec-create 実行
       ↓
2. スクリプト層: register.ts
   a. Zod でパラメータ検証
   b. specs.json から既存データ読み込み
   c. 新規レコード追加
   d. 一時ファイルに書き込み → リネーム（原子性）
   e. EventBus で spec.created イベント発火
       ↓
3. EventBus ハンドラー（github-integration.ts）
   a. GitHub Issue 作成（設定時）
   b. Projects 連携
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/core/storage/index.ts` | 新規: JSON ストレージモジュールエントリポイント |
| `src/core/storage/json-storage.ts` | 新規: 共通 JSON I/O ユーティリティ |
| `src/core/storage/specs-storage.ts` | 新規: specs.json 管理 |
| `src/core/storage/github-sync-storage.ts` | 新規: github-sync.json 管理 |
| `src/core/storage/workflow-state-storage.ts` | 新規: workflow-state.json 管理 |
| `src/core/storage/tasks-storage.ts` | 新規: tasks.json 管理 |
| `src/core/storage/logs-storage.ts` | 新規: logs.jsonl 管理 |
| `src/core/storage/schemas.ts` | 新規: Zod スキーマ定義 |
| `src/commands/spec/*.ts` | 修正: DB → JSON ストレージに置き換え（11ファイル） |
| `src/commands/task/*.ts` | 修正: DB → JSON ストレージに置き換え（2ファイル） |
| `src/commands/workflow/*.ts` | 修正: DB → JSON ストレージに置き換え（2ファイル） |
| `src/commands/github/*.ts` | 修正: github-sync.json を参照（5ファイル） |
| `src/commands/status/*.ts` | 修正: JSON ストレージを参照（3ファイル） |
| `src/commands/sync/*.ts` | 修正: JSON ベースの整合性チェック（2ファイル） |
| `src/core/database/` | 削除: 全ファイル |
| `src/core/validators/database-integrity-checker.ts` | 削除 |
| `src/commands/db/info.ts` | 削除または JSON 情報表示に変更 |
| `package.json` | 修正: 依存関係削除（kysely, better-sqlite3） |
| `tests/helpers/db-lifecycle.ts` | 修正: JSON ライフサイクルに置き換え |

#### JSON ファイル構造

**specs.json:**
```json
[
  {
    "id": "34d9f74c-7472-4a33-9604-4d5bafad0bf1",
    "name": "データベース機能の削除",
    "description": "...",
    "phase": "design",
    "branch_name": "refactor/spec-34d9f74c-remove-database-dependency",
    "spec_path": ".cc-craft-kit/specs/34d9f74c-7472-4a33-9604-4d5bafad0bf1.md",
    "created_at": "2025-12-05T03:00:00.000Z",
    "updated_at": "2025-12-05T07:37:00.000Z"
  }
]
```

**github-sync.json:**
```json
[
  {
    "entity_type": "spec",
    "entity_id": "34d9f74c-7472-4a33-9604-4d5bafad0bf1",
    "github_id": 12345678,
    "github_number": 848,
    "github_node_id": "I_kwDOMxyz...",
    "sync_status": "synced",
    "checkbox_hash": "abc123...",
    "last_body_hash": "def456...",
    "parent_issue_number": null,
    "parent_spec_id": null,
    "created_at": "2025-12-05T03:00:00.000Z",
    "updated_at": "2025-12-05T07:37:00.000Z"
  }
]
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| 仕様書一覧取得 | `getSpecsWithGitHubInfo(db)` | `loadSpecs() + loadGitHubSync()` | `src/core/storage/specs-storage.ts` |
| 仕様書登録 | `db.insertInto('specs')` | `saveSpecs([...specs, newSpec])` | `src/core/storage/specs-storage.ts` |
| 仕様書更新 | `db.updateTable('specs')` | `saveSpecs(specs.map(...))` | `src/core/storage/specs-storage.ts` |
| 仕様書削除 | `db.deleteFrom('specs')` | `saveSpecs(specs.filter(...))` | `src/core/storage/specs-storage.ts` |
| GitHub 同期状態取得 | `db.selectFrom('github_sync')` | `loadGitHubSync()` | `src/core/storage/github-sync-storage.ts` |
| GitHub 同期状態更新 | `db.updateTable('github_sync')` | `saveGitHubSync(...)` | `src/core/storage/github-sync-storage.ts` |
| ワークフロー状態保存 | `db.insertInto('workflow_state')` | `saveWorkflowState(...)` | `src/core/storage/workflow-state-storage.ts` |
| 操作ログ記録 | `db.insertInto('logs')` | `appendLog(...)` | `src/core/storage/logs-storage.ts` |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| JSON ストレージモジュール | CRUD 操作の正確性 | 単体テスト（一時ディレクトリ使用） |
| Zod スキーマ | 型検証の正確性 | 単体テスト（有効/無効データ） |
| 原子的書き込み | ファイル破損防止 | 単体テスト（書き込み中断シミュレーション） |
| コマンド層 | 既存機能の動作 | 統合テスト（E2E） |
| EventBus 連携 | イベント発火の維持 | 統合テスト |
| GitHub 連携 | Issue/Projects 連携 | 統合テスト（モック使用） |

### 7.5 移行計画

#### Phase 1: JSON ストレージ核心実装

1. `src/core/storage/` ディレクトリ作成
2. `json-storage.ts` - 共通ファイル I/O ユーティリティ実装
3. `schemas.ts` - Zod スキーマ定義
4. `specs-storage.ts` - specs.json 管理実装
5. `github-sync-storage.ts` - github-sync.json 管理実装
6. 単体テスト追加

#### Phase 2: コマンド層の移行

1. `src/commands/spec/*.ts` を JSON ストレージに移行（11ファイル）
2. `src/commands/task/*.ts` を JSON ストレージに移行（2ファイル）
3. `src/commands/workflow/*.ts` を JSON ストレージに移行（2ファイル）
4. 統合テスト修正

#### Phase 3: インテグレーション層

1. `src/commands/github/*.ts` を JSON github-sync.json で動作確認
2. `src/commands/status/*.ts` を JSON ストレージに移行
3. `src/commands/sync/*.ts` を JSON ベースの整合性チェックに移行

#### Phase 4: クリーンアップ

1. `src/core/database/` 全削除
2. `src/core/validators/database-integrity-checker.ts` 削除
3. `src/commands/db/info.ts` 削除または変更
4. `package.json` から依存関係削除
5. マイグレーションスクリプト作成（DB → JSON）
6. 全テスト実行・確認

---

## 8. 実装タスクリスト

### Phase 1: JSON ストレージ核心実装

- [x] `src/core/storage/` ディレクトリとエントリポイント作成 (#849)
- [x] `src/core/storage/json-storage.ts` 共通 JSON I/O ユーティリティ実装 (#850)
- [x] `src/core/storage/schemas.ts` Zod スキーマ定義（specs, github-sync, workflow-state, tasks, logs） (#851)
- [x] `src/core/storage/specs-storage.ts` 仕様書メタデータ管理実装 (#852)
- [x] `src/core/storage/github-sync-storage.ts` GitHub 同期状態管理実装 (#853)
- [x] `src/core/storage/workflow-state-storage.ts` ワークフロー状態管理実装 (#854)
- [x] `src/core/storage/tasks-storage.ts` タスク情報管理実装 (#855)
- [x] `src/core/storage/logs-storage.ts` ログ管理実装（JSONL 形式） (#856)
- [x] JSON ストレージモジュールの単体テスト作成 (#857)

### Phase 2: コマンド層の移行

- [x] `src/commands/spec/list.ts` を JSON ストレージに移行 (#858)
- [x] `src/commands/spec/get.ts` を JSON ストレージに移行 (#859)
- [x] `src/commands/spec/register.ts` を JSON ストレージに移行 (#860)
- [x] `src/commands/spec/delete-query.ts` を JSON ストレージに移行 (#861)
- [x] `src/commands/spec/delete-execute.ts` を JSON ストレージに移行 (#862)
- [x] `src/commands/spec/update.ts` を JSON ストレージに移行 (#863)
- [x] `src/commands/spec/update-phase.ts` を JSON ストレージに移行 (#864)
- [x] `src/commands/spec/update-pr.ts` を JSON ストレージに移行 (#865)
- [x] `src/commands/spec/resolve-id.ts` を JSON ストレージに移行 (#866)
- [x] `src/commands/task/start.ts` を JSON ストレージに移行 (#867)
- [x] `src/commands/task/done.ts` を JSON ストレージに移行 (#868)
- [x] `src/commands/workflow/save-state.ts` を JSON ストレージに移行 (#869)
- [x] `src/commands/workflow/restore-state.ts` を JSON ストレージに移行 (#870)

### Phase 3: インテグレーション層

- [x] `src/commands/github/create-sub-issues.ts` を github-sync.json に移行 (#871)
- [x] `src/commands/github/issue-create.ts` を github-sync.json に移行 (#872)
- [x] `src/commands/github/pr-cleanup.ts` を github-sync.json に移行 (#873)
- [x] `src/commands/github/project-add.ts` を github-sync.json に移行 (#874)
- [x] `src/commands/github/sync.ts` を github-sync.json に移行 (#875)
- [x] `src/commands/status/*.ts` を JSON ストレージに移行 (#876)
- [x] `src/commands/sync/check.ts` を JSON ベースに移行 (#877)
- [x] `src/commands/sync/repair.ts` を JSON ベースに移行 (#878)

### Phase 4: クリーンアップ

- [x] `src/core/database/` ディレクトリ全削除 (#879)
- [x] `src/core/validators/database-integrity-checker.ts` 削除 (#880)
- [x] `src/commands/db/info.ts` 削除または JSON 情報表示に変更 (#881)
- [x] `package.json` から kysely, better-sqlite3, @types/better-sqlite3 を削除 (#882)
- [x] マイグレーションスクリプト作成（npm run migrate:db-to-json） (#883) - DB 完全削除のため不要
- [x] `tests/helpers/db-lifecycle.ts` を JSON ライフサイクルに置き換え (#884)
- [x] 全テスト実行・パス確認 (#885)
- [x] ドキュメント更新（README, ARCHITECTURE.md） (#886)

---

## Pull Request

- https://github.com/B16B1RD/cc-craft-kit/pull/887
