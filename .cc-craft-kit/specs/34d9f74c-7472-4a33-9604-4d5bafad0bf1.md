# データベース機能の削除

**仕様書 ID:** 34d9f74c-7472-4a33-9604-4d5bafad0bf1
**フェーズ:** requirements
**作成日時:** 2025/12/05 12:00:00
**更新日時:** 2025/12/05 12:00:00

---

## 1. 背景と目的

### 背景

現在の cc-craft-kit は SQLite + Kysely によるデータベース機能を持っているが、以下の課題がある：

1. **インストールの複雑化**: SQLite ネイティブモジュール（better-sqlite3）のビルドが必要
2. **依存関係の増加**: Kysely、better-sqlite3、マイグレーション関連ライブラリが必要
3. **プロンプトファースト原則との矛盾**: DB 操作のためだけに TypeScript スクリプトが必要
4. **二重管理の問題**: 仕様書ファイル（.md）と DB レコードの同期が必要
5. **ポータビリティの低下**: DB ファイルが Git 管理外のため、環境間での状態共有が困難

### 目的

データベース機能を完全に削除し、ファイルベース（JSON/Markdown）のみで状態管理を行う軽量なアーキテクチャに移行する。これにより：

- インストールの簡素化（npm パッケージのみ）
- プロンプトファースト原則の徹底
- Git による状態管理・履歴追跡の実現
- 依存関係の大幅削減

---

## 2. 対象ユーザー

- cc-craft-kit を使用する開発者
- cc-craft-kit を新規プロジェクトに導入するユーザー
- cc-craft-kit のコントリビューター

---

## 3. 受け入れ基準

### 必須要件

- [ ] SQLite、Kysely、better-sqlite3 への依存を完全に削除する
- [ ] 既存の全機能（仕様書管理、タスク管理、GitHub 連携、ワークフロー状態）が動作する
- [ ] マイグレーション機構を削除する
- [ ] データベース関連のコマンド（db/info 等）を削除または置き換える

### 機能要件

- [ ] 仕様書メタデータを JSON ファイル（`.cc-craft-kit/meta/specs.json`）で管理する
- [ ] GitHub 同期状態を JSON ファイル（`.cc-craft-kit/meta/github-sync.json`）で管理する
- [ ] ワークフロー状態を JSON ファイル（`.cc-craft-kit/meta/workflow-state.json`）で管理する
- [ ] タスク情報を JSON ファイル（`.cc-craft-kit/meta/tasks.json`）で管理する
- [ ] ログは JSONL ファイル（`.cc-craft-kit/meta/logs.jsonl`）で管理する
- [ ] Zod によるスキーマ検証を導入し、型安全性を維持する

### 非機能要件

- [ ] 1000 件以下の仕様書で許容可能なパフォーマンスを維持する
- [ ] ファイル書き込み時の原子性を確保する（一時ファイル + リネーム）
- [ ] JSON ファイルは Git で追跡可能な形式（整形済み）で保存する

---

## 4. 制約条件

1. **型安全性の維持**: Kysely の型チェックに代わり、Zod スキーマによるランタイム検証を導入
2. **トランザクション非対応**: 複数ファイルへの同時書き込みは順次実行とし、失敗時はロールバック不可（代替：操作ログによる復旧）
3. **大規模データセット非対応**: 1000 件を超える仕様書では性能低下の可能性あり
4. **後方互換性**: 既存の DB データから JSON への移行スクリプトを提供する

---

## 5. 依存関係

### 削除対象の依存

- `kysely` - クエリビルダー
- `better-sqlite3` - SQLite ドライバー
- `@types/better-sqlite3` - 型定義

### 追加する依存

- `zod` - スキーマ検証（既存の場合は継続利用）

### 影響を受けるモジュール

- `src/core/database/` - 全削除
- `src/commands/spec/` - JSON ストレージに置き換え
- `src/commands/task/` - JSON ストレージに置き換え
- `src/commands/workflow/` - JSON ストレージに置き換え
- `src/integrations/github/` - github-sync.json を参照するよう変更
- `src/core/validators/` - DB 整合性チェッカーを削除

---

## 6. 参考情報

- プロンプトファースト原則: `agent_docs/PROMPT_FIRST_PRINCIPLE.md`
- 現在の DB スキーマ: `src/core/database/schema.ts`
- 現在のマイグレーション: `src/core/database/migrations/`
