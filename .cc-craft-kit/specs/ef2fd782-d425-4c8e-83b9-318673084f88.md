# /cft:spec-create で GitHub Issue が作成されない

**仕様書 ID:** ef2fd782-d425-4c8e-83b9-318673084f88
**フェーズ:** completed
**作成日時:** 2025/11/30 11:01:09
**更新日時:** 2025/11/30 11:50:32

---

## 1. 背景と目的

### 背景

現在の `/cft:spec-create` コマンド実行時、仕様書の作成と DB 登録は成功するが、GitHub Issue が自動作成されない問題が発生している。また、その後の各フェーズ（design, implementation, completed）でも GitHub Issue がないにもかかわらず、警告なしに処理が進行してしまう。

原因として以下が考えられる:
1. イベントハンドラー登録のタイミング問題（非同期登録で `spec.created` イベント発火時に未登録）
2. GitHub 設定チェック失敗時のサイレント失敗（警告ログが出力されない）
3. `/cft:github-init` 未実行時の動作が不明確

また、関連する問題として以下も確認されている:

1. **仕様書ファイルの未コミット問題**: `/cft:spec-create` 実行後に仕様書ファイル（`.cc-craft-kit/specs/*.md`）が自動コミットされず、未追跡ファイルとして残ってしまう。仕様書作成時にブランチ作成・切り替えは行われるが、ファイルのステージングとコミットが行われていない。

2. **ブランチ命名規則違反**: 作成されるブランチ名が `spec/ef2fd782-fix-spec-create-github-issue` のように `spec/` プレフィックスになっているが、CLAUDE.md で定義されているブランチ命名規則（`feature/`, `fix/`, `docs/` など）に則っていない。

3. **feature ブランチからの実行時の問題**: `feature/xxx` ブランチで作業中に `/cft:spec-create` を実行した場合、上記の未コミット問題とブランチ命名規則違反が同時に発生する。本来は develop ブランチから新しい作業ブランチを作成すべきだが、現在のブランチ状態を考慮せずに `spec/` ブランチを作成してしまう。

### 目的

`/cft:spec-create` 実行時に GitHub Issue が確実に作成され、GitHub 統合が未設定の場合は明確な警告をユーザーに提示する仕組みを実装する。また、各フェーズ移行時に GitHub Issue との連携状態を確認し、必要に応じて警告または自動修復を行う

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発（SDD）を行う開発者。特に GitHub との連携を期待しているユーザー

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-create` 実行時、GitHub 統合が設定済みであれば Issue が自動作成されること
- [ ] GitHub 統合が未設定の場合、明確な警告メッセージが表示されること
- [ ] イベントハンドラー登録完了後にイベントが発火されること

### 機能要件

- [ ] `spec.created` イベント発火前にハンドラー登録完了を保証する仕組みを実装
- [ ] GitHub 設定チェック失敗時に警告ログを出力
- [ ] 各フェーズ移行時（design, impl, completed）に GitHub Issue 連携状態を確認
- [ ] GitHub Issue がない場合、警告を表示し `/cft:github-issue-create` を案内
- [ ] 仕様書ファイル作成後、自動的にステージングとコミットを行う
- [ ] ブランチ命名規則を CLAUDE.md に準拠させる（`feature/`, `fix/`, `docs/` 等）
- [ ] 現在のブランチ状態を確認し、develop 以外からの実行時は警告または適切な処理を行う

### 非機能要件

- [ ] 既存の処理フローを破壊しないこと（後方互換性）
- [ ] エラーハンドリングを強化し、デバッグ情報を充実させる

---

## 4. 制約条件

- プロンプトファースト原則に従い、可能な限りプロンプトベース（.md）で実装
- イベントバスの設計パターン（EventEmitter2）を維持
- GitHub API のレート制限を考慮（バッチ処理、リトライ）
- 既存のテストを破壊しない

---

## 5. 依存関係

- `src/core/workflow/event-bus.ts` - イベントバス実装
- `src/core/workflow/github-integration.ts` - GitHub 統合イベントハンドラー
- `src/core/spec/register-spec.ts` - 仕様書登録処理
- `src/integrations/github/sync.ts` - GitHub 同期サービス
- `.cc-craft-kit/slash-commands/spec-create.md` - spec-create コマンド定義
- `.cc-craft-kit/slash-commands/spec-phase.md` - spec-phase コマンド定義

---

## 6. 参考情報

- GitHub Sub Issue 連携機能: コミット dd99509
- EventEmitter2 ドキュメント: https://github.com/EventEmitter2/EventEmitter2
- 既存の GitHub 統合テスト: `tests/integrations/github/`

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
spec-create.md 実行フロー（修正後）
├─ Step 1-3: 仕様書名解析・UUID 生成・ブランチ名決定
├─ Step 4: ブランチ作成（develop からのみ許可、feature/ プレフィックス）
├─ Step 5-8: ファイル作成・コードベース解析
├─ Step 9: register.ts 実行
│  ├─ registerSpec() 実行
│  │  ├─ DB INSERT
│  │  ├─ getEventBusAsync() 呼び出し（ハンドラー登録待機）
│  │  └─ spec.created イベント発火
│  │     └─ github-integration.ts: handleGitHubCreate()
│  │        ├─ GitHub トークンチェック → 未設定時は警告出力
│  │        ├─ GitHub 設定チェック → 未設定時は警告出力
│  │        └─ Issue 作成
│  └─ JSON 出力
├─ Step 9.5: 仕様書ファイルの自動コミット（新規追加）
└─ Step 10: 元ブランチに復帰
```

#### 設計方針

1. **プロンプトファースト原則**: スクリプト変更は最小限（警告出力の追加のみ）
2. **後方互換性**: 既存のイベント駆動設計を維持
3. **明示的なフィードバック**: サイレント失敗をなくし、ユーザーに状況を通知

#### 処理フロー詳細

**GitHub Issue 作成の判定フロー:**

```
spec.created イベント受信
       │
       ▼
┌─────────────────────────────────────────────┐
│ GITHUB_TOKEN 環境変数が設定されている？     │
└─────────────────────────────────────────────┘
       │
   ┌───┴───────┐
  YES          NO → ⚠️ 警告出力 + /cft:github-init 案内
   │
   ▼
┌─────────────────────────────────────────────┐
│ .cc-craft-kit/config.json に GitHub 設定？  │
└─────────────────────────────────────────────┘
       │
   ┌───┴───────┐
  YES          NO → ⚠️ 警告出力 + /cft:github-init 案内
   │
   ▼
┌─────────────────────────────────────────────┐
│ GitHub Issue 作成実行                       │
└─────────────────────────────────────────────┘
       │
   ┌───┴───────┐
成功          失敗 → ⚠️ 警告出力 + /cft:github-issue-create 案内
   │
   ▼
✓ Issue 番号・URL を出力
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/core/workflow/github-integration.ts` | GitHub トークン・設定未設定時の警告出力追加 |
| `.cc-craft-kit/slash-commands/spec-create.md` | Step 9.5（自動コミット）追加、Step 4（ブランチ命名規則）修正 |
| `.cc-craft-kit/slash-commands/spec-phase.md` | GitHub Issue 連携状態確認ロジック追加 |
| `src/slash-commands/spec-create.md` | 同期元ファイルの修正 |
| `src/slash-commands/spec-phase.md` | 同期元ファイルの修正 |

#### 同期対象

`src/` 配下を編集後、`npm run sync:dogfood` で `.cc-craft-kit/` へ同期する。

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| GitHub トークン未設定時 | サイレントスキップ | 警告出力 + 案内 | `github-integration.ts:90-95` |
| GitHub 設定未設定時 | サイレントスキップ | 警告出力 + 案内 | `github-integration.ts:100-105` |
| 仕様書作成後のコミット | なし | 自動 `git add` + `git commit` | `spec-create.md:Step 9.5` |
| ブランチ命名規則 | `spec/` プレフィックス許可 | `feature/` に統一、develop 以外から警告 | `spec-create.md:Step 4` |
| フェーズ移行時の Issue 確認 | なし | 警告出力 + 案内 | `spec-phase.md:Step 4` |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| GitHub トークン未設定時の警告 | 警告メッセージが console.warn に出力される | Jest モック + console.warn キャプチャ |
| GitHub 設定未設定時の警告 | 警告メッセージが console.warn に出力される | Jest モック + console.warn キャプチャ |
| 仕様書自動コミット | spec-create 実行後にコミットが作成される | 手動テスト（E2E） |
| ブランチ命名規則 | develop 以外からの実行時に警告 | 手動テスト（E2E） |

### 7.5 移行計画

#### Phase 1: GitHub 統合の警告出力強化

1. `src/core/workflow/github-integration.ts` の `spec.created` ハンドラーを修正
2. GitHub トークン未設定時に `console.warn()` で警告出力
3. GitHub 設定未設定時に `console.warn()` で警告出力
4. 既存テストへの影響確認

#### Phase 2: spec-create.md の修正

1. Step 4: ブランチ命名規則を `feature/` に統一
2. Step 4: develop 以外からの実行時に警告を追加
3. Step 9.5: 仕様書ファイルの自動コミットを追加
4. `npm run sync:dogfood` で同期

#### Phase 3: spec-phase.md の修正

1. Step 4: GitHub Issue 連携状態確認ロジックを追加
2. GitHub Issue がない場合の警告メッセージを追加
3. `npm run sync:dogfood` で同期

---

## 8. 実装タスクリスト

### Phase 1: GitHub 統合の警告出力強化

- [x] `src/core/workflow/github-integration.ts` の `spec.created` ハンドラーで GitHub トークン未設定時に警告出力を追加
- [x] `src/core/workflow/github-integration.ts` の `spec.created` ハンドラーで GitHub 設定未設定時に警告出力を追加
- [x] 既存テスト（`tests/core/workflow/github-integration.test.ts`）への影響確認・修正

### Phase 2: spec-create.md の修正

- [x] `src/slash-commands/spec-create.md` の Step 4 でブランチ命名規則を `feature/` に統一
- [x] `src/slash-commands/spec-create.md` の Step 4 で develop 以外からの実行時に警告を追加
- [x] `src/slash-commands/spec-create.md` に Step 9.5（仕様書ファイルの自動コミット）を追加
- [x] `npm run sync:dogfood` で `.cc-craft-kit/` へ同期

### Phase 3: spec-phase.md の修正

- [x] `src/slash-commands/spec-phase.md` の Step 4 に GitHub Issue 連携状態確認ロジックを追加
- [x] `npm run sync:dogfood` で `.cc-craft-kit/` へ同期

### Phase 4: 最終確認

- [x] `npm run typecheck` で型チェック
- [x] `npm run lint` でリントチェック
- [x] `npm test` でテスト実行
