# /cft:spec-create で GitHub Issue が作成されない

**仕様書 ID:** ef2fd782-d425-4c8e-83b9-318673084f88
**フェーズ:** requirements
**作成日時:** 2025/11/30 11:01:09
**更新日時:** 2025/11/30 11:01:09

---

## 1. 背景と目的

### 背景

現在の `/cft:spec-create` コマンド実行時、仕様書の作成と DB 登録は成功するが、GitHub Issue が自動作成されない問題が発生している。また、その後の各フェーズ（design, implementation, completed）でも GitHub Issue がないにもかかわらず、警告なしに処理が進行してしまう。

原因として以下が考えられる:
1. イベントハンドラー登録のタイミング問題（非同期登録で `spec.created` イベント発火時に未登録）
2. GitHub 設定チェック失敗時のサイレント失敗（警告ログが出力されない）
3. `/cft:github-init` 未実行時の動作が不明確

また、関連する問題として、`/cft:spec-create` 実行後に仕様書ファイル（`.cc-craft-kit/specs/*.md`）が自動コミットされず、未追跡ファイルとして残ってしまう現象も確認されている。仕様書作成時にブランチ作成・切り替えは行われるが、ファイルのステージングとコミットが行われていない。

### 目的

`/cft:spec-create` 実行時に GitHub Issue が確実に作成され、GitHub 統合が未設定の場合は明確な警告をユーザーに提示する仕組みを実装する。また、各フェーズ移行時に GitHub Issue との連携状態を確認し、必要に応じて警告または自動修復を行う

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発（SDD）を行う開発者。特に GitHub との連携を期待しているユーザー

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-create` 実行時、GitHub 統合が設定済みであれば Issue が自動作成されること
- [ ] GitHub 統合が未設定の場合、明確な警告メッセージが表示されること
- [ ] イベントハンドラー登録完了後にイベントが発火されること

### 機能要件

- [ ] `spec.created` イベント発火前にハンドラー登録完了を保証する仕組みを実装
- [ ] GitHub 設定チェック失敗時に警告ログを出力
- [ ] 各フェーズ移行時（design, impl, completed）に GitHub Issue 連携状態を確認
- [ ] GitHub Issue がない場合、警告を表示し `/cft:github-issue-create` を案内
- [ ] 仕様書ファイル作成後、自動的にステージングとコミットを行う

### 非機能要件

- [ ] 既存の処理フローを破壊しないこと（後方互換性）
- [ ] エラーハンドリングを強化し、デバッグ情報を充実させる

---

## 4. 制約条件

- プロンプトファースト原則に従い、可能な限りプロンプトベース（.md）で実装
- イベントバスの設計パターン（EventEmitter2）を維持
- GitHub API のレート制限を考慮（バッチ処理、リトライ）
- 既存のテストを破壊しない

---

## 5. 依存関係

- `src/core/workflow/event-bus.ts` - イベントバス実装
- `src/core/workflow/github-integration.ts` - GitHub 統合イベントハンドラー
- `src/core/spec/register-spec.ts` - 仕様書登録処理
- `src/integrations/github/sync.ts` - GitHub 同期サービス
- `.cc-craft-kit/slash-commands/spec-create.md` - spec-create コマンド定義
- `.cc-craft-kit/slash-commands/spec-phase.md` - spec-phase コマンド定義

---

## 6. 参考情報

- GitHub Sub Issue 連携機能: コミット dd99509
- EventEmitter2 ドキュメント: https://github.com/EventEmitter2/EventEmitter2
- 既存の GitHub 統合テスト: `tests/integrations/github/`
