---
id: "09b2c271-a89e-4eb1-811f-2ebabcfce1d4"
name: "/cft:status と /cft:spec list で他ブランチの仕様書が表示されない"
phase: "design"
branch_name: "fix/spec-09b2c271-status-list-show-all-branches"
github_issue_number: null
pr_url: null
created_at: "2025-12-07T07:15:00.000Z"
updated_at: "2025-12-07T07:30:00.000Z"
---

# /cft:status と /cft:spec list で他ブランチの仕様書が表示されない

## 1. 背景と目的

### 背景

現在の `/cft:status` および `/cft:spec list` コマンドは、**現在のブランチにあるファイルのみ** を対象に仕様書を集計・表示している。

これにより、以下の問題が発生する:

1. **作業ブランチの仕様書が見えない**: `develop` ブランチにいる場合、`fix/spec-xxx` ブランチで作成された仕様書がカウント・表示されない
2. **プロジェクト全体の状況が把握できない**: 複数の作業ブランチで並行開発している場合、全体像が見えない
3. **仕様書の重複作成リスク**: 他ブランチにある仕様書の存在に気づかず、同じ内容の仕様書を作成してしまう可能性がある

**実例:**
- `fix/spec-bcc860f0-status-phase-count-incorrect` ブランチで作成した仕様書 `bcc860f0` が、`develop` ブランチからは見えない
- `/cft:status` で requirements: 1 件と表示されるが、実際には別ブランチに requirements フェーズの仕様書が追加で存在する

### 目的

`/cft:status` および `/cft:spec list` コマンドで、すべてのローカルブランチにある仕様書を集計・表示できるようにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:status` で全ブランチの仕様書がカウントされる
- [ ] `/cft:spec list` で全ブランチの仕様書が表示される
- [ ] 現在のブランチにない仕様書には、所属ブランチ情報が表示される

### 機能要件

- [ ] `spec-` を含むブランチ名から仕様書ファイルを検索
- [ ] 各仕様書の YAML フロントマター内 `branch_name` フィールドを活用
- [ ] 重複排除: 同じ仕様書が複数ブランチにある場合は1件としてカウント
- [ ] ブランチ情報の表示: 現在のブランチ以外の仕様書には `[branch-name]` を付与

### 非機能要件

- [ ] 多数のブランチ（20件以上）があっても高速に処理できる
- [ ] TypeScript を使用しない（スラッシュコマンドのみで実装）

---

## 4. 制約条件

- スラッシュコマンド（.md ファイル）のみで実装
- TypeScript は使用しない
- gh CLI と標準的な Unix コマンド（git, grep, sed, awk 等）のみ使用可能

---

## 5. 依存関係

- `.claude/commands/cft/spec.md` - list サブコマンドの実装
- `.claude/commands/cft/status.md` - status コマンドの実装
- 関連 Issue: bcc860f0 (フェーズ件数集計の問題) - この仕様書で併せて対応

---

## 6. 参考情報

- 仕様書の YAML フロントマターには `branch_name` フィールドがあり、作成時のブランチ名が記録されている
- `git show <branch>:<file>` で他ブランチのファイル内容を取得可能
- `git for-each-ref --format='%(refname:short)' refs/heads/` でローカルブランチ一覧を取得可能

---

## 7. 設計詳細

### 7.1 修正対象ファイル

| ファイル | 修正内容 |
|----------|----------|
| `.claude/commands/cft/status.md` | 全ブランチの仕様書を集計するロジックを追加 |
| `.claude/commands/cft/spec.md` | list サブコマンドで全ブランチの仕様書を表示するロジックを追加 |

### 7.2 全ブランチ仕様書収集アルゴリズム

以下の手順で全ブランチの仕様書を収集する:

```
1. ローカルブランチ一覧を取得
   git for-each-ref --format='%(refname:short)' refs/heads/ | grep 'spec-'

2. 各ブランチの仕様書ファイル一覧を取得
   git ls-tree -r --name-only <branch> .cc-craft-kit/specs/ 2>/dev/null | grep '\.md$'

3. 各仕様書の YAML フロントマターを取得
   git show <branch>:<file> | head -15

4. 仕様書 ID で重複排除（同じ ID の仕様書は最新のブランチを優先）

5. フェーズごとに集計
```

### 7.3 出力フォーマットの変更

#### /cft:status の変更

現在:
```
| フェーズ | 件数 |
|---------|-----:|
| requirements | 1 |
```

変更後:
```
| フェーズ | 件数 | うち他ブランチ |
|---------|-----:|-------------:|
| requirements | 3 | 2 |
```

#### /cft:spec list の変更

現在:
```
| ID | 名前 | フェーズ | 更新日時 |
```

変更後:
```
| ID | 名前 | フェーズ | ブランチ | 更新日時 |
```

- 現在のブランチにある仕様書: ブランチ列は `-` または空
- 他ブランチにある仕様書: ブランチ列にブランチ名（短縮形）を表示

### 7.4 フェーズ集計の改善（bcc860f0 の問題対応）

YAML フロントマターのみを正確に解析するため、以下のパターンを使用:

```bash
# 各ファイルの先頭10行のみを対象に phase: を抽出
git show <branch>:<file> 2>/dev/null | head -10 | grep '^phase:' | sed 's/phase: *//; s/"//g'
```

これにより:
- 本文中の `phase: design` などのテンプレート記述はマッチしない
- 引用符の有無（`"completed"` と `completed`）の両方に対応

### 7.5 パフォーマンス考慮

多数のブランチ・仕様書がある場合のパフォーマンスを確保:

1. **ブランチフィルタリング**: `spec-` を含むブランチのみを対象
2. **並列実行不可**: スラッシュコマンドは直列実行のため、ブランチ数を制限（最大20件）
3. **キャッシュなし**: 毎回最新の状態を取得（リアルタイム性を優先）

---

## 8. 実装タスクリスト

### Phase 1: status.md の修正

- [ ] Step 1 を修正: 全ブランチの仕様書を集計するロジックに変更
- [ ] 出力フォーマットに「うち他ブランチ」列を追加

### Phase 2: spec.md の修正

- [ ] list サブコマンドの Step 1 を修正: 全ブランチの仕様書ファイル一覧を取得
- [ ] 出力フォーマットに「ブランチ」列を追加
- [ ] フェーズフィルタリングを YAML フロントマターのみ対象に修正
