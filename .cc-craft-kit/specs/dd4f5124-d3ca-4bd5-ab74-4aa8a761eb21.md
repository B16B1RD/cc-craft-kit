# 詳細設計とタスク分割フェーズの統合可否を検討し実装

**仕様書 ID:** dd4f5124-d3ca-4bd5-ab74-4aa8a761eb21
**フェーズ:** implementation
**作成日時:** 2025/11/25 19:01:52
**更新日時:** 2025/11/25 21:33:42

---

## 1. 背景と目的

### 背景

現在の cc-craft-kit は 5 フェーズモデル（requirements → design → tasks → implementation → completed）を採用しているが、以下の課題がある:

1. **design と tasks フェーズの分離による非効率**: 詳細設計を行う段階でタスク分割も同時に検討するのが自然な流れだが、現状は別フェーズとして分離されている
2. **タスク管理の不明確さ**: tasks テーブルは存在するが、仕様書ファイルとの同期フローが確立されていない
3. **セッション継続性の課題**: Claude Code のセッションを跨いで作業を継続する際、GitHub Issue に情報が集約されていないと作業状況の把握が困難
4. **並列作業の非効率**: 複数のタスクを並列で進める際の追跡手段が不足している

GitHub は 2024年10月に Sub Issue 機能（Public Preview）をリリースしており、親 Issue に最大 50 個の Sub Issue を紐付け、最大 8 階層のネストが可能。進捗は自動的に親 Issue に反映される。

### 目的

1. **フェーズの簡素化**: design と tasks フェーズを統合し、4 フェーズモデル（requirements → design → implementation → completed）に移行する
2. **GitHub Issue 中心の情報管理**: 仕様書の詳細情報と進捗を GitHub Issue に集約し、セッション間での情報共有を容易にする
3. **Sub Issue によるタスク管理**: 設計フェーズで生成されたタスクを Sub Issue として自動作成し、並列作業と進捗追跡を可能にする

---

## 2. 対象ユーザー

- cc-craft-kit を使用して仕様駆動開発（SDD）を行う開発者
- Claude Code を使用してセッションを跨いだ開発作業を行うユーザー
- GitHub Projects でプロジェクト管理を行うチーム

---

## 3. 受け入れ基準

### 必須要件

- [ ] design フェーズで詳細設計とタスク分割を同時に実行できる
- [ ] tasks フェーズを削除し、4 フェーズモデルに移行する
- [ ] design フェーズ完了時にタスクを Sub Issue として自動作成する
- [ ] 既存の仕様書（tasks フェーズ）を design フェーズにマイグレーションできる
- [ ] GitHub Issue 本文に仕様書の全内容を同期する

### 機能要件

- [ ] `/cft:spec-phase <id> design` 実行時に設計詳細セクションとタスクリストを生成する
- [ ] タスクリストの各項目を Sub Issue として自動作成する
- [ ] Sub Issue のステータス変更を親 Issue の進捗に反映する
- [ ] Sub Issue に作業メモ（進捗、エラー解決策、Tips）をコメントとして記録する
- [ ] `/cft:task-list <spec-id>` コマンドで Sub Issue の一覧と進捗を表示する
- [ ] `/cft:task-start <task-id>` コマンドで Sub Issue を「In Progress」に更新し作業を開始する
- [ ] `/cft:task-done <task-id>` コマンドで Sub Issue を「Done」に更新する

### 非機能要件

- [ ] フェーズ統合による既存データの破壊的変更を避ける（マイグレーションで対応）
- [ ] GitHub API 呼び出し回数を最小化する（バッチ処理、キャッシュ活用）
- [ ] Sub Issue 作成失敗時のリトライ機構を実装する

---

## 4. 制約条件

1. **GitHub Sub Issue の制限**
   - 親 Issue あたり最大 50 Sub Issue
   - 最大 8 階層のネスト
   - Public Preview 機能のため API 仕様変更の可能性あり

2. **後方互換性**
   - 既存の tasks フェーズにある仕様書は design フェーズに自動マイグレーション
   - tasks テーブルのデータは github_sync テーブルを通じて Sub Issue と紐付け

3. **技術的制約**
   - GitHub GraphQL API を使用（Sub Issue 操作に必要）
   - GITHUB_TOKEN に適切なスコープ（`repo`, `project`）が必要

---

## 5. 依存関係

### 内部依存

- `src/core/database/schema.ts`: SpecPhase 型定義の変更
- `src/core/workflow/github-integration.ts`: Sub Issue 作成・同期ロジック
- `src/core/workflow/phase-automation.ts`: design フェーズの自動処理拡張
- `.cc-craft-kit/slash-commands/spec-phase.md`: フェーズ遷移プロンプトの更新

### 外部依存

- GitHub Sub Issue API（GraphQL）
- GitHub Projects API（ステータス同期）

---

## 6. 参考情報

- [GitHub Sub Issues 公式ドキュメント](https://docs.github.com/en/issues/tracking-your-work-with-issues/using-issues/adding-sub-issues)
- [Evolving GitHub Issues (Public Preview)](https://github.blog/changelog/2025-01-13-evolving-github-issues-public-preview/)
- [Sub-issues: Enhancing issue management on GitHub](https://github.blog/engineering/architecture-optimization/introducing-sub-issues-enhancing-issue-management-on-github/)
- [GitHub Community Discussion #139932](https://github.com/orgs/community/discussions/139932)

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│                        cc-craft-kit フェーズ統合                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────┐      ┌──────────────┐      ┌──────────────┐              │
│  │ requirements │ ──▶  │    design    │ ──▶  │implementation│ ──▶ completed│
│  │              │      │              │      │              │              │
│  │  ・要件定義  │      │  ・詳細設計  │      │  ・実装作業  │              │
│  │  ・受入基準  │      │  ・タスク分割│      │  ・テスト    │              │
│  │              │      │  ・Sub Issue │      │              │              │
│  └──────────────┘      └──────────────┘      └──────────────┘              │
│                              │                                              │
│                              ▼                                              │
│                    ┌─────────────────┐                                      │
│                    │  GitHub Issue   │                                      │
│                    │  (親 Issue)     │                                      │
│                    │       │         │                                      │
│                    │       ▼         │                                      │
│                    │  ┌──────────┐   │                                      │
│                    │  │Sub Issue │   │                                      │
│                    │  │  Task 1  │   │                                      │
│                    │  ├──────────┤   │                                      │
│                    │  │Sub Issue │   │                                      │
│                    │  │  Task 2  │   │                                      │
│                    │  ├──────────┤   │                                      │
│                    │  │   ...    │   │                                      │
│                    │  └──────────┘   │                                      │
│                    └─────────────────┘                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 設計方針

1. **フェーズ統合**: tasks フェーズを design フェーズに統合し、5 フェーズから 4 フェーズへ簡素化
2. **後方互換性維持**: 既存の tasks フェーズは非推奨として継続サポート
3. **プロンプト優先**: CLAUDE.md の原則に従い、タスク分割はプロンプトで実装
4. **既存基盤活用**: SubIssueManager クラスは既に完全実装済みのため再利用

#### 処理フロー詳細

**design フェーズ移行時の統合フロー:**

```text
/cft:spec-phase <id> design
         │
         ▼
┌─────────────────────────┐
│ 1. バリデーション        │ ← requirements セクション確認
└─────────────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 2. コードベース解析      │ ← Explore サブエージェント
└─────────────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 3. 設計詳細セクション生成 │ ← Edit ツール
│    - アーキテクチャ設計   │
│    - 実装方針            │
│    - 機能マッピング       │
│    - テスト戦略           │
│    - 移行計画            │
└─────────────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 4. タスクリスト生成      │ ← TodoWrite + Edit ツール
│    「## 8. 実装タスク」   │
└─────────────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 5. Sub Issue 自動作成    │ ← SubIssueManager（既存）
│    (GitHub Issue 存在時) │
└─────────────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 6. 自動コミット          │ ← Git
└─────────────────────────┘
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/core/database/schema.ts` | SpecPhase 型から tasks を非推奨化（型定義は維持） |
| `src/core/workflow/github-integration.ts` | Sub Issue 作成トリガーを `tasks` → `design` に変更 |
| `src/core/workflow/phase-automation.ts` | `handleDesignPhase()` にタスク分割トリガーを追加 |
| `src/slash-commands/spec-phase.md` | design フェーズ後処理にタスク分割・Sub Issue 作成を統合 |

#### 変更しないファイル

| ファイル | 理由 |
|---------|------|
| `src/integrations/github/sub-issues.ts` | 既に完全実装済み、変更不要 |
| `src/core/utils/task-parser.ts` | 既存のタスク解析ロジックを再利用 |
| `src/core/database/migrations/*` | 新規マイグレーション不要 |

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| フェーズ定義 | 5 フェーズ (req/des/tasks/impl/comp) | 4 フェーズ + 非推奨 1 | `schema.ts` |
| タスク分割 | tasks フェーズで実行 | design フェーズで実行 | `spec-phase.md` |
| Sub Issue 作成 | tasks フェーズトリガー | design フェーズトリガー | `github-integration.ts` |
| 設計詳細生成 | design フェーズで実行 | 変更なし | `spec-phase.md` |
| タスクリスト表示 | 新規 | `/cft:task-list` コマンド追加（オプション） | `slash-commands/` |
| タスク開始 | 新規 | `/cft:task-start` コマンド追加（オプション） | `slash-commands/` |
| タスク完了 | 新規 | `/cft:task-done` コマンド追加（オプション） | `slash-commands/` |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| フェーズ遷移 | design フェーズでタスク分割が実行される | `tests/commands/spec/phase.test.ts` |
| Sub Issue 作成 | design フェーズ完了時に Sub Issue が作成される | `tests/integrations/sub-issue-workflow.test.ts` |
| 後方互換性 | tasks フェーズの仕様書が正常に処理される | 既存テストの維持 |
| マイグレーション | tasks → design への変換が正常に動作 | 新規 E2E テスト |
| バリデーション | design 移行時の必須セクション確認 | `tests/core/workflow/phase-transition-validator.test.ts` |

### 7.5 移行計画

#### Phase 1: 基盤変更（破壊的変更なし）

1. `schema.ts`: SpecPhase 型にコメントで非推奨を明示
2. `spec-phase.md`: design フェーズ後処理にタスク分割を追加
3. テスト更新: design フェーズでのタスク分割をカバー

#### Phase 2: GitHub 統合変更

1. `github-integration.ts`: Sub Issue 作成トリガーを design に変更
2. `phase-automation.ts`: design フェーズハンドラーを拡張
3. E2E テスト: Sub Issue 作成フローの検証

#### Phase 3: 新規コマンド追加（オプション）

1. `/cft:task-list <spec-id>`: Sub Issue 一覧表示
2. `/cft:task-start <task-id>`: Sub Issue を In Progress に更新
3. `/cft:task-done <task-id>`: Sub Issue を Done に更新

#### Phase 4: ドキュメント・マイグレーション

1. README.md: 新フェーズモデルの説明追加
2. マイグレーションスクリプト: tasks → design 一括変換（任意実行）
3. 非推奨警告: tasks フェーズ使用時に警告表示

### 7.6 API 呼び出し最適化

#### 現在の API 呼び出し数（N タスクの場合）

| 操作 | 呼び出し回数 | API 種別 |
|-----|------------|---------|
| 親 Issue Node ID 取得 | 1 | REST |
| 子 Issue 作成 | N | REST |
| 子 Issue Node ID 取得 | N | REST |
| 親への Sub Issue 追加 | N | GraphQL |
| **合計** | **3N + 1** | - |

#### レート制限対策（既存実装）

- 指数バックオフ: `fetchWithRetry()` で実装済み
- 429 ステータス: `retry-after` ヘッダー確認
- 初期待機: 1000ms × 2^attempt

### 7.7 エラーハンドリング

| エラー種別 | 対策 | 実装場所 |
|----------|------|---------|
| GitHub API レート制限 | 指数バックオフ + リトライ | `SubIssueManager` |
| Sub Issue 作成失敗 | 部分成功を許容、エラーログ出力 | `github-integration.ts` |
| タスク解析失敗 | 警告表示、手動でのタスク追加を案内 | `spec-phase.md` |
| GraphQL 認証エラー | トークンスコープ確認を促すメッセージ | 各ハンドラー |

---

## 8. 実装タスクリスト

### Phase 1: 基盤変更（破壊的変更なし）

- [x] `schema.ts` の SpecPhase 型から tasks を非推奨化（型定義は維持）
- [x] `spec-phase.md` の design フェーズ後処理にタスク分割・Sub Issue 作成を統合
- [x] テスト更新: design フェーズでのタスク分割をカバー

### Phase 2: GitHub 統合変更

- [x] `github-integration.ts` の Sub Issue 作成トリガーを tasks → design に変更
- [x] `phase-automation.ts` の handleDesignPhase() にタスク分割トリガーを追加
- [ ] E2E テスト: Sub Issue 作成フローの検証

### Phase 3: 新規コマンド追加（オプション）

- [x] `/cft:task-list <spec-id>`: Sub Issue 一覧表示コマンドを追加
- [x] `/cft:task-start <task-id>`: Sub Issue を In Progress に更新するコマンドを追加
- [x] `/cft:task-done <task-id>`: Sub Issue を Done に更新するコマンドを追加

### Phase 4: ドキュメント・マイグレーション

- [x] tasks → design への既存仕様書マイグレーションスクリプトを作成
- [x] tasks フェーズ使用時に非推奨警告を表示
