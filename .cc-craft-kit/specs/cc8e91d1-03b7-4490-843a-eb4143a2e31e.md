# req / design の各フェーズ切り替え時、req の場合は要求仕様、design の場合は詳細設計が不十分の場合は、自動で調査して埋める

**仕様書 ID:** cc8e91d1-03b7-4490-843a-eb4143a2e31e
**フェーズ:** requirements
**作成日時:** 2025/11/23 01:22:52
**更新日時:** 2025/11/23 01:22:52

---

## 1. 背景と目的

### 背景

現在、`/cft:spec-phase` コマンドでフェーズを切り替える際、仕様書ファイルの内容が不十分な場合でもフェーズ遷移が許可されてしまいます。特に以下の問題が発生しています。

- **Requirements フェーズ**: 背景・目的・受け入れ基準などがプレースホルダーのまま Design フェーズに移行できてしまう
- **Design フェーズ**: 設計詳細セクション（セクション 7）が未記述でも Implementation フェーズに移行できてしまう
- **手動での補完作業**: 開発者が仕様書を手動で確認・編集する必要があり、作業効率が低い

これにより、不完全な仕様書のまま実装が進み、後工程でのトラブルや手戻りの原因となっている。

### 目的

フェーズ切り替え時に仕様書の内容を自動的に検証し、不足情報がある場合は以下を実現します。

1. **自動調査・補完**: コードベース解析や既存仕様書から情報を推論して自動的に補完する
2. **対話的な情報収集**: 推論が困難な情報についてはユーザーに質問し、回答をもとに仕様書を完成させる
3. **フェーズ遷移のゲート機能**: 必須情報が不足している場合はフェーズ遷移を一時的にブロックし、補完完了後に遷移する

これにより、仕様書の品質を担保しつつ、開発者の手間を削減し、スムーズな開発フローを実現する。

---

## 2. 対象ユーザー

**プライマリユーザー**: cc-craft-kit を使用してソフトウェア開発する開発者。

**ユースケース**:

- 仕様書を作成し、フェーズを切り替えながら開発を進める開発者
- Claude Code を使用して仕様駆動開発（SDD）を実践する開発者
- 仕様書の品質を自動的に担保したいプロジェクトリーダー

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-phase <spec-id> design` 実行時、Requirements フェーズの必須セクションが不足している場合、自動的に補完される
- [ ] `/cft:spec-phase <spec-id> implementation` 実行時、Design フェーズの設計詳細セクション（セクション 7）が不足している場合、自動的に補完される
- [ ] 自動補完に必要な情報が不足している場合、ユーザーに質問し、回答をもとに仕様書を完成させる
- [ ] フェーズ遷移前に仕様書の品質が十分であることを確認し、不十分な場合は補完完了後に遷移する

### 機能要件

- [ ] **要件フェーズ (Requirements) の検証項目**:
  - 背景と目的セクションが具体的に記述されている（プレースホルダーが残っていない）
  - 対象ユーザーが明記されている
  - 受け入れ基準（必須要件・機能要件・非機能要件）が具体的に記述されている
  - 制約条件が記述されている（該当なしの場合は「なし」と明記）
  - 依存関係が記述されている（該当なしの場合は「なし」と明記）

- [ ] **設計フェーズ (Design) の検証項目**:
  - セクション 7「設計詳細」が存在し、以下のサブセクションが含まれている:
    - アーキテクチャ設計
    - API の仕様（該当する場合）
    - データモデル（該当する場合）
    - セキュリティ考慮事項
    - テスト戦略

- [ ] **自動補完の処理フロー**:
  1. コードベース解析（Explore サブエージェント）で関連実装を調査
  2. 既存仕様書から類似パターンを検索
  3. 推論可能な情報を自動的に記述
  4. 推論が困難な情報については `AskUserQuestion` ツールでユーザーに質問
  5. 仕様書ファイルを Edit ツールで更新

- [ ] **エラーハンドリング**:
  - 自動補完に失敗した場合、エラーメッセージを表示し、手動編集を案内する
  - フェーズ遷移は中断せず、不完全な状態でも遷移を許可するオプションを提供する（`--force` フラグ）

### 非機能要件

- [ ] **パフォーマンス**: コードベース解析は 30 秒以内に完了すること
- [ ] **ユーザビリティ**: 質問は最大 4 つまでとし、ユーザーの負担を最小限にすること
- [ ] **保守性**: 既存のフェーズ遷移ロジック（`phase-automation.ts`）を拡張する形で実装すること
- [ ] **テスタビリティ**: 自動補完ロジックは単体テスト可能な形で実装すること

---

## 4. 制約条件

1. **既存アーキテクチャとの整合性**:
   - イベント駆動アーキテクチャ（`EventBus`）を使用すること
   - `spec.phase_changed` イベントのハンドラーとして実装すること
   - 既存の `phase-automation.ts` のロジックを拡張する形で実装すること

2. **データベース操作の安全性**:
   - `getDatabase()` を使用してデータベース接続を取得すること
   - パラメータを指定せず、デフォルトのデータベースパスを使用すること

3. **ファイル操作の制約**:
   - 仕様書ファイルの読み書きは `Read` ツールと `Edit` ツールを使用すること
   - Bash コマンド（`cat`, `sed` など）での直接操作は禁止

4. **テスト環境での動作**:
   - `NODE_ENV === 'test'` または `E2E_TEST === 'true'` の場合、自動補完処理をスキップすること
   - テスト環境では GitHub API 呼び出しをモック化すること

5. **エラーハンドリングの標準化**:
   - `src/core/errors/` の標準エラークラスを使用すること
   - エラーメッセージにはセンシティブ情報を含めないこと

6. **コンテキスト消費の制限**:
   - コードベース解析（Explore サブエージェント）は thoroughness level: "medium" を使用すること
   - 想定コンテキスト消費: 約 20,000〜40,000 トークン

---

## 5. 依存関係

### 既存コンポーネント

- **`src/commands/spec/phase.ts`**: フェーズ更新コマンドのエントリポイント
- **`src/core/workflow/phase-automation.ts`**: フェーズ切り替え時の自動処理ハンドラー
- **`src/core/workflow/event-bus.ts`**: イベントバス（`spec.phase_changed` イベント）
- **`src/core/sync/spec-file-parser.ts`**: 仕様書ファイルのパーサー（メタデータ抽出）
- **`src/core/validators/spec-file-validator.ts`**: 仕様書ファイルのバリデーター

### 関連仕様書

- **`a85fe81b-3d27-4a5e-bbf1-3e395ebc1c77.md`**: CLAUDE.md 整理（completed）
  - 仕様書テンプレートの構造を参考にする
- **`edcc66aa-6963-4042-9772-847733c802bb.md`**: 仕様書ファイルパーサー（completed）
  - セクションの存在チェックロジックを参考にする
- **`20a0ff2e-bab4-43f3-838a-decfd71a96da.md`**: 品質要件自動チェック（completed）
  - バリデーションパターンを参考にする

### 外部ツール

- **Task ツール（Explore サブエージェント）**: コードベース解析に使用
- **AskUserQuestion ツール**: ユーザーへの対話的な質問に使用
- **Edit ツール**: 仕様書ファイルの自動更新に使用

---

## 6. 参考情報

### 参考実装

- **`/cft:spec-create` の自動完成フロー**: `.claude/commands/cft/spec-create.md`
  - フェーズ 0〜4 の処理フローを参考にする
  - コードベース解析の thoroughness level 設定を参考にする

### 関連ドキュメント

- **CLAUDE.md**: プロジェクト規約とコーディング規約
- **ARCHITECTURE.md**: アーキテクチャ設計（イベント駆動、モジュラーモノリス）

### 技術資料

- **EventEmitter2 ドキュメント**: <https://github.com/EventEmitter2/EventEmitter2>
- **Kysely ドキュメント**: <https://kysely.dev/>
- **TypeScript Handbook**: <https://www.typescriptlang.org/docs/handbook/intro.html>
