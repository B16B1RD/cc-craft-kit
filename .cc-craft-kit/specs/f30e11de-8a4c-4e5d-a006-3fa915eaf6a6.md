# implementation フェーズ時のタスク進行時、Sub Issue が更新されない

**仕様書 ID:** f30e11de-8a4c-4e5d-a006-3fa915eaf6a6
**フェーズ:** design
**作成日時:** 2025/12/01 00:00:00
**更新日時:** 2025/12/01 21:55:00

---

## 1. 背景と目的

### 背景

タスクの進行に合わせて、対応する各 Sub Issue の内容及びステータスも変更されるべき。現在作成された Sub Issue が Todo ステータスのままクローズもされず放置されている。何度も問題提起し修正依頼しているが一向に直る気配がない。

### 目的

implementation フェーズでタスクを進行（完了）した際に、対応する GitHub Sub Issue のステータスが自動的に更新されるようにする。これにより、GitHub 上での進捗管理とローカルのタスク管理の整合性を保つ。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者。特に GitHub Issue 連携機能を利用してプロジェクト管理を行うユーザー。

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:task done` でタスクを完了した際、対応する Sub Issue のステータスが「Done」に変更される
- [ ] Sub Issue が自動的にクローズされる

### 機能要件

- [ ] `task.completed` イベント発火時に、GitHub Sub Issue のステータス更新処理が確実に実行される
- [ ] イベントハンドラー登録のタイミング問題を解消し、ハンドラーが確実に登録された状態でイベントが発火される
- [ ] `github_sync` テーブルの `parent_issue_number`、`parent_spec_id` が正しく保存・取得される
- [ ] タスク完了時に対応する Sub Issue が存在しない場合、適切な警告メッセージを表示する

### 非機能要件

- [ ] GitHub API のレート制限に対応した適切なリトライ処理を維持する
- [ ] イベント駆動アーキテクチャの設計原則を維持する

---

## 4. 制約条件

- イベント駆動アーキテクチャを維持し、`task.completed` イベントハンドラーでのみ Sub Issue 更新を行う
- `github_sync` テーブルのスキーマ変更は最小限に抑える
- GitHub GraphQL API の Sub Issue 機能への依存を考慮する
- 既存の `SubIssueManager` クラスの API を可能な限り維持する

---

## 5. 依存関係

- `src/core/workflow/event-bus.ts` - EventBus のハンドラー登録・イベント発火
- `src/core/workflow/github-integration.ts` - `task.completed` イベントハンドラー
- `src/integrations/github/sub-issues.ts` - SubIssueManager クラス
- `src/commands/task/done.ts` - タスク完了コマンド
- `src/core/database/schema.ts` - github_sync テーブルスキーマ

---

## 6. 参考情報

- 推定される原因候補:
  1. イベントハンドラー登録のタイミング問題（`registerHandlersAsync()` の非同期実行）
  2. `getSubIssueInfo()` の `specId` が常に空文字列で返される問題
  3. `github_sync` テーブルへの `parent_issue_number`、`parent_spec_id` の未設定
  4. design フェーズをスキップした場合の Sub Issue 未作成

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
┌─────────────────────────────────────────────────────────────────┐
│                        タスク完了フロー                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  /cft:task done #123                                            │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────────────┐                                       │
│  │  task/done.ts       │                                       │
│  │  executeTaskDone()  │                                       │
│  └─────────┬───────────┘                                       │
│            │                                                    │
│            ▼                                                    │
│  ┌─────────────────────┐    ┌────────────────────────────┐     │
│  │  getSubIssueInfo()  │───▶│  github_sync テーブル      │     │
│  │  specId を取得      │    │  parent_spec_id を参照     │     │
│  └─────────┬───────────┘    └────────────────────────────┘     │
│            │                                                    │
│            ▼                                                    │
│  ┌─────────────────────┐                                       │
│  │  getEventBusAsync() │◀── ハンドラー登録完了を待機            │
│  └─────────┬───────────┘                                       │
│            │                                                    │
│            ▼                                                    │
│  ┌─────────────────────┐                                       │
│  │  task.completed     │                                       │
│  │  イベント発火       │                                       │
│  └─────────┬───────────┘                                       │
│            │                                                    │
│            ▼                                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  github-integration.ts                                   │   │
│  │  task.completed ハンドラー                               │   │
│  │                                                          │   │
│  │  1. SubIssueManager.handleTaskCompletion() 呼び出し      │   │
│  │  2. 親 Issue ステータス更新                               │   │
│  │  3. GitHub Projects ステータス更新                        │   │
│  └─────────┬────────────────────────────────────────────────┘   │
│            │                                                    │
│            ▼                                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  SubIssueManager                                         │   │
│  │  handleTaskCompletion()                                  │   │
│  │                                                          │   │
│  │  1. github_sync から Sub Issue 情報を取得                │   │
│  │  2. Sub Issue をクローズ（GitHub API）                   │   │
│  │  3. 親 Issue のチェックボックスを更新                     │   │
│  │  4. 全 Sub Issue がクローズなら親 Issue も自動クローズ    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 設計方針

**問題 1: ハンドラー登録タイミング**
- `getEventBus()` → `getEventBusAsync()` に変更
- イベント発火前にハンドラー登録完了を保証

**問題 2: specId が取得されない**
- `getSubIssueInfo()` で `parent_spec_id` を DB から取得して返す
- イベント発火時に正しい `specId` を設定

**問題 3: 既存の DB レコードの後方互換性**
- `parent_spec_id` が null の場合は警告ログを出力して処理続行
- 新規 Sub Issue 作成時は必ず `parent_spec_id` を記録

#### 処理フロー詳細

```
1. executeTaskDone(issueNumber)
   │
   ├─ getSubIssueInfo(issueNumber)
   │   └─ SELECT parent_spec_id, entity_id FROM github_sync
   │       WHERE entity_type='sub_issue' AND github_number=issueNumber
   │
   ├─ getEventBusAsync() ← 新規追加
   │   └─ ハンドラー登録完了まで待機（タイムアウト: 5秒）
   │
   └─ eventBus.emit('task.completed', { specId, taskId })
       │
       └─ task.completed ハンドラー
           │
           └─ SubIssueManager.handleTaskCompletion(taskId, token)
               │
               ├─ SELECT * FROM github_sync
               │   WHERE entity_id=taskId AND entity_type='sub_issue'
               │
               ├─ GitHub API: Issue をクローズ
               │   PATCH /repos/{owner}/{repo}/issues/{issue_number}
               │   { state: 'closed' }
               │
               └─ 親 Issue チェックボックス更新
                   PATCH /repos/{owner}/{repo}/issues/{parent_issue_number}
                   { body: 更新された本文 }
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/commands/task/done.ts` | `getSubIssueInfo()` で `parent_spec_id` を返す、`getEventBusAsync()` を使用 |
| `src/core/workflow/event-bus.ts` | `getEventBusAsync()` のタイムアウトを 10 秒に延長（オプション） |

#### 変更しないファイル

以下のファイルは変更不要（既に正しく実装済み）:
- `src/core/workflow/github-integration.ts` - ハンドラーは正常に実装済み
- `src/integrations/github/sub-issues.ts` - `handleTaskCompletion()` は正常に実装済み
- `src/core/database/schema.ts` - スキーマ変更不要

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| specId 取得 | 常に空文字列 `''` を返す | `parent_spec_id` を DB から取得 | `task/done.ts:44-68` |
| EventBus 取得 | `getEventBus()` 同期呼び出し | `getEventBusAsync()` 非同期呼び出し | `task/done.ts:118` |
| イベント発火 | `specId=''` でイベント発火 | 正しい `specId` でイベント発火 | `task/done.ts:121-128` |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| `getSubIssueInfo()` | `parent_spec_id` が正しく取得される | ユニットテスト |
| ハンドラー登録待機 | `getEventBusAsync()` でハンドラー登録完了を待機 | 統合テスト |
| イベント発火 | `specId` がイベントに含まれる | 統合テスト |
| Sub Issue クローズ | タスク完了時に Sub Issue が closed になる | E2E テスト |
| 親 Issue 更新 | チェックボックスが更新される | E2E テスト |

### 7.5 移行計画

#### Phase 1: task/done.ts の修正

1. `getSubIssueInfo()` で `parent_spec_id` を返す
2. `getEventBusAsync()` を使用してハンドラー登録を待機
3. イベント発火時に正しい `specId` を設定

#### Phase 2: テスト追加

1. `getSubIssueInfo()` のユニットテスト追加
2. ハンドラー登録待機の統合テスト追加
3. 既存の Sub Issue ワークフローテストを更新

#### Phase 3: 動作検証

1. `npm run sync:dogfood` で同期
2. 実際のタスク完了で Sub Issue が更新されることを確認

---

## 8. 実装タスクリスト

### Phase 1: task/done.ts の修正

- [ ] `getSubIssueInfo()` で `parent_spec_id` を取得して返す
- [ ] `executeTaskDone()` で `getEventBusAsync()` を使用
- [ ] イベント発火時に正しい `specId` を設定

### Phase 2: テスト追加

- [ ] `getSubIssueInfo()` のユニットテスト追加
- [ ] 統合テストで Sub Issue 更新を検証

### Phase 3: 動作検証

- [ ] `npm run sync:dogfood` で同期
- [ ] 実際のタスク完了で Sub Issue が更新されることを確認
