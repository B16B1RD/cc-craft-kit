# implementation フェーズ時のタスク進行時、Sub Issue が更新されない

**仕様書 ID:** f30e11de-8a4c-4e5d-a006-3fa915eaf6a6
**フェーズ:** requirements
**作成日時:** 2025/12/01 00:00:00
**更新日時:** 2025/12/01 00:00:00

---

## 1. 背景と目的

### 背景

タスクの進行に合わせて、対応する各 Sub Issue の内容及びステータスも変更されるべき。現在作成された Sub Issue が Todo ステータスのままクローズもされず放置されている。何度も問題提起し修正依頼しているが一向に直る気配がない。

### 目的

implementation フェーズでタスクを進行（完了）した際に、対応する GitHub Sub Issue のステータスが自動的に更新されるようにする。これにより、GitHub 上での進捗管理とローカルのタスク管理の整合性を保つ。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者。特に GitHub Issue 連携機能を利用してプロジェクト管理を行うユーザー。

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:task done` でタスクを完了した際、対応する Sub Issue のステータスが「Done」に変更される
- [ ] Sub Issue が自動的にクローズされる

### 機能要件

- [ ] `task.completed` イベント発火時に、GitHub Sub Issue のステータス更新処理が確実に実行される
- [ ] イベントハンドラー登録のタイミング問題を解消し、ハンドラーが確実に登録された状態でイベントが発火される
- [ ] `github_sync` テーブルの `parent_issue_number`、`parent_spec_id` が正しく保存・取得される
- [ ] タスク完了時に対応する Sub Issue が存在しない場合、適切な警告メッセージを表示する

### 非機能要件

- [ ] GitHub API のレート制限に対応した適切なリトライ処理を維持する
- [ ] イベント駆動アーキテクチャの設計原則を維持する

---

## 4. 制約条件

- イベント駆動アーキテクチャを維持し、`task.completed` イベントハンドラーでのみ Sub Issue 更新を行う
- `github_sync` テーブルのスキーマ変更は最小限に抑える
- GitHub GraphQL API の Sub Issue 機能への依存を考慮する
- 既存の `SubIssueManager` クラスの API を可能な限り維持する

---

## 5. 依存関係

- `src/core/workflow/event-bus.ts` - EventBus のハンドラー登録・イベント発火
- `src/core/workflow/github-integration.ts` - `task.completed` イベントハンドラー
- `src/integrations/github/sub-issues.ts` - SubIssueManager クラス
- `src/commands/task/done.ts` - タスク完了コマンド
- `src/core/database/schema.ts` - github_sync テーブルスキーマ

---

## 6. 参考情報

- 推定される原因候補:
  1. イベントハンドラー登録のタイミング問題（`registerHandlersAsync()` の非同期実行）
  2. `getSubIssueInfo()` の `specId` が常に空文字列で返される問題
  3. `github_sync` テーブルへの `parent_issue_number`、`parent_spec_id` の未設定
  4. design フェーズをスキップした場合の Sub Issue 未作成
