# ブランチ名が適当な名前になっている

**仕様書 ID:** c795fc91-1988-4994-a160-ad963b99921c
**フェーズ:** completed
**作成日時:** 2025/11/20 19:46:36
**更新日時:** 2025/11/20 20:46:14

---

## 1. 背景と目的

### 背景

現在、cc-craft-kit は仕様書作成時に自動的に `spec/<仕様書IDの先頭8文字>` 形式のブランチを作成します。

**問題点:**

- ブランチ名から仕様書の内容が推測できない
- 例: `spec/c795fc91` では何の機能を開発しているのか不明
- GitHub や git log でブランチ一覧を見たときに識別が困難

**改善の必要性:**
仕様書の内容に沿った意味のある名前（例: `spec/c795fc91-improve-branch-naming`）により、開発効率の向上を図りたい。

### 目的

仕様書作成時に、仕様書の内容を反映した人間が読みやすいブランチ名を自動生成する機能を実装する。

**期待される効果:**

1. ブランチ一覧から開発内容が一目で把握できる
2. Git 履歴の可読性が向上する
3. チーム開発時のコミュニケーションが円滑になる

---

## 2. 対象ユーザー

- cc-craft-kit を使用して仕様駆動開発を行う開発者
- プロジェクトの Git ブランチ履歴を確認する開発者・レビュアー

---

## 3. 受け入れ基準

### 必須要件

- [ ] 仕様書名からブランチ名を自動生成できる
- [ ] 生成されたブランチ名が Git の命名規則に準拠している（英数字、ハイフン、スラッシュのみ）
- [ ] 仕様書 ID の一部（先頭 8 文字）がブランチ名に含まれる（一意性の保証）
- [ ] ブランチ名の長さが適切に制限される（最大 63 文字など）

### 機能要件

- [ ] Claude Code が仕様書名と説明から適切な英語ブランチ名を生成する
- [ ] 生成されたブランチ名が意味のある、理解しやすい英語になっている
- [ ] 特殊文字や空白が適切に置換される（例: スペース → ハイフン）
- [ ] ブランチプレフィックス `spec/` が自動的に付与される
- [ ] 既存のブランチ命名規則（CLAUDE.md で定義）と整合性が取れる

### 非機能要件

- [ ] ブランチ名生成処理が 1 秒以内に完了する
- [ ] 同じ仕様書名から常に同じブランチ名が生成される（冪等性）
- [ ] エラー時は安全にフォールバックする（現在の ID ベース命名に戻る）

---

## 4. 制約条件

- Git のブランチ名として使用可能な文字のみ使用（英数字、ハイフン、スラッシュ、アンダースコア）
- ブランチ名の最大長は 63 文字（Git の推奨値）
- 保護ブランチ（main, develop）では自動ブランチ作成をスキップする（既存仕様を維持）
- 既存の `spec/` プレフィックスを維持し、後方互換性を保つ

---

## 5. 依存関係

- `src/commands/spec/create.ts` - 仕様書作成コマンド（ブランチ作成ロジックを含む）
- `src/core/git/branch-cache.ts` - ブランチキャッシュ機構
- `src/core/database/schema.ts` - `specs` テーブル定義（`branch_name` カラム）
- CLAUDE.md で定義されたブランチ戦略との整合性

---

## 6. 参考情報

- [Git ブランチ命名のベストプラクティス](https://git-scm.com/docs/git-check-ref-format)
- CLAUDE.md セクション「ブランチ管理」（既存の仕様書作成時の自動ブランチ作成仕様）
- `src/commands/spec/create.ts` の現在の実装（`spec/<仕様書IDの先頭8文字>` 生成ロジック）

---

## 7. 詳細設計

### 7.1 アーキテクチャ設計

#### 影響を受けるモジュール

1. **`src/slash-commands/spec-create.md`** (変更)
   - 仕様書作成時に Claude にブランチ名生成を指示する記述を追加

2. **`src/commands/spec/create.ts`** (変更)
   - `--branch-name` オプションを追加（Claude が生成したブランチ名を受け取る）
   - `createSpecBranch()` の呼び出し時にブランチ名を渡す

3. **`src/core/git/branch-creation.ts`** (変更)
   - `createSpecBranch()` 関数に `customBranchName` パラメータを追加
   - カスタムブランチ名が指定された場合はそれを使用、未指定の場合は従来通り `spec/${shortId}` を生成

#### レイヤー構造

```text
┌─────────────────────────────────────┐
│  Slash Commands                     │
│  - spec-create.md                   │
│    └─ Claude にブランチ名生成を指示    │
├─────────────────────────────────────┤
│  Claude Code (LLM)                  │
│  - 仕様書名・説明から英語ブランチ名を生成 │
│  - サニタイズ（小文字化、特殊文字除去） │
├─────────────────────────────────────┤
│  Commands (.cc-craft-kit/commands/)       │
│  - spec/create.ts                   │
│    └─ --branch-name オプションで受け取り │
├─────────────────────────────────────┤
│  Core - Git (.cc-craft-kit/core/git/)    │
│  - branch-creation.ts               │
│    └─ createSpecBranch(id, customName?) │
└─────────────────────────────────────┘
```

### 7.2 API設計

#### 7.2.1 スラッシュコマンドの変更

**場所**: `src/slash-commands/spec-create.md`

**追加する指示**:

```markdown
## ブランチ名生成

仕様書作成時、以下の手順でブランチ名を生成してください。

1. **仕様書名と説明を分析**
   - ユーザーが指定した仕様書名（`$1`）と説明（`$2`）を確認
   - 仕様書の内容を理解し、適切な英語の説明フレーズを考案

2. **英語ブランチ名の生成規則**
   - 3〜5単語程度の簡潔な英語フレーズ
   - 小文字のみ使用
   - 単語の区切りはハイフン（`-`）を使用
   - Git互換文字のみ（英数字、ハイフン、アンダースコア）
   - 最大40文字程度（仕様書IDと組み合わせて63文字以内に収める）

3. **ブランチ名の例**
   - 日本語: "ブランチ名が適当な名前になっている" → 英語: "improve-branch-naming"
   - 日本語: "データベース接続エラーを修正" → 英語: "fix-database-connection"
   - 英語: "Add User Authentication" → 英語: "add-user-authentication"

4. **CLI実行**
   - 生成したブランチ名を `--branch-name` オプションで渡す
   - 例: `npx tsx .cc-craft-kit/commands/spec/create.ts "$1" "$2" --branch-name "improve-branch-naming"`
```

#### 7.2.2 `create.ts` コマンドの変更

**場所**: `src/commands/spec/create.ts`

**追加パラメータ**:

```typescript
export async function createSpec(
  name: string,
  description?: string,
  options: {
    color: boolean;
    branchName?: string;  // 新規追加
  } = { color: true }
): Promise<void>
```

**変更内容**:

```typescript
// ブランチ作成（カスタムブランチ名がある場合はそれを使用）
const branchResult = options.branchName
  ? createSpecBranch(id, options.branchName)
  : createSpecBranch(id);
```

**CLI引数パース**:

```typescript
// CLI エントリポイント
if (import.meta.url === `file://${process.argv[1]}`) {
  const name = process.argv[2];
  const description = process.argv[3];

  // --branch-name オプションのパース
  const branchNameIndex = process.argv.indexOf('--branch-name');
  const branchName = branchNameIndex !== -1 ? process.argv[branchNameIndex + 1] : undefined;

  if (!name) {
    console.error('Error: spec-name is required');
    console.error('Usage: npx tsx create.ts <spec-name> [description] [--branch-name <name>]');
    process.exit(1);
  }

  createSpec(name, description, { color: true, branchName })
    .catch((error) => handleCLIError(error))
    .finally(() => closeDatabase());
}
```

#### 7.2.3 `createSpecBranch()` 関数の拡張

**場所**: `src/core/git/branch-creation.ts`

**変更前**:

```typescript
export function createSpecBranch(specId: string): BranchCreationResult;
```

**変更後**:

```typescript
export function createSpecBranch(
  specId: string,
  customBranchName?: string
): BranchCreationResult;
```

**変更内容**:

- `customBranchName` 引数を追加（省略可能、後方互換性を維持）
- カスタムブランチ名が指定された場合は `spec/${shortId}-${customBranchName}` を使用
- 未指定の場合は従来通り `spec/${shortId}` を生成（フォールバック）

**実装例**:

```typescript
export function createSpecBranch(
  specId: string,
  customBranchName?: string
): BranchCreationResult {
  // UUID バリデーション
  const UUID_REGEX = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
  if (!UUID_REGEX.test(specId)) {
    throw new Error(`Invalid spec ID format. Expected UUID, got: ${specId}`);
  }

  const shortSpecId = specId.substring(0, 8);

  // ブランチ名生成
  let branchName: string;
  if (customBranchName) {
    // カスタムブランチ名のサニタイズ
    const sanitized = customBranchName
      .toLowerCase()
      .replace(/[^a-z0-9-_]/g, '-')   // Git互換文字のみ
      .replace(/-+/g, '-')             // 連続ハイフンを統合
      .replace(/^-|-$/g, '');          // 先頭・末尾のハイフンを削除

    branchName = `spec/${shortSpecId}-${sanitized}`;
  } else {
    // フォールバック（従来形式）
    branchName = `spec/${shortSpecId}`;
  }

  // ... 以降の処理は変更なし（ブランチ作成、検証など）
}
```

### 7.3 データモデル設計

#### 影響を受けるテーブル

**`specs` テーブル**:

- **カラム**: `branch_name` (既存)
- **変更内容**: 格納される値の形式が変更される
  - 変更前: `spec/c795fc91`
  - 変更後: `spec/c795fc91-improve-branch-naming`

**マイグレーション**: 不要（カラム定義の変更なし）

#### データベーススキーマへの影響

- スキーマ定義の変更は不要
- 既存レコードは `spec/<shortId>` 形式のまま保持される（後方互換性）
- 新規作成される仕様書のみ、新形式のブランチ名が格納される

### 7.4 エラーハンドリング設計

#### エラーケースとフォールバック戦略

| エラーケース | 検出方法 | フォールバック動作 |
|---|---|---|
| 仕様書名が空文字列 | `specName.trim().length === 0` | 従来形式 `spec/${shortId}` を使用 |
| スラッグ化後に空文字列 | `slug.length === 0` | 従来形式 `spec/${shortId}` を使用 |
| 外部ライブラリエラー | `try-catch` で捕捉 | 簡易ローマ字化にフォールバック |
| ブランチ名が既に存在 | Git エラー検出 | エラーメッセージを表示し、処理中断 |

#### フォールバック実装例

```typescript
export function generateBranchName(specId: string, specName: string): string {
  const shortId = specId.substring(0, 8);

  try {
    const slug = slugify(specName);

    // スラッグが空の場合はフォールバック
    if (slug.length === 0) {
      console.warn('Failed to generate slug, falling back to ID-based naming');
      return `spec/${shortId}`;
    }

    const maxSlugLength = 49;
    const truncatedSlug = slug.substring(0, maxSlugLength);

    return `spec/${shortId}-${truncatedSlug}`;
  } catch (error) {
    console.error('Error generating branch name:', error);
    return `spec/${shortId}`;  // フォールバック
  }
}
```

### 7.5 テスト設計

#### 単体テスト

**場所**: `tests/core/git/branch-creation.test.ts`

**テストケース**:

1. **`createSpecBranch()` のテスト（カスタムブランチ名あり）**
   - 正常系: `("12345678-...", "improve-branch-naming")` → `"spec/12345678-improve-branch-naming"`
   - サニタイズ: `("12345678-...", "Improve@Branch#Naming!")` → `"spec/12345678-improve-branch-naming"`
   - 長い名前の切り詰め: 63 文字制限が適用されるか
   - 連続ハイフンの統合: `("12345678-...", "fix--bug")` → `"spec/12345678-fix-bug"`
   - 先頭・末尾のハイフン除去: `("12345678-...", "-test-")` → `"spec/12345678-test"`

2. **`createSpecBranch()` のテスト（カスタムブランチ名なし）**
   - フォールバック: `("12345678-...")` → `"spec/12345678"`

#### E2Eテスト

**場所**: `tests/integrations/spec-creation.test.ts`

**テストシナリオ**:

1. `--branch-name` オプション指定時にカスタムブランチが作成されるか
   - コマンド: `npx tsx create.ts "Test Spec" "Description" --branch-name "custom-branch"`
   - 期待: `spec/xxxxxxxx-custom-branch` ブランチが作成される
2. `--branch-name` オプション未指定時にデフォルトブランチが作成されるか
   - コマンド: `npx tsx create.ts "Test Spec" "Description"`
   - 期待: `spec/xxxxxxxx` ブランチが作成される
3. 作成されたブランチ名がデータベースに正しく記録されるか
4. Git ブランチが実際に作成され、切り替わっているか
5. エラー時のロールバックが正常に動作するか

### 7.6 セキュリティ考慮事項

#### コマンドインジェクション対策

- **既存対策**: UUID フォーマット検証
- **追加対策**: カスタムブランチ名のサニタイゼーション（`createSpecBranch()` 内で実施）
  - Git 互換文字のみ許可: `[a-z0-9-_]`
  - 特殊文字は自動的にハイフンに置換
  - 連続ハイフン、先頭・末尾のハイフンを除去

#### Claude による生成の利点

- Claude がコンテキストを理解して適切な英語を生成するため、固定マッピング辞書が不要
- 自然言語処理により、多様な日本語表現に対応可能
- ユーザーの意図を汲み取った、より意味のあるブランチ名を生成

### 7.7 パフォーマンス考慮事項

- **目標**: ブランチ名生成を含む仕様書作成処理を 5 秒以内に完了
- **実装方針**: Claude による生成は追加の API コールを必要としないため、オーバーヘッドは最小限
- **フォールバック**: Claude がブランチ名を生成しない場合、従来の `spec/${shortId}` 形式を使用

### 7.8 後方互換性

- 既存の `createSpecBranch(specId)` 呼び出しは引き続き動作（`customBranchName` は省略可能）
- 既存のブランチ名 `spec/${shortId}` も引き続きサポート
- データベーススキーマの変更なし
- スラッシュコマンドを使用しない直接的な CLI 呼び出しでも動作

---

## 8. 実装タスクリスト

### 実装タスク

1. **スラッシュコマンド spec-create.md にブランチ名生成指示を追加**
   - 仕様書名と説明から英語ブランチ名を生成する手順を記述
   - ブランチ名生成規則を明記（3〜5 単語、小文字、ハイフン区切り、最大 40 文字）
   - CLI 実行時に `--branch-name` オプションで渡す指示を追加

2. **create.ts に --branch-name オプションを追加**
   - `createSpec()` 関数のオプションパラメータに `branchName?: string` を追加
   - CLI 引数パーサーで `--branch-name` を解析
   - `createSpecBranch()` 呼び出し時にブランチ名を渡す

3. **branch-creation.ts の createSpecBranch() に customBranchName パラメータを追加**
   - 関数シグネチャを `createSpecBranch(specId: string, customBranchName?: string)` に変更
   - カスタムブランチ名が指定された場合の処理を追加

4. **branch-creation.ts にブランチ名サニタイズロジックを実装**
   - 小文字化、特殊文字のハイフン置換
   - 連続ハイフン統合、先頭・末尾のハイフン除去
   - `spec/${shortId}-${sanitized}` 形式でブランチ名を生成

5. **単体テストを作成 (branch-creation.test.ts)**
   - カスタムブランチ名ありのテスト（正常系、サニタイズ、切り詰め）
   - カスタムブランチ名なしのテスト（フォールバック）

6. **E2Eテストを作成 (spec-creation.test.ts)**
   - `--branch-name` オプション指定時のテスト
   - `--branch-name` オプション未指定時のテスト
   - データベース記録、Git ブランチ作成、ロールバックの検証

7. **ソースコードを .cc-craft-kit/ に同期 (npm run sync:dogfood)**
   - `src/` の変更を `.cc-craft-kit/` にコピー

8. **動作確認: 日本語仕様書名でブランチ作成テスト**
   - `/cft:spec-create "テスト仕様書" "説明"` を実行
   - Claude が適切な英語ブランチ名を生成することを確認
   - 生成されたブランチが正しく作成されることを確認
