# GitHub Sub Issue が更新されない

**仕様書 ID:** 0bd68360-2be2-46f7-a186-8fd5be1ad5e0
**フェーズ:** implementation
**作成日時:** 2025/11/30 12:00:00
**更新日時:** 2025/11/30 17:05:00

---

## 1. 背景と目的

### 背景

cc-craft-kit では、仕様書のタスクリストから GitHub Sub Issue を自動作成し、タスク完了時に Sub Issue をクローズする機能が実装されている。しかし、以下の問題が発生している:

1. **`checkAllSubIssuesClosed()` が常に true を返す**: DB のみで判断し、GitHub API を呼び出していないため、実際の Sub Issue ステータスと乖離する
2. **`task.completed` イベントの taskId 取得が曖昧**: `event.taskId` と `event.data.taskId` のどちらを使用するか不明確
3. **チェックボックスパターンが緩い**: 正規表現がコメント内の Issue 参照にもマッチしてしまう
4. **親 Issue 情報の逆引きが困難**: `parent_spec_id` が活用されておらず、仕様書 ID を使用する処理が実装できない

### 目的

GitHub Sub Issue の更新処理を修正し、タスク完了時に Sub Issue が正しくクローズされ、親 Issue のチェックボックスが適切に更新されるようにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行い、GitHub Issue 連携機能を活用している開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:task done` 実行時に、対応する Sub Issue がクローズされること
- [ ] Sub Issue クローズ時に、親 Issue のチェックボックスが `[x]` に更新されること
- [ ] 全ての Sub Issue がクローズされた場合、親 Issue も自動的にクローズされること

### 機能要件

- [ ] `checkAllSubIssuesClosedViaApi()` が GitHub API を呼び出して正確にステータスを確認すること
- [ ] `task.completed` イベントで taskId が確実に取得できること（Zod スキーマで必須化）
- [ ] チェックボックス更新の正規表現がより厳密にマッチすること
- [ ] `parent_spec_id` を活用した逆引きが実装されていること

### 非機能要件

- [ ] GitHub API レート制限に対応したリトライ機構が機能すること
- [ ] エラー発生時に適切なログが出力されること

---

## 4. 制約条件

- GitHub API レート制限: REST 60 req/min, GraphQL 5,000 points/hour
- 既存の `fetchWithRetry()` + exponential backoff 機構を活用すること
- Sub Issue 作成には GraphQL の `sub_issues` ヘッダー指定が必須
- イベント駆動アーキテクチャ（EventBus）の既存パターンに従うこと

---

## 5. 依存関係

- `src/integrations/github/sub-issues.ts` - SubIssueManager クラス
- `src/core/workflow/github-integration.ts` - イベントハンドラー登録
- `src/commands/task/done.ts` - タスク完了コマンド
- `src/core/database/schema.ts` - github_sync テーブル（parent_issue_number, parent_spec_id カラム）

---

## 6. 参考情報

- 関連仕様書: `30f4b007-481c-4eb0-aaae-feb96c82e0ac.md` - Sub Issue が放置されている
- 関連仕様書: `d1b80586-c9ee-43a1-8a22-b81e12669d91.md` - 仕様書が更新されても Issue が更新されない
- バグ箇所: `src/integrations/github/sub-issues.ts:447-479` - `checkAllSubIssuesClosed()` が常に true を返す
- バグ箇所: `src/integrations/github/sub-issues.ts:401` - チェックボックスパターンが緩い

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
タスク完了コマンド (task/done.ts)
       │
       ▼
  task.completed イベント発火
       │
       ▼
イベントハンドラー (github-integration.ts)
       │
       ▼
SubIssueManager.handleTaskCompletion()
       │
       ├─► updateSubIssueStatus() - Sub Issue をクローズ
       │
       ├─► syncParentIssueCheckbox() - 親 Issue のチェックボックス更新
       │        │
       │        └─► チェックボックスパターン（★改善対象）
       │
       ├─► checkAllSubIssuesClosed() - 全 Sub Issue クローズ確認（★削除対象）
       │        │
       │        └─► checkAllSubIssuesClosedViaApi() に統一
       │
       └─► closeParentIssue() - 親 Issue をクローズ
```

#### 設計方針

1. **DB + GitHub API の両方で確認するパターン**に統一
   - `checkAllSubIssuesClosed()` は削除し、`checkAllSubIssuesClosedViaApi()` に統一
   - DB は「どの Sub Issue が存在するか」の情報源として使用
   - GitHub API は「実際のステータス」の情報源として使用

2. **チェックボックスパターンの厳密化**
   - 正規表現を改善し、誤マッチを防止
   - コメント内の Issue 参照にマッチしないようにする

3. **既存の `fetchWithRetry()` 機構を活用**
   - レート制限対応は既存実装をそのまま使用

#### 処理フロー詳細

**タスク完了時の Sub Issue 更新フロー**:

```
1. task.completed イベント受信
   ↓
2. taskId から Sub Issue 情報を DB で検索
   - entity_type = 'sub_issue'
   - entity_id = taskId
   ↓
3. Sub Issue をクローズ (GitHub API)
   - PATCH /repos/{owner}/{repo}/issues/{number}
   - body: { state: 'closed' }
   ↓
4. 親 Issue のチェックボックスを更新 (GitHub API)
   - GET /repos/{owner}/{repo}/issues/{parent_number}
   - PATCH /repos/{owner}/{repo}/issues/{parent_number}
   - body: { body: <更新後の本文> }
   ↓
5. 全 Sub Issue のクローズ状態を確認 (GitHub API)
   - 各 Sub Issue の state を API で取得
   ↓
6. 全てクローズなら親 Issue もクローズ
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/integrations/github/sub-issues.ts` | `checkAllSubIssuesClosed()` 削除、チェックボックスパターン改善 |
| `src/core/workflow/github-integration.ts` | イベントハンドラーの taskId 取得を Zod スキーマで検証 |

#### 変更内容詳細

**1. `checkAllSubIssuesClosed()` の削除** (sub-issues.ts:447-479)

現在の問題コード:
```typescript
async checkAllSubIssuesClosed(parentIssueNumber: number): Promise<boolean> {
  const subIssues = await this.db
    .selectFrom('github_sync')
    .selectAll()
    .where('entity_type', '=', 'sub_issue')
    .where('parent_issue_number', '=', parentIssueNumber)
    .execute();

  if (subIssues.length === 0) {
    return true;
  }

  console.log(`Found ${subIssues.length} Sub Issues...`);
  return true;  // ❌ 常に true を返す
}
```

対応方針:
- このメソッドを削除
- 呼び出し箇所は `checkAllSubIssuesClosedViaApi()` を使用するよう統一
- 現在の `handleTaskCompletion()` は既に `checkAllSubIssuesClosedViaApi()` を使用しているため影響なし

**2. チェックボックスパターンの改善** (sub-issues.ts:401)

現在の問題パターン:
```typescript
const checkboxPattern = new RegExp(`(- \\[)[ x](\\] .*#${subIssueNumber}(?:\\D|$))`, 'gm');
```

改善後:
```typescript
// より厳密なパターン: 行頭の - [ ] #番号 形式のみにマッチ
const checkboxPattern = new RegExp(
  `^(\\s*- \\[)([ x])(\\] #${subIssueNumber}\\b)`,
  'gm'
);
```

改善点:
- `^` で行頭を指定
- `\s*` で先頭の空白を許容（インデント対応）
- `\b` で単語境界を指定し、`#123` が `#1234` にマッチしないようにする
- `.*` を削除し、Issue 番号の直前にある文字列にはマッチしないようにする

**3. taskId 取得の Zod スキーマ化** (github-integration.ts)

現在の曖昧なコード:
```typescript
const taskId = event.data.taskId || event.taskId;
```

改善後:
```typescript
import { z } from 'zod';

const TaskCompletedEventSchema = z.object({
  taskId: z.string().uuid(),
});

// イベントハンドラー内
const parsed = TaskCompletedEventSchema.safeParse(event.data);
if (!parsed.success) {
  await logError(db, null, specId, 'task.completed', `Invalid event data: ${parsed.error.message}`);
  return;
}
const { taskId } = parsed.data;
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| 全 Sub Issue クローズ確認 | `checkAllSubIssuesClosed()` (DB のみ) | `checkAllSubIssuesClosedViaApi()` (GitHub API) | sub-issues.ts |
| チェックボックス更新 | 緩いパターンでマッチ | 厳密なパターンでマッチ | sub-issues.ts:401 |
| taskId 取得 | `event.data.taskId \|\| event.taskId` | Zod スキーマで検証 | github-integration.ts |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| チェックボックスパターン | 正しい形式のみマッチ | 単体テスト |
| チェックボックスパターン | コメント内 Issue 参照にマッチしない | 単体テスト |
| taskId 取得 | 不正な形式で適切なエラー | 単体テスト |
| 全 Sub Issue クローズ確認 | GitHub API で正確に確認 | モック使用の統合テスト |

### 7.5 移行計画

#### Phase 1: チェックボックスパターンの改善

1. `syncParentIssueCheckbox()` 内のパターンを修正
2. 単体テストを追加して正しいマッチを検証

#### Phase 2: 未使用メソッドの削除

1. `checkAllSubIssuesClosed()` メソッドを削除
2. 既存の呼び出し箇所がないことを確認（現在は使用されていない）

#### Phase 3: イベントデータの検証強化

1. `task.completed` イベントハンドラーに Zod スキーマを追加
2. 不正なイベントデータのエラーログを改善

---

## 8. 実装タスクリスト

### Phase 1: チェックボックスパターンの改善

- [x] `syncParentIssueCheckbox()` 内のチェックボックスパターンを厳密化（sub-issues.ts:401）
- [x] チェックボックスパターンの単体テストを追加

### Phase 2: 未使用メソッドの削除

- [x] `checkAllSubIssuesClosed()` メソッドを削除（sub-issues.ts:447-479）
- [x] 削除後に既存テストが通ることを確認

### Phase 3: イベントデータの検証強化

- [ ] `task.completed` イベントハンドラーに Zod スキーマを追加（github-integration.ts）
- [ ] エラーログのメッセージを改善
- [ ] 全体の型チェック・リント実行
