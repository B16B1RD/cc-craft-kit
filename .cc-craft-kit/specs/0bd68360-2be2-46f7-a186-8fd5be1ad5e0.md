# GitHub Sub Issue が更新されない

**仕様書 ID:** 0bd68360-2be2-46f7-a186-8fd5be1ad5e0
**フェーズ:** requirements
**作成日時:** 2025/11/30 12:00:00
**更新日時:** 2025/11/30 12:00:00

---

## 1. 背景と目的

### 背景

cc-craft-kit では、仕様書のタスクリストから GitHub Sub Issue を自動作成し、タスク完了時に Sub Issue をクローズする機能が実装されている。しかし、以下の問題が発生している:

1. **`checkAllSubIssuesClosed()` が常に true を返す**: DB のみで判断し、GitHub API を呼び出していないため、実際の Sub Issue ステータスと乖離する
2. **`task.completed` イベントの taskId 取得が曖昧**: `event.taskId` と `event.data.taskId` のどちらを使用するか不明確
3. **チェックボックスパターンが緩い**: 正規表現がコメント内の Issue 参照にもマッチしてしまう
4. **親 Issue 情報の逆引きが困難**: `parent_spec_id` が活用されておらず、仕様書 ID を使用する処理が実装できない

### 目的

GitHub Sub Issue の更新処理を修正し、タスク完了時に Sub Issue が正しくクローズされ、親 Issue のチェックボックスが適切に更新されるようにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行い、GitHub Issue 連携機能を活用している開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:task done` 実行時に、対応する Sub Issue がクローズされること
- [ ] Sub Issue クローズ時に、親 Issue のチェックボックスが `[x]` に更新されること
- [ ] 全ての Sub Issue がクローズされた場合、親 Issue も自動的にクローズされること

### 機能要件

- [ ] `checkAllSubIssuesClosedViaApi()` が GitHub API を呼び出して正確にステータスを確認すること
- [ ] `task.completed` イベントで taskId が確実に取得できること（Zod スキーマで必須化）
- [ ] チェックボックス更新の正規表現がより厳密にマッチすること
- [ ] `parent_spec_id` を活用した逆引きが実装されていること

### 非機能要件

- [ ] GitHub API レート制限に対応したリトライ機構が機能すること
- [ ] エラー発生時に適切なログが出力されること

---

## 4. 制約条件

- GitHub API レート制限: REST 60 req/min, GraphQL 5,000 points/hour
- 既存の `fetchWithRetry()` + exponential backoff 機構を活用すること
- Sub Issue 作成には GraphQL の `sub_issues` ヘッダー指定が必須
- イベント駆動アーキテクチャ（EventBus）の既存パターンに従うこと

---

## 5. 依存関係

- `src/integrations/github/sub-issues.ts` - SubIssueManager クラス
- `src/core/workflow/github-integration.ts` - イベントハンドラー登録
- `src/commands/task/done.ts` - タスク完了コマンド
- `src/core/database/schema.ts` - github_sync テーブル（parent_issue_number, parent_spec_id カラム）

---

## 6. 参考情報

- 関連仕様書: `30f4b007-481c-4eb0-aaae-feb96c82e0ac.md` - Sub Issue が放置されている
- 関連仕様書: `d1b80586-c9ee-43a1-8a22-b81e12669d91.md` - 仕様書が更新されても Issue が更新されない
- バグ箇所: `src/integrations/github/sub-issues.ts:447-479` - `checkAllSubIssuesClosed()` が常に true を返す
- バグ箇所: `src/integrations/github/sub-issues.ts:401` - チェックボックスパターンが緩い
