# specs.github_issue_id カラムを削除し、github_sync テーブルに一元化

**仕様書 ID:** 6150c4eb-2e78-4b89-ba47-1c6c0b01aaf8
**フェーズ:** tasks
**作成日時:** 2025/11/20 12:35:56
**更新日時:** 2025/11/20 13:31:12

---

## 1. 背景と目的

### 背景

specs テーブルと github_sync テーブルで GitHub Issue 番号が重複管理されており、データ不整合が頻発しています。github_sync テーブルに一元化することで、データの整合性を保ち、保守性を向上させます。

### 目的

`specs` テーブルから `github_issue_id` カラムを削除し、GitHub 関連情報を `github_sync` テーブルに一元化することで、以下を実現します。

- データの一貫性を保証し、不整合による障害を防止
- GitHub 同期情報の管理を統一化し、保守性を向上
- 将来的な拡張性を確保（他のエンティティとの統一的な管理）

---

## 2. 対象ユーザー

この変更は以下のユーザーに影響します。

- **cc-craft-kit 開発者**: データベーススキーマの変更により、既存コードの修正が必要
- **cc-craft-kit 利用者**: 透過的な変更（ユーザー体験に影響なし）
- **運用担当者**: マイグレーション実行が必要

---

## 3. 受け入れ基準

### 必須要件

- [ ] `specs.github_issue_id` カラムを削除するマイグレーションを作成すること
- [ ] `specs.github_issue_id` を参照するすべてのコードを `github_sync` との JOIN に変更すること
- [ ] 既存の仕様書データが正しく表示されること
- [ ] GitHub Issue との紐付けが正常に動作すること

### 機能要件

#### マイグレーション

- [ ] マイグレーションファイル `004_remove_specs_github_issue_id.ts` を作成すること
- [ ] `specs` テーブルから以下のカラムを削除すること:
  - `github_issue_id`
  - `github_project_id`
  - `github_project_item_id`
  - `github_milestone_id`
- [ ] 既存データは `github_sync` テーブルに既に存在するため、データ移行は不要
- [ ] ロールバック用の Down マイグレーションを提供すること

#### スキーマ型定義の更新

- [ ] `src/core/database/schema.ts` の `SpecsTable` インターフェースから GitHub 関連カラムを削除すること
- [ ] TypeScript の型チェックでエラーが発生しないこと

#### コード修正

- [ ] `/cft:spec-get` コマンドで GitHub Issue 番号を正しく表示すること
- [ ] `/cft:spec-list` コマンドで GitHub Issue 番号を正しく表示すること
- [ ] `/cft:status` コマンドで GitHub 連携状態を正しく表示すること
- [ ] GitHub Issue 作成時に `github_sync` テーブルのみを更新すること
- [ ] ヘルパー関数 `getSpecWithGitHubInfo(db, specId)` を作成し、JOIN ロジックを共通化すること

#### テスト

- [ ] E2E テストで仕様書作成→GitHub Issue 作成→表示の一連の流れが正常に動作すること
- [ ] 既存の仕様書が正しく表示されること
- [ ] GitHub Issue との紐付け情報が正しく取得できること

### 非機能要件

- [ ] マイグレーション実行時間: 1 秒以内（60 件の仕様書を想定）
- [ ] クエリパフォーマンス: JOIN による性能劣化が 10% 以内であること
- [ ] 型安全性: TypeScript の strict mode で型エラーが発生しないこと
- [ ] 後方互換性: マイグレーション実行前のバックアップを自動作成すること

---

## 4. 制約条件

### 技術的制約

- 既存の `github_sync` テーブル構造を変更しないこと
- Kysely の型定義と整合性を保つこと
- SQLite の制約に従うこと（カラム削除は ALTER TABLE DROP COLUMN で実施）

### 運用上の制約

- マイグレーション実行前に必ずバックアップを取得すること
- マイグレーション失敗時のロールバック手順を用意すること
- 開発環境とドッグフーディング環境の両方でテストを実施すること

### ロールバック時のデータ損失リスク

⚠️ **重要な警告:**

- ロールバック時、`github_project_id`、`github_project_item_id`、`github_milestone_id` は復元できません（`github_sync` テーブルに保存されていないため）
- ロールバック実行前に、必ずバックアップから復元することを推奨します
- ロールバック後は、GitHub Project との紐付けが失われるため、手動で再設定が必要です

### データ整合性の保証

- マイグレーション前に `specs.github_issue_id` と `github_sync.github_number` の整合性をチェックすること
- 不整合がある場合は、マイグレーション前に修正すること
- 整合性チェックスクリプト `.cc-craft-kit/scripts/check-github-sync-integrity.ts` を作成すること

---

## 5. 依存関係

### 内部依存

#### データベース層

- `src/core/database/schema.ts`: `SpecsTable` インターフェース定義
- `src/core/database/migrations/004_remove_specs_github_issue_id.ts`: 新規マイグレーション
- `src/core/database/connection.ts`: データベース接続管理

#### コマンド層

- `src/commands/spec/get.ts`: 仕様書詳細表示（修正必要）
- `src/commands/spec/list.ts`: 仕様書一覧表示（修正必要）
- `src/commands/status.ts`: プロジェクト状態表示（修正必要）
- `src/commands/github/issue-create.ts`: GitHub Issue 作成（修正必要）
- `src/commands/github/sync.ts`: GitHub 同期（修正必要）

#### 統合層

- `src/integrations/github/ensure-issue.ts`: GitHub Issue 自動リカバリー（修正必要）
- `src/integrations/github/sync.ts`: GitHub 同期処理（修正必要）

#### ワークフロー層

- `src/core/workflow/phase-automation-registration.ts`: フェーズ変更時の GitHub Issue 更新（修正必要）

#### テスト層

- `tests/e2e/project-initialization.test.ts`: E2E テスト（修正必要）
- `tests/integrations/github/ensure-issue.test.ts`: GitHub Issue 自動リカバリーテスト（修正必要）
- `tests/commands/spec/phase.test.ts`: フェーズ変更テスト（修正必要）
- `tests/core/workflow/github-integration.test.ts`: GitHub 統合テスト（修正必要）
- `tests/core/sync/sync-service.test.ts`: 同期サービステスト（修正必要）
- `tests/core/sync/integrity-checker.test.ts`: 整合性チェッカーテスト（修正必要）
- `tests/integrations/sub-issue-workflow.test.ts`: Sub Issue ワークフローテスト（修正必要）
- `tests/integrations/github/knowledge-base.test.ts`: ナレッジベーステスト（修正必要）
- `tests/integrations/github/sync.test.ts`: GitHub 同期テスト（修正必要）
- `tests/core/filesystem/watcher.test.ts`: ファイルシステムウォッチャーテスト（修正必要）

#### データベースインデックス

- `specs_github_issue_id_idx`: 削除が必要（マイグレーション内で処理）

#### ドキュメント

- `CLAUDE.md`: データベーススキーマセクションの更新（修正必要）
- `docs/ARCHITECTURE.md`: データモデル図の更新（修正必要）

### 外部依存

- なし

### 関連仕様

- なし（既存仕様の改善）

---

## 6. 参考情報

### データベーススキーマ

**現在の `specs` テーブル:**

```typescript
export interface SpecsTable {
  id: Generated<string>;
  name: string;
  description: string | null;
  phase: SpecPhase;
  github_issue_id: number | null; // 削除対象
  github_project_id: string | null; // 削除対象
  github_project_item_id: string | null; // 削除対象
  github_milestone_id: number | null; // 削除対象
  created_at: ColumnType<Date, string | undefined, never>;
  updated_at: ColumnType<Date, string | undefined, string>;
}
```

**変更後の `specs` テーブル:**

```typescript
export interface SpecsTable {
  id: Generated<string>;
  name: string;
  description: string | null;
  phase: SpecPhase;
  created_at: ColumnType<Date, string | undefined, never>;
  updated_at: ColumnType<Date, string | undefined, string>;
}
```

**`github_sync` テーブル（変更なし）:**

```typescript
export interface GitHubSyncTable {
  id: Generated<string>;
  entity_type: GitHubEntityType; // 'spec' | 'task' | 'issue' | 'project' | 'sub_issue'
  entity_id: string; // spec_id or task_id
  github_id: string; // GitHub Issue ID or Project ID
  github_number: number | null; // GitHub Issue番号
  github_node_id: string | null; // GraphQL で使用する Node ID
  last_synced_at: ColumnType<Date, string | undefined, string>;
  sync_status: 'success' | 'failed' | 'pending';
  error_message: string | null;
}
```

### ヘルパー関数の設計

**`src/core/database/helpers.ts`（新規作成）:**

```typescript
import type { Kysely } from 'kysely';
import type { Database, Spec } from './schema.js';

export interface SpecWithGitHub extends Spec {
  github_issue_number: number | null;
  github_node_id: string | null;
  github_sync_status: 'success' | 'failed' | 'pending' | null;
}

export async function getSpecWithGitHubInfo(
  db: Kysely<Database>,
  specId: string
): Promise<SpecWithGitHub | undefined> {
  const result = await db
    .selectFrom('specs')
    .leftJoin('github_sync', (join) =>
      join
        .onRef('github_sync.entity_id', '=', 'specs.id')
        .on('github_sync.entity_type', '=', 'spec')
    )
    .select([
      'specs.id',
      'specs.name',
      'specs.description',
      'specs.phase',
      'specs.created_at',
      'specs.updated_at',
      'github_sync.github_number as github_issue_number',
      'github_sync.github_node_id',
      'github_sync.sync_status as github_sync_status',
    ])
    .where('specs.id', 'like', `${specId}%`)
    .executeTakeFirst();

  return result as SpecWithGitHub | undefined;
}
```

### マイグレーション実装例

**`src/core/database/migrations/004_remove_specs_github_issue_id.ts`:**

```typescript
import type { Kysely } from 'kysely';

export async function up(db: Kysely<any>): Promise<void> {
  // SQLite では ALTER TABLE DROP COLUMN がサポートされていないため、
  // テーブル再作成が必要

  // 0. 既存インデックスを削除
  await db.schema.dropIndex('specs_github_issue_id_idx').ifExists().execute();

  // 1. 新しいテーブルを作成
  await db.schema
    .createTable('specs_new')
    .addColumn('id', 'text', (col) => col.primaryKey())
    .addColumn('name', 'text', (col) => col.notNull())
    .addColumn('description', 'text')
    .addColumn('phase', 'text', (col) => col.notNull())
    .addColumn('created_at', 'text', (col) => col.notNull().defaultTo('CURRENT_TIMESTAMP'))
    .addColumn('updated_at', 'text', (col) => col.notNull().defaultTo('CURRENT_TIMESTAMP'))
    .execute();

  // 2. データをコピー
  await db
    .insertInto('specs_new')
    .columns(['id', 'name', 'description', 'phase', 'created_at', 'updated_at'])
    .expression((eb) =>
      eb
        .selectFrom('specs')
        .select(['id', 'name', 'description', 'phase', 'created_at', 'updated_at'])
    )
    .execute();

  // 3. 古いテーブルを削除
  await db.schema.dropTable('specs').execute();

  // 4. 新しいテーブルをリネーム
  await db.schema.alterTable('specs_new').renameTo('specs').execute();

  // 5. フェーズ検索用インデックスを作成
  await db.schema
    .createIndex('specs_phase_idx')
    .on('specs')
    .column('phase')
    .execute();
}

export async function down(db: Kysely<any>): Promise<void> {
  // ロールバック: github_issue_id カラムを復元

  await db.schema
    .createTable('specs_new')
    .addColumn('id', 'text', (col) => col.primaryKey())
    .addColumn('name', 'text', (col) => col.notNull())
    .addColumn('description', 'text')
    .addColumn('phase', 'text', (col) => col.notNull())
    .addColumn('github_issue_id', 'integer')
    .addColumn('github_project_id', 'text')
    .addColumn('github_project_item_id', 'text')
    .addColumn('github_milestone_id', 'integer')
    .addColumn('created_at', 'text', (col) => col.notNull().defaultTo('CURRENT_TIMESTAMP'))
    .addColumn('updated_at', 'text', (col) => col.notNull().defaultTo('CURRENT_TIMESTAMP'))
    .execute();

  // データをコピー（github_issue_id は github_sync から復元）
  await db
    .insertInto('specs_new')
    .columns(['id', 'name', 'description', 'phase', 'created_at', 'updated_at', 'github_issue_id'])
    .expression((eb) =>
      eb
        .selectFrom('specs')
        .leftJoin('github_sync', (join) =>
          join
            .onRef('github_sync.entity_id', '=', 'specs.id')
            .on('github_sync.entity_type', '=', 'spec')
        )
        .select([
          'specs.id',
          'specs.name',
          'specs.description',
          'specs.phase',
          'specs.created_at',
          'specs.updated_at',
          'github_sync.github_number as github_issue_id',
        ])
    )
    .execute();

  await db.schema.dropTable('specs').execute();
  await db.schema.alterTable('specs_new').renameTo('specs').execute();
}
```

### 整合性チェックスクリプト例

**`.cc-craft-kit/scripts/check-github-sync-integrity.ts`:**

```typescript
#!/usr/bin/env node
import { getDatabase, closeDatabase } from '../core/database/connection.js';

async function checkIntegrity() {
  const db = getDatabase();

  // パターン1: specs に github_issue_id があるが、github_sync にレコードがない
  const missingInSync = await db
    .selectFrom('specs')
    .leftJoin('github_sync', (join) =>
      join
        .onRef('github_sync.entity_id', '=', 'specs.id')
        .on('github_sync.entity_type', '=', 'spec')
    )
    .select([
      'specs.id',
      'specs.name',
      'specs.github_issue_id',
    ])
    .where('specs.github_issue_id', 'is not', null)
    .where('github_sync.github_number', 'is', null)
    .execute();

  // パターン2: specs と github_sync で Issue 番号が一致しない
  const mismatchedNumbers = await db
    .selectFrom('specs')
    .innerJoin('github_sync', (join) =>
      join
        .onRef('github_sync.entity_id', '=', 'specs.id')
        .on('github_sync.entity_type', '=', 'spec')
    )
    .select([
      'specs.id',
      'specs.name',
      'specs.github_issue_id',
      'github_sync.github_number',
    ])
    .where('specs.github_issue_id', 'is not', null)
    .where('github_sync.github_number', 'is not', null)
    .where((eb) =>
      eb('specs.github_issue_id', '!=', eb.ref('github_sync.github_number'))
    )
    .execute();

  // パターン3: github_sync にレコードがあるが、specs に github_issue_id がない
  const missingInSpecs = await db
    .selectFrom('specs')
    .innerJoin('github_sync', (join) =>
      join
        .onRef('github_sync.entity_id', '=', 'specs.id')
        .on('github_sync.entity_type', '=', 'spec')
    )
    .select([
      'specs.id',
      'specs.name',
      'specs.github_issue_id',
      'github_sync.github_number',
    ])
    .where('specs.github_issue_id', 'is', null)
    .where('github_sync.github_number', 'is not', null)
    .execute();

  const totalInconsistencies =
    missingInSync.length + mismatchedNumbers.length + missingInSpecs.length;

  if (totalInconsistencies > 0) {
    console.error(`Found ${totalInconsistencies} inconsistencies:\n`);

    if (missingInSync.length > 0) {
      console.error('Pattern 1: specs has github_issue_id but github_sync is missing:');
      missingInSync.forEach((row) => {
        console.error(
          `  - Spec ${row.id} (${row.name}): specs.github_issue_id=${row.github_issue_id}, github_sync=MISSING`
        );
      });
    }

    if (mismatchedNumbers.length > 0) {
      console.error('\nPattern 2: Issue numbers do not match:');
      mismatchedNumbers.forEach((row) => {
        console.error(
          `  - Spec ${row.id} (${row.name}): specs.github_issue_id=${row.github_issue_id}, github_sync.github_number=${row.github_number}`
        );
      });
    }

    if (missingInSpecs.length > 0) {
      console.error('\nPattern 3: github_sync has record but specs.github_issue_id is NULL:');
      missingInSpecs.forEach((row) => {
        console.error(
          `  - Spec ${row.id} (${row.name}): specs.github_issue_id=NULL, github_sync.github_number=${row.github_number}`
        );
      });
    }

    process.exit(1);
  }

  console.log('✓ No inconsistencies found');
}

checkIntegrity()
  .catch((error) => {
    console.error('Error:', error);
    process.exit(1);
  })
  .finally(() => closeDatabase());
```

### 参考リンク

- [Kysely Documentation](https://kysely.dev/)
- [SQLite ALTER TABLE](https://www.sqlite.org/lang_altertable.html)
- cc-craft-kit 既存マイグレーション: `src/core/database/migrations/`
