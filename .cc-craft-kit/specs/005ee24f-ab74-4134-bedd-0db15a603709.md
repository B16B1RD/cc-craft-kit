# データベース中の Issue に関するカラムが null になっている

**仕様書 ID:** 005ee24f-ab74-4134-bedd-0db15a603709
**フェーズ:** design
**作成日時:** 2025/11/30 12:00:00
**更新日時:** 2025/12/01 00:38:00

---

## 1. 背景と目的

### 背景

Issue が作成されているにも関わらずデータベース中の Issue に関するカラムが null になる問題が報告された。

cc-craft-kit では GitHub Issue 連携機能があり、仕様書（specs）と GitHub Issue を同期する機能を持っている。Issue 情報は `github_sync` テーブルに一元化されており、`specs` テーブルから `github_issue_id` などのカラムは削除済み（migration 005）。

関連する過去の修正:
- edaee28: UNIQUE 制約違反時のエラーハンドリング追加
- 6dccce8: `issue_number` → `github_number` への参照修正
- 427f1da: Sub Issue 同期ロジック改善

### 調査結果

調査の結果、以下の原因が特定された:

1. **`src/` と `.cc-craft-kit/` の同期不整合**（主要原因）
   - `src/commands/spec/resolve-id.ts` は `github_number` カラムを参照（正しい）
   - `.cc-craft-kit/commands/spec/resolve-id.ts` は `issue_number` カラムを参照（非推奨・古い）
   - `npm run sync:dogfood` が実行されていないため、古いコードが使用されていた

2. **データベースの実際の状態**
   - `github_sync` テーブルには正しく `github_number` が記録されている
   - 問題は参照するカラム名の不一致のみ

3. **統計情報**
   - 150 件の仕様書のうち 75 件が GitHub Issue と紐付け済み
   - 残り 75 件は GitHub Issue が作成されていない（正常）

### 目的

この問題は `npm run sync:dogfood` の実行により解決済み。しかし、以下の予防策を実装する:
1. 同期忘れを検出する仕組みの追加
2. カラム参照の整合性を担保するバリデーション強化

---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者（GitHub Issue 連携機能を利用するユーザー）

---

## 3. 受け入れ基準

### 必須要件

- [x] ~~Issue 作成時に `github_sync` テーブルの `github_number` が確実に記録される~~ → 既に正しく動作している
- [ ] `src/` と `.cc-craft-kit/` の同期状態を検証する仕組みを追加する

### 機能要件

- [ ] `npm run check:sync` で同期漏れを検出できるようにする（既存機能の確認）
- [ ] 非推奨カラム `issue_number` への参照を完全に削除する
- [ ] `github_number` カラムへの参照に統一されていることを CI でチェックする

### 非機能要件

- [ ] 既存の Issue 連携機能との後方互換性を維持する
- [ ] 修正による性能劣化がないこと

---

## 4. 制約条件

- TypeScript strict mode を維持
- Kysely のパラメータ化クエリのみを使用（SQL インジェクション対策）
- 既存のデータベーススキーマ（github_sync テーブル）を大幅に変更しない
- UNIQUE 制約 (entity_type, entity_id) を維持

---

## 5. 依存関係

### 関連モジュール
- `src/integrations/github/sync.ts` - recordSyncLog 関数
- `src/commands/github/issue-create.ts` - Issue 作成コマンド
- `src/integrations/github/ensure-issue.ts` - Issue 自動リカバリー
- `src/core/database/helpers.ts` - getSpecWithGitHubInfo 関数

### 関連テーブル
- `github_sync` テーブル（主要）
- `specs` テーブル（参照）
- `logs` テーブル（エラーログ確認用）

### 関連仕様書
- 3e313ec5: 「作成済みの GitHub Issue が認識されない問題が解決していない」（完了）
- 9ce6378b: 「/cft:spec-create で GitHub Issue が自動作成されない」（完了）

---

## 6. 参考情報

- マイグレーション 005: specs テーブルから github_issue_id を削除
- マイグレーション 007: github_sync に UNIQUE 制約追加
- マイグレーション 011: parent_issue_number, parent_spec_id 追加

### 調査ポイント

```sql
-- Issue が作成されているが github_sync に記録されていないレコード検出
SELECT s.id, s.name, s.phase, gs.github_number
FROM specs s
LEFT JOIN github_sync gs ON gs.entity_id = s.id AND gs.entity_type = 'spec'
WHERE gs.github_number IS NULL;
```

---

## 7. 設計詳細

### 7.1 根本原因分析

#### 問題の構造

```
問題: GitHub Issue #459 が存在するのに github_issue_number が null と表示される

┌─────────────────────────────────────────────────────────────────┐
│ 実行時のファイル参照                                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  プロンプト実行                                                 │
│       │                                                         │
│       ▼                                                         │
│  .cc-craft-kit/commands/spec/resolve-id.ts  ← 古いバージョン    │
│       │                                                         │
│       ▼                                                         │
│  SELECT issue_number FROM github_sync  ← 非推奨カラム参照       │
│       │                                                         │
│       ▼                                                         │
│  issue_number = NULL  ← 新規レコードでは未設定                  │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│ 期待される動作                                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  src/commands/spec/resolve-id.ts  ← 最新バージョン              │
│       │                                                         │
│       ▼                                                         │
│  SELECT github_number FROM github_sync  ← 正しいカラム参照      │
│       │                                                         │
│       ▼                                                         │
│  github_number = 459  ← 正しく取得                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 解決策

`npm run sync:dogfood` を実行することで解決。これにより `src/` の最新コードが `.cc-craft-kit/` に同期される。

### 7.2 予防策の設計

#### 設計方針

1. **早期検出**: 同期漏れを CI/CD で検出
2. **非推奨カラムの削除**: `issue_number` への参照を完全に排除
3. **自動化**: 開発フローに同期チェックを組み込む

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/scripts/sync-dogfood.ts` | 同期後に差分がないことを検証するオプション追加 |
| `.github/workflows/ci.yml` | 同期チェックをCIに追加（既存の `npm run check:sync` を活用） |
| 全ソースファイル | `issue_number` への参照を検索・削除 |

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| 同期チェック | `npm run check:sync` | CI で自動実行 | `.github/workflows/ci.yml` |
| カラム参照 | 一部で `issue_number` 使用 | `github_number` に統一 | 全ソースファイル |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| 同期チェック | `src/` と `.cc-craft-kit/` の差分検出 | CI 自動実行 |
| カラム参照 | `issue_number` への参照がないこと | grep による静的解析 |

### 7.5 移行計画

#### Phase 1: 現状確認と即時対応（完了）

1. ~~`npm run sync:dogfood` を実行して同期~~ ✓
2. ~~`resolve-id.ts` が正しく動作することを確認~~ ✓

#### Phase 2: 非推奨カラム参照の排除

1. コードベース全体で `issue_number` への参照を検索
2. 見つかった参照を `github_number` に置換
3. 単体テストで動作確認

#### Phase 3: CI/CD 強化

1. `npm run check:sync` が CI で実行されていることを確認
2. 失敗時にエラーとなることを確認

---

## 8. 実装タスクリスト

### Phase 1: 現状確認と即時対応（完了）

- [x] `npm run sync:dogfood` を実行して同期
- [x] `resolve-id.ts` が正しく動作することを確認

### Phase 2: 非推奨カラム参照の排除

- [ ] コードベース全体で `issue_number` への参照を検索
- [ ] 見つかった参照を `github_number` に置換
- [ ] 単体テストで動作確認

### Phase 3: CI/CD 強化

- [ ] `npm run check:sync` が CI で実行されていることを確認
- [ ] 失敗時にエラーとなることを確認
