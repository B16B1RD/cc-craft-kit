# データベース中の Issue に関するカラムが null になっている

**仕様書 ID:** 005ee24f-ab74-4134-bedd-0db15a603709
**フェーズ:** design
**作成日時:** 2025/11/30 12:00:00
**更新日時:** 2025/12/01 00:29:09

---

## 1. 背景と目的

### 背景

Issue が作成されているにも関わらずデータベース中の Issue に関するカラムが null になる模様。

cc-craft-kit では GitHub Issue 連携機能があり、仕様書（specs）と GitHub Issue を同期する機能を持っている。Issue 情報は `github_sync` テーブルに一元化されており、`specs` テーブルから `github_issue_id` などのカラムは削除済み（migration 005）。

関連する過去の修正:
- edaee28: UNIQUE 制約違反時のエラーハンドリング追加
- 6dccce8: `issue_number` → `github_number` への参照修正
- 427f1da: Sub Issue 同期ロジック改善

しかし、これらの修正にも関わらず、依然として Issue が作成されているにも関わらず `github_sync` テーブルの Issue 関連カラム（`github_number`, `github_id` など）が null になるケースが存在する。

### 目的

GitHub Issue が作成された際に、`github_sync` テーブルの Issue 関連カラムが確実に記録されるよう修正し、Issue 情報の整合性を担保する。

---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者（GitHub Issue 連携機能を利用するユーザー）

---

## 3. 受け入れ基準

### 必須要件

- [ ] Issue 作成時に `github_sync` テーブルの `github_number` が確実に記録される
- [ ] 既存の null レコードを検出する診断コマンドまたはスクリプトを提供する

### 機能要件

- [ ] `recordSyncLog` 関数で Issue 番号が null の場合にエラーまたは警告をログ出力する
- [ ] Issue 作成直後の `github_sync` 記録処理でエラーが発生した場合、適切にリトライまたはロールバックする
- [ ] LEFT JOIN で github_sync レコードが存在しない場合の原因を特定できるログを追加する

### 非機能要件

- [ ] 既存の Issue 連携機能との後方互換性を維持する
- [ ] 修正による性能劣化がないこと

---

## 4. 制約条件

- TypeScript strict mode を維持
- Kysely のパラメータ化クエリのみを使用（SQL インジェクション対策）
- 既存のデータベーススキーマ（github_sync テーブル）を大幅に変更しない
- UNIQUE 制約 (entity_type, entity_id) を維持

---

## 5. 依存関係

### 関連モジュール
- `src/integrations/github/sync.ts` - recordSyncLog 関数
- `src/commands/github/issue-create.ts` - Issue 作成コマンド
- `src/integrations/github/ensure-issue.ts` - Issue 自動リカバリー
- `src/core/database/helpers.ts` - getSpecWithGitHubInfo 関数

### 関連テーブル
- `github_sync` テーブル（主要）
- `specs` テーブル（参照）
- `logs` テーブル（エラーログ確認用）

### 関連仕様書
- 3e313ec5: 「作成済みの GitHub Issue が認識されない問題が解決していない」（完了）
- 9ce6378b: 「/cft:spec-create で GitHub Issue が自動作成されない」（完了）

---

## 6. 参考情報

- マイグレーション 005: specs テーブルから github_issue_id を削除
- マイグレーション 007: github_sync に UNIQUE 制約追加
- マイグレーション 011: parent_issue_number, parent_spec_id 追加

### 調査ポイント

```sql
-- Issue が作成されているが github_sync に記録されていないレコード検出
SELECT s.id, s.name, s.phase, gs.github_number
FROM specs s
LEFT JOIN github_sync gs ON gs.entity_id = s.id AND gs.entity_type = 'spec'
WHERE gs.github_number IS NULL;
```

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
┌─────────────────────────────────────────────────────────────────┐
│                          CLI Layer                              │
├─────────────────────────────────────────────────────────────────┤
│  issue-create.ts    spec-phase.md    github-issue-create.ts     │
│         │                │                    │                 │
│         ▼                ▼                    ▼                 │
├─────────────────────────────────────────────────────────────────┤
│                     Integration Layer                           │
├─────────────────────────────────────────────────────────────────┤
│                   GitHubSyncService                             │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ syncSpecToIssue() ────────► recordSyncLog()             │    │
│  │ syncIssueToSpec() ────────► recordSyncLog()             │    │
│  │ updatePrMergedStatus() ───► updateGitHubSync()          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                           │                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                  ensure-issue.ts                        │    │
│  │  ensureGitHubIssue() ──► syncSpecToIssue()              │    │
│  └─────────────────────────────────────────────────────────┘    │
│                           │                                     │
├─────────────────────────────────────────────────────────────────┤
│                      Database Layer                             │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                  helpers.ts                             │    │
│  │  getSpecWithGitHubInfo() ──► LEFT JOIN github_sync      │    │
│  └─────────────────────────────────────────────────────────┘    │
│                           │                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                 github_sync テーブル                    │    │
│  │  UNIQUE(entity_type, entity_id)                        │    │
│  │  github_id, github_number, github_node_id              │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

#### 設計方針

1. **単一責任原則**: 各関数は自身の責務のみを実行し、カラム設定責務を明確化
2. **防御的プログラミング**: Issue 作成後の同期ログ記録でバリデーションを強化
3. **後方互換性維持**: 既存の API シグネチャを変更せず、内部処理のみ改善

#### 処理フロー詳細

```
Issue 作成時のフロー:
┌──────────────────────────────────────────────────────────────┐
│ 1. GitHub API で Issue 作成                                  │
│    └─► issue.number, issue.node_id を取得                    │
│                                                              │
│ 2. github_sync レコード確認                                  │
│    └─► 既存: UPDATE / 新規: INSERT                           │
│                                                              │
│ 3. recordSyncLog() でカラム設定                              │
│    ├─► github_id: issue.number.toString() (必須)             │
│    ├─► github_number: issue.number (必須)                    │
│    ├─► github_node_id: issue.node_id (必須)                  │
│    ├─► last_synced_at: 現在時刻 (必須)                       │
│    └─► sync_status: 'success' (必須)                         │
│                                                              │
│ 4. バリデーション                                            │
│    └─► github_number が null → Error をスロー                │
└──────────────────────────────────────────────────────────────┘
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/integrations/github/sync.ts` | `recordSyncLog()` に必須カラムバリデーション追加、`github_node_id` を必須引数化 |
| `src/commands/github/issue-create.ts` | `github_node_id` を同期ログに追加 |
| `src/core/database/helpers.ts` | `getSpecWithGitHubInfo()` に NULL 検出ログ追加 |
| `src/integrations/github/ensure-issue.ts` | 診断ログ追加（オプショナル） |

#### カラム設定責務表

| カラム | 設定タイミング | 責任関数 | 必須/オプション |
|--------|---------------|---------|---------------|
| `github_id` | Issue 作成時 | `recordSyncLog()` | 必須 |
| `github_number` | Issue 作成時 | `recordSyncLog()` | 必須 |
| `github_node_id` | Issue 作成時 | `recordSyncLog()` | 必須 |
| `last_synced_at` | 同期時 | `recordSyncLog()` | 必須 |
| `sync_status` | 同期時 | `recordSyncLog()` | 必須 |
| `error_message` | エラー時 | `recordSyncLog()` | オプション |
| `pr_number` | PR 作成時 | `updatePrMergedStatus()` | オプション |
| `pr_url` | PR 作成時 | `updatePrMergedStatus()` | オプション |
| `pr_merged_at` | PR マージ時 | `updatePrMergedStatus()` | オプション |
| `parent_issue_number` | Sub Issue 作成時 | Sub Issue 専用関数 | オプション |
| `parent_spec_id` | Sub Issue 作成時 | Sub Issue 専用関数 | オプション |

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| Issue 作成時の同期ログ記録 | `github_node_id` がオプショナル | `github_node_id` を必須化、バリデーション追加 | `sync.ts:recordSyncLog()` |
| Issue 直接作成 | `github_node_id` 未設定 | `github_node_id` を設定 | `issue-create.ts` |
| NULL 検出 | なし | 診断 SQL スクリプト提供 | 新規: `diagnose-null-issues.ts` |
| LEFT JOIN 後の NULL ログ | なし | 警告ログ追加 | `helpers.ts:getSpecWithGitHubInfo()` |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| `recordSyncLog()` | `github_number` が null の場合にエラーをスロー | 単体テスト |
| `recordSyncLog()` | `github_node_id` が設定されていることを確認 | 単体テスト |
| `issue-create.ts` | Issue 作成後に `github_sync` レコードが正しく作成される | 統合テスト |
| `getSpecWithGitHubInfo()` | `github_number` が null の場合にログ出力 | 単体テスト |
| 診断スクリプト | null レコードを正しく検出 | 手動テスト |

### 7.5 移行計画

#### Phase 1: バリデーション強化

1. `recordSyncLog()` に必須カラムバリデーション追加
2. `github_node_id` を必須引数化
3. 単体テスト追加

#### Phase 2: 既存コード修正

1. `issue-create.ts` で `github_node_id` を設定
2. `getSpecWithGitHubInfo()` に NULL 検出ログ追加
3. 統合テスト追加

#### Phase 3: 診断ツール提供

1. 既存の null レコードを検出する診断スクリプト作成
2. 手動修正ガイドまたは自動修正スクリプト提供

---

## 8. 実装タスクリスト

### Phase 1: バリデーション強化

- [ ] `recordSyncLog()` に `github_number` の null チェック追加（エラースロー）
- [ ] `recordSyncLog()` の `github_node_id` 引数を必須化
- [ ] `recordSyncLog()` の単体テスト追加

### Phase 2: 既存コード修正

- [ ] `issue-create.ts` で `github_node_id` を同期ログに追加
- [ ] `getSpecWithGitHubInfo()` に NULL 検出時の警告ログ追加
- [ ] 統合テスト追加

### Phase 3: 診断ツール提供

- [ ] 既存の null レコードを検出する診断スクリプト作成
- [ ] 診断結果をレポート形式で出力
