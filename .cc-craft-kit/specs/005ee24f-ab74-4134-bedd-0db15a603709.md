# データベース中の Issue に関するカラムが null になっている

**仕様書 ID:** 005ee24f-ab74-4134-bedd-0db15a603709
**フェーズ:** completed
**作成日時:** 2025/11/30 12:00:00
**更新日時:** 2025/12/01 00:55:17

---

## 1. 背景と目的

### 背景

Issue が作成されているにも関わらずデータベース中の Issue に関するカラムが null になる問題が報告された。

cc-craft-kit では GitHub Issue 連携機能があり、仕様書（specs）と GitHub Issue を同期する機能を持っている。Issue 情報は `github_sync` テーブルに一元化されており、`specs` テーブルから `github_issue_id` などのカラムは削除済み（migration 005）。

関連する過去の修正:
- edaee28: UNIQUE 制約違反時のエラーハンドリング追加
- 6dccce8: `issue_number` → `github_number` への参照修正
- 427f1da: Sub Issue 同期ロジック改善

### 調査結果

調査の結果、以下の複合的な原因が特定された:

#### 原因 1: `src/` と `.cc-craft-kit/` の同期不整合（副次的原因）

- `src/commands/spec/resolve-id.ts` は `github_number` カラムを参照（正しい）
- `.cc-craft-kit/commands/spec/resolve-id.ts` は `issue_number` カラムを参照（非推奨・古い）
- `npm run sync:dogfood` が実行されていないため、古いコードが使用されていた
- → `npm run sync:dogfood` の実行により解決済み

#### 原因 2: 古い仕様書と GitHub Issue の紐付けが欠落（主要原因）

- `github_sync` テーブルには Issue #249〜#459 のみ記録されている
- Issue #1〜#248 に対応する仕様書は `github_sync` に記録されていない
- GitHub 連携機能が後から追加されたため、既存の Issue との紐付けが行われていない

#### 統計情報

| 項目 | 件数 |
|-----|-----|
| 全仕様書数 | 150 件 |
| `github_sync` に記録あり | 87 件（Issue #249〜#459） |
| `github_sync` に記録なし | 75 件（Issue #1〜#248 相当） |
| GitHub Issue 総数 | 255 件 |

### 目的

1. 古い仕様書と GitHub Issue の紐付けを復旧する
2. 同期忘れを検出する仕組みの追加
3. 今後同様の問題が発生しないよう予防策を実装する

---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者（GitHub Issue 連携機能を利用するユーザー）

---

## 3. 受け入れ基準

### 必須要件

- [x] ~~Issue 作成時に `github_sync` テーブルの `github_number` が確実に記録される~~ → 既に正しく動作している
- [ ] 古い仕様書（Issue #1〜#248）と GitHub Issue の紐付けを復旧する
- [ ] `src/` と `.cc-craft-kit/` の同期状態を検証する仕組みを追加する

### 機能要件

- [ ] 仕様書名と GitHub Issue タイトルを照合して自動紐付けするスクリプトを作成する
- [ ] `npm run check:sync` で同期漏れを検出できるようにする（既存機能の確認）
- [ ] 非推奨カラム `issue_number` への参照を完全に削除する

### 非機能要件

- [ ] 既存の Issue 連携機能との後方互換性を維持する
- [ ] 修正による性能劣化がないこと

---

## 4. 制約条件

- TypeScript strict mode を維持
- Kysely のパラメータ化クエリのみを使用（SQL インジェクション対策）
- 既存のデータベーススキーマ（github_sync テーブル）を大幅に変更しない
- UNIQUE 制約 (entity_type, entity_id) を維持

---

## 5. 依存関係

### 関連モジュール
- `src/integrations/github/sync.ts` - recordSyncLog 関数
- `src/commands/github/issue-create.ts` - Issue 作成コマンド
- `src/integrations/github/ensure-issue.ts` - Issue 自動リカバリー
- `src/core/database/helpers.ts` - getSpecWithGitHubInfo 関数

### 関連テーブル
- `github_sync` テーブル（主要）
- `specs` テーブル（参照）
- `logs` テーブル（エラーログ確認用）

### 関連仕様書
- 3e313ec5: 「作成済みの GitHub Issue が認識されない問題が解決していない」（完了）
- 9ce6378b: 「/cft:spec-create で GitHub Issue が自動作成されない」（完了）

---

## 6. 参考情報

- マイグレーション 005: specs テーブルから github_issue_id を削除
- マイグレーション 007: github_sync に UNIQUE 制約追加
- マイグレーション 011: parent_issue_number, parent_spec_id 追加

### 調査ポイント

```sql
-- Issue が作成されているが github_sync に記録されていないレコード検出
SELECT s.id, s.name, s.phase, gs.github_number
FROM specs s
LEFT JOIN github_sync gs ON gs.entity_id = s.id AND gs.entity_type = 'spec'
WHERE gs.github_number IS NULL;
```

---

## 7. 設計詳細

### 7.1 根本原因分析

#### 問題の構造

```
問題: 75 件の仕様書で github_issue_number が null

┌─────────────────────────────────────────────────────────────────┐
│ 原因 1: 同期不整合（解決済み）                                  │
├─────────────────────────────────────────────────────────────────┤
│  .cc-craft-kit/commands/spec/resolve-id.ts                      │
│       │                                                         │
│       ▼                                                         │
│  SELECT issue_number FROM github_sync  ← 非推奨カラム参照       │
│       │                                                         │
│       ▼                                                         │
│  → npm run sync:dogfood で解決                                  │
├─────────────────────────────────────────────────────────────────┤
│ 原因 2: 古い仕様書の紐付け欠落（未解決・主要原因）              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  GitHub Issue #1〜#248（約170件）                               │
│       │                                                         │
│       ▼                                                         │
│  github_sync テーブルに記録なし                                 │
│       │                                                         │
│       ▼                                                         │
│  75 件の仕様書で github_issue_number = NULL                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 紐付け復旧の設計

#### 設計方針

1. **自動照合**: 仕様書名と GitHub Issue タイトルを照合
2. **手動確認**: 複数候補がある場合はユーザー確認
3. **バッチ処理**: 一括で `github_sync` レコードを作成

#### 照合アルゴリズム

```
1. GitHub Issue タイトルから prefix を除去
   "[completed] Phase 1 検証テスト" → "Phase 1 検証テスト"

2. 仕様書名と完全一致を検索

3. 一致した場合:
   - github_sync レコードを INSERT
   - github_number, github_id, github_node_id を設定

4. 複数一致した場合:
   - 最新の Issue（番号が大きい方）を優先
   - または手動確認を要求
```

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| 新規: `src/scripts/repair-github-sync.ts` | 仕様書と GitHub Issue の紐付け復旧スクリプト |
| 新規: `src/commands/sync/repair.ts` | 復旧コマンドの CLI エントリポイント |
| `.github/workflows/ci.yml` | 同期チェックを CI に追加 |

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| 紐付け復旧 | なし | 自動照合スクリプト | `repair-github-sync.ts` |
| 同期チェック | `npm run check:sync` | CI で自動実行 | `.github/workflows/ci.yml` |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| 照合アルゴリズム | タイトル正規化と一致判定 | 単体テスト |
| 復旧スクリプト | `github_sync` レコード作成 | 統合テスト |
| 同期チェック | `src/` と `.cc-craft-kit/` の差分検出 | CI 自動実行 |

### 7.5 移行計画

#### Phase 1: 現状確認と即時対応（完了）

1. ~~`npm run sync:dogfood` を実行して同期~~ ✓
2. ~~`resolve-id.ts` が正しく動作することを確認~~ ✓

#### Phase 2: 古い仕様書の紐付け復旧

1. GitHub Issue 一覧を取得
2. 仕様書名と Issue タイトルを照合
3. 一致した組み合わせで `github_sync` レコードを作成
4. 復旧結果を確認

#### Phase 3: CI/CD 強化

1. `npm run check:sync` が CI で実行されていることを確認
2. 失敗時にエラーとなることを確認

---

## 8. 実装タスクリスト

### Phase 1: 現状確認と即時対応（完了）

- [x] `npm run sync:dogfood` を実行して同期
- [x] `resolve-id.ts` が正しく動作することを確認

### Phase 2: 古い仕様書の紐付け復旧

- [x] GitHub Issue 一覧を取得するスクリプトを作成
- [x] 仕様書名と Issue タイトルの照合ロジックを実装
- [x] `github_sync` レコードを一括作成
- [x] 復旧結果を確認（75 件 → 4 件に削減 ※手動対応が必要な 4 件を除き解決）

### Phase 3: CI/CD 強化

- [x] `npm run check:sync` が CI で実行されていることを確認（`.github/workflows/ci.yml` に sync-check ジョブを追加）
- [x] 失敗時にエラーとなることを確認（終了コード 1 で終了することを確認済み）

---

## Pull Request

- https://github.com/B16B1RD/cc-craft-kit/pull/460
