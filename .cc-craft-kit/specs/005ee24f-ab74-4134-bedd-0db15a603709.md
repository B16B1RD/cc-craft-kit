# データベース中の Issue に関するカラムが null になっている

**仕様書 ID:** 005ee24f-ab74-4134-bedd-0db15a603709
**フェーズ:** requirements
**作成日時:** 2025/11/30 12:00:00
**更新日時:** 2025/11/30 12:00:00

---

## 1. 背景と目的

### 背景

Issue が作成されているにも関わらずデータベース中の Issue に関するカラムが null になる模様。

cc-craft-kit では GitHub Issue 連携機能があり、仕様書（specs）と GitHub Issue を同期する機能を持っている。Issue 情報は `github_sync` テーブルに一元化されており、`specs` テーブルから `github_issue_id` などのカラムは削除済み（migration 005）。

関連する過去の修正:
- edaee28: UNIQUE 制約違反時のエラーハンドリング追加
- 6dccce8: `issue_number` → `github_number` への参照修正
- 427f1da: Sub Issue 同期ロジック改善

しかし、これらの修正にも関わらず、依然として Issue が作成されているにも関わらず `github_sync` テーブルの Issue 関連カラム（`github_number`, `github_id` など）が null になるケースが存在する。

### 目的

GitHub Issue が作成された際に、`github_sync` テーブルの Issue 関連カラムが確実に記録されるよう修正し、Issue 情報の整合性を担保する。

---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者（GitHub Issue 連携機能を利用するユーザー）

---

## 3. 受け入れ基準

### 必須要件

- [ ] Issue 作成時に `github_sync` テーブルの `github_number` が確実に記録される
- [ ] 既存の null レコードを検出する診断コマンドまたはスクリプトを提供する

### 機能要件

- [ ] `recordSyncLog` 関数で Issue 番号が null の場合にエラーまたは警告をログ出力する
- [ ] Issue 作成直後の `github_sync` 記録処理でエラーが発生した場合、適切にリトライまたはロールバックする
- [ ] LEFT JOIN で github_sync レコードが存在しない場合の原因を特定できるログを追加する

### 非機能要件

- [ ] 既存の Issue 連携機能との後方互換性を維持する
- [ ] 修正による性能劣化がないこと

---

## 4. 制約条件

- TypeScript strict mode を維持
- Kysely のパラメータ化クエリのみを使用（SQL インジェクション対策）
- 既存のデータベーススキーマ（github_sync テーブル）を大幅に変更しない
- UNIQUE 制約 (entity_type, entity_id) を維持

---

## 5. 依存関係

### 関連モジュール
- `src/integrations/github/sync.ts` - recordSyncLog 関数
- `src/commands/github/issue-create.ts` - Issue 作成コマンド
- `src/integrations/github/ensure-issue.ts` - Issue 自動リカバリー
- `src/core/database/helpers.ts` - getSpecWithGitHubInfo 関数

### 関連テーブル
- `github_sync` テーブル（主要）
- `specs` テーブル（参照）
- `logs` テーブル（エラーログ確認用）

### 関連仕様書
- 3e313ec5: 「作成済みの GitHub Issue が認識されない問題が解決していない」（完了）
- 9ce6378b: 「/cft:spec-create で GitHub Issue が自動作成されない」（完了）

---

## 6. 参考情報

- マイグレーション 005: specs テーブルから github_issue_id を削除
- マイグレーション 007: github_sync に UNIQUE 制約追加
- マイグレーション 011: parent_issue_number, parent_spec_id 追加

### 調査ポイント

```sql
-- Issue が作成されているが github_sync に記録されていないレコード検出
SELECT s.id, s.name, s.phase, gs.github_number
FROM specs s
LEFT JOIN github_sync gs ON gs.entity_id = s.id AND gs.entity_type = 'spec'
WHERE gs.github_number IS NULL;
```
