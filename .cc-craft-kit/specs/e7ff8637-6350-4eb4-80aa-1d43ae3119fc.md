# implementation フェーズ時のタスク進行時、Sub Issue が更新されない

**仕様書 ID:** e7ff8637-6350-4eb4-80aa-1d43ae3119fc
**フェーズ:** requirements
**作成日時:** 2025/12/01 09:45:37
**更新日時:** 2025/12/01 09:45:37

---

## 1. 背景と目的

### 背景

タスクの進行に合わせて、対応する各 Sub Issue の内容及びステータスも変更されるべき。現在作成された Sub Issue が Todo ステータスのままクローズもされず放置されている。何度も問題提起し修正依頼しているが一向に直る気配がない。

### 目的

implementation フェーズでタスクが進行した際に、対応する GitHub Sub Issue のステータスと内容が自動的に同期されるようにする。タスク完了時に Sub Issue がクローズされ、進捗に応じて親 Issue のチェックボックスも更新されることで、GitHub Issue と仕様書の状態を一貫して保つ。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発（SDD）を行う開発者。特に GitHub Issue 連携機能を活用し、タスク管理と Issue 管理を統合的に行いたいユーザー。

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:task done` でタスク完了時、対応する Sub Issue が自動的にクローズされる
- [ ] タスク完了時、親 Issue のチェックボックスが自動的にチェック状態になる
- [ ] 全タスク完了時、親 Issue が自動的にクローズされる

### 機能要件

- [ ] `task.completed` イベントが正しく発火され、GitHub Integration ハンドラーで処理される
- [ ] `github_sync` テーブルに Sub Issue と taskId の紐付けが正しく記録される
- [ ] Sub Issue 更新時のエラーがログに記録され、デバッグ可能である
- [ ] GitHub API レート制限エラー時にリトライが行われる

### 非機能要件

- [ ] Sub Issue 更新処理は 5 秒以内に完了する
- [ ] GitHub API エラー時のリトライは最大 3 回まで

---

## 4. 制約条件

- EventBus によるイベント駆動アーキテクチャに従う
- GitHub API 操作は Octokit を使用する
- データベース操作は Kysely を使用する
- 既存の `SubIssueManager` クラスと `github-integration.ts` のハンドラー構造を維持する
- `fetchWithRetry()` によるリトライロジックを活用する

---

## 5. 依存関係

- `src/core/workflow/event-bus.ts` - イベント発火・ハンドラー登録
- `src/core/workflow/github-integration.ts` - GitHub 連携ハンドラー（`task.completed` イベント処理）
- `src/integrations/github/sub-issues.ts` - SubIssueManager クラス（Sub Issue 更新処理）
- `src/commands/task/done.ts` - タスク完了コマンド（イベント発火元）
- `github_sync` テーブル - Sub Issue と taskId の紐付け情報

---

## 6. 参考情報

- コードベース解析結果: Sub Issue 更新フローは `task.completed` イベント → `github-integration.ts` ハンドラー → `SubIssueManager.handleTaskCompletion()` の順で処理される
- 問題の原因候補:
  1. `task.completed` イベントが正しく発火されていない
  2. `github_sync` テーブルに taskId が正しく記録されていない
  3. ハンドラー登録の非同期性による競合状態
  4. GitHub API エラーの握りつぶし
