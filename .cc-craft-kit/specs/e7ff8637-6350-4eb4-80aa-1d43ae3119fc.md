# implementation フェーズ時のタスク進行時、Sub Issue が更新されない

**仕様書 ID:** e7ff8637-6350-4eb4-80aa-1d43ae3119fc
**フェーズ:** implementation
**作成日時:** 2025/12/01 09:45:37
**更新日時:** 2025/12/01 09:57:46

---

## 1. 背景と目的

### 背景

タスクの進行に合わせて、対応する各 Sub Issue の内容及びステータスも変更されるべき。現在作成された Sub Issue が Todo ステータスのままクローズもされず放置されている。何度も問題提起し修正依頼しているが一向に直る気配がない。

### 目的

implementation フェーズでタスクが進行した際に、対応する GitHub Sub Issue のステータスと内容が自動的に同期されるようにする。タスク完了時に Sub Issue がクローズされ、進捗に応じて親 Issue のチェックボックスも更新されることで、GitHub Issue と仕様書の状態を一貫して保つ。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発（SDD）を行う開発者。特に GitHub Issue 連携機能を活用し、タスク管理と Issue 管理を統合的に行いたいユーザー。

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:task done` でタスク完了時、対応する Sub Issue が自動的にクローズされる
- [ ] タスク完了時、親 Issue のチェックボックスが自動的にチェック状態になる
- [ ] 全タスク完了時、親 Issue が自動的にクローズされる

### 機能要件

- [ ] `task.completed` イベントが正しく発火され、GitHub Integration ハンドラーで処理される
- [ ] `github_sync` テーブルに Sub Issue と taskId の紐付けが正しく記録される
- [ ] Sub Issue 更新時のエラーがログに記録され、デバッグ可能である
- [ ] GitHub API レート制限エラー時にリトライが行われる

### 非機能要件

- [ ] Sub Issue 更新処理は 5 秒以内に完了する
- [ ] GitHub API エラー時のリトライは最大 3 回まで

---

## 4. 制約条件

- EventBus によるイベント駆動アーキテクチャに従う
- GitHub API 操作は Octokit を使用する
- データベース操作は Kysely を使用する
- 既存の `SubIssueManager` クラスと `github-integration.ts` のハンドラー構造を維持する
- `fetchWithRetry()` によるリトライロジックを活用する

---

## 5. 依存関係

- `src/core/workflow/event-bus.ts` - イベント発火・ハンドラー登録
- `src/core/workflow/github-integration.ts` - GitHub 連携ハンドラー（`task.completed` イベント処理）
- `src/integrations/github/sub-issues.ts` - SubIssueManager クラス（Sub Issue 更新処理）
- `src/commands/task/done.ts` - タスク完了コマンド（イベント発火元）
- `github_sync` テーブル - Sub Issue と taskId の紐付け情報

---

## 6. 参考情報

- コードベース解析結果: Sub Issue 更新フローは `task.completed` イベント → `github-integration.ts` ハンドラー → `SubIssueManager.handleTaskCompletion()` の順で処理される
- 問題の原因候補:
  1. `task.completed` イベントが正しく発火されていない
  2. `github_sync` テーブルに taskId が正しく記録されていない
  3. ハンドラー登録の非同期性による競合状態
  4. GitHub API エラーの握りつぶし

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
┌─────────────────┐    task.completed     ┌──────────────────────────┐
│  /cft:task done │ ────────────────────► │  github-integration.ts   │
│  (done.ts)      │      EventBus         │  (ハンドラー)              │
└─────────────────┘                       └────────────┬─────────────┘
                                                       │
                                                       ▼
                                          ┌──────────────────────────┐
                                          │  SubIssueManager         │
                                          │  (sub-issues.ts)         │
                                          └────────────┬─────────────┘
                                                       │
                        ┌──────────────────────────────┼──────────────────────────────┐
                        ▼                              ▼                              ▼
              ┌─────────────────┐          ┌─────────────────┐          ┌─────────────────┐
              │  github_sync    │          │  GitHub API     │          │  親 Issue       │
              │  (DB 検索)      │          │  (Sub Issue     │          │  チェックボックス │
              └─────────────────┘          │   クローズ)     │          │  更新           │
                                           └─────────────────┘          └─────────────────┘
```

#### 設計方針

コードベース解析により、以下の問題が特定されました:

1. **ログ出力不足**: イベント発火、DB 検索、API 呼び出しの各段階でログが不十分
2. **parent_issue_number が null**: Sub Issue 作成時に親 Issue 番号が正しく渡されていない可能性
3. **エラーの握りつぶし**: 例外発生時に詳細なログなしで早期リターン

**修正方針**: 既存のアーキテクチャを維持しつつ、以下を強化
- 各処理段階でのデバッグログ追加
- DB レコード作成後の検証処理追加
- エラー発生時の詳細情報出力

#### 処理フロー詳細

```
1. /cft:task done 実行
   │
   ├─► getEventBusAsync() でハンドラー登録完了を待機
   │
   ├─► eventBus.emit('task.completed', { taskId })
   │   │
   │   └─► [NEW] ログ: "task.completed イベント発火: taskId=xxx"
   │
   └─► github-integration.ts ハンドラー実行
       │
       ├─► [NEW] ログ: "task.completed ハンドラー開始: taskId=xxx"
       │
       ├─► GitHub トークン・設定チェック
       │
       ├─► SubIssueManager.handleTaskCompletion(taskId, token)
       │   │
       │   ├─► [NEW] ログ: "handleTaskCompletion 開始: taskId=xxx"
       │   │
       │   ├─► github_sync から Sub Issue 情報を検索
       │   │   │
       │   │   ├─► [見つからない場合]
       │   │   │   └─► [NEW] 警告ログ: "Sub Issue 未登録: taskId=xxx, 登録済み: [一覧]"
       │   │   │
       │   │   └─► [見つかった場合]
       │   │       └─► [NEW] ログ: "Sub Issue 発見: #xxx, parent=#yyy"
       │   │
       │   ├─► updateSubIssueStatus(taskId, 'closed', token)
       │   │   └─► GitHub API: PATCH /repos/{owner}/{repo}/issues/{number}
       │   │
       │   ├─► [parent_issue_number が null の場合]
       │   │   └─► [NEW] 警告ログ: "parent_issue_number が null"
       │   │
       │   ├─► updateParentIssueCheckbox()
       │   │   └─► 親 Issue の body を更新
       │   │
       │   └─► checkAndCloseParentIssue()
       │       └─► 全 Sub Issue 完了なら親 Issue をクローズ
       │
       └─► [NEW] ログ: "task.completed ハンドラー完了: taskId=xxx"
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/core/workflow/github-integration.ts` | task.completed ハンドラーにデバッグログ追加 |
| `src/integrations/github/sub-issues.ts` | handleTaskCompletion() のログ強化、DB 検証追加 |
| `src/commands/task/done.ts` | イベント発火前後のログ追加 |

#### 変更詳細

##### github-integration.ts (Line 959-1022)

```typescript
// 変更前
eventBus.on<{ taskId: string }>(
  'task.completed',
  async (event: WorkflowEvent<{ taskId: string }>) => {
    if (!githubToken) return;
    if (!githubConfig) return;
    // ...
  }
);

// 変更後
eventBus.on<{ taskId: string }>(
  'task.completed',
  async (event: WorkflowEvent<{ taskId: string }>) => {
    const taskId = event.data?.taskId || (event as { taskId?: string }).taskId;
    console.log(`[task.completed] ハンドラー開始: taskId=${taskId}`);

    if (!githubToken) {
      console.log('[task.completed] GitHub トークン未設定のためスキップ');
      return;
    }
    if (!githubConfig) {
      console.log('[task.completed] GitHub 設定未設定のためスキップ');
      return;
    }
    // ...

    console.log(`[task.completed] SubIssueManager.handleTaskCompletion 呼び出し: taskId=${taskId}`);
    await subIssueManager.handleTaskCompletion(taskId, githubToken);
    console.log(`[task.completed] ハンドラー完了: taskId=${taskId}`);
  }
);
```

##### sub-issues.ts (Line 577-630)

```typescript
// 変更前
async handleTaskCompletion(taskId: string, token: string): Promise<void> {
  const syncRecord = await this.db
    .selectFrom('github_sync')
    // ...
  if (!syncRecord || !syncRecord.github_number) {
    console.log(`No Sub Issue found for task: ${taskId}`);
    return;
  }
  // ...
}

// 変更後
async handleTaskCompletion(taskId: string, token: string): Promise<void> {
  console.log(`[handleTaskCompletion] 開始: taskId=${taskId}`);

  const syncRecord = await this.db
    .selectFrom('github_sync')
    // ...

  if (!syncRecord) {
    // デバッグ用: 登録済みの Sub Issue を全て取得
    const allSubIssues = await this.db
      .selectFrom('github_sync')
      .select(['entity_id', 'github_number', 'parent_issue_number'])
      .where('entity_type', '=', 'sub_issue')
      .execute();
    console.warn(
      `[handleTaskCompletion] Sub Issue 未登録: taskId=${taskId}\n` +
      `登録済み Sub Issues: ${JSON.stringify(allSubIssues, null, 2)}`
    );
    return;
  }

  if (!syncRecord.github_number) {
    console.warn(`[handleTaskCompletion] github_number が null: taskId=${taskId}`);
    return;
  }

  console.log(
    `[handleTaskCompletion] Sub Issue 発見: #${syncRecord.github_number}, ` +
    `parent=#${syncRecord.parent_issue_number || 'null'}`
  );
  // ...
}
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| イベント受信ログ | なし | ハンドラー開始時にログ出力 | github-integration.ts:962 |
| DB 検索失敗ログ | 簡易メッセージのみ | 登録済み Sub Issue 一覧を含む詳細ログ | sub-issues.ts:585 |
| parent_issue_number null 警告 | 情報レベル | 警告レベルに昇格 | sub-issues.ts:603 |
| ハンドラー完了ログ | なし | 処理完了時にログ出力 | github-integration.ts:1020 |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| task.completed ハンドラー | イベント受信時にログが出力される | コンソール出力をキャプチャして検証 |
| handleTaskCompletion | Sub Issue 未登録時に詳細ログが出力される | モック DB で未登録状態を再現 |
| handleTaskCompletion | parent_issue_number null 時に警告ログ | モック DB で null 状態を再現 |
| 正常系 | タスク完了で Sub Issue がクローズされる | 既存テストで検証済み |

### 7.5 移行計画

#### Phase 1: ログ強化

1. github-integration.ts の task.completed ハンドラーにログ追加
2. sub-issues.ts の handleTaskCompletion() にログ追加
3. done.ts のイベント発火前後にログ追加

#### Phase 2: DB 検証強化

1. recordSubIssueSyncData() 実行後の検証処理追加
2. 検証失敗時のエラーログ出力

#### Phase 3: テスト追加

1. ログ出力のテストケース追加
2. エラーケースのテストカバレッジ向上

---

## 8. 実装タスクリスト

### Phase 1: ログ強化

- [x] github-integration.ts: task.completed ハンドラーの開始・完了ログ追加
- [x] sub-issues.ts: handleTaskCompletion() のデバッグログ追加
- [x] sub-issues.ts: Sub Issue 未登録時の詳細ログ（登録済み一覧表示）追加
- [x] sub-issues.ts: parent_issue_number null 時の警告ログ追加

### Phase 2: DB 検証強化

- [ ] sub-issues.ts: recordSubIssueSyncData() 後の検証処理追加

### Phase 3: テスト追加

- [ ] tests/integrations/sub-issue-workflow.test.ts: ログ出力のテストケース追加
