# 開発キット全体の処理（設計）見直し

**仕様書 ID:** aab74421-5c39-4280-832e-cb72262a6205
**フェーズ:** requirements
**作成日時:** 2025/11/23 12:10:44
**更新日時:** 2025/11/23 12:10:44

---

## 1. 背景と目的

### 背景

基本的には、カスタムスラッシュコマンド → スキル → サブエージェントという枠組みで様々なことを実現させることを想定しています。ただし、ケースによっては、カスタムスラッシュコマンド → サブエージェントというのもあるでしょう。

現状ドッグフーディングしている中で感じていることは、スクリプトを使用しすぎているような気がします。基本は、プロンプトで済ませられることはプロンプトで済ませるべきです。

これが、この開発キットを開発する上での基本原則です。この原則の観点で、いま一度、全体の設計を見直す必要があると感じています。

### 目的

開発キット全体の処理設計を見直し、「プロンプトで済ませられることはプロンプトで済ませる」という基本原則に基づいて、スクリプト実装とプロンプトベースの処理を適切に使い分ける指針を確立する。

---

## 2. 対象ユーザー

- **cc-craft-kit を開発する開発者**（主対象）
  - 新機能の追加や既存機能の改善を行う際の設計判断に使用
  - コードベース全体の一貫性を保つための指針として参照

- **cc-craft-kit を利用する開発者**（副次的）
  - カスタムスラッシュコマンドやスキルを作成する際の参考情報として活用

---

## 3. 受け入れ基準

### 必須要件

- [ ] スクリプト実装が必要な処理とプロンプトで代替可能な処理の判断基準を明確に定義する
- [ ] 現在スクリプト化されている処理のうち、プロンプトで代替可能なものを特定する
- [ ] カスタムスラッシュコマンド → スキル → サブエージェントの処理フローを整理する

### 機能要件

- [ ] プロンプトで代替可能なスクリプト（`code-review.ts`, `refactor.ts`, `test-generate.ts`, `lint-check.ts`, `schema-validate.ts`）をプロンプトベースに移行する方針を決定する
- [ ] スクリプト実装を維持すべき処理（データベース操作、GitHub API 呼び出し、イベント駆動処理、ファイル監視）の範囲を明確化する
- [ ] CLAUDE.md またはドキュメントに設計指針を記載する

### 非機能要件

- [ ] コードベース全体の一貫性を保つため、既存の設計パターン（モジュラーモノリス、イベント駆動、DI）を維持する
- [ ] プロンプトベースへの移行により、保守性とコンテキスト効率を向上させる
- [ ] 将来的な拡張性を損なわない設計とする

---

## 4. 制約条件

### 技術的制約

- **TypeScript**: strict mode を維持し、型安全性を確保する
- **Kysely**: データベース操作は Kysely の型安全なクエリビルダーを使用する
- **EventEmitter2**: イベント駆動処理は EventBus を経由する
- **TSyringe**: 依存性注入（DI）パターンを維持する

### アーキテクチャ制約

- **モジュラーモノリス**: 現在の `src/core/**`, `src/integrations/**`, `src/commands/**` の構造を維持する
- **イベント駆動**: 既存のイベントタイプ（`spec.*`, `task.*`, `github.*`, `knowledge.*`, `subagent.*`, `skill.*`）を維持する

### 互換性制約

- **既存のスラッシュコマンド**: `/cft:*` コマンドの動作を破壊しない
- **データベーススキーマ**: 既存のマイグレーションとの整合性を保つ
- **GitHub 統合**: Octokit によるREST API / GraphQL API の使用方法を維持する

### 設計原則

- **プロンプトファースト**: プロンプトで済ませられることはプロンプトで済ませる（最優先原則）
- **疎結合**: モジュール間の依存関係を最小化する
- **テスタビリティ**: DI によるモック差し替えを可能にする

---

## 5. 依存関係

### 既存コンポーネント

- **コアモジュール** (`src/core/**`)
  - `database/`: Kysely データベース接続、スキーマ、マイグレーション
  - `workflow/`: EventBus、ワークフローエンジン
  - `validation/`: Zod スキーマ、バリデーター
  - `git/`: Git 統合、ブランチ管理
  - `filesystem/`: ファイル監視（Chokidar）

- **統合モジュール** (`src/integrations/**`)
  - `github/`: Octokit クライアント、Issue/Project 管理

- **コマンド** (`src/commands/**`)
  - `spec/`: 仕様書 CRUD 操作
  - `github/`: GitHub 統合コマンド
  - `quality/`: コードレビュー、リファクタリング、テスト生成、Lint、スキーマ検証
  - `sync/`: 同期チェック・修復

### 既存仕様書

現時点で依存する仕様書はありません（この仕様書が全体設計の基盤となります）。

### 外部ライブラリ

- **Kysely** (^0.27.4): 型安全なSQLクエリビルダー
- **EventEmitter2** (^6.4.9): イベント駆動アーキテクチャ
- **Octokit** (@octokit/rest, @octokit/graphql): GitHub API クライアント
- **Zod** (^3.24.1): スキーマバリデーション
- **TSyringe** (^4.8.0): 依存性注入コンテナ
- **Chokidar** (^4.0.3): ファイル監視

---

## 6. 参考情報

### ドキュメント

- `docs/ARCHITECTURE.md`: アーキテクチャ設計の詳細
- `CLAUDE.md`: プロジェクト規約、コーディング規約
- `README.md`: プロジェクト概要

### 調査結果

調査により以下の知見を得ました：

#### スクリプト化が必須の処理

| 処理タイプ | 理由 | 例 |
|---|---|---|
| データベース操作 | Kysely の型安全性、トランザクション管理 | `spec/create.ts`, `spec/phase.ts` |
| GitHub API 呼び出し | Octokit の認証、レート制限管理 | `github/issue-create.ts` |
| イベント駆動処理 | EventBus の初期化、ハンドラー管理 | `spec/create.ts` (spec.created イベント) |
| ファイル監視・長時間実行 | Chokidar、バックグラウンドプロセス | `watch.ts` |
| 複雑なバリデーション | Zod スキーマ、整合性チェック | `sync/check.ts` |

#### プロンプトで代替可能な処理

| 処理 | 現状 | 代替案 |
|---|---|---|
| コードレビュー (`code-review.ts`) | スクリプトは起動トリガーのみ | プロンプトで直接指示 |
| リファクタリング (`refactor.ts`) | スクリプトは起動トリガーのみ | プロンプトで直接指示 |
| テスト生成 (`test-generate.ts`) | スクリプトは起動トリガーのみ | プロンプトで直接指示 |
| Lint チェック (`lint-check.ts`) | スクリプトは起動トリガーのみ | Bash ツールで `npm run lint` |
| スキーマ検証 (`schema-validate.ts`) | スクリプトは起動トリガーのみ | プロンプトで直接指示 |

### 設計パターン

- **モジュラーモノリス**: マイクロサービスの利点（モジュール分離）とモノリスの利点（単一デプロイ）を組み合わせ
- **イベント駆動アーキテクチャ**: EventBus による疎結合な処理フロー
- **依存性注入（DI）**: TSyringe によるモック差し替え、テスタビリティ向上
