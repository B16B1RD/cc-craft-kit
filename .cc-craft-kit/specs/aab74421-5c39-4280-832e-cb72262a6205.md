# 開発キット全体の処理（設計）見直し

**仕様書 ID:** aab74421-5c39-4280-832e-cb72262a6205
**フェーズ:** tasks
**作成日時:** 2025/11/23 12:10:44
**更新日時:** 2025/11/23 12:32:59

---

## 1. 背景と目的

### 背景

基本的には、カスタムスラッシュコマンド → スキル → サブエージェントという枠組みで様々なことを実現させることを想定しています。ただし、ケースによっては、カスタムスラッシュコマンド → サブエージェントというのもあるでしょう。

現状ドッグフーディングしている中で感じていることは、スクリプトを使用しすぎているような気がします。基本は、プロンプトで済ませられることはプロンプトで済ませるべきです。

これが、この開発キットを開発する上での基本原則です。この原則の観点で、いま一度、全体の設計を見直す必要があると感じています。

### 目的

開発キット全体の処理設計を見直し、「プロンプトで済ませられることはプロンプトで済ませる」という基本原則に基づいて、スクリプト実装とプロンプトベースの処理を適切に使い分ける指針を確立する。

---

## 2. 対象ユーザー

- **cc-craft-kit を開発する開発者**（主対象）
  - 新機能の追加や既存機能の改善を行う際の設計判断に使用
  - コードベース全体の一貫性を保つための指針として参照

- **cc-craft-kit を利用する開発者**（副次的）
  - カスタムスラッシュコマンドやスキルを作成する際の参考情報として活用

---

## 3. 受け入れ基準

### 必須要件

- [ ] スクリプト実装が必要な処理とプロンプトで代替可能な処理の判断基準を明確に定義する
- [ ] 現在スクリプト化されている処理のうち、プロンプトで代替可能なものを特定する
- [ ] カスタムスラッシュコマンド → スキル → サブエージェントの処理フローを整理する

### 機能要件

- [ ] プロンプトで代替可能なスクリプト（`code-review.ts`, `refactor.ts`, `test-generate.ts`, `lint-check.ts`, `schema-validate.ts`）をプロンプトベースに移行する方針を決定する
- [ ] スクリプト実装を維持すべき処理（データベース操作、GitHub API 呼び出し、イベント駆動処理、ファイル監視）の範囲を明確化する
- [ ] CLAUDE.md またはドキュメントに設計指針を記載する

### 非機能要件

- [ ] コードベース全体の一貫性を保つため、既存の設計パターン（モジュラーモノリス、イベント駆動、DI）を維持する
- [ ] プロンプトベースへの移行により、保守性とコンテキスト効率を向上させる
- [ ] 将来的な拡張性を損なわない設計とする

---

## 4. 制約条件

### 技術的制約

- **TypeScript**: strict mode を維持し、型安全性を確保する
- **Kysely**: データベース操作は Kysely の型安全なクエリビルダーを使用する
- **EventEmitter2**: イベント駆動処理は EventBus を経由する
- **TSyringe**: 依存性注入（DI）パターンを維持する

### アーキテクチャ制約

- **モジュラーモノリス**: 現在の `src/core/**`, `src/integrations/**`, `src/commands/**` の構造を維持する
- **イベント駆動**: 既存のイベントタイプ（`spec.*`, `task.*`, `github.*`, `knowledge.*`, `subagent.*`, `skill.*`）を維持する

### 互換性制約

- **既存のスラッシュコマンド**: `/cft:*` コマンドの動作を破壊しない
- **データベーススキーマ**: 既存のマイグレーションとの整合性を保つ
- **GitHub 統合**: Octokit によるREST API / GraphQL API の使用方法を維持する

### 設計原則

- **プロンプトファースト**: プロンプトで済ませられることはプロンプトで済ませる（最優先原則）
- **疎結合**: モジュール間の依存関係を最小化する
- **テスタビリティ**: DI によるモック差し替えを可能にする

---

## 5. 依存関係

### 既存コンポーネント

- **コアモジュール** (`src/core/**`)
  - `database/`: Kysely データベース接続、スキーマ、マイグレーション
  - `workflow/`: EventBus、ワークフローエンジン
  - `validation/`: Zod スキーマ、バリデーター
  - `git/`: Git 統合、ブランチ管理
  - `filesystem/`: ファイル監視（Chokidar）

- **統合モジュール** (`src/integrations/**`)
  - `github/`: Octokit クライアント、Issue/Project 管理

- **コマンド** (`src/commands/**`)
  - `spec/`: 仕様書 CRUD 操作
  - `github/`: GitHub 統合コマンド
  - `quality/`: コードレビュー、リファクタリング、テスト生成、Lint、スキーマ検証
  - `sync/`: 同期チェック・修復

### 既存仕様書

現時点で依存する仕様書はありません（この仕様書が全体設計の基盤となります）。

### 外部ライブラリ

- **Kysely** (^0.27.4): 型安全なSQLクエリビルダー
- **EventEmitter2** (^6.4.9): イベント駆動アーキテクチャ
- **Octokit** (@octokit/rest, @octokit/graphql): GitHub API クライアント
- **Zod** (^3.24.1): スキーマバリデーション
- **TSyringe** (^4.8.0): 依存性注入コンテナ
- **Chokidar** (^4.0.3): ファイル監視

---

## 6. 参考情報

### ドキュメント

- `docs/ARCHITECTURE.md`: アーキテクチャ設計の詳細
- `CLAUDE.md`: プロジェクト規約、コーディング規約
- `README.md`: プロジェクト概要

### 調査結果

調査により以下の知見を得ました：

#### スクリプト化が必須の処理

| 処理タイプ | 理由 | 例 |
|---|---|---|
| データベース操作 | Kysely の型安全性、トランザクション管理 | `spec/create.ts`, `spec/phase.ts` |
| GitHub API 呼び出し | Octokit の認証、レート制限管理 | `github/issue-create.ts` |
| イベント駆動処理 | EventBus の初期化、ハンドラー管理 | `spec/create.ts` (spec.created イベント) |
| ファイル監視・長時間実行 | Chokidar、バックグラウンドプロセス | `watch.ts` |
| 複雑なバリデーション | Zod スキーマ、整合性チェック | `sync/check.ts` |

#### プロンプトで代替可能な処理

| 処理 | 現状 | 代替案 |
|---|---|---|
| コードレビュー (`code-review.ts`) | スクリプトは起動トリガーのみ | プロンプトで直接指示 |
| リファクタリング (`refactor.ts`) | スクリプトは起動トリガーのみ | プロンプトで直接指示 |
| テスト生成 (`test-generate.ts`) | スクリプトは起動トリガーのみ | プロンプトで直接指示 |
| Lint チェック (`lint-check.ts`) | スクリプトは起動トリガーのみ | Bash ツールで `npm run lint` |
| スキーマ検証 (`schema-validate.ts`) | スクリプトは起動トリガーのみ | プロンプトで直接指示 |

### 設計パターン

- **モジュラーモノリス**: マイクロサービスの利点（モジュール分離）とモノリスの利点（単一デプロイ）を組み合わせ
- **イベント駆動アーキテクチャ**: EventBus による疎結合な処理フロー
- **依存性注入（DI）**: TSyringe によるモック差し替え、テスタビリティ向上

---

## 7. 設計詳細

### 7.1. アーキテクチャ設計

#### 7.1.1 処理層の責務分離

現在の cc-craft-kit は、以下の3層構造で処理を実装しています。

```
┌─────────────────────────────────────────────────────┐
│ プロンプト層 (.md)                                      │
│ - ユーザー向けドキュメント                                 │
│ - 自動実行フロー定義 (Task/Skill/Tool呼び出し)               │
│ - 引数説明、使用例                                       │
└─────────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────┐
│ スクリプト層 (.ts)                                      │
│ - CLIエントリーポイント                                  │
│ - 引数パース・バリデーション                               │
│ - データベース操作                                       │
│ - イベント発火                                          │
│ - 複雑な検証・解析                                       │
└─────────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────┐
│ コア層 (src/core/**)                                   │
│ - データベース接続管理 (database/)                        │
│ - イベントバス (workflow/)                              │
│ - バリデーション (validation/)                          │
│ - Git統合 (git/)                                      │
│ - ファイル監視 (filesystem/)                           │
└─────────────────────────────────────────────────────┘
```

#### 7.1.2 スクリプト実装が必須の処理

以下の処理は、技術的制約・複雑性・安全性の観点から、**スクリプト実装を維持すべき**です。

| 処理タイプ | 理由 | 具体例 |
|---|---|---|
| **データベース操作** | Kysely の型安全性、トランザクション管理、シングルトン制御 | `spec/create.ts`, `spec/phase.ts` |
| **GitHub API 呼び出し** | Octokit の認証、レート制限管理、複雑なクエリ | `github/issue-create.ts` |
| **イベント駆動処理** | EventBus の初期化、ハンドラー登録、非同期イベント発火 | `spec/create.ts` (spec.created イベント) |
| **ファイル監視・長時間実行** | Chokidar、バックグラウンドプロセス、シグナルハンドラー | `watch.ts` |
| **複雑なバリデーション** | Zod スキーマ、プレースホルダー検出、フェーズ遷移検証 | `sync/check.ts`, `spec/phase.ts` |
| **品質要件管理** | YAML解析、ファイルシステムスキャン、不足検出 | `quality/check.ts`, `quality/mapper.ts` |

#### 7.1.3 プロンプトベースに移行可能な処理

以下の処理は、**プロンプトベースに移行可能**または**段階的に移行可能**です。

| 処理 | 現状 | 移行後 | 優先度 |
|---|---|---|---|
| **コードレビュー** | `code-review.ts` でメッセージ表示 → `code-review.md` でサブエージェント起動 | `code-review.md` に統合（スクリプト削除可） | 高 |
| **リファクタリング** | `refactor.ts` でメッセージ表示 → `refactor.md` でサブエージェント起動 | `refactor.md` に統合（スクリプト削除可） | 高 |
| **テスト生成** | `test-generate.ts` でメッセージ表示 → `test-generate.md` でサブエージェント起動 | `test-generate.md` に統合（スクリプト削除可） | 高 |
| **Lint チェック** | `lint-check.ts` でスキル起動 | Bash ツールで `npm run lint` 直接実行 | 中 |
| **スキーマ検証** | `schema-validate.ts` でスキル起動 | `schema-validate.md` に統合（スクリプト削除可） | 中 |
| **品質要件初期化** | `quality/init.ts` でテンプレート出力 | プロンプトで YAML テンプレート生成 → Write ツール | 低 |

#### 7.1.4 処理フロー: カスタムスラッシュコマンド → スキル → サブエージェント

```
ユーザー入力: /cft:code-review src/**/*.ts
         ↓
┌─────────────────────────────────────────┐
│ 1. カスタムスラッシュコマンド (.md)         │
│    - code-review.md の自動実行フロー読み込み │
└─────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────┐
│ 2. スクリプト実行 (オプション)              │
│    - npx tsx .cc-craft-kit/commands/    │
│      quality/code-review.ts             │
│    - 引数検証、メッセージ表示              │
└─────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────┐
│ 3. プロンプト自動実行                      │
│    - Glob ツールでファイルパターン解決      │
│    - Task ツールでサブエージェント起動      │
│      (subagent_type: code-reviewer)    │
└─────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────┐
│ 4. サブエージェント実行                    │
│    - Read ツールで対象ファイル読み込み      │
│    - コード品質分析                        │
│    - Edit ツールで修正提案                │
└─────────────────────────────────────────┘
         ↓
結果表示: レビュー結果、修正提案
```

**改善方針**:

- **Step 2（スクリプト実行）を削減**: 検証のみの軽量スクリプトはプロンプト層に統合
- **Step 3 の強化**: プロンプト層で複雑なロジック（条件分岐、並列実行）も実装可能
- **Step 4 の標準化**: サブエージェントの標準テンプレート化（quality-requirements.yaml で管理）

### 7.2. データモデル

#### 7.2.1 既存データベーススキーマ（維持）

現在の cc-craft-kit は、以下のテーブル構成を持ちます。これらは**変更せず維持**します。

**specs テーブル**:
```typescript
interface Spec {
  id: string;                    // UUID
  name: string;                  // 仕様書名
  description: string | null;    // 説明
  phase: Phase;                  // requirements | design | tasks | implementation | testing | completed
  file_path: string;             // .cc-craft-kit/specs/{id}.md
  branch_name: string | null;    // Git ブランチ名
  github_issue_id: number | null;     // GitHub Issue番号
  github_project_id: string | null;   // GitHub Project ID
  github_milestone_id: number | null; // GitHub Milestone ID
  created_at: string;            // ISO 8601
  updated_at: string;            // ISO 8601
}
```

**tasks テーブル**:
```typescript
interface Task {
  id: string;                    // UUID
  spec_id: string;               // 外部キー → specs.id
  title: string;                 // タスク名
  description: string | null;    // 説明
  status: TaskStatus;            // pending | in_progress | completed | blocked
  priority: number;              // 優先度（1-5）
  dependencies: string | null;   // JSON配列 ["task_id1", "task_id2"]
  created_at: string;
  updated_at: string;
}
```

**knowledge_base テーブル**:
```typescript
interface KnowledgeBase {
  id: string;                    // UUID
  spec_id: string;               // 外部キー → specs.id
  category: KnowledgeCategory;   // progress | error | tip | decision
  title: string;                 // タイトル
  content: string;               // 本文
  metadata: string | null;       // JSON形式のメタデータ
  created_at: string;
}
```

#### 7.2.2 品質要件データモデル（YAML）

品質要件は `.cc-craft-kit/quality-requirements.yaml` で管理されます。

```yaml
version: "1.0"
quality_requirements:
  - name: "code-review"
    type: "subagent"
    trigger_phase: "implementation"
    description: "コード品質をレビュー"
    template: "default-code-reviewer"
    tools:
      - Read
      - Grep
      - Glob
      - Edit
      - Bash
    parameters:
      focus_areas:
        - "Security vulnerabilities"
        - "Performance issues"
        - "Code maintainability"

  - name: "typescript-eslint"
    type: "skill"
    trigger_phase: "implementation"
    description: "TypeScript/ESLint チェック"
    template: "default-typescript-eslint"
    tools:
      - Read
      - Grep
      - Glob
      - Bash
    parameters:
      strict_mode: true
```

**スキーマ定義** (`src/core/quality/schema.ts`):
```typescript
interface QualityRequirement {
  name: string;
  type: 'subagent' | 'skill';
  trigger_phase: TriggerPhase;
  description: string;
  template: string;
  tools: string[];
  parameters?: Record<string, unknown>;
}

type TriggerPhase = 'requirements' | 'design' | 'tasks' | 'implementation' | 'testing' | 'completed';
```

### 7.3. API の仕様

#### 7.3.1 内部 API（モジュール間連携）

**EventBus API**:
```typescript
// イベント発火
await eventBus.emit(
  eventBus.createEvent('spec.phase_changed', specId, {
    oldPhase: 'requirements',
    newPhase: 'design',
  })
);

// イベントハンドラー登録
eventBus.on('spec.phase_changed', async (event) => {
  // フェーズ遷移時の自動処理
});
```

**Database API**:
```typescript
// シングルトン接続取得
const db = getDatabase();

// CRUD操作（Kysely）
await db
  .selectFrom('specs')
  .where('id', '=', specId)
  .selectAll()
  .executeTakeFirst();

await db
  .updateTable('specs')
  .set({ phase: 'design', updated_at: new Date().toISOString() })
  .where('id', '=', specId)
  .execute();
```

**Quality Mapper API**:
```typescript
import { QualityMapper } from '@/core/quality/mapper.js';

// 品質要件読み込み
const requirements = await QualityMapper.loadQualityRequirements();

// 特定フェーズの品質要件取得
const designRequirements = QualityMapper.getRequirementsForPhase(requirements, 'design');

// 不足している品質チェックを検出
const gaps = await QualityMapper.detectQualityGaps();
```

#### 7.3.2 外部 API（GitHub 統合）

**Octokit REST API**:
```typescript
// Issue 作成
const { data: issue } = await octokit.rest.issues.create({
  owner: 'your-org',
  repo: 'your-repo',
  title: spec.name,
  body: issueBody,
  labels: ['spec', `phase:${spec.phase}`],
});

// Issue 更新
await octokit.rest.issues.update({
  owner: 'your-org',
  repo: 'your-repo',
  issue_number: issueNumber,
  body: updatedBody,
});
```

**Octokit GraphQL API**:
```typescript
// Project V2 に Issue を追加
const mutation = `
  mutation($projectId: ID!, $contentId: ID!) {
    addProjectV2ItemById(input: {
      projectId: $projectId
      contentId: $contentId
    }) {
      item {
        id
      }
    }
  }
`;

await octokit.graphql(mutation, {
  projectId: projectNodeId,
  contentId: issueNodeId,
});
```

### 7.4. セキュリティ考慮事項

#### 7.4.1 認証情報の安全な管理

- **環境変数**: `.env` ファイルで管理（`.gitignore` に追加）
  ```bash
  GITHUB_TOKEN=ghp_xxxxxxxxxxxxx
  DATABASE_PATH=.cc-craft-kit/cc-craft-kit.db
  ```

- **トークン検証**: Octokit 初期化時に認証チェック
  ```typescript
  try {
    await octokit.rest.users.getAuthenticated();
  } catch (error) {
    throw new Error('GitHub token is invalid or expired');
  }
  ```

#### 7.4.2 入力検証

- **Zod スキーマ**: すべての CLI 引数を検証
  ```typescript
  const PhaseSchema = z.enum(['requirements', 'design', 'tasks', 'implementation', 'testing', 'completed']);
  const validatedPhase = PhaseSchema.parse(phase);
  ```

- **SQL インジェクション対策**: Kysely のパラメータ化クエリのみを使用
  ```typescript
  // ✓ 安全
  await db.selectFrom('specs').where('id', '=', userInput).selectAll().execute();

  // ✗ 危険（使用禁止）
  await db.executeQuery(`SELECT * FROM specs WHERE id = '${userInput}'`);
  ```

#### 7.4.3 データベース破損防止

- **シングルトンパターン**: 複数インスタンス生成を禁止
  ```typescript
  if (dbInstance && dbPath !== requestedPath) {
    throw new Error('Database instance already exists with different path');
  }
  ```

- **WAL モード**: 並行アクセス時の整合性を保証
  ```typescript
  db.pragma('journal_mode = WAL');
  db.pragma('busy_timeout = 5000');
  ```

- **シグナルハンドラー**: 異常終了時も安全にクローズ
  ```typescript
  process.on('SIGINT', async () => {
    await closeDatabase();
    process.exit(0);
  });
  ```

### 7.5. テスト戦略

#### 7.5.1 単体テスト

**テストファイル配置**:
```
tests/
├── core/
│   ├── database/
│   │   ├── connection.test.ts
│   │   └── migrations.test.ts
│   ├── workflow/
│   │   └── event-bus.test.ts
│   └── quality/
│       ├── mapper.test.ts
│       └── schema.test.ts
├── commands/
│   ├── spec/
│   │   ├── create.test.ts
│   │   └── phase.test.ts
│   └── quality/
│       └── check.test.ts
└── integrations/
    └── github/
        └── client.test.ts
```

**モック戦略**:

| 対象 | モック方法 | 理由 |
|---|---|---|
| **データベース** | `:memory:` モード | テスト間の独立性確保 |
| **GitHub API** | `nock` でHTTPモック | レート制限回避 |
| **Git 操作** | `simple-git` のモック | テスト実行時にブランチ変更を防止 |
| **ファイルシステム** | `memfs` | 実ファイル生成を回避 |
| **EventBus** | 独立インスタンス | テスト間のイベント混在防止 |

**カバレッジ目標**:
- **全体**: 80%以上
- **コア層** (`src/core/**`): 90%以上
- **コマンド層** (`src/commands/**`): 70%以上

#### 7.5.2 統合テスト

**テストシナリオ例**:

```typescript
describe('Spec Phase Transition Integration', () => {
  it('requirements → design でバリデーション成功し、イベントが発火される', async () => {
    // 1. 仕様書作成
    const spec = await createSpec('Test Spec');

    // 2. 要件定義を埋める
    await fillRequirementsSection(spec.id);

    // 3. フェーズ遷移
    const result = await updateSpecPhase(spec.id, 'design');

    // 4. 検証
    expect(result.success).toBe(true);
    expect(eventBus.emit).toHaveBeenCalledWith(
      expect.objectContaining({ type: 'spec.phase_changed' })
    );
  });
});
```

#### 7.5.3 E2E テスト

**テスト対象**:
- スラッシュコマンドの実行（`/cft:spec-create` → `/cft:spec-phase` → `/cft:github-issue-create`）
- GitHub 統合の動作確認（モックサーバー使用）
- ファイル監視の動作確認

**テスト環境**:
- CI/CD: GitHub Actions
- テストデータベース: `:memory:`
- GitHub API: `nock` でモック

### 7.6. 移行ロードマップ

#### Phase 1: 軽量な処理をプロンプト化（優先度: 高）

| タスク | 対象ファイル | 移行内容 | 期待効果 |
|---|---|---|---|
| コードレビュー統合 | `code-review.ts` → `code-review.md` | スクリプト削除、プロンプト層に統合 | コンテキスト効率+30% |
| リファクタリング統合 | `refactor.ts` → `refactor.md` | スクリプト削除、プロンプト層に統合 | コンテキスト効率+30% |
| テスト生成統合 | `test-generate.ts` → `test-generate.md` | スクリプト削除、プロンプト層に統合 | コンテキスト効率+30% |

#### Phase 2: 検証処理の分割（優先度: 中）

| タスク | 対象ファイル | 移行内容 | 期待効果 |
|---|---|---|---|
| Lint チェック簡素化 | `lint-check.ts` | Bash ツールで `npm run lint` 直接実行 | コード削減50行 |
| スキーマ検証統合 | `schema-validate.ts` → `schema-validate.md` | スクリプト削減、スキルに移行 | コンテキスト効率+20% |

#### Phase 3: 品質管理の完全統合（優先度: 低）

| タスク | 対象ファイル | 移行内容 | 期待効果 |
|---|---|---|---|
| 品質要件初期化 | `quality/init.ts` | プロンプトで YAML 生成 | コード削減30行 |
| 品質チェック簡素化 | `quality/check.ts` | 不足検出ロジックをプロンプト化 | 保守性向上 |

#### 重要: スクリプトに残すべき処理

以下は**常にスクリプト実装を維持**します:

- ✓ データベース層全体 (`src/core/database/**`)
- ✓ イベントバス管理 (`src/core/workflow/event-bus.ts`)
- ✓ 複雑な型検証 (`src/core/validation/**`)
- ✓ GitHub API 呼び出し (`src/integrations/github/**`)
- ✓ Git 操作 (`src/core/git/**`)
- ✓ ファイル監視 (`src/core/filesystem/**`)

### 7.7. 設計指針の文書化

#### 7.7.1 CLAUDE.md への追記内容

以下のセクションを `CLAUDE.md` に追記します。

```markdown
## スクリプトとプロンプトの使い分け指針

### プロンプトファースト原則

cc-craft-kit の開発では、「プロンプトで済ませられることはプロンプトで済ませる」という基本原則に従います。

### スクリプト実装が必要な処理

以下の処理は、**TypeScript スクリプトで実装**してください:

1. **データベース操作**
   - Kysely の型安全性が必要
   - トランザクション管理が必要
   - 例: `spec/create.ts`, `spec/phase.ts`

2. **GitHub API 呼び出し**
   - Octokit の認証・レート制限管理が必要
   - 複雑なクエリ（GraphQL）
   - 例: `github/issue-create.ts`

3. **イベント駆動処理**
   - EventBus の初期化・ハンドラー登録
   - 非同期イベント発火
   - 例: `spec/create.ts` (spec.created イベント)

4. **ファイル監視・長時間実行**
   - Chokidar によるファイル監視
   - バックグラウンドプロセス
   - 例: `watch.ts`

5. **複雑なバリデーション**
   - Zod スキーマ検証
   - プレースホルダー検出
   - フェーズ遷移検証
   - 例: `sync/check.ts`, `spec/phase.ts`

### プロンプトベースで実装すべき処理

以下の処理は、**カスタムスラッシュコマンド (.md) で実装**してください:

1. **軽量な検証・表示処理**
   - 引数の簡単な検証
   - ユーザー向けメッセージ表示
   - 例: ガイダンス表示、簡単なファイル操作

2. **サブエージェント・スキル起動**
   - Task/Skill ツールによる起動
   - ファイルパターン解決（Glob）
   - 結果の構造化表示
   - 例: `code-review.md`, `refactor.md`, `test-generate.md`

3. **単純なファイル操作**
   - Read/Write/Edit ツール
   - 例: テンプレート生成、簡単な設定ファイル更新

### 判断基準チェックリスト

新しい機能を実装する際は、以下のチェックリストを使用してください。

#### スクリプト実装が必要か？

- [ ] データベース操作（CRUD、トランザクション）が必要
- [ ] GitHub API 呼び出しが必要
- [ ] イベント発火・ハンドラー登録が必要
- [ ] ファイル監視・バックグラウンド実行が必要
- [ ] 複雑な Zod スキーマ検証が必要
- [ ] 型安全性が重要（TypeScript の型推論が必要）

→ **1つでも該当すれば、スクリプト実装を選択**

#### プロンプトベースで十分か?

- [ ] 単純な引数検証のみ
- [ ] サブエージェント・スキル起動が主目的
- [ ] ファイル読み書きのみ（Read/Write/Edit ツール）
- [ ] ユーザー向けメッセージ表示が主目的
- [ ] Bash コマンド実行のみ（npm run lint など）

→ **すべて該当すれば、プロンプトベース実装を選択**
```

#### 7.7.2 docs/ARCHITECTURE.md への追記内容

以下のセクションを `docs/ARCHITECTURE.md` に追記します。

```markdown
## プロンプトベースアーキテクチャ

cc-craft-kit は、Claude Code のプロンプトベース実行を最大限活用するアーキテクチャを採用しています。

### 3層アーキテクチャ

```
プロンプト層 (.md)
  ↓
スクリプト層 (.ts)
  ↓
コア層 (src/core/**)
```

### 処理フロー例: コードレビュー

```
/cft:code-review src/**/*.ts
  ↓
code-review.md (プロンプト層)
  - ファイルパターン解決 (Glob)
  - code-reviewer サブエージェント起動 (Task)
  ↓
code-reviewer (サブエージェント)
  - Read ツールで対象ファイル読み込み
  - コード品質分析
  - Edit ツールで修正提案
  ↓
結果表示
```

### 設計原則

1. **プロンプトファースト**: プロンプトで済ませられることはプロンプトで済ませる
2. **疎結合**: モジュール間の依存関係を最小化（イベント駆動）
3. **型安全性**: TypeScript strict mode、Kysely の型安全なクエリビルダー
4. **テスタビリティ**: DI によるモック差し替え、`:memory:` データベース
```
