# v0.1.0 リリース作業

**仕様書 ID:** d356440e-45cb-46dc-ae99-62ab6dabe2d2
**フェーズ:** completed
**作成日時:** 2025/11/24 10:48:19
**更新日時:** 2025/11/24 21:11:00

---

## 1. 背景と目的

### 背景

現在の develop ブランチを main ブランチにマージして v0.1.0 としてリリースしたい。既に、v0.1.0 のリリースがあるがそれは削除して、改めて現在の develop ブランチのものを v0.1.0 としてリリースする。なおこの作業により、データベース中の各仕様書中のブランチカラムはすべて main ブランチとなる。あと、各種ドキュメント、コード内にバージョンの記述があればすべて v0.1.0 になっていること。また、CHANGELOG.md は新たに現在の仕様で上書きしてください。その際、ユーザー目線での記述となるようにしてください。

### 目的

cc-craft-kit の初回正式リリース v0.1.0 を安定版として main ブランチに統合し、ユーザーが利用できる状態にする。既存の v0.1.0 タグは削除し、現在の develop ブランチの内容を正式な v0.1.0 としてリリースする。これにより、データベース中のすべての仕様書のブランチカラムが main に統一され、プロジェクト全体のバージョン情報が v0.1.0 に整合される。

---

## 2. 対象ユーザー

- **プロジェクト管理者**: cc-craft-kit のリリースを担当する開発者
- **ユーザー**: cc-craft-kit を利用する開発者（正式リリースのタグ・バージョンを参照）

---

## 3. 受け入れ基準

### 必須要件

- [ ] 既存の v0.1.0 Git タグが削除されている
- [ ] develop ブランチが main ブランチにマージされている
- [ ] main ブランチに新しい v0.1.0 Git タグが付与されている
- [ ] データベース（specs テーブル）のすべての仕様書の `branch_name` カラムが `main` に更新されている

### 機能要件

- [ ] package.json の `version` フィールドが `0.1.0` に設定されている
- [ ] CHANGELOG.md がユーザー目線の内容で新規作成されている
- [ ] 各種ドキュメント（README.md、CLAUDE.md、docs/*.md）のバージョン記述が v0.1.0 に統一されている
- [ ] ソースコード内のバージョン記述が v0.1.0 に統一されている

### 非機能要件

- [ ] main ブランチの CI テストがすべて通過している
- [ ] リント・型チェックがエラーなく完了している
- [ ] リリースタグ作成後、GitHub Actions が正常に実行される（npm publish の事前確認）

---

## 4. 制約条件

- **Git タグの一意性**: 同名の Git タグ（v0.1.0）は存在できないため、既存タグを削除してから新規作成する必要がある
- **ブランチ保護ルール**: main ブランチは保護されているため、PR 経由でのマージが必須
- **データベース整合性**: specs テーブルの `branch_name` カラムは NOT NULL 制約があり、すべてのレコードを main に更新する必要がある
- **Semantic Versioning**: v0.1.0 は MINOR リリースであり、後方互換性のある新機能を含む
- **CHANGELOG.md の形式**: Keep a Changelog 形式に準拠し、ユーザー目線で変更内容を記述する

---

## 5. 依存関係

- **関連仕様書**: `cab85173-3f2b-4b85-8c90-2a23d54fe4b4` (0.1.0 リリースに向けた作業) - completed フェーズ
- **データベーススキーマ**: マイグレーション 006 (`006_add_branch_name_to_specs.ts`) で追加された `branch_name` カラムに依存
- **GitHub Actions**: `.github/workflows/release.yml` のワークフローが正常に動作する必要がある
- **ブランチ保護**: main ブランチの保護ルール（PR 必須、CI テスト必須）に準拠する必要がある

---

## 6. 参考情報

- [CLAUDE.md - リリースフロー](../CLAUDE.md#リリースフロー)
- [Semantic Versioning 2.0.0](https://semver.org/)
- [Keep a Changelog](https://keepachangelog.com/ja/1.0.0/)
- [GitHub リポジトリ](https://github.com/B16B1RD/cc-craft-kit)
- [既存 CHANGELOG.md](../CHANGELOG.md)
- [関連仕様書 - 0.1.0 リリースに向けた作業](./cab85173-3f2b-4b85-8c90-2a23d54fe4b4.md)

---

## 7. 設計詳細

### 7.1. アーキテクチャ設計

v0.1.0 リリース作業は、以下の3つの主要コンポーネントで構成されます。

#### A. Git タグ管理

```
既存タグ削除 → develop を main にマージ → 新規タグ作成
     ↓                  ↓                        ↓
git tag -d v0.1.0   git merge develop    git tag -a v0.1.0 -m "..."
git push --delete   (PR 経由)            git push origin v0.1.0
```

#### B. データベース更新

```
specs テーブルの全レコード一括更新
     ↓
UPDATE specs SET branch_name = 'main' WHERE branch_name IS NOT NULL
     ↓
すべての仕様書が main ブランチに統一される
```

#### C. バージョン情報の統一

```
package.json の version フィールド更新
     ↓
ドキュメント・ソースコード内のバージョン記述を検索・更新
     ↓
CHANGELOG.md を新規作成（Keep a Changelog 形式）
```

#### リリースワークフロー全体像

```
[手動作業]                    [GitHub Actions 自動実行]
    ↓                                ↓
Git タグ push (v0.1.0)  →  GitHub Actions トリガー
    ↓                                ↓
                          1. npm ci (依存関係インストール)
                          2. npm run sync:dogfood (.cc-craft-kit/ 同期)
                          3. .cc-craft-kit.tar.gz 作成
                          4. GitHub Release 作成
                          5. install.sh を GitHub Pages へデプロイ
```

### 7.2. データモデル

#### specs テーブルの更新対象カラム

| カラム名 | 型 | 現在値の例 | 更新後の値 | 備考 |
|---------|---|-----------|----------|------|
| `branch_name` | `string \| null` | `feature/spec-xxx`, `develop`, `null` | `main` | すべてのレコードを `main` に統一 |

#### 一括更新クエリ

```typescript
// src/scripts/update-specs-to-main.ts (新規作成)
import { getDatabase } from '../core/database/connection.js';
import { sql } from 'kysely';

export async function updateAllSpecsToMain(): Promise<void> {
  const db = getDatabase();

  // すべての仕様書の branch_name を main に更新
  await db.updateTable('specs')
    .set({ branch_name: 'main' })
    .execute();

  console.log('✓ すべての仕様書のブランチを main に更新しました');
}
```

### 7.3. Git 操作の仕様

#### 既存タグの削除

```bash
# ローカルタグ削除
git tag -d v0.1.0

# リモートタグ削除
git push origin --delete v0.1.0
```

#### develop を main にマージ（PR 経由）

```bash
# 1. develop ブランチに切り替え
git checkout develop
git pull origin develop

# 2. main ブランチを最新化
git checkout main
git pull origin main

# 3. PR 作成（GitHub CLI）
gh pr create --base main --head develop \
  --title "release: v0.1.0" \
  --body "v0.1.0 正式リリース

## 概要
develop ブランチを main にマージして v0.1.0 としてリリースします。

## 変更内容
- 仕様駆動開発（SDD）の基本機能実装
- GitHub Integration（Issue/PR 自動作成）
- データベース整合性チェック機能
- カスタムスラッシュコマンド 20+ 個

## リリース後の処理
- [x] Git タグ v0.1.0 作成
- [x] データベースの branch_name を main に統一
- [x] CHANGELOG.md 更新
"
```

#### 新規タグの作成

```bash
# main ブランチに切り替え
git checkout main
git pull origin main

# 新規タグ作成（アノテートタグ）
git tag -a v0.1.0 -m "Release version 0.1.0

v0.1.0 正式リリース

主な機能:
- 仕様駆動開発（SDD）の基本機能
- GitHub Integration（Issue/PR 自動作成）
- データベース整合性チェック
- カスタムスラッシュコマンド 20+ 個
"

# リモートへプッシュ
git push origin v0.1.0
```

### 7.4. セキュリティ考慮事項

#### A. Git タグ削除のリスク

- **リスク**: 既存の v0.1.0 タグを削除すると、タグを参照しているユーザーに影響が出る可能性
- **対策**: CHANGELOG.md にタグ再作成の経緯を明記し、ユーザーに周知

#### B. データベース一括更新のリスク

- **リスク**: 一括更新クエリが失敗した場合、データベースが不整合な状態になる可能性
- **対策**:
  1. 実行前にデータベースのバックアップを取得
  2. dry-run モードで更新対象レコードを確認
  3. UPDATE クエリ実行後、検証クエリで全レコードが `main` になっていることを確認

```typescript
// dry-run モード
export async function verifySpecsBeforeUpdate(): Promise<void> {
  const db = getDatabase();
  const specs = await db.selectFrom('specs')
    .select(['id', 'name', 'branch_name'])
    .where('branch_name', '!=', 'main')
    .execute();

  console.log(`更新対象の仕様書: ${specs.length} 件`);
  specs.forEach(spec => {
    console.log(`  - ${spec.name} (${spec.branch_name} → main)`);
  });
}

// 検証クエリ
export async function verifyAllSpecsOnMain(): Promise<boolean> {
  const db = getDatabase();
  const nonMainSpecs = await db.selectFrom('specs')
    .select('id')
    .where('branch_name', '!=', 'main')
    .execute();

  if (nonMainSpecs.length > 0) {
    console.error(`⚠ main 以外のブランチが ${nonMainSpecs.length} 件残っています`);
    return false;
  }

  console.log('✓ すべての仕様書が main ブランチになっています');
  return true;
}
```

#### C. バージョン情報の不整合リスク

- **リスク**: package.json、ドキュメント、ソースコード内のバージョン記述が不一致になる可能性
- **対策**: リリース前に grep でバージョン記述を全検索し、v0.1.0 に統一されていることを確認

```bash
# バージョン記述の検索
grep -r "version" package.json README.md CLAUDE.md docs/ src/ --include="*.md" --include="*.ts" --include="*.json"
```

### 7.5. テスト戦略

#### A. 単体テスト

**対象**: データベース更新スクリプト

```typescript
// tests/scripts/update-specs-to-main.test.ts
import { describe, it, expect, beforeEach, afterEach } from '@jest/globals';
import { getDatabase, closeDatabase } from '../../src/core/database/connection.js';
import { updateAllSpecsToMain, verifyAllSpecsOnMain } from '../../src/scripts/update-specs-to-main.js';

describe('updateAllSpecsToMain', () => {
  let db: Kysely<Database>;

  beforeEach(async () => {
    db = getDatabase({ databasePath: ':memory:' });
    // マイグレーション実行
    await migrateToLatest(db);

    // テストデータ投入
    await db.insertInto('specs').values([
      { id: 'spec-1', name: 'Spec 1', branch_name: 'feature/test-1', phase: 'requirements' },
      { id: 'spec-2', name: 'Spec 2', branch_name: 'develop', phase: 'design' },
      { id: 'spec-3', name: 'Spec 3', branch_name: 'main', phase: 'completed' },
    ]).execute();
  });

  afterEach(async () => {
    await closeDatabase();
  });

  it('すべての仕様書の branch_name を main に更新する', async () => {
    await updateAllSpecsToMain();

    const allSpecs = await db.selectFrom('specs').selectAll().execute();
    expect(allSpecs.every(spec => spec.branch_name === 'main')).toBe(true);
  });

  it('検証クエリが成功する', async () => {
    await updateAllSpecsToMain();

    const isValid = await verifyAllSpecsOnMain();
    expect(isValid).toBe(true);
  });
});
```

#### B. 統合テスト

**対象**: リリースワークフロー全体

```bash
# テストブランチで実行
git checkout -b test/release-v0.1.0

# 1. Git タグ削除・作成の動作確認
git tag -a v0.1.0-test -m "Test tag"
git tag -d v0.1.0-test

# 2. データベース更新の動作確認
npm run db:migrate
npx tsx src/scripts/update-specs-to-main.ts

# 3. バージョン情報の統一確認
grep -r "0.1.0" package.json README.md CLAUDE.md docs/

# 4. CI テスト実行
npm run lint
npm run typecheck
npm test
```

#### C. リリース後の検証

```bash
# 1. Git タグが正しく作成されているか確認
git tag -l "v0.1.0"
git show v0.1.0

# 2. GitHub Actions が正常に実行されたか確認
gh run list --workflow=release.yml

# 3. GitHub Release が作成されたか確認
gh release view v0.1.0

# 4. データベースの整合性確認
npx tsx -e "
import { getDatabase } from './src/core/database/connection.js';
const db = getDatabase();
const specs = await db.selectFrom('specs').selectAll().execute();
console.log('Total specs:', specs.length);
console.log('All on main:', specs.every(s => s.branch_name === 'main'));
"
```

---

## 8. 実装タスクリスト

### フェーズ 1: 準備作業

1. **既存の v0.1.0 Git タグを削除する**
   - ローカルタグ削除: `git tag -d v0.1.0`
   - リモートタグ削除: `git push origin --delete v0.1.0`
   - 依存: なし
   - 優先度: 高

2. **データベース更新スクリプトを作成**
   - ファイル: `src/scripts/update-specs-to-main.ts`
   - 機能: すべての仕様書の `branch_name` を `main` に更新
   - 機能: dry-run モード (`verifySpecsBeforeUpdate`)
   - 機能: 検証クエリ (`verifyAllSpecsOnMain`)
   - 依存: なし
   - 優先度: 高

3. **単体テストを作成**
   - ファイル: `tests/scripts/update-specs-to-main.test.ts`
   - 対象: `updateAllSpecsToMain`, `verifyAllSpecsOnMain`
   - カバレッジ: 80%以上
   - 依存: タスク 2 完了後
   - 優先度: 高

### フェーズ 2: データベース・バージョン情報の更新

4. **データベースの branch_name を main に一括更新**
   - 実行: `npx tsx src/scripts/update-specs-to-main.ts`
   - 事前確認: dry-run モードで更新対象を確認
   - 事後検証: 検証クエリで全レコードが `main` になっていることを確認
   - 依存: タスク 2、3 完了後
   - 優先度: 高

5. **package.json の version を 0.1.0 に更新**
   - フィールド: `version`
   - 値: `0.1.0`
   - 依存: なし
   - 優先度: 高

6. **CHANGELOG.md を新規作成**
   - 形式: Keep a Changelog
   - 内容: ユーザー目線の変更内容（v0.1.0 の新機能・改善点）
   - 参考: [Keep a Changelog](https://keepachangelog.com/ja/1.0.0/)
   - 依存: なし
   - 優先度: 高

7. **ドキュメント内のバージョン記述を v0.1.0 に統一**
   - 対象ファイル: `README.md`, `CLAUDE.md`, `docs/*.md`
   - 確認コマンド: `grep -r "version" README.md CLAUDE.md docs/ --include="*.md"`
   - 依存: なし
   - 優先度: 中

8. **ソースコード内のバージョン記述を v0.1.0 に統一**
   - 対象ファイル: `src/**/*.ts`
   - 確認コマンド: `grep -r "version" src/ --include="*.ts"`
   - 依存: なし
   - 優先度: 中

### フェーズ 3: 品質チェック・PR 作成

9. **リント・型チェックを実行**
   - コマンド: `npm run lint`, `npx tsc --noEmit`, `npm test`
   - 目的: リリース前の品質確認
   - 依存: タスク 5-8 完了後
   - 優先度: 高

10. **develop ブランチを main にマージする PR を作成**
    - タイトル: `release: v0.1.0`
    - ベースブランチ: `main`
    - ヘッドブランチ: `develop`
    - PR 本文: v0.1.0 の変更内容サマリ
    - 依存: タスク 9 完了後（CI テスト通過）
    - 優先度: 高

### フェーズ 4: リリース・検証

11. **PR マージ後、main ブランチに新しい v0.1.0 Git タグを作成してプッシュ**
    - タグ名: `v0.1.0`
    - タグメッセージ: v0.1.0 正式リリースの説明
    - コマンド: `git tag -a v0.1.0 -m "..."`, `git push origin v0.1.0`
    - 依存: タスク 10 完了後（PR マージ済み）
    - 優先度: 高

12. **GitHub Actions の実行結果を確認**
    - 確認項目: CI テスト、GitHub Release 作成、install.sh デプロイ
    - コマンド: `gh run list --workflow=release.yml`, `gh release view v0.1.0`
    - 依存: タスク 11 完了後
    - 優先度: 高

---
