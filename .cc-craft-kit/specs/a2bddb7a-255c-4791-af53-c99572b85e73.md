# Issue自動作成機能のテスト

**仕様書 ID:** a2bddb7a-255c-4791-af53-c99572b85e73
**フェーズ:** completed
**作成日時:** 2025/11/16 15:20:48
**更新日時:** 2025/11/17 3:10:37

---

## 1. 背景と目的

### 背景

仕様書と GitHub Issue の同期に関する問題が再発している。具体的には以下の 2 つの問題が発生：

1. **仕様書ファイル（.md）を直接編集しても、対応するGitHub Issueが更新されない**
2. **フェーズ変更時に、GitHub Issue のラベルは更新されるが、タイトルとボディが更新されない**

これにより、仕様書と GitHub Issue の内容が乖離し、開発管理の一貫性が失われる。

### 目的

1. 仕様書ファイルの内容変更を検知し、GitHub Issue を自動更新する仕組みを実装する
2. フェーズ変更時に、ラベルだけでなく、タイトル（フェーズ接頭辞）とボディも更新する
3. 仕様書と GitHub Issue の完全な双方向同期を実現する

---

## 2. 対象ユーザー

- Takumi を使用して仕様駆動開発を行う開発者
- GitHub Projects でプロジェクト管理を行うチーム

---

## 3. 根本原因の分析

### 問題1: 仕様書ファイル編集時にIssueが更新されない

**原因:**
- `spec.updated` イベントは定義されているが、実際に発火されている箇所が存在しない
- 仕様書ファイル（.md）を直接編集しても、イベントが発火されないため、GitHub Issue が更新されない
- `spec.updated` イベントに対応するハンドラーも `github-integration.ts` に登録されていない

**影響箇所:**
- `.cc-craft-kit/specs/*.md` ファイルを直接編集した場合、変更が GitHub Issue に反映されない
- Claude による仕様書の内容変更も同様に反映されない

### 問題2: フェーズ変更時にタイトルとボディが更新されない

**原因:**
- `spec.phase_changed` イベントハンドラー（`src/core/workflow/github-integration.ts:178-248`）は、ラベル更新と Project ステータス更新のみを行っている
- Issue のタイトル（`[phase:xxx]` 接頭辞）とボディ（仕様書内容）の更新処理が実装されていない

**現在の実装:**
```typescript
// src/core/workflow/github-integration.ts:209-215
await issues.update({
  owner: githubConfig.owner,
  repo: githubConfig.repo,
  issueNumber: spec.github_issue_id,
  labels: [`phase:${event.data.newPhase}`],  // ラベルのみ更新
});
```

**不足している処理:**
- タイトルに `[phase]` 接頭辞を追加・更新
- ボディを最新の仕様書ファイル内容で更新

---

## 4. 受け入れ基準

### 必須要件

- [x] ~~仕様書ファイル（.md）を編集すると、対応するGitHub Issueのボディが自動更新される~~ → **コメント追加方式に変更**
- [x] フェーズ変更時に、GitHub Issue のタイトルにフェーズが Prefix（例: `[requirements]`）として追加される
- [x] ~~フェーズ変更時に、GitHub Issueのボディが最新の仕様書内容に更新される~~ → **コメント追加方式に変更**
- [x] GitHub Issue のラベルがフェーズに応じて更新される（既存機能、継続）
- [x] GitHub Projects のステータスがフェーズに応じて更新される（既存機能、継続）

**実装方針変更:** Issue 本文は初期内容を保持し、フェーズ移行・仕様書更新はコメントで記録する方式に変更

### 機能要件

- [x] `spec.updated` イベントを発火する仕組みを実装
  - [x] `/cft:spec-update` コマンドを作成
  - [x] データベースの `updated_at` を更新
  - [x] `spec.updated` イベントを発火
- [x] `spec.updated` イベントハンドラーを実装
  - [x] ~~仕様書ファイルを読み込み、GitHub IssueのボディをMarkdown内容で更新~~ → **コメント追加方式に変更**
  - [x] GitHub Issue にコメントを追加（仕様書更新通知）
- [x] `spec.phase_changed` イベントハンドラーを拡張
  - [x] Issue タイトルにフェーズ接頭辞を追加（例: `[requirements] 仕様書名`）
  - [x] ~~Issueボディを最新の仕様書内容で更新~~ → **コメント追加方式に変更**
  - [x] GitHub Issue にコメントを追加（フェーズ移行記録）

### 非機能要件

- [x] GitHub API のレート制限を考慮（不要な更新を避ける）
- [x] エラー発生時も、仕様書の更新は成功させる（GitHub 更新は警告のみ）
- [x] 既存のテストが通過すること
- [ ] 新機能に対する単体テストを追加（E2E テストは手動で完了）

---

## 5. 実装方針

### 重要な設計原則: Issue履歴の保持

**Issue本文（body）は履歴を保持すること:**
- Issue 本文は仕様書作成時の初期内容を保持し、上書きしない
- フェーズ移行や仕様書の内容更新は、**Issueコメントで追記**する
- 本文を更新するのは、誤字脱字などの修正のみ

**理由:**
- 要件定義フェーズで書かれた内容が、後のフェーズで消えてしまうことを防ぐ
- Issue 本文で初期要件を確認でき、コメント欄で進捗・変更履歴を追える
- GitHub Issue が開発ナレッジベースとして機能する

---

### 方針1: Issue更新は本文上書きではなくコメント追加

**Issue作成時（初回のみ）:**
- 仕様書の内容を Issue 本文に設定（現在の実装通り）

**仕様書更新時（`spec.updated` イベント）:**
- Issue 本文は更新しない（初期内容を保持）
- 代わりに、Issue にコメントを追加：
  ```
  ## 📝 仕様書更新

  仕様書が更新されました。

  **更新日時:** 2025/11/17 10:30:00
  **最新の仕様書:** [.cc-craft-kit/specs/<spec-id>.md]

  <変更内容のサマリー（オプション）>
  ```

**フェーズ変更時（`spec.phase_changed` イベント）:**
- Issue 本文は更新しない（初期内容を保持）
- Issue タイトルは更新（`[phase] 仕様書名`）
- Issue ラベルは更新（`phase:xxx`）
- Projects ステータスは更新
- **Issueにコメントを追加**：
  ```
  ## 🔄 フェーズ移行: requirements → design

  フェーズが **requirements** から **design** に移行しました。

  **移行日時:** 2025/11/17 10:30:00

  ### 次のステップ
  - 設計ドキュメントの作成
  - アーキテクチャ図の追加
  - API設計の詳細化
  ```

**実装箇所:**
- `src/core/workflow/github-integration.ts`
- GitHub Issues API の `POST /repos/{owner}/{repo}/issues/{issue_number}/comments` を使用

---

### 方針2: `spec.updated` イベント対応（コメント追加方式）

**ステップ1: イベント発火の実装**

仕様書ファイルを更新する可能性のある箇所でイベントを発火：

1. **`/cft:spec-phase` コマンド内**
   - ファイル: `.cc-craft-kit/commands/spec/phase.ts`
   - フェーズ変更後、Markdown ファイルを更新した後に `spec.updated` イベントを発火

2. **新規コマンド `/cft:spec-update` を作成（推奨）**
   - 仕様書ファイルの内容を明示的に更新するコマンド
   - データベースの `updated_at` を更新
   - `spec.updated` イベントを発火

3. **Claudeによる仕様書ファイル編集後の対応**
   - Claude が仕様書ファイルを編集した後、ユーザーに `/cft:spec-update <spec-id>` の実行を案内
   - または、`/cft:github-sync to-github <spec-id>` を使用

**ステップ2: イベントハンドラーの実装**

- ファイル: `src/core/workflow/github-integration.ts`
- `spec.updated` イベントハンドラーを追加：
  ```typescript
  eventBus.on('spec.updated', async (event) => {
    // Issue本文は更新せず、コメントを追加
    const comment = `## 📝 仕様書更新

仕様書が更新されました。

**更新日時:** ${new Date().toLocaleString('ja-JP')}
**最新の仕様書:** [\`.cc-craft-kit/specs/${spec.id}.md\`](${repoUrl}/blob/main/.cc-craft-kit/specs/${spec.id}.md)
`;

    await issues.createComment({
      owner: githubConfig.owner,
      repo: githubConfig.repo,
      issueNumber: spec.github_issue_id,
      body: comment,
    });
  });
  ```

### 方針3: `spec.phase_changed` イベントハンドラーの拡張（コメント追加方式）

**修正箇所:** `src/core/workflow/github-integration.ts:209-215`

**変更内容:**
```typescript
// タイトルにフェーズ接頭辞を追加
const title = `[${event.data.newPhase}] ${spec.name}`;

// Issue を更新（タイトルとラベルのみ、本文は保持）
await issues.update({
  owner: githubConfig.owner,
  repo: githubConfig.repo,
  issueNumber: spec.github_issue_id,
  title: title,
  labels: [`phase:${event.data.newPhase}`],
  // bodyは指定しない（既存の本文を保持）
});

// フェーズ移行をコメントで記録
const phaseEmoji = {
  requirements: '📋',
  design: '🎨',
  tasks: '📝',
  implementation: '⚙️',
  completed: '✅',
};

const nextSteps = {
  requirements: '- 要件定義の詳細化\n- 背景・目的・受け入れ基準の記述',
  design: '- 設計ドキュメントの作成\n- アーキテクチャ図の追加\n- API設計の詳細化',
  tasks: '- タスク分解\n- 工数見積もり\n- 依存関係の整理',
  implementation: '- 実装の開始\n- テストの作成\n- ドキュメントの更新',
  completed: '- 実装のレビュー\n- 関連Issueのクローズ\n- 次の仕様書の作成',
};

const comment = `## ${phaseEmoji[event.data.oldPhase]} → ${phaseEmoji[event.data.newPhase]} フェーズ移行: ${event.data.oldPhase} → ${event.data.newPhase}

フェーズが **${event.data.oldPhase}** から **${event.data.newPhase}** に移行しました。

**移行日時:** ${new Date().toLocaleString('ja-JP')}

### 次のステップ
${nextSteps[event.data.newPhase]}
`;

await issues.createComment({
  owner: githubConfig.owner,
  repo: githubConfig.repo,
  issueNumber: spec.github_issue_id,
  body: comment,
});
```

**変更点:**
- Issue 本文（body）の更新を削除 → 初期内容を保持
- タイトルとラベルのみ更新
- フェーズ移行の記録をコメントで追加
- フェーズごとの次のステップをガイド

### 方針4: 既存の `/cft:github-sync` コマンドの修正

既存の `/cft:github-sync to-github <spec-id>` コマンドは、Issue 本文を上書き更新している。

**修正内容:**
- Issue 本文の更新を削除（履歴保持のため）
- 代わりに、同期実行時にコメントを追加：
  ```
  ## 🔄 仕様書から同期

  仕様書の内容をGitHub Issueに同期しました。

  **同期日時:** 2025/11/17 10:30:00
  **最新の仕様書:** [.cc-craft-kit/specs/<spec-id>.md]
  ```

**修正箇所:**
- `src/integrations/github/sync.ts` の `syncSpecToGitHub` 関数

---

## 6. 制約条件

- GitHub API のレート制限: 5,000 リクエスト/時
- 仕様書ファイルサイズ: GitHub Issue のボディは最大 65,536 文字
- イベント駆動のため、ハンドラー登録が完了していない場合は同期されない（`getEventBusAsync()` を使用して回避）

---

## 7. 依存関係

### 関連ファイル
- `src/core/workflow/event-bus.ts` - イベントバス
- `src/core/workflow/github-integration.ts` - GitHub 統合ハンドラー
- `.cc-craft-kit/commands/spec/phase.ts` - フェーズ変更コマンド
- `src/integrations/github/sync.ts` - 既存の同期コマンド

### 関連仕様書
- なし（新規機能）

---

## 8. 実装タスク分解（修正版 - コードレビュー後）

### ~~Task 1: GitHub Issues API にコメント作成機能を追加~~ ✅ 既に実装済み

**状態:** 実装済み - タスク不要

**確認事項:**
- `src/integrations/github/issues.ts:146-164` に `addComment()` メソッドが既に実装されている
- GitHub REST API の `POST /repos/{owner}/{repo}/issues/{issue_number}/comments` を呼び出している
- エラーハンドリングも含まれている
- メソッド名は `addComment`（仕様書では `createComment` と記載していたが、既存実装を使用）

**工数:** 0 時間（不要）

---

### Task 1（旧Task 2）: `spec.phase_changed` ハンドラーの拡張（コメント追加方式） ✅ 完了

**目的:** フェーズ変更時に Issue タイトル・ラベルを更新し、コメントで履歴を記録

**作業内容:**
- [x] `src/core/workflow/github-integration.ts:209-238` を修正
- [x] タイトルに `[phase]` 接頭辞を追加
- [x] ラベルを更新（既存機能）
- [x] **Issue本文の更新を削除**（履歴保持のため）
- [x] フェーズ移行をコメントで記録
- [x] 動作確認完了（Issue #15 で検証）

**工数:** 2-3 時間 → **実績: 約2時間**

---

### Task 2（旧Task 3）: `spec.updated` イベントハンドラーの実装（コメント追加方式） ✅ 完了

**目的:** 仕様書ファイル更新時にコメントで通知

**作業内容:**
- [x] `src/core/workflow/github-integration.ts:273-324` に `spec.updated` ハンドラーを追加
- [x] **Issue本文は更新せず、コメントを追加**（既存の `addComment` メソッドを使用）
- [x] 仕様書ファイルへのリンクを含める
- [x] エラーハンドリングを追加
- [x] 動作確認完了（Issue #15 で検証）

**工数:** 2-3 時間 → **実績: 約1.5時間**

---

### Task 3（旧Task 4）: `/cft:github-sync` コマンドの修正 ✅ 完了

**目的:** 既存の同期コマンドを履歴保持方式に変更

**現在の問題:**
- `src/integrations/github/sync.ts:56-67` で Issue 本文を上書きしている（`body: this.buildIssueBody(spec)`）
- これにより初期要件が消えてしまう

**作業内容:**
- [x] `.cc-craft-kit/integrations/github/sync.ts:56-90` の `syncSpecToIssue` メソッドを修正
- [x] **Issue本文の更新（`body` パラメータ）を削除**
- [x] タイトルとラベルのみ更新
- [x] 同期実行時にコメントを追加（既存の `addComment` メソッドを使用）
- [x] 動作確認完了（Issue #3 で検証）

**工数:** 1-2 時間 → **実績: 約1時間**

---

### Task 4（旧Task 5）: `spec.updated` イベントの発火 ✅ 完了

**目的:** 仕様書ファイル更新時にイベントを発火する

**作業内容:**
- [x] 新規コマンド `/cft:spec-update <spec-id>` を作成（`.cc-craft-kit/commands/spec/update.ts`）
- [x] 新規スラッシュコマンド `.claude/commands/takumi/spec-update.md` を作成
- [x] データベースの `updated_at` を更新
- [x] `spec.updated` イベントを発火
- [x] 動作確認完了（Issue #15 で検証）
- [ ] CLAUDE.md にガイドラインを追加（仕様書編集後は `/cft:spec-update` を実行）

**工数:** 2-3 時間 → **実績: 約2時間**

---

### Task 5（旧Task 6）: 動作確認とテスト ✅ 完了

**目的:** 全機能が正常に動作し、履歴が保持されることを確認

**作業内容:**
- [x] `/cft:spec-update` 実行時に、Issue にコメントが追加されることを確認（Issue #15）
- [x] フェーズ変更時に、タイトル・ラベルが更新され、コメントが追加されることを確認（Issue #15）
- [x] **Issue本文が初期内容のまま保持されることを確認**（Issue #15）
- [x] `/cft:github-sync` がコメント追加方式で動作することを確認（Issue #3）
- [x] 既存のテストが通過することを確認
- [ ] E2E テストを追加（手動テストで代替）

**工数:** 2-3 時間 → **実績: 約1.5時間**

---

**総工数見積もり:** 8-14 時間（約 1-2 日）
**実績工数:** 約 8 時間

**重要な変更点（コードレビュー後）:**
- ✅ **Task 1を削除**: `addComment()` メソッドは既に実装済み（2 時間削減）
- ✅ **既存APIの活用**: `addComment()` を使用してコメント追加を実装
- ✅ **sync.ts の修正を追加**: Issue 本文の上書きを防ぐ
- ✅ **Issue履歴保持の実装完了**:
  - Issue 本文は作成時のみ設定し、以降は更新しない
  - フェーズ移行や仕様書更新は、すべてコメントで記録
  - 履歴がコメント欄に時系列で蓄積される
  - Issue #15 と #3 で動作確認完了

---

## 9. 参考情報

### 関連コード

- `src/core/workflow/event-bus.ts:7-19` - イベント型定義
- `src/core/workflow/github-integration.ts:43-249` - GitHub 統合ハンドラー
- `.cc-craft-kit/commands/spec/phase.ts:87-95` - フェーズ変更時のイベント発火
- `src/integrations/github/sync.ts` - 既存の同期コマンド

### GitHub API ドキュメント

- [Update an issue - GitHub REST API](https://docs.github.com/en/rest/issues/issues#update-an-issue)
