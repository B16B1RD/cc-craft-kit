# 仕様書作成時のデータベース整合性の保証機能の実装

**仕様書 ID:** a9cc98bc-97b0-4d2d-a8c9-672d5127eafe
**フェーズ:** implementation
**作成日時:** 2025/11/21 08:13:33
**更新日時:** 2025/11/21 11:07:28

---

## 1. 背景と目的

### 背景

/cft:spec-create コマンド実行時に以下の警告メッセージが表示され、開発者に不安を与えています。

```text
⚠️  Database integrity warnings:
      - Found 1 database record(s) with invalid spec file
```

この警告は、データベースレコードと仕様書ファイルの整合性が取れていないことを示しており、以下の問題を引き起こします。

1. **開発フローの中断**: エラーメッセージが表示されるたびに、開発者は無視してよいか、または修復が必要かを判断する必要がある
2. **データ損失のリスク**: 仕様書ファイルの破損により、実装履歴を失う可能性がある
3. **CI/CD の失敗**: 整合性チェックをテストに含める場合、警告によりビルド失敗の可能性がある

すでに仕様書 ID `f1341d15-df2f-48c7-8bbd-ec7fa043749f` で根本原因の分析と修復スクリプトの実装は完了していますが、仕様書作成時の予防的な対策が不十分であるため、本仕様書で追加の恒久対策を実施します。

### 目的

/cft:spec-create 実行時に発生する「Database integrity warnings」エラーの根本原因を特定し、恒久的な解決策を実装することで、以下を達成する。

1. 仕様書作成時のデータベース整合性を常に保証する
2. 既存の不整合レコードを自動的に検出・修復する機能を提供する
3. 開発者体験を向上させ、エラーメッセージに惑わされることなく開発を進められる環境を整備する

---

## 2. 対象ユーザー

- **cc-craft-kit の開発者**: ドッグフーディング環境でこのツールを使用している開発者
- **cc-craft-kit を利用する全ユーザー**: 仕様書作成時にエラーメッセージが表示されると開発フローが中断される
- **将来のコントリビューター**: データベース整合性が保証されていないと、プルリクエスト時にレビューが困難

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-create` 実行時に「Database integrity warnings」エラーが表示されないこと
- [ ] 既存の不整合レコード（orphaned records）が自動的に検出されること
- [ ] 不整合レコードの修復方法がユーザーに明示されること（コマンド案内）

### 機能要件

- [ ] 仕様書作成時にファイル書き込みと DB 挿入をトランザクション的に扱い、エラー時は自動ロールバックされること
- [ ] `/cft:status` コマンド実行時に整合性チェックが自動実行されること
- [ ] `npx tsx .cc-craft-kit/scripts/repair-database.ts` で不整合を自動修復できること
- [ ] 修復スクリプトは以下の処理を実施すること：
  - 不正なメタデータ（日時形式の不一致）の自動修正
  - 孤立した DB レコードの削除
  - ファイルはあるが DB レコードがない場合の自動登録

### 非機能要件

- [ ] ファイル書き込み後に `fsync()` を実行し、OS バッファを強制的にフラッシュすること
- [ ] Claude Code 異常終了時にもデータ損失が発生しないこと
- [ ] E2E テストで 100 回連続実行しても不整合が 0 件であること
- [ ] 整合性チェックの実行時間が 1 秒以内であること（パフォーマンス要件）

---

## 4. 制約条件

### 技術的制約

- データベースは SQLite を使用しており、トランザクション分離レベルは SERIALIZABLE
- Node.js の `fs.writeFileSync()` は OS バッファにデータを書き込むだけで、ディスクへの即時書き込みは保証されない
- Claude Code の異常終了（強制終了、クラッシュ）を完全に防ぐことはできない

### ビジネス制約

- 既存の仕様書ファイル（69 件）に対して後方互換性を保つ必要がある
- 修復スクリプトは手動実行のみ（自動実行すると意図しないデータ削除のリスク）
- 本修正は v0.1.1 リリースに含める必要がある（優先度: High）

---

## 5. 依存関係

### 既存の実装

- `src/core/validators/database-integrity-checker.ts` - 整合性チェックロジック
- `src/core/validators/spec-file-validator.ts` - メタデータパース・検証ロジック
- `src/scripts/repair-database.ts` - 修復スクリプト
- `src/commands/spec/create.ts` - 仕様書作成コマンド（ロールバック処理の実装が必要）

### 関連する仕様書

- 仕様書 ID: `f1341d15-df2f-48c7-8bbd-ec7fa043749f`、タイトル: "定期的にデータベース不整合となる根本原因の追究"、ステータス: completed。本仕様書は上記仕様書の実装結果を受けた追加修正の可能性がある。

### 外部ライブラリ

- Kysely (データベースクエリビルダー)
- Node.js `fs` モジュール（`fsync()` の使用）

---

## 6. 参考情報

### エラーメッセージの詳細

```text
⚠️  Database integrity warnings:
      - Found 1 database record(s) with invalid spec file
```

### 該当コード

- `src/core/validators/database-integrity-checker.ts:233-234` - 警告メッセージ生成箇所
- `src/commands/spec/create.ts` - エラーハンドリング未実装

### 関連ドキュメント

- CLAUDE.md「データベース不整合エラー」セクション
- ARCHITECTURE.md「データベーススキーマ」セクション

### 既知の根本原因

1. **日時形式の不一致**: 仕様書ファイルの日時が `YYYY/MM/DD HH:MM:SS` 形式ではない
2. **ファイル書き込みの未完了**: `fsync()` 未実装により、OS バッファに残ったデータがディスクに書き込まれていない
3. **トランザクション不整合**: 仕様書作成中にエラーが発生し、DB レコードは作成されたがファイルが未作成

### 修復コマンド

```bash
npx tsx .cc-craft-kit/scripts/repair-database.ts
```

---

## 8. 実装タスクリスト

以下のタスクを順次実装して、データベース整合性保証機能を完成させます。

### タスク 1: トランザクション的なエラーハンドリングの実装

- **対象ファイル**: `src/commands/spec/create.ts`
- **内容**: try-catch によるエラーハンドリングを実装し、エラー時に DB レコードとファイルを自動削除
- **依存**: なし

### タスク 2: fsync() ヘルパー関数の実装

- **対象ファイル**: `src/core/utils/file-sync.ts`
- **内容**: ファイルとディレクトリに対して fsync() を実行するヘルパー関数を作成
- **依存**: なし

### タスク 3: 仕様書作成時の fsync() 呼び出し

- **対象ファイル**: `src/commands/spec/create.ts`
- **内容**: ファイル書き込み後に fsync() を呼び出して、OS バッファを強制フラッシュ
- **依存**: タスク 2

### タスク 4: 起動時整合性チェックの自動実行

- **対象ファイル**: `src/commands/status.ts`
- **内容**: `/cft:status` コマンド実行時に整合性チェックを自動実行
- **依存**: なし

### タスク 5: 修復スクリプトの機能強化

- **対象ファイル**: `src/scripts/repair-database.ts`
- **内容**: 孤立レコード削除、自動登録機能を追加
- **依存**: なし

### タスク 6: E2E テストの実装

- **対象ファイル**: `tests/e2e/database-integrity.test.ts`
- **内容**: 100 回連続実行して不整合が 0 件であることを検証
- **依存**: タスク 1〜5

### タスク 7: ドキュメント更新

- **対象ファイル**: `CLAUDE.md`
- **内容**: トラブルシューティングセクションを更新し、修復スクリプトの使い方を明記
- **依存**: タスク 5
