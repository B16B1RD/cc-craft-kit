# Takumi から cc-craft-kit への変更が不十分

**仕様書 ID:** a7a79273-f6a8-431d-bcf7-7690bcaf21cd
**フェーズ:** completed
**作成日時:** 2025/11/18 12:02:25
**更新日時:** 2025/11/18 12:46:11

---

## 1. 背景と目的

### 背景

プロジェクト名を Takumi から cc-craft-kit へ変更したが、コードベース全体で以下の問題が残存しています。

**現在の問題:**

- 仕様書ファイルが `.cc-craft-kit/specs/` に作成される
- データベースファイルが `.cc-craft-kit/cc-craft-kit.db` として参照される
- スラッシュコマンドのガイダンスで `/cft:*` が表示される（正しくは `/cft:*`）
- 46 個の TypeScript ファイルで `takumi` または `.cc-craft-kit` が使用されている
- `src/core/database/connection.ts` で `DEFAULT_DB_PATH = '.cc-craft-kit/cc-craft-kit.db'`
- `src/commands/init.ts` で `.cc-craft-kit/` ディレクトリを作成
- `src/commands/spec/create.ts` で `.cc-craft-kit/specs/` を参照
- `src/commands/status.ts` で `/cft:*` コマンドを案内

### 目的

プロジェクト名の変更を完全に適用し、すべての参照を cc-craft-kit に統一します。

1. `.cc-craft-kit/` → `.cc-craft-kit/` へディレクトリ名変更
2. `cc-craft-kit.db` → `cc-craft-kit.db` へデータベース名変更
3. `/cft:*` → `/cft:*` へスラッシュコマンド名変更（**重要**: プレフィックスは `cft` が正しい）
4. コードベース内の全 `takumi` 参照を `cc-craft-kit` に置換
5. 既存の `.cc-craft-kit/` データを `.cc-craft-kit/` へマイグレーション

---

## 2. 対象ユーザー

- cc-craft-kit を使用するすべての開発者
- プロジェクト名変更によるマイグレーション作業する管理者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `.cc-craft-kit/` ディレクトリが `.cc-craft-kit/` に変更される
- [ ] `cc-craft-kit.db` が `cc-craft-kit.db` に変更される
- [ ] `/cft:*` スラッシュコマンドが `/cft:*` に変更される
- [ ] 仕様書ファイルが `.cc-craft-kit/specs/` に作成される
- [ ] すべての TypeScript ファイルで `takumi` 参照が `cc-craft-kit` に置換される

### 機能要件

- [ ] `src/core/database/connection.ts` の `DEFAULT_DB_PATH` を `.cc-craft-kit/cc-craft-kit.db` に変更
- [ ] `src/commands/init.ts` で `.cc-craft-kit/` ディレクトリを作成
- [ ] `src/commands/spec/create.ts` で `.cc-craft-kit/specs/` を参照
- [ ] `src/commands/status.ts` で `/cft:*` コマンドを案内
- [ ] `src/core/filesystem/watcher.ts` の `ccCraftKitDir` パラメータを `ccCraftKitDir` に変更
- [ ] 既存の `.cc-craft-kit/` データを `.cc-craft-kit/` へマイグレーションするスクリプトを作成
- [ ] マイグレーション後も既存の仕様書、データベースレコードが正常に動作する

### 非機能要件

- [ ] マイグレーションスクリプトは冪等性を保つ（複数回実行しても安全）
- [ ] マイグレーション前に `.cc-craft-kit/` のバックアップを自動作成
- [ ] マイグレーション失敗時のロールバック機能を実装
- [ ] コードの全参照が確実に置換されることを確認するテストを追加

---

## 4. 制約条件

### 既存データの互換性

- `.cc-craft-kit/` ディレクトリを使用している既存プロジェクトとの互換性を保つ
- マイグレーションスクリプト実行前の既存データを破損させない
- データベーススキーマは変更しない（パスのみ変更）

### 後方互換性

- マイグレーション完了後は `.cc-craft-kit/` への参照を完全に削除
- 新規プロジェクト作成時は `.cc-craft-kit/` のみを使用
- 既存のスラッシュコマンドファイル（`.claude/commands/cc-craft-kit/`）との整合性を保つ

---

## 5. 依存関係

### 影響を受けるファイル（46ファイル）

**主要コマンドファイル:**

- `src/commands/init.ts`
- `src/commands/status.ts`
- `src/commands/spec/create.ts`
- `src/commands/spec/get.ts`
- `src/commands/spec/list.ts`
- `src/commands/spec/phase.ts`
- `src/commands/spec/update.ts`
- `src/commands/watch.ts`
- `src/commands/github/init.ts`
- `src/commands/github/sync.ts`
- `src/commands/github/issue-create.ts`
- `src/commands/github/project-add.ts`
- `src/commands/knowledge/record.ts`

**コアモジュール:**

- `src/core/database/connection.ts`
- `src/core/filesystem/watcher.ts`
- `src/core/workflow/github-integration.ts`
- `src/core/workflow/git-integration.ts`

**統合モジュール:**

- `src/integrations/github/sync.ts`
- `src/integrations/github/project-resolver.ts`

**スクリプト:**

- `src/scripts/check-sync.ts`
- `src/scripts/sync-dogfood.ts`
- `src/scripts/migrate-structure.ts`
- `src/scripts/rename-project.ts`

**テストファイル:**

- `tests/**/*.test.ts`（複数のテストファイル）

---

## 6. 参考情報

### 調査結果

**`.cc-craft-kit` を使用しているファイル: 46個**

- TypeScript ソースファイル: 35 個
- テストファイル: 11 個

**主要な変更箇所:**

1. データベースパス: `src/core/database/connection.ts:18`
2. 初期化処理: `src/commands/init.ts:36-82`
3. 仕様書作成: `src/commands/spec/create.ts:91-92`
4. ステータス表示: `src/commands/status.ts:57-188`
5. ファイル監視: `src/core/filesystem/watcher.ts:4,72,92`

### マイグレーション戦略

1. **フェーズ1**: 既存データのバックアップ
2. **フェーズ2**: コードベース内の全参照を置換
3. **フェーズ3**: `.cc-craft-kit/` から `.cc-craft-kit/` へデータコピー
4. **フェーズ4**: 動作確認とテスト実行
5. **フェーズ5**: `.cc-craft-kit/` ディレクトリの削除（任意）

---

## 7. アーキテクチャ設計

### 7.1 影響範囲と変更方針

#### 7.1.1 ディレクトリ構造の変更

**変更前:**

```text
.cc-craft-kit/
├── cc-craft-kit.db
├── specs/
│   └── *.md
└── logs/
```

**変更後:**

```text
.cc-craft-kit/
├── cc-craft-kit.db
├── specs/
│   └── *.md
└── logs/
```

#### 7.1.2 コードベース内の置換対象

**置換パターン:**

| 置換前 | 置換後 | 対象ファイル数 |
|---|---|---|
| `.cc-craft-kit` | `.cc-craft-kit` | 46 |
| `cc-craft-kit.db` | `cc-craft-kit.db` | 3 |
| `/cft:` | `/cft:` | 13 |
| `ccCraftKitDir` | `ccCraftKitDir` | 2 |

### 7.2 マイグレーションスクリプト設計

#### 7.2.1 マイグレーションフロー

```typescript
// src/scripts/migrate-takumi-to-cc-craft-kit.ts

async function migrateProject() {
  // 1. 前提条件チェック
  if (!fs.existsSync('.cc-craft-kit')) {
    console.log('No .cc-craft-kit directory found. Skipping migration.');
    return;
  }

  // 2. バックアップ作成
  await createBackup('.cc-craft-kit', '.cc-craft-kit.backup');

  // 3. 新ディレクトリ作成
  await fs.mkdir('.cc-craft-kit', { recursive: true });

  // 4. ファイルコピー
  await copyDirectory('.cc-craft-kit', '.cc-craft-kit');

  // 5. データベース接続の切り替え
  await updateDatabaseConnection();

  // 6. 検証
  await validateMigration();

  // 7. クリーンアップ（オプション）
  await promptCleanupOldDirectory();
}
```

#### 7.2.2 冪等性の実装

- `.cc-craft-kit/` が既に存在する場合はスキップ
- バックアップが既に存在する場合は上書き確認
- マイグレーション済みフラグファイル `.cc-craft-kit/.migrated` を作成

#### 7.2.3 ロールバック設計

```typescript
async function rollback() {
  // 1. .cc-craft-kit/ を削除
  await fs.rm('.cc-craft-kit', { recursive: true, force: true });

  // 2. .cc-craft-kit.backup/ から復元
  await copyDirectory('.cc-craft-kit.backup', '.cc-craft-kit');

  // 3. データベース接続を元に戻す
  await revertDatabaseConnection();
}
```

### 7.3 コード置換戦略

#### 7.3.1 自動置換スクリプト

```typescript
// src/scripts/replace-takumi-references.ts

const replacements = [
  { from: /\.cc-craft-kit/g, to: '.cc-craft-kit' },
  { from: /takumi\.db/g, to: 'cc-craft-kit.db' },
  { from: /\/cft:/g, to: '/cft:' },
  { from: /ccCraftKitDir/g, to: 'ccCraftKitDir' },
];

async function replaceInFiles(pattern: string) {
  const files = await glob(pattern);
  for (const file of files) {
    let content = await fs.readFile(file, 'utf-8');
    for (const { from, to } of replacements) {
      content = content.replace(from, to);
    }
    await fs.writeFile(file, content, 'utf-8');
  }
}
```

#### 7.3.2 対象ファイルパターン

```typescript
const filePatterns = [
  'src/**/*.ts',
  'tests/**/*.ts',
  '.claude/commands/**/*.md',
  'package.json',
  'README.md',
  'CLAUDE.md',
];
```

### 7.4 テスト設計

#### 7.4.1 マイグレーションテスト

```typescript
describe('Migration from .cc-craft-kit to .cc-craft-kit', () => {
  it('should copy all files from .cc-craft-kit to .cc-craft-kit', async () => {
    // Given: .cc-craft-kit directory with test data
    // When: migration script runs
    // Then: .cc-craft-kit should contain identical files
  });

  it('should update database path to cc-craft-kit.db', async () => {
    // Given: database connection using cc-craft-kit.db
    // When: migration script runs
    // Then: database connection should use cc-craft-kit.db
  });

  it('should be idempotent (safe to run multiple times)', async () => {
    // Given: migration already completed
    // When: migration script runs again
    // Then: no errors, no data loss
  });

  it('should create backup before migration', async () => {
    // Given: .cc-craft-kit directory exists
    // When: migration script runs
    // Then: .cc-craft-kit.backup should be created
  });
});
```

#### 7.4.2 参照置換テスト

```typescript
describe('Replace takumi references', () => {
  it('should replace all .cc-craft-kit references in TypeScript files', async () => {
    const files = await glob('src/**/*.ts');
    for (const file of files) {
      const content = await fs.readFile(file, 'utf-8');
      expect(content).not.toMatch(/\.cc-craft-kit/);
      expect(content).not.toMatch(/takumi\.db/);
    }
  });

  it('should replace all /cft: slash commands', async () => {
    const files = await glob('.claude/commands/**/*.md');
    for (const file of files) {
      const content = await fs.readFile(file, 'utf-8');
      expect(content).not.toMatch(/\/cft:/);
    }
  });
});
```

### 7.5 実装スケジュール

#### フェーズ1: コード置換（2時間）

- `src/scripts/replace-takumi-references.ts` を実装
- 全ファイルの参照を置換
- 置換結果の検証

#### フェーズ2: マイグレーションスクリプト実装（3時間）

- `src/scripts/migrate-takumi-to-cc-craft-kit.ts` を実装
- バックアップ機能を実装
- ロールバック機能を実装

#### フェーズ3: テスト実装（2時間）

- マイグレーションテストを実装
- 参照置換テストを実装
- E2E テストで動作確認

#### フェーズ4: ドキュメント更新（1時間）

- CLAUDE.md の更新
- README.md の更新
- QUICK_START.md の更新

### 7.6 リスク管理

#### 高リスク

- **データ損失**: バックアップ機能の実装で対処
- **データベース破損**: マイグレーション前の検証で対処

#### 中リスク

- **置換ミス**: テストで全参照を検証
- **既存プロジェクトとの非互換**: マイグレーションスクリプトで対処

#### 低リスク

- **スラッシュコマンドの動作不良**: `/cft:*` への置換後にテスト

---

## 8. 実装タスクリスト

### タスク概要

| # | タスク | 工数見積 | 依存関係 | ステータス |
|---|---|---|---|---|
| 1 | コード置換スクリプト実装 | 1.5h | - | 未着手 |
| 2 | データベースパス変更 | 0.5h | - | 未着手 |
| 3 | ファイル監視モジュール変更 | 0.5h | - | 未着手 |
| 4 | init コマンド変更 | 0.5h | タスク1 | 未着手 |
| 5 | spec/create コマンド変更 | 0.5h | タスク1 | 未着手 |
| 6 | status コマンド変更 | 0.5h | タスク1 | 未着手 |
| 7 | マイグレーションスクリプト実装 | 3h | タスク2-6 | 未着手 |
| 8 | テスト実装 | 2h | タスク7 | 未着手 |
| 9 | ドキュメント更新 | 1h | タスク8 | 未着手 |
| 10 | マイグレーション実行と動作確認 | 1h | タスク9 | 未着手 |

**合計工数見積:** 11 時間

### タスク詳細

#### タスク1: コード置換スクリプト実装

**目的:** 全ファイルの `takumi` 参照を `cc-craft-kit` に自動置換

**実装内容:**

- `src/scripts/replace-takumi-references.ts` を作成
- 以下の置換パターンを実装:
  - `.cc-craft-kit` → `.cc-craft-kit`
  - `cc-craft-kit.db` → `cc-craft-kit.db`
  - `/cft:` → `/cft:`
  - `ccCraftKitDir` → `ccCraftKitDir`
- 対象ファイルパターン:
  - `src/**/*.ts`
  - `tests/**/*.ts`
  - `.claude/commands/**/*.md`
  - `package.json`
  - `README.md`
  - `CLAUDE.md`

**検証方法:**

```bash
npm run replace:takumi
grep -r "\.cc-craft-kit" src/
grep -r "takumi\.db" src/
grep -r "/cft:" .claude/
```

#### タスク2: データベースパス変更

**目的:** `src/core/database/connection.ts` の `DEFAULT_DB_PATH` を `.cc-craft-kit/cc-craft-kit.db` に変更

**実装内容:**

- `src/core/database/connection.ts:18` の定数を変更

**検証方法:**

```bash
grep "DEFAULT_DB_PATH" src/core/database/connection.ts
```

#### タスク3: ファイル監視モジュール変更

**目的:** `src/core/filesystem/watcher.ts` の `ccCraftKitDir` パラメータを `ccCraftKitDir` に変更

**実装内容:**

- `src/core/filesystem/watcher.ts` の変数名を変更

**検証方法:**

```bash
grep "ccCraftKitDir" src/core/filesystem/watcher.ts
```

#### タスク4: init コマンド変更

**目的:** `src/commands/init.ts` で `.cc-craft-kit/` ディレクトリを作成

**実装内容:**

- `src/commands/init.ts:36-82` の初期化処理を変更

**検証方法:**

```bash
npx tsx .cc-craft-kit/commands/init.ts "test-project"
ls -la .cc-craft-kit/
```

#### タスク5: spec/create コマンド変更

**目的:** `src/commands/spec/create.ts` で `.cc-craft-kit/specs/` を参照

**実装内容:**

- `src/commands/spec/create.ts:91-92` のパス参照を変更

**検証方法:**

```bash
npx tsx .cc-craft-kit/commands/spec/create.ts "test-spec"
ls -la .cc-craft-kit/specs/
```

#### タスク6: status コマンド変更

**目的:** `src/commands/status.ts` で `/cft:*` コマンドを案内

**実装内容:**

- `src/commands/status.ts:57-188` のメッセージを変更

**検証方法:**

```bash
npx tsx .cc-craft-kit/commands/status.ts
```

#### タスク7: マイグレーションスクリプト実装

**目的:** 既存の `.cc-craft-kit/` データを `.cc-craft-kit/` へ安全にマイグレーション

**実装内容:**

- `src/scripts/migrate-takumi-to-cc-craft-kit.ts` を作成
- バックアップ機能実装
- ファイルコピー機能実装
- データベース接続切り替え
- 検証機能実装
- ロールバック機能実装
- 冪等性の保証

**検証方法:**

```bash
npm run migrate:takumi
ls -la .cc-craft-kit/
ls -la .cc-craft-kit.backup/
```

#### タスク8: テスト実装

**目的:** マイグレーションと参照置換の正確性を検証

**実装内容:**

- マイグレーションテスト実装
- 参照置換テスト実装
- E2E テスト実装

**検証方法:**

```bash
npm test
npm run test:migration
```

#### タスク9: ドキュメント更新

**目的:** ドキュメントを最新の変更に合わせて更新

**実装内容:**

- `CLAUDE.md` の更新
- `README.md` の更新
- `QUICK_START.md` の更新

**検証方法:**

```bash
grep -r "\.cc-craft-kit" CLAUDE.md README.md docs/
grep -r "/cft:" CLAUDE.md README.md docs/
```

#### タスク10: マイグレーション実行と動作確認

**目的:** 実際のマイグレーションを実行し、すべての機能が正常動作することを確認

**実装内容:**

- マイグレーションスクリプトを実行
- すべてのコマンドを実行して動作確認
- データベースレコードの整合性確認
- 仕様書ファイルの整合性確認

**検証方法:**

```bash
npm run migrate:takumi
/cft:status
/cft:spec-list
npx tsx .cc-craft-kit/commands/spec/create.ts "migration-test"
```
