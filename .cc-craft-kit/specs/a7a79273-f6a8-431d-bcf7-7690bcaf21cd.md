# Takumi から cc-craft-kit への変更が不十分

**仕様書 ID:** a7a79273-f6a8-431d-bcf7-7690bcaf21cd
**フェーズ:** tasks
**作成日時:** 2025/11/18 12:02:25
**更新日時:** 2025/11/18 12:34:33

---

## 1. 背景と目的

### 背景

プロジェクト名を Takumi から cc-craft-kit へ変更したが、コードベース全体で以下の問題が残存しています。

**現在の問題:**

- 仕様書ファイルが `.takumi/specs/` に作成される
- データベースファイルが `.takumi/takumi.db` として参照される
- スラッシュコマンドのガイダンスで `/takumi:*` が表示される（正しくは `/cft:*`）
- 46 個の TypeScript ファイルで `takumi` または `.takumi` が使用されている
- `src/core/database/connection.ts` で `DEFAULT_DB_PATH = '.takumi/takumi.db'`
- `src/commands/init.ts` で `.takumi/` ディレクトリを作成
- `src/commands/spec/create.ts` で `.takumi/specs/` を参照
- `src/commands/status.ts` で `/takumi:*` コマンドを案内

### 目的

プロジェクト名の変更を完全に適用し、すべての参照を cc-craft-kit に統一します。

1. `.takumi/` → `.cc-craft-kit/` へディレクトリ名変更
2. `takumi.db` → `cc-craft-kit.db` へデータベース名変更
3. `/takumi:*` → `/cft:*` へスラッシュコマンド名変更（**重要**: プレフィックスは `cft` が正しい）
4. コードベース内の全 `takumi` 参照を `cc-craft-kit` に置換
5. 既存の `.takumi/` データを `.cc-craft-kit/` へマイグレーション

---

## 2. 対象ユーザー

- cc-craft-kit を使用するすべての開発者
- プロジェクト名変更によるマイグレーション作業する管理者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `.takumi/` ディレクトリが `.cc-craft-kit/` に変更される
- [ ] `takumi.db` が `cc-craft-kit.db` に変更される
- [ ] `/takumi:*` スラッシュコマンドが `/cc-craft-kit:*` に変更される
- [ ] 仕様書ファイルが `.cc-craft-kit/specs/` に作成される
- [ ] すべての TypeScript ファイルで `takumi` 参照が `cc-craft-kit` に置換される

### 機能要件

- [ ] `src/core/database/connection.ts` の `DEFAULT_DB_PATH` を `.cc-craft-kit/cc-craft-kit.db` に変更
- [ ] `src/commands/init.ts` で `.cc-craft-kit/` ディレクトリを作成
- [ ] `src/commands/spec/create.ts` で `.cc-craft-kit/specs/` を参照
- [ ] `src/commands/status.ts` で `/cc-craft-kit:*` コマンドを案内
- [ ] `src/core/filesystem/watcher.ts` の `takumiDir` パラメータを `ccCraftKitDir` に変更
- [ ] 既存の `.takumi/` データを `.cc-craft-kit/` へマイグレーションするスクリプトを作成
- [ ] マイグレーション後も既存の仕様書、データベースレコードが正常に動作する

### 非機能要件

- [ ] マイグレーションスクリプトは冪等性を保つ（複数回実行しても安全）
- [ ] マイグレーション前に `.takumi/` のバックアップを自動作成
- [ ] マイグレーション失敗時のロールバック機能を実装
- [ ] コードの全参照が確実に置換されることを確認するテストを追加

---

## 4. 制約条件

### 既存データの互換性

- `.takumi/` ディレクトリを使用している既存プロジェクトとの互換性を保つ
- マイグレーションスクリプト実行前の既存データを破損させない
- データベーススキーマは変更しない（パスのみ変更）

### 後方互換性

- マイグレーション完了後は `.takumi/` への参照を完全に削除
- 新規プロジェクト作成時は `.cc-craft-kit/` のみを使用
- 既存のスラッシュコマンドファイル（`.claude/commands/cc-craft-kit/`）との整合性を保つ

---

## 5. 依存関係

### 影響を受けるファイル（46ファイル）

**主要コマンドファイル:**

- `src/commands/init.ts`
- `src/commands/status.ts`
- `src/commands/spec/create.ts`
- `src/commands/spec/get.ts`
- `src/commands/spec/list.ts`
- `src/commands/spec/phase.ts`
- `src/commands/spec/update.ts`
- `src/commands/watch.ts`
- `src/commands/github/init.ts`
- `src/commands/github/sync.ts`
- `src/commands/github/issue-create.ts`
- `src/commands/github/project-add.ts`
- `src/commands/knowledge/record.ts`

**コアモジュール:**

- `src/core/database/connection.ts`
- `src/core/filesystem/watcher.ts`
- `src/core/workflow/github-integration.ts`
- `src/core/workflow/git-integration.ts`

**統合モジュール:**

- `src/integrations/github/sync.ts`
- `src/integrations/github/project-resolver.ts`

**スクリプト:**

- `src/scripts/check-sync.ts`
- `src/scripts/sync-dogfood.ts`
- `src/scripts/migrate-structure.ts`
- `src/scripts/rename-project.ts`

**テストファイル:**

- `tests/**/*.test.ts`（複数のテストファイル）

---

## 6. 参考情報

### 調査結果

**`.takumi` を使用しているファイル: 46個**

- TypeScript ソースファイル: 35 個
- テストファイル: 11 個

**主要な変更箇所:**

1. データベースパス: `src/core/database/connection.ts:18`
2. 初期化処理: `src/commands/init.ts:36-82`
3. 仕様書作成: `src/commands/spec/create.ts:91-92`
4. ステータス表示: `src/commands/status.ts:57-188`
5. ファイル監視: `src/core/filesystem/watcher.ts:4,72,92`

### マイグレーション戦略

1. **フェーズ1**: 既存データのバックアップ
2. **フェーズ2**: コードベース内の全参照を置換
3. **フェーズ3**: `.takumi/` から `.cc-craft-kit/` へデータコピー
4. **フェーズ4**: 動作確認とテスト実行
5. **フェーズ5**: `.takumi/` ディレクトリの削除（任意）

---

## 7. アーキテクチャ設計

### 7.1 影響範囲と変更方針

#### 7.1.1 ディレクトリ構造の変更

**変更前:**

```text
.takumi/
├── takumi.db
├── specs/
│   └── *.md
└── logs/
```

**変更後:**

```text
.cc-craft-kit/
├── cc-craft-kit.db
├── specs/
│   └── *.md
└── logs/
```

#### 7.1.2 コードベース内の置換対象

**置換パターン:**

| 置換前 | 置換後 | 対象ファイル数 |
|---|---|---|
| `.takumi` | `.cc-craft-kit` | 46 |
| `takumi.db` | `cc-craft-kit.db` | 3 |
| `/takumi:` | `/cft:` | 13 |
| `takumiDir` | `ccCraftKitDir` | 2 |

### 7.2 マイグレーションスクリプト設計

#### 7.2.1 マイグレーションフロー

```typescript
// src/scripts/migrate-takumi-to-cc-craft-kit.ts

async function migrateProject() {
  // 1. 前提条件チェック
  if (!fs.existsSync('.takumi')) {
    console.log('No .takumi directory found. Skipping migration.');
    return;
  }

  // 2. バックアップ作成
  await createBackup('.takumi', '.takumi.backup');

  // 3. 新ディレクトリ作成
  await fs.mkdir('.cc-craft-kit', { recursive: true });

  // 4. ファイルコピー
  await copyDirectory('.takumi', '.cc-craft-kit');

  // 5. データベース接続の切り替え
  await updateDatabaseConnection();

  // 6. 検証
  await validateMigration();

  // 7. クリーンアップ（オプション）
  await promptCleanupOldDirectory();
}
```

#### 7.2.2 冪等性の実装

- `.cc-craft-kit/` が既に存在する場合はスキップ
- バックアップが既に存在する場合は上書き確認
- マイグレーション済みフラグファイル `.cc-craft-kit/.migrated` を作成

#### 7.2.3 ロールバック設計

```typescript
async function rollback() {
  // 1. .cc-craft-kit/ を削除
  await fs.rm('.cc-craft-kit', { recursive: true, force: true });

  // 2. .takumi.backup/ から復元
  await copyDirectory('.takumi.backup', '.takumi');

  // 3. データベース接続を元に戻す
  await revertDatabaseConnection();
}
```

### 7.3 コード置換戦略

#### 7.3.1 自動置換スクリプト

```typescript
// src/scripts/replace-takumi-references.ts

const replacements = [
  { from: /\.takumi/g, to: '.cc-craft-kit' },
  { from: /takumi\.db/g, to: 'cc-craft-kit.db' },
  { from: /\/takumi:/g, to: '/cft:' },
  { from: /takumiDir/g, to: 'ccCraftKitDir' },
];

async function replaceInFiles(pattern: string) {
  const files = await glob(pattern);
  for (const file of files) {
    let content = await fs.readFile(file, 'utf-8');
    for (const { from, to } of replacements) {
      content = content.replace(from, to);
    }
    await fs.writeFile(file, content, 'utf-8');
  }
}
```

#### 7.3.2 対象ファイルパターン

```typescript
const filePatterns = [
  'src/**/*.ts',
  'tests/**/*.ts',
  '.claude/commands/**/*.md',
  'package.json',
  'README.md',
  'CLAUDE.md',
];
```

### 7.4 テスト設計

#### 7.4.1 マイグレーションテスト

```typescript
describe('Migration from .takumi to .cc-craft-kit', () => {
  it('should copy all files from .takumi to .cc-craft-kit', async () => {
    // Given: .takumi directory with test data
    // When: migration script runs
    // Then: .cc-craft-kit should contain identical files
  });

  it('should update database path to cc-craft-kit.db', async () => {
    // Given: database connection using takumi.db
    // When: migration script runs
    // Then: database connection should use cc-craft-kit.db
  });

  it('should be idempotent (safe to run multiple times)', async () => {
    // Given: migration already completed
    // When: migration script runs again
    // Then: no errors, no data loss
  });

  it('should create backup before migration', async () => {
    // Given: .takumi directory exists
    // When: migration script runs
    // Then: .takumi.backup should be created
  });
});
```

#### 7.4.2 参照置換テスト

```typescript
describe('Replace takumi references', () => {
  it('should replace all .takumi references in TypeScript files', async () => {
    const files = await glob('src/**/*.ts');
    for (const file of files) {
      const content = await fs.readFile(file, 'utf-8');
      expect(content).not.toMatch(/\.takumi/);
      expect(content).not.toMatch(/takumi\.db/);
    }
  });

  it('should replace all /takumi: slash commands', async () => {
    const files = await glob('.claude/commands/**/*.md');
    for (const file of files) {
      const content = await fs.readFile(file, 'utf-8');
      expect(content).not.toMatch(/\/takumi:/);
    }
  });
});
```

### 7.5 実装スケジュール

#### フェーズ1: コード置換（2時間）

- `src/scripts/replace-takumi-references.ts` を実装
- 全ファイルの参照を置換
- 置換結果の検証

#### フェーズ2: マイグレーションスクリプト実装（3時間）

- `src/scripts/migrate-takumi-to-cc-craft-kit.ts` を実装
- バックアップ機能を実装
- ロールバック機能を実装

#### フェーズ3: テスト実装（2時間）

- マイグレーションテストを実装
- 参照置換テストを実装
- E2E テストで動作確認

#### フェーズ4: ドキュメント更新（1時間）

- CLAUDE.md の更新
- README.md の更新
- QUICK_START.md の更新

### 7.6 リスク管理

#### 高リスク

- **データ損失**: バックアップ機能の実装で対処
- **データベース破損**: マイグレーション前の検証で対処

#### 中リスク

- **置換ミス**: テストで全参照を検証
- **既存プロジェクトとの非互換**: マイグレーションスクリプトで対処

#### 低リスク

- **スラッシュコマンドの動作不良**: `/cft:*` への置換後にテスト
