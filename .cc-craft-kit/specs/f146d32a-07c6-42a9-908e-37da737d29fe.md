# /cft:spec-update で要求仕様書のアップデートをしても Issu のテンプレート本文が更新されない

**仕様書 ID:** f146d32a-07c6-42a9-908e-37da737d29fe
**フェーズ:** completed
**作成日時:** 2025/11/17 15:04:33
**更新日時:** 2025/11/17 15:22:19

---

## 1. 背景と目的

### 背景

現在、`/cft:spec-update` コマンドを実行すると、以下の処理が行われます:

1. データベースの `updated_at` を更新
2. `spec.updated` イベントを発火
3. GitHub Issue にコメントを追加（「仕様書が更新されました」という通知のみ）

しかし、**GitHub Issue の本文（body）は更新されません**。これは、`.cc-craft-kit/core/workflow/github-integration.ts:498` で以下のように設計されているためです:

```typescript
// 仕様書更新をコメントで記録（本文は更新しない）
```

この設計により、仕様書ファイル（`.cc-craft-kit/specs/<spec-id>.md`）を編集しても、対応する GitHub Issue の本文が古いままになり、Issue を見ただけでは最新の仕様書内容が分からない問題が発生しています。

例えば、`spec.created` 時には要件定義テンプレートが Issue 本文に設定されますが、その後ユーザーが要件定義を記述しても、Issue 本文は初期テンプレートのままです。

### 目的

`/cft:spec-update` コマンド実行時に、GitHub Issue の本文を仕様書ファイルの最新内容で更新し、Issue を見るだけで常に最新の仕様書を確認できるようにする。また、何を修正したかをコメントで記録し、変更履歴を追跡可能にする。

---

## 2. 対象ユーザー

- **cc-craft-kit 利用者**: 仕様書を頻繁に更新し、GitHub Issue で進捗を管理している開発者
- **レビュアー**: GitHub Issue 経由で仕様書の最新状態を確認したい関係者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-update <spec-id>` 実行時に、GitHub Issue の本文が仕様書ファイル（`.cc-craft-kit/specs/<spec-id>.md`）の最新内容で上書き更新される
- [ ] 更新通知コメントに「何を修正したか」の情報を含める（変更履歴の記録）
- [ ] 仕様書ファイルが存在しない場合は、エラーメッセージを表示して処理を中断する

### 機能要件

- [ ] `spec.updated` イベントハンドラー内で、以下の処理を実行する:
  1. 仕様書ファイル（`.cc-craft-kit/specs/<spec-id>.md`）を読み込む
  2. `issues.update()` を呼び出して Issue 本文を更新
  3. 更新通知コメントを追加（変更内容のサマリーを含む）
- [ ] 更新される本文は、仕様書ファイル全体の内容とする
- [ ] 更新通知コメントには以下を含める:
  - 更新日時
  - 仕様書ファイルへのリンク
  - （可能であれば）変更内容の要約や差分情報

### 非機能要件

- [ ] GitHub API のレート制限を考慮し、1 回の `/cft:spec-update` で API 呼び出しは最小限にする（Issue 更新 1 回 + コメント追加 1 回）
- [ ] 既存の他のイベントハンドラー（`spec.phase_changed`, `knowledge.*` など）には影響を与えない
- [ ] ユニットテストを追加し、Issue 本文更新のロジックをカバーする

---

## 4. 制約条件

- GitHub API の `PATCH /repos/{owner}/{repo}/issues/{issue_number}` を使用して本文を更新する
- 本文更新は Issue がクローズされていても可能（GitHub の仕様）
- 仕様書ファイルのサイズが GitHub Issue の本文上限（65536 文字）を超える場合の対処が必要

---

## 5. 依存関係

- **既存コンポーネント**:
  - `.cc-craft-kit/core/workflow/github-integration.ts` - `spec.updated` イベントハンドラー
  - `.cc-craft-kit/integrations/github/issues.ts` - `GitHubIssues.update()` メソッド
  - `.cc-craft-kit/commands/spec/update.ts` - `/cft:spec-update` コマンド実装

- **関連仕様**:
  - GitHub Issue 自動作成機能（`spec.created` イベント）
  - フェーズ移行時の Issue 更新機能（`spec.phase_changed` イベント）

---

## 6. 参考情報

### 関連ファイル

- `.cc-craft-kit/core/workflow/github-integration.ts:469-520` - `spec.updated` イベントハンドラー
- `.cc-craft-kit/integrations/github/issues.ts` - GitHub Issues API ラッパー
- `.cc-craft-kit/commands/spec/update.ts` - `/cft:spec-update` コマンド

### GitHub API ドキュメント

- [Update an issue - GitHub REST API](https://docs.github.com/en/rest/issues/issues?apiVersion=2022-11-28#update-an-issue)

### 現在の動作

1. `/cft:spec-update <spec-id>` 実行
2. データベースの `updated_at` 更新
3. `spec.updated` イベント発火
4. GitHub Issue にコメント追加（本文は**更新されない**）

### 期待される動作

1. `/cft:spec-update <spec-id>` 実行
2. データベースの `updated_at` 更新
3. `spec.updated` イベント発火
4. **GitHub Issue の本文を仕様書ファイルの最新内容で上書き更新**（古い本文は削除される）
5. GitHub Issue にコメント追加（更新日時、仕様書へのリンク、変更内容のサマリーを含む）
