---
id: "9712573a-3782-440f-b72a-d084241b7019"
name: "テスト設計の全面的な見直し"
phase: "completed"
branch_name: "main"
github_issue_number: null
pr_url: null
created_at: "2025-11-19T15:27:04Z"
updated_at: "2025-11-19T22:45:00Z"
---

# テスト設計の全面的な見直し


## 1. 背景と目的

### 背景

**関連仕様書**: [c9d9d620-4e73-4fd8-9422-b48ba49e3abd](https://github.com/B16B1RD/cc-craft-kit/issues/137) - テストスイートで失敗するものがある（一時的に無効にされているかも）

前回の仕様書（c9d9d620）の実装過程で、以下の問題が明らかになりました：

**Phase 3（ワークフロー・ファイルシステムテスト）の修正困難な理由:**
1. **Jest モックシステムの制約**: クラスインスタンス化のモック化が複雑で、ホイスティング問題により正しく動作しない
2. **環境依存性**: chokidar などのファイルシステム監視ライブラリが Jest 環境で正しく動作しない
3. **統合テストの複雑さ**: 複数コンポーネントの統合が必要で、テスト環境構築が困難

**Phase 4（E2E・スクリプトテスト）の修正困難な理由:**
1. **統合環境構築の複雑さ**: Docker などの環境が必要で、Jest 単体では対応困難
2. **スクリプトテストの特性**: 実際のファイルシステムとの統合が必要

これらの問題は、**テスト設計の根本的な見直し**が必要であることを示しています。

### 目的

cc-craft-kit プロジェクトのテスト設計を全面的に見直し、以下を実現する：

1. **モック化が容易なアーキテクチャ**: 依存性注入パターンの導入により、Jest でのモック化を簡易化
2. **環境依存性の排除**: テストが Jest 環境で確実に動作する設計
3. **テストレベルの明確化**: 単体テスト、統合テスト、E2E テストの境界を明確にし、適切な環境で実行
4. **テストカバレッジの向上**: 現在 8.88% のカバレッジを 70% 以上に引き上げ
---

## 2. 対象ユーザー

- cc-craft-kit 開発チームメンバー全員
- テストコードを書く開発者
- CI/CD パイプラインを管理する DevOps エンジニア
- コードレビュアー
---

## 3. 受け入れ基準

### 必須要件

- [ ] 依存性注入パターンが主要なクラス（`GitHubClient`, `GitHubIssues`, `GitHubProjects`, `SpecFileWatcher`）に導入されている
- [ ] すべての単体テストが Jest 環境で確実に動作する（環境依存性なし）
- [ ] 統合テストと E2E テストが明確に分離され、適切な環境（Docker など）で実行される
- [ ] テストカバレッジが 70% 以上である

### 機能要件

- [ ] `GitHubClient` などの GitHub API クライアントが、コンストラクタ注入でモック化可能
- [ ] `SpecFileWatcher` などのファイルシステム依存コンポーネントが、インターフェースを介してモック化可能
- [ ] EventBus のイベント発火が、テスト環境で正しく検証可能
- [ ] テストヘルパー関数（モックファクトリー、フィクスチャ）が整備されている

### 非機能要件

- [ ] テストの実行時間が 3 分以内である（現在: 1.5 秒、目標達成済み）
- [ ] テストの Flaky（不安定）が 0 件である（現在: 0 件、目標達成済み）
- [ ] テストコードの可読性が高く、新規メンバーでも理解しやすい
- [ ] CI/CD パイプラインで全テストが自動実行される
---

## 4. 制約条件

- 既存のテストコード（13 test suites, 147 tests）は可能な限り維持する
- 既存の実装コードの大幅な書き換えは避け、インターフェース追加など最小限の変更で対応
- GitHub Actions の無料枠制限（月 2,000 分）を考慮し、テスト実行時間を最適化する
- TypeScript の strict モードを維持する
---

## 5. 依存関係

### 関連仕様書
- [c9d9d620-4e73-4fd8-9422-b48ba49e3abd](https://github.com/B16B1RD/cc-craft-kit/issues/137) - テストスイートで失敗するものがある

### テストフレームワーク
- Jest (v29.x) - 単体テスト・統合テスト
- Testcontainers (検討中) - E2E テスト用の Docker 環境構築

### アーキテクチャパターン
- 依存性注入（DI）- TSyringe は既に導入済み、テストでの活用を拡大
- Repository パターン - データベースアクセスの抽象化
- Strategy パターン - ファイルシステム監視などの環境依存処理の抽象化
---

## 6. 参考情報

- [Jest 公式ドキュメント - Mocking](https://jestjs.io/docs/mock-functions)
- [Testing Library - Testing Philosophy](https://testing-library.com/docs/guiding-principles/)
- [TSyringe 公式ドキュメント](https://github.com/microsoft/tsyringe)
- [Testcontainers 公式ドキュメント](https://testcontainers.com/)
- [前回の実装進捗](https://github.com/B16B1RD/cc-craft-kit/issues/137#issuecomment-latest)
---

## 8. 実装タスクリスト

### Phase 1: 依存性注入パターンの導入

- [ ] **タスク 1.1**: GitHubClient への依存性注入パターン導入
  - 対象ファイル: `src/integrations/github/client.ts`
  - 内容: コンストラクタ注入でモック化可能な設計に変更

- [ ] **タスク 1.2**: GitHubIssues への依存性注入パターン導入
  - 対象ファイル: `src/integrations/github/issues.ts`
  - 内容: コンストラクタ注入でモック化可能な設計に変更

- [ ] **タスク 1.3**: GitHubProjects への依存性注入パターン導入
  - 対象ファイル: `src/integrations/github/projects.ts`
  - 内容: コンストラクタ注入でモック化可能な設計に変更

- [ ] **タスク 1.4**: SpecFileWatcher への依存性注入パターン導入
  - 対象ファイル: `src/core/workflow/spec-file-watcher.ts`
  - 内容: インターフェースを介したモック化可能な設計に変更

### Phase 2: テストインフラの整備

- [ ] **タスク 2.1**: ファイルシステム依存コンポーネントのインターフェース設計
  - 対象ファイル: `src/core/interfaces/file-system.ts`（新規作成）
  - 内容: ファイルシステム操作を抽象化するインターフェースを定義

- [ ] **タスク 2.2**: EventBus のモック化可能な設計実装
  - 対象ファイル: `src/core/workflow/event-bus.ts`
  - 内容: テスト環境でのモック化を容易にする設計変更

- [ ] **タスク 2.3**: テストヘルパー関数（モックファクトリー）実装
  - 対象ファイル: `tests/helpers/mocks.ts`（新規作成）
  - 内容: GitHubClient, EventBus などのモックファクトリーを実装

- [ ] **タスク 2.4**: テストヘルパー関数（フィクスチャ）実装
  - 対象ファイル: `tests/helpers/fixtures.ts`（新規作成）
  - 内容: テストデータのフィクスチャを実装

### Phase 3: テストの修正と分離

- [ ] **タスク 3.1**: 既存の単体テストを Jest 環境で動作するように修正
  - 対象ファイル: `tests/**/*.test.ts`
  - 内容: 環境依存性を排除し、モックファクトリーを活用

- [ ] **タスク 3.2**: 統合テストを分離して適切な環境で実行できるようにする
  - 対象ディレクトリ: `tests/integration/`（新規作成）
  - 内容: 統合テストを分離し、必要に応じて Docker 環境で実行

- [ ] **タスク 3.3**: E2E テストを分離して適切な環境で実行できるようにする
  - 対象ディレクトリ: `tests/e2e/`（新規作成）
  - 内容: E2E テストを分離し、Testcontainers などで環境構築

### Phase 4: カバレッジ向上と CI/CD 統合

- [ ] **タスク 4.1**: テストカバレッジを測定して 70% 以上を達成する
  - コマンド: `npm run test:coverage`
  - 内容: カバレッジレポートを確認し、不足している箇所のテストを追加

- [ ] **タスク 4.2**: CI/CD パイプラインでの自動テスト実行を確認する
  - 対象ファイル: `.github/workflows/test.yml`
  - 内容: GitHub Actions でテストが自動実行されることを確認
