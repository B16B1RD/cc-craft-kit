# /cft:spec-phase コマンドの引数に GitHub Issue の指定も可とする

**仕様書 ID:** ca338052-941d-4a47-81da-f757558d629c
**フェーズ:** implementation
**作成日時:** 2025/11/28 17:30:00
**更新日時:** 2025/11/28 18:00:00

---

## 1. 背景と目的

### 背景

現在の `/cft:spec-phase` コマンドは、仕様書 ID（UUID の先頭 8 文字以上）のみを引数として受け付ける。しかし、GitHub Issue と連携した開発フローでは、Issue 番号（例: #42）の方が直感的に参照しやすいケースが多い。特に GitHub の Issue 一覧や通知から作業を開始する場合、Issue 番号から仕様書を特定してフェーズを変更したいニーズがある。

### 目的

`/cft:spec-phase` コマンドの第一引数に GitHub Issue 番号（`#123` または `123` 形式）を指定可能にし、仕様書 ID と GitHub Issue 番号のどちらでもフェーズ変更操作を行えるようにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者。特に GitHub Issue と仕様書を連携させて開発フローを管理しているユーザー。

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-phase #42 design` 形式で GitHub Issue 番号を指定してフェーズ変更ができること
- [ ] `/cft:spec-phase 42 design` 形式（# なし）でも GitHub Issue 番号として認識されること
- [ ] 既存の仕様書 ID 指定（`/cft:spec-phase f6621295 design`）は引き続き動作すること

### 機能要件

- [ ] GitHub Issue 番号と仕様書 ID の引数パターンを自動判別すること
- [ ] 指定された GitHub Issue 番号に紐付く仕様書が存在しない場合、適切なエラーメッセージを表示すること
- [ ] 同一 GitHub Issue に複数の仕様書が紐付いている場合のエラーハンドリングがあること

### 非機能要件

- [ ] GitHub Issue 番号からの仕様書検索は既存のインデックスを活用し、高速に動作すること
- [ ] 後方互換性を維持し、既存のスクリプトやワークフローに影響を与えないこと

---

## 4. 制約条件

- `github_sync` テーブルの既存構造を活用する（新規テーブル作成は不要）
- `github_sync.issue_number` または `github_sync.github_number` フィールドに index があり、高速検索が可能
- GitHub API 呼び出しは不要（ローカル DB のみで完結）

---

## 5. 依存関係

- `src/commands/spec/resolve-id.ts`: 仕様書 ID 解決ロジックの拡張が必要
- `src/commands/utils/validation.ts`: GitHub Issue 番号の検証関数追加
- `.cc-craft-kit/slash-commands/spec-phase.md`: コマンド仕様書の更新
- `github_sync` テーブル: 仕様書と GitHub Issue の関連付けデータ

---

## 6. 参考情報

- 現在の引数仕様: `argument-hint: "<spec-id> <phase>"`
- 拡張後の引数仕様案: `argument-hint: "<spec-id|#issue-number> <phase>"`
- 関連テーブル: `specs`, `github_sync`

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
┌─────────────────────────────────────────────────────────────┐
│                   /cft:spec-phase コマンド                   │
│                  (spec-phase.md プロンプト)                  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│               resolve-id.ts (入力解決スクリプト)              │
│                                                             │
│  ┌─────────────────┐    ┌─────────────────────────────────┐ │
│  │ 入力形式判定    │───▶│ 仕様書 ID / GitHub Issue 分岐   │ │
│  │ (validation.ts) │    └─────────────────────────────────┘ │
│  └─────────────────┘               │                        │
│                        ┌───────────┴───────────┐            │
│                        ▼                       ▼            │
│              ┌─────────────────┐    ┌─────────────────────┐ │
│              │ 仕様書 ID 検索  │    │ GitHub Issue 検索   │ │
│              │ (既存ロジック)  │    │ (新規ロジック)      │ │
│              └─────────────────┘    └─────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      SQLite データベース                     │
│  ┌─────────────┐         ┌──────────────────────────────┐  │
│  │   specs     │◀────────│       github_sync            │  │
│  │             │ JOIN    │  (entity_type = 'spec')      │  │
│  │  - id       │         │  - entity_id → specs.id      │  │
│  │  - name     │         │  - github_number (検索対象)  │  │
│  │  - phase    │         └──────────────────────────────┘  │
│  └─────────────┘                                           │
└─────────────────────────────────────────────────────────────┘
```

#### 設計方針

1. **プロンプトファースト原則に準拠**: コマンド仕様書（spec-phase.md）はそのまま維持し、DB 検索ロジックのみをスクリプトで拡張
2. **既存インターフェース互換**: `resolve-id.ts` の出力形式は変更せず、入力判定ロジックを追加
3. **単一責任の原則**: 入力形式の判定は `validation.ts` に集約

#### 処理フロー詳細

```
入力: "$1" (例: "#42", "42", "f6621295")
        │
        ▼
┌───────────────────────────────────────┐
│ Step 1: 入力形式の判定               │
│                                       │
│ isGitHubIssueNumber(input)?          │
│   - "#" で始まる + 数値              │
│   - 数値のみ（1-5桁程度）            │
│                                       │
│ isSpecId(input)?                     │
│   - 8文字以上                        │
│   - UUID パターン（英小文字+数字+"-"）│
└───────────────────────────────────────┘
        │
        ├─── GitHub Issue 番号 ───┐
        │                         ▼
        │         ┌───────────────────────────────┐
        │         │ Step 2a: Issue 番号から検索   │
        │         │                               │
        │         │ SELECT specs.*                │
        │         │ FROM specs                    │
        │         │ JOIN github_sync              │
        │         │ WHERE github_number = ?       │
        │         │   AND entity_type = 'spec'    │
        │         └───────────────────────────────┘
        │
        └─── 仕様書 ID ───────────┐
                                  ▼
                  ┌───────────────────────────────┐
                  │ Step 2b: ID 前方一致検索      │
                  │                               │
                  │ SELECT specs.*                │
                  │ FROM specs                    │
                  │ WHERE id LIKE '${specId}%'    │
                  │（既存ロジック）               │
                  └───────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────┐
│ Step 3: 結果を JSON 出力              │
│                                       │
│ { success: true, spec: { ... } }      │
└───────────────────────────────────────┘
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/commands/utils/validation.ts` | GitHub Issue 番号検証関数の追加（`isGitHubIssueNumber`, `parseGitHubIssueNumber`） |
| `src/commands/spec/resolve-id.ts` | 入力形式の自動判別、GitHub Issue 番号からの仕様書検索ロジック追加 |
| `tests/commands/spec/resolve-id.test.ts` | GitHub Issue 番号による解決のテストケース追加 |

#### 追加関数の詳細

**validation.ts に追加:**

```typescript
// GitHub Issue 番号形式の判定（#42 または 42）
export function isGitHubIssueNumber(input: string): boolean {
  const stripped = input.startsWith('#') ? input.slice(1) : input;
  // 1-6桁の数値（GitHub Issue 番号として妥当な範囲）
  return /^\d{1,6}$/.test(stripped);
}

// GitHub Issue 番号のパース
export function parseGitHubIssueNumber(input: string): number {
  const stripped = input.startsWith('#') ? input.slice(1) : input;
  const num = parseInt(stripped, 10);
  if (isNaN(num) || num < 1) {
    throw new Error(`Invalid GitHub Issue number: ${input}`);
  }
  return num;
}

// 仕様書 ID 形式の判定（8文字以上、UUID パターン）
export function isSpecId(input: string): boolean {
  return input.length >= 8 && /^[a-f0-9\-]{8,}$/i.test(input);
}
```

**resolve-id.ts の変更:**

```typescript
// メイン関数の拡張
export async function resolveSpecId(input: string): Promise<ResolveIdOutput> {
  // 入力形式の判定
  if (isGitHubIssueNumber(input)) {
    const issueNumber = parseGitHubIssueNumber(input);
    return await resolveSpecByIssueNumber(issueNumber);
  } else if (isSpecId(input)) {
    return await resolveSpecById(input);  // 既存ロジック
  } else {
    return {
      success: false,
      error: `Invalid input format: "${input}". Expected spec ID (8+ chars) or GitHub Issue number (#123 or 123).`
    };
  }
}

// 新規関数: GitHub Issue 番号から仕様書を解決
async function resolveSpecByIssueNumber(issueNumber: number): Promise<ResolveIdOutput> {
  const db = getDatabase();

  const result = await db
    .selectFrom('specs')
    .leftJoin('github_sync', (join) =>
      join
        .onRef('github_sync.entity_id', '=', 'specs.id')
        .on('github_sync.entity_type', '=', 'spec')
    )
    .selectAll('specs')
    .select('github_sync.github_number as github_issue_number')
    .where('github_sync.github_number', '=', issueNumber)
    .executeTakeFirst();

  if (!result) {
    return {
      success: false,
      error: `No spec found for GitHub Issue #${issueNumber}`
    };
  }

  return {
    success: true,
    spec: {
      id: result.id,
      name: result.name,
      phase: result.phase,
      branch_name: result.branch_name,
      spec_path: `.../${result.id}.md`,
      github_issue_number: result.github_issue_number
    }
  };
}
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| 入力形式判定 | なし（仕様書 ID 固定） | `isGitHubIssueNumber()` + `isSpecId()` で自動判別 | `validation.ts` |
| 仕様書 ID 検索 | `WHERE id LIKE '${specId}%'` | そのまま維持 | `resolve-id.ts` |
| Issue 番号検索 | なし | `WHERE github_number = ?` JOIN 検索 | `resolve-id.ts` |
| エラーメッセージ | 仕様書 ID 形式のみ対応 | 両形式に対応したエラーメッセージ | `resolve-id.ts` |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| `isGitHubIssueNumber()` | `#42`, `42`, `123456` が true、`f6621295` が false | 単体テスト |
| `parseGitHubIssueNumber()` | `#42` → 42、`0` や `-1` でエラー | 単体テスト |
| `isSpecId()` | `f6621295` が true、`42` が false | 単体テスト |
| `resolveSpecByIssueNumber()` | DB に登録済みの Issue 番号で仕様書取得 | 統合テスト（モック DB） |
| 後方互換性 | 既存の仕様書 ID 指定が動作すること | 回帰テスト |

### 7.5 移行計画

#### Phase 1: 検証関数の追加

1. `src/commands/utils/validation.ts` に以下を追加:
   - `isGitHubIssueNumber()`
   - `parseGitHubIssueNumber()`
   - `isSpecId()`
2. 単体テストを追加

#### Phase 2: 解決ロジックの拡張

1. `src/commands/spec/resolve-id.ts` を修正:
   - 入力形式の自動判別ロジック
   - `resolveSpecByIssueNumber()` 関数追加
2. 統合テストを追加

#### Phase 3: 動作確認・ドッグフーディング

1. `npm run sync:dogfood` で同期
2. `/cft:spec-phase #XX design` で動作確認

---

## 8. 実装タスクリスト

### Phase 1: 検証関数の追加

- [x] `validation.ts` に `isGitHubIssueNumber()` 関数を追加
- [x] `validation.ts` に `parseGitHubIssueNumber()` 関数を追加
- [x] `validation.ts` に `isSpecId()` 関数を追加
- [x] 検証関数の単体テストを追加

### Phase 2: 解決ロジックの拡張

- [x] `resolve-id.ts` に入力形式の自動判別ロジックを追加
- [x] `resolve-id.ts` に `resolveSpecByIssueNumber()` 関数を追加
- [x] GitHub Issue 番号による解決の統合テストを追加

### Phase 3: 動作確認

- [x] `npm run sync:dogfood` で同期
- [x] 型チェック・リント実行
- [x] 手動での動作確認（`/cft:spec-phase #XX design`）
