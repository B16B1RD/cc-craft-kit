# フェーズ変更時のGitHub Issue自動更新

**仕様書 ID:** dcbb128c-c205-4c86-80e6-3fa8b89a9b6b
**フェーズ:** completed
**作成日時:** 2025/11/16 16:13:22
**更新日時:** 2025/11/17 1:33:28

---

## 1. 背景と目的

### 背景

現在の実装では、`/cft:spec-phase` コマンドでフェーズを変更した際に、以下の問題が発生しています：

1. **イベントは発火されるが、ハンドラーが未登録**
   - `.cc-craft-kit/commands/spec/phase.ts` で `spec.phase_changed` イベントが発火される（87-94 行目）
   - しかし `registerGitHubIntegrationHandlers()` が呼ばれていないため、ハンドラーが実行されない
   - 結果として GitHub Issue のラベルや Project ステータスが更新されない

2. **実装は存在するが機能していない**
   - `src/core/workflow/github-integration.ts` (177-248 行目) にハンドラー実装は存在
   - テストでは正しく動作する（ハンドラーを明示的に登録しているため）
   - 実際のコマンド実行時には動作しない

### 目的

フェーズ変更時に GitHub Issue と Projects v2 を自動的に更新し、開発ワークフローとプロジェクト管理ツールを同期させる。

具体的には：

- Issue ラベルを `phase:requirements` → `phase:design` のように自動更新
- Projects v2 のステータスを自動更新（requirements → Todo、design → In Progress など）
- フェーズ変更履歴を Issue コメントとして記録（オプション）

---

## 2. 対象ユーザー

- **Takumi を使用するすべての開発者**
  - GitHub Projects v2 でタスク管理をしている開発者
  - チームでの開発状況の可視化が必要な開発者
  - フェーズ移行時に手動で Issue を更新する手間を省きたい開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-phase` コマンド実行時に GitHub Issue のラベルが自動更新される
- [ ] フェーズ変更時に GitHub Projects v2 のステータスが自動更新される
- [ ] GitHub 統合が未設定の場合はエラーにならず、スキップされる
- [ ] GitHub API エラー時は警告を表示するが、コマンド自体は成功する

### 機能要件

- [ ] イベントバス初期化時に GitHub ハンドラーを自動登録する仕組みを実装
- [ ] `getEventBus()` が呼ばれた際に、必要なハンドラーが登録済みであること
- [ ] 既存のハンドラー実装（`registerGitHubIntegrationHandlers`）を再利用
- [ ] フェーズとプロジェクトステータスのマッピングが正しく動作すること

### 非機能要件

- [ ] ハンドラー登録処理は 100ms 以内に完了すること
- [ ] 既存のコマンド実行パフォーマンスに影響を与えないこと
- [ ] テストコードは引き続き正常に動作すること

---

## 4. 制約条件

### 技術的制約

- **EventBus のシングルトンパターン**: `getEventBus()` は既存のシングルトン実装を維持する
- **遅延初期化**: ハンドラー登録は最初の `getEventBus()` 呼び出し時に自動実行
- **依存性注入**: データベースインスタンスが必要なため、`getDatabase()` との連携が必要
- **既存テストとの互換性**: テストでの明示的なハンドラー登録方法を壊さない

### 環境制約

- **GITHUB_TOKEN が未設定の場合**: ハンドラーは登録されるが、実行時にスキップされる
- **GitHub 設定（config.json）が未設定の場合**: 同様にスキップ
- **ネットワークエラー**: Issue 更新失敗時は警告のみで処理を継続

---

## 5. 依存関係

### 既存モジュール

- `.cc-craft-kit/core/workflow/event-bus.ts` - イベントバスのコア実装
- `.cc-craft-kit/core/workflow/github-integration.ts` - GitHub ハンドラー実装（src/ からコピー済み）
- `.cc-craft-kit/core/database/connection.ts` - データベース接続
- `.cc-craft-kit/integrations/github/*` - GitHub API クライアント（src/ からコピー済み）

### 影響を受けるコマンド

- `/cft:spec-create` - Issue 自動作成（既に動作中）
- `/cft:spec-phase` - Issue ラベル更新（**現在動作していない**）

---

## 6. 参考情報

### コード参照

- **イベント発火箇所**: `.cc-craft-kit/commands/spec/phase.ts:87-94`
- **ハンドラー実装**: `src/core/workflow/github-integration.ts:177-248`
- **EventBus 実装**: `.cc-craft-kit/core/workflow/event-bus.ts:123-128`

### GitHub API ドキュメント

- [GitHub REST API - Issues](https://docs.github.com/en/rest/issues/issues)
- [GitHub GraphQL API - Projects V2](https://docs.github.com/en/graphql/reference/mutations#updateprojectv2itemfieldvalue)

### 関連 Issue

- GitHub Issue #5: 本仕様書の追跡 Issue

---

## 7. 設計

### 7.1 アーキテクチャ概要

現在の問題は、EventBus のシングルトンインスタンスに対して GitHub ハンドラーが登録されていないことです。以下のアプローチで解決します：

```
┌─────────────────────────────────────────────────┐
│  Commands (.cc-craft-kit/commands/)                   │
│  - spec/create.ts                               │
│  - spec/phase.ts                                │
└──────────────┬──────────────────────────────────┘
               │ getEventBus()
               ▼
┌─────────────────────────────────────────────────┐
│  EventBus Singleton (.cc-craft-kit/core/workflow/)    │
│  - 初回呼び出し時にハンドラー自動登録           │
│  - registerGitHubIntegrationHandlers() 呼び出し │
└──────────────┬──────────────────────────────────┘
               │ emit('spec.phase_changed', ...)
               ▼
┌─────────────────────────────────────────────────┐
│  GitHub Integration Handlers                    │
│  - spec.created → Issue 作成                    │
│  - spec.phase_changed → Issue/Project 更新      │
└─────────────────────────────────────────────────┘
```

### 7.2 実装方針

#### 方針 A: EventBus 初期化時の自動ハンドラー登録（推奨）

**利点:**
- コマンド側の変更が不要
- 一度だけの登録で全コマンドで有効
- テストコードとの互換性を保てる

**実装:**

```typescript
// .cc-craft-kit/core/workflow/event-bus.ts

let eventBusInstance: EventBus | null = null;
let handlersRegistered = false;

export function getEventBus(): EventBus {
  if (!eventBusInstance) {
    eventBusInstance = new EventBus();
  }

  // 初回のみハンドラー登録
  if (!handlersRegistered) {
    try {
      const db = getDatabase();
      registerGitHubIntegrationHandlers(eventBusInstance, db);
      handlersRegistered = true;
    } catch (error) {
      // データベース未初期化などのエラーはスキップ
      console.warn('Failed to register GitHub handlers:', error);
    }
  }

  return eventBusInstance;
}
```

#### 方針 B: 各コマンドでの明示的登録

**欠点:**
- 各コマンドファイルに登録コードが必要
- 重複コードが増える
- 登録し忘れのリスク

**非推奨のため実装詳細は省略**

### 7.3 データフロー

```
1. ユーザーが /cft:spec-phase dcbb128c design を実行
   ↓
2. .cc-craft-kit/commands/spec/phase.ts が実行
   ↓
3. getEventBus() 呼び出し
   ↓
4. [初回のみ] registerGitHubIntegrationHandlers() 自動実行
   ↓
5. データベース更新（phase を design に変更）
   ↓
6. eventBus.emit('spec.phase_changed', { oldPhase, newPhase })
   ↓
7. GitHub ハンドラーが起動
   ↓
8. GitHub API 呼び出し
   - Issue ラベルを phase:design に更新
   - Project ステータスを "In Progress" に更新
   ↓
9. コンソールに成功メッセージ表示
```

### 7.4 エラーハンドリング

#### ハンドラー登録時のエラー

- **データベース未初期化**: 警告を表示してスキップ（プロジェクト未初期化の場合）
- **モジュールロードエラー**: 警告を表示してスキップ

#### GitHub API 呼び出し時のエラー

- **GITHUB_TOKEN 未設定**: サイレントにスキップ（エラーにしない）
- **GitHub 設定未完了**: サイレントにスキップ
- **ネットワークエラー**: 警告を表示、コマンド自体は成功
- **API レート制限**: 警告を表示、リトライは行わない

### 7.5 テストとの互換性

既存のテストコードは以下のパターンを使用：

```typescript
const eventBus = new EventBus();
const db = getTestDatabase();
registerGitHubIntegrationHandlers(eventBus, db);
```

新しい実装では `getEventBus()` が自動登録を行うため：

```typescript
// テストでは既存の方法を維持（明示的登録）
const eventBus = new EventBus();
registerGitHubIntegrationHandlers(eventBus, db);

// または新しい方法（自動登録）
const eventBus = getEventBus(); // 自動的にハンドラー登録される
```

両方のパターンをサポートするため、重複登録のチェックが必要です。

### 7.6 パフォーマンス考慮

- ハンドラー登録は初回の `getEventBus()` 呼び出し時のみ
- 登録処理は同期的に実行（100ms 以内）
- GitHub API 呼び出しは非同期（イベントハンドラー内）
- コマンド実行時間への影響は無視できるレベル

### 7.7 必要な変更ファイル

1. **`.cc-craft-kit/core/workflow/event-bus.ts`**
   - `getEventBus()` 関数の修正
   - ハンドラー登録フラグの追加

2. **`.cc-craft-kit/core/workflow/github-integration.ts`**
   - src/ からのコピー（既に存在するか確認）
   - 重複登録防止のロジック追加（オプション）

3. **依存モジュールの確認**
   - `.cc-craft-kit/integrations/github/*` が存在するか
   - `.cc-craft-kit/core/database/connection.ts` が存在するか

---

## 8. 実装タスク

### Task 1: EventBus の自動ハンドラー登録機能実装

**ファイル:** `.cc-craft-kit/core/workflow/event-bus.ts`

**変更内容:**

1. ハンドラー登録フラグを追加
2. `getEventBus()` 関数を修正して初回呼び出し時にハンドラー登録
3. エラーハンドリング追加

**実装例:**

```typescript
import { getDatabase } from '../database/connection.js';
import { registerGitHubIntegrationHandlers } from './github-integration.js';

let eventBusInstance: EventBus | null = null;
let handlersRegistered = false;

export function getEventBus(): EventBus {
  if (!eventBusInstance) {
    eventBusInstance = new EventBus();
  }

  // 初回のみハンドラー登録
  if (!handlersRegistered) {
    try {
      const db = getDatabase();
      registerGitHubIntegrationHandlers(eventBusInstance, db);
      handlersRegistered = true;
    } catch (error) {
      // データベース未初期化などのエラーはスキップ
      // プロジェクト未初期化の場合は正常動作
      console.warn('Failed to register GitHub handlers:', error);
    }
  }

  return eventBusInstance;
}
```

**見積もり工数:** 30 分

**依存関係:** なし

**テスト:**
- プロジェクト初期化済みの場合、ハンドラーが登録されること
- データベース未初期化の場合、エラーにならないこと
- 2 回目以降の呼び出しで重複登録されないこと

---

### Task 2: 動作確認テスト（手動）

**実施内容:**

1. テストプロジェクトで `/cft:spec-phase` を実行
2. GitHub Issue のラベルが自動更新されることを確認
3. Projects v2 のステータスが自動更新されることを確認
4. コンソール出力を確認

**テストケース:**

| ケース | フェーズ遷移 | 期待される Issue ラベル | 期待される Project ステータス |
|--------|-------------|------------------------|-------------------------------|
| 1 | requirements → design | phase:design | In Progress |
| 2 | design → tasks | phase:tasks | In Progress |
| 3 | tasks → implementation | phase:implementation | In Progress |
| 4 | implementation → completed | phase:completed | Done |

**見積もり工数:** 30 分

**依存関係:** Task 1

---

### Task 3: エラーケースのテスト

**テストケース:**

1. **GITHUB_TOKEN 未設定**
   - 実行結果: ハンドラーがスキップされる（エラーにならない）
   - 確認方法: `unset GITHUB_TOKEN` してコマンド実行

2. **GitHub 設定未完了（config.json に github セクションなし）**
   - 実行結果: ハンドラーがスキップされる
   - 確認方法: `.cc-craft-kit/config.json` から `github` セクションを削除

3. **Issue 未作成の仕様書**
   - 実行結果: ハンドラーがスキップされる
   - 確認方法: `github_issue_id` が null の仕様書でフェーズ変更

4. **ネットワークエラー（GitHub API 到達不可）**
   - 実行結果: 警告表示、コマンドは成功
   - 確認方法: 無効な GITHUB_TOKEN を設定

**見積もり工数:** 1 時間

**依存関係:** Task 1, Task 2

---

### Task 4: 既存テストとの互換性確認

**実施内容:**

1. 既存のテストスイートを実行
2. `tests/core/workflow/github-integration.test.ts` が正常に動作することを確認
3. 自動登録による影響がないことを確認

**コマンド:**

```bash
npm test -- github-integration.test.ts
```

**見積もり工数:** 15 分

**依存関係:** Task 1

---

### Task 5: ドキュメント更新

**更新ファイル:**

1. **CLAUDE.md**
   - イベント駆動アーキテクチャのセクションを更新
   - 自動ハンドラー登録について記載

2. **README.md**（必要に応じて）
   - GitHub 統合セクションの更新

**見積もり工数:** 30 分

**依存関係:** Task 1, Task 2, Task 3

---

### Task 6: GitHub Issue に実装完了を記録

**実施内容:**

```bash
/cft:knowledge-progress dcbb128c "EventBus自動ハンドラー登録機能を実装。フェーズ変更時にGitHub IssueとProjectsが自動更新されるようになった。"
```

**見積もり工数:** 5 分

**依存関係:** Task 1, Task 2, Task 3, Task 4, Task 5

---

## 総見積もり工数

- **実装**: 30 分（Task 1）
- **テスト**: 1 時間 45 分（Task 2, 3, 4）
- **ドキュメント**: 30 分（Task 5）
- **記録**: 5 分（Task 6）

**合計**: 約 2 時間 50 分

---

## 優先順位

1. **高**: Task 1（コア実装）
2. **高**: Task 2（動作確認）
3. **中**: Task 3（エラーケース）
4. **中**: Task 4（テスト互換性）
5. **低**: Task 5（ドキュメント）
6. **低**: Task 6（記録）
