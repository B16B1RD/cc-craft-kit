# DB の整合性がまったくとれていない

**仕様書 ID:** a1c94dc8-7d6b-4099-9505-13d7f69559b9
**フェーズ:** requirements
**作成日時:** 2025/12/05 21:30:00
**更新日時:** 2025/12/05 21:30:00

---

## 1. 背景と目的

### 背景

requirements が 2 件（GitHub Issue #761 と #762）が `/cft:status` で計上されていない。いずれも develop ブランチで作成された仕様書であるにもかかわらず、表示されない。また、review フェーズは実際には 0 件だが、6 件と表示されており、この 6 件は completed が正しい。

コードベース解析の結果、以下の問題が特定された:

1. **review フェーズ定義漏れ**: `get-status.ts` の `phases` 配列に `'review'` が含まれていない可能性
2. **ブランチフィルタリング過度適用**: `getSpecsWithGitHubInfo()` のブランチフィルタリングにより develop の仕様書が除外される可能性
3. **github_sync との LEFT JOIN 緩さ**: null 許容により不整合を検出しづらい

### 目的

`/cft:status` コマンドで正確なフェーズ別集計を表示し、DB の整合性を保証する

---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者（`/cft:status` で正確なプロジェクト状況を把握したいユーザー）

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:status` で全フェーズ（requirements, design, tasks, implementation, review, completed）が正しく集計される
- [ ] develop ブランチの仕様書（Issue #761, #762）が正しく表示される

### 機能要件

- [ ] `get-status.ts` の phases 配列に全フェーズが含まれている
- [ ] ブランチフィルタリングロジックを修正し、develop ブランチの仕様書が除外されないようにする
- [ ] DB 整合性チェック機能で不整合を検出できる

### 非機能要件

- [ ] 修正後も既存の `/cft:status` コマンドのパフォーマンスに影響しない
- [ ] 既存の仕様書データに対して破壊的変更を行わない

---

## 4. 制約条件

- 既存の SQLite データベーススキーマを維持する（マイグレーション不要）
- Kysely ORM を使用した型安全なクエリ実装
- 5 フェーズモデル（requirements → design → implementation → review → completed）+ 後方互換の tasks フェーズをサポート

---

## 5. 依存関係

- `src/commands/status/get-status.ts` - ステータス表示ロジック
- `src/core/database/helpers.ts` - specs と github_sync の JOIN クエリ、ブランチフィルタリング
- `src/core/database/schema.ts` - SpecPhase 型定義
- `src/core/validators/database-integrity-checker.ts` - DB 整合性検証

---

## 6. 参考情報

- GitHub Issue #761: requirements フェーズの仕様書が漏れている
- GitHub Issue #762: review フェーズの集計問題と関連している可能性
- `src/scripts/repair-github-sync.ts` - GitHub Issue 紐付け復旧スクリプト（参考実装）
