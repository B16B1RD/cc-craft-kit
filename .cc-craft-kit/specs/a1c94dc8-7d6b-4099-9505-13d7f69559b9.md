# DB の整合性がまったくとれていない

**仕様書 ID:** a1c94dc8-7d6b-4099-9505-13d7f69559b9
**フェーズ:** implementation
**作成日時:** 2025/12/05 21:30:00
**更新日時:** 2025/12/05 22:02:00

---

## 1. 背景と目的

### 背景

requirements が 2 件（GitHub Issue #761 と #762）が `/cft:status` で計上されていない。いずれも develop ブランチで作成された仕様書であるにもかかわらず、表示されない。また、review フェーズは実際には 0 件だが、6 件と表示されており、この 6 件は completed が正しい。

コードベース解析の結果、以下の問題が特定された:

1. **review フェーズ定義漏れ**: `get-status.ts` の `phases` 配列に `'review'` が含まれていない可能性
2. **ブランチフィルタリング過度適用**: `getSpecsWithGitHubInfo()` のブランチフィルタリングにより develop の仕様書が除外される可能性
3. **github_sync との LEFT JOIN 緩さ**: null 許容により不整合を検出しづらい

### 目的

`/cft:status` コマンドで正確なフェーズ別集計を表示し、DB の整合性を保証する

---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者（`/cft:status` で正確なプロジェクト状況を把握したいユーザー）

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:status` で全フェーズ（requirements, design, tasks, implementation, review, completed）が正しく集計される
- [ ] develop ブランチの仕様書（Issue #761, #762）が正しく表示される

### 機能要件

- [ ] `get-status.ts` の phases 配列に全フェーズが含まれている
- [ ] ブランチフィルタリングロジックを修正し、develop ブランチの仕様書が除外されないようにする
- [ ] DB 整合性チェック機能で不整合を検出できる

### 非機能要件

- [ ] 修正後も既存の `/cft:status` コマンドのパフォーマンスに影響しない
- [ ] 既存の仕様書データに対して破壊的変更を行わない

---

## 4. 制約条件

- 既存の SQLite データベーススキーマを維持する（マイグレーション不要）
- Kysely ORM を使用した型安全なクエリ実装
- 5 フェーズモデル（requirements → design → implementation → review → completed）+ 後方互換の tasks フェーズをサポート

---

## 5. 依存関係

- `src/commands/status/get-status.ts` - ステータス表示ロジック
- `src/core/database/helpers.ts` - specs と github_sync の JOIN クエリ、ブランチフィルタリング
- `src/core/database/schema.ts` - SpecPhase 型定義
- `src/core/validators/database-integrity-checker.ts` - DB 整合性検証

---

## 6. 参考情報

- GitHub Issue #761: requirements フェーズの仕様書が漏れている
- GitHub Issue #762: review フェーズの集計問題と関連している可能性
- `src/scripts/repair-github-sync.ts` - GitHub Issue 紐付け復旧スクリプト（参考実装）

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
┌─────────────────────────────────────────────────────────────────────┐
│                         /cft:status コマンド                         │
├─────────────────────────────────────────────────────────────────────┤
│  src/commands/status.ts (CLI エントリポイント)                       │
│       ↓                                                             │
│  src/commands/status/get-status.ts (コアロジック)                    │
│       ↓                                                             │
│  src/core/database/helpers.ts (DB クエリ・フィルタリング)            │
│       ↓                                                             │
│  SQLite DB (specs + github_sync テーブル)                           │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                         型定義・制約                                 │
├─────────────────────────────────────────────────────────────────────┤
│  src/core/database/schema.ts          ← SpecPhase 型（6フェーズ）    │
│  src/integrations/github/phase-status-mapper.ts ← Phase 型（5フェーズ）│
│       ↑ 不整合！review フェーズが欠落                                │
└─────────────────────────────────────────────────────────────────────┘
```

#### 設計方針

1. **フェーズ定義の統一**: すべてのフェーズ集計ロジックで `SpecPhase` 型の全 6 フェーズを使用
2. **型の正規化**: `phase-status-mapper.ts` の `Phase` 型を `SpecPhase` に統一
3. **最小変更原則**: 既存の DB スキーマやデータに影響を与えない

#### 処理フロー詳細

```
/cft:status 実行
    │
    ▼
status.ts: parseArguments()
    │
    ▼
get-status.ts: getStatus()
    ├── getSpecsWithGitHubInfo() ← ブランチフィルタリング適用
    │       │
    │       ▼
    │   helpers.ts: LEFT JOIN specs ⇔ github_sync
    │       │
    │       ▼
    │   フィルタ: branch_name IN (currentBranch, 'main', 'develop')
    │
    ├── phases 配列でループ ← ★ここに review が欠落
    │       │
    │       ▼
    │   byPhase[phase] = allSpecs.filter(s => s.phase === phase).length
    │
    └── return { totalSpecs, byPhase, ... }
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/commands/status/get-status.ts` | phases 配列に `'review'` を追加 |
| `src/commands/status.ts` | phases 配列に `'review'` を追加 |
| `src/integrations/github/phase-status-mapper.ts` | Phase 型に `'review'` を追加 |

#### 変更詳細

**get-status.ts (line 82)**:
```typescript
// Before
const phases: SpecPhase[] = ['requirements', 'design', 'tasks', 'implementation', 'completed'];

// After
const phases: SpecPhase[] = ['requirements', 'design', 'tasks', 'implementation', 'review', 'completed'];
```

**status.ts (line 198)**:
```typescript
// Before
const phases = ['requirements', 'design', 'tasks', 'implementation', 'completed'];

// After
const phases = ['requirements', 'design', 'tasks', 'implementation', 'review', 'completed'];
```

**phase-status-mapper.ts (line 22)**:
```typescript
// Before
export type Phase = 'requirements' | 'design' | 'tasks' | 'implementation' | 'completed';

// After
export type Phase = 'requirements' | 'design' | 'tasks' | 'implementation' | 'review' | 'completed';
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| フェーズ集計 | 5フェーズのみ（review 欠落） | 6フェーズすべて | get-status.ts:82 |
| フェーズ表示 | 5フェーズのみ | 6フェーズすべて | status.ts:198 |
| GitHub ステータス型 | Phase 型（review 欠落） | SpecPhase と同じ | phase-status-mapper.ts:22 |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| フェーズ集計 | 全 6 フェーズが byPhase に含まれる | 型チェック + 単体テスト |
| review フェーズ表示 | review フェーズの仕様書がカウントされる | `/cft:status` 実行後の出力確認 |
| 型整合性 | Phase 型と SpecPhase 型が一致 | TypeScript コンパイル |

### 7.5 移行計画

#### Phase 1: フェーズ集計ロジックの修正

1. `get-status.ts` の phases 配列に `'review'` を追加
2. `status.ts` の phases 配列に `'review'` を追加

#### Phase 2: 型定義の統一

1. `phase-status-mapper.ts` の Phase 型に `'review'` を追加

#### Phase 3: 動作確認

1. 型チェック・リント実行
2. `/cft:status` で review フェーズが正しく表示されることを確認

---

## 8. 実装タスクリスト

### Phase 1: フェーズ集計ロジックの修正

- [x] `get-status.ts` の phases 配列に `'review'` を追加 (#764)
- [ ] `status.ts` の phases 配列に `'review'` を追加 (#765)

### Phase 2: 型定義の統一

- [ ] `phase-status-mapper.ts` の Phase 型に `'review'` を追加 (#766)

### Phase 3: 動作確認

- [ ] 型チェック・リント実行 (#767)
- [ ] `/cft:status` で review フェーズが正しく表示されることを確認 (#768)
