# フェーズ切り替え時にコミット

**仕様書 ID:** ce58b80b-b5e3-49e7-ab11-ff12f4205276
**フェーズ:** completed
**作成日時:** 2025/11/22 11:42:28
**更新日時:** 2025/11/22 12:11:22

---

## 1. 背景と目的

### 背景

現在、cc-craft-kit では仕様書のフェーズ切り替え時に Git 自動コミット機能が実装されていますが、以下の問題が発生しています。

- フェーズ切り替え前に未コミットの変更が残っている場合、ユーザーが手動でコミットする必要がある
- コミット漏れにより、作業内容を失うリスクがある
- フェーズ移行とコミットのタイミングが不整合になる可能性がある

この問題を解決するため、フェーズ切り替え時に自動的に変更をコミットする機能を強化する必要があります。

### 目的

フェーズ切り替え時に未コミットの変更を自動検出し、適切なコミットメッセージで自動コミットすることで、以下を実現します。

- コミット漏れによる作業内容の損失を防止する
- フェーズ移行とコミットのタイミングを一致させる
- ユーザーが Git 操作を意識せずに仕様駆動開発を進められる環境を提供する

---

## 2. 対象ユーザー

**主要ユーザー:**

- cc-craft-kit を使用する開発者（仕様書作成者）
- Claude Code を使用して仕様駆動開発を実施するエンジニア

**ユースケース:**

- 仕様書のフェーズを切り替える際に、Git コミットを意識せずに作業を進めたい
- コミット漏れによる作業内容の損失を防ぎたい
- フェーズ移行履歴を Git コミット履歴として自動記録したい

---

## 3. 受け入れ基準

### 必須要件

- [ ] フェーズ切り替え時に未コミットの変更がある場合、自動的にコミットされること
- [ ] コミットメッセージに仕様書名とフェーズ情報が含まれること
- [ ] コミット失敗時にエラーメッセージが表示され、フェーズ移行がロールバックされること

### 機能要件

- [ ] completed フェーズ移行時は全変更ファイルをコミット対象とすること
- [ ] requirements/design/tasks/implementation フェーズ移行時は仕様書ファイルのみをコミット対象とすること
- [ ] Git リポジトリ未初期化の場合、警告のみ表示しフェーズ移行は継続すること
- [ ] pre-commit フック失敗時、ユーザーに手動コミット手順を案内すること

### 非機能要件

- [ ] コミット処理が 5 秒以内に完了すること
- [ ] コミット失敗ログが `.cc-craft-kit/logs/` に記録されること
- [ ] コミット処理中、ユーザーへ進捗状況が表示されること

---

## 4. 制約条件

**技術的制約:**

- Git がインストールされている環境でのみ動作する
- Git リポジトリが初期化されている必要がある（未初期化の場合は警告のみ）
- Node.js の `child_process.execSync()` を使用して Git コマンドを実行する

**運用上の制約:**

- コミットメッセージ形式は Conventional Commits に従う
- 保護ブランチ（main, develop）では直接コミットできない
- フェーズ移行前の整合性チェックに合格している必要がある

**既存実装との互換性:**

- 既存の Git 自動コミット機能（`src/core/workflow/git-integration.ts`）を拡張する
- イベント駆動アーキテクチャ（`spec.phase_changed` イベント）を維持する
- 既存のエラーハンドリング機構を使用する

---

## 5. 依存関係

**依存するモジュール:**

- `src/core/workflow/git-integration.ts` - Git 自動コミット処理
- `src/core/workflow/event-bus.ts` - イベントバスとハンドラー登録
- `src/commands/spec/phase.ts` - フェーズ切り替えコマンド
- `src/core/git/branch-creation.ts` - ブランチ管理機能

**依存するデータ:**

- `specs` テーブル（データベース）- 仕様書情報とフェーズ管理
- `.cc-craft-kit/specs/*.md` - 仕様書ファイル
- `.env` - 環境変数（保護ブランチ設定）

**関連仕様:**

- Git 自動コミット機能（既存実装）
- イベント駆動アーキテクチャ
- フェーズ管理機能

---

## 6. 参考情報

**関連ドキュメント:**

- [CLAUDE.md - Git 自動コミット機能](./CLAUDE.md#git自動コミット機能)
- [ARCHITECTURE.md - イベント駆動アーキテクチャ](./docs/ARCHITECTURE.md)

**関連ファイル:**

- `src/core/workflow/git-integration.ts` - Git 統合ハンドラー実装
- `src/core/workflow/event-bus.ts` - イベントバス実装
- `src/commands/spec/phase.ts` - フェーズ切り替えコマンド実装

**参考 Issue:**

- GitHub Issue #271: フェーズ切り替え時にコミット

---

## 7. 設計

### 7.1 アーキテクチャ概要

フェーズ切り替え時のコミット処理は、イベント駆動アーキテクチャを使用して実装します。

```text
┌─────────────────────────────────────┐
│ /cft:spec-phase コマンド            │
│  (src/commands/spec/phase.ts)       │
└──────────────┬──────────────────────┘
               │
               │ 1. spec.phase_changed イベント発火
               ▼
┌─────────────────────────────────────┐
│ EventBus (src/core/workflow/)       │
│  - イベントルーティング              │
│  - ハンドラー実行                    │
└──────────────┬──────────────────────┘
               │
               │ 2. イベントハンドラー実行
               ▼
┌─────────────────────────────────────┐
│ Git Integration Handler             │
│  (src/core/workflow/git-integration.ts) │
│  - 未コミット変更の検出 (新機能)     │
│  - コミット対象ファイルの決定        │
│  - Git コミット実行                  │
│  - エラーハンドリング                │
└─────────────────────────────────────┘
```

### 7.2 処理フロー

#### 7.2.1 フェーズ切り替え時の処理フロー

```text
1. ユーザーが /cft:spec-phase <spec-id> <phase> を実行
   ↓
2. フェーズ切り替えコマンド実行前に Git ステータスをチェック
   ├─ 未コミットの変更あり → 次へ進む
   └─ 変更なし → フェーズ切り替えのみ実行
   ↓
3. 未コミット変更の分類
   ├─ 仕様書ファイルの変更
   ├─ ソースコードの変更
   └─ その他のファイルの変更
   ↓
4. コミット対象の決定
   ├─ completed フェーズ移行 → 全ファイル
   └─ その他のフェーズ → 仕様書ファイルのみ
   ↓
5. コミットメッセージ生成
   ├─ Conventional Commits 形式
   └─ フェーズ情報を含める
   ↓
6. Git コミット実行
   ├─ git add <files>
   ├─ git commit -m "<message>"
   └─ エラー時はロールバック
   ↓
7. フェーズ切り替え実行
   ├─ データベース更新
   ├─ 仕様書ファイル更新
   └─ spec.phase_changed イベント発火
```

#### 7.2.2 エラーハンドリングフロー

```text
1. Git リポジトリ未初期化
   ├─ 警告メッセージ表示
   └─ フェーズ切り替えは継続

2. git add 失敗
   ├─ エラーログ記録
   ├─ ユーザーへ手動コミット案内
   └─ フェーズ切り替えは継続

3. git commit 失敗 (pre-commit フック失敗含む)
   ├─ エラーログ記録
   ├─ git reset でステージング解除
   ├─ ユーザーへ手動コミット案内
   └─ フェーズ切り替えは継続

4. spec.phase_changed イベント発火失敗
   ├─ エラーログ記録
   ├─ ロールバック実行（データベース、ファイル）
   └─ フェーズ切り替え失敗
```

### 7.3 データモデル

#### 7.3.1 イベントデータ

**spec.phase_changed イベント:**

```typescript
interface PhaseChangedEvent {
  specId: string;           // 仕様書 ID (UUID)
  data: {
    oldPhase: Phase;        // 変更前のフェーズ
    newPhase: Phase;        // 変更後のフェーズ
  };
  timestamp: Date;          // イベント発火時刻
}
```

#### 7.3.2 Git ステータスデータ

```typescript
interface GitStatus {
  hasChanges: boolean;      // 未コミット変更の有無
  stagedFiles: string[];    // ステージングされたファイル
  unstagedFiles: string[];  // 未ステージングのファイル
  untrackedFiles: string[]; // 追跡されていないファイル
}
```

### 7.4 API 設計

#### 7.4.1 新規追加関数

##### checkGitStatus(): GitStatus

```typescript
/**
 * Git ステータスをチェックし、未コミット変更を検出
 * @returns Git ステータス情報
 * @throws Git コマンド実行エラー時
 */
function checkGitStatus(): GitStatus {
  // git status --porcelain 実行
  // 結果をパースして GitStatus オブジェクトを生成
  // 例:
  // - "M  file.ts" → stagedFiles
  // - " M file.ts" → unstagedFiles
  // - "?? file.ts" → untrackedFiles
}
```

##### hasUncommittedChanges(): boolean

```typescript
/**
 * 未コミット変更の有無を簡易チェック
 * @returns 未コミット変更がある場合 true
 */
function hasUncommittedChanges(): boolean {
  // git status --short を実行
  // 出力が空でない場合 true を返す
}
```

#### 7.4.2 既存関数の拡張

##### handlePhaseChangeCommit() の拡張

```typescript
async function handlePhaseChangeCommit(
  event: WorkflowEvent<{ oldPhase: string; newPhase: string }>,
  db: Kysely<Database>
): Promise<void> {
  // 既存処理...

  // 新規追加: 未コミット変更のチェック
  const gitStatus = checkGitStatus();

  if (!gitStatus.hasChanges) {
    console.log('ℹ No uncommitted changes, skipping auto-commit');
    return;
  }

  // 既存のコミット処理を実行...
}
```

### 7.5 セキュリティ設計

#### 7.5.1 コマンドインジェクション対策

- `spawnSync()` を使用し、シェル経由でのコマンド実行を回避
- ファイルパスは `path.basename()` でサニタイズ
- 仕様書 ID は UUID フォーマット検証を実施

#### 7.5.2 データ保護

- コミット失敗時は `git reset` で自動ロールバック
- エラーログにセンシティブ情報（トークン、パスワード）を含めない
- pre-commit フック失敗時もデータ損失を防止

### 7.6 パフォーマンス設計

#### 7.6.1 Git コマンド実行の最適化

- `git status --porcelain` で軽量な出力形式を使用
- `stdio: 'ignore'` でバッファリングを最小化
- タイムアウト設定（5 秒）でハングアップを防止

#### 7.6.2 並列処理の制限

- Git コマンドは順次実行（並列実行しない）
- データベース更新とファイル更新は同期処理

### 7.7 ログ設計

#### 7.7.1 ログレベル

| レベル | 用途 | 出力先 |
|---|---|---|
| `debug` | Git コマンドの実行詳細 | `.cc-craft-kit/logs/` |
| `info` | コミット成功、スキップ | コンソール + ログファイル |
| `warn` | Git リポジトリ未初期化 | コンソール + ログファイル |
| `error` | コミット失敗、pre-commit フック失敗 | コンソール + ログファイル |

#### 7.7.2 ログメッセージ例

```text
[INFO] Auto-commit: feat: フェーズ切り替え時にコミット の設計を完了
[INFO] Committed files: .cc-craft-kit/specs/ce58b80b-b5e3-49e7-ab11-ff12f4205276.md
[WARN] Not a Git repository, skipping auto-commit
[ERROR] Git commit failed: husky - pre-commit script failed (code 1)
```

### 7.8 テスト設計

#### 7.8.1 単体テスト

| テストケース | 検証内容 |
|---|---|
| `checkGitStatus()` | Git ステータスの正しいパース |
| `hasUncommittedChanges()` | 未コミット変更の検出精度 |
| `getCommitTargets()` | フェーズごとのコミット対象決定 |
| `gitCommit()` | コミット成功/失敗のハンドリング |

#### 7.8.2 統合テスト

| シナリオ | 検証内容 |
|---|---|
| フェーズ切り替え + コミット | 正常系の E2E フロー |
| pre-commit フック失敗 | エラーハンドリングとロールバック |
| Git リポジトリ未初期化 | 警告表示とフェーズ切り替え継続 |
| completed フェーズ移行 | 全ファイルコミットの検証 |

---

## 8. 実装タスクリスト

### 8.1 コア機能の実装

#### タスク 1: checkGitStatus() 関数を実装

**目的:** Git ステータスをチェックし、未コミット変更を検出する関数を実装する。

**実装内容:**

- `git status --porcelain` を実行して結果を取得
- 結果をパースして以下に分類：
  - ステージングされたファイル（`M  file.ts`）
  - 未ステージングのファイル（`M file.ts`）
  - 追跡されていないファイル（`?? file.ts`）
- `GitStatus` インターフェースのオブジェクトを返す

**対象ファイル:** `src/core/workflow/git-integration.ts`

**受け入れ基準:**

- [ ] `git status --porcelain` の出力を正しくパースできること
- [ ] ステージング済み/未ステージング/未追跡ファイルを正しく分類できること
- [ ] Git コマンド実行エラー時は適切な例外をスローすること

---

#### タスク 2: hasUncommittedChanges() 関数を実装

**目的:** 未コミット変更の有無を簡易チェックする関数を実装する。

**実装内容:**

- `git status --short` を実行
- 出力が空でない場合は `true` を返す
- Git リポジトリ未初期化の場合は `false` を返す

**対象ファイル:** `src/core/workflow/git-integration.ts`

**受け入れ基準:**

- [ ] 未コミット変更がある場合は `true` を返すこと
- [ ] 未コミット変更がない場合は `false` を返すこと
- [ ] Git リポジトリ未初期化の場合は `false` を返すこと

---

#### タスク 3: handlePhaseChangeCommit() 関数を拡張

**目的:** フェーズ切り替え時に未コミット変更を事前チェックし、必要な場合のみコミットを実行する。

**実装内容:**

- `hasUncommittedChanges()` で未コミット変更の有無をチェック
- 変更がない場合は早期リターン（コミットスキップ）
- 変更がある場合は既存のコミット処理を実行

**対象ファイル:** `src/core/workflow/git-integration.ts`

**受け入れ基準:**

- [ ] 未コミット変更がない場合、コミットをスキップすること
- [ ] 未コミット変更がある場合、既存のコミット処理を実行すること
- [ ] スキップ時は情報メッセージを表示すること

---

### 8.2 エラーハンドリングの強化

#### タスク 4: コミット失敗時のロールバック処理を実装

**目的:** `git commit` 失敗時に、ステージングされたファイルを自動的にリセットする。

**実装内容:**

- `git commit` 失敗時に `git reset HEAD` を実行
- ステージングエリアをクリア
- エラーログを記録

**対象ファイル:** `src/core/workflow/git-integration.ts`

**受け入れ基準:**

- [ ] `git commit` 失敗時に `git reset HEAD` が実行されること
- [ ] ロールバック処理が失敗してもフェーズ切り替えは継続すること
- [ ] ロールバック実行時はログに記録されること

---

#### タスク 5: エラーログ記録機能を実装

**目的:** コミット失敗時のエラーログを `.cc-craft-kit/logs/` に記録する。

**実装内容:**

- エラーハンドラーを使用してログを記録
- ログレベル `error` で記録
- エラーメッセージ、フェーズ情報、ファイル情報を含める

**対象ファイル:** `src/core/workflow/git-integration.ts`

**受け入れ基準:**

- [ ] コミット失敗時にエラーログが `.cc-craft-kit/logs/` に記録されること
- [ ] ログにエラーメッセージ、フェーズ、ファイル情報が含まれること
- [ ] センシティブ情報（トークン等）がログに含まれないこと

---

### 8.3 テストの作成

#### タスク 6: 単体テストを作成

**目的:** `checkGitStatus()` と `hasUncommittedChanges()` の単体テストを作成する。

**実装内容:**

- `checkGitStatus()` のテスト：
  - 正常系：ステージング済み/未ステージング/未追跡ファイルの分類
  - 異常系：Git コマンド実行エラー
- `hasUncommittedChanges()` のテスト：
  - 変更あり/なし/Git 未初期化の各ケース

**対象ファイル:** `tests/core/workflow/git-integration.test.ts`

**受け入れ基準:**

- [ ] `checkGitStatus()` の正常系テストが通ること
- [ ] `checkGitStatus()` の異常系テストが通ること
- [ ] `hasUncommittedChanges()` の全ケーステストが通ること

---

#### タスク 7: 統合テストを作成

**目的:** フェーズ切り替え + コミットの E2E テストを作成する。

**実装内容:**

- シナリオ 1：未コミット変更あり → 自動コミット → フェーズ切り替え
- シナリオ 2：未コミット変更なし → コミットスキップ → フェーズ切り替え
- シナリオ 3：Git リポジトリ未初期化 → 警告表示 → フェーズ切り替え継続
- シナリオ 4：pre-commit フック失敗 → エラーログ記録 → フェーズ切り替え継続

**対象ファイル:** `tests/e2e/phase-change-commit.test.ts`

**受け入れ基準:**

- [ ] 全シナリオのテストが通ること
- [ ] Git 操作は必ずモック化されていること
- [ ] テスト実行時にブランチが変更されないこと

---

### 8.4 ドキュメント更新

#### タスク 8: ドキュメント更新

**目的:** CLAUDE.md の Git 自動コミット機能セクションを更新する。

**実装内容:**

- 未コミット変更の事前チェック機能を追記
- コミットスキップ時の動作を説明
- エラーハンドリングとロールバック処理を説明

**対象ファイル:** `CLAUDE.md`

**受け入れ基準:**

- [ ] 新機能の説明が追加されていること
- [ ] コード例が更新されていること
- [ ] エラーハンドリングの説明が追加されていること

---

### 8.5 実装の優先順位

| 優先度 | タスク | 依存関係 |
|---|---|---|
| **高** | タスク 1: checkGitStatus() 実装 | なし |
| **高** | タスク 2: hasUncommittedChanges() 実装 | タスク 1 |
| **高** | タスク 3: handlePhaseChangeCommit() 拡張 | タスク 2 |
| **中** | タスク 4: ロールバック処理実装 | タスク 3 |
| **中** | タスク 5: エラーログ記録実装 | タスク 3 |
| **中** | タスク 6: 単体テスト作成 | タスク 1, 2 |
| **中** | タスク 7: 統合テスト作成 | タスク 3, 4, 5 |
| **低** | タスク 8: ドキュメント更新 | タスク 7 |
