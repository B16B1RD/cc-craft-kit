# フェーズ切り替え時にコミット

**仕様書 ID:** ce58b80b-b5e3-49e7-ab11-ff12f4205276
**フェーズ:** requirements
**作成日時:** 2025/11/22 11:42:28
**更新日時:** 2025/11/22 11:42:28

---

## 1. 背景と目的

### 背景

現在、cc-craft-kit では仕様書のフェーズ切り替え時に Git 自動コミット機能が実装されていますが、以下の問題が発生しています。

- フェーズ切り替え前に未コミットの変更が残っている場合、ユーザーが手動でコミットする必要がある
- コミット漏れにより、作業内容が失われるリスクがある
- フェーズ移行とコミットのタイミングが不整合になる可能性がある

この問題を解決するため、フェーズ切り替え時に自動的に変更をコミットする機能を強化する必要があります。

### 目的

フェーズ切り替え時に未コミットの変更を自動検出し、適切なコミットメッセージで自動コミットすることで、以下を実現します。

- コミット漏れによる作業内容の損失を防止する
- フェーズ移行とコミットのタイミングを一致させる
- ユーザーが Git 操作を意識せずに仕様駆動開発を進められる環境を提供する

---

## 2. 対象ユーザー

**主要ユーザー:**

- cc-craft-kit を使用する開発者（仕様書作成者）
- Claude Code を使用して仕様駆動開発を実施するエンジニア

**ユースケース:**

- 仕様書のフェーズを切り替える際に、Git コミットを意識せずに作業を進めたい
- コミット漏れによる作業内容の損失を防ぎたい
- フェーズ移行履歴を Git コミット履歴として自動記録したい

---

## 3. 受け入れ基準

### 必須要件

- [ ] フェーズ切り替え時に未コミットの変更がある場合、自動的にコミットされること
- [ ] コミットメッセージに仕様書名とフェーズ情報が含まれること
- [ ] コミット失敗時にエラーメッセージが表示され、フェーズ移行がロールバックされること

### 機能要件

- [ ] completed フェーズ移行時は全変更ファイルをコミット対象とすること
- [ ] requirements/design/tasks/implementation フェーズ移行時は仕様書ファイルのみをコミット対象とすること
- [ ] Git リポジトリ未初期化の場合、警告のみ表示しフェーズ移行は継続すること
- [ ] pre-commit フック失敗時、ユーザーに手動コミット手順を案内すること

### 非機能要件

- [ ] コミット処理が 5 秒以内に完了すること
- [ ] コミット失敗ログが `.cc-craft-kit/logs/` に記録されること
- [ ] コミット処理中にユーザーに進捗状況が表示されること

---

## 4. 制約条件

**技術的制約:**

- Git がインストールされている環境でのみ動作する
- Git リポジトリが初期化されている必要がある（未初期化の場合は警告のみ）
- Node.js の `child_process.execSync()` を使用して Git コマンドを実行する

**運用上の制約:**

- コミットメッセージ形式は Conventional Commits に従う
- 保護ブランチ（main, develop）では直接コミットできない
- フェーズ移行前の整合性チェックに合格している必要がある

**既存実装との互換性:**

- 既存の Git 自動コミット機能（`src/core/workflow/git-integration.ts`）を拡張する
- イベント駆動アーキテクチャ（`spec.phase_changed` イベント）を維持する
- 既存のエラーハンドリング機構を使用する

---

## 5. 依存関係

**依存するモジュール:**

- `src/core/workflow/git-integration.ts` - Git 自動コミット処理
- `src/core/workflow/event-bus.ts` - イベントバスとハンドラー登録
- `src/commands/spec/phase.ts` - フェーズ切り替えコマンド
- `src/core/git/branch-creation.ts` - ブランチ管理機能

**依存するデータ:**

- `specs` テーブル（データベース）- 仕様書情報とフェーズ管理
- `.cc-craft-kit/specs/*.md` - 仕様書ファイル
- `.env` - 環境変数（保護ブランチ設定）

**関連仕様:**

- Git 自動コミット機能（既存実装）
- イベント駆動アーキテクチャ
- フェーズ管理機能

---

## 6. 参考情報

**関連ドキュメント:**

- [CLAUDE.md - Git 自動コミット機能](./CLAUDE.md#git自動コミット機能)
- [ARCHITECTURE.md - イベント駆動アーキテクチャ](./docs/ARCHITECTURE.md)

**関連ファイル:**

- `src/core/workflow/git-integration.ts` - Git 統合ハンドラー実装
- `src/core/workflow/event-bus.ts` - イベントバス実装
- `src/commands/spec/phase.ts` - フェーズ切り替えコマンド実装

**参考 Issue:**

- GitHub Issue #271: フェーズ切り替え時にコミット
