# 各フェーズ完了時に未コミットのものがる

**仕様書 ID:** eba108ca-3ba8-4418-ba80-c0ca6fed22f3
**フェーズ:** requirements
**作成日時:** 2025/11/24 16:03:32
**更新日時:** 2025/11/24 16:03:32

---

## 1. 背景と目的

### 背景

現在、フェーズ遷移時（特に `/cft:spec-phase` コマンド実行時）に未コミット状態が残存する問題が発生しています。

**問題の原因:**

1. **自動コミット実行タイミングの不確実性**:
   - `phase.ts` でフェーズ遷移時に `spec.phase_changed` イベントを発火
   - イベントハンドラー登録が非同期で実行される（`event-bus.ts`）
   - ハンドラー登録完了前にイベントが発火すると、自動コミットがスキップされる

2. **Slash コマンド層での自動コミットチェック非実装**:
   - `spec-phase.md` の仕様では「フェーズ移行後に自動的に git status チェックを実行」と記載
   - 実際には Claude が手動で実行する必要があるが、実行されないケースがある
   - 未コミット状態の検出と警告が確実に実行されない

3. **責任分界の不明確さ**:
   - TypeScript スクリプト層（`git-integration.ts`）: イベント駆動で自動コミット実装
   - Slash コマンド層（`spec-phase.md`）: プロンプトベースで git status チェック指示
   - 両者の役割分担が不明確で、どちらも確実に実行されない可能性がある

### 目的

フェーズ遷移時に未コミット状態が残存する問題を解決し、すべてのフェーズ完了時に確実にコミットが実行される仕組みを構築します。具体的には:

1. イベントハンドラー登録の完了を明示的に待機し、自動コミット処理の確実性を向上
2. Slash コマンド層での未コミットチェックを確実に実行する実装を追加
3. TypeScript スクリプト層と Slash コマンド層の責任分界を明確化
4. フェーズ完了時のコミット処理をテストで検証

---

## 2. 対象ユーザー

- **cc-craft-kit を使用する開発者**: `/cft:spec-phase` コマンドでフェーズ遷移を実行するユーザー
- **開発キット保守担当者**: 自動コミット処理の信頼性を確保する必要がある開発者
- **CI/CD パイプライン**: 自動化されたフェーズ遷移処理で未コミット状態を検出する必要があるシステム

---

## 3. 受け入れ基準

### 必須要件

- [ ] `event-bus.ts` でハンドラー登録完了を待機する関数を実装（`ensureHandlersRegistered()`）
- [ ] `phase.ts` の `updateSpecPhase()` でイベント発火前にハンドラー登録完了を明示的に待機
- [ ] `spec-phase.md` でフェーズ遷移後に `git status --porcelain` を確実に実行する実装を追加
- [ ] フェーズ完了時のコミット処理をテストで検証（単体テスト、統合テスト）

### 機能要件

- [ ] `/cft:spec-phase <id> <phase>` 実行後、未コミット状態がない場合は成功メッセージを表示
- [ ] 未コミット状態がある場合は、警告メッセージを表示し、コミット推奨を案内
- [ ] 自動コミット処理が失敗した場合、エラーメッセージを表示し、手動コミットを案内
- [ ] イベント駆動の自動コミット処理と Slash コマンド層のチェック処理が両方とも実行される

### 非機能要件

- [ ] 既存のフェーズ遷移処理に影響を与えない（後方互換性）
- [ ] イベントハンドラー登録の待機処理がタイムアウトする（デフォルト 10 秒）
- [ ] テストカバレッジが維持される（追加されたコードがテストでカバーされる）
- [ ] ログレベルを適切に設定（`debug`, `info`, `warn`, `error`）

---

## 4. 制約条件

- **非同期処理の複雑性**: イベントハンドラー登録とイベント発火のタイミングを確実に制御する必要がある
- **後方互換性**: 既存のフェーズ遷移処理（`phase.ts`, `git-integration.ts`）を変更するため、既存の動作を維持する必要がある
- **Slash コマンドの実装主体**: `spec-phase.md` はプロンプトベースで、Claude が Bash コマンドを実行する必要がある
- **テストカバレッジ**: イベント駆動処理のテストは複雑で、モック化が必要（Git コマンド、EventBus）
- **タイムアウト設定**: ハンドラー登録待機処理がデッドロックしないよう、タイムアウトを設定する必要がある

---

## 5. 依存関係

### 修正対象ファイル

1. **`src/core/workflow/event-bus.ts`** (287行)
   - `ensureHandlersRegistered()` 関数を実装
   - ハンドラー登録完了を待機する仕組みを追加
   - タイムアウト処理の実装

2. **`src/commands/spec/phase.ts`** (287行)
   - `updateSpecPhase()` でハンドラー登録完了を明示的に待機
   - `await ensureHandlersRegistered(eventBus);` を追加
   - エラーハンドリングの改善

3. **`src/slash-commands/spec-phase.md`** (188行)
   - フェーズ遷移後の git status チェックを確実に実行する実装を追加
   - 未コミット状態の検出と警告メッセージの表示を明確化

4. **`src/core/workflow/git-integration.ts`** (427行)
   - 自動コミット処理のログレベルを改善
   - エラーハンドリングの強化

5. **テストファイルの追加/更新**
   - `tests/core/workflow/event-bus.test.ts` - ハンドラー登録待機処理のテスト
   - `tests/commands/spec/phase.test.ts` - フェーズ遷移時の自動コミットテスト
   - `tests/integrations/phase-commit-flow.test.ts` - 統合テスト

### 関連コンポーネント

- **EventBus**: `src/core/workflow/event-bus.ts` (イベント駆動アーキテクチャの中核)
- **フェーズ遷移処理**: `src/core/workflow/phase-automation.ts` (フェーズ自動処理)
- **GitHub 統合**: `src/core/workflow/github-integration.ts` (GitHub Issue 連携)
- **仕様書作成**: `src/commands/spec/create.ts` (仕様書作成時の自動コミット実装例)

---

## 6. 参考情報

### 実装パターン

- **イベント駆動アーキテクチャ**: EventBus を使用した非同期処理のベストプラクティス
- **ハンドラー登録待機**: Promise ベースの待機処理とタイムアウト実装
- **Git 操作の自動化**: `execSync()` を使用した Git コマンド実行とエラーハンドリング
- **プロンプトベース実装**: Slash コマンド層での Bash コマンド実行パターン

### コードベース解析結果

Explore サブエージェントで調査した結果、以下の実装状況が特定されました:

1. **イベント駆動の自動コミット実装済み**: `git-integration.ts` で `spec.phase_changed` イベントに対応
2. **ハンドラー登録の非同期性**: `event-bus.ts` でハンドラー登録が非同期で実行され、競合が発生する可能性
3. **Slash コマンド層での実装不足**: `spec-phase.md` の仕様では git status チェックを指示しているが、確実に実行されない

詳細は、Explore サブエージェントの分析レポートを参照してください。

### 修正方針の選択肢

**A. 短期対策**: `spec-phase.md` での git status チェックを確実に実行
**B. 中期対策**: `event-bus.ts` でハンドラー登録完了を明示的に待機
**C. 長期対策**: コミット処理の責任分界を明確化し、一元化

本仕様では、B と C を組み合わせた修正を推奨します。

### 関連ドキュメント

- **CLAUDE.md**: プロジェクト規約（スクリプトとプロンプトの使い分け指針）
- **src/slash-commands/spec-phase.md**: ユーザー向けフェーズ遷移ガイド
- **src/core/workflow/event-bus.ts**: EventBus の実装と使用方法
- **src/core/workflow/git-integration.ts**: Git 統合の実装例
