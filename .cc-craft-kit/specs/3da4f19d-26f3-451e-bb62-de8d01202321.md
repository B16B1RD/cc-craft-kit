# Kent Beck や t-wada 氏らが推奨する TDD が実践されているように見受けられない

**仕様書 ID:** 3da4f19d-26f3-451e-bb62-de8d01202321
**フェーズ:** design
**作成日時:** 2025/11/21 11:35:04
**更新日時:** 2025/11/21 11:40:38

---

## 1. 背景と目的

### 背景

cc-craft-kit プロジェクトでは、多数の機能実装とテストコードが存在するものの、Kent Beck や和田卓人氏が推奨する本格的な **テスト駆動開発（TDD）** が実践されていない。

**現状の問題点**:

- 実装後にテストを書く「テストラスト」のアプローチが多い
- Red-Green-Refactor サイクルが遵守されていない
- テストコードが実装の品質保証ではなく、事後的な検証に留まっている
- リファクタリングの安全性が低い（テストがないため変更を躊躇する）

### 目的

本仕様の目的は、**TDD の 3 原則（Red-Green-Refactor）** を実践し、以下を達成すること。

1. **テストファースト原則の徹底**: 実装前に必ず失敗するテストを書く
2. **リファクタリングの安全性向上**: テストが品質を保証し、安心してコードを改善できる
3. **設計品質の向上**: テスタブルな設計を自然に導く
4. **ドキュメントとしてのテスト**: テストコードが仕様書として機能する

---

## 2. 対象ユーザー

- **cc-craft-kit 開発チーム全員**（開発者、メンテナー、コントリビューター）
- **Claude Code ユーザー**（TDD の実践例として参考にする）

---

## 3. 受け入れ基準

### 必須要件（TDD プロセスの遵守）

- [ ] すべての新機能・バグ修正において、実装前にテストを書いている
- [ ] コミット履歴で「テスト追加 → 実装 → リファクタリング」の順序が確認できる
- [ ] テストが失敗した状態で実装を開始していない（Red フェーズを確認できる）
- [ ] Red-Green-Refactor サイクルが最低 3 回以上実践されている

### 機能要件（テストの品質）

- [ ] すべてのテストが意図を明確に表現している（テスト名から何を検証しているか分かる）
- [ ] テストコードが実装コードと同等以上の品質である
- [ ] テストがフレームワークのベストプラクティスに従っている（Vitest の場合、`describe`, `it`, `expect` の適切な使用）
- [ ] テストケースがエッジケース、正常系、異常系を網羅している

### 非機能要件（継続的な品質保証）

- [ ] テストスイートが 10 秒以内に完了する（高速フィードバック）
- [ ] CI/CD パイプラインでテストが自動実行される
- [ ] テストカバレッジレポートが自動生成され、80% 以上を維持している
- [ ] カバレッジレポートが GitHub Actions の PR コメントに自動投稿される

---

## 4. 制約条件

- **テスティングフレームワーク**: Vitest（既存のまま変更しない）
- **カバレッジツール**: c8（Vitest に統合済み）
- **CI/CD**: GitHub Actions（既存のまま変更しない）
- **既存テストコードの互換性**: 既存のテストコードを破壊しない（段階的に TDD へ移行）
- **学習コスト**: TDD の学習に時間を要するため、段階的な導入を推奨

---

## 5. 依存関係

- **Vitest**: テスト実行とカバレッジレポート生成
- **GitHub Actions**: CI/CD パイプラインでの自動テスト実行
- **既存のテストコード**: `tests/` ディレクトリ配下のすべてのテストファイル
- **カバレッジレポート**: `npm run test:coverage` で生成される HTML レポート

---

## 6. 参考情報

### TDD 関連書籍

- Kent Beck『テスト駆動開発』（オーム社）
- 和田卓人『テスト駆動開発の実践』（技術評論社）
- Robert C. Martin『Clean Code』（アスキー・メディアワークス）

### TDD 関連記事・動画

- [和田卓人氏の TDD ライブコーディング - YouTube](https://www.youtube.com/watch?v=Q-FJ3XmFlT8)
- [TDD の 3 原則（Red-Green-Refactor）- Martin Fowler](https://martinfowler.com/bliki/TestDrivenDevelopment.html)

### テスティングフレームワーク

- [Vitest - Next Generation Testing Framework](https://vitest.dev/)
- [Vitest Best Practices](https://vitest.dev/guide/)

### カバレッジツール

- [c8 - Code Coverage Tool](https://github.com/bcoe/c8)
- [Istanbul - JavaScript Code Coverage](https://istanbul.js.org/)

---

## 7. テスト戦略（TDD 実践方針）

### Red-Green-Refactor サイクルの遵守

1. **Red（失敗するテストを書く）**:
   - 実装前に必ずテストを書く
   - テストが失敗することを確認する（`npm test` で Red を確認）
   - テスト名で何を検証するか明確に表現する

2. **Green（テストを通過する最小限のコードを書く）**:
   - テストを通過させるための最小限の実装をする
   - 過剰な実装をしない（YAGNI: You Aren't Gonna Need It）
   - すべてのテストが通過することを確認する

3. **Refactor（コードを改善する）**:
   - テストが通過した状態で、コードをリファクタリングする
   - リファクタリング後もテストが通過することを確認する
   - テストコード自体もリファクタリングの対象とする

### テストカバレッジ目標

- **ステートメントカバレッジ**: 80% 以上
- **ブランチカバレッジ**: 70% 以上
- **関数カバレッジ**: 90% 以上

### テストの種類

- **単体テスト（Unit Test）**: すべての関数・メソッドに対して作成
- **統合テスト（Integration Test）**: モジュール間の連携を検証
- **E2E テスト（End-to-End Test）**: 主要なユーザーフローを検証

---

## 8. TDD 実践チェックリスト

### コード作成前

- [ ] 要件を明確に理解している
- [ ] テストケースをリストアップしている
- [ ] エッジケース、正常系、異常系を洗い出している

### テスト作成時（Red フェーズ）

- [ ] テストが失敗することを確認した（Red）
- [ ] テスト名が要件を明確に表現している
- [ ] 1 つのテストが 1 つの観点のみを検証している
- [ ] テストコードが読みやすく、意図が明確である

### 実装時（Green フェーズ）

- [ ] テストを通過する最小限のコードを書いた（Green）
- [ ] すべてのテストが通過することを確認した
- [ ] 過剰な実装をしていない（YAGNI 原則を遵守）

### リファクタリング時（Refactor フェーズ）

- [ ] コードをリファクタリングした（Refactor）
- [ ] リファクタリング後もテストが通過することを確認した
- [ ] テストコード自体もリファクタリングした
- [ ] コードの可読性と保守性が向上した

### コミット時

- [ ] コミットメッセージに「Red → Green → Refactor」のサイクルを記録
- [ ] コミット履歴から TDD の実践が確認できる

---

## 9. 既存コードの TDD 適合性評価

### 評価対象

- [ ] `tests/` ディレクトリ配下のすべてのテストファイル
- [ ] テストカバレッジレポート（`npm run test:coverage`）

### 評価基準

1. **テストファースト原則**: Git コミット履歴から「テスト → 実装」の順序を確認
2. **テストの独立性**: 各テストが他のテストに依存していないか
3. **テストの可読性**: テスト名から意図が明確に分かるか
4. **カバレッジ**: 80% 以上を達成しているか

### 改善計画

- TDD 原則に違反している箇所をリストアップ
- 段階的に修正するタスクを作成
- 新規実装は必ず TDD で実施
