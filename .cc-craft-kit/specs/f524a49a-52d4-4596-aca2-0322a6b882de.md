# /cft:spec-phase <id> implementation において、実装が自動で実行されない

**仕様書 ID:** f524a49a-52d4-4596-aca2-0322a6b882de
**フェーズ:** implementation
**作成日時:** 2025/11/27 00:00:00
**更新日時:** 2025/11/27 10:45:00

---

## 1. 背景と目的

### 背景

`/cft:spec-phase <id> implementation` コマンドで implementation フェーズに移行した際、期待される自動実行処理（タスクリスト表示、型チェック、リント実行など）が実行されない問題が発生している。

現在の実装状況:
- `src/slash-commands/spec-phase.md` の implementation フェーズ定義は 4 行のみで、具体的なツール実行方法が記述されていない
- TypeScript 側（`phase-automation.ts`）はタスクリストの表示のみを実行
- design フェーズでは 168 行分の詳細指示があり、自動実行が正常に動作している

### 目的

implementation フェーズに移行した際に、以下の処理が自動的に実行されるようにする:
1. タスクリストの読み込みと TodoWrite での進捗管理開始
2. 型チェック・リント実行（typescript-eslint スキル）
3. チェック結果の表示とガイダンス

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発（SDD）を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-phase <id> implementation` 実行時に、タスクリストが TodoWrite ツールで自動表示される
- [ ] 型チェック・リント実行が自動的に行われ、結果が表示される

### 機能要件

- [ ] 仕様書の「## 8. 実装タスクリスト」セクションが Read ツールで読み込まれる
- [ ] TodoWrite ツールでタスクリストの進捗管理が開始される
- [ ] Skill ツールで `typescript-eslint` スキルが実行される
- [ ] エラーがある場合は警告メッセージが表示される
- [ ] エラーがない場合は成功メッセージと次のステップガイダンスが表示される

### 非機能要件

- [ ] CLAUDE.md のプロンプトファースト原則に従い、プロンプト定義（.md）で実装する
- [ ] design フェーズと同等の詳細さでプロンプト定義を記述する

---

## 4. 制約条件

- プロンプトファースト原則: Claude Code のツールで実現可能な処理はプロンプト（.md）で実装する
- 既存の TypeScript 実装（`phase-automation.ts`）との整合性を保つ
- 他のフェーズ（design, testing, completed）の動作に影響を与えない

---

## 5. 依存関係

- `src/slash-commands/spec-phase.md` - メインのスラッシュコマンド定義
- `src/core/workflow/phase-automation.ts` - TypeScript 側のフェーズ自動処理
- `.cc-craft-kit/slash-commands/spec-phase.md` - 同期先ファイル
- `typescript-eslint` スキル - 型チェック・リント実行

---

## 6. 参考情報

- design フェーズの実装パターン（spec-phase.md 行 187-333）
- CLAUDE.md のプロンプトファースト原則
- GitHub Issue: #394

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
┌─────────────────────────────────────────────────────────────────┐
│                  /cft:spec-phase <id> impl                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                Step 1-7: 共通処理（既存）                        │
│  - フェーズ正規化、ID解決、ブランチ切り替え                       │
│  - バリデーション、DB更新、Markdown更新、自動コミット             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│          Step 8: implementation フェーズ固有処理                 │
│                      【修正対象】                                │
├─────────────────────────────────────────────────────────────────┤
│  1. 実装タスクリスト読み込み（Read ツール）                       │
│  2. タスク解析・TodoWrite で進捗管理開始                         │
│  3. 設計詳細確認（7.2 実装方針の修正対象ファイル）               │
│  4. 型チェック・リント実行（typescript-eslint スキル）           │
│  5. 結果表示・ガイダンスメッセージ                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                Step 9: git status チェック（既存）               │
└─────────────────────────────────────────────────────────────────┘
```

#### 設計方針

プロンプトファースト原則に従い、implementation フェーズの自動実行処理はすべてプロンプト定義（.md）で実装する。

- **TypeScript 側（phase-automation.ts）**: 変更不要。現在のタスク表示機能はそのまま維持
- **プロンプト側（spec-phase.md）**: Step 8 の implementation セクションを拡張

#### 処理フロー詳細

```
implementation フェーズ移行時の処理フロー:

1. 仕様書から「## 8. 実装タスクリスト」を Read
       │
       ▼
2. タスクを解析し、TodoWrite で登録
   - 各タスクを pending 状態で登録
   - Phase 単位でグループ化
       │
       ▼
3. 「## 7. 設計詳細 → 7.2 実装方針」から修正対象ファイルを抽出
       │
       ▼
4. Skill ツールで typescript-eslint を実行
   - 型チェック（npx tsc --noEmit）
   - ESLint チェック（npm run lint）
       │
       ▼
5. 結果に応じたガイダンス表示
   ├── エラーあり → 警告メッセージ + 修正推奨
   └── エラーなし → 成功メッセージ + 次のステップ案内
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/slash-commands/spec-phase.md` | Step 8 の implementation セクションを拡張（4行 → 約60行） |
| `.cc-craft-kit/slash-commands/spec-phase.md` | `npm run sync:dogfood` で自動同期 |

#### 実装詳細

`src/slash-commands/spec-phase.md` の「#### implementation フェーズに移行した場合」セクション（行 171-176）を以下の構造に置き換える:

```markdown
#### implementation フェーズに移行した場合

1. **実装タスクリスト読み込み**:
   - Read ツールで仕様書（`$SPEC_PATH`）を読み込み
   - 「## 8. 実装タスクリスト」セクションを抽出
   - セクションが存在しない場合:
     ```
     ⚠️ 警告: 実装タスクリストが見つかりません

     design フェーズでタスクリストが生成されていない可能性があります。
     推奨アクション: /cft:spec-phase $SPEC_ID design を再実行
     ```
     **処理を中断**

2. **タスク解析・進捗管理開始**:
   - マークダウンのチェックボックス形式を解析
   - TodoWrite ツールでタスクリストを登録:
     - 完了済み（`- [x]`）: status = "completed"
     - 未完了（`- [ ]`）: status = "pending"
   - 最初の未完了タスクを in_progress に設定

3. **設計詳細確認**:
   - 「## 7. 設計詳細 → 7.2 実装方針 → 修正対象ファイル」を確認
   - 修正対象ファイルの一覧を表示

4. **型チェック・リント実行**:
   - Skill ツールで `typescript-eslint` スキルを実行

5. **結果表示・ガイダンス**:

   エラーがない場合:
   ```
   ✓ 実装フェーズを開始しました

   仕様書: $SPEC_NAME
   フェーズ: $CURRENT_PHASE → implementation

   タスク進捗: X/Y 完了

   修正対象ファイル:
   - [ファイル1]
   - [ファイル2]

   次のステップ:
   - タスク一覧確認: /cft:task-list $SPEC_ID
   - タスク開始: /cft:task-start <issue-number>
   - 実装完了後: /cft:spec-phase $SPEC_ID completed
   ```

   エラーがある場合:
   ```
   ⚠️ 実装フェーズを開始しましたが、コード品質に問題があります

   [typescript-eslint の出力結果]

   推奨アクション:
   - 型エラーを修正してから実装を開始してください
   - npm run lint:fix で自動修正可能なエラーを修正
   ```
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| タスクリスト読み込み | なし（TypeScript側で表示のみ） | Read ツールで読み込み | spec-phase.md |
| TodoWrite 登録 | なし | タスク解析 → TodoWrite 登録 | spec-phase.md |
| 設計詳細確認 | なし | 修正対象ファイル一覧表示 | spec-phase.md |
| 型チェック・リント | なし（プロンプト記載のみ） | Skill ツールで自動実行 | spec-phase.md |
| ガイダンス表示 | 簡潔（4行） | 詳細（エラー有無で分岐） | spec-phase.md |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| タスクリスト読み込み | 「## 8. 実装タスクリスト」が正しく抽出される | 手動テスト: 仕様書にセクションがある場合 |
| タスクリスト不在時 | 警告メッセージが表示され処理が中断される | 手動テスト: セクションを削除して実行 |
| TodoWrite 登録 | タスクが正しいステータスで登録される | 手動テスト: TodoWrite の出力確認 |
| typescript-eslint 実行 | Skill ツールが正しく呼び出される | 手動テスト: スキル実行ログ確認 |
| ガイダンス分岐 | エラー有無で適切なメッセージが表示される | 手動テスト: エラーあり/なしの両方で確認 |

### 7.5 移行計画

#### Phase 1: プロンプト定義の拡張

1. `src/slash-commands/spec-phase.md` の Step 8 implementation セクションを編集
2. 現在の 4 行を約 60 行の詳細定義に置き換え
3. design フェーズのパターンを参考に、各ステップで使用するツールを明示

#### Phase 2: 同期と動作確認

1. `npm run sync:dogfood` で `.cc-craft-kit/` に同期
2. テスト用の仕様書で `/cft:spec-phase <id> impl` を実行
3. 期待される自動実行が行われることを確認

---

## 8. 実装タスクリスト

### Phase 1: プロンプト定義の拡張

- [ ] `src/slash-commands/spec-phase.md` の implementation セクション（行 171-176）を特定
- [ ] 現在の 4 行の定義を削除
- [ ] 新しい詳細定義（約 60 行）を追加
  - [ ] 実装タスクリスト読み込み処理を追加
  - [ ] タスク解析・TodoWrite 登録処理を追加
  - [ ] 設計詳細確認処理を追加
  - [ ] typescript-eslint スキル実行処理を追加
  - [ ] エラー有無に応じたガイダンス表示を追加

### Phase 2: 同期と動作確認

- [ ] `npm run sync:dogfood` を実行して同期
- [ ] `npm run check:sync` で同期状態を確認
- [ ] 型チェック（`npm run typecheck`）を実行
- [ ] この仕様書で `/cft:spec-phase f524a49a impl` を実行して動作確認
