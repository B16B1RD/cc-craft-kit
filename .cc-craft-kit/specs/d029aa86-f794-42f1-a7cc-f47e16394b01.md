---
id: "d029aa86-f794-42f1-a7cc-f47e16394b01"
name: "ステータス更新の冪等性保証"
phase: "completed"
branch_name: "main"
github_issue_number: null
pr_url: null
created_at: "2025-11-18T15:07:08Z"
updated_at: "2025-11-19T12:24:14Z"
---

# ステータス更新の冪等性保証


## 1. 背景と目的

### 背景

フェーズ移行時に GitHub Projects のステータスを更新する処理（`src/core/workflow/github-integration.ts:246-268`）が正常に実行されても、実際には GitHub 側でステータスが更新されていない問題が発生しています。

**具体例:**

Issue #31「Sub Issue を活用」を completed フェーズに移行した際、以下の状況が発生しました:

1. `/cft:spec-phase 0fd42810 completed` 実行
2. イベントハンドラー内で `projects.updateProjectStatus()` を呼び出し
3. エラーは発生せず、正常終了したように見える
4. しかし、実際には GitHub Projects のステータスは「In Progress」のまま
5. 手動で API を呼び出すと正常に「Done」に更新される

この問題により、以下の課題が発生しています:

1. **状態の不整合** - データベース上のフェーズと GitHub Projects のステータスが一致しない
2. **手動修正の必要性** - フェーズ移行後に GitHub Projects を手動で確認・修正する必要がある
3. **信頼性の低下** - 自動化された処理が信頼できず、開発効率が低下

### 目的

フェーズ移行後に GitHub Projects のステータスが正しく更新されていることを自動検証し、以下を実現します:

1. **状態の整合性保証** - データベースと GitHub Projects のステータスを常に同期
2. **自動リトライ** - ステータス更新失敗時に自動的にリトライ
3. **エラー通知** - 更新失敗時にユーザーに明確に通知
4. **冪等性の保証** - 同じ操作を複数回実行しても安全
---

## 2. 対象ユーザー

- cc-craft-kit を使用して仕様駆動開発を行う開発者
- GitHub Projects でタスク管理を行うプロジェクトマネージャー
- フェーズ移行後に手動でステータスを確認・修正している開発者
---

## 3. 受け入れ基準

### 必須要件

- [ ] フェーズ移行後、GitHub Projects のステータスが正しく更新されていることを自動検証
- [ ] ステータスが期待値と異なる場合、最大 3 回までリトライ
- [ ] リトライ後も更新されない場合、エラーログを記録し、ユーザーに通知
- [ ] `/cft:spec-phase` コマンド実行後、「✓ Updated project status to "Done"」のようなメッセージを表示
- [ ] ステータス更新失敗時は「⚠ Failed to update project status after 3 retries」のようなメッセージを表示

### 機能要件

- [ ] `projects.updateProjectStatus()` 実行後、GitHub API で現在のステータスを取得して検証
- [ ] ステータスが期待値と一致しない場合、1 秒待機後にリトライ
- [ ] リトライは指数バックオフ（1 秒 → 2 秒 → 4 秒）で実行
- [ ] 検証失敗時のエラーは `logs` テーブルに記録
- [ ] 検証処理は非同期で実行し、フェーズ移行処理をブロックしない

### 非機能要件

- [ ] 検証処理がフェーズ移行のパフォーマンスに大きく影響しない（最大 10 秒以内）
- [ ] GitHub API のレート制限に配慮（検証は 1 回のみ、リトライ時のみ追加 API 呼び出し）
- [ ] ネットワークエラー時のタイムアウト処理（10 秒）
---

## 4. 制約条件

### GitHub API の制約

- GraphQL API でプロジェクトアイテムのステータスを取得する必要がある
- ステータス更新が即座に反映されない場合がある（最大 1-2 秒の遅延）
- レート制限: GraphQL API は 5,000 ポイント/時

### 既存コードの制約

- `src/core/workflow/github-integration.ts` のイベントハンドラー内で実装
- 既存の `projects.updateProjectStatus()` の動作を変更しない
- `resolveProjectId()` が null を返す場合は検証をスキップ
---

## 5. 依存関係

### 既存モジュール

- `src/integrations/github/projects.ts` - GitHubProjects クラス（ステータス更新・取得）
- `src/integrations/github/project-resolver.ts` - resolveProjectId 関数
- `src/integrations/github/phase-status-mapper.ts` - mapPhaseToStatus 関数
- `src/core/workflow/github-integration.ts` - spec.phase_changed イベントハンドラー
- `src/core/errors/error-handler.ts` - ErrorHandler クラス

### 新規実装が必要な機能

- `projects.getProjectItemStatus(owner, projectNumber, itemId)` - プロジェクトアイテムのステータス取得メソッド
- `verifyProjectStatusUpdate()` - ステータス更新検証＋リトライロジック

### 関連する仕様書

- Sub Issue を活用 (0fd42810) - この問題が発見されたきっかけ
- ログ記録の強化 (3534eb82) - エラーログの記録方法
---

## 6. 参考情報

### GitHub GraphQL API

プロジェクトアイテムのステータスを取得するクエリ:

```graphql
query getProjectItemStatus($itemId: ID!) {
  node(id: $itemId) {
    ... on ProjectV2Item {
      id
      fieldValues(first: 10) {
        nodes {
          ... on ProjectV2ItemFieldSingleSelectValue {
            name
            field {
              ... on ProjectV2SingleSelectField {
                name
              }
            }
          }
        }
      }
    }
  }
}
```

### 現在の問題箇所

- `src/core/workflow/github-integration.ts:246-268` - ステータス更新処理
- `src/integrations/github/projects.ts` - GitHubProjects クラス（ステータス取得メソッドが未実装）

### リトライロジックのベストプラクティス

- 指数バックオフ: 1 秒 → 2 秒 → 4 秒 → 8 秒
- 最大リトライ回数: 3 回
- タイムアウト: 各 API 呼び出しに 10 秒のタイムアウトを設定
- ジッター: リトライ間隔にランダムな遅延を追加（同時実行時の衝突回避）

### 実装例

```typescript
async function verifyAndRetryProjectStatusUpdate(
  projects: GitHubProjects,
  owner: string,
  projectNumber: number,
  itemId: string,
  expectedStatus: ProjectStatus,
  maxRetries: number = 3
): Promise<boolean> {
  for (let attempt = 0; attempt < maxRetries; attempt++) {
    // 1秒待機後にステータスを取得
    await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, attempt)));

    const currentStatus = await projects.getProjectItemStatus(owner, projectNumber, itemId);

    if (currentStatus === expectedStatus) {
      return true; // 成功
    }

    // リトライ
    await projects.updateProjectStatus({
      owner,
      projectNumber,
      itemId,
      status: expectedStatus,
    });
  }

  return false; // 失敗
}
```
---

## 7. アーキテクチャ設計

### 7.1 システムアーキテクチャ

ステータス更新検証機能は、既存の GitHub Projects 統合に組み込まれます。

```text
┌────────────────────────────────────────────────────────┐
│ Event Bus (spec.phase_changed)                        │
└────────────────┬───────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────┐
│ github-integration.ts (イベントハンドラー)              │
│  ├─ Issue 更新                                         │
│  ├─ ラベル更新                                         │
│  ├─ コメント追加                                       │
│  └─ Projects ステータス更新 ← 【ここを強化】           │
└────────────────┬───────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────┐
│ GitHubProjects クラス (projects.ts)                    │
│  ├─ updateProjectStatus() (既存)                       │
│  ├─ getProjectItemStatus() (新規)                      │
│  └─ verifyProjectStatusUpdate() (新規)                 │
└────────────────┬───────────────────────────────────────┘
                 │
                 ▼
┌────────────────────────────────────────────────────────┐
│ GitHub GraphQL API                                     │
│  ├─ updateProjectV2ItemFieldValue (更新)               │
│  └─ node(id: itemId) { fieldValues } (検証)            │
└────────────────────────────────────────────────────────┘
```

### 7.2 コンポーネント設計

#### 7.2.1 新規メソッド: `getProjectItemStatus()`

**責務**: プロジェクトアイテムの現在のステータスを取得する

**配置場所**: `src/integrations/github/projects.ts`

**シグネチャ**:
```typescript
async getProjectItemStatus(
  itemId: string
): Promise<ProjectStatus | null>
```

**実装方針**:
- GitHub GraphQL API の `node` クエリでアイテム情報を取得
- `fieldValues` から "Status" フィールドの値を抽出
- ステータス名を `ProjectStatus` 型にマッピング
- ステータスフィールドが見つからない場合は `null` を返す

#### 7.2.2 新規メソッド: `verifyProjectStatusUpdate()`

**責務**: ステータス更新後に検証し、必要に応じてリトライする

**配置場所**: `src/integrations/github/projects.ts`

**シグネチャ**:
```typescript
async verifyProjectStatusUpdate(params: {
  owner: string;
  projectNumber: number;
  itemId: string;
  expectedStatus: ProjectStatus;
  maxRetries?: number;
}): Promise<{
  success: boolean;
  actualStatus: ProjectStatus | null;
  attempts: number;
}>
```

**実装方針**:
- 指数バックオフでリトライ（1 秒 → 2 秒 → 4 秒）
- 各リトライ前に `getProjectItemStatus()` で現在値を確認
- 期待値と一致すれば成功、一致しなければ `updateProjectStatus()` を再実行
- 最大リトライ回数後も不一致の場合は失敗を返す

#### 7.2.3 イベントハンドラーの改修

**配置場所**: `src/core/workflow/github-integration.ts:246-268`

**変更内容**:
1. 既存の `updateProjectStatus()` 呼び出し後に `verifyProjectStatusUpdate()` を追加
2. 検証結果に応じてログ出力とユーザー通知
3. 非同期処理として実行し、フェーズ移行をブロックしない

**疑似コード**:
```typescript
// 既存: ステータス更新
await projects.updateProjectStatus({
  owner: githubConfig.owner,
  projectNumber: projectId.projectNumber,
  itemId: projectId.itemId,
  status: mapPhaseToStatus(event.data.newPhase),
});

// 新規: 検証＋リトライ
const verification = await projects.verifyProjectStatusUpdate({
  owner: githubConfig.owner,
  projectNumber: projectId.projectNumber,
  itemId: projectId.itemId,
  expectedStatus: mapPhaseToStatus(event.data.newPhase),
  maxRetries: 3,
});

if (verification.success) {
  console.log(`✓ Updated project status to "${verification.actualStatus}"`);
} else {
  console.warn(
    `⚠ Failed to update project status after ${verification.attempts} retries. ` +
    `Expected: "${mapPhaseToStatus(event.data.newPhase)}", ` +
    `Actual: "${verification.actualStatus}"`
  );
  await logError('warn', 'Project status update verification failed', {
    specId: event.entityId,
    expectedStatus: mapPhaseToStatus(event.data.newPhase),
    actualStatus: verification.actualStatus,
    attempts: verification.attempts,
  });
}
```

### 7.3 データフロー

```text
1. ユーザー: /cft:spec-phase <spec-id> completed
         ↓
2. フェーズ更新処理: データベース更新
         ↓
3. イベント発火: spec.phase_changed
         ↓
4. イベントハンドラー:
   - Issue 更新
   - ラベル更新
   - Projects ステータス更新
         ↓
5. updateProjectStatus(): GraphQL mutation 実行
         ↓
6. verifyProjectStatusUpdate():
   - 1秒待機
   - getProjectItemStatus() でステータス取得
   - 期待値と比較
         ↓
7-a. 一致した場合:
   - ✓ Updated project status to "Done"
   - 成功ログ記録
         ↓
7-b. 不一致の場合:
   - リトライ実行 (最大3回)
   - 最終的に不一致:
     - ⚠ Failed to update project status
     - エラーログ記録
```

### 7.4 エラーハンドリング戦略

| エラー種別 | 対応 | ログレベル | ユーザー通知 |
|---|---|---|---|
| GitHub API タイムアウト | リトライ（最大3回） | warn | リトライ中のメッセージ表示 |
| ネットワークエラー | リトライ（最大3回） | warn | リトライ中のメッセージ表示 |
| レート制限エラー | 即座に失敗、リトライしない | error | エラーメッセージ表示 |
| ステータスフィールド未存在 | 検証スキップ | warn | 警告メッセージ表示 |
| 最終リトライ後も不一致 | 失敗を記録、処理は継続 | error | エラーメッセージ表示 |

### 7.5 パフォーマンス設計

#### API 呼び出し回数

**成功ケース（初回で成功）**:
- `updateProjectStatus()`: 1 回（既存）
- `getProjectItemStatus()`: 1 回（新規）
- **合計**: 2 回の GraphQL API 呼び出し

**リトライケース（3回リトライ）**:
- `updateProjectStatus()`: 4 回（初回 + リトライ 3 回）
- `getProjectItemStatus()`: 3 回（検証 3 回）
- **合計**: 7 回の GraphQL API 呼び出し

#### レート制限への影響

- GraphQL API: 5,000 ポイント/時
- 1 回のクエリ: 約 1-2 ポイント消費
- フェーズ移行 1 回あたり: 2-14 ポイント消費（成功〜失敗ケース）
- **影響**: 軽微（1 時間に数 100 回のフェーズ移行が可能）

#### 待機時間

- 成功ケース: 約 1-2 秒（GitHub API 応答時間 + 1 秒待機）
- リトライケース: 約 8-10 秒（1 秒 + 2 秒 + 4 秒 + API 応答時間）
- **ユーザー体験への影響**: 非同期処理のため、フェーズ移行自体はブロックされない
---

## 8. API設計

### 8.1 新規メソッド詳細仕様

#### 8.1.1 `getProjectItemStatus(itemId: string)`

**目的**: プロジェクトアイテムの現在のステータスを取得する

**パラメータ**:
- `itemId` (string, 必須): プロジェクトアイテムの GraphQL Node ID

**戻り値**:
```typescript
Promise<ProjectStatus | null>
```
- `ProjectStatus`: "Todo" | "In Progress" | "Done"
- `null`: ステータスフィールドが見つからない場合

**GraphQL クエリ**:
```graphql
query getProjectItemStatus($itemId: ID!) {
  node(id: $itemId) {
    ... on ProjectV2Item {
      id
      fieldValues(first: 20) {
        nodes {
          ... on ProjectV2ItemFieldSingleSelectValue {
            name
            field {
              ... on ProjectV2SingleSelectField {
                name
              }
            }
          }
        }
      }
    }
  }
}
```

**実装例**:
```typescript
async getProjectItemStatus(itemId: string): Promise<ProjectStatus | null> {
  const query = `
    query getProjectItemStatus($itemId: ID!) {
      node(id: $itemId) {
        ... on ProjectV2Item {
          id
          fieldValues(first: 20) {
            nodes {
              ... on ProjectV2ItemFieldSingleSelectValue {
                name
                field {
                  ... on ProjectV2SingleSelectField {
                    name
                  }
                }
              }
            }
          }
        }
      }
    }
  `;

  const result = await this.client.query<{
    node: {
      id: string;
      fieldValues: {
        nodes: Array<{
          name: string;
          field: { name: string };
        }>;
      };
    };
  }>(query, { itemId });

  // "Status" フィールドを検索
  const statusField = result.node.fieldValues.nodes.find(
    (fv) => fv.field.name === 'Status'
  );

  if (!statusField) {
    return null;
  }

  // ステータス名を ProjectStatus 型にマッピング
  const statusName = statusField.name;
  if (statusName === 'Todo' || statusName === 'In Progress' || statusName === 'Done') {
    return statusName;
  }

  return null;
}
```

**エラーハンドリング**:
- GraphQL API エラー: 例外をスローせず、`null` を返す
- `node` が存在しない: `null` を返す
- `fieldValues` が空: `null` を返す

#### 8.1.2 `verifyProjectStatusUpdate(params)`

**目的**: ステータス更新後に検証し、必要に応じてリトライする

**パラメータ**:
```typescript
interface VerifyProjectStatusParams {
  owner: string;          // GitHub owner (user/org)
  projectNumber: number;  // プロジェクト番号
  itemId: string;         // プロジェクトアイテム ID
  expectedStatus: ProjectStatus;  // 期待するステータス
  maxRetries?: number;    // 最大リトライ回数（デフォルト: 3）
}
```

**戻り値**:
```typescript
interface VerifyProjectStatusResult {
  success: boolean;                // 検証成功フラグ
  actualStatus: ProjectStatus | null;  // 実際のステータス
  attempts: number;                // 試行回数
}
```

**実装例**:
```typescript
async verifyProjectStatusUpdate(
  params: VerifyProjectStatusParams
): Promise<VerifyProjectStatusResult> {
  const maxRetries = params.maxRetries ?? 3;
  let attempts = 0;

  for (let i = 0; i <= maxRetries; i++) {
    attempts++;

    // 指数バックオフで待機（初回は1秒、2回目は2秒、3回目は4秒）
    const waitTime = i === 0 ? 1000 : 1000 * Math.pow(2, i - 1);
    await new Promise((resolve) => setTimeout(resolve, waitTime));

    // 現在のステータスを取得
    const actualStatus = await this.getProjectItemStatus(params.itemId);

    if (actualStatus === params.expectedStatus) {
      return { success: true, actualStatus, attempts };
    }

    // 最後のリトライでない場合は再度ステータス更新
    if (i < maxRetries) {
      await this.updateProjectStatus({
        owner: params.owner,
        projectNumber: params.projectNumber,
        itemId: params.itemId,
        status: params.expectedStatus,
      });
    }
  }

  // 最終的に失敗
  const finalStatus = await this.getProjectItemStatus(params.itemId);
  return { success: false, actualStatus: finalStatus, attempts };
}
```

**エラーハンドリング**:
- `getProjectItemStatus()` が `null` を返す場合: リトライを継続
- `updateProjectStatus()` が例外をスローした場合: 例外を再スロー
- レート制限エラー: 例外を再スロー（リトライしない）

### 8.2 既存メソッドの変更

#### 8.2.1 `updateProjectStatus()`

**変更なし**: 既存の動作を維持します。

**理由**:
- 検証機能は `verifyProjectStatusUpdate()` に分離
- 既存コードとの後方互換性を維持

### 8.3 型定義

#### 8.3.1 既存型の再利用

```typescript
// src/integrations/github/phase-status-mapper.ts
export type ProjectStatus = 'Todo' | 'In Progress' | 'Done';
```

#### 8.3.2 新規型定義

```typescript
// src/integrations/github/projects.ts に追加

/**
 * ステータス検証パラメータ
 */
export interface VerifyProjectStatusParams {
  owner: string;
  projectNumber: number;
  itemId: string;
  expectedStatus: ProjectStatus;
  maxRetries?: number;
}

/**
 * ステータス検証結果
 */
export interface VerifyProjectStatusResult {
  success: boolean;
  actualStatus: ProjectStatus | null;
  attempts: number;
}
```
---

## 9. データモデル設計

この機能はデータベーススキーマの変更を伴いません。すべての処理はメモリ内と GitHub API 上で完結します。

### 9.1 影響を受けるテーブル

#### `logs` テーブル

検証失敗時のエラーログを記録します。

**使用例**:
```typescript
await logError('warn', 'Project status update verification failed', {
  specId: event.entityId,
  expectedStatus: 'Done',
  actualStatus: 'In Progress',
  attempts: 3,
});
```

**記録される情報**:
- `level`: 'warn' または 'error'
- `message`: 'Project status update verification failed'
- `context`: JSON 形式のコンテキスト情報
  - `specId`: 仕様書 ID
  - `expectedStatus`: 期待するステータス
  - `actualStatus`: 実際のステータス
  - `attempts`: 試行回数

### 9.2 メモリ内データ構造

#### リトライ状態管理

リトライループ内で以下の状態を保持します:

```typescript
interface RetryState {
  attempts: number;           // 現在の試行回数
  currentStatus: ProjectStatus | null;  // 現在のステータス
  lastError: Error | null;    // 最後に発生したエラー
}
```
---

## 10. シーケンス図

### 10.1 成功ケース（初回で成功）

```text
ユーザー                     spec-phase.ts              github-integration.ts    GitHubProjects
  │                              │                           │                      │
  │ /cft:spec-phase xxx completed│                           │                      │
  ├─────────────────────────────>│                           │                      │
  │                              │ フェーズ更新               │                      │
  │                              │ (DB + ファイル)            │                      │
  │                              │                           │                      │
  │                              │ spec.phase_changed イベント発火                    │
  │                              ├──────────────────────────>│                      │
  │                              │                           │                      │
  │                              │                           │ updateProjectStatus()│
  │                              │                           ├─────────────────────>│
  │                              │                           │                      │ GraphQL mutation
  │                              │                           │<─────────────────────┤ (成功)
  │                              │                           │                      │
  │                              │                           │ 1秒待機              │
  │                              │                           │                      │
  │                              │                           │ getProjectItemStatus()│
  │                              │                           ├─────────────────────>│
  │                              │                           │                      │ GraphQL query
  │                              │                           │<─────────────────────┤ status: "Done"
  │                              │                           │                      │
  │                              │                           │ 検証: "Done" == "Done"
  │                              │                           │ ✓ 成功               │
  │                              │                           │                      │
  │<─ ✓ Updated project status to "Done" ─────────────────────┤                      │
  │                              │                           │                      │
```

### 10.2 リトライケース（2回目で成功）

```text
ユーザー                     spec-phase.ts              github-integration.ts    GitHubProjects
  │                              │                           │                      │
  │ /cft:spec-phase xxx completed│                           │                      │
  ├─────────────────────────────>│                           │                      │
  │                              │ フェーズ更新               │                      │
  │                              │                           │                      │
  │                              │ spec.phase_changed イベント発火                    │
  │                              ├──────────────────────────>│                      │
  │                              │                           │                      │
  │                              │                           │ updateProjectStatus()│
  │                              │                           ├─────────────────────>│
  │                              │                           │<─────────────────────┤ (成功)
  │                              │                           │                      │
  │                              │                           │ 1秒待機              │
  │                              │                           │                      │
  │                              │                           │ getProjectItemStatus()│
  │                              │                           ├─────────────────────>│
  │                              │                           │<─────────────────────┤ status: "In Progress"
  │                              │                           │                      │
  │                              │                           │ 検証: "In Progress" != "Done"
  │                              │                           │ ✗ 失敗 → リトライ    │
  │                              │                           │                      │
  │                              │                           │ updateProjectStatus()│
  │                              │                           ├─────────────────────>│
  │                              │                           │<─────────────────────┤ (成功)
  │                              │                           │                      │
  │                              │                           │ 2秒待機              │
  │                              │                           │                      │
  │                              │                           │ getProjectItemStatus()│
  │                              │                           ├─────────────────────>│
  │                              │                           │<─────────────────────┤ status: "Done"
  │                              │                           │                      │
  │                              │                           │ 検証: "Done" == "Done"
  │                              │                           │ ✓ 成功（2回目）      │
  │                              │                           │                      │
  │<─ ✓ Updated project status to "Done" (2 attempts) ────────┤                      │
  │                              │                           │                      │
```

### 10.3 失敗ケース（3回リトライ後も失敗）

```text
ユーザー                     spec-phase.ts              github-integration.ts    GitHubProjects    logs
  │                              │                           │                      │             │
  │ /cft:spec-phase xxx completed│                           │                      │             │
  ├─────────────────────────────>│                           │                      │             │
  │                              │ フェーズ更新               │                      │             │
  │                              │                           │                      │             │
  │                              │ spec.phase_changed イベント発火                    │             │
  │                              ├──────────────────────────>│                      │             │
  │                              │                           │                      │             │
  │                              │                           │ updateProjectStatus()│             │
  │                              │                           ├─────────────────────>│             │
  │                              │                           │<─────────────────────┤ (成功)      │
  │                              │                           │                      │             │
  │                              │                           │ 1秒 → 2秒 → 4秒待機  │             │
  │                              │                           │ 3回リトライ          │             │
  │                              │                           │ すべて失敗           │             │
  │                              │                           │                      │             │
  │                              │                           │ logError()           │             │
  │                              │                           ├────────────────────────────────────>│
  │                              │                           │                      │             │
  │<─ ⚠ Failed to update project status after 3 retries ──────┤                      │             │
  │    Expected: "Done", Actual: "In Progress"                │                      │             │
  │                              │                           │                      │             │
```
---

## 11. エラーハンドリング詳細設計

### 11.1 エラー分類と対処方針

| エラー種別 | HTTP/GraphQL エラー | 対処方針 | リトライ | ログレベル |
|---|---|---|---|---|
| **ネットワークエラー** | ENOTFOUND, ETIMEDOUT | リトライ（最大3回） | ✓ | warn |
| **GitHub API タイムアウト** | Request timeout | リトライ（最大3回） | ✓ | warn |
| **レート制限エラー** | 403 rate limit exceeded | 即座に失敗 | ✗ | error |
| **認証エラー** | 401 Unauthorized | 即座に失敗 | ✗ | error |
| **ステータスフィールド未存在** | - | 検証スキップ | ✗ | warn |
| **プロジェクトアイテム未存在** | 404 Not Found | 即座に失敗 | ✗ | error |
| **検証失敗（3回リトライ後）** | - | エラーログ記録 | - | error |

### 11.2 エラーハンドリング実装例

#### 11.2.1 `getProjectItemStatus()` のエラーハンドリング

```typescript
async getProjectItemStatus(itemId: string): Promise<ProjectStatus | null> {
  try {
    const query = `...`;
    const result = await this.client.query(query, { itemId });

    const statusField = result.node.fieldValues.nodes.find(
      (fv) => fv.field.name === 'Status'
    );

    if (!statusField) {
      // ステータスフィールドが見つからない場合
      return null;
    }

    const statusName = statusField.name;
    if (statusName === 'Todo' || statusName === 'In Progress' || statusName === 'Done') {
      return statusName;
    }

    return null;
  } catch (error) {
    // GraphQL API エラーの場合、null を返す
    console.warn('Failed to get project item status:', error);
    return null;
  }
}
```

#### 11.2.2 `verifyProjectStatusUpdate()` のエラーハンドリング

```typescript
async verifyProjectStatusUpdate(
  params: VerifyProjectStatusParams
): Promise<VerifyProjectStatusResult> {
  const maxRetries = params.maxRetries ?? 3;
  let attempts = 0;

  for (let i = 0; i <= maxRetries; i++) {
    attempts++;

    const waitTime = i === 0 ? 1000 : 1000 * Math.pow(2, i - 1);
    await new Promise((resolve) => setTimeout(resolve, waitTime));

    try {
      const actualStatus = await this.getProjectItemStatus(params.itemId);

      if (actualStatus === params.expectedStatus) {
        return { success: true, actualStatus, attempts };
      }

      if (i < maxRetries) {
        await this.updateProjectStatus({
          owner: params.owner,
          projectNumber: params.projectNumber,
          itemId: params.itemId,
          status: params.expectedStatus,
        });
      }
    } catch (error) {
      // レート制限エラーの場合は即座に失敗
      if (error instanceof Error && error.message.includes('rate limit')) {
        throw error;
      }

      // その他のエラーはリトライを継続
      console.warn(`Retry attempt ${attempts} failed:`, error);
    }
  }

  // 最終的に失敗
  const finalStatus = await this.getProjectItemStatus(params.itemId);
  return { success: false, actualStatus: finalStatus, attempts };
}
```

#### 11.2.3 イベントハンドラーのエラーハンドリング

```typescript
// src/core/workflow/github-integration.ts

try {
  const verification = await projects.verifyProjectStatusUpdate({
    owner: githubConfig.owner,
    projectNumber: projectId.projectNumber,
    itemId: projectId.itemId,
    expectedStatus: mapPhaseToStatus(event.data.newPhase),
    maxRetries: 3,
  });

  if (verification.success) {
    console.log(
      `✓ Updated project status to "${verification.actualStatus}" (${verification.attempts} attempts)`
    );
  } else {
    console.warn(
      `⚠ Failed to update project status after ${verification.attempts} retries. ` +
      `Expected: "${mapPhaseToStatus(event.data.newPhase)}", ` +
      `Actual: "${verification.actualStatus}"`
    );

    await logError('error', 'Project status update verification failed', {
      specId: event.entityId,
      expectedStatus: mapPhaseToStatus(event.data.newPhase),
      actualStatus: verification.actualStatus,
      attempts: verification.attempts,
    });
  }
} catch (error) {
  // レート制限エラー、認証エラーなどの致命的なエラー
  console.error('Failed to verify project status update:', error);
  await logError('error', 'Project status update verification error', {
    specId: event.entityId,
    error: error instanceof Error ? error.message : String(error),
  });
}
```

### 11.3 ユーザー通知メッセージ

#### 成功時

```text
✓ Updated project status to "Done"
```

#### リトライ成功時

```text
✓ Updated project status to "Done" (2 attempts)
```

#### 失敗時

```text
⚠ Failed to update project status after 3 retries.
Expected: "Done", Actual: "In Progress"
Please check GitHub Projects manually.
```

#### レート制限エラー

```text
⚠ GitHub API rate limit exceeded.
Status update will be retried after reset.
```
---

## 12. 実装タスクリスト

### タスク概要

受け入れ基準と設計仕様を元に、以下の実装タスクに分解しました。各タスクは可能な限り独立して実行可能です。

### タスク一覧

| # | タスク | ステータス | 優先度 | 見積もり工数 | 依存関係 |
|---|---|---|---|---|---|
| 1 | `GitHubProjects.getProjectItemStatus()` メソッドを実装 | 未着手 | 高 | 2時間 | なし |
| 2 | 型定義を追加 (`VerifyProjectStatusParams`, `VerifyProjectStatusResult`) | 未着手 | 高 | 30分 | なし |
| 3 | `GitHubProjects.verifyProjectStatusUpdate()` メソッドを実装 | 未着手 | 高 | 3時間 | タスク 1, 2 |
| 4 | `github-integration.ts` のイベントハンドラーに検証ロジックを統合 | 未着手 | 高 | 1.5時間 | タスク 3 |
| 5 | エラーハンドリングとユーザー通知メッセージを実装 | 未着手 | 高 | 1時間 | タスク 4 |
| 6 | 単体テストを作成 (`getProjectItemStatus`, `verifyProjectStatusUpdate`) | 未着手 | 高 | 3時間 | タスク 1, 3 |
| 7 | 統合テストを作成 (フェーズ移行時の検証フロー全体) | 未着手 | 中 | 2時間 | タスク 4, 5 |
| 8 | ドキュメントを更新 (CLAUDE.md, ARCHITECTURE.md) | 未着手 | 低 | 1時間 | タスク 5 |

**合計見積もり工数**: 約 14 時間
---

### タスク詳細

#### タスク 1: `GitHubProjects.getProjectItemStatus()` メソッドを実装

**ファイル**: `src/integrations/github/projects.ts`

**実装内容**:

```typescript
/**
 * プロジェクトアイテムの現在のステータスを取得
 */
async getProjectItemStatus(itemId: string): Promise<ProjectStatus | null> {
  try {
    const query = `
      query getProjectItemStatus($itemId: ID!) {
        node(id: $itemId) {
          ... on ProjectV2Item {
            id
            fieldValues(first: 20) {
              nodes {
                ... on ProjectV2ItemFieldSingleSelectValue {
                  name
                  field {
                    ... on ProjectV2SingleSelectField {
                      name
                    }
                  }
                }
              }
            }
          }
        }
      }
    `;

    const result = await this.client.query<{
      node: {
        id: string;
        fieldValues: {
          nodes: Array<{
            name: string;
            field: { name: string };
          }>;
        };
      };
    }>(query, { itemId });

    // "Status" フィールドを検索
    const statusField = result.node.fieldValues.nodes.find(
      (fv) => fv.field.name === 'Status'
    );

    if (!statusField) {
      return null;
    }

    // ステータス名を ProjectStatus 型にマッピング
    const statusName = statusField.name;
    if (statusName === 'Todo' || statusName === 'In Progress' || statusName === 'Done') {
      return statusName;
    }

    return null;
  } catch (error) {
    console.warn('Failed to get project item status:', error);
    return null;
  }
}
```

**テスト内容**:
- 正常ケース: ステータスが "Todo", "In Progress", "Done" のいずれかを返す
- エラーケース: GraphQL API エラー時に `null` を返す
- エラーケース: ステータスフィールドが存在しない場合に `null` を返す
---

#### タスク 2: 型定義を追加

**ファイル**: `src/integrations/github/projects.ts`

**実装内容**:

```typescript
/**
 * ステータス検証パラメータ
 */
export interface VerifyProjectStatusParams {
  owner: string;
  projectNumber: number;
  itemId: string;
  expectedStatus: ProjectStatus;
  maxRetries?: number;
}

/**
 * ステータス検証結果
 */
export interface VerifyProjectStatusResult {
  success: boolean;
  actualStatus: ProjectStatus | null;
  attempts: number;
}
```

**テスト内容**:
- 型定義が正しくエクスポートされることを確認
---

#### タスク 3: `GitHubProjects.verifyProjectStatusUpdate()` メソッドを実装

**ファイル**: `src/integrations/github/projects.ts`

**実装内容**:

```typescript
/**
 * ステータス更新後に検証し、必要に応じてリトライする
 */
async verifyProjectStatusUpdate(
  params: VerifyProjectStatusParams
): Promise<VerifyProjectStatusResult> {
  const maxRetries = params.maxRetries ?? 3;
  let attempts = 0;

  for (let i = 0; i <= maxRetries; i++) {
    attempts++;

    // 指数バックオフで待機（初回は1秒、2回目は2秒、3回目は4秒）
    const waitTime = i === 0 ? 1000 : 1000 * Math.pow(2, i - 1);
    await new Promise((resolve) => setTimeout(resolve, waitTime));

    try {
      const actualStatus = await this.getProjectItemStatus(params.itemId);

      if (actualStatus === params.expectedStatus) {
        return { success: true, actualStatus, attempts };
      }

      // 最後のリトライでない場合は再度ステータス更新
      if (i < maxRetries) {
        await this.updateProjectStatus({
          owner: params.owner,
          projectNumber: params.projectNumber,
          itemId: params.itemId,
          status: params.expectedStatus,
        });
      }
    } catch (error) {
      // レート制限エラーの場合は即座に失敗
      if (error instanceof Error && error.message.includes('rate limit')) {
        throw error;
      }

      // その他のエラーはリトライを継続
      console.warn(`Retry attempt ${attempts} failed:`, error);
    }
  }

  // 最終的に失敗
  const finalStatus = await this.getProjectItemStatus(params.itemId);
  return { success: false, actualStatus: finalStatus, attempts };
}
```

**テスト内容**:
- 成功ケース: 初回で期待値と一致する場合
- リトライケース: 2 回目で一致する場合
- 失敗ケース: 3 回リトライ後も不一致の場合
- エラーケース: レート制限エラー時に即座に例外をスロー
---

#### タスク 4: `github-integration.ts` のイベントハンドラーに検証ロジックを統合

**ファイル**: `src/core/workflow/github-integration.ts`

**実装内容**:

既存の `spec.phase_changed` イベントハンドラー内で、`projects.updateProjectStatus()` の後に検証ロジックを追加します。

```typescript
// 既存: ステータス更新
await projects.updateProjectStatus({
  owner: githubConfig.owner,
  projectNumber: projectId.projectNumber,
  itemId: projectId.itemId,
  status: mapPhaseToStatus(event.data.newPhase),
});

// 新規: 検証＋リトライ
const verification = await projects.verifyProjectStatusUpdate({
  owner: githubConfig.owner,
  projectNumber: projectId.projectNumber,
  itemId: projectId.itemId,
  expectedStatus: mapPhaseToStatus(event.data.newPhase),
  maxRetries: 3,
});

if (verification.success) {
  console.log(
    `✓ Updated project status to "${verification.actualStatus}"` +
    (verification.attempts > 1 ? ` (${verification.attempts} attempts)` : '')
  );
} else {
  console.warn(
    `⚠ Failed to update project status after ${verification.attempts} retries. ` +
    `Expected: "${mapPhaseToStatus(event.data.newPhase)}", ` +
    `Actual: "${verification.actualStatus}"`
  );

  await logError('error', 'Project status update verification failed', {
    specId: event.entityId,
    expectedStatus: mapPhaseToStatus(event.data.newPhase),
    actualStatus: verification.actualStatus,
    attempts: verification.attempts,
  });
}
```

**テスト内容**:
- フェーズ移行時に検証ロジックが実行されることを確認
- 検証成功時に適切なメッセージが表示されることを確認
- 検証失敗時にエラーログが記録されることを確認
---

#### タスク 5: エラーハンドリングとユーザー通知メッセージを実装

**ファイル**: `src/core/workflow/github-integration.ts`

**実装内容**:

```typescript
try {
  const verification = await projects.verifyProjectStatusUpdate({
    owner: githubConfig.owner,
    projectNumber: projectId.projectNumber,
    itemId: projectId.itemId,
    expectedStatus: mapPhaseToStatus(event.data.newPhase),
    maxRetries: 3,
  });

  if (verification.success) {
    console.log(
      `✓ Updated project status to "${verification.actualStatus}"` +
      (verification.attempts > 1 ? ` (${verification.attempts} attempts)` : '')
    );
  } else {
    console.warn(
      `⚠ Failed to update project status after ${verification.attempts} retries.\n` +
      `Expected: "${mapPhaseToStatus(event.data.newPhase)}", ` +
      `Actual: "${verification.actualStatus}"\n` +
      `Please check GitHub Projects manually.`
    );

    await logError('error', 'Project status update verification failed', {
      specId: event.entityId,
      expectedStatus: mapPhaseToStatus(event.data.newPhase),
      actualStatus: verification.actualStatus,
      attempts: verification.attempts,
    });
  }
} catch (error) {
  // レート制限エラー、認証エラーなどの致命的なエラー
  if (error instanceof Error && error.message.includes('rate limit')) {
    console.warn(
      `⚠ GitHub API rate limit exceeded.\n` +
      `Status update will be retried after reset.`
    );
  } else {
    console.error('Failed to verify project status update:', error);
  }

  await logError('error', 'Project status update verification error', {
    specId: event.entityId,
    error: error instanceof Error ? error.message : String(error),
  });
}
```

**テスト内容**:
- 成功時のメッセージが正しく表示されることを確認
- 失敗時のメッセージが正しく表示されることを確認
- レート制限エラー時の特別なメッセージが表示されることを確認
---

#### タスク 6: 単体テストを作成

**ファイル**: `tests/integrations/github/projects.test.ts`

**テスト内容**:

1. `getProjectItemStatus()` のテスト:
   - 正常ケース: ステータスが "Todo" を返す
   - 正常ケース: ステータスが "In Progress" を返す
   - 正常ケース: ステータスが "Done" を返す
   - エラーケース: ステータスフィールドが存在しない場合に `null` を返す
   - エラーケース: GraphQL API エラー時に `null` を返す

2. `verifyProjectStatusUpdate()` のテスト:
   - 成功ケース: 初回で期待値と一致する場合 (`success: true`, `attempts: 1`)
   - リトライケース: 2 回目で一致する場合 (`success: true`, `attempts: 2`)
   - リトライケース: 3 回目で一致する場合 (`success: true`, `attempts: 3`)
   - 失敗ケース: 3 回リトライ後も不一致の場合 (`success: false`, `attempts: 4`)
   - エラーケース: レート制限エラー時に即座に例外をスロー
   - エラーケース: 認証エラー時に即座に例外をスロー
---

#### タスク 7: 統合テストを作成

**ファイル**: `tests/e2e/phase-transition-verification.test.ts`

**テスト内容**:

1. フェーズ移行時の検証フロー全体をテスト:
   - 仕様書作成 → GitHub Issue 作成 → Projects 追加
   - フェーズを `completed` に移行
   - ステータスが "Done" に更新されることを確認
   - 検証成功メッセージが表示されることを確認

2. リトライケースのテスト:
   - GitHub API をモックして、1 回目は "In Progress"、2 回目は "Done" を返す
   - フェーズを `completed` に移行
   - リトライが実行されることを確認
   - 検証成功メッセージに "2 attempts" が含まれることを確認

3. 失敗ケースのテスト:
   - GitHub API をモックして、常に "In Progress" を返す
   - フェーズを `completed` に移行
   - エラーログが記録されることを確認
   - 失敗メッセージが表示されることを確認
---

#### タスク 8: ドキュメントを更新

**ファイル**: `CLAUDE.md`, `ARCHITECTURE.md`

**更新内容**:

1. `CLAUDE.md`:
   - GitHub 統合セクションに検証機能の説明を追加
   - トラブルシューティングセクションにステータス更新失敗時の対処法を追加

2. `ARCHITECTURE.md`:
   - イベント駆動アーキテクチャセクションにステータス検証の説明を追加
   - GitHub 統合の仕組みセクションに検証＋リトライの詳細を追加
---

### 実装順序

1. **タスク 1, 2** (並行実行可能): 基本メソッドと型定義を実装
2. **タスク 3**: 検証メソッドを実装
3. **タスク 4, 5** (順次実行): イベントハンドラーに統合し、エラーハンドリングを追加
4. **タスク 6, 7** (並行実行可能): テストを作成
5. **タスク 8**: ドキュメントを更新

### テスト戦略

- 単体テストでは GitHub API をモック化
- 統合テストでは実際のイベントバスを使用
- E2E テストではデータベースも含めた全体フローをテスト

### 品質チェックポイント

- [ ] すべての単体テストが合格
- [ ] すべての統合テストが合格
- [ ] TypeScript コンパイルエラーがゼロ
- [ ] ESLint 警告がゼロ
- [ ] テストカバレッジが 80%以上
