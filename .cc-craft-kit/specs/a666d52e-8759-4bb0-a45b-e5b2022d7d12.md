# /cft:spec-create 時の元のブランチに戻るタイミングがおかしい

**仕様書 ID:** a666d52e-8759-4bb0-a45b-e5b2022d7d12
**フェーズ:** completed
**作成日時:** 2025/11/22 22:00:15
**更新日時:** 2025/11/22 22:21:34

---

## 1. 背景と目的

### 背景

/cft:spec-create でブランチ作成後、すぐに元のブランチに戻ってしまう。その後仕様書を作成しようとするのでおかしなことになる。元のブランチに戻るのは、仕様書を作成し、適切にコミットした後にするべき。

### 目的

仕様書作成時のブランチ切り替えタイミングを修正し、Git 自動コミットが正常に実行されるようにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用するすべての開発者。

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-create` 実行時、ブランチ作成後にブランチ切り替えを行わないこと
- [ ] 仕様書ファイル作成、データベースレコード作成、イベント発火が完了した後に Git 自動コミットが実行されること
- [ ] Git 自動コミット完了後に元のブランチに戻ること

### 機能要件

- [ ] `src/commands/spec/create.ts` の処理順序を修正すること
- [ ] イベントハンドラー（`spec.created`）が完了するまで待機すること
- [ ] ブランチ切り替えタイミングを Git 自動コミット後に変更すること

### 非機能要件

- [ ] 既存のエラーハンドリング機構（ロールバック処理）を維持すること
- [ ] 既存のテストが正常に動作すること

---

## 4. 制約条件

- イベントハンドラーは非同期で実行されるため、`await eventBus.emit()` で完了を待機する必要がある
- ブランチ切り替えはイベントハンドラー完了後に実行する必要がある
- エラー時のロールバック処理（ブランチ削除、DB レコード削除、ファイル削除）を維持する必要がある

---

## 5. 依存関係

- `src/commands/spec/create.ts` - 仕様書作成コマンド
- `src/core/workflow/git-integration.ts` - Git 自動コミット処理（`handleSpecCreatedCommit`）
- `src/core/workflow/github-integration.ts` - GitHub Issue 自動作成処理
- `src/core/workflow/event-bus.ts` - イベントバスとハンドラー登録機構

---

## 6. 参考情報

- 関連 Issue: #291
- 問題発生箇所: `src/commands/spec/create.ts:201-248`
- 根本原因: `await eventBus.emit()` 直後にブランチ切り替えを実行しているため、Git 自動コミットが実行される前に元のブランチに戻ってしまう

## 7. 技術的詳細

### 現在の処理順序（問題あり）

```typescript
// 1. ブランチ作成
const branchResult = createSpecBranch(id);

// 2. データベースレコード作成
await db.insertInto('specs').values({ ... }).execute();

// 3. 仕様書ファイル生成
writeFileSync(specPath, content);

// 4. イベント発火（非同期処理）
await eventBus.emit(eventBus.createEvent('spec.created', id, { ... }));

// 5. 元のブランチに戻る ← 問題箇所（Git自動コミット前に実行される）
if (branchCreated && originalBranch) {
  execSync(`git checkout ${originalBranch}`);
}
```

### 修正後の処理順序

```typescript
// 1. ブランチ作成（切り替えなし、作成のみ）
const branchResult = createSpecBranch(id);

// 2. データベースレコード作成
await db.insertInto('specs').values({ ... }).execute();

// 3. 仕様書ファイル生成
writeFileSync(specPath, content);

// 4. イベント発火（Git自動コミット含む、完了まで待機）
await eventBus.emit(eventBus.createEvent('spec.created', id, { ... }));

// 5. 元のブランチに戻る（Git自動コミット完了後）
if (branchCreated && originalBranch) {
  execSync(`git checkout ${originalBranch}`);
}
```

### 変更点

- ブランチ切り替えタイミングを `eventBus.emit()` の完了後に移動
- イベントハンドラー内で Git 自動コミットが完了するまで待機
- 既存のエラーハンドリング（ロールバック処理）を維持

---

## 8. 詳細設計

### 8.1. アーキテクチャ設計

#### コンポーネント間の関係

```text
┌─────────────────────────────┐
│ /cft:spec-create コマンド    │
│ (src/commands/spec/create.ts)│
└──────────┬──────────────────┘
           │
           │ 1. createSpecBranch() でブランチ作成（切り替えなし）
           │ 2. データベースレコード作成
           │ 3. 仕様書ファイル生成
           │
           ▼
┌─────────────────────────────┐
│ EventBus                    │
│ (src/core/workflow/event-bus.ts) │
└──────────┬──────────────────┘
           │
           │ emit('spec.created', ...)
           │ ↓ 待機（await）
           ▼
┌─────────────────────────────┐
│ Git Integration Handler     │
│ (src/core/workflow/git-integration.ts)│
│ handleSpecCreatedCommit()   │
└──────────┬──────────────────┘
           │
           │ 4. git add + git commit
           │ 5. textlint 検証
           │
           ▼
           完了
           │
           ▼
┌─────────────────────────────┐
│ /cft:spec-create コマンド    │
│ 6. 元のブランチに戻る        │
│    git checkout <original>  │
└─────────────────────────────┘
```

#### イベント駆動設計のポイント

- **イベント発火の同期待機**: `await eventBus.emit()` により、すべてのハンドラーが完了するまで待機
- **Git 自動コミットの完了保証**: ハンドラー内の Git 操作が完了してから次の処理に進む
- **エラーハンドリングの分離**: イベントハンドラー内のエラーはログ記録のみ行い、コマンド本体のエラーハンドリングとは独立

### 8.2. データフロー

#### 正常系のデータフロー

```text
[ユーザー入力]
  ↓
[バリデーション]
  ↓
[ブランチ作成] → branchResult { created, branchName, originalBranch }
  ↓
[DB レコード作成] → specs テーブルに挿入
  ↓
[ファイル生成] → .cc-craft-kit/specs/<spec-id>.md
  ↓
[イベント発火] → spec.created
  ↓
[Git 自動コミット] → git add + git commit（完了まで待機）
  ↓
[ブランチ復帰] → git checkout <originalBranch>
  ↓
[完了メッセージ表示]
```

#### エラー時のロールバックフロー

```text
[エラー発生]
  ↓
[ブランチ削除] → git branch -D <branchName>
  ↓
[DB レコード削除] → DELETE FROM specs WHERE id = ?
  ↓
[ファイル削除] → unlinkSync(<specPath>)
  ↓
[エラースロー]
```

### 8.3. API 設計

#### createSpecBranch() の動作変更

**変更前:**

```typescript
function createSpecBranch(specId: string): BranchCreationResult {
  // ブランチ作成 + 自動切り替え
  execSync(`git checkout -b ${branchName}`);
  return {
    created: true,
    branchName,
    originalBranch,
  };
}
```

**変更後:**

```typescript
function createSpecBranch(specId: string): BranchCreationResult {
  // ブランチ作成のみ（切り替えなし）
  execSync(`git branch ${branchName}`);
  return {
    created: true,
    branchName,
    originalBranch,
  };
}
```

**重要**: ブランチ切り替えは `/cft:spec-create` コマンド側で Git 自動コミット完了後に実行する。

#### イベントハンドラーの完了待機

**変更前:**

```typescript
// イベント発火後、すぐに次の処理に進む
eventBus.emit(eventBus.createEvent('spec.created', id, { ... }));

// ブランチ切り替え（Git自動コミット前に実行される）
if (branchCreated && originalBranch) {
  execSync(`git checkout ${originalBranch}`);
}
```

**変更後:**

```typescript
// イベントハンドラーの完了を待機
await eventBus.emit(eventBus.createEvent('spec.created', id, { ... }));

// ブランチ切り替え（Git自動コミット後に実行される）
if (branchCreated && originalBranch) {
  execSync(`git checkout ${originalBranch}`);
}
```

### 8.4. セキュリティ設計

#### コマンドインジェクション対策

- **ブランチ名のサニタイゼーション**: UUID フォーマット検証により、不正な文字列の混入を防止
- **Git コマンドのエスケープ**: `execSync()` の引数は常にサニタイズ済みの値を使用

#### エラー情報の漏洩防止

- **スタックトレースの制御**: 本番環境ではスタックトレースを非表示
- **Git エラーメッセージの制御**: `stdio: 'pipe'` により、詳細なエラーメッセージを制御

### 8.5. パフォーマンス設計

#### Git コマンド実行の最適化

- **ブランチ作成のみ**: `git checkout -b` ではなく `git branch` を使用することで、不要なブランチ切り替えを削減
- **fsync() の活用**: ファイル書き込み後に `fsyncFileAndDirectory()` を実行し、OS バッファを強制フラッシュ

#### データベースアクセスの最適化

- **トランザクション不要**: 単一レコード挿入のため、トランザクションは不要
- **インデックス活用**: `specs.id` のプライマリキーを使用して高速検索

### 8.6. エラーハンドリング設計

#### ロールバック処理の順序

1. **ブランチ削除**: `git checkout <originalBranch>` → `git branch -D <branchName>`
2. **DB レコード削除**: `DELETE FROM specs WHERE id = ?`
3. **ファイル削除**: `unlinkSync(<specPath>)`

#### エラーメッセージの設計

| エラーケース | メッセージ | ユーザー対応 |
|---|---|---|
| Git リポジトリ未初期化 | `Git repository not initialized` | `git init` 実行 |
| ブランチ作成失敗 | `Failed to create branch: <branchName>` | Git エラーを確認 |
| DB レコード作成失敗 | `Failed to insert spec record` | データベース整合性を確認 |
| ファイル作成失敗 | `Failed to write spec file` | ディスク容量を確認 |
| Git 自動コミット失敗 | `Auto-commit failed, please commit manually` | 手動コミット実行 |

### 8.7. テスト設計

#### 単体テスト

| テストケース | テスト内容 | 期待結果 |
|---|---|---|
| ブランチ作成のみ | `createSpecBranch()` がブランチ切り替えを行わないこと | `git branch` のみ実行 |
| イベント完了待機 | `eventBus.emit()` が完了するまで待機すること | Git 自動コミット後にブランチ復帰 |
| ロールバック処理 | エラー時にブランチ、DB、ファイルが削除されること | すべてのリソースがクリーンアップ |

#### E2E テスト

| テストケース | テスト内容 | 期待結果 |
|---|---|---|
| 正常系フロー | `/cft:spec-create` 実行時の全体フロー | Git 自動コミット後に元のブランチに戻る |
| エラー時フロー | イベントハンドラーエラー発生時のロールバック | すべてのリソースがクリーンアップ |

#### テストデータ

- **仕様書名**: "テスト用仕様書"
- **仕様書 ID**: `12345678-1234-1234-1234-123456789abc`
- **ブランチ名**: `spec/12345678`
- **元のブランチ**: `develop`

---

## 9. 実装タスクリスト

### タスク1: createSpecBranch() 関数の修正

- **対象ファイル**: `src/core/git/branch-creation.ts`
- **変更内容**: `git checkout -b` → `git branch` に変更（ブランチ作成のみ、切り替えなし）
- **依存関係**: なし
- **優先度**: 高

### タスク2: /cft:spec-create コマンドの処理順序修正

- **対象ファイル**: `src/commands/spec/create.ts`
- **変更内容**: `await eventBus.emit()` 完了後にブランチ切り替えを実行
- **依存関係**: タスク 1 完了後
- **優先度**: 高

### タスク3: エラーハンドリング機構の動作確認

- **対象ファイル**: `src/commands/spec/create.ts`
- **確認内容**: ロールバック処理（ブランチ削除、DB レコード削除、ファイル削除）が正常に動作すること
- **依存関係**: タスク 2 完了後
- **優先度**: 中

### タスク4: 既存テストの動作確認

- **対象ファイル**: `tests/commands/spec/create.test.ts`, `tests/e2e/test-branch-stability.test.ts`
- **確認内容**: 既存テストが正常にパスすること
- **依存関係**: タスク 3 完了後
- **優先度**: 中
