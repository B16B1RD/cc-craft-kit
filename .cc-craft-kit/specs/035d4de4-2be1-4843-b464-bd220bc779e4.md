# 構成見直し

**仕様書 ID:** 035d4de4-2be1-4843-b464-bd220bc779e4
**フェーズ:** implementation
**作成日時:** 2025/12/06 18:30:00
**更新日時:** 2025/12/07 01:46:00

---

## 1. 背景と目的

### 背景

kiro や cc-sdd  と同様に、カスタムスラッシュコマンド、スキル、サブエージェントのみで構成させたい

### 目的

cc-craft-kit の構成を見直し、TypeScript を完全に排除して、カスタムスラッシュコマンド、スキル、サブエージェントのみで動作するシンプルなアーキテクチャに再構成する。

---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者、および Claude Code で仕様駆動開発（SDD）を実践するユーザー

---

## 3. 受け入れ基準

### 必須要件

- [ ] TypeScript コード（`src/`、`.cc-craft-kit/commands/`、`core/`、`integrations/` 等）を完全に削除
- [ ] スラッシュコマンドを 24 個から 10 個に統合
- [ ] 仕様書フォーマットを YAML フロントマター形式に変更（Single Source of Truth）
- [ ] GitHub 操作を `gh` CLI で代替

### 機能要件

- [ ] `/cft:spec` 統合コマンド（create/list/get/phase/delete）の実装
- [ ] `/cft:github` 統合コマンド（init/issue/sync/cleanup）の実装
- [ ] `/cft:review` 統合コマンド（code-review/lint-check/refactor）の実装
- [ ] `/cft:test` 統合コマンド（test-generate/schema-validate）の実装
- [ ] `/cft:session` 統合コマンド（start/end）の実装
- [ ] 既存仕様書の YAML フロントマター形式への移行スクリプト

### 非機能要件

- [ ] `gh` CLI がインストールされていない場合のエラーガイダンス
- [ ] 手動トリガー + 次のステップガイダンス方式での運用

---

## 4. 制約条件

- `gh` CLI（GitHub CLI）が必須
- GITHUB_TOKEN 環境変数の設定が必須
- 現在の EventBus（イベント駆動）、Chokidar（ファイル監視）による自動化は廃止
- 自動処理は手動トリガー + ガイダンス方式に移行

---

## 5. 依存関係

### 削除対象

- `src/` 全体（約 5,000+ 行の TypeScript）
- `.cc-craft-kit/commands/`、`core/`、`integrations/`、`hooks/`、`plugins/`、`scripts/`、`meta/`
- `package.json` の TypeScript 関連依存

### 維持対象

- `.claude/commands/cft/` - スラッシュコマンド（統合後 10 個）
- `.claude/skills/` - スキル（整理後 4 個）
- `.claude/agents/` - サブエージェント（5 個維持）
- `.cc-craft-kit/specs/` - 仕様書ファイル
- `.cc-craft-kit/config.json` - プロジェクト設定

---

## 6. 参考情報

- [計画ファイル](/home/autum/.claude/plans/cosmic-gliding-moth.md) - 詳細な実装計画
- kiro - シンプルなスペックファイル + プロンプトベースのワークフロー
- cc-sdd - カスタムスラッシュコマンドのみで構成

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
Before (現在):
┌─────────────────────────────────────────────────────────────┐
│ .claude/commands/cft/ (24個)                                │
│         ↓ npx tsx                                           │
│ .cc-craft-kit/commands/ (28個 TS スクリプト)                │
│         ↓                                                   │
│ .cc-craft-kit/core/ (67個、11,569行 TypeScript)             │
│         ↓                                                   │
│ Octokit (GitHub API) + Kysely (DB) + EventBus              │
└─────────────────────────────────────────────────────────────┘

After (目標):
┌─────────────────────────────────────────────────────────────┐
│ .claude/commands/cft/ (10個、統合コマンド)                  │
│         ↓ 直接実行                                          │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ Bash / git / gh CLI                                     │ │
│ │ + Claude Code ツール (Read/Edit/Grep/Glob)              │ │
│ └─────────────────────────────────────────────────────────┘ │
│         ↓                                                   │
│ .cc-craft-kit/specs/ (YAML フロントマター形式 Markdown)    │
│ + .cc-craft-kit/config.json (プロジェクト設定)             │
└─────────────────────────────────────────────────────────────┘
```

#### 設計方針

1. **プロンプトファースト原則の徹底**
   - すべての処理をスラッシュコマンド（Markdown プロンプト）内で完結
   - TypeScript スクリプトへの依存を完全排除
   - Claude Code の標準ツール（Read/Edit/Glob/Grep/Bash）を直接使用

2. **Single Source of Truth（仕様書中心）**
   - 仕様書ファイル自体がメタデータを保持（YAML フロントマター）
   - 外部 DB（SQLite）を廃止
   - Git 履歴がバージョン管理の唯一の情報源

3. **CLI ネイティブ**
   - GitHub 操作は `gh` CLI に統一
   - Git 操作は標準の `git` コマンドを使用
   - 複雑なラッパーを排除

#### 処理フロー詳細

**仕様書作成フロー（/cft:spec create）:**
```
1. ユーザー入力: 仕様書名と説明
2. UUID 生成: uuidgen コマンド
3. ファイル作成: Write ツールで YAML フロントマター + Markdown
4. ブランチ作成: git branch コマンド
5. ガイダンス表示: 次のステップを案内
```

**GitHub Issue 作成フロー（/cft:github issue）:**
```
1. 仕様書読み込み: Read ツール
2. YAML パース: プロンプト内で解析
3. Issue 作成: gh issue create
4. 仕様書更新: Edit ツールで github_issue_number を追記
5. 自動コミット: git add && git commit
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `.claude/commands/cft/spec.md` | 新規作成：spec 統合コマンド（create/list/get/phase/delete） |
| `.claude/commands/cft/github.md` | 新規作成：github 統合コマンド（init/issue/sync/cleanup） |
| `.claude/commands/cft/review.md` | 新規作成：review 統合コマンド（code-review/lint-check/refactor） |
| `.claude/commands/cft/test.md` | 新規作成：test 統合コマンド（test-generate/schema-validate） |
| `.claude/commands/cft/session.md` | 新規作成：session 統合コマンド（start/end） |
| `.claude/commands/cft/status.md` | 書き換え：TypeScript 依存を除去 |
| `.claude/commands/cft/task.md` | 書き換え：TypeScript 依存を除去 |
| `.claude/commands/cft/sync.md` | 書き換え：TypeScript 依存を除去 |
| `.claude/commands/cft/knowledge.md` | 書き換え：TypeScript 依存を除去 |
| `.claude/commands/cft/quality.md` | 書き換え：TypeScript 依存を除去 |

#### 削除対象ファイル

| ディレクトリ/ファイル | 削除理由 |
|---------------------|---------|
| `src/` | 全ファイル（マスターソース、不要） |
| `.cc-craft-kit/commands/` | TypeScript スクリプト群（代替実装済み後） |
| `.cc-craft-kit/core/` | TypeScript ライブラリ（不要） |
| `.cc-craft-kit/integrations/` | Octokit 実装（gh CLI で代替） |
| `.cc-craft-kit/hooks/` | イベントハンドラ（手動トリガーに移行） |
| `.cc-craft-kit/plugins/` | プラグインシステム（廃止） |
| `.cc-craft-kit/scripts/` | ユーティリティスクリプト（不要） |
| `.cc-craft-kit/meta/` | メタデータストレージ（廃止） |
| `.cc-craft-kit/database.db` | SQLite DB（廃止） |
| `package.json` | TypeScript 依存削除、最小構成に |
| `tsconfig.json` | 削除 |
| `jest.config.js` | 削除 |

#### 仕様書フォーマット変更

**Before（現在のフォーマット）:**
```markdown
# 仕様書名

**仕様書 ID:** xxx
**フェーズ:** design
**作成日時:** 2025/12/06 18:30:00
...
```

**After（YAML フロントマター形式）:**
```markdown
---
id: 035d4de4-2be1-4843-b464-bd220bc779e4
name: 構成見直し
phase: design
branch_name: refactor/spec-035d4de4-restructure-slash-commands-skills-only
github_issue_number: 905
created_at: 2025-12-06T18:30:00+09:00
updated_at: 2025-12-07T00:30:15+09:00
---

# 構成見直し

## 1. 背景と目的
...
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| 仕様書 ID 解決 | `npx tsx resolve-id.ts` | Glob + Read + YAML パース | `/cft:spec` 内 |
| フェーズ更新 | `npx tsx update-phase.ts` + DB | Edit ツール + git commit | `/cft:spec phase` 内 |
| GitHub Issue 作成 | Octokit API | `gh issue create` | `/cft:github issue` 内 |
| Sub Issue 作成 | Octokit API | `gh issue create --body` | `/cft:github issue` 内 |
| PR 作成 | Octokit API | `gh pr create` | `pr-creator` スキル |
| 仕様書一覧取得 | DB クエリ | Glob + Read + YAML パース | `/cft:spec list` 内 |
| 整合性チェック | TypeScript 実装 | Bash + Read + Glob | `/cft:sync check` 内 |
| 品質チェック | TypeScript 実装 | `npm run typecheck && npm run lint` | `/cft:review` 内 |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| スラッシュコマンド（10個） | 各サブコマンドの動作 | 手動テスト + ドキュメント化 |
| YAML フロントマターパース | 正常/異常ケース | サンプル仕様書での検証 |
| gh CLI 操作 | Issue/PR 作成・更新 | テスト用リポジトリでの実行 |
| 仕様書移行 | 既存形式 → YAML 形式 | 全仕様書の変換検証 |
| 削除後の動作 | TypeScript 削除後の正常動作 | 全コマンドの実行確認 |

### 7.5 移行計画

#### Phase 1: 新コマンド実装（既存と並行）

1. YAML フロントマター対応の仕様書パーサーを `/cft:spec` に実装
2. `/cft:github` 統合コマンドを `gh` CLI ベースで新規実装
3. `/cft:review`、`/cft:test`、`/cft:session` を新規実装
4. 既存コマンドと新コマンドを並行稼働

#### Phase 2: 仕様書フォーマット移行

1. 既存仕様書を YAML フロントマター形式に変換
2. 旧フォーマット対応コードを削除
3. 移行後の動作検証

#### Phase 3: TypeScript コード削除

1. 新コマンドで全機能が動作することを確認
2. `.cc-craft-kit/commands/`、`core/`、`integrations/` を削除
3. `src/` ディレクトリを削除
4. `package.json` を最小構成に変更

#### Phase 4: 最終クリーンアップ

1. 不要な設定ファイル（tsconfig.json、jest.config.js 等）を削除
2. ドキュメント更新（README.md、CLAUDE.md）
3. 旧スラッシュコマンド（24個）を削除し、新コマンド（10個）に統一

---

## 9. YAML フロントマターパーサー設計

### 9.1 フォーマット仕様

```markdown
---
id: <uuid>
name: <仕様書名>
phase: <requirements|design|implementation|review|completed>
branch_name: <ブランチ名>
github_issue_number: <Issue番号|null>
created_at: <ISO8601形式>
updated_at: <ISO8601形式>
---

# <仕様書名>

## 1. 背景と目的
...
```

### 9.2 パース手順（プロンプト内実行）

各コマンドで以下のパターンを使用:

```
1. Glob ツールで仕様書ファイルを特定:
   - パターン: `.cc-craft-kit/specs/*.md`
   - ID 部分一致: ファイル名に ID が含まれるものを検索

2. Read ツールでファイル内容を取得

3. プロンプト内で YAML フロントマターを解析:
   - `---` で囲まれた部分を抽出
   - 各行を `key: value` 形式でパース
   - 必須フィールドの検証

4. 値の取得例:
   - id: 最初の `id:` 行の値
   - name: 最初の `name:` 行の値
   - phase: 最初の `phase:` 行の値
   - branch_name: 最初の `branch_name:` 行の値
   - github_issue_number: 最初の `github_issue_number:` 行の値（null の場合は空文字列）
```

### 9.3 ID 解決パターン

**部分 ID からの完全 ID 解決:**

```
入力: 035d4de4（8文字以上の部分ID）

1. Glob(".cc-craft-kit/specs/*.md") で全仕様書を取得
2. 各ファイル名から ID を抽出（ファイル名形式: `<uuid>.md`）
3. 部分 ID に一致するファイルを特定
4. Read でファイル内容を取得
5. YAML フロントマターから完全な情報を抽出

出力:
- id: 035d4de4-2be1-4843-b464-bd220bc779e4
- name: 構成見直し
- phase: design
- branch_name: refactor/spec-035d4de4-...
- github_issue_number: 905
- spec_path: .cc-craft-kit/specs/035d4de4-...md
```

### 9.4 フェーズ更新パターン

```
1. 対象仕様書を Read ツールで読み込み
2. Edit ツールで以下を更新:
   - `phase: <old>` → `phase: <new>`
   - `updated_at: <old>` → `updated_at: <current ISO8601>`
3. git add && git commit
```

### 9.5 一覧取得パターン

```
1. Glob(".cc-craft-kit/specs/*.md") で全ファイルを取得
2. 各ファイルを Read して YAML フロントマターを抽出
3. phase でフィルタリング（指定時）
4. 結果を整形して表示
```

### 9.6 バリデーションルール

| フィールド | 必須 | 検証内容 |
|-----------|------|---------|
| id | ✓ | UUID v4 形式 |
| name | ✓ | 空でないこと |
| phase | ✓ | 有効なフェーズ名 |
| branch_name | ✓ | 空でないこと |
| github_issue_number | - | 数値または null |
| created_at | ✓ | ISO8601 形式 |
| updated_at | ✓ | ISO8601 形式 |

---

## 8. 実装タスクリスト

### Phase 1: 新コマンド実装

- [x] YAML フロントマター形式の仕様書パーサーを設計 (#906)
- [x] `/cft:spec` 統合コマンドを新規実装（create/list/get/phase/delete） (#907)
- [x] `/cft:github` 統合コマンドを `gh` CLI ベースで新規実装（init/issue/sync/cleanup） (#908)
- [x] `/cft:review` 統合コマンドを新規実装（code-review/lint-check/refactor） (#909)
- [x] `/cft:test` 統合コマンドを新規実装（test-generate/schema-validate） (#910)
- [x] `/cft:session` 統合コマンドを新規実装（start/end） (#911)
- [x] `/cft:status` を TypeScript 依存なしで書き換え (#912)
- [x] `/cft:task` を TypeScript 依存なしで書き換え (#913)
- [x] `/cft:sync` を TypeScript 依存なしで書き換え (#914)
- [x] `/cft:knowledge` を TypeScript 依存なしで書き換え (#915)

### Phase 2: 仕様書フォーマット移行

- [ ] 仕様書移行スクリプト（Bash + Read/Edit）を実装 (#916)
- [ ] 既存仕様書（.cc-craft-kit/specs/*.md）を YAML フロントマター形式に変換 (#917)
- [ ] 移行後の動作検証 (#918)

### Phase 3: TypeScript コード削除

- [ ] `.cc-craft-kit/commands/` ディレクトリを削除 (#919)
- [ ] `.cc-craft-kit/core/` ディレクトリを削除 (#920)
- [ ] `.cc-craft-kit/integrations/` ディレクトリを削除 (#921)
- [ ] `.cc-craft-kit/hooks/` ディレクトリを削除 (#922)
- [ ] `.cc-craft-kit/plugins/` ディレクトリを削除 (#923)
- [ ] `.cc-craft-kit/scripts/` ディレクトリを削除 (#924)
- [ ] `.cc-craft-kit/meta/` ディレクトリを削除 (#925)
- [ ] `.cc-craft-kit/database.db` を削除 (#926)
- [ ] `src/` ディレクトリを削除 (#927)

### Phase 4: 最終クリーンアップ

- [ ] `package.json` を最小構成に変更（TypeScript 依存削除） (#928)
- [ ] `tsconfig.json` を削除 (#929)
- [ ] `jest.config.js` を削除 (#930)
- [ ] 旧スラッシュコマンド（14個）を削除 (#931)
- [ ] README.md を更新 (#932)
- [ ] CLAUDE.md を更新 (#933)
- [ ] `.claude/skills/` を整理（4個に削減） (#934)
