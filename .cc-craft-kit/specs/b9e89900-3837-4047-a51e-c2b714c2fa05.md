# GITHUB_DEFAULT_BASE_BRANCH を BASE_BRANCH へ変更

**仕様書 ID:** b9e89900-3837-4047-a51e-c2b714c2fa05
**フェーズ:** completed
**作成日時:** 2025/11/24 14:38:11
**更新日時:** 2025/11/24 15:31:18

---

## 1. 背景と目的

### 背景

現在、cc-craft-kit では PR 作成時のマージ先ブランチを指定する環境変数が `GITHUB_DEFAULT_BASE_BRANCH` として定義されています。しかし、この命名には以下の問題があります:

1. **命名規則の不統一**: `GITHUB_*` プレフィックスは GitHub API や GitHub 固有の設定に使用されるべきですが、`GITHUB_DEFAULT_BASE_BRANCH` は Git ブランチ管理の基本設定であり、GitHub API には直接関係していません。
2. **冗長な命名**: 「DEFAULT」が含まれているため、他のベースブランチが存在するかのような誤解を招く可能性があります。
3. **設計意図の不明瞭さ**: 仕様駆動開発では「すべての仕様書ブランチは同じベースブランチから派生し、同じベースブランチにマージされるべき」という設計思想がありますが、現在の命名では意図が伝わりにくくなっています。

既存の仕様書（b1098fbd-2d4c-464d-8831-7cebc42c1f0d）では、この問題が指摘され、`BASE_BRANCH` へのリネームが提案されています。

### 目的

環境変数 `GITHUB_DEFAULT_BASE_BRANCH` を `BASE_BRANCH` にリネームし、以下を達成します:

1. **命名規則の統一**: `PROTECTED_BRANCHES` などの Git ブランチ管理設定と一貫性のある命名に変更
2. **設計意図の明確化**: ベースブランチは1つであり、すべての仕様書ブランチがこのブランチから派生・マージされることを命名で表現
3. **コードの可読性向上**: 環境変数名と設定の役割が直感的に理解できるようにする

---

## 2. 対象ユーザー

- **cc-craft-kit を使用する開発者**: 環境変数 `.env` ファイルを設定してツールキットを使用するすべての開発者
- **cc-craft-kit の保守担当者**: 環境変数の命名規則を統一し、コードの可読性・保守性を向上させたい開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] 環境変数 `GITHUB_DEFAULT_BASE_BRANCH` が `BASE_BRANCH` にリネームされていること
- [ ] `.env.example` ファイルで `BASE_BRANCH` が定義され、適切なコメントが付いていること
- [ ] すべての使用箇所（`src/core/config/github-config.ts` など）で `BASE_BRANCH` を参照していること
- [ ] `GitHubConfig` インターフェースの `defaultBaseBranch` プロパティが `BASE_BRANCH` から読み込まれていること
- [ ] すべての既存機能（PR 作成、ブランチ管理）が正常に動作すること

### 機能要件

- [ ] 環境変数の読み込み処理で `trim()` が適用されていること
- [ ] デフォルト値 `'develop'` が維持されていること
- [ ] hotfix ブランチの特殊処理（`main` へのPR作成）が維持されていること
- [ ] `process.env.BASE_BRANCH` が未定義の場合に `'develop'` が使用されること

### 非機能要件

- [ ] 単体テスト（`tests/core/config/github-config.test.ts` など）が `BASE_BRANCH` を使用するように更新され、すべてパスすること
- [ ] 型チェック（`npx tsc --noEmit`）がエラーなく完了すること
- [ ] ESLint チェック（`npm run lint`）がエラーなく完了すること
- [ ] 環境変数の命名規則が `PROTECTED_BRANCHES` などの既存設定と統一されていること

---

## 4. 制約条件

### 技術的制約

1. **環境変数の読み込みタイミング**: `src/core/config/env.ts` で `dotenv` が設定されており、すべてのコマンドファイルの先頭でインポートされること
2. **型安全性**: `GitHubConfig` インターフェースの `defaultBaseBranch` プロパティは `string` 型であること
3. **デフォルト値の維持**: 既存の動作を維持するため、デフォルト値は `'develop'` とすること
4. **後方互換性**: 既存の `.env` ファイルを使用している開発者向けに、移行手順を明示すること

### 影響範囲

1. **コア設定モジュール**: `src/core/config/github-config.ts`
2. **GitHub 統合モジュール**: `src/integrations/github/pull-request.ts`
3. **ワークフロー処理**: `src/core/workflow/branch-management.ts`
4. **ブランチ操作**: `src/core/git/branch-creation.ts`, `src/commands/spec/create.ts`
5. **単体テスト**: `tests/core/config/github-config.test.ts`, `tests/core/workflow/branch-management-pr-creation.test.ts`

### 運用上の制約

1. **既存の開発者への影響**: `.env` ファイルを使用している開発者は環境変数名を変更する必要がある
2. **ドキュメント更新**: README.md、QUICK_START.md などのドキュメントで環境変数名を更新すること

---

## 5. 依存関係

### 関連仕様書

- **b1098fbd-2d4c-464d-8831-7cebc42c1f0d** (completed): `.env の GITHUB_DEFAULT_BASE_BRANCH は不要では？`
  - この仕様書で `BASE_BRANCH` へのリネームが提案されている

### 依存モジュール

1. **環境変数読み込み**: `dotenv` (v16.4.7)
   - `src/core/config/env.ts` で設定され、`process.env` から環境変数を読み込む
2. **Git 操作**: `simple-git` (v3.27.0)
   - ブランチ作成、PR 作成時のベースブランチ決定に使用
3. **GitHub API**: `@octokit/rest` (v21.0.2)
   - PR 作成時にベースブランチを指定
4. **型定義**: TypeScript (v5.7.3)
   - `GitHubConfig` インターフェースで `defaultBaseBranch` を定義

### 影響を受けるコンポーネント

1. **仕様書ブランチ作成**: `src/core/git/branch-creation.ts`
   - 保護ブランチから仕様書ブランチを作成する際にベースブランチを参照
2. **PR 作成**: `src/integrations/github/pull-request.ts`
   - PR 作成時のマージ先ブランチを決定
3. **イベント駆動処理**: `src/core/workflow/branch-management.ts`
   - `spec.phase_changed` イベント（implementation → completed）での PR 自動作成

---

## 6. 参考情報

### ソースコード参照

- **環境変数定義**: `src/core/config/github-config.ts:33`
  - 現在: `process.env.GITHUB_DEFAULT_BASE_BRANCH?.trim() || 'develop'`
- **PR 作成**: `src/integrations/github/pull-request.ts:166`
  - ベースブランチの決定ロジック
- **ブランチ管理**: `src/core/workflow/branch-management.ts:109`
  - hotfix ブランチの特殊処理
- **単体テスト**: `tests/core/config/github-config.test.ts:13,25,31,37`
  - 環境変数の読み込みテスト

### 環境変数の命名規則（既存例）

| 環境変数 | パターン | 用途 |
|---------|---------|------|
| `GITHUB_TOKEN` | `GITHUB_*` | GitHub API 認証 |
| `GITHUB_OWNER` | `GITHUB_*` | GitHub リポジトリ所有者 |
| `GITHUB_REPO` | `GITHUB_*` | GitHub リポジトリ名 |
| `PROTECTED_BRANCHES` | `*_BRANCHES` | Git ブランチ保護リスト |
| `BASE_BRANCH` | `*_BRANCH` | Git ブランチ管理の基本設定 |

### 関連ドキュメント

- [ARCHITECTURE.md](./docs/ARCHITECTURE.md) - 3層アーキテクチャ設計
- [QUICK_START.md](./docs/QUICK_START.md) - 環境変数設定手順
- [CLAUDE.md](./CLAUDE.md) - プロジェクト規約・セキュリティ基本原則

---

## 7. 設計詳細

### 7.1. アーキテクチャ設計

#### 変更対象ファイルと変更内容

| ファイルパス | 変更内容 | 影響度 |
|------------|---------|-------|
| `src/core/config/github-config.ts` | 環境変数参照を `GITHUB_DEFAULT_BASE_BRANCH` から `BASE_BRANCH` に変更 | 高 |
| `.env.example` | 環境変数定義とコメントを更新 | 高 |
| `tests/core/config/github-config.test.ts` | 環境変数名を `BASE_BRANCH` に更新 | 中 |
| `tests/core/workflow/branch-management-pr-creation.test.ts` | 環境変数名を `BASE_BRANCH` に更新 | 中 |
| `README.md` | 環境変数の説明を更新 | 低 |
| `docs/QUICK_START.md` | 環境変数設定手順を更新 | 低 |

#### 変更前後のコード

**src/core/config/github-config.ts:33（変更前）**
```typescript
defaultBaseBranch: process.env.GITHUB_DEFAULT_BASE_BRANCH?.trim() || 'develop',
```

**src/core/config/github-config.ts:33（変更後）**
```typescript
defaultBaseBranch: process.env.BASE_BRANCH?.trim() || 'develop',
```

**`.env.example`（変更前）**
```env
# PR作成時のマージ先ブランチ (デフォルト: develop)
# completed フェーズ移行時に、このブランチへPRを作成します
# hotfix ブランチの場合は自動的に main に切り替わります
# GITHUB_DEFAULT_BASE_BRANCH=develop
```

**`.env.example`（変更後）**
```env
# ベースブランチ (デフォルト: develop)
# すべての仕様書ブランチはこのブランチから派生し、PR はこのブランチへマージされます
# hotfix ブランチの場合のみ、自動的に main に切り替わります
# BASE_BRANCH=develop
```

### 7.2. データモデル

この変更はデータベーススキーマの変更を伴いません。環境変数のリネームのみです。

### 7.3. API の仕様

外部 API への影響はありません。内部的な環境変数の読み込みロジックのみが変更されます。

### 7.4. セキュリティ考慮事項

#### 既存のセキュリティ機構の維持

1. **環境変数のサニタイゼーション**
   - `trim()` による前後の空白除去を維持
   - 空文字列チェックは不要（`?.` によるオプショナルチェーンで対応）

2. **デフォルト値の安全性**
   - デフォルト値 `'develop'` はハードコードされており、外部入力に依存しない
   - 保護ブランチ（`main`, `develop`）の設定は `PROTECTED_BRANCHES` で管理

3. **Git インジェクション対策**
   - `simple-git` ライブラリがコマンドインジェクション対策を実施済み
   - 環境変数の値は `simple-git` の API 経由で使用され、シェルに直接渡されない

#### セキュリティリスク評価

| リスク | 影響度 | 対策状況 |
|-------|-------|---------|
| 環境変数インジェクション | 低 | `trim()` でサニタイゼーション済み |
| ブランチ名の不正操作 | 低 | `simple-git` の安全な API を使用 |
| デフォルト値の改竄 | なし | ハードコード値を使用 |

### 7.5. テスト戦略

#### 単体テストの更新方針

1. **環境変数読み込みのテスト** (`tests/core/config/github-config.test.ts`)
   - `GITHUB_DEFAULT_BASE_BRANCH` を `BASE_BRANCH` に変更
   - 既存のテストケースをすべて維持
   - テスト項目:
     - `BASE_BRANCH` が設定されている場合、その値が読み込まれること
     - `BASE_BRANCH` が未設定の場合、デフォルト値 `'develop'` が使用されること
     - `BASE_BRANCH` に前後の空白がある場合、`trim()` で除去されること

2. **PR 作成のテスト** (`tests/core/workflow/branch-management-pr-creation.test.ts`)
   - モック設定で `BASE_BRANCH` を使用
   - hotfix ブランチの特殊処理（`main` へのPR作成）が正常に動作すること
   - 通常ブランチの場合、`BASE_BRANCH` の値が使用されること

#### テスト実行手順

```bash
# 1. 単体テスト実行
npm test

# 2. 型チェック
npx tsc --noEmit

# 3. ESLint チェック
npm run lint

# 4. カバレッジ確認
npm run test:coverage
```

#### 受け入れテスト

1. **環境変数の読み込み確認**
   - `.env` ファイルで `BASE_BRANCH=custom-branch` を設定
   - `/cft:spec-create "テスト仕様書"` を実行
   - `custom-branch` からブランチが作成されることを確認

2. **デフォルト値の確認**
   - `.env` ファイルで `BASE_BRANCH` をコメントアウト
   - `/cft:spec-create "テスト仕様書"` を実行
   - `develop` からブランチが作成されることを確認

3. **hotfix の特殊処理確認**
   - `hotfix/test-fix` ブランチを作成
   - 仕様書を completed フェーズに移行
   - PR のベースブランチが `main` であることを確認

#### リグレッションテスト

既存の全テストスイートを実行し、環境変数のリネームによる影響がないことを確認します。

```bash
# 全テスト実行（3回実行して安定性確認）
for i in 1 2 3; do echo "=== テスト実行 $i/3 ==="; npm test; done
```

---

## 8. 実装タスクリスト

### フェーズ 1: ソースコード変更（コア設定モジュール）

- [ ] **Task 1-1**: `src/core/config/github-config.ts:33` を変更
  - 環境変数参照を `process.env.GITHUB_DEFAULT_BASE_BRANCH` から `process.env.BASE_BRANCH` に変更
  - `trim()` とデフォルト値 `'develop'` の維持を確認
  - 依存関係: なし
  - 見積もり: 5分

### フェーズ 2: 環境変数定義の更新

- [ ] **Task 2-1**: `.env.example` を変更
  - `# GITHUB_DEFAULT_BASE_BRANCH=develop` を `# BASE_BRANCH=develop` に変更
  - コメントを更新: 「ベースブランチ (デフォルト: develop)」「すべての仕様書ブランチはこのブランチから派生し、PR はこのブランチへマージされます」
  - 依存関係: なし
  - 見積もり: 5分

### フェーズ 3: 単体テストの更新

- [ ] **Task 3-1**: `tests/core/config/github-config.test.ts` を変更
  - すべての `GITHUB_DEFAULT_BASE_BRANCH` を `BASE_BRANCH` に変更
  - テストケースが正常にパスすることを確認
  - 依存関係: Task 1-1（コア設定モジュールの変更）
  - 見積もり: 10分

- [ ] **Task 3-2**: `tests/core/workflow/branch-management-pr-creation.test.ts` を変更
  - モック設定の `GITHUB_DEFAULT_BASE_BRANCH` を `BASE_BRANCH` に変更
  - hotfix ブランチの特殊処理テストが正常にパスすることを確認
  - 依存関係: Task 1-1（コア設定モジュールの変更）
  - 見積もり: 10分

### フェーズ 4: ドキュメント更新

- [ ] **Task 4-1**: `README.md` を変更
  - 環境変数の説明で `GITHUB_DEFAULT_BASE_BRANCH` を `BASE_BRANCH` に変更
  - 依存関係: Task 1-1, Task 2-1
  - 見積もり: 5分

- [ ] **Task 4-2**: `docs/QUICK_START.md` を変更
  - 環境変数設定手順で `GITHUB_DEFAULT_BASE_BRANCH` を `BASE_BRANCH` に変更
  - 依存関係: Task 1-1, Task 2-1
  - 見積もり: 5分

### フェーズ 5: 品質チェックとリグレッションテスト

- [ ] **Task 5-1**: 型チェック実行
  - `npx tsc --noEmit` を実行し、型エラーがないことを確認
  - 依存関係: Task 1-1
  - 見積もり: 3分

- [ ] **Task 5-2**: ESLint チェック実行
  - `npm run lint` を実行し、リントエラーがないことを確認
  - 依存関係: すべての変更タスク
  - 見積もり: 3分

- [ ] **Task 5-3**: 全単体テスト実行
  - `npm test` を実行し、すべてのテストがパスすることを確認
  - 依存関係: Task 3-1, Task 3-2
  - 見積もり: 5分

- [ ] **Task 5-4**: リグレッションテスト（3回実行）
  - `for i in 1 2 3; do echo "=== テスト実行 $i/3 ==="; npm test; done` を実行
  - すべての実行で安定してパスすることを確認
  - 依存関係: Task 5-3
  - 見積もり: 10分

### フェーズ 6: 同期と最終確認

- [ ] **Task 6-1**: ソースコード同期
  - `npm run sync:dogfood` を実行し、`.cc-craft-kit/` へ同期
  - 依存関係: すべての変更タスク
  - 見積もり: 3分

- [ ] **Task 6-2**: 受け入れテスト（環境変数読み込み確認）
  - `.env` ファイルで `BASE_BRANCH=custom-branch` を設定
  - `/cft:spec-create "テスト仕様書"` を実行し、`custom-branch` からブランチが作成されることを確認
  - 依存関係: Task 6-1
  - 見積もり: 5分

- [ ] **Task 6-3**: 受け入れテスト（デフォルト値確認）
  - `.env` ファイルで `BASE_BRANCH` をコメントアウト
  - `/cft:spec-create "テスト仕様書"` を実行し、`develop` からブランチが作成されることを確認
  - 依存関係: Task 6-1
  - 見積もり: 5分

### 総見積もり時間

約 74分（1時間14分）

### タスク実行順序

1. **フェーズ 1 → フェーズ 2** (並列実行可能)
2. **フェーズ 3** (フェーズ 1 完了後)
3. **フェーズ 4** (フェーズ 1, 2 完了後、並列実行可能)
4. **フェーズ 5** (フェーズ 1-4 完了後)
5. **フェーズ 6** (フェーズ 5 完了後)
