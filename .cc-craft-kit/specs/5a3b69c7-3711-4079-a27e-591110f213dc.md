# /cft:spec-create の実装を見直したい

**仕様書 ID:** 5a3b69c7-3711-4079-a27e-591110f213dc
**フェーズ:** requirements
**作成日時:** 2025-11-25 10:50
**更新日時:** 2025-11-25 10:50

---

## 1. 背景と目的

### 背景

現在の `/cft:spec-create` 実装には以下の問題がある：

1. **過度なスクリプト依存**: `src/commands/spec/create.ts`（304行）が主要処理を担当し、ブランチ作成、DB操作、ファイル生成、イベント発火を一括で行っている
2. **プロンプト指示の複雑化**: スラッシュコマンド（.md）がフェーズ 0〜5 の複雑な処理フローを指示しているが、Claude が正確にフローを追えない
3. **プロンプトで可能な処理のスクリプト化**: ブランチ作成・切り替え、ファイル作成、テンプレート生成など、Bash/Write ツールで実現可能な処理がスクリプト化されている

cc-craft-kit の設計原則「プロンプトファースト」に反しており、仕様通りに動作しない問題が発生している。

### 目的

1. **スクリプトを最小限に**: データベース操作（INSERT）とイベント発火のみをスクリプトで実装
2. **プロンプトベースの処理フロー**: ブランチ操作、ファイル生成、自動完成をプロンプト指示で実現
3. **保守性の向上**: シンプルな構造で仕様変更に柔軟に対応

---

## 2. 対象ユーザー

- cc-craft-kit を使用する開発者
- Claude Code でスラッシュコマンドを実行するユーザー

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-create "仕様名" "説明"` で仕様書が作成される
- [ ] 仕様書 ID（UUID）が自動生成される
- [ ] ブランチ名が仕様書名から自動生成される（英語、kebab-case）
- [ ] 保護ブランチ（main, develop）からは `feature/spec-<id>` ブランチが作成される
- [ ] 仕様書ファイル（`.cc-craft-kit/specs/<id>.md`）が作成される
- [ ] データベースに仕様書レコードが作成される

### 機能要件

- [ ] ブランチ作成・切り替えは Bash ツール（`git` コマンド）で実行
- [ ] 仕様書テンプレートは Write ツールで生成
- [ ] コードベース解析は Task ツール（Explore サブエージェント）で実行
- [ ] 仕様書の自動完成は Edit ツールで実行
- [ ] 処理完了後、元のブランチに復帰

### 非機能要件

- [ ] スクリプト（TypeScript）は 100 行以下
- [ ] スラッシュコマンド（.md）は明確な自動実行フローを記述
- [ ] エラー時のロールバック処理（ブランチ削除、DB 削除）

---

## 4. 制約条件

### 技術的制約

- **データベース操作**: SQLite（Kysely）でのトランザクション管理が必要 → スクリプト必須
- **イベント発火**: EventEmitter2 でのイベントバス → スクリプト必須
- **UUID 生成**: `uuidgen` コマンド（Bash）で代替可能

### プロンプトベース実装の制限

- カスタムスラッシュコマンドはツール呼び出しを「指示」できるが、直接実行はしない
- ツール呼び出しの結果を条件分岐に使用する場合、明示的な指示が必要
- サブエージェント（Task ツール）は並列実行不可

### 既存互換性

- 既存の仕様書（`.cc-craft-kit/specs/*.md`）との互換性を維持
- データベーススキーマの変更なし

---

## 5. 依存関係

### 既存モジュール

- `src/core/database/connection.ts` - データベース接続
- `src/core/workflow/event-bus.ts` - イベントバス
- `src/core/config/github-config.ts` - GitHub 設定（保護ブランチ、デフォルトブランチ）

### 削除対象モジュール

- `src/core/git/branch-creation.ts` - プロンプトで代替
- `src/core/git/branch-cache.ts` - プロンプトで代替（不要に）
- `src/commands/spec/create.ts` の大部分 - 最小スクリプトに置き換え

### 新規作成

- `src/commands/spec/register.ts` - DB 登録 + イベント発火のみの最小スクリプト

---

## 6. 設計方針

### アーキテクチャ変更

```
[現在]
スラッシュコマンド (.md)
  → スクリプト呼び出し (npx tsx create.ts)
    → ブランチ作成、DB操作、ファイル生成、イベント発火

[再設計]
スラッシュコマンド (.md)
  → プロンプト指示でツール呼び出し
    → Bash: uuidgen, git branch, git checkout
    → Write: 仕様書ファイル作成
    → 最小スクリプト呼び出し (DB INSERT + イベント発火のみ)
    → Task: Explore サブエージェント（コードベース解析）
    → Edit: 仕様書の自動完成
    → Bash: git checkout (元ブランチに復帰)
```

### 処理フロー（新設計）

1. **UUID 生成**: `uuidgen` コマンド（Bash）
2. **ブランチ名生成**: Claude が仕様書名から英語 kebab-case を推論
3. **現在ブランチ確認**: `git branch --show-current`（Bash）
4. **保護ブランチ判定**: プロンプト内で条件分岐
5. **ブランチ作成**: `git branch <name> <base>`（Bash）
6. **ブランチ切り替え**: `git checkout <name>`（Bash）
7. **仕様書ファイル作成**: Write ツールでテンプレート生成
8. **DB 登録 + イベント発火**: 最小スクリプト呼び出し
9. **コードベース解析**: Task ツール（Explore）
10. **仕様書の自動完成**: Edit ツール
11. **元ブランチに復帰**: `git checkout <original>`（Bash）

### 最小スクリプトの責務

**`src/commands/spec/register.ts`**（約 50 行）:

```typescript
// 入力: specId, name, description, branchName, specFilePath
// 処理:
//   1. DB に INSERT
//   2. spec.created イベント発火
// 出力: 成功/失敗メッセージ
```

---

## 7. 参考情報

### Claude Code 機能仕様

- **カスタムスラッシュコマンド**: `.md` ファイルで定義、`$1`, `$2` で引数受け取り
- **スキル**: 再利用可能な知識ベース、Skill ツールで起動
- **サブエージェント**: Task ツールで起動、`Explore`, `code-reviewer` など

### 関連仕様書

- なし（新規機能）

### 参考資料

- [Claude Code Docs - Slash Commands](https://code.claude.com/docs/en/slash-commands)
- [Claude Code Docs - Subagents](https://code.claude.com/docs/en/sub-agents)
- CLAUDE.md 内「スクリプトとプロンプトの使い分け指針」
