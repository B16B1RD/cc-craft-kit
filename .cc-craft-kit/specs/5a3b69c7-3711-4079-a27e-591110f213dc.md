# /cft:spec-create の実装を見直したい

**仕様書 ID:** 5a3b69c7-3711-4079-a27e-591110f213dc
**フェーズ:** completed
**作成日時:** 2025-11-25 10:50
**更新日時:** 2025/11/25 11:07:51

---

## 1. 背景と目的

### 背景

現在の `/cft:spec-create` 実装には以下の問題がある：

1. **過度なスクリプト依存**: `src/commands/spec/create.ts`（304行）が主要処理を担当し、ブランチ作成、DB操作、ファイル生成、イベント発火を一括で行っている
2. **プロンプト指示の複雑化**: スラッシュコマンド（.md）がフェーズ 0〜5 の複雑な処理フローを指示しているが、Claude が正確にフローを追えない
3. **プロンプトで可能な処理のスクリプト化**: ブランチ作成・切り替え、ファイル作成、テンプレート生成など、Bash/Write ツールで実現可能な処理がスクリプト化されている

cc-craft-kit の設計原則「プロンプトファースト」に反しており、仕様通りに動作しない問題が発生している。

### 目的

1. **スクリプトを最小限に**: データベース操作（INSERT）とイベント発火のみをスクリプトで実装
2. **プロンプトベースの処理フロー**: ブランチ操作、ファイル生成、自動完成をプロンプト指示で実現
3. **保守性の向上**: シンプルな構造で仕様変更に柔軟に対応

---

## 2. 対象ユーザー

- cc-craft-kit を使用する開発者
- Claude Code でスラッシュコマンドを実行するユーザー

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-create "仕様名" "説明"` で仕様書が作成される
- [ ] 仕様書 ID（UUID）が自動生成される
- [ ] ブランチ名が仕様書名から自動生成される（英語、kebab-case）
- [ ] 保護ブランチ（main, develop）からは `feature/spec-<id>` ブランチが作成される
- [ ] 仕様書ファイル（`.cc-craft-kit/specs/<id>.md`）が作成される
- [ ] データベースに仕様書レコードが作成される

### 機能要件

- [ ] ブランチ作成・切り替えは Bash ツール（`git` コマンド）で実行
- [ ] 仕様書テンプレートは Write ツールで生成
- [ ] コードベース解析は Task ツール（Explore サブエージェント）で実行
- [ ] 仕様書の自動完成は Edit ツールで実行
- [ ] 処理完了後、元のブランチに復帰

### 非機能要件

- [ ] スクリプト（TypeScript）は 100 行以下
- [ ] スラッシュコマンド（.md）は明確な自動実行フローを記述
- [ ] エラー時のロールバック処理（ブランチ削除、DB 削除）

---

## 4. 制約条件

### 技術的制約

- **データベース操作**: SQLite（Kysely）でのトランザクション管理が必要 → スクリプト必須
- **イベント発火**: EventEmitter2 でのイベントバス → スクリプト必須
- **UUID 生成**: `uuidgen` コマンド（Bash）で代替可能

### プロンプトベース実装の制限

- カスタムスラッシュコマンドはツール呼び出しを「指示」できるが、直接実行はしない
- ツール呼び出しの結果を条件分岐に使用する場合、明示的な指示が必要
- サブエージェント（Task ツール）は並列実行不可

### 既存互換性

- 既存の仕様書（`.cc-craft-kit/specs/*.md`）との互換性を維持
- データベーススキーマの変更なし

---

## 5. 依存関係

### 既存モジュール

- `src/core/database/connection.ts` - データベース接続
- `src/core/workflow/event-bus.ts` - イベントバス
- `src/core/config/github-config.ts` - GitHub 設定（保護ブランチ、デフォルトブランチ）

### 削除対象モジュール

- `src/core/git/branch-creation.ts` - プロンプトで代替
- `src/core/git/branch-cache.ts` - プロンプトで代替（不要に）
- `src/commands/spec/create.ts` の大部分 - 最小スクリプトに置き換え

### 新規作成

- `src/commands/spec/register.ts` - DB 登録 + イベント発火のみの最小スクリプト

---

## 6. 設計方針

### アーキテクチャ変更

```
[現在]
スラッシュコマンド (.md)
  → スクリプト呼び出し (npx tsx create.ts)
    → ブランチ作成、DB操作、ファイル生成、イベント発火

[再設計]
スラッシュコマンド (.md)
  → プロンプト指示でツール呼び出し
    → Bash: uuidgen, git branch, git checkout
    → Write: 仕様書ファイル作成
    → 最小スクリプト呼び出し (DB INSERT + イベント発火のみ)
    → Task: Explore サブエージェント（コードベース解析）
    → Edit: 仕様書の自動完成
    → Bash: git checkout (元ブランチに復帰)
```

### 処理フロー（新設計）

1. **UUID 生成**: `uuidgen` コマンド（Bash）
2. **ブランチ名生成**: Claude が仕様書名から英語 kebab-case を推論
3. **現在ブランチ確認**: `git branch --show-current`（Bash）
4. **保護ブランチ判定**: プロンプト内で条件分岐
5. **ブランチ作成**: `git branch <name> <base>`（Bash）
6. **ブランチ切り替え**: `git checkout <name>`（Bash）
7. **仕様書ファイル作成**: Write ツールでテンプレート生成
8. **DB 登録 + イベント発火**: 最小スクリプト呼び出し
9. **コードベース解析**: Task ツール（Explore）
10. **仕様書の自動完成**: Edit ツール
11. **元ブランチに復帰**: `git checkout <original>`（Bash）

### 最小スクリプトの責務

**`src/commands/spec/register.ts`**（約 50 行）:

```typescript
// 入力: specId, name, description, branchName, specFilePath
// 処理:
//   1. DB に INSERT
//   2. spec.created イベント発火
// 出力: 成功/失敗メッセージ
```

---

## 7. 参考情報

### Claude Code 機能仕様

- **カスタムスラッシュコマンド**: `.md` ファイルで定義、`$1`, `$2` で引数受け取り
- **スキル**: 再利用可能な知識ベース、Skill ツールで起動
- **サブエージェント**: Task ツールで起動、`Explore`, `code-reviewer` など

### 関連仕様書

- なし（新規機能）

### 参考資料

- [Claude Code Docs - Slash Commands](https://code.claude.com/docs/en/slash-commands)
- [Claude Code Docs - Subagents](https://code.claude.com/docs/en/sub-agents)
- CLAUDE.md 内「スクリプトとプロンプトの使い分け指針」

---

## 7. 設計詳細

### 7.1. アーキテクチャ設計

#### 現行アーキテクチャの問題点

```
[現行]
spec-create.md (スラッシュコマンド)
  ↓ 呼び出し
create.ts (304行の巨大スクリプト)
  ├── ブランチ作成 (branch-creation.ts)
  ├── ブランチキャッシュ (branch-cache.ts)
  ├── DB INSERT (Kysely)
  ├── ファイル生成 (fs.writeFileSync)
  ├── イベント発火 (EventBus)
  └── ロールバック処理
```

**問題**:
- スクリプトが多くの責務を持ち、単一責任の原則に違反
- ブランチ操作、ファイル生成など、Bash/Write ツールで実現可能な処理がスクリプト化
- プロンプト指示のフロー（フェーズ 0〜5）が複雑で、Claude が正確に追えない

#### 新アーキテクチャ

```
[新設計]
spec-create.md (スラッシュコマンド)
  ├── Step 1: UUID 生成 (Bash: uuidgen)
  ├── Step 2: ブランチ名生成 (Claude 推論)
  ├── Step 3: 現在ブランチ確認 (Bash: git branch --show-current)
  ├── Step 4: 保護ブランチ判定 (プロンプト内条件分岐)
  ├── Step 5: ブランチ作成・切り替え (Bash: git branch, git checkout)
  ├── Step 6: 仕様書ファイル作成 (Write ツール)
  ├── Step 7: DB 登録 + イベント発火 (最小スクリプト: register.ts)
  ├── Step 8: コードベース解析 (Task: Explore サブエージェント)
  ├── Step 9: 仕様書の自動完成 (Edit ツール)
  └── Step 10: 元ブランチに復帰 (Bash: git checkout)
```

**特徴**:
- スクリプトは DB 操作 + イベント発火のみ（約 50 行）
- ブランチ操作、ファイル生成はプロンプト指示で実現
- 処理フローが直線的で、Claude が追いやすい

### 7.2. データモデル

#### specs テーブル（変更なし）

既存のスキーマを維持します。

```sql
CREATE TABLE specs (
  id TEXT PRIMARY KEY,           -- UUID
  name TEXT NOT NULL,            -- 仕様書名
  description TEXT,              -- 説明
  phase TEXT NOT NULL,           -- フェーズ
  branch_name TEXT,              -- ブランチ名
  created_at TEXT NOT NULL,      -- 作成日時 (ISO 8601)
  updated_at TEXT NOT NULL       -- 更新日時 (ISO 8601)
);
```

#### イベントペイロード（変更なし）

```typescript
interface SpecCreatedEvent {
  specId: string;
  payload: {
    name: string;
    description: string | null;
    phase: 'requirements';
  };
}
```

### 7.3. API の仕様

#### 新規: `register.ts` スクリプト

**責務**: DB INSERT + イベント発火のみ

**入力**:
```bash
npx tsx .cc-craft-kit/commands/spec/register.ts \
  --id "<UUID>" \
  --name "<仕様書名>" \
  --description "<説明>" \
  --branch-name "<ブランチ名>" \
  --spec-path "<仕様書ファイルパス>"
```

**処理**:
1. 引数バリデーション（Zod スキーマ）
2. DB INSERT（トランザクション）
3. `spec.created` イベント発火
4. 成功/失敗メッセージ出力

**出力** (JSON):
```json
{
  "success": true,
  "specId": "5a3b69c7-3711-4079-a27e-591110f213dc",
  "message": "Spec registered successfully"
}
```

**エラー出力** (JSON):
```json
{
  "success": false,
  "error": "Validation failed: name is required"
}
```

#### 削除対象モジュール

以下のモジュールは `register.ts` 作成後に削除します：

| ファイル | 理由 |
|---------|------|
| `src/core/git/branch-creation.ts` | Bash ツールで代替 |
| `src/core/git/branch-cache.ts` | プロンプトで管理（不要に） |
| `src/commands/spec/create.ts` | `register.ts` に置き換え |

### 7.4. セキュリティ考慮事項

#### 入力バリデーション

1. **仕様書名**: 空文字チェック、最大 200 文字
2. **UUID**: 正規表現でフォーマット検証
3. **ブランチ名**: Git 互換文字のみ許可（英数字、ハイフン、アンダースコア）

#### コマンドインジェクション対策

- Bash ツール実行時、ユーザー入力をダブルクォートでエスケープ
- `execFileSync` でシェル経由ではなく直接実行（スクリプト内）

#### ファイルパストラバーサル対策

- 仕様書ファイルパスは `.cc-craft-kit/specs/` ディレクトリに限定
- UUID 以外のファイル名は許可しない

### 7.5. テスト戦略

#### 単体テスト

| テスト対象 | テスト内容 | モック対象 |
|-----------|-----------|-----------|
| `register.ts` | 引数バリデーション | - |
| `register.ts` | DB INSERT 成功 | DB |
| `register.ts` | DB INSERT 失敗時のエラーハンドリング | DB |
| `register.ts` | イベント発火 | EventBus |

#### 統合テスト

| テストケース | 検証内容 |
|-------------|---------|
| 正常系: 仕様書作成 | UUID 生成 → ブランチ作成 → ファイル生成 → DB 登録 → 元ブランチ復帰 |
| 異常系: 保護ブランチ判定 | `main`/`develop` から実行時に `feature/spec-` ブランチ作成 |
| 異常系: ロールバック | 途中エラー時に ブランチ削除 → DB 削除 → ファイル削除 |

#### テストカバレッジ目標

- `register.ts`: 90% 以上
- プロンプト部分（`spec-create.md`）: 手動テストで検証

### 7.6. 移行計画

#### Phase 1: 最小スクリプト作成

1. `src/commands/spec/register.ts` を新規作成
2. 単体テストを作成
3. 既存の `create.ts` は残したまま並行稼働

#### Phase 2: スラッシュコマンド更新

1. `src/slash-commands/spec-create.md` を新設計に更新
2. 処理フローを Step 1〜10 に整理
3. `register.ts` を呼び出すように変更

#### Phase 3: 旧コード削除

1. `src/commands/spec/create.ts` を削除
2. `src/core/git/branch-creation.ts` を削除
3. `src/core/git/branch-cache.ts` を削除（他で使用していないことを確認）

### 7.7. 実装ファイル一覧

#### 新規作成

| ファイル | 行数目安 | 責務 |
|---------|---------|------|
| `src/commands/spec/register.ts` | 50 行 | DB INSERT + イベント発火 |

#### 変更

| ファイル | 変更内容 |
|---------|---------|
| `src/slash-commands/spec-create.md` | 処理フローを Step 1〜10 に整理 |

#### 削除

| ファイル | 削除理由 |
|---------|---------|
| `src/commands/spec/create.ts` | `register.ts` に置き換え |
| `src/core/git/branch-creation.ts` | Bash ツールで代替 |
| `src/core/git/branch-cache.ts` | 不要に（プロンプトで管理）|

---

## 8. 実装タスクリスト

### Phase 1: 最小スクリプト作成

| # | タスク | 状態 | 備考 |
|---|--------|------|------|
| 1.1 | `src/commands/spec/register.ts` を新規作成 | ✅ 完了 | DB INSERT + イベント発火のみ、約 80 行（コア機能は `src/core/spec/register-spec.ts` に分離） |
| 1.2 | `register.ts` の単体テストを作成 | ✅ 完了 | `tests/commands/spec/register.test.ts` |

### Phase 2: スラッシュコマンド更新

| # | タスク | 状態 | 備考 |
|---|--------|------|------|
| 2.1 | `src/slash-commands/spec-create.md` を新設計に更新 | ✅ 完了 | Step 1〜10 の処理フローに整理 |

### Phase 3: 旧コード削除

| # | タスク | 状態 | 備考 |
|---|--------|------|------|
| 3.1 | `src/commands/spec/create.ts` を削除 | ✅ 完了 | `register.ts` 作成後 |
| 3.2 | `src/core/git/branch-creation.ts` を削除 | ✅ 完了 | Bash ツールで代替 |
| 3.3 | `src/core/git/branch-cache.ts` を削除 | ⏸️ 保留 | 他モジュール（integrity-checker, database-integrity-checker, branch-switching, get.ts）で使用のため残す |

### 検証

| # | タスク | 状態 | 備考 |
|---|--------|------|------|
| 4.1 | `npm run sync:dogfood` で同期 | ✅ 完了 | |
| 4.2 | `/cft:spec-create` コマンドをテスト | ✅ 完了 | 単体テスト 717 件通過 |

---

## Pull Request

**PR 番号:** #358
**PR URL:** https://github.com/B16B1RD/cc-craft-kit/pull/358
**PR 作成日時:** 2025/11/25 11:08
