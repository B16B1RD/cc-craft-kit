---
id: "bcc860f0-80cd-487c-a6b5-aab53e496f3d"
name: "/cft:status で表示されるフェーズごとの件数が正しくない"
phase: "design"
branch_name: "fix/spec-bcc860f0-status-phase-count-incorrect"
github_issue_number: 955
pr_url: null
created_at: "2025-12-07T07:00:00.000Z"
updated_at: "2025-12-07T08:30:00.000Z"
---

# /cft:status で表示されるフェーズごとの件数が正しくない

## 1. 背景と目的

### 背景

`/cft:status` および `/cft:spec list` コマンドでフェーズごとの仕様書件数を集計・フィルタリングする際、以下の問題が発生している:

**問題1: grep による集計が不正確**

```bash
grep -h '^phase:' .cc-craft-kit/specs/*.md 2>/dev/null | sort | uniq -c | sort -rn
```

この方法では、YAML フロントマター内の `phase:` だけでなく、仕様書本文中に記載されたテンプレートや例示（例: `phase: design`）も含めてカウントしてしまう。

**問題2: grep によるフィルタリングが不正確**

```bash
grep -l 'phase: "design"\|phase: design' .cc-craft-kit/specs/*.md
```

同様に、本文中の記述もマッチしてしまい、実際のフェーズと異なるファイルが検出される。

**実例（会話ログより）:**
- `/cft:status` で `design: 1` と表示されたが、実際には design フェーズの仕様書は 0 件
- `grep -rn 'phase: design'` で検索すると、`035d4de4...md:212:phase: design` のように本文中の記述がヒット

### 目的

YAML フロントマター内の `phase:` フィールドのみを正確に解析し、フェーズごとの件数集計およびフィルタリングを正しく行えるようにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:status` でフェーズごとの件数が正確に表示される
- [ ] `/cft:spec list <phase>` で指定フェーズの仕様書のみが表示される

### 機能要件

- [ ] YAML フロントマター（先頭の `---` ～ 2番目の `---` の間）のみを解析対象とする
- [ ] 本文中に `phase:` が含まれていても集計・フィルタリングに影響しない
- [ ] 引用符の有無（`phase: "design"` と `phase: design`）の両方に対応

### 非機能要件

- [ ] 193 件以上の仕様書でも高速に処理できる（1秒以内）
- [ ] TypeScript を使用しない（スラッシュコマンドのみで実装）

---

## 4. 制約条件

- スラッシュコマンド（.md ファイル）のみで実装
- TypeScript は使用しない
- gh CLI と標準的な Unix コマンドのみ使用可能

---

## 5. 依存関係

- `.claude/commands/cft/spec.md` - list サブコマンドの実装
- `.claude/commands/cft/status.md` - status コマンドの実装

---

## 6. 参考情報

- 発生時の会話ログ: ユーザー提供の詳細なログを参照
- 問題のある grep パターン: `grep -h '^phase:'` は先頭のみマッチするが、YAML フロントマター外の行頭もマッチする

---

## 7. 設計詳細

### 7.1 問題の根本原因

現在の `/cft:status` と `/cft:spec list` は以下の方法でフェーズを集計・フィルタリングしている:

1. **status.md**: `npx tsx .cc-craft-kit/commands/status/info.ts` を呼び出し（TypeScript 依存）
2. **spec.md**: Grep ツールで `phase:` パターンを検索

どちらも YAML フロントマター（先頭の `---` ～ 2番目の `---`）内の `phase:` のみを対象とすべきだが、本文中のテンプレート記述（例: コードブロック内の `phase: design`）もマッチしてしまう。

### 7.2 解決アプローチ

**行番号ベースのフィルタリング**を採用する:

1. YAML フロントマターは必ずファイル先頭にある
2. `phase:` フィールドは通常 4〜6 行目に存在
3. 先頭 10 行以内の `phase:` のみを対象とすれば、本文中の誤検出を排除できる

**Grep ツールの使用方法**:

```
pattern: ^phase: "?(requirements|design|implementation|review|completed)"?$
output_mode: files_with_matches または count
head_limit: 適用して先頭行のみを対象
```

ただし、Grep ツールの `head_limit` は検索結果の件数制限であり、ファイル内の行番号制限ではない。

**代替案: Read ツールで各ファイルの先頭のみを読み込む**

```
Read ツール: limit: 10 で先頭 10 行のみ読み込み
→ YAML フロントマターから phase を抽出
```

### 7.3 採用する解決策

**Read ツール + YAML パースの組み合わせ**:

1. Glob ツールで `.cc-craft-kit/specs/*.md` を取得
2. 各ファイルを Read ツール（limit: 10）で読み込み
3. 先頭の `---` から 2番目の `---` までを YAML として解析
4. `phase` フィールドの値を抽出

**メリット**:
- 確実に YAML フロントマターのみを解析
- TypeScript 不要（Read + Grep + Edit のみ）
- 高速（先頭 10 行のみ読み込み）

### 7.4 影響範囲

| ファイル | 変更内容 |
|---------|---------|
| `.claude/commands/cft/status.md` | TypeScript 依存を削除し、Read ツールベースの集計に変更 |
| `.claude/commands/cft/spec.md` | list サブコマンドの Grep パターンを修正 |

### 7.5 実装方針

**status.md の変更**:

```
Step 2: 現在ブランチの仕様書を集計（並列実行可能）

以下の Grep ツール操作を並列で実行:

| フェーズ | pattern | path | output_mode |
|----------|---------|------|-------------|
| requirements | `^phase: "requirements"$` | `.cc-craft-kit/specs` | files_with_matches |
| design | `^phase: "design"$` | `.cc-craft-kit/specs` | files_with_matches |
| implementation | `^phase: "implementation"$` | `.cc-craft-kit/specs` | files_with_matches |
| review | `^phase: "review"$` | `.cc-craft-kit/specs` | files_with_matches |
| completed | `^phase: "completed"$` | `.cc-craft-kit/specs` | count |

注意: 行頭マッチ `^` を使用して YAML フロントマターのみを対象にする。
本文中のコードブロック内は通常インデントされているため、`^phase:` ではマッチしない。
```

**spec.md の変更**:

list サブコマンドのフィルタリングも同様に `^phase:` パターンを使用。

---

## 8. 実装タスクリスト

- [ ] status.md の Step 2 を Grep ツールベースの集計に変更
- [ ] status.md から TypeScript 依存（npx tsx）を削除
- [ ] spec.md の list サブコマンドで `^phase:` パターンを使用するよう修正
- [ ] 動作確認: `/cft:status` で正しいフェーズ件数が表示されることを確認
- [ ] 動作確認: `/cft:spec list design` で design フェーズの仕様書のみが表示されることを確認
