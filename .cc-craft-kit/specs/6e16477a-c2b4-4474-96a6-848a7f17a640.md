# implementation フェーズで予期しないブランチが作成される

**仕様書 ID:** 6e16477a-c2b4-4474-96a6-848a7f17a640
**フェーズ:** design
**作成日時:** 2025/11/21 22:44:42
**更新日時:** 2025/11/22 00:47:13

---

## 1. 背景と目的

### 背景

実装フェーズの途中で spec/feb08af3 のような予期しないブランチの自動作成という問題が発生した。ブランチは仕様書作成時のみ作成されるべきで、フェーズ移行時や実装中に作成されるべきではない。根本原因を調査し、修正して欲しい。

### 目的

implementation フェーズ移行時に予期しないブランチが作成される問題の根本原因を特定し、修正する。これにより、1 つの仕様書に対して 1 つのブランチのみが作成されることを保証する。

---

## 2. 対象ユーザー

cc-craft-kit を使用する全開発者。

---

## 3. 受け入れ基準

### 必須要件

- [ ] コードレベルの調査を実施すること（対象は `src/commands/spec/create.ts` など 4 ファイル）
- [ ] implementation フェーズ移行時にブランチが作成される根本原因を特定すること
- [ ] 特定した根本原因を修正し、ブランチが仕様書作成時のみ作成されることを保証すること
- [ ] 修正後、仕様書作成から completed フェーズまでの全フローで予期しないブランチが作成されないことを確認すること

### 機能要件

- [ ] 仕様書作成時にブランチが作成されること（既存動作の維持）
- [ ] フェーズ移行時（requirements → design → tasks → implementation → completed）にブランチが作成されないこと
- [ ] CLAUDE.md の自動処理がブランチ作成を誘発しないこと

### 非機能要件

- [ ] 既存の仕様書やブランチに影響を与えないこと
- [ ] コミット `82cdc35` で削除された「フェーズ移行時のブランチ自動作成ロジック」の削除が正しく機能していること

---

## 4. 制約条件

- 既存の仕様書作成フローを変更しない（`/cft:spec-create` 実行時のブランチ作成は維持）
- コミット `82cdc35` で削除された `handleBranchCreationOnImplementation` 関数が復活していないことを確認
- CLAUDE.md の自動処理セクションが Claude Code に対してブランチ作成を指示していないことを確認

---

## 5. 依存関係

- `src/core/git/branch-creation.ts` - ブランチ作成ロジック
- `src/commands/spec/create.ts` - 仕様書作成コマンド（ブランチ作成を呼び出す）
- `src/commands/spec/phase.ts` - フェーズ移行コマンド
- `CLAUDE.md` - Claude Code への自動処理指示
- コミット `82cdc35` - フェーズ移行時のブランチ自動作成ロジック削除

---

## 6. 参考情報

- コミット `82cdc35`: フェーズ移行時のブランチ自動作成ロジックを削除
- コミット `ab1333c`: フェーズ移行時に不要なブランチが複数作成される問題を修正
- `src/core/workflow/branch-management.ts`: 削除された `handleBranchCreationOnImplementation` 関数があったファイル
- CLAUDE.md 145-156 行目: implementation フェーズ移行時の自動処理セクション

---

## 7. 調査結果

### コードレベルの調査結果

#### ブランチ作成ロジック（`src/core/git/branch-creation.ts`）

- 場所は `src/core/git/branch-creation.ts:46-157` である
- 関数は `createSpecBranch(specId: string, customBranchName?: string)` である
- 動作は仕様書 ID から `spec/<短縮ID>` 形式のブランチを作成することである
- 保護ブランチ対応として、`main` または `develop` から実行時は `feature/spec-` プレフィックス付きブランチを自動作成する
- セキュリティ対策として、UUID フォーマット検証とサニタイゼーションによりコマンドインジェクションを防止している
- 結論として、このロジック自体は仕様書作成時のみ呼び出されるため、問題なしである

#### 仕様書作成コマンド（`src/commands/spec/create.ts`）

- 場所は `src/commands/spec/create.ts:140-160` である
- 動作は仕様書作成時に `createSpecBranch()` を呼び出し、ブランチを自動作成することである
- ロールバック機能として、エラー時はブランチ、DB レコード、ファイルを削除する
- 結論として、正常に動作しており、問題なしである

#### フェーズ移行コマンド（`src/commands/spec/phase.ts`）

- 場所は `src/commands/spec/phase.ts:24-179` である
- 動作はフェーズ更新時に DB とファイルを更新し、`spec.phase_changed` イベントを発火することである
- ブランチ作成ロジックは呼び出していない
- 結論として、正常に動作しており、問題なしである

#### Git 統合ハンドラー（`src/core/workflow/branch-management.ts`）

- コミット `82cdc35` で 2025/11/21 19:38:32 に `handleBranchCreationOnImplementation` 関数を削除した
- 削除理由は、仕様書作成時に既にブランチが作成されるため、フェーズ移行時の再作成は不要であることである
- 結論として、削除は正しく、復活していないことを確認した

#### CLAUDE.md の自動処理セクション

- 場所は CLAUDE.md 145-156 行目である
- 内容は implementation フェーズ移行時の自動処理手順である
  1. 仕様書ファイルを Read ツールで読み込む
  2. 「8. 実装タスクリスト」セクションを確認
  3. TodoWrite ツールでタスクリストを表示し、進捗管理を開始
  4. 最初の未完了タスクを in_progress へ設定
  5. 対象ファイルを Read して実装を開始
  6. タスク完了後、TodoWrite で completed へ設定し、次のタスクへ自動移行
- ブランチ作成の記述はなしである
- 結論として、ブランチ作成を指示する記述は存在しない

### 根本原因の仮説

調査の結果、コードレベルではブランチ作成ロジックは正常に動作しており、フェーズ移行時にブランチが作成されるコードは存在しない。

考えられる根本原因は以下の 2 つです。

#### 仮説 1: Claude Code が CLAUDE.md の自動処理を誤解釈している

CLAUDE.md 145-156 行目の implementation フェーズ移行時の自動処理セクションには、ブランチ作成の指示はない。しかし、Claude Code は以下の理由でブランチを作成した可能性がある。

- 「実装を開始」という指示を「新しいブランチで実装を開始」と誤解釈したこと
- 過去の会話履歴やコンテキストから、実装開始時にブランチを作成する習慣を学習したこと
- CLAUDE.md の「注意として、確認は不要で自動的に作業を進める」という記述を、ブランチ作成も含めた「自動実行」と解釈したこと

#### 仮説 2: Claude Code が実装タスク実行時に独自にブランチを作成している

CLAUDE.md の自動処理セクションは以下を指示している。

- 「対象ファイルを Read して実装を開始」
- 「自動的に作業を進めてください」

Claude Code がこれを受けて、以下の推論をした可能性がある。

- 実装を開始する際に、新しいブランチを作成する（Git のベストプラクティスに従う）
- 仕様書 ID から `spec/<短縮ID>` 形式のブランチ名を生成する
- `createSpecBranch()` を直接呼び出すか、`git checkout -b` を実行する

### 再現方法の提案

以下の手順で問題を再現できる可能性がある。

1. 新しい仕様書を作成する（ブランチが自動作成される）
2. requirements → design → tasks フェーズへ移行する
3. tasks → implementation フェーズへ移行する
4. Claude Code が自動処理セクションに従って実装を開始する
5. この時点で予期しないブランチが作成されるか確認する
