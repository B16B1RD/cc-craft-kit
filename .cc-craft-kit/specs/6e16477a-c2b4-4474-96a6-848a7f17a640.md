# implementation フェーズで予期しないブランチが作成される

**仕様書 ID:** 6e16477a-c2b4-4474-96a6-848a7f17a640
**フェーズ:** completed
**作成日時:** 2025/11/21 22:44:42
**更新日時:** 2025/11/22 00:54:51

---

## 1. 背景と目的

### 背景

実装フェーズの途中で spec/feb08af3 のような予期しないブランチの自動作成という問題が発生した。ブランチは仕様書作成時のみ作成されるべきで、フェーズ移行時や実装中に作成されるべきではない。根本原因を調査し、修正して欲しい。

### 目的

implementation フェーズ移行時に予期しないブランチが作成される問題の根本原因を特定し、修正する。これにより、1 つの仕様書に対して 1 つのブランチのみが作成されることを保証する。

---

## 2. 対象ユーザー

cc-craft-kit を使用する全開発者。

---

## 3. 受け入れ基準

### 必須要件

- [ ] コードレベルの調査を実施すること（対象は `src/commands/spec/create.ts` など 4 ファイル）
- [ ] implementation フェーズ移行時にブランチが作成される根本原因を特定すること
- [ ] 特定した根本原因を修正し、ブランチが仕様書作成時のみ作成されることを保証すること
- [ ] 修正後、仕様書作成から completed フェーズまでの全フローで予期しないブランチが作成されないことを確認すること

### 機能要件

- [ ] 仕様書作成時にブランチが作成されること（既存動作の維持）
- [ ] フェーズ移行時（requirements → design → tasks → implementation → completed）にブランチが作成されないこと
- [ ] CLAUDE.md の自動処理がブランチ作成を誘発しないこと

### 非機能要件

- [ ] 既存の仕様書やブランチに影響を与えないこと
- [ ] コミット `82cdc35` で削除された「フェーズ移行時のブランチ自動作成ロジック」の削除が正しく機能していること

---

## 4. 制約条件

- 既存の仕様書作成フローを変更しない（`/cft:spec-create` 実行時のブランチ作成は維持）
- コミット `82cdc35` で削除された `handleBranchCreationOnImplementation` 関数が復活していないことを確認
- CLAUDE.md の自動処理セクションが Claude Code に対してブランチ作成を指示していないことを確認

---

## 5. 依存関係

- `src/core/git/branch-creation.ts` - ブランチ作成ロジック
- `src/commands/spec/create.ts` - 仕様書作成コマンド（ブランチ作成を呼び出す）
- `src/commands/spec/phase.ts` - フェーズ移行コマンド
- `CLAUDE.md` - Claude Code への自動処理指示
- コミット `82cdc35` - フェーズ移行時のブランチ自動作成ロジック削除

---

## 6. 参考情報

- コミット `82cdc35`: フェーズ移行時のブランチ自動作成ロジックを削除
- コミット `ab1333c`: フェーズ移行時に不要なブランチが複数作成される問題を修正
- `src/core/workflow/branch-management.ts`: 削除された `handleBranchCreationOnImplementation` 関数があったファイル
- CLAUDE.md 145-156 行目: implementation フェーズ移行時の自動処理セクション

---

## 7. 調査結果

### コードレベルの調査結果

#### ブランチ作成ロジック（`src/core/git/branch-creation.ts`）

- 場所は `src/core/git/branch-creation.ts:46-157` である
- 関数は `createSpecBranch(specId: string, customBranchName?: string)` である
- 動作は仕様書 ID から `spec/<短縮ID>` 形式のブランチを作成することである
- 保護ブランチ対応として、`main` または `develop` から実行時は `feature/spec-` プレフィックス付きブランチを自動作成する
- セキュリティ対策として、UUID フォーマット検証とサニタイゼーションによりコマンドインジェクションを防止している
- 結論として、このロジック自体は仕様書作成時のみ呼び出されるため、問題なしである

#### 仕様書作成コマンド（`src/commands/spec/create.ts`）

- 場所は `src/commands/spec/create.ts:140-160` である
- 動作は仕様書作成時に `createSpecBranch()` を呼び出し、ブランチを自動作成することである
- ロールバック機能として、エラー時はブランチ、DB レコード、ファイルを削除する
- 結論として、正常に動作しており、問題なしである

#### フェーズ移行コマンド（`src/commands/spec/phase.ts`）

- 場所は `src/commands/spec/phase.ts:24-179` である
- 動作はフェーズ更新時に DB とファイルを更新し、`spec.phase_changed` イベントを発火することである
- ブランチ作成ロジックは呼び出していない
- 結論として、正常に動作しており、問題なしである

#### Git 統合ハンドラー（`src/core/workflow/branch-management.ts`）

- コミット `82cdc35` で 2025/11/21 19:38:32 に `handleBranchCreationOnImplementation` 関数を削除した
- 削除理由は、仕様書作成時に既にブランチが作成されるため、フェーズ移行時の再作成は不要であることである
- 結論として、削除は正しく、復活していないことを確認した

#### CLAUDE.md の自動処理セクション

- 場所は CLAUDE.md 145-156 行目である
- 内容は implementation フェーズ移行時の自動処理手順である
  1. 仕様書ファイルを Read ツールで読み込む
  2. 「8. 実装タスクリスト」セクションを確認
  3. TodoWrite ツールでタスクリストを表示し、進捗管理を開始
  4. 最初の未完了タスクを in_progress へ設定
  5. 対象ファイルを Read して実装を開始
  6. タスク完了後、TodoWrite で completed へ設定し、次のタスクへ自動移行
- ブランチ作成の記述はなしである
- 結論として、ブランチ作成を指示する記述は存在しない

### 根本原因の仮説

調査の結果、コードレベルではブランチ作成ロジックは正常に動作しており、フェーズ移行時にブランチが作成されるコードは存在しない。

考えられる根本原因は以下の 2 つです。

#### 仮説 1: Claude Code が CLAUDE.md の自動処理を誤解釈している

CLAUDE.md 145-156 行目の implementation フェーズ移行時の自動処理セクションには、ブランチ作成の指示はない。しかし、Claude Code は以下の理由でブランチを作成した可能性がある。

- 「実装を開始」という指示を「新しいブランチで実装を開始」と誤解釈したこと
- 過去の会話履歴やコンテキストから、実装開始時にブランチを作成する習慣を学習したこと
- CLAUDE.md の「注意として、確認は不要で自動的に作業を進める」という記述を、ブランチ作成も含めた「自動実行」と解釈したこと

#### 仮説 2: Claude Code が実装タスク実行時に独自にブランチを作成している

CLAUDE.md の自動処理セクションは以下を指示している。

- 「対象ファイルを Read して実装を開始」
- 「自動的に作業を進めてください」

Claude Code がこれを受けて、以下の推論をした可能性がある。

- 実装を開始する際に、新しいブランチを作成する（Git のベストプラクティスに従う）
- 仕様書 ID から `spec/<短縮ID>` 形式のブランチ名を生成する
- `createSpecBranch()` を直接呼び出すか、`git checkout -b` を実行する

### 再現方法の提案

以下の手順で問題を再現できる可能性がある。

1. 新しい仕様書を作成する（ブランチが自動作成される）
2. requirements → design → tasks フェーズへ移行する
3. tasks → implementation フェーズへ移行する
4. Claude Code が自動処理セクションに従って実装を開始する
5. この時点で予期しないブランチが作成されるか確認する

---

## 8. 設計

### 修正方針

調査の結果、コードレベルでは問題がないことを判明しました。したがって、修正方針は以下の 2 つです。

#### 方針 1: CLAUDE.md の自動処理セクションを明確化する

**目的**: Claude Code がブランチ作成を誤解釈しないように、CLAUDE.md の記述を明確化する。

**修正内容**:

- implementation フェーズ移行時の自動処理セクション（CLAUDE.md 145-156 行目）に、以下の注意書きを追加する

```markdown
#### 重要: ブランチ作成について

implementation フェーズ移行時に、新しいブランチを作成してはいけません。ブランチは仕様書作成時に既に作成されています。

- ブランチ作成コマンド（`git checkout -b`, `git branch` など）を実行しない
- `createSpecBranch()` 関数を呼び出さない
- 現在のブランチで実装を進める
```

#### 方針 2: 再現テストを実施し、問題が解消されたことを確認する

**目的**: CLAUDE.md の修正により、問題が解消されたことを確認する。

**テスト手順**:

1. 新しい仕様書を作成する（ブランチが自動作成される）
2. requirements → design → tasks フェーズへ移行する
3. tasks → implementation フェーズへ移行する
4. Claude Code が自動処理セクションに従って実装を開始する
5. この時点でブランチが作成されないことを確認する

**検証項目**:

- `git branch` コマンドで、予期しないブランチが作成されていないこと
- `git log` コマンドで、不要なブランチ作成コミットがないこと
- 実装が現在のブランチで正常に進むこと

### 影響範囲

**修正対象ファイル**:

- `CLAUDE.md` (145-156 行目付近)

**影響を受けるコンポーネント**:

- なし（CLAUDE.md の記述のみを修正するため）

**既存機能への影響**:

- なし（コードレベルの修正は不要）

### リスク評価

**リスクレベル**: 低。

**理由**:

- コードレベルの修正は不要である
- CLAUDE.md の記述を明確化するのみである
- 既存の動作に影響を与えない

**懸念事項**:

- CLAUDE.md の修正だけでは、Claude Code の誤解釈を完全に防げない可能性がある
- その場合は、追加の対策（コードレベルの検証ロジック追加など）を検討する必要がある

### 代替案

#### 代替案 1: コードレベルでブランチ作成を検証する

フェーズ移行時に、現在のブランチが仕様書作成時に作成されたブランチと一致することを検証する。

**メリット**:

- Claude Code の誤解釈を確実に防げる
- コードレベルで保証される

**デメリット**:

- 実装コストが高い
- 既存のコードに変更を加える必要がある

**採用判断**: CLAUDE.md の修正で問題が解消されない場合に検討する。

#### 代替案 2: フェーズ移行時にブランチをロックする

implementation フェーズ移行時に、ブランチを読み取り専用にする。

**メリット**:

- ブランチ作成を物理的に防げる

**デメリット**:

- Git にはブランチロック機能がない
- 実装が困難

**採用判断**: 採用しない。

---

## 9. 実装タスクリスト

### タスク 1: CLAUDE.md の implementation フェーズ自動処理セクションにブランチ作成禁止の注意書きを追加

**優先度**: 高

**説明**:
CLAUDE.md の implementation フェーズ移行時の自動処理セクション（145-156 行目付近）に、ブランチ作成を禁止する明確な注意書きを追加する。

**実装内容**:
- CLAUDE.md を Read ツールで読み込む
- 145-156 行目付近の implementation フェーズ自動処理セクションを確認
- Edit ツールで以下の注意書きを追加する

```markdown
#### 重要: ブランチ作成について

implementation フェーズ移行時に、新しいブランチを作成してはいけません。ブランチは仕様書作成時に既に作成されています。

- ブランチ作成コマンド（`git checkout -b`, `git branch` など）を実行しない
- `createSpecBranch()` 関数を呼び出さない
- 現在のブランチで実装を進める
```

**検証方法**:
- CLAUDE.md を Read ツールで読み込み、注意書きが追加されていることを確認
- 追加箇所が implementation フェーズ自動処理セクションの直後であることを確認

**依存関係**: なし

### タスク 2: textlint でドキュメント品質をチェック

**優先度**: 中

**説明**:
CLAUDE.md の修正内容が textlint のルールに準拠していることを確認する。

**実装内容**:
- `/textlint-check CLAUDE.md` を実行
- エラーがある場合は修正

**検証方法**:
- textlint エラーが 0 件であること

**依存関係**: タスク 1

### タスク 3: 再現テストを実施（新しい仕様書を作成し、implementation フェーズまで移行）

**優先度**: 高

**説明**:
CLAUDE.md の修正により、問題が解消されたことを確認するため、再現テストを実施する。

**実装内容**:
1. 新しいテスト用仕様書を作成する（`/cft:spec-create "テスト: ブランチ作成問題の検証"`）
2. requirements → design → tasks フェーズへ移行する
3. tasks → implementation フェーズへ移行する
4. Claude Code が自動処理セクションに従って実装を開始する
5. この時点で予期しないブランチが作成されないことを確認する

**検証方法**:
- `git branch` コマンドで、予期しないブランチが作成されていないこと
- `git log` コマンドで、不要なブランチ作成コミットがないこと
- 実装が現在のブランチで正常に進むこと

**依存関係**: タスク 1, タスク 2

### タスク 4: git branch コマンドで予期しないブランチが作成されていないことを確認

**優先度**: 高

**説明**:
再現テスト完了後、予期しないブランチが作成されていないことを最終確認する。

**実装内容**:
- `git branch` コマンドを実行
- テスト用仕様書のブランチ（`spec/<短縮ID>-test`）以外に、予期しないブランチが作成されていないことを確認
- 必要に応じて、不要なブランチを削除

**検証方法**:
- `git branch` コマンドの出力に、テスト用ブランチのみが表示されること
- `git branch | grep "spec/" | wc -l` の出力が、期待される数（テスト用ブランチ数）と一致すること

**依存関係**: タスク 3
