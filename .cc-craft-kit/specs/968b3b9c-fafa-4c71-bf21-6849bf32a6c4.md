# /cft:status が別ブランチの仕様書ファイルを読み取ろうとしてエラーになる

**仕様書 ID:** 968b3b9c-fafa-4c71-bf21-6849bf32a6c4
**フェーズ:** review
**作成日時:** 2025/12/04 22:30:00
**更新日時:** 2025/12/04 23:56:00

---

## 1. 背景と目的

### 背景

`/cft:status` コマンド実行時に、DB に登録されているが現在のブランチにファイルが存在しない仕様書を読み取ろうとしてエラーが発生する。

具体的な問題:
1. 仕様書は `fix/spec-xxx` ブランチで作成され、DB に登録される（`branch_name` カラムに正しくブランチ名が記録される）
2. 仕様書ファイルはその作業ブランチにのみ存在し、`develop` ブランチにはマージされていない
3. `info.ts` は現在のブランチにファイルが存在するかどうかに関係なく、DB の全仕様書を `specs.recent` に含めて返す
4. `/cft:status` プロンプトの処理中に、存在しないファイル（例: `.cc-craft-kit/specs/b6407c28-xxx.md`）を Read しようとしてエラーになる

これは仕様書がブランチごとに管理される設計において、ステータス表示時の整合性チェックが不十分なために発生している。

### 目的

`/cft:status` コマンドが、現在のブランチに存在しない仕様書ファイルを読み取ろうとせず、エラーなく実行されるようにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:status` 実行時に、存在しないファイルの Read エラーが発生しない
- [ ] 別ブランチにのみ存在する仕様書は、適切にスキップまたは別途表示される

### 機能要件

- [ ] `info.ts` が返す `specs.recent` は、現在のブランチにファイルが存在する仕様書のみを含む
- [ ] または、別ブランチの仕様書であることを示すフラグを追加し、プロンプト側でスキップ可能にする
- [ ] 別ブランチの仕様書は「別ブランチで作業中」として一覧に表示される（オプション）

### 非機能要件

- [ ] 既存の `/cft:status` の表示フォーマットを大きく変更しない
- [ ] パフォーマンスへの影響を最小限にする

---

## 4. 制約条件

- 仕様書ファイルはブランチごとに管理される設計を維持する
- DB の `branch_name` カラムを活用して判定する
- `info.ts` スクリプトの修正で対応する（プロンプトのみの修正は根本解決にならない）

---

## 5. 依存関係

- `.cc-craft-kit/commands/status.ts` - `/cft:status` の主要実装（`getSpecsWithGitHubInfo()` 呼び出し箇所）
- `.cc-craft-kit/commands/status/info.ts` - ステータス情報取得の CLI エントリポイント
- `.cc-craft-kit/commands/status/get-status.ts` - `specs.recent` の取得ロジック
- `.cc-craft-kit/core/database/helpers.ts` - `getSpecsWithGitHubInfo()` の実装（`branchName` オプションあり）
- `.cc-craft-kit/core/git/branch-cache.ts` - `getCurrentBranch()` の実装
- `.claude/commands/cft/status.md` - ステータス表示プロンプト（Step 1.5 で仕様書ファイル読み込み）
- `.cc-craft-kit/core/sync/integrity-checker.ts` - ブランチフィルタリングの参考実装

---

## 6. 参考情報

- 発生した具体例: 仕様書 ID `b6407c28-cd21-4588-998c-ee247eabe264` が `fix/spec-b6407c28-fix-duplicate-sub-issue-creation` ブランチに存在するが、`develop` ブランチで `/cft:status` 実行時にファイル読み取りエラー
- 関連する過去の仕様書: 整合性チェックのブランチフィルタリング関連

### 原因分析

**status.ts の実装（L.173）**:
```typescript
const specs = await getSpecsWithGitHubInfo(db, {
  orderBy: 'created_at',
  orderDirection: 'desc',
  // ⚠️ branchName オプションが指定されていない！
});
```

`getSpecsWithGitHubInfo()` に `branchName` オプションが指定されていないため、すべてのブランチの仕様書が取得される。

### 推奨される実装アプローチ

**アプローチ 1: status.ts でブランチフィルタリング（最小変更・推奨）**

```typescript
const currentBranch = getCurrentBranch();

const specs = await getSpecsWithGitHubInfo(db, {
  branchName: currentBranch,  // 現在のブランチで作成された仕様書のみ取得
  orderBy: 'created_at',
  orderDirection: 'desc',
});
```

**メリット**:
- 別ブランチの仕様書を除外
- ファイル読み取りエラーを防止
- 最小限のコード変更
- `main` / `develop` の仕様書は常に表示される（helpers.ts の既存ロジック）

**アプローチ 2: status.md でファイル存在チェック（防御的）**

Step 1.5 の進捗バー生成時に、ファイル存在チェックを追加。

**アプローチ 3: 別ブランチ警告表示（オプション）**

別ブランチの仕様書が存在する場合、ユーザーに通知。

### 参考実装

- `spec/get.ts` の `handleBranchMismatch()` 関数（L.20-64）
- `integrity-checker.ts` の `allowedBranches` ロジック（L.57-75）

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
/cft:status 実行フロー（修正後）

┌─────────────────────────────────────────────────────────────────┐
│  status.md (プロンプト)                                          │
│  └─ Step 1.5: specs.recent の仕様書ファイルを Read               │
└─────────────────────────────────────────────────────────────────┘
                              ↑ specs.recent
┌─────────────────────────────────────────────────────────────────┐
│  status.ts                                                       │
│  └─ getSpecsWithGitHubInfo(db, { branchName: currentBranch })   │
│      ↑ getCurrentBranch() で現在のブランチを取得                  │
└─────────────────────────────────────────────────────────────────┘
                              ↑ SQL フィルタリング
┌─────────────────────────────────────────────────────────────────┐
│  helpers.ts: getSpecsWithGitHubInfo()                            │
│  └─ WHERE branch_name IN (currentBranch, 'main', 'develop')      │
└─────────────────────────────────────────────────────────────────┘
                              ↑ DB クエリ
┌─────────────────────────────────────────────────────────────────┐
│  SQLite DB (specs テーブル)                                       │
│  └─ branch_name カラム: 仕様書が作成されたブランチ名              │
└─────────────────────────────────────────────────────────────────┘
```

#### 設計方針

- **DB レベルでのフィルタリング**: `getSpecsWithGitHubInfo()` の既存オプション `branchName` を活用
- **ブランチ許可リスト**: 現在のブランチ + `main` + `develop` の仕様書のみを返す
- **既存資産の活用**: `getCurrentBranch()` と `branchName` オプションはすでに実装済み
- **最小変更**: 2 ファイルに 3 行の追加のみ

#### 処理フロー詳細

```
1. `/cft:status` 実行
     ↓
2. status.ts: getCurrentBranch() → 'develop' (例)
     ↓
3. status.ts: getSpecsWithGitHubInfo(db, { branchName: 'develop', ... })
     ↓
4. helpers.ts: SQL WHERE 句に branch_name フィルタを追加
   → branch_name IN ('develop', 'main', 'develop')
     ↓
5. DB: フィルタリングされた仕様書のみ返す
   → 別ブランチ（fix/spec-xxx など）の仕様書は除外
     ↓
6. status.ts: specs.recent に現在のブランチの仕様書のみ含む
     ↓
7. status.md: specs.recent の各仕様書ファイルを Read
   → すべてのファイルが存在 → エラーなし
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `.cc-craft-kit/commands/status.ts` | `getCurrentBranch()` をインポートし、`getSpecsWithGitHubInfo()` に `branchName` オプションを追加 |
| `.cc-craft-kit/commands/status/get-status.ts` | `getCurrentBranch()` をインポートし、`getSpecsWithGitHubInfo()` に `branchName` オプションを追加 |

#### 修正内容（status.ts L.173-176）

```typescript
// 修正前
const specs = await getSpecsWithGitHubInfo(db, {
  orderBy: 'created_at',
  orderDirection: 'desc',
});

// 修正後
const currentBranch = getCurrentBranch();
const specs = await getSpecsWithGitHubInfo(db, {
  branchName: currentBranch,  // ← 追加
  orderBy: 'created_at',
  orderDirection: 'desc',
});
```

#### 修正内容（get-status.ts L.59-62）

```typescript
// 修正前
const allSpecs = await getSpecsWithGitHubInfo(db, {
  orderBy: 'created_at',
  orderDirection: 'desc',
});

// 修正後
const currentBranch = getCurrentBranch();
const allSpecs = await getSpecsWithGitHubInfo(db, {
  branchName: currentBranch,  // ← 追加
  orderBy: 'created_at',
  orderDirection: 'desc',
});
```

#### 必要なインポート追加

```typescript
// status.ts
import { getCurrentBranch } from '../core/git/branch-cache.js';

// get-status.ts
import { getCurrentBranch } from '../../core/git/branch-cache.js';
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| 仕様書一覧取得 | 全ブランチの仕様書を取得 | 現在のブランチ + main + develop の仕様書のみ取得 | status.ts L.173 |
| ステータス情報取得 | 全ブランチの仕様書を取得 | 現在のブランチ + main + develop の仕様書のみ取得 | get-status.ts L.59 |
| ブランチ名取得 | なし | `getCurrentBranch()` で取得 | 各ファイルで import |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| status.ts | ブランチフィルタリングが有効か | 別ブランチで仕様書を作成し、develop で `/cft:status` 実行時にその仕様書が表示されないことを確認 |
| get-status.ts | 戻り値のフィルタリング | `getStatusInfo()` の戻り値に別ブランチの仕様書が含まれないことを確認 |
| main/develop の仕様書 | 共有仕様書の表示 | main または develop で作成された仕様書が別ブランチでも表示されることを確認 |
| エラーなし確認 | Read エラーが発生しない | `/cft:status` 実行時にファイル読み取りエラーが発生しないことを確認 |

### 7.5 移行計画

#### Phase 1: status.ts の修正

1. `getCurrentBranch` をインポート追加
2. `getSpecsWithGitHubInfo()` に `branchName: currentBranch` を追加
3. 動作確認

#### Phase 2: get-status.ts の修正

1. `getCurrentBranch` をインポート追加
2. `getSpecsWithGitHubInfo()` に `branchName: currentBranch` を追加
3. 動作確認

#### Phase 3: テスト・検証

1. 型チェック・リント実行
2. 手動テスト: 別ブランチで仕様書を作成し、develop で `/cft:status` 実行
3. 既存テストが通ることを確認

---

## 8. 実装タスクリスト

### Phase 1: status.ts の修正

- [x] status.ts に getCurrentBranch をインポート追加 (#740)
- [x] status.ts の getSpecsWithGitHubInfo() に branchName オプションを追加 (#741)

### Phase 2: get-status.ts の修正

- [x] get-status.ts に getCurrentBranch をインポート追加 (#742)
- [x] get-status.ts の getSpecsWithGitHubInfo() に branchName オプションを追加 (#743)

### Phase 3: テスト・検証

- [x] 型チェック・リント実行で問題がないことを確認 (#744)
- [x] 手動テスト: /cft:status が別ブランチの仕様書でエラーにならないことを確認 (#745)
