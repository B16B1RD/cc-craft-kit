# /cft:spec-phase <id> completed の PR 作成のマージ先が間違っている

**仕様書 ID:** 404dbb3e-3d00-4264-87bf-78f95f0262ee
**フェーズ:** completed
**作成日時:** 2025/11/25 00:10:19
**更新日時:** 2025/11/25 00:50:10

---

## 1. 背景と目的

### 背景

現在、`/cft:spec-phase <id> completed` コマンドで completed フェーズへ移行する際に PR が自動作成されますが、`gh pr create` コマンドに `--base` オプションが指定されていないため、デフォルトブランチ（main）へマージされる可能性があります。

プロジェクトのブランチ戦略では、以下のように PR のマージ先が定義されています:

- **通常の作業ブランチ** (feature/fix/refactor/docs/chore) → `develop` へマージ
- **hotfix ブランチ** → `main` へマージ

しかし、現在の実装では `.env` で定義された `BASE_BRANCH` 環境変数を参照していないため、マージ先が意図しないブランチになる問題があります。

**問題箇所**: `src/slash-commands/spec-phase.md` の Step 5（行172-196）

### 目的

PR 作成時に正しいマージ先ブランチを指定するよう修正します。

- hotfix ブランチの場合 → `main` へマージ
- その他のブランチの場合 → `.env` の `BASE_BRANCH` で指定されたブランチ（通常は `develop`）へマージ

---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者全員。

特に、以下のシナリオで影響を受けます:

- 仕様書を completed フェーズに移行する開発者
- PR 作成の自動化を利用する開発者
- ブランチ戦略（develop / main）を採用しているチーム

---

## 3. 受け入れ基準

### 必須要件

- [ ] PR 作成時に `--base` オプションでマージ先ブランチを指定すること
- [ ] hotfix ブランチの場合、マージ先を `main` とすること
- [ ] その他のブランチの場合、マージ先を `.env` の `BASE_BRANCH` とすること
- [ ] `BASE_BRANCH` 環境変数が未設定の場合、デフォルト値 `develop` を使用すること

### 機能要件

- [ ] 現在のブランチ名から hotfix 判定を自動的に行うこと
- [ ] `gh pr create` コマンド実行前にマージ先ブランチを決定すること
- [ ] マージ先ブランチの決定ロジックをプロンプト内に実装すること（スクリプト修正不要）
- [ ] エラーメッセージでマージ先ブランチを表示すること（デバッグ用）

### 非機能要件

- [ ] プロンプトベース実装のみで完結すること（スクリプト変更なし）
- [ ] 既存の PR 作成フローを壊さないこと
- [ ] `.env` ファイルの変更は不要であること（既存の `BASE_BRANCH` を使用）

---

## 4. 制約条件

- **プロンプトベース実装**: スラッシュコマンド（.md ファイル）の修正のみで対応する
- **スクリプト変更禁止**: `src/commands/spec/phase.ts` の修正は行わない
- **環境変数依存**: `.env` の `BASE_BRANCH` が正しく設定されていることを前提とする
- **Bash ツールの使用**: ブランチ名取得、環境変数読み込みは Bash ツールで実装する
- **GitHub CLI**: `gh` コマンドがインストールされていることを前提とする

---

## 5. 依存関係

### 依存ファイル

- **`src/slash-commands/spec-phase.md`**: completed フェーズ移行時の PR 作成ロジック（修正対象）
- **`.env`**: `BASE_BRANCH` 環境変数の定義
- **`CLAUDE.md`**: ブランチ戦略の定義（参考情報）

### 関連コンポーネント

- **`src/core/config/github-config.ts`**: GitHub 設定の管理（`BASE_BRANCH` のデフォルト値）
- **`src/core/utils/branch-name-generator.ts`**: ブランチプレフィックス判定ロジック（参考情報）

### 前提条件

- `.env` に `BASE_BRANCH` が定義されていること（未設定の場合は `develop` がデフォルト）
- `gh` コマンドがインストールされ、認証済みであること
- Git リポジトリの `main` および `develop` ブランチが存在すること

---

## 6. 参考情報

### ブランチ戦略

- **GitHub Flow + develop ブランチ**: `CLAUDE.md` 行35-89
  - feature/fix/refactor/docs/chore → `develop` へマージ
  - hotfix → `main` へマージ

### 関連 Issue・PR

- 過去の類似修正があれば記載

### 参考ドキュメント

- [GitHub CLI: gh pr create](https://cli.github.com/manual/gh_pr_create)
- [cc-craft-kit CLAUDE.md](./CLAUDE.md) - ブランチ戦略セクション

---

## 7. 設計詳細

### 7.1. アーキテクチャ設計

#### 現状の問題点

現在の `src/slash-commands/spec-phase.md` の Step 5（行172-196）では、`gh pr create` コマンドに `--base` オプションが指定されていません。このため、GitHub CLI がデフォルトブランチ（通常は `main`）をマージ先と判断します。

```bash
# 現在の実装（問題あり）
gh pr create \
  --title "feat: <仕様書名> を実装完了" \
  --body "$(cat <<'EOF'
...
EOF
)"
```

#### 設計方針

**プロンプトベース実装**により、以下のロジックを追加します:

1. **環境変数からベースブランチを取得**
   - `.env` の `BASE_BRANCH` を読み込み
   - 未設定の場合は `develop` をデフォルト値とする

2. **現在のブランチ名からhotfix判定**
   - `git branch --show-current` でブランチ名を取得
   - ブランチ名が `hotfix/` で始まる場合、マージ先を `main` とする
   - それ以外の場合、マージ先を `BASE_BRANCH` とする

3. **`gh pr create` に `--base` オプションを追加**
   - 決定したマージ先ブランチを `--base` オプションで指定

#### データフロー

```
┌─────────────────────────┐
│ 1. 環境変数読み込み      │
│    BASE_BRANCH=develop   │
└────────────┬────────────┘
             │
┌────────────▼────────────┐
│ 2. ブランチ名取得        │
│    git branch --show-   │
│    current              │
└────────────┬────────────┘
             │
┌────────────▼────────────┐
│ 3. hotfix判定            │
│    branchName.starts    │
│    With('hotfix/')      │
└────────────┬────────────┘
             │
        ┌────┴────┐
        │         │
     YES│         │NO
        │         │
   ┌────▼────┐  ┌▼─────────┐
   │ main    │  │BASE_BRANCH│
   └────┬────┘  └┬─────────┘
        │         │
        └────┬────┘
             │
┌────────────▼────────────┐
│ 4. PR作成                │
│    gh pr create --base  │
│    <決定したブランチ>    │
└─────────────────────────┘
```

### 7.2. データモデル

データベーススキーマの変更は不要です。既存の `github_sync` テーブルで十分対応可能です。

### 7.3. API 仕様

#### 修正対象ファイル

- **ファイル名**: `src/slash-commands/spec-phase.md`
- **修正範囲**: Step 5（行172-196）

#### 修正前

```markdown
#### Step 5: PR 作成

1. **PR 作成**: Bash ツールで `gh pr create` 実行
   ```bash
   gh pr create \
     --title "feat: <仕様書名> を実装完了" \
     --body "$(cat <<'EOF'
   ## Summary
   ...
   EOF
   )"
   ```
```

#### 修正後

```markdown
#### Step 5: PR 作成

1. **ベースブランチの決定**: Bash ツールで以下の処理を実行
   ```bash
   # 環境変数からベースブランチを取得（デフォルト: develop）
   BASE_BRANCH=$(grep '^BASE_BRANCH=' .env | cut -d'=' -f2 | tr -d '"' | xargs)
   BASE_BRANCH=${BASE_BRANCH:-develop}

   # 現在のブランチ名を取得
   CURRENT_BRANCH=$(git branch --show-current)

   # hotfix判定: hotfix/ で始まる場合は main、それ以外は BASE_BRANCH
   if [[ "$CURRENT_BRANCH" == hotfix/* ]]; then
     TARGET_BASE="main"
   else
     TARGET_BASE="$BASE_BRANCH"
   fi

   echo "マージ先ブランチ: $TARGET_BASE"
   ```

2. **PR 作成**: Bash ツールで `gh pr create` 実行
   ```bash
   gh pr create \
     --base "$TARGET_BASE" \
     --title "feat: <仕様書名> を実装完了" \
     --body "$(cat <<'EOF'
   ## Summary

   <「1. 背景と目的」と「3. 受け入れ基準」を要約>

   ## Test plan

   - [ ] 単体テスト実施
   - [ ] 統合テスト実施
   - [ ] コードレビュー完了

   ---

   🤖 Generated with [Claude Code](https://claude.com/claude-code)

   Co-Authored-By: Claude <noreply@anthropic.com>
   EOF
   )"
   ```
```

#### コマンド実行時の出力例

```bash
# feature ブランチの場合
$ /cft:spec-phase 404dbb3e completed
マージ先ブランチ: develop
✓ Pull Request が正常に作成されました！

# hotfix ブランチの場合
$ /cft:spec-phase 404dbb3e completed
マージ先ブランチ: main
✓ Pull Request が正常に作成されました！
```

### 7.4. セキュリティ考慮事項

#### 1. 環境変数の安全な読み込み

- **脅威**: `.env` ファイルが存在しない場合のエラー
- **対策**: `grep` の終了コードを確認せず、空文字列の場合にデフォルト値を使用

```bash
BASE_BRANCH=$(grep '^BASE_BRANCH=' .env | cut -d'=' -f2 | tr -d '"' | xargs)
BASE_BRANCH=${BASE_BRANCH:-develop}  # 空の場合は develop を使用
```

#### 2. ブランチ名のバリデーション

- **脅威**: 予期しないブランチ名によるコマンドインジェクション
- **対策**: `git branch --show-current` の出力を直接 Bash 変数に格納（シェルエスケープ不要）

```bash
CURRENT_BRANCH=$(git branch --show-current)
```

#### 3. GitHub CLI の認証状態確認

- **脅威**: 認証失敗時の PR 作成エラー
- **対策**: Step 3 で `gh auth status` を実行し、認証済みであることを確認（既存実装で対応済み）

#### 4. プロテクトブランチへのプッシュ

- **脅威**: `main` や `develop` への直接プッシュ
- **対策**: GitHub リポジトリ設定でブランチ保護ルールを有効化（リポジトリ設定で対応）

### 7.5. テスト戦略

#### 単体テスト

プロンプトベース実装のため、単体テストは作成しません。

#### 統合テスト

以下のシナリオで手動テストを実施します。

##### テストケース 1: feature ブランチから completed への遷移

**前提条件**:
- `.env` に `BASE_BRANCH=develop` が設定されている
- 現在のブランチ名: `feature/spec-404dbb3e-fix-pr-merge-target-branch`

**実行手順**:
1. `/cft:spec-phase 404dbb3e completed` を実行
2. PR 作成時のコマンド出力を確認

**期待結果**:
- マージ先ブランチが `develop` と表示される
- `gh pr create --base develop` が実行される
- PR が正常に作成される

##### テストケース 2: hotfix ブランチから completed への遷移

**前提条件**:
- `.env` に `BASE_BRANCH=develop` が設定されている
- 現在のブランチ名: `hotfix/critical-security-patch`

**実行手順**:
1. `/cft:spec-phase <spec-id> completed` を実行
2. PR 作成時のコマンド出力を確認

**期待結果**:
- マージ先ブランチが `main` と表示される
- `gh pr create --base main` が実行される
- PR が正常に作成される

##### テストケース 3: BASE_BRANCH 環境変数が未設定の場合

**前提条件**:
- `.env` に `BASE_BRANCH` が設定されていない
- 現在のブランチ名: `feature/spec-xxx-test-feature`

**実行手順**:
1. `/cft:spec-phase <spec-id> completed` を実行
2. PR 作成時のコマンド出力を確認

**期待結果**:
- マージ先ブランチが `develop`（デフォルト値）と表示される
- `gh pr create --base develop` が実行される
- PR が正常に作成される

##### テストケース 4: GitHub CLI 未認証の場合

**前提条件**:
- `gh auth status` が失敗する状態
- 現在のブランチ名: `feature/spec-xxx-test-feature`

**実行手順**:
1. `/cft:spec-phase <spec-id> completed` を実行

**期待結果**:
- Step 3 で認証エラーが検出される
- `gh auth login` を実行するよう案内される
- PR 作成処理は実行されない

#### パフォーマンステスト

- **対象**: Bash コマンド実行のオーバーヘッド
- **目標**: PR 作成処理全体で 5 秒以内に完了
- **測定方法**: `time` コマンドで実行時間を計測

#### 回帰テスト

既存の PR 作成フローが壊れていないことを確認します。

- [ ] Step 1-4 が正常に動作すること
- [ ] Step 6-7 が正常に動作すること
- [ ] 仕様書ファイルと `github_sync` テーブルが正しく更新されること
