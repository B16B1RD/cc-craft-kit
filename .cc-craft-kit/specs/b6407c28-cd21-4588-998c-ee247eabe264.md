# Sub Issue が重複して作成される

**仕様書 ID:** b6407c28-cd21-4588-998c-ee247eabe264
**フェーズ:** requirements
**作成日時:** 2025/12/04 20:15:00
**更新日時:** 2025/12/04 20:15:00

---

## 1. 背景と目的

### 背景

design フェーズで Sub Issue 作成時に、既存の Sub Issue をチェックせずに重複作成してしまう問題が発生している。実際に #725-#730 と #731-#736 のように同じタスクの Sub Issue が 2 セット作成された。

原因は design フェーズで Sub Issue 作成処理が 2 回実行されること:
1. `github-integration.ts` の `spec.phase_changed` イベントハンドラーによる自動作成
2. `spec-phase.md` の design フェーズ処理（Step 5）での手動呼び出し

さらに、`SubIssueManager.createSubIssuesFromTaskList()` には既存 Sub Issue のチェックロジックがなく、タスク ID も毎回 `randomUUID()` で再生成されるため、同一タスクかどうかを判定できない。

### 目的

Sub Issue 作成時に既存の Sub Issue をチェックし、重複作成を防止する

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発（SDD）を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] 同じ親 Issue に対して同じタイトルの Sub Issue が複数作成されない
- [ ] 既存の Sub Issue がある場合、作成をスキップしてログを出力する

### 機能要件

- [ ] Sub Issue 作成前に、親 Issue に紐づく既存 Sub Issue を取得する
- [ ] 新規タスクと既存 Sub Issue のタイトルを比較し、重複を検出する
- [ ] 重複検出時は「ℹ️ Sub Issue already exists: {タイトル}」のようなログを出力する
- [ ] 重複でない新規タスクのみ Sub Issue を作成する

### 非機能要件

- [ ] 既存の Sub Issue 取得は GitHub API 呼び出し 1 回で完了する
- [ ] 重複チェックのオーバーヘッドは許容範囲内（数秒以内）

---

## 4. 制約条件

- プロンプトファースト原則に従い、ロジック変更は TypeScript で実装
- 既存の `SubIssueManager` クラスの API を大きく変更しない
- GitHub API のレート制限を考慮する
- 既存の DB スキーマ（`github_sync` テーブル）との互換性を維持

---

## 5. 依存関係

- `src/integrations/github/sub-issues.ts` - SubIssueManager クラス（修正対象）
- `src/core/workflow/github-integration.ts` - イベントハンドラー（確認対象）
- `src/slash-commands/spec-phase.md` - design フェーズ処理（確認対象）
- `src/commands/github/create-sub-issues.ts` - CLI コマンド
- `src/core/database/schema.ts` - DB スキーマ（`github_sync` テーブル）

---

## 6. 参考情報

- 重複発生事例: #725-#730 と #731-#736
- 親 Issue: #712（CI が失敗する PR が作成されることがある）
- GitHub Sub Issue API: GraphQL mutation `addSubIssue`
