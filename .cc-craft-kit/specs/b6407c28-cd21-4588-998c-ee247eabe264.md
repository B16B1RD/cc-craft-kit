# Sub Issue が重複して作成される

**仕様書 ID:** b6407c28-cd21-4588-998c-ee247eabe264
**フェーズ:** review
**作成日時:** 2025/12/04 20:15:00
**更新日時:** 2025/12/04 21:30:00

---

## 1. 背景と目的

### 背景

design フェーズで Sub Issue 作成時に、既存の Sub Issue をチェックせずに重複作成してしまう問題が発生している。実際に #725-#730 と #731-#736 のように同じタスクの Sub Issue が 2 セット作成された。

原因は design フェーズで Sub Issue 作成処理が 2 回実行されること:
1. `github-integration.ts` の `spec.phase_changed` イベントハンドラーによる自動作成
2. `spec-phase.md` の design フェーズ処理（Step 5）での手動呼び出し

さらに、`SubIssueManager.createSubIssuesFromTaskList()` には既存 Sub Issue のチェックロジックがなく、タスク ID も毎回 `randomUUID()` で再生成されるため、同一タスクかどうかを判定できない。

### 目的

Sub Issue 作成時に既存の Sub Issue をチェックし、重複作成を防止する

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発（SDD）を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] 同じ親 Issue に対して同じタイトルの Sub Issue が複数作成されない
- [ ] 既存の Sub Issue がある場合、作成をスキップしてログを出力する

### 機能要件

- [ ] Sub Issue 作成前に、親 Issue に紐づく既存 Sub Issue を取得する
- [ ] 新規タスクと既存 Sub Issue のタイトルを比較し、重複を検出する
- [ ] 重複検出時は「ℹ️ Sub Issue already exists: {タイトル}」のようなログを出力する
- [ ] 重複でない新規タスクのみ Sub Issue を作成する

### 非機能要件

- [ ] 既存の Sub Issue 取得は GitHub API 呼び出し 1 回で完了する
- [ ] 重複チェックのオーバーヘッドは許容範囲内（数秒以内）

---

## 4. 制約条件

- プロンプトファースト原則に従い、ロジック変更は TypeScript で実装
- 既存の `SubIssueManager` クラスの API を大きく変更しない
- GitHub API のレート制限を考慮する
- 既存の DB スキーマ（`github_sync` テーブル）との互換性を維持

---

## 5. 依存関係

- `src/integrations/github/sub-issues.ts` - SubIssueManager クラス（修正対象）
- `src/core/workflow/github-integration.ts` - イベントハンドラー（確認対象）
- `src/slash-commands/spec-phase.md` - design フェーズ処理（確認対象）
- `src/commands/github/create-sub-issues.ts` - CLI コマンド
- `src/core/database/schema.ts` - DB スキーマ（`github_sync` テーブル）

---

## 6. 参考情報

- 重複発生事例: #725-#730 と #731-#736
- 親 Issue: #712（CI が失敗する PR が作成されることがある）
- GitHub Sub Issue API: GraphQL mutation `addSubIssue`

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
┌─────────────────────────────────────────────────────────────┐
│                    Sub Issue 作成フロー                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    ┌──────────────────┐                   │
│  │ spec-phase  │───▶│ create-sub-      │                   │
│  │ .md (手動)  │    │ issues.ts        │                   │
│  └─────────────┘    └────────┬─────────┘                   │
│                              │                              │
│  ┌─────────────┐             ▼                              │
│  │ github-     │    ┌──────────────────┐                   │
│  │ integration │───▶│ SubIssueManager  │                   │
│  │ .ts (自動)  │    │ .createSubIssues │                   │
│  └─────────────┘    │ FromTaskList()   │                   │
│                     └────────┬─────────┘                   │
│                              │                              │
│                              ▼                              │
│                     ┌──────────────────┐                   │
│                     │ 【新規追加】      │                   │
│                     │ getExistingSub   │◀── GitHub API     │
│                     │ IssuesForParent()│    1回の呼び出し  │
│                     └────────┬─────────┘                   │
│                              │                              │
│                              ▼                              │
│                     ┌──────────────────┐                   │
│                     │ 重複チェック      │                   │
│                     │ (タイトル比較)   │                   │
│                     └────────┬─────────┘                   │
│                              │                              │
│         ┌────────────────────┼────────────────────┐        │
│         ▼                    ▼                    ▼        │
│  ┌─────────────┐    ┌─────────────┐     ┌─────────────┐   │
│  │ 重複あり    │    │ 新規作成    │     │ github_sync │   │
│  │ → スキップ  │    │ → API呼出  │     │ に記録      │   │
│  │ → ログ出力  │    └─────────────┘     └─────────────┘   │
│  └─────────────┘                                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 設計方針

1. **既存 Sub Issue 取得の一括化**: 親 Issue に紐づく既存 Sub Issue を 1 回の API 呼び出しで取得
2. **タイトルベースの重複検出**: タスク ID ではなくタイトル文字列で重複を判定
3. **冪等性の確保**: 同じ処理を何度実行しても結果が同じになる設計

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/integrations/github/sub-issues.ts` | `getExistingSubIssuesForParent()` メソッド追加、`createSubIssuesFromTaskList()` に重複チェックロジック追加 |

#### 実装詳細

**1. 既存 Sub Issue 取得メソッドの追加**

```typescript
/**
 * 親 Issue に紐づく既存の Sub Issue を取得する
 * @param owner リポジトリオーナー
 * @param repo リポジトリ名
 * @param parentIssueNumber 親 Issue 番号
 * @param token GitHub トークン
 * @returns 既存 Sub Issue のタイトル一覧（Set）
 */
async getExistingSubIssuesForParent(
  owner: string,
  repo: string,
  parentIssueNumber: number,
  token: string
): Promise<Set<string>>
```

**2. GraphQL クエリ**

```graphql
query GetSubIssues($owner: String!, $repo: String!, $issueNumber: Int!) {
  repository(owner: $owner, name: $repo) {
    issue(number: $issueNumber) {
      subIssues(first: 100) {
        nodes {
          title
          number
          state
        }
      }
    }
  }
}
```

**3. 重複チェックロジック**

```typescript
// createSubIssuesFromTaskList() 内の修正
const existingTitles = await this.getExistingSubIssuesForParent(
  owner, repo, parentIssueNumber, token
);

for (const task of config.taskList) {
  if (existingTitles.has(task.title)) {
    console.log(`ℹ️ Sub Issue already exists: ${task.title}`);
    continue;  // スキップ
  }
  // 新規作成処理...
}
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| Sub Issue 作成 | チェックなしで常に作成 | 既存チェック後に作成 | `createSubIssuesFromTaskList()` |
| 既存 Sub Issue 取得 | なし | GraphQL で一括取得 | `getExistingSubIssuesForParent()` |
| 重複検出 | なし | タイトル文字列比較 | `createSubIssuesFromTaskList()` |
| ログ出力 | なし | 重複時にスキップログ | `createSubIssuesFromTaskList()` |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| `getExistingSubIssuesForParent()` | 正常系：Sub Issue 取得成功 | モック API レスポンス |
| `getExistingSubIssuesForParent()` | 異常系：API エラー時の処理 | エラーレスポンスのモック |
| `createSubIssuesFromTaskList()` | 重複時：スキップされる | 既存タイトルを含むタスクリスト |
| `createSubIssuesFromTaskList()` | 新規時：正常に作成される | 新規タイトルのタスクリスト |
| 結合テスト | 2 回実行で重複なし | 手動テスト |

### 7.5 移行計画

#### Phase 1: 既存 Sub Issue 取得機能の実装

1. `getExistingSubIssuesForParent()` メソッドを `SubIssueManager` に追加
2. GraphQL クエリの実装とテスト

#### Phase 2: 重複チェックロジックの統合

1. `createSubIssuesFromTaskList()` に重複チェックを追加
2. スキップ時のログ出力実装

#### Phase 3: 動作検証

1. 型チェック・リント実行
2. 手動テスト（design フェーズ 2 回実行で重複なし確認）

---

## 8. 実装タスクリスト

### Phase 1: 既存 Sub Issue 取得機能の実装

- [x] `getExistingSubIssuesForParent()` メソッドを SubIssueManager に追加 (#747)
- [x] GraphQL クエリで親 Issue の Sub Issue 一覧を取得する実装 (#748)

### Phase 2: 重複チェックロジックの統合

- [x] `createSubIssuesFromTaskList()` の冒頭で既存 Sub Issue を取得 (#749)
- [x] タスクループ内で重複チェックとスキップログを実装 (#750)

### Phase 3: 動作検証

- [x] 型チェック・リント実行で問題なしを確認 (#751)
- [x] 手動テストで重複防止を確認 (#752)
