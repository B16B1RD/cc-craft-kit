# CI が失敗する PR が作成される

**仕様書 ID:** 2feaa5bf-2257-4c65-a4c0-0e770274a811
**フェーズ:** implementation
**作成日時:** 2025/12/04 12:00:00
**更新日時:** 2025/12/04 19:40:00

---

## 1. 背景と目的

### 背景

現在、cc-craft-kit では PR #738 で review フェーズ移行時の品質チェック（TypeScript 型チェック・ESLint）を導入済みだが、依然として CI が失敗する PR が作成されることがある。これは開発者の時間を無駄にし、レビュアーの負担を増加させる。CI が失敗しない PR を作成すべき。

### 目的

PR 作成前に CI で実行されるすべてのチェックをローカルで事前実行し、CI が失敗する PR の作成を防止する。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] review フェーズ移行時に CI で実行されるすべてのチェックが事前実行される
- [ ] チェック失敗時は PR 作成をスキップし、具体的なエラー内容を表示する

### 機能要件

- [ ] TypeScript 型チェック（npm run typecheck）を実行する
- [ ] ESLint（npm run lint）を実行する
- [ ] テスト（npm test）を実行する（CI で実行される場合）
- [ ] チェック失敗時に修正ガイダンスを表示する

### 非機能要件

- [ ] 品質チェックの実行時間が 60 秒以内であること
- [ ] プロンプトファースト原則に従った実装であること

---

## 4. 制約条件

- プロンプトファースト原則: .md ファイルでロジック実装、TypeScript はスキル層のみ
- 既存の spec-phase.md の Step 4.5 の拡張として実装
- 既存スキル（typescript-eslint）を活用

---

## 5. 依存関係

- `src/slash-commands/spec-phase.md` - フェーズ遷移ロジック
- `src/skills/typescript-eslint/SKILL.md` - 品質チェックスキル
- `src/skills/pr-creator/SKILL.md` - PR 作成スキル
- `.github/workflows/` - CI ワークフロー定義

---

## 6. 参考情報

- PR #738: CI が失敗する PR が作成されることがある（既存の修正）
- 仕様書 ID: 987c1587 - 類似仕様書（マージ済み）
- `agent_docs/PROMPT_FIRST_PRINCIPLE.md` - プロンプトファースト原則

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
User Input: /cft:spec-phase <spec-id> review
            ↓
┌─────────────────────────────────────────┐
│ spec-phase.md (Step 1-4)                │
│ - フェーズ正規化、仕様書解決             │
│ - バリデーション                        │
└──────────────┬──────────────────────────┘
               ↓
┌──────────────────────────────────────────┐
│ spec-phase.md (Step 4.5) [拡張対象]      │
│ 品質チェック（review フェーズのみ）      │
│                                          │
│ 4.5.1 Skill: typescript-eslint           │
│ 4.5.2 Bash: npm run typecheck            │
│ 4.5.3 Bash: npm run lint                 │
│ 4.5.4 Bash: npm run test:coverage [新規] │
│ 4.5.5 結果判定 → 失敗時は処理中断        │
└──────────────┬──────────────────────────┘
               ↓ (すべて成功)
┌──────────────────────────────────────────┐
│ spec-phase.md (Step 5-9)                 │
│ - DB 更新 → イベント発火                 │
│ - Markdown 更新 → 自動コミット           │
│ - pr-creator スキル実行                  │
└──────────────────────────────────────────┘
```

#### 設計方針

1. **プロンプトファースト原則**: すべてのロジックは `spec-phase.md` 内で実装
2. **直列実行**: typecheck → lint → test の順序で実行（並列実行は非推奨）
3. **即座に中断**: 最初に失敗したチェックの時点で処理を中断

#### 処理フロー詳細

```
チェック実行
    ↓
[typecheck] → 失敗 → エラー表示 + ガイダンス → 処理中断
    ↓ (成功)
[lint] → 失敗 → エラー表示 + ガイダンス → 処理中断
    ↓ (成功)
[test] → 失敗 → エラー表示 + ガイダンス → 処理中断
    ↓ (成功)
✓ 品質チェック完了 → Step 5 へ進む
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/slash-commands/spec-phase.md` | Step 4.5 にテスト実行を追加、ガイダンス更新 |

#### 実装詳細

Step 4.5 の既存実装を拡張し、以下の処理を追加:

1. **テスト実行の追加**: `npm run test:coverage` を lint 実行後に追加
2. **エラーハンドリング強化**: 3 種類のチェック結果を個別に表示
3. **ガイダンス充実**: テスト失敗時の修正手順を追加

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| 型チェック | Step 4.5 で実行 | 変更なし | spec-phase.md |
| ESLint | Step 4.5 で実行 | 変更なし | spec-phase.md |
| テスト実行 | なし | Step 4.5 に追加 | spec-phase.md |
| ガイダンス | 2 種類 | 3 種類に拡張 | spec-phase.md |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| Step 4.5 | テスト実行が追加されていること | review フェーズ移行時に npm test が実行される |
| エラーハンドリング | テスト失敗時に処理が中断されること | 意図的にテストを失敗させて確認 |
| ガイダンス | テスト失敗時の修正ガイダンスが表示されること | 出力メッセージを確認 |

### 7.5 移行計画

#### Phase 1: Step 4.5 の拡張

1. 既存の Step 4.5 セクションを特定
2. テスト実行処理を追加
3. 結果判定ロジックを更新
4. エラーメッセージを拡張

---

## 8. 実装タスクリスト

### Phase 1: Step 4.5 の拡張

- [x] Step 4.5.4 としてテスト実行処理を追加 (#756)
- [x] 結果判定ロジックを 3 種類のチェックに対応 (#757)
- [x] テスト失敗時の修正ガイダンスを追加 (#758)
- [ ] dogfood 同期を実行して動作確認 (#759)
