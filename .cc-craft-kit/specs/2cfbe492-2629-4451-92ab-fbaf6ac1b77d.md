# /cft:spec-phase <id> design において詳細設計が自動で行われない

**仕様書 ID:** 2cfbe492-2629-4451-92ab-fbaf6ac1b77d
**フェーズ:** implementation
**作成日時:** 2025-01-25 10:30
**更新日時:** 2025/01/25 11:11:45

---

## 1. 背景と目的

### 背景

現在の `/cft:spec-phase <id> design` コマンドは、design フェーズへの遷移時に requirements フェーズのバリデーションのみを行い、詳細設計の自動実行を行っていない。

- `tasks` フェーズ移行時には、受け入れ基準から実装タスクリストを自動生成する機能がある
- `implementation` フェーズ移行時には、typescript-eslint スキルを自動実行する機能がある
- `completed` フェーズ移行時には、pr-creator スキルを自動実行する機能がある

一方、`design` フェーズ移行時には「その他のフェーズ」として扱われ、ガイダンスメッセージのみ表示されている状態。

### 目的

`/cft:spec-phase <id> design` コマンド実行時に、以下を自動実行する:

1. コードベース解析による関連コンポーネントの特定
2. アーキテクチャ設計の自動生成
3. 不明点のユーザーへの問い合わせ
4. 設計詳細セクション（## 7）の自動追加

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] design フェーズ移行時に、詳細設計の自動実行処理が呼び出されること
- [ ] 不明な点がある場合、AskUserQuestion ツールでユーザーに問い合わせること
- [ ] 自動生成された設計内容が仕様書の「## 7. 設計詳細」セクションに追記されること

### 機能要件

- [ ] Explore サブエージェントでコードベース解析を実行すること
- [ ] 解析結果に基づいてアーキテクチャ設計を生成すること
- [ ] 以下のサブセクションを含む「## 7. 設計詳細」を生成すること:
  - 7.1 アーキテクチャ設計
  - 7.2 実装方針
  - 7.3 テスト戦略

### 非機能要件

- [ ] 既存の spec-phase.md のプロンプト構造を維持すること
- [ ] 既存の他フェーズ（tasks, implementation, completed）の自動処理に影響しないこと

---

## 4. 制約条件

- プロンプトベース（.md）での実装を優先すること（CLAUDE.md のプロンプトファースト原則に準拠）
- 既存の spec-phase.md の Step 8「フェーズ固有の後処理」セクションを拡張すること
- 新規スクリプト（.ts）の追加は最小限に抑えること

---

## 5. 依存関係

- `src/slash-commands/spec-phase.md` - 修正対象
- `src/core/subagents/impl/architect-designer.ts` - 参考実装（活用可能）
- Explore サブエージェント - コードベース解析に使用
- AskUserQuestion ツール - ユーザーへの問い合わせに使用
- Edit ツール - 仕様書の設計セクション追記に使用

---

## 6. 参考情報

- 既存の tasks フェーズ後処理パターン（spec-phase.md Step 8）
- architect-designer サブエージェント実装（src/core/subagents/impl/architect-designer.ts）

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
spec-phase.md (プロンプトベース)
├── Step 1-7: 既存処理（変更なし）
├── Step 8: フェーズ固有の後処理
│   ├── tasks フェーズ（既存）
│   ├── implementation フェーズ（既存）
│   ├── completed フェーズ（既存）
│   ├── design フェーズ ← 新規追加
│   │   ├── コードベース解析（Explore サブエージェント）
│   │   ├── ユーザー確認（AskUserQuestion ツール）
│   │   └── 設計詳細セクション生成（Edit ツール）
│   └── その他のフェーズ（既存）
└── Step 9: git status チェック（変更なし）
```

#### 設計方針

- **プロンプトファースト原則を厳守**: スクリプト（.ts）は使用せず、spec-phase.md への Markdown 追加のみで実装
- **既存パターンの踏襲**: tasks フェーズ後処理と同様の構造で design フェーズ後処理を実装
- **Claude Code ツールの活用**: Explore, AskUserQuestion, Edit の 3 ツールを組み合わせて詳細設計を自動化

#### 処理フロー詳細

```
design フェーズに移行
       │
       ▼
┌─────────────────────────────────────┐
│ 1. コードベース解析                  │
│    Task ツール + Explore サブエージェント │
│    thoroughness: "medium"            │
└─────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────┐
│ 2. ユーザー確認（必要な場合）         │
│    AskUserQuestion ツール            │
│    - アーキテクチャパターン          │
│    - 実装方針の確認                  │
│    - 不明点の解消                    │
└─────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────┐
│ 3. 設計詳細セクション生成            │
│    Edit ツール                       │
│    - ## 7. 設計詳細                  │
│      - 7.1 アーキテクチャ設計        │
│      - 7.2 実装方針                  │
│      - 7.3 機能マッピング            │
│      - 7.4 テスト戦略                │
│      - 7.5 移行計画                  │
└─────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────┐
│ 4. 自動コミット                      │
│    git add && git commit             │
└─────────────────────────────────────┘
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/slash-commands/spec-phase.md` | Step 8 に design フェーズ後処理セクションを追加 |

#### Step 8 への追加内容

既存の Step 8「フェーズ固有の後処理」セクションに、以下の `design` フェーズ処理を追加:

```markdown
#### design フェーズに移行した場合

1. **コードベース解析**:
   - Task ツールで Explore サブエージェント実行（thoroughness: "medium"）
   - 分析対象:
     - 修正対象ファイルの特定（仕様書の依存関係セクションから）
     - 既存のコンポーネント構造
     - 命名規則・設計パターン
     - 類似機能の実装例

2. **ユーザー確認**（不明点がある場合）:
   - AskUserQuestion ツールで以下を問い合わせ:
     - アーキテクチャパターンの選択
     - 実装方針の確認
     - 外部統合・依存関係の確認
   - 質問は最大 2-3 項目に絞る

3. **設計詳細セクション生成**:
   - Edit ツールで仕様書末尾に「## 7. 設計詳細」セクション追加
   - 以下のサブセクションを含める:
     - 7.1 アーキテクチャ設計（全体構成、設計方針、処理フロー）
     - 7.2 実装方針（修正対象ファイル、変更内容）
     - 7.3 機能マッピング（既存機能との対応表）
     - 7.4 テスト戦略（テスト対象、テスト内容、モック対象）
     - 7.5 移行計画（段階的実装ステップ）

4. **自動コミット**:
   - 設計詳細セクション追加を自動コミット
   - コミットメッセージ: `docs: $SPEC_NAME の設計詳細を追加`
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| design フェーズ後処理 | ガイダンスメッセージ表示のみ | コードベース解析 + ユーザー確認 + 設計詳細生成 | Step 8 |
| コードベース解析 | なし | Task + Explore サブエージェント | Step 8 design セクション |
| ユーザー確認 | なし | AskUserQuestion ツール | Step 8 design セクション |
| 設計詳細生成 | なし | Edit ツール | Step 8 design セクション |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| design フェーズ後処理の発火 | `/cft:spec-phase <id> design` 実行時に後処理が実行されること | 手動テスト |
| Explore サブエージェント連携 | コードベース解析結果が取得できること | 手動テスト |
| AskUserQuestion 連携 | 不明点がある場合にユーザーへの問い合わせが発生すること | 手動テスト |
| 設計詳細セクション生成 | `## 7. 設計詳細` セクションが仕様書に追加されること | 手動テスト |
| 自動コミット | 設計詳細追加後に自動コミットされること | 手動テスト |
| 既存フェーズへの影響 | tasks, implementation, completed フェーズの動作に変更がないこと | 手動テスト |

**備考**: プロンプトベース実装のため、単体テスト（.test.ts）は不要。手動テストで動作確認を行う。

### 7.5 移行計画

#### Phase 1: プロンプト修正

1. `src/slash-commands/spec-phase.md` の Step 8 セクションを編集
2. `#### design フェーズに移行した場合` セクションを追加
3. 既存の「その他のフェーズ」から `design` を除外

#### Phase 2: 同期と動作確認

1. `npm run sync:dogfood` で `.cc-craft-kit/` へ同期
2. 新規仕様書を作成してテスト: `/cft:spec-create "テスト仕様" "テスト用"`
3. design フェーズへ移行: `/cft:spec-phase <id> design`
4. 以下を確認:
   - Explore サブエージェントが実行されること
   - 設計詳細セクションが生成されること
   - 自動コミットが実行されること

#### Phase 3: ドキュメント更新

1. 本仕様書の受け入れ基準をチェック
2. GitHub Issue を更新（完了報告）

---

## 8. 実装タスクリスト

### 必須要件

- [ ] spec-phase.md の Step 8 に design フェーズ後処理セクションを追加
- [ ] AskUserQuestion ツールでユーザー確認処理を記述
- [ ] Edit ツールで設計詳細セクション生成処理を記述

### 機能要件

- [ ] Explore サブエージェントでコードベース解析を実行する処理を記述
- [ ] 解析結果に基づいてアーキテクチャ設計を生成する処理を記述
- [ ] 以下のサブセクションを含む「## 7. 設計詳細」生成処理を記述:
  - 7.1 アーキテクチャ設計
  - 7.2 実装方針
  - 7.3 テスト戦略

### 非機能要件

- [ ] 既存の spec-phase.md のプロンプト構造を維持すること
- [ ] 既存の他フェーズ（tasks, implementation, completed）の自動処理に影響しないこと

### 同期と動作確認

- [ ] npm run sync:dogfood で .cc-craft-kit/ へ同期
- [ ] 手動テストで動作確認
