# 保護ブランチからの仕様書作成時の自動ブランチ作成

**仕様書 ID:** f20c18a2-b268-4569-bbc5-4f1f9bac4109
**フェーズ:** completed
**作成日時:** 2025/11/21 08:22:09
**更新日時:** 2025/11/21 09:16:44

---

## 1. 背景と目的

### 背景

仕様書作成時のブランチ自動作成機能（GitHub Issue #227）が実装されているが、develop ブランチから `/cft:spec-create` を実行した場合、保護ブランチであるためブランチ作成がスキップされる。

この動作は、`src/core/git/branch-creation.ts` の以下のロジックによるものです。

```typescript
// 保護ブランチチェック
const protectedBranches = (process.env.PROTECTED_BRANCHES || 'main,develop')
  .split(',')
  .map((b) => b.trim());

if (protectedBranches.includes(originalBranch)) {
  return {
    created: false,
    branchName: null,
    originalBranch,
    reason: `保護ブランチ ${originalBranch} ではブランチを作成しません`,
  };
}
```

この仕様は、main/develop ブランチでの直接作業を防ぐ意図的な設計です。しかし、ユーザーが仕様書を作成する際、毎回手動で feature ブランチを作成する必要があり、ワークフローが煩雑になっています。

### 目的

本仕様書の目的は、以下の改善を実現することです。

1. **保護ブランチからの仕様書作成時の自動ブランチ作成**
   - develop/main ブランチから `/cft:spec-create` を実行した場合でも、自動的に適切な作業ブランチを作成する
   - ユーザーが手動でブランチを作成する手間を削減する

2. **一貫性のあるブランチ命名規則**
   - 仕様書作成時に生成されるブランチ名を、プロジェクトのブランチ戦略（feature/、fix/ など）と整合させる

3. **エラーハンドリングの改善**
   - 保護ブランチでのブランチ作成失敗時に、より明確なガイダンスを提供する
   - 自動的に適切なブランチに切り替えてから仕様書を作成する

---

## 2. 対象ユーザー

本機能の対象ユーザーは以下の通りです。

1. **cc-craft-kit の開発者**
   - 仕様駆動開発（SDD）ワークフローに従って開発を進める開発者
   - 保護ブランチから仕様書を作成する必要がある開発者

2. **チーム開発における複数の開発者**
   - develop ブランチで最新の変更を確認後、即座に新しい仕様書を作成したい開発者
   - 手動でのブランチ作成を省略し、効率的に作業を進めたい開発者

3. **新規ユーザー**
   - cc-craft-kit のブランチ戦略を理解していないユーザー
   - 保護ブランチでの作業制限を知らないユーザー

---

## 3. 受け入れ基準

### 必須要件

- [ ] develop ブランチから `/cft:spec-create` を実行した場合、自動的に feature ブランチを作成し、切り替える
- [ ] main ブランチから `/cft:spec-create` を実行した場合、自動的に feature ブランチを作成し、切り替える
- [ ] 既存の保護ブランチチェック機能を維持する（環境変数 `PROTECTED_BRANCHES` で設定可能）
- [ ] ブランチ作成失敗時のエラーメッセージを改善する

### 機能要件

- [ ] 保護ブランチから仕様書作成時、ブランチ名を `feature/spec-<short-id>-<descriptive-name>` 形式で自動生成する
- [ ] カスタムブランチ名が指定された場合（`--branch-name` オプション）、優先的に使用する
- [ ] ブランチ作成後、仕様書の `branch_name` カラムに正しいブランチ名を設定する
- [ ] ブランチ作成失敗時、仕様書作成をロールバックする

### 非機能要件

- [ ] 既存のテストスイートがすべてパスする
- [ ] 新しいテストケースを追加し、カバレッジを 80% 以上に維持する
- [ ] ブランチ作成処理が 1 秒以内に完了する
- [ ] エラーメッセージがユーザーフレンドリーで、次のアクションが明確である

---

## 4. 制約条件

### 技術的制約

1. **保護ブランチの設定**
   - 環境変数 `PROTECTED_BRANCHES` で保護ブランチを設定可能（デフォルト: `main,develop`）
   - この設定を変更すると、ブランチ作成の動作が変わる

2. **Git ブランチ命名規則**
   - ブランチ名は Git 互換文字（英数字、ハイフン、アンダースコア、スラッシュ）のみ使用可能
   - ブランチ名の最大長は 255 文字（Git の制約）

3. **既存のブランチ作成ロジックとの整合性**
   - `src/core/git/branch-creation.ts` の既存ロジックを変更する
   - 既存のテストケースとの互換性を保つ必要がある

### 設計上の制約

1. **後方互換性**
   - 既存の仕様書作成フローを破壊しないこと
   - `--branch-name` オプションは引き続きサポートすること

2. **エラーハンドリング**
   - ブランチ作成失敗時、明確なエラーメッセージを表示すること
   - トランザクションロールバックを確実に実行すること

3. **ユーザー体験**
   - ブランチ作成がスキップされた理由を明確に表示すること
   - 次のアクションを案内すること

---

## 5. 依存関係

### 内部依存

- **ブランチ作成ロジック** (`src/core/git/branch-creation.ts`)
  - `createSpecBranch()` 関数を修正する必要がある
  - 保護ブランチチェックのロジックを変更する

- **仕様書作成コマンド** (`src/commands/spec/create.ts`)
  - ブランチ作成失敗時のエラーハンドリングを改善する必要がある

- **スラッシュコマンド定義** (`src/slash-commands/spec-create.md`)
  - ブランチ名生成のガイダンスを更新する必要がある

### 外部依存

- **Git リポジトリ**
  - Git リポジトリが初期化されている必要がある
  - リモートリポジトリとの同期が正常に動作している必要がある

- **環境変数**
  - `PROTECTED_BRANCHES` 設定を読み取る必要がある

### 関連仕様

- **GitHub Issue #227**: ブランチの作成タイミングの検討
  - 既に実装済み（completed フェーズ）
  - 本仕様書は Issue #227 の改善提案である

---

## 6. 参考情報

### 関連ドキュメント

- [CLAUDE.md - Git ワークフロー基本方針](./CLAUDE.md#git-ワークフロー基本方針)
- [CLAUDE.md - ブランチ管理](./CLAUDE.md#ブランチ管理)

### 関連 Issue

- GitHub Issue #227: ブランチの作成タイミングの検討
  - URL: <https://github.com/B16B1RD/cc-craft-kit/issues/227>
  - ステータス: completed
  - マージコミット: dad0536

### 関連実装ファイル

- `src/core/git/branch-creation.ts` - ブランチ作成ロジック
- `src/commands/spec/create.ts` - 仕様書作成コマンド
- `tests/core/git/branch-creation.test.ts` - 単体テスト

### 技術的背景

1. **保護ブランチの設計意図**
   - main/develop ブランチでの直接作業を防止する
   - プルリクエストベースのワークフローを強制する

2. **現在の動作**
   - develop ブランチから `/cft:spec-create` を実行すると、ブランチ作成がスキップされる
   - feature ブランチから実行すると、正常にブランチが作成される

3. **検証結果**
   - テストスイート: 13 件すべてパス
   - feature ブランチでのブランチ作成: 成功
   - develop ブランチでのブランチ作成: スキップ（保護ブランチのため）

---

## 7. 設計

### 7.1 アーキテクチャ概要

保護ブランチからの仕様書作成時、自動的に適切な作業ブランチを作成するため、既存のブランチ作成ロジックを拡張します。

```text
┌─────────────────────────────────────────────────────────────┐
│                    /cft:spec-create                         │
│                   (ユーザー実行)                               │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
          ┌───────────────────────┐
          │  保護ブランチチェック    │
          │  (PROTECTED_BRANCHES)  │
          └───────┬───────────────┘
                  │
        ┌─────────┴─────────┐
        │                   │
        ▼                   ▼
  [保護ブランチ]        [通常ブランチ]
        │                   │
        ▼                   ▼
  自動ブランチ作成      既存ロジック
  feature/spec-xxx     spec/xxx
        │                   │
        └─────────┬─────────┘
                  │
                  ▼
          ┌───────────────────┐
          │  仕様書レコード作成 │
          │  (DB + ファイル)   │
          └───────────────────┘
```

### 7.2 ブランチ命名戦略

#### 保護ブランチから作成される場合

保護ブランチ（main/develop）から仕様書作成時、以下のブランチ名を自動生成します。

**命名規則:**

```text
feature/spec-<short-id>[-<descriptive-name>]
```

**生成ロジック:**

1. **カスタムブランチ名が指定された場合** (`--branch-name` オプション):

   ```text
   feature/spec-f20c18a2-auto-branch-creation
   ```

   - `feature/` プレフィックスを追加
   - 仕様書 ID の先頭 8 文字 (`short-id`) を含める
   - カスタム名をサニタイズして結合

2. **カスタムブランチ名が未指定の場合**:

   ```text
   feature/spec-f20c18a2
   ```

   - `feature/` プレフィックスを追加
   - 仕様書 ID の先頭 8 文字のみ使用

#### 通常ブランチから作成される場合

既存のロジックを維持します。

```text
spec/<short-id>[-<descriptive-name>]
```

### 7.3 修正対象ファイル

#### 1. `src/core/git/branch-creation.ts`

**修正内容:**

- `createSpecBranch()` 関数のロジックを拡張
- 保護ブランチチェック後、自動的に `feature/` プレフィックス付きブランチを作成

**変更箇所:**

```typescript
// 現在のコード (99-106行目)
if (protectedBranches.includes(originalBranch)) {
  return {
    created: false,
    branchName: null,
    originalBranch,
    reason: `保護ブランチ ${originalBranch} ではブランチを作成しません`,
  };
}
```

**修正後:**

```typescript
if (protectedBranches.includes(originalBranch)) {
  // 保護ブランチの場合、feature/ プレフィックスを追加
  const featureBranchName = customBranchName
    ? `feature/spec-${shortSpecId}-${customBranchName.toLowerCase().replace(/[^a-z0-9-_]/g, '-')}`
    : `feature/spec-${shortSpecId}`;

  branchName = featureBranchName;

  console.log(`保護ブランチ ${originalBranch} から自動的にブランチを作成: ${branchName}`);
}
```

#### 2. `src/commands/spec/create.ts`

**修正内容:**

- エラーハンドリングのメッセージを改善
- ブランチ作成失敗時のガイダンスを追加

**変更箇所:**

```typescript
// 現在のコード (156-160行目)
} else {
  originalBranch = branchResult.originalBranch;
  console.log(
    formatInfo(branchResult.reason || 'ブランチ作成をスキップしました。', options.color)
  );
}
```

**修正後:**

```typescript
} else {
  originalBranch = branchResult.originalBranch;
  // 保護ブランチの場合でもブランチが作成されるため、このブロックに到達するケースは減少
  console.log(
    formatInfo(branchResult.reason || 'ブランチ作成をスキップしました。', options.color)
  );
}
```

#### 3. `tests/core/git/branch-creation.test.ts`

**修正内容:**

- 保護ブランチからの自動ブランチ作成テストケースを追加

**新規テストケース:**

1. `保護ブランチ (develop) から feature/ プレフィックス付きブランチが作成されること`
2. `保護ブランチ (main) から feature/ プレフィックス付きブランチが作成されること`
3. `カスタムブランチ名が指定された場合、feature/spec-<id>-<name> 形式になること`
4. `保護ブランチでのブランチ作成失敗時、適切なエラーメッセージが表示されること`

### 7.4 データフロー

#### 仕様書作成時のフロー（保護ブランチから実行）

```text
1. ユーザー実行
   /cft:spec-create "新機能の実装"
   (現在のブランチ: develop)

2. createSpecBranch() 呼び出し
   - 現在のブランチを取得: develop
   - 保護ブランチチェック: true
   - ブランチ名生成: feature/spec-f20c18a2

3. Git ブランチ作成
   git checkout -b feature/spec-f20c18a2

4. ブランチ検証
   git rev-parse --abbrev-ref HEAD
   → feature/spec-f20c18a2

5. データベースレコード作成
   INSERT INTO specs (id, name, phase, branch_name, ...)
   VALUES ('f20c18a2-...', '新機能の実装', 'requirements', 'feature/spec-f20c18a2', ...)

6. Markdown ファイル作成
   .cc-craft-kit/specs/f20c18a2-....md

7. イベント発火
   eventBus.emit('spec.created', ...)
   → GitHub Issue 自動作成

8. 完了メッセージ表示
   ✓ Specification created successfully!
   ✓ Created new branch: feature/spec-f20c18a2
```

### 7.5 エラーハンドリング

#### ブランチ作成失敗時のロールバック

保護ブランチでのブランチ作成失敗時、以下の順序でロールバックを実行します。

```typescript
try {
  // ブランチ作成
  const branchResult = createSpecBranch(id, options.branchName);

  // データベースレコード作成
  await db.insertInto('specs').values({...}).execute();

  // ファイル作成
  writeFileSync(specPath, content);
  fsyncFileAndDirectory(specPath);
} catch (error) {
  // 1. ブランチ削除
  if (branchCreated && originalBranch && branchName) {
    execSync(`git checkout ${originalBranch}`);
    execSync(`git branch -D ${branchName}`);
  }

  // 2. DBレコード削除
  await db.deleteFrom('specs').where('id', '=', id).execute();

  // 3. ファイル削除
  if (existsSync(specPath)) {
    unlinkSync(specPath);
  }

  throw error;
}
```

#### エラーメッセージの改善

| エラーケース | 現在のメッセージ | 改善後のメッセージ |
|---|---|---|
| Git 未初期化 | `Git リポジトリが初期化されていません` | `Git リポジトリが初期化されていません。git init を実行してください。` |
| ブランチ作成失敗 | `ブランチ作成コマンドの実行に失敗しました` | `ブランチ作成に失敗しました。既に同名のブランチが存在する可能性があります。` |
| 保護ブランチスキップ | `保護ブランチ ${branch} ではブランチを作成しません` | (このメッセージは削除され、自動的にブランチが作成される) |

### 7.6 後方互換性

#### 既存の動作を維持

1. **通常ブランチからの実行**
   - 既存のロジックを維持
   - ブランチ名: `spec/<short-id>` または `spec/<short-id>-<custom-name>`

2. **`--branch-name` オプション**
   - 引き続きサポート
   - 保護ブランチからの実行時: `feature/spec-<short-id>-<custom-name>`
   - 通常ブランチからの実行時: `spec/<short-id>-<custom-name>`

3. **環境変数 `PROTECTED_BRANCHES`**
   - デフォルト値: `main,develop`
   - カスタマイズ可能

### 7.7 パフォーマンス要件

#### 処理時間の目標

- ブランチ作成処理: 1 秒以内
- データベースレコード作成: 100ms 以内
- ファイル作成 + fsync: 200ms 以内

#### 合計目標時間

1.5 秒以内で完了することを目指します。

#### 最適化ポイント

1. **Git コマンド実行の最適化**
   - `stdio: 'pipe'` でエラーメッセージのみ取得
   - 不要な出力を抑制

2. **ブランチキャッシュの活用**
   - `getCurrentBranch()` でキャッシュを使用
   - ブランチ作成後に `clearBranchCache()` を呼び出し

3. **fsync の適切な使用**
   - ファイル作成後に確実に `fsyncFileAndDirectory()` を実行
   - データベース破損を防止

### 7.8 セキュリティ考慮事項

#### コマンドインジェクション対策

1. **UUID フォーマット検証**
   - 正規表現で UUID フォーマットを検証
   - 不正な文字列を早期に検出

2. **ブランチ名サニタイゼーション**
   - Git 互換文字（英数字、ハイフン、アンダースコア、スラッシュ）のみ許可
   - 特殊文字をハイフンに変換

3. **エラーメッセージのサニタイゼーション**
   - センシティブ情報（トークン、パスワード）を含めない
   - ユーザーフレンドリーなメッセージのみ表示

### 7.9 テスト戦略

#### 単体テスト

| テストケース | 期待結果 |
|---|---|
| develop ブランチからの実行 | `feature/spec-<id>` ブランチが作成される |
| main ブランチからの実行 | `feature/spec-<id>` ブランチが作成される |
| カスタムブランチ名を指定 | `feature/spec-<id>-<name>` ブランチが作成される |
| 通常ブランチからの実行 | `spec/<id>` ブランチが作成される（既存動作） |
| Git 未初期化の場合 | エラーメッセージが表示される |
| ブランチ作成失敗の場合 | ロールバックが実行される |

#### 統合テスト

1. **保護ブランチからの仕様書作成**
   - develop ブランチで `/cft:spec-create` を実行
   - ブランチが自動作成されることを確認
   - データベースレコードとファイルが作成されることを確認

2. **ブランチ作成失敗時のロールバック**
   - 既存ブランチ名で再度作成を試行
   - ロールバックが正常に実行されることを確認

3. **GitHub Issue 自動作成**
   - 仕様書作成後、GitHub Issue が自動作成されることを確認

### 7.10 実装の優先順位

#### Phase 1: コア機能の実装（必須）

1. `src/core/git/branch-creation.ts` の修正
2. `src/commands/spec/create.ts` のエラーハンドリング改善
3. 単体テストの追加

#### Phase 2: 統合テストとドキュメント（推奨）

1. 統合テストの追加
2. `CLAUDE.md` のブランチ管理セクション更新
3. `src/slash-commands/spec-create.md` のガイダンス更新

#### Phase 3: パフォーマンス最適化（オプション）

1. ブランチ作成処理のベンチマーク測定
2. 最適化ポイントの洗い出しと実装

---

## 8. 実装タスクリスト

### Phase 1: コア機能の実装（必須）

#### タスク 1: `src/core/git/branch-creation.ts` の保護ブランチチェックロジックを修正

- **目的**: 保護ブランチから `feature/` プレフィックス付きブランチを自動作成
- **変更箇所**: 99-106 行目の保護ブランチチェック
- **実装内容**:
  - 保護ブランチチェック後、`created: false` を返すのではなく、`feature/` プレフィックス付きブランチを作成
  - カスタムブランチ名が指定された場合、`feature/spec-<short-id>-<custom-name>` 形式
  - カスタムブランチ名が未指定の場合、`feature/spec-<short-id>` 形式
- **受け入れ基準**:
  - develop ブランチから実行時、`feature/spec-<short-id>` ブランチが作成される
  - main ブランチから実行時、`feature/spec-<short-id>` ブランチが作成される
  - カスタムブランチ名が指定された場合、`feature/spec-<short-id>-<custom-name>` ブランチが作成される

#### タスク 2: `src/commands/spec/create.ts` のエラーハンドリング改善

- **目的**: ブランチ作成失敗時のエラーメッセージを改善
- **変更箇所**: 156-160 行目のブランチ作成結果の処理
- **実装内容**:
  - エラーメッセージをユーザーフレンドリーに変更
  - Git 未初期化時:「git init を実行してください」を追加
  - ブランチ作成失敗時:「同名のブランチが存在します」を追加
- **受け入れ基準**:
  - エラーメッセージが明確で、次のアクションが分かりやすい

#### タスク 3: 単体テストの追加

- **目的**: 保護ブランチからの自動ブランチ作成機能をテスト
- **変更箇所**: `tests/core/git/branch-creation.test.ts`
- **実装内容**:
  - develop ブランチから `feature/spec-<id>` ブランチが作成されることを確認
  - main ブランチから `feature/spec-<id>` ブランチが作成されることを確認
  - カスタムブランチ名指定時、`feature/spec-<id>-<name>` ブランチが作成されることを確認
  - 通常ブランチから `spec/<id>` ブランチが作成されることを確認（既存動作）
- **受け入れ基準**:
  - すべてのテストケースが成功する

#### タスク 4: 統合テストの追加

- **目的**: 保護ブランチからの仕様書作成フローをエンドツーエンドでテスト
- **変更箇所**: `tests/integrations/` 配下に新規テストファイル作成
- **実装内容**:
  - develop ブランチで `/cft:spec-create` を実行
  - ブランチが自動作成されることを確認
  - データベースレコードとファイルが作成されることを確認
  - ブランチ作成失敗時のロールバックを確認
- **受け入れ基準**:
  - すべての統合テストが成功する

#### タスク 5: 既存テストスイートの実行と全テスト通過確認

- **目的**: 既存機能を破壊していないことを確認
- **実装内容**:
  - `npm test` を実行
  - すべてのテストが成功することを確認
- **受け入れ基準**:
  - 既存テストスイートがすべて成功する

#### タスク 6: テストカバレッジ測定（80% 以上維持）

- **目的**: コード品質を維持
- **実装内容**:
  - `npm run test:coverage` を実行
  - カバレッジレポートを確認
- **受け入れ基準**:
  - カバレッジが 80% 以上である

### Phase 2: 統合テストとドキュメント（推奨）

#### タスク 7: `CLAUDE.md` のブランチ管理セクション更新

- **目的**: 保護ブランチからの自動ブランチ作成機能をドキュメント化
- **変更箇所**: `CLAUDE.md` のブランチ管理セクション
- **実装内容**:
  - 保護ブランチからの自動ブランチ作成機能を説明
  - ブランチ命名規則を更新
- **受け入れ基準**:
  - ドキュメントが最新の仕様と一致している

#### タスク 8: `src/slash-commands/spec-create.md` のガイダンス更新

- **目的**: ユーザーに保護ブランチからの自動ブランチ作成機能を案内
- **変更箇所**: `src/slash-commands/spec-create.md`
- **実装内容**:
  - 保護ブランチからの自動ブランチ作成機能を説明
  - 使用例を追加
- **受け入れ基準**:
  - ガイダンスが最新の仕様と一致している
