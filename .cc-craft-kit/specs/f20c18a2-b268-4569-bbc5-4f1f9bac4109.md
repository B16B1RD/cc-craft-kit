# 保護ブランチからの仕様書作成時の自動ブランチ作成

**仕様書 ID:** f20c18a2-b268-4569-bbc5-4f1f9bac4109
**フェーズ:** design
**作成日時:** 2025/11/21 08:22:09
**更新日時:** 2025/11/21 08:34:41

---

## 1. 背景と目的

### 背景

仕様書作成時のブランチ自動作成機能（GitHub Issue #227）が実装されているが、develop ブランチから `/cft:spec-create` を実行した場合、保護ブランチであるためブランチ作成がスキップされる。

この動作は、`src/core/git/branch-creation.ts` の以下のロジックによるものである。

```typescript
// 保護ブランチチェック
const protectedBranches = (process.env.PROTECTED_BRANCHES || 'main,develop')
  .split(',')
  .map((b) => b.trim());

if (protectedBranches.includes(originalBranch)) {
  return {
    created: false,
    branchName: null,
    originalBranch,
    reason: `保護ブランチ ${originalBranch} ではブランチを作成しません`,
  };
}
```

この仕様は、main/develop ブランチでの直接作業を防ぐ意図的な設計である。しかし、ユーザーが仕様書を作成する際、毎回手動で feature ブランチを作成する必要があり、ワークフローが煩雑になっている。

### 目的

本仕様書の目的は、以下の改善を実現することである。

1. **保護ブランチからの仕様書作成時の自動ブランチ作成**
   - develop/main ブランチから `/cft:spec-create` を実行した場合でも、自動的に適切な作業ブランチを作成する
   - ユーザーが手動でブランチを作成する手間を削減する

2. **一貫性のあるブランチ命名規則**
   - 仕様書作成時に生成されるブランチ名を、プロジェクトのブランチ戦略（feature/、fix/ など）と整合させる

3. **エラーハンドリングの改善**
   - 保護ブランチでのブランチ作成失敗時に、より明確なガイダンスを提供する
   - 自動的に適切なブランチに切り替えてから仕様書を作成する

---

## 2. 対象ユーザー

本機能の対象ユーザーは以下の通りである。

1. **cc-craft-kit の開発者**
   - 仕様駆動開発（SDD）ワークフローに従って開発を進める開発者
   - 保護ブランチから仕様書を作成する必要がある開発者

2. **チーム開発における複数の開発者**
   - develop ブランチで最新の変更を確認後、即座に新しい仕様書を作成したい開発者
   - 手動でのブランチ作成を省略し、効率的に作業を進めたい開発者

3. **新規ユーザー**
   - cc-craft-kit のブランチ戦略を理解していないユーザー
   - 保護ブランチでの作業制限を知らないユーザー

---

## 3. 受け入れ基準

### 必須要件

- [ ] develop ブランチから `/cft:spec-create` を実行した場合、自動的に feature ブランチを作成し、切り替える
- [ ] main ブランチから `/cft:spec-create` を実行した場合、自動的に feature ブランチを作成し、切り替える
- [ ] 既存の保護ブランチチェック機能を維持する（環境変数 `PROTECTED_BRANCHES` で設定可能）
- [ ] ブランチ作成失敗時のエラーメッセージを改善する

### 機能要件

- [ ] 保護ブランチから仕様書作成時、ブランチ名を `feature/spec-<short-id>-<descriptive-name>` 形式で自動生成する
- [ ] カスタムブランチ名が指定された場合（`--branch-name` オプション）、優先的に使用する
- [ ] ブランチ作成後、仕様書の `branch_name` カラムに正しいブランチ名を設定する
- [ ] ブランチ作成失敗時、仕様書作成をロールバックする

### 非機能要件

- [ ] 既存のテストスイートがすべてパスする
- [ ] 新しいテストケースを追加し、カバレッジを 80% 以上に維持する
- [ ] ブランチ作成処理が 1 秒以内に完了する
- [ ] エラーメッセージがユーザーフレンドリーで、次のアクションが明確である

---

## 4. 制約条件

### 技術的制約

1. **保護ブランチの設定**
   - 環境変数 `PROTECTED_BRANCHES` で保護ブランチを設定可能（デフォルト: `main,develop`）
   - この設定を変更すると、ブランチ作成の動作が変わる

2. **Git ブランチ命名規則**
   - ブランチ名は Git 互換文字（英数字、ハイフン、アンダースコア、スラッシュ）のみ使用可能
   - ブランチ名の最大長は 255 文字（Git の制約）

3. **既存のブランチ作成ロジックとの整合性**
   - `src/core/git/branch-creation.ts` の既存ロジックを変更する
   - 既存のテストケースとの互換性を保つ必要がある

### 設計上の制約

1. **後方互換性**
   - 既存の仕様書作成フローを破壊しないこと
   - `--branch-name` オプションは引き続きサポートすること

2. **エラーハンドリング**
   - ブランチ作成失敗時、明確なエラーメッセージを表示すること
   - トランザクションロールバックを確実に実行すること

3. **ユーザー体験**
   - ブランチ作成がスキップされた理由を明確に表示すること
   - 次のアクションを案内すること

---

## 5. 依存関係

### 内部依存

- **ブランチ作成ロジック** (`src/core/git/branch-creation.ts`)
  - `createSpecBranch()` 関数を修正する必要がある
  - 保護ブランチチェックのロジックを変更する

- **仕様書作成コマンド** (`src/commands/spec/create.ts`)
  - ブランチ作成失敗時のエラーハンドリングを改善する必要がある

- **スラッシュコマンド定義** (`src/slash-commands/spec-create.md`)
  - ブランチ名生成のガイダンスを更新する必要がある

### 外部依存

- **Git リポジトリ**
  - Git リポジトリが初期化されている必要がある
  - リモートリポジトリとの同期が正常に動作している必要がある

- **環境変数**
  - `PROTECTED_BRANCHES` 設定を読み取る必要がある

### 関連仕様

- **GitHub Issue #227**: ブランチの作成タイミングの検討
  - 既に実装済み（completed フェーズ）
  - 本仕様書は Issue #227 の改善提案である

---

## 6. 参考情報

### 関連ドキュメント

- [CLAUDE.md - Git ワークフロー基本方針](./CLAUDE.md#git-ワークフロー基本方針)
- [CLAUDE.md - ブランチ管理](./CLAUDE.md#ブランチ管理)

### 関連 Issue

- GitHub Issue #227: ブランチの作成タイミングの検討
  - URL: <https://github.com/B16B1RD/cc-craft-kit/issues/227>
  - ステータス: completed
  - マージコミット: dad0536

### 関連実装ファイル

- `src/core/git/branch-creation.ts` - ブランチ作成ロジック
- `src/commands/spec/create.ts` - 仕様書作成コマンド
- `tests/core/git/branch-creation.test.ts` - 単体テスト

### 技術的背景

1. **保護ブランチの設計意図**
   - main/develop ブランチでの直接作業を防止する
   - プルリクエストベースのワークフローを強制する

2. **現在の動作**
   - develop ブランチから `/cft:spec-create` を実行すると、ブランチ作成がスキップされる
   - feature ブランチから実行すると、正常にブランチが作成される

3. **検証結果**
   - テストスイート: 13 件すべてパス
   - feature ブランチでのブランチ作成: 成功
   - develop ブランチでのブランチ作成: スキップ（保護ブランチのため）
