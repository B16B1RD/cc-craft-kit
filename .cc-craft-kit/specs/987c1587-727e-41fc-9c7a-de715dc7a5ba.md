# CI が失敗する PR が作成されることがある

**仕様書 ID:** 987c1587-727e-41fc-9c7a-de715dc7a5ba
**フェーズ:** requirements
**作成日時:** 2025/12/04 17:45:00
**更新日時:** 2025/12/04 17:45:00

---

## 1. 背景と目的

### 背景

現在の cc-craft-kit では、`/cft:spec-phase` コマンドで implementation フェーズから review フェーズに移行する際、`pr-creator` スキルが自動的に PR を作成する。しかし、PR 作成前にコード品質チェック（typecheck、lint、test）が実行されていないため、CI パイプラインで初めてエラーが検出され、CI が失敗する PR が作成されることがある。

これにより以下の問題が発生している：
- CI 失敗 PR の修正に追加の手間がかかる
- レビュアーが CI 失敗を確認してからレビューを待つ無駄な時間が発生
- PR が「赤い状態」で作成されることによる開発体験の低下

### 目的

review フェーズへの移行時に、PR 作成前に必須の品質チェックを実行し、チェックが失敗した場合は PR 作成をスキップすることで、CI が成功する PR のみが作成されるようにする

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発（SDD）を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] review フェーズ移行時、PR 作成前に TypeScript 型チェック（`npm run typecheck`）が実行される
- [ ] review フェーズ移行時、PR 作成前に ESLint チェック（`npm run lint`）が実行される
- [ ] 品質チェックが失敗した場合、PR 作成がスキップされる

### 機能要件

- [ ] 品質チェック失敗時、エラー内容がユーザーに明確に表示される
- [ ] 品質チェック失敗時、フェーズ遷移は中断または警告付きで続行する（設計時に決定）
- [ ] チェック結果のサマリーが表示される（成功/失敗件数）
- [ ] テスト実行（`npm test`）もオプションで含める（設計時に要否決定）

### 非機能要件

- [ ] 品質チェックの実行時間が通常の開発フローに大きな影響を与えない（目安: 60秒以内）
- [ ] チェック失敗時のエラーメッセージが具体的で、修正方法が分かる

---

## 4. 制約条件

- プロンプトファースト原則に従い、可能な限りスラッシュコマンド（.md）で実装
- 既存の `spec-phase.md` フローとの整合性を維持
- 既存の `pr-creator` スキルの動作を変更せず、呼び出し前にゲートを追加
- `quality-requirements.yaml` を活用して品質要件を定義する（既存パターンに従う）

---

## 5. 依存関係

- `src/slash-commands/spec-phase.md` - フェーズ遷移コマンド（修正対象）
- `src/skills/pr-creator/SKILL.md` - PR 作成スキル（呼び出し元）
- `src/skills/typescript-eslint/SKILL.md` - TypeScript/ESLint スキル（参考）
- `src/core/quality/automation.ts` - 品質チェック自動実行
- `.cc-craft-kit/quality-requirements.yaml` - 品質要件定義ファイル

---

## 6. 参考情報

- 現在の PR 作成フロー: `spec-phase.md` → `pr-creator` スキル → `gh pr create --draft`
- 品質チェックは `implementation` フェーズ開始時のみ実行されている
- 類似仕様: `ff13d208-7fa5-4e85-a7f2-7ba72fa6ba8c.md`（textlint CI 失敗の修正）
