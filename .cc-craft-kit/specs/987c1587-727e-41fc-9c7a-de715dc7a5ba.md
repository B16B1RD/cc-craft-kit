# CI が失敗する PR が作成されることがある

**仕様書 ID:** 987c1587-727e-41fc-9c7a-de715dc7a5ba
**フェーズ:** implementation
**作成日時:** 2025/12/04 17:45:00
**更新日時:** 2025/12/04 20:06:00

---

## 1. 背景と目的

### 背景

現在の cc-craft-kit では、`/cft:spec-phase` コマンドで implementation フェーズから review フェーズに移行する際、`pr-creator` スキルが自動的に PR を作成する。しかし、PR 作成前にコード品質チェック（typecheck、lint、test）が実行されていないため、CI パイプラインで初めてエラーが検出され、CI が失敗する PR が作成されることがある。

これにより以下の問題が発生している：
- CI 失敗 PR の修正に追加の手間がかかる
- レビュアーが CI 失敗を確認してからレビューを待つ無駄な時間が発生
- PR が「赤い状態」で作成されることによる開発体験の低下

### 目的

review フェーズへの移行時に、PR 作成前に必須の品質チェックを実行し、チェックが失敗した場合は PR 作成をスキップすることで、CI が成功する PR のみが作成されるようにする

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発（SDD）を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] review フェーズ移行時、PR 作成前に TypeScript 型チェック（`npm run typecheck`）が実行される
- [ ] review フェーズ移行時、PR 作成前に ESLint チェック（`npm run lint`）が実行される
- [ ] 品質チェックが失敗した場合、PR 作成がスキップされる

### 機能要件

- [ ] 品質チェック失敗時、エラー内容がユーザーに明確に表示される
- [ ] 品質チェック失敗時、フェーズ遷移は中断または警告付きで続行する（設計時に決定）
- [ ] チェック結果のサマリーが表示される（成功/失敗件数）
- [ ] テスト実行（`npm test`）もオプションで含める（設計時に要否決定）

### 非機能要件

- [ ] 品質チェックの実行時間が通常の開発フローに大きな影響を与えない（目安: 60秒以内）
- [ ] チェック失敗時のエラーメッセージが具体的で、修正方法が分かる

---

## 4. 制約条件

- プロンプトファースト原則に従い、可能な限りスラッシュコマンド（.md）で実装
- 既存の `spec-phase.md` フローとの整合性を維持
- 既存の `pr-creator` スキルの動作を変更せず、呼び出し前にゲートを追加
- `quality-requirements.yaml` を活用して品質要件を定義する（既存パターンに従う）

---

## 5. 依存関係

- `src/slash-commands/spec-phase.md` - フェーズ遷移コマンド（修正対象）
- `src/skills/pr-creator/SKILL.md` - PR 作成スキル（呼び出し元）
- `src/skills/typescript-eslint/SKILL.md` - TypeScript/ESLint スキル（参考）
- `src/core/quality/automation.ts` - 品質チェック自動実行
- `.cc-craft-kit/quality-requirements.yaml` - 品質要件定義ファイル

---

## 6. 参考情報

- 現在の PR 作成フロー: `spec-phase.md` → `pr-creator` スキル → `gh pr create --draft`
- 品質チェックは `implementation` フェーズ開始時のみ実行されている
- 類似仕様: `ff13d208-7fa5-4e85-a7f2-7ba72fa6ba8c.md`（textlint CI 失敗の修正）

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```text
review フェーズ移行フロー（修正後）

[implementation → review 遷移要求]
           ↓
┌─────────────────────────────┐
│ Step 5-A: 品質チェック実行    │
│ - typescript-eslint スキル   │
│ - typecheck + lint          │
└─────────────────────────────┘
           ↓
    ┌──────┴──────┐
    │ 結果判定    │
    └──────┬──────┘
      ↓        ↓
  [成功]     [失敗]
    ↓          ↓
┌─────────┐  ┌──────────────────┐
│DB 更新   │  │ エラー表示        │
│イベント発火│  │ 修正ガイダンス     │
└─────────┘  │ **処理中断**      │
    ↓        └──────────────────┘
┌─────────────────────────────┐
│ pr-creator スキル実行        │
│ - PR 作成                   │
└─────────────────────────────┘
    ↓
[review フェーズ完了]
```

#### 設計方針

1. **プロンプトファースト原則**: 品質チェックロジックは `spec-phase.md` で実装
2. **既存スキルの再利用**: `typescript-eslint` スキルをそのまま活用
3. **フェーズ遷移制御**: 品質チェック失敗時は DB 更新・イベント発火を行わない
4. **ユーザーガイダンス**: 具体的なエラー内容と修正方法を明示

#### 処理フロー詳細

**現在のフロー（問題あり）:**
```
implementation → review
    ↓
spec.phase_changed イベント
    ↓
pr-creator スキル呼び出し
    ↓
PR 作成（品質チェックなし）
    ↓
CI で初めてエラー検出 ← 問題点
```

**修正後のフロー:**
```
implementation → review 遷移要求
    ↓
品質チェック実行（typescript-eslint）
    ↓
[成功] → DB 更新・イベント発火 → pr-creator → PR 作成
[失敗] → エラー表示・ガイダンス → 処理中断（DB 更新なし）
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/slash-commands/spec-phase.md` | review フェーズ移行時に品質チェックを追加（Step 5 の前） |

#### 変更箇所の詳細

**`spec-phase.md` の修正ポイント:**

1. **Step 5（DB 更新）の前に品質チェックステップを追加**
   - review フェーズ移行時のみ実行
   - Skill ツールで `typescript-eslint` スキルを呼び出し
   - 結果に応じて分岐

2. **品質チェック失敗時の処理**
   - エラー内容を表示
   - 修正ガイダンスを提示
   - 処理を中断（DB 更新・pr-creator 呼び出しをスキップ）

3. **品質チェック成功時の処理**
   - サマリーを表示
   - 通常フローへ継続（DB 更新 → pr-creator）

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| 品質チェック | implementation 開始時のみ | review 移行時にも実行 | `spec-phase.md` |
| PR 作成ゲート | なし | 品質チェック成功が必須 | `spec-phase.md` |
| エラー表示 | - | 具体的なエラーと修正方法 | `spec-phase.md` |
| フェーズ遷移制御 | 常に遷移 | チェック失敗時は中断 | `spec-phase.md` |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| 品質チェック実行 | review 移行時にスキル呼び出し | 手動テスト（スキル呼び出し確認） |
| チェック成功時 | PR 作成が実行される | 手動テスト（PR 作成確認） |
| チェック失敗時 | PR 作成がスキップされる | 型エラーを意図的に作成してテスト |
| エラーメッセージ | 具体的な内容と修正方法 | 出力内容の目視確認 |
| フェーズ遷移中断 | DB 更新されない | DB 状態確認 |

### 7.5 移行計画

#### Phase 1: spec-phase.md の修正

1. review フェーズ移行処理に品質チェックステップを追加
2. 品質チェック失敗時の分岐処理を実装
3. エラーメッセージとガイダンスを定義

#### Phase 2: 同期・テスト

1. `npm run sync:dogfood` で `.claude/commands/cft/` に同期
2. 手動テストで動作確認
3. 型エラーを含むコードで失敗ケースをテスト

---

## 8. 実装タスクリスト

### Phase 1: spec-phase.md の修正

- [x] review フェーズ移行時の品質チェックステップを追加 (#725)
- [x] 品質チェック失敗時の分岐処理とエラーメッセージを実装 (#726)
- [x] 品質チェック成功時のサマリー表示を実装 (#727)

### Phase 2: 同期・テスト

- [x] `npm run sync:dogfood` で同期を実行 (#728)
- [x] 品質チェック成功ケースのテスト（クリーンなコードで PR 作成） (#729)
- [ ] 品質チェック失敗ケースのテスト（型エラーで PR 作成スキップ） (#730)
