# 開発キットソースとドッグフーディング環境の整理と整合性チェック

**仕様書 ID:** e972e41e-ae12-43a8-8c11-b8cf96f87ed8
**フェーズ:** completed
**作成日時:** 2025/11/17 3:13:43
**更新日時:** 2025/11/17 10:02:31

---

## 1. 背景と目的

### 背景

Takumi プロジェクトは「自分自身を使って開発する（ドッグフーディング）」ため、以下の 2 つのコードベースが存在しています:

- **`src/`** - 開発時に編集する本体の TypeScript ソースコード
- **`.cc-craft-kit/`** - Takumi 自身が Takumi を使うためのインストール先（ドッグフーディング用）

現状、以下の問題が発生しています:

1. **同期漏れリスク**: `src/` で変更したファイルが `.cc-craft-kit/` にコピーされず、実行時に古いコードが動作する
2. **整合性確認の欠如**: 両ディレクトリのファイルが一致しているか確認する仕組みがない
3. **ビルド・デプロイフローの不明確さ**: 開発時の正しい手順が文書化されているが、自動化されていない
4. **スラッシュコマンド定義の分散**: `.claude/commands/takumi/*.md` は Git 管理されているが、実装ファイル (`.cc-craft-kit/commands/`) は管理外
5. **ソース管理の不統一**: カスタムスラッシュコマンド、スキル、サブエージェントの配置場所が不明確

### 目的

開発キットソースコード（`src/`）とドッグフーディング環境（`.cc-craft-kit/`）の整理と整合性チェック機能を実装し、以下を実現する:

1. **ソースコード構造の統一**: すべてのコード資産を `src/` 配下で一元管理
2. **整合性チェックツール**: `src/` と `.cc-craft-kit/` のファイル差分を検出するコマンドを提供
3. **自動同期スクリプト**: ビルド後に `.cc-craft-kit/` へ自動コピーする npm スクリプトを追加
4. **ドキュメント整備**: 開発フロー、同期手順、トラブルシューティングを CLAUDE.md に追記

### ソースコード構造の再編成

現在の分散した構造を以下のように統一します:

**移行前:**
```
.claude/commands/takumi/     # スラッシュコマンド定義 (Git管理)
.cc-craft-kit/commands/            # CLI実装 (Git管理外)
src/core/skills/             # スキル (Git管理)
src/core/subagents/          # サブエージェント (Git管理)
```

**移行後:**
```
src/
├── commands/              # CLI実装 (.cc-craft-kit/commands/ から移動)
├── slash-commands/        # スラッシュコマンド定義 (.claude/commands/takumi/ から移動)
├── core/
│   ├── skills/           # スキル (既存)
│   └── subagents/        # サブエージェント (既存)
└── ...

.claude/commands/takumi/   # src/slash-commands/ へのシンボリックリンク
.cc-craft-kit/                   # ビルド後のインストール先のみ (完全にGit管理外)
```

---

## 2. 対象ユーザー

- **Takumi 開発者**: `src/` でソースコードを編集し、`.cc-craft-kit/` でドッグフーディングを行う開発者
- **CI/CD パイプライン**: 自動テストやデプロイ時に整合性を確認する自動化システム

---

## 3. 受け入れ基準

### 必須要件

- [ ] すべてのコード資産が `src/` 配下で一元管理されている
- [ ] `.claude/commands/takumi/` が `src/slash-commands/` へのシンボリックリンクになっている
- [ ] `src/` と `.cc-craft-kit/` のファイル差分を検出できる CLI コマンドが存在する
- [ ] ビルド後に `.cc-craft-kit/` へ自動コピーする npm スクリプトが動作する
- [ ] CLAUDE.md に開発フロー、同期手順が明記されている

### 機能要件

#### ソースコード構造の再編成

- [ ] `.cc-craft-kit/commands/` の全ファイルを `src/commands/` へ移動
- [ ] `.claude/commands/takumi/` の全ファイルを `src/slash-commands/` へ移動
- [ ] `.claude/commands/takumi/` を削除し、`src/slash-commands/` へのシンボリックリンクを作成
- [ ] 移動後も既存のスラッシュコマンドが正常に動作することを確認
- [ ] `src/commands/` 内のすべての import パスを修正

#### 整合性チェックツール

- [ ] `npm run check:sync` コマンドで差分検出が可能
- [ ] 差分があるファイルのパスとハッシュ値を表示
- [ ] 差分がない場合は成功メッセージを表示
- [ ] 差分がある場合は終了コード 1 を返す（CI/CD 対応）

#### 自動同期スクリプト

- [ ] `npm run sync:dogfood` コマンドで `src/` → `.cc-craft-kit/` へコピー
- [ ] スラッシュコマンド定義ファイル (`.md`) も `.cc-craft-kit/` へコピー
- [ ] `.cc-craft-kit/` の既存ファイルは上書きされる
- [ ] コピー後に整合性チェックを実行
- [ ] `.claude/commands/takumi/` シンボリックリンクの正常性確認

#### ドキュメント整備

- [ ] CLAUDE.md に「ソースコードとインストール先の関係」セクションを更新
- [ ] 新しいディレクトリ構造を明記
- [ ] 正しい開発フロー（編集 → ビルド → 同期）を明記
- [ ] トラブルシューティングセクションに「差分検出時の対処法」を追加
- [ ] シンボリックリンクの扱いに関する注意事項を追加

### 非機能要件

- [ ] 整合性チェックは 5 秒以内に完了する（1000 ファイル想定）
- [ ] 同期スクリプトは 10 秒以内に完了する
- [ ] エラーメッセージは日本語で分かりやすく表示される

---

## 4. 制約条件

- **プラットフォーム**: Linux, macOS, Windows (WSL) で動作すること
- **Node.js バージョン**: 18.x 以上を想定
- **ファイルシステム**: `.cc-craft-kit/` ディレクトリは `.gitignore` に含まれている前提
- **ビルドツール**: TypeScript コンパイラ（`tsc`）を使用
- **同期対象**: `src/` 配下のすべてのファイル（`.ts`, `.js`, `.json`, `.md` など）
- **シンボリックリンク**: `.claude/commands/takumi/` は Git リポジトリ内のシンボリックリンクとして管理
- **後方互換性**: 既存のスラッシュコマンド（`/cft:*`）が引き続き動作すること

---

## 5. 依存関係

- **TypeScript コンパイラ**: `tsconfig.json` の設定に依存
- **npm スクリプト**: `package.json` の `scripts` セクションに追加
- **CLAUDE.md**: プロジェクトドキュメントの整備が必要
- **Git**: `.gitignore` の設定確認が必要

---

## 6. 参考情報

- CLAUDE.md: プロジェクトの開発ガイドライン
- package.json: npm スクリプト定義
- tsconfig.json: TypeScript コンパイル設定
- .gitignore: Git 除外設定

## 7. 技術的アプローチ案

### ソースコード構造の再編成

1. **フェーズ1: ファイル移動**:
   ```bash
   # commands/ の移動
   mkdir -p src/commands
   cp -r .cc-craft-kit/commands/* src/commands/

   # slash-commands/ の移動
   mkdir -p src/slash-commands
   cp -r .claude/commands/takumi/* src/slash-commands/
   ```

2. **フェーズ2: シンボリックリンク作成**:
   ```bash
   rm -rf .claude/commands/takumi
   ln -s ../../src/slash-commands .claude/commands/takumi
   ```

3. **フェーズ3: import パスの修正**:
   - `src/commands/` 内のすべての `.ts` ファイルで相対パスを修正
   - 例: `../core/` → `../../core/`

### 整合性チェックツール

1. **ファイルハッシュ比較**:
   - `src/` と `.cc-craft-kit/` の対応ファイルの MD5 ハッシュを比較
   - Node.js の `crypto` モジュールを使用

2. **実装方法**:
   - `src/scripts/check-sync.ts` を作成
   - 再帰的にディレクトリをスキャン
   - 差分があるファイルを配列で収集
   - 結果を標準出力に表示

### 自動同期スクリプト

1. **コピー方法**:
   - Node.js の `fs.cpSync` を使用（クロスプラットフォーム対応）
   - `src/` → `.cc-craft-kit/` へ再帰的にコピー
   - `src/slash-commands/` → `.claude/commands/takumi/` へもコピー（シンボリックリンク維持）

2. **実装方法**:
   - `src/scripts/sync-dogfood.ts` を作成
   - コピー後に `check-sync.ts` を実行して検証

### npm スクリプト追加

```json
{
  "scripts": {
    "check:sync": "tsx src/scripts/check-sync.ts",
    "sync:dogfood": "tsx src/scripts/sync-dogfood.ts",
    "build:dogfood": "npm run build && npm run sync:dogfood",
    "migrate:structure": "tsx src/scripts/migrate-structure.ts"
  }
}
```

### マイグレーション手順

1. **事前確認**:
   - 現在の `.cc-craft-kit/` と `src/` の差分を確認
   - 未コミットの変更をすべてコミット

2. **構造移行**:
   - `npm run migrate:structure` を実行
   - シンボリックリンクの動作確認

3. **動作検証**:
   - 各スラッシュコマンドを実行して正常動作を確認
   - `npm run check:sync` で整合性確認

4. **Git コミット**:
   - 新しい構造を Git にコミット
   - `.gitignore` の更新確認

---

## 8. 設計 (Design Phase)

### 8.1 アーキテクチャ概要

```
┌─────────────────────────────────────────────────────┐
│              開発者の編集作業                         │
│                  (src/)                              │
└──────────────────┬──────────────────────────────────┘
                   │
                   ▼
         ┌─────────────────────┐
         │  npm run build      │ TypeScript コンパイル
         └──────────┬──────────┘
                   │
                   ▼
         ┌─────────────────────┐
         │ npm run sync:dogfood│ 自動同期スクリプト
         └──────────┬──────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────┐
│          ドッグフーディング環境                       │
│               (.cc-craft-kit/)                             │
└─────────────────────────────────────────────────────┘
                   │
                   ▼
         ┌─────────────────────┐
         │ スラッシュコマンド   │ Claude Code から実行
         │   /cft:*         │
         └─────────────────────┘
```

### 8.2 ディレクトリ構造詳細設計

#### 移行後の完全なディレクトリ構成

```
takumi/
├── src/                          # ✅ Git管理: すべてのソースコード
│   ├── commands/                 # 📦 新規: CLI実装 (.cc-craft-kit/commands/ から移動)
│   │   ├── init.ts
│   │   ├── status.ts
│   │   ├── spec/
│   │   │   ├── create.ts
│   │   │   ├── get.ts
│   │   │   ├── list.ts
│   │   │   ├── phase.ts
│   │   │   └── update.ts
│   │   ├── github/
│   │   │   ├── init.ts
│   │   │   ├── issue-create.ts
│   │   │   ├── sync.ts
│   │   │   └── project-add.ts
│   │   ├── knowledge/
│   │   │   ├── progress.ts
│   │   │   ├── error.ts
│   │   │   └── tip.ts
│   │   └── utils/
│   │       ├── error-handler.ts
│   │       ├── validation.ts
│   │       └── output.ts
│   │
│   ├── slash-commands/           # 📦 新規: スラッシュコマンド定義 (.claude/commands/takumi/ から移動)
│   │   ├── init.md
│   │   ├── status.md
│   │   ├── spec-create.md
│   │   ├── spec-get.md
│   │   ├── spec-list.md
│   │   ├── spec-phase.md
│   │   ├── spec-update.md
│   │   ├── github-init.md
│   │   ├── github-issue-create.md
│   │   ├── github-sync.md
│   │   ├── github-project-add.md
│   │   ├── knowledge-progress.md
│   │   ├── knowledge-error.md
│   │   └── knowledge-tip.md
│   │
│   ├── core/                     # ✅ 既存: コアロジック
│   │   ├── database/
│   │   ├── workflow/
│   │   ├── events/
│   │   ├── templates/
│   │   ├── skills/               # スキル
│   │   ├── subagents/            # サブエージェント
│   │   └── ...
│   │
│   ├── integrations/             # ✅ 既存: 外部統合
│   │   └── github/
│   │
│   ├── scripts/                  # 📦 新規: ビルド・同期スクリプト
│   │   ├── check-sync.ts         # 整合性チェック
│   │   ├── sync-dogfood.ts       # 自動同期
│   │   └── migrate-structure.ts  # 構造マイグレーション
│   │
│   └── ...
│
├── .claude/                      # ✅ Git管理: Claude Code設定
│   └── commands/
│       └── takumi/               # 🔗 シンボリックリンク → ../../src/slash-commands/
│
├── .cc-craft-kit/                      # ❌ Git管理外: ドッグフーディング環境
│   ├── commands/                 # src/commands/ のコピー
│   ├── core/                     # src/core/ のコピー
│   ├── integrations/             # src/integrations/ のコピー
│   ├── specs/                    # 仕様書ファイル
│   └── cc-craft-kit.db                 # データベース
│
└── dist/                         # ❌ Git管理外: ビルド成果物
    └── ...
```

### 8.3 コンポーネント設計

#### 8.3.1 マイグレーションスクリプト (`src/scripts/migrate-structure.ts`)

**責務:**
- `.cc-craft-kit/commands/` → `src/commands/` へのファイル移動
- `.claude/commands/takumi/` → `src/slash-commands/` へのファイル移動
- シンボリックリンクの作成
- import パスの自動修正

**インターフェース:**

```typescript
interface MigrationConfig {
  dryRun: boolean;          // true の場合、実際の変更は行わない
  verbose: boolean;         // 詳細ログ出力
  skipImportFix: boolean;   // import パス修正をスキップ
}

interface MigrationResult {
  success: boolean;
  movedFiles: string[];     // 移動したファイルのリスト
  errors: string[];         // エラーメッセージ
  warnings: string[];       // 警告メッセージ
}

async function migrateStructure(config: MigrationConfig): Promise<MigrationResult>
```

**処理フロー:**

1. **事前チェック**:
   - `src/commands/` が既に存在しないことを確認
   - `src/slash-commands/` が既に存在しないことを確認
   - `.cc-craft-kit/commands/` にファイルが存在することを確認

2. **ファイル移動**:
   - `.cc-craft-kit/commands/` → `src/commands/` へコピー
   - `.claude/commands/takumi/` → `src/slash-commands/` へコピー

3. **import パス修正**:
   - `src/commands/**/*.ts` 内の import 文を解析
   - 相対パスを新しい階層に合わせて修正
   - 例: `../core/` → `../../core/`

4. **シンボリックリンク作成**:
   - `.claude/commands/takumi/` を削除
   - `ln -s ../../src/slash-commands .claude/commands/takumi` を実行

5. **検証**:
   - シンボリックリンクの有効性確認
   - TypeScript コンパイルエラーがないことを確認

#### 8.3.2 整合性チェックツール (`src/scripts/check-sync.ts`)

**責務:**
- `src/` と `.cc-craft-kit/` のファイル差分検出
- ハッシュ値比較による整合性確認
- CI/CD 対応（終了コード）

**インターフェース:**

```typescript
interface SyncCheckOptions {
  verbose: boolean;         // 詳細出力
  showHash: boolean;        // ハッシュ値を表示
}

interface FileDiff {
  path: string;             // ファイルパス
  srcHash: string | null;   // src/ のハッシュ (存在しない場合 null)
  takumiHash: string | null; // .cc-craft-kit/ のハッシュ (存在しない場合 null)
  status: 'modified' | 'missing_in_takumi' | 'extra_in_takumi';
}

interface SyncCheckResult {
  inSync: boolean;          // 完全同期している場合 true
  diffs: FileDiff[];        // 差分リスト
  totalFiles: number;       // チェック対象ファイル総数
}

async function checkSync(options: SyncCheckOptions): Promise<SyncCheckResult>
```

**処理フロー:**

1. **ファイル収集**:
   - `src/commands/`, `src/core/`, `src/integrations/` を再帰的にスキャン
   - TypeScript ファイル (`.ts`), JSON ファイル (`.json`) を対象

2. **ハッシュ計算**:
   - `crypto.createHash('md5')` を使用
   - 対応する `.cc-craft-kit/` のファイルも同様に計算

3. **差分検出**:
   - ハッシュ値が異なる → `modified`
   - `src/` に存在するが `.cc-craft-kit/` にない → `missing_in_takumi`
   - `.cc-craft-kit/` に存在するが `src/` にない → `extra_in_takumi`

4. **結果出力**:
   - 差分がある場合: ファイルパスとステータスを表示、終了コード 1
   - 差分がない場合: 成功メッセージ、終了コード 0

#### 8.3.3 自動同期スクリプト (`src/scripts/sync-dogfood.ts`)

**責務:**
- `src/` → `.cc-craft-kit/` への自動コピー
- スラッシュコマンド定義ファイルのシンボリックリンク維持
- コピー後の整合性検証

**インターフェース:**

```typescript
interface SyncOptions {
  force: boolean;           // 確認なしで実行
  checkAfterSync: boolean;  // 同期後に整合性チェック
}

interface SyncResult {
  success: boolean;
  copiedFiles: number;      // コピーしたファイル数
  errors: string[];
}

async function syncDogfood(options: SyncOptions): Promise<SyncResult>
```

**処理フロー:**

1. **ビルド確認**:
   - `dist/` ディレクトリが存在することを確認
   - ビルドが古い場合は警告

2. **コピー実行**:
   - `fs.cpSync(src, dest, { recursive: true, force: true })` を使用
   - `src/commands/` → `.cc-craft-kit/commands/`
   - `src/core/` → `.cc-craft-kit/core/`
   - `src/integrations/` → `.cc-craft-kit/integrations/`

3. **シンボリックリンク確認**:
   - `.claude/commands/takumi/` が有効なシンボリックリンクであることを確認
   - 壊れている場合は再作成

4. **整合性チェック**:
   - `checkAfterSync: true` の場合、`check-sync.ts` を実行
   - 差分がある場合はエラー

### 8.4 データモデル

このプロジェクトは既存のデータベーススキーマを変更しません。スクリプトの設定は環境変数または引数で管理します。

**環境変数:**

| 変数名 | 説明 | デフォルト値 |
|---|---|---|
| `TAKUMI_ROOT` | Takumi プロジェクトルート | `process.cwd()` |
| `TAKUMI_SRC_DIR` | ソースディレクトリ | `src/` |
| `TAKUMI_DOGFOOD_DIR` | ドッグフーディング環境 | `.cc-craft-kit/` |

### 8.5 エラーハンドリング設計

**エラー分類:**

1. **ファイルシステムエラー**:
   - ファイルが存在しない → `FileNotFoundError`
   - 権限エラー → `PermissionError`
   - シンボリックリンク作成失敗 → `SymlinkError`

2. **整合性チェックエラー**:
   - ハッシュ不一致 → 警告レベル、終了コード 1
   - ファイル欠損 → エラーレベル、終了コード 1

3. **マイグレーションエラー**:
   - 既存ディレクトリ競合 → `ConflictError`
   - import パス修正失敗 → `ImportFixError`

**エラーメッセージ例:**

```
❌ エラー: src/commands/ は既に存在します
→ マイグレーションを実行する前に、既存のディレクトリを削除してください

⚠️  警告: .cc-craft-kit/commands/status.ts がsrc/commands/status.ts と一致しません
→ npm run sync:dogfood を実行してください

✓ 成功: すべてのファイルが同期されています (チェック対象: 142 ファイル)
```

### 8.6 パフォーマンス設計

**目標:**
- 整合性チェック: 1000 ファイルを 5 秒以内
- 同期スクリプト: 1000 ファイルを 10 秒以内

**最適化手法:**

1. **並列ハッシュ計算**:
   - `Promise.all()` でファイルハッシュを並列計算
   - ワーカースレッド数: `os.cpus().length`

2. **増分コピー**:
   - ハッシュが一致するファイルはスキップ
   - 変更があったファイルのみコピー

3. **キャッシュ**:
   - ハッシュ値を一時ファイルにキャッシュ（オプション）

### 8.7 セキュリティ設計

**対策:**

1. **パストラバーサル対策**:
   - すべてのファイルパスを `path.resolve()` で正規化
   - プロジェクトルート外へのアクセスを禁止

2. **シンボリックリンク検証**:
   - `fs.lstat()` でシンボリックリンクの実体を確認
   - プロジェクト外へのリンクを禁止

3. **ファイル権限**:
   - コピー時に実行権限を保持
   - センシティブファイル (`.env`) はコピー対象外

### 8.8 CLAUDE.md ドキュメント更新計画

**更新セクション:**

#### 1. 「ソースコードとインストール先の関係」セクションを更新

**現在:**
```markdown
## ⚠️ 重要: ソースコードとインストール先の関係

### ディレクトリ構成

Takumi プロジェクトは、**自分自身を使って開発する（ドッグフーディング）** ため、2つのコードベースが存在します：

| ディレクトリ | 役割 | 説明 |
|---|---|---|
| **`src/`** | **ソースコード** | 開発時に編集する本体のTypeScriptコード |
| **`dist/`** | ビルド成果物 | `npm run build` で `src/` からコンパイルされる（`.gitignore` 対象） |
| **`.cc-craft-kit/`** | **インストール先** | Takumi自身がTakumiを使うためのインストール先（ドッグフーディング用） |
```

**更新後:**
```markdown
## ⚠️ 重要: ソースコードとインストール先の関係

### ディレクトリ構成

Takumi プロジェクトは、**自分自身を使って開発する（ドッグフーディング）** ため、以下のディレクトリ構造を採用しています：

| ディレクトリ | 役割 | Git管理 | 説明 |
|---|---|---|---|
| **`src/`** | **ソースコード** | ✅ | 開発時に編集する本体のTypeScriptコード |
| **`src/commands/`** | CLI実装 | ✅ | スラッシュコマンドから実行されるCLI実装 |
| **`src/slash-commands/`** | スラッシュコマンド定義 | ✅ | Claude Codeのスラッシュコマンド定義 (`.md`) |
| **`.claude/commands/takumi/`** | シンボリックリンク | ✅ | `src/slash-commands/` へのシンボリックリンク |
| **`dist/`** | ビルド成果物 | ❌ | `npm run build` で `src/` からコンパイルされる |
| **`.cc-craft-kit/`** | **インストール先** | ❌ | Takumi自身がTakumiを使うためのインストール先（ドッグフーディング用） |

### 開発フロー

1. **編集**: `src/` 配下のファイルを編集
2. **ビルド**: `npm run build` でTypeScriptコンパイル
3. **同期**: `npm run sync:dogfood` で `.cc-craft-kit/` へ自動コピー
4. **実行**: スラッシュコマンド `/cft:*` を実行してテスト

**重要:** `src/` を編集したら必ず `npm run sync:dogfood` を実行してください。
```

#### 2. 「よく使うコマンド」セクションに追加

**追加内容:**
```markdown
### ソースコード同期

```bash
# 整合性チェック
npm run check:sync

# ドッグフーディング環境へ同期
npm run sync:dogfood

# ビルド + 同期
npm run build:dogfood

# 構造マイグレーション（初回のみ）
npm run migrate:structure
```
```

#### 3. 「トラブルシューティング」セクションに追加

**追加内容:**
```markdown
### ソースコード同期エラー

**症状:** スラッシュコマンドが古い動作をする

**原因:** `src/` の変更が `.cc-craft-kit/` に反映されていない

**解決策:**
```bash
# 1. 差分確認
npm run check:sync

# 2. 同期実行
npm run sync:dogfood

# 3. 整合性再確認
npm run check:sync
```

**症状:** `npm run check:sync` で差分が検出される

**解決策:**
```bash
# src/ と .cc-craft-kit/ のファイルハッシュを比較
md5sum src/commands/status.ts .cc-craft-kit/commands/status.ts

# 一致していない場合は同期
npm run sync:dogfood
```
```

#### 4. 「開発時の注意事項」セクションに追加

**追加内容:**
```markdown
### ソースコード管理

- **すべてのコード編集は `src/` で行う**: `.cc-craft-kit/` 配下のファイルは自動生成されるため、直接編集しない
- **スラッシュコマンド定義は `src/slash-commands/` で管理**: `.claude/commands/takumi/` はシンボリックリンクのため、直接編集しない
- **同期を忘れない**: `src/` を編集したら `npm run sync:dogfood` を実行
- **CI/CD での整合性チェック**: プルリクエスト時に `npm run check:sync` を実行して差分がないことを確認
```

### 8.9 実装優先順位

設計完了後、以下の順序で実装を進めることを推奨します:

1. **Phase 1: 整合性チェックツール** (`src/scripts/check-sync.ts`)
   - 現状把握に必要
   - 他のスクリプト開発時の検証ツールとして使用

2. **Phase 2: 自動同期スクリプト** (`src/scripts/sync-dogfood.ts`)
   - マイグレーション前に同期フローを確立
   - 手動での動作確認が可能

3. **Phase 3: マイグレーションスクリプト** (`src/scripts/migrate-structure.ts`)
   - 構造変更の実施
   - 慎重な実行が必要

4. **Phase 4: ドキュメント整備**
   - CLAUDE.md の更新
   - 開発フロー、トラブルシューティングの追記

5. **Phase 5: CI/CD統合**
   - GitHub Actions で整合性チェック自動化
   - プルリクエスト時の自動検証

---

## 9. タスク分解 (Tasks Phase)

### Phase 1: 整合性チェックツール (`src/scripts/check-sync.ts`)

**タスク 1.1: プロジェクト構造のスキャン機能実装** ✅
- **所要時間**: 2 時間
- **依存関係**: なし
- **詳細**:
  - `src/commands/`, `src/core/`, `src/integrations/` を再帰的にスキャン
  - `.ts`, `.json`, `.md` ファイルを収集
  - ディレクトリトラバーサル処理実装
- **受け入れ基準**:
  - [x] `glob` パターンまたは `fs.readdir()` で再帰的スキャン実装
  - [x] `.gitignore` パターンを考慮（`node_modules/`, `dist/` を除外）
  - [x] ファイルリストを配列で返す関数を実装

**タスク 1.2: ファイルハッシュ計算機能実装** ✅
- **所要時間**: 1 時間
- **依存関係**: タスク 1.1
- **詳細**:
  - `crypto.createHash('md5')` を使用してファイルハッシュを計算
  - `src/` と `.cc-craft-kit/` の対応ファイルのハッシュを比較
- **受け入れ基準**:
  - [x] ファイルパスを受け取り、MD5 ハッシュを返す関数を実装
  - [x] ストリーム処理で大きなファイルにも対応
  - [x] エラーハンドリング（ファイルが存在しない場合）

**タスク 1.3: 差分検出ロジック実装** ✅
- **所要時間**: 2 時間
- **依存関係**: タスク 1.2
- **詳細**:
  - `src/` と `.cc-craft-kit/` のハッシュ比較
  - 差分ステータスの分類（`modified`, `missing_in_takumi`, `extra_in_takumi`）
- **受け入れ基準**:
  - [x] `FileDiff[]` 型の差分リストを生成
  - [x] ハッシュ不一致を検出
  - [x] 片方にのみ存在するファイルを検出

**タスク 1.4: CLI 出力とレポート機能実装** ✅
- **所要時間**: 1.5 時間
- **依存関係**: タスク 1.3
- **詳細**:
  - 差分がある場合: ファイルパスとステータスを表示
  - 差分がない場合: 成功メッセージ
  - 終了コード制御（差分あり: 1, なし: 0）
- **受け入れ基準**:
  - [x] カラー出力（chalk または標準 ANSI エスケープコード）
  - [x] `--verbose` フラグで詳細情報表示
  - [x] `--show-hash` フラグでハッシュ値表示
  - [x] 適切な終了コード

**タスク 1.5: 単体テスト作成** ✅
- **所要時間**: 2 時間
- **依存関係**: タスク 1.4
- **詳細**:
  - ファイルスキャン、ハッシュ計算、差分検出のユニットテスト
  - モックファイルシステムを使用
- **受け入れ基準**:
  - [x] カバレッジ 80% 以上
  - [x] エッジケース（空ディレクトリ、シンボリックリンク）をテスト

---

### Phase 2: 自動同期スクリプト (`src/scripts/sync-dogfood.ts`) ✅

**タスク 2.1: コピー機能の基本実装** ✅
- **所要時間**: 2 時間
- **依存関係**: Phase 1 完了
- **詳細**:
  - `fs.cpSync()` を使用して `src/` → `.cc-craft-kit/` へコピー
  - 再帰的コピー、上書きオプション
- **受け入れ基準**:
  - [x] `src/commands/`, `src/core/`, `src/integrations/` をコピー
  - [x] 既存ファイルを上書き
  - [x] ディレクトリ構造を保持

**タスク 2.2: 増分コピーの最適化** ✅
- **所要時間**: 2 時間
- **依存関係**: タスク 2.1, タスク 1.2（ハッシュ計算機能）
- **詳細**:
  - ハッシュが一致するファイルはスキップ
  - 変更があったファイルのみコピー
- **受け入れ基準**:
  - [x] ハッシュ比較でスキップ判定（check-sync 統合）
  - [x] コピーしたファイル数を表示

**タスク 2.3: スラッシュコマンド同期機能** ✅
- **所要時間**: 1.5 時間
- **依存関係**: タスク 2.1
- **詳細**:
  - `.claude/commands/takumi/` から `.cc-craft-kit/slash-commands/` へコピー
  - `.md` ファイルのみ対象
- **受け入れ基準**:
  - [x] スラッシュコマンド定義ファイルを同期
  - [x] `.md` ファイルのみをフィルタリング
  - [x] ディレクトリが存在しない場合はスキップ

**タスク 2.4: Dry-runモード実装** ✅
- **所要時間**: 1 時間
- **依存関係**: タスク 2.2
- **詳細**:
  - `--dry-run` フラグで実際の変更を行わずに動作確認
  - 変更予定のファイル一覧を表示
- **受け入れ基準**:
  - [x] `--dry-run` フラグでファイル変更を実行しない
  - [x] 変更予定ファイルをログ出力
  - [x] 成功メッセージで dry-run であることを明示

**タスク 2.5: 単体テスト・統合テスト作成** ✅
- **所要時間**: 2 時間
- **依存関係**: タスク 2.4
- **詳細**:
  - コピー、増分コピー、スラッシュコマンド同期のテスト
- **受け入れ基準**:
  - [x] カバレッジ 80% 以上（9 テスト全てパス）
  - [x] 一時ディレクトリでのテスト実行

---

### Phase 3: マイグレーションスクリプト (`src/scripts/migrate-structure.ts`)

**タスク 3.1: 事前チェック機能実装**
- **所要時間**: 1.5 時間
- **依存関係**: Phase 2 完了
- **詳細**:
  - `src/commands/`, `src/slash-commands/` が既に存在しないことを確認
  - `.cc-craft-kit/commands/`, `.claude/commands/takumi/` が存在することを確認
- **受け入れ基準**:
  - [ ] ディレクトリ存在チェック
  - [ ] 競合がある場合はエラーで停止
  - [ ] `--dry-run` フラグでシミュレーション

**タスク 3.2: ファイル移動機能実装**
- **所要時間**: 2 時間
- **依存関係**: タスク 3.1
- **詳細**:
  - `.cc-craft-kit/commands/` → `src/commands/` へコピー
  - `.claude/commands/takumi/` → `src/slash-commands/` へコピー
- **受け入れ基準**:
  - [ ] ディレクトリ構造を保持
  - [ ] ファイル権限を保持
  - [ ] 移動したファイルリストを記録

**タスク 3.3: import パス自動修正機能実装**
- **所要時間**: 3 時間
- **依存関係**: タスク 3.2
- **詳細**:
  - `src/commands/**/*.ts` の import 文を解析
  - 相対パスを新しい階層に合わせて修正
  - TypeScript AST パーサー（`@typescript-eslint/parser`）またはシンプルな正規表現を使用
- **受け入れ基準**:
  - [ ] `../core/` → `../../core/` などのパス修正
  - [ ] 絶対パス（`@/`）は変更しない
  - [ ] 修正前後の差分をログ出力

**タスク 3.4: シンボリックリンク作成機能実装**
- **所要時間**: 1 時間
- **依存関係**: タスク 3.2
- **詳細**:
  - `.claude/commands/takumi/` を削除
  - `ln -s ../../src/slash-commands .claude/commands/takumi` を実行
- **受け入れ基準**:
  - [ ] クロスプラットフォーム対応
  - [ ] シンボリックリンクの有効性検証

**タスク 3.5: TypeScript コンパイル検証**
- **所要時間**: 1 時間
- **依存関係**: タスク 3.3
- **詳細**:
  - `tsc --noEmit` でコンパイルエラーがないことを確認
- **受け入れ基準**:
  - [ ] コンパイルエラーがある場合はロールバック
  - [ ] エラーメッセージを表示

**タスク 3.6: 単体テスト・統合テスト作成**
- **所要時間**: 2.5 時間
- **依存関係**: タスク 3.5
- **詳細**:
  - 一時ディレクトリで完全なマイグレーションをテスト
- **受け入れ基準**:
  - [ ] カバレッジ 80% 以上
  - [ ] ロールバック機能のテスト

---

### Phase 4: ドキュメント整備

**タスク 4.1: CLAUDE.md の「ソースコードとインストール先の関係」セクション更新**
- **所要時間**: 1 時間
- **依存関係**: Phase 3 完了
- **詳細**:
  - 新しいディレクトリ構造を反映
  - Git 管理状態を明記
- **受け入れ基準**:
  - [ ] 表形式で明確に記述
  - [ ] 開発フローを図解

**タスク 4.2: 「よく使うコマンド」セクションに同期コマンド追加**
- **所要時間**: 30 分
- **依存関係**: タスク 4.1
- **詳細**:
  - `npm run check:sync`, `npm run sync:dogfood` などを追加
- **受け入れ基準**:
  - [ ] コマンド説明を追加
  - [ ] 使用例を記載

**タスク 4.3: 「トラブルシューティング」セクション追加**
- **所要時間**: 1 時間
- **依存関係**: タスク 4.2
- **詳細**:
  - よくあるエラーと解決策を記述
- **受け入れ基準**:
  - [ ] 症状・原因・解決策の 3 点セットで記述
  - [ ] コマンド例を記載

**タスク 4.4: 「開発時の注意事項」セクション追加**
- **所要時間**: 30 分
- **依存関係**: タスク 4.3
- **詳細**:
  - ソースコード管理のベストプラクティスを記述
- **受け入れ基準**:
  - [ ] 箇条書きで簡潔に記述

---

### Phase 5: CI/CD統合

**タスク 5.1: package.json の npm スクリプト追加**
- **所要時間**: 30 分
- **依存関係**: Phase 2 完了
- **詳細**:
  - `check:sync`, `sync:dogfood`, `build:dogfood`, `migrate:structure` を追加
- **受け入れ基準**:
  - [ ] すべてのスクリプトが正常動作
  - [ ] 依存関係を考慮した順序

**タスク 5.2: GitHub Actions ワークフロー作成（オプション）**
- **所要時間**: 2 時間
- **依存関係**: タスク 5.1
- **詳細**:
  - プルリクエスト時に `npm run check:sync` を自動実行
- **受け入れ基準**:
  - [ ] `.github/workflows/check-sync.yml` を作成
  - [ ] 差分がある場合は CI 失敗

---

### タスク総数と所要時間の見積もり

| Phase | タスク数 | 合計所要時間 |
|---|---|---|
| Phase 1: 整合性チェックツール | 5 | 8.5時間 |
| Phase 2: 自動同期スクリプト | 5 | 8.5時間 |
| Phase 3: マイグレーションスクリプト | 6 | 11時間 |
| Phase 4: ドキュメント整備 | 4 | 3時間 |
| Phase 5: CI/CD統合 | 2 | 2.5時間 |
| **合計** | **22** | **33.5時間** |

### 実装順序

1. Phase 1 → Phase 2 → Phase 3 の順に実装（依存関係あり）
2. Phase 4 は Phase 3 完了後
3. Phase 5 は Phase 2 完了後に並行実装可能

---

## 10. 実装進捗

### ✅ Phase 1 完了 (2025/11/17)

**実装ファイル:**
- `src/scripts/check-sync.ts` (418 行) - 整合性チェックツール
- `tests/scripts/check-sync.test.ts` (303 行) - 単体テスト (17 テスト全てパス)

**主要機能:**
- ディレクトリスキャン (`scanDirectory`, `scanProjectFiles`)
- MD5 ハッシュ計算 (`calculateFileHash`, `calculateFileHashes`) - ストリーム処理対応
- 差分検出 (`detectDifferences`) - 3 つのステータス: modified/missing_in_takumi/extra_in_takumi
- CLI 出力 (`printDiffReport`) - カラー出力、終了コード制御

**npm スクリプト追加:**
```json
"check:sync": "tsx src/scripts/check-sync.ts"
```

### ✅ Phase 2 完了 (2025/11/17)

**実装ファイル:**
- `src/scripts/sync-dogfood.ts` (276 行) - 自動同期スクリプト
- `tests/scripts/sync-dogfood.test.ts` (220 行) - 単体テスト (9 テスト全てパス)

**主要機能:**
- `syncSourceToTakumi` - src/ → .cc-craft-kit/ 自動同期
- `syncSlashCommands` - .claude/commands/takumi/ → .cc-craft-kit/slash-commands/ 同期
- `syncAll` - 完全同期実行
- Dry-run モード対応 (`--dry-run`, `--verbose`)
- エラーハンドリングと詳細ログ出力

**npm スクリプト追加:**
```json
"sync:dogfood": "tsx src/scripts/sync-dogfood.ts"
"sync:dogfood:dry": "tsx src/scripts/sync-dogfood.ts --dry-run --verbose"
"build:dogfood": "npm run build && npm run sync:dogfood"
```

### ✅ Phase 3 完了 (2025/11/17)

**実装ファイル:**
- `src/scripts/migrate-structure.ts` (370 行) - マイグレーションスクリプト
- `tests/scripts/migrate-structure.test.ts` (280 行) - 単体テスト (10 テスト全てパス)

**主要機能:**
- `preflightCheck` - 事前チェック（移動先ディレクトリの競合検出）
- `migrateCommands` - .cc-craft-kit/commands/ → src/commands/ 移動
- `migrateSlashCommands` - .claude/commands/takumi/ → src/slash-commands/ 移動
- `createSlashCommandsSymlink` - シンボリックリンク作成
- Dry-run モード対応、ロールバック可能な設計

**npm スクリプト追加:**
```json
"migrate:structure": "tsx src/scripts/migrate-structure.ts"
"migrate:structure:dry": "tsx src/scripts/migrate-structure.ts --dry-run --verbose"
```

### ✅ Phase 4 完了 (2025/11/17)

**ドキュメント更新:**
- `CLAUDE.md` - 包括的なドキュメント整備
  - ディレクトリ構成セクション更新（Git 管理状態明記）
  - 開発フロー追加（編集→ビルド→同期→実行）
  - ソースコード同期コマンド追加
  - トラブルシューティングセクション追加（3 つのシナリオ）
  - 開発時の注意事項追加（6 項目）

### ✅ Phase 5 完了 (2025/11/17)

**CI/CD統合:**
- `.github/workflows/ci.yml` - check-sync ジョブ追加
  - プルリクエスト時に `npm run check:sync` を自動実行
  - 差分検出時は CI 失敗（エラーメッセージ表示）
  - build ジョブの依存関係に追加

**npm スクリプト:**
- ✅ check:sync
- ✅ sync:dogfood / sync:dogfood:dry
- ✅ build:dogfood
- ✅ migrate:structure / migrate:structure:dry

### 📊 最終完了状況

**実装済み機能:**
- ✅ `src/` と `.cc-craft-kit/` の整合性チェック機能
- ✅ 自動同期スクリプトによる開発フロー改善
- ✅ Dry-run モードによる安全な動作確認
- ✅ マイグレーションツール（ファイル移動、シンボリックリンク作成）
- ✅ 包括的な単体テスト（36 テスト全てパス）
- ✅ npm スクリプトによる開発者体験向上
- ✅ CI/CD パイプラインでの整合性チェック自動化
- ✅ 包括的なドキュメント整備

**テスト結果:**
- check-sync: 17 テスト ✅
- sync-dogfood: 9 テスト ✅
- migrate-structure: 10 テスト ✅
- **合計: 36テスト全てパス**
