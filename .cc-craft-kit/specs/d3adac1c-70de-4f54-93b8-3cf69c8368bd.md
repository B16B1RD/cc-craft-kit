---
id: "d3adac1c-70de-4f54-93b8-3cf69c8368bd"
name: "completed 後に PR のマージを報告するフェーズが欲しい"
phase: "completed"
branch_name: "main"
github_issue_number: null
pr_url: null
created_at: "2025-11-23T08:28:38.415Z"
updated_at: "2025-11-23T18:07:00Z"
---

# completed 後に PR のマージを報告するフェーズが欲しい


## 1. 背景と目的

### 背景

現在、cc-craft-kit では PR を `completed` フェーズで自動作成するが、PR がマージされた後の後処理が手動になっている。

- ローカルブランチとリモートブランチが残り続ける
- データベースの `specs.branch_name` カラムにマージ済みブランチ名が残る
- PR マージ後の状態を追跡できない

これにより、開発者が手動でブランチ削除やデータベース更新を行う必要があり、運用コストが増加している。

### 目的

`completed` フェーズの後に PR マージを検知し、以下の後処理を自動化する:

1. PR のマージ状態を GitHub API で確認
2. マージ済みブランチをローカル・リモート両方から削除
3. データベースの `specs.branch_name` をクリア
4. マージ完了イベントを発火(将来的な拡張性)
---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者
---

## 3. 受け入れ基準

### 必須要件

- [ ] `completed` フェーズで作成された PR のマージ状態を GitHub API で取得できる
- [ ] PR がマージされた場合、ローカルブランチとリモートブランチを削除できる
- [ ] データベースの `specs.branch_name` カラムをクリア(NULL に更新)できる

### 機能要件

- [ ] PR マージ検知機能の実装(GitHub API `/repos/{owner}/{repo}/pulls/{pull_number}` の `merged` フィールドを確認)
- [ ] ローカルブランチ削除機能の実装(`git branch -D <branch-name>`)
- [ ] リモートブランチ削除機能の実装(`git push origin --delete <branch-name>`)
- [ ] データベース更新機能の実装(`UPDATE specs SET branch_name = NULL WHERE id = ?`)
- [ ] 処理完了後に `spec.pr_merged` イベントを発火
- [ ] エラーハンドリング(ブランチ削除失敗時の警告表示など)

### 非機能要件

- [ ] GitHub API のレート制限を考慮した実装
- [ ] 処理失敗時のロールバック戦略(ブランチ削除失敗時はデータベース更新をスキップ)
- [ ] 安全性: 保護ブランチ(main/develop)は削除しない
---

## 4. 制約条件

### 技術的制約

1. **GitHub API**
   - Octokit(REST API)を使用
   - レート制限対応が必須
   - `GITHUB_TOKEN` 環境変数で認証

2. **データベース操作**
   - `getDatabase()` を使用(複数インスタンス化禁止)
   - Kysely のパラメータ化クエリのみ使用

3. **Git 操作**
   - `execSync` を使用してブランチ削除
   - 保護ブランチ(main/develop)の削除禁止
   - エラーハンドリング必須

4. **イベント駆動**
   - `spec.pr_merged` イベント発火(将来的な拡張性)
   - non-blocking 実行

### セキュリティ制約

- API キーをコードに直接記述しない
- Git 操作のモック化(テスト実行時)
---

## 5. 依存関係

### 関連モジュール

- **GitHub 統合モジュール**
  - `GitHubClient` (REST API)
  - `GitHubSyncService` (同期ステータス管理)

- **Git 操作モジュール**
  - `branch-guard.ts` (保護ブランチ判定)

- **データベース**
  - `specs` テーブル(`branch_name` カラム)
  - `github_sync` テーブル(`pr_number` カラム)

- **イベントバス**
  - `EventBus` (`spec.pr_merged` イベント発火)

### データフロー

```
PR マージ検知トリガー(手動コマンドまたは自動)
  ↓
GitHub API で PR マージ状態を確認
  ↓
マージ済みの場合
  ├─ ローカルブランチ削除
  ├─ リモートブランチ削除
  ├─ データベース更新(specs.branch_name = NULL)
  └─ spec.pr_merged イベント発火
```
---

## 6. 参考情報

### 既存の実装

- PR 作成機能: `/home/autum/Projects/personal/cc-craft-kit/src/integrations/github/pull-request.ts`
- ブランチ管理: `/home/autum/Projects/personal/cc-craft-kit/src/core/workflow/branch-management.ts`
- フェーズ遷移: `/home/autum/Projects/personal/cc-craft-kit/src/commands/spec/phase.ts`

### GitHub API ドキュメント

- [Get a pull request](https://docs.github.com/en/rest/pulls/pulls#get-a-pull-request)
- [Delete a reference](https://docs.github.com/en/rest/git/refs#delete-a-reference)

### データベーススキーマ

- マイグレーション 004: `004_add_pr_support.ts` (PR フィールド追加)
- マイグレーション 006: `006_add_branch_name_to_specs.ts` (ブランチ名カラム追加)
---

## 7. 設計詳細

### 7.1. アーキテクチャ設計

#### 全体フロー

```
[completed フェーズ]
  ↓ (PR 作成済み)
[PR マージ検知トリガー]
  ├── 手動コマンド: /cft:pr-cleanup <spec-id>
  └── 自動検知: Webhook (github.pr_merged イベント)
  ↓
[GitHub API で PR マージ状態を確認]
  ├── マージ済み: merged = true
  └── 未マージ: 処理をスキップ
  ↓
[後処理の実行]
  ├── 1. ローカルブランチ削除
  │    └── git branch -D <branch-name>
  ├── 2. リモートブランチ削除
  │    └── git push origin --delete <branch-name>
  ├── 3. データベース更新
  │    ├── specs.branch_name = NULL
  │    └── github_sync.pr_merged_at = NOW()
  └── 4. イベント発火
       └── spec.pr_merged イベント
```

#### モジュール構成

新規実装が必要なモジュール:

1. **PR マージ検知モジュール** (`src/integrations/github/pr-cleanup.ts`)
   - `checkPullRequestMerged(prNumber: number): Promise<boolean>` - PR マージ状態確認
   - `cleanupMergedPullRequest(specId: string): Promise<void>` - 後処理実行

2. **Git ブランチ削除モジュール** (`src/core/workflow/branch-cleanup.ts`)
   - `deleteLocalBranch(branchName: string): void` - ローカルブランチ削除
   - `deleteRemoteBranch(branchName: string): void` - リモートブランチ削除
   - 既存の `isProtectedBranch()` を活用して安全性を確保

3. **データベース更新** (既存の `src/core/database/helpers.ts` を拡張)
   - `clearSpecBranchName(specId: string): Promise<void>` - specs.branch_name をクリア
   - `updatePrMergedStatus(prNumber: number): Promise<void>` - github_sync 更新

4. **イベントハンドラー登録** (`src/core/workflow/github-integration.ts` を拡張)
   - `spec.pr_merged` イベント発火
   - 将来的な拡張: Slack 通知、統計情報更新など

5. **スラッシュコマンド** (`src/slash-commands/pr-cleanup.md`)
   - `/cft:pr-cleanup <spec-id>` - 手動で PR マージ後処理を実行
---

### 7.2. データモデル

#### データベース変更

##### github_sync テーブルに新規カラム追加

既存の `pr_number`, `pr_url` カラムに加えて、マージ状態を追跡するカラムを追加します。

**新規マイグレーション**: `009_add_pr_merged_at.ts`

```sql
ALTER TABLE github_sync
  ADD COLUMN pr_merged_at TEXT DEFAULT NULL;
```

**更新後のスキーマ**:
```typescript
export interface GitHubSyncTable {
  // ...既存フィールド...
  pr_number: number | null;        // PR 番号
  pr_url: string | null;            // PR URL
  pr_merged_at: ColumnType<Date, string | undefined, string> | null; // ← 新規
}
```

##### specs テーブル (変更なし)

既存の `branch_name` カラムを使用します。マージ完了後に `NULL` に更新します。
---

### 7.3. API の仕様

#### GitHub API エンドポイント

##### 1. PR マージ状態の確認

```typescript
// Octokit REST API
GET /repos/{owner}/{repo}/pulls/{pull_number}

// 使用例
const { data: pr } = await client.rest.pulls.get({
  owner: 'owner-name',
  repo: 'repo-name',
  pull_number: 123
});

// 確認項目
pr.merged // boolean: PR がマージ済みか
pr.merged_at // string | null: マージ日時
pr.base.ref // string: ベースブランチ名
pr.head.ref // string: 削除対象ブランチ名
```

##### 2. リモートブランチ削除 (Git Refs API)

```typescript
// Octokit REST API
DELETE /repos/{owner}/{repo}/git/refs/heads/{branch}

// 使用例
await client.rest.git.deleteRef({
  owner: 'owner-name',
  repo: 'repo-name',
  ref: 'heads/feature/spec-d3adac1c-add-pr-merge-phase'
});
```

**注意**: GitHub 側でブランチがすでに削除されている場合、404 エラーが返るため、エラーハンドリングが必要です。
---

#### 内部 API

##### `cleanupMergedPullRequest(specId: string)`

PR マージ後処理のメイン関数。

```typescript
export async function cleanupMergedPullRequest(
  specId: string
): Promise<CleanupResult> {
  const db = getDatabase();
  const client = getGitHubClient();

  // 1. 仕様書と GitHub 情報を取得
  const spec = await getSpecWithGitHubInfo(db, specId);
  if (!spec.pr_number) {
    throw new Error('PR が作成されていません');
  }

  // 2. PR マージ状態を確認
  const pr = await client.rest.pulls.get({
    owner: config.owner,
    repo: config.repo,
    pull_number: spec.pr_number
  });

  if (!pr.data.merged) {
    throw new Error('PR はまだマージされていません');
  }

  const branchName = spec.branch_name;
  if (!branchName) {
    throw new Error('ブランチ名が見つかりません');
  }

  // 3. 保護ブランチチェック
  if (isProtectedBranch(branchName)) {
    throw new Error(`保護ブランチは削除できません: ${branchName}`);
  }

  // 4. ローカルブランチ削除
  await deleteLocalBranch(branchName);

  // 5. リモートブランチ削除
  await deleteRemoteBranch(branchName);

  // 6. データベース更新
  await db.transaction().execute(async (trx) => {
    // specs.branch_name をクリア
    await trx
      .updateTable('specs')
      .set({ branch_name: null })
      .where('id', '=', specId)
      .execute();

    // github_sync.pr_merged_at を記録
    await trx
      .updateTable('github_sync')
      .set({ pr_merged_at: new Date().toISOString() })
      .where('entity_id', '=', specId)
      .where('entity_type', '=', 'spec')
      .execute();
  });

  // 7. イベント発火
  const eventBus = await getEventBusAsync();
  await eventBus.emit({
    type: 'spec.pr_merged',
    timestamp: new Date().toISOString(),
    specId,
    data: {
      prNumber: spec.pr_number,
      branchName,
      mergedAt: pr.data.merged_at
    }
  });

  return {
    success: true,
    prNumber: spec.pr_number,
    branchName,
    mergedAt: pr.data.merged_at
  };
}
```
---

### 7.4. セキュリティ考慮事項

#### 1. 保護ブランチの削除防止

**リスク**: 誤って `main` や `develop` ブランチを削除してしまう

**対策**:
- `src/core/workflow/branch-guard.ts` の `isProtectedBranch()` を使用
- 削除前に必ず保護ブランチチェックを実施
- 保護ブランチの場合は例外をスローし、処理を中断

```typescript
function isProtectedBranch(branchName: string): boolean {
  const config = getGitHubConfig();
  return config.protectedBranches.includes(branchName);
}
```

#### 2. GitHub API トークンの安全性

**リスク**: トークンの流出、コミットへの含有

**対策**:
- `.env` ファイルで管理（`.gitignore` 登録済み）
- `GITHUB_TOKEN` 環境変数から読み込み
- エラーメッセージにトークンを含めない

#### 3. Git 操作のエラーハンドリング

**リスク**: ブランチ削除失敗時にデータベースが不整合状態になる

**対策**:
- ブランチ削除とデータベース更新を **逆順** で実行
  - ブランチ削除を先に実行（失敗しても DB は未更新）
  - データベース更新は最後に実行（ブランチ削除成功後のみ）
- ローカルブランチ削除失敗時はリモートブランチ削除をスキップ
- エラーログを記録し、ユーザーに警告表示

#### 4. データベースロック競合

**リスク**: 複数のプロセスが同時に同じ仕様書を更新

**対策**:
- Kysely トランザクションを使用
- WAL モードによる並行書き込み対応（既存設定）
- busy_timeout 5秒設定（既存設定）
---

### 7.5. テスト戦略

#### 単体テスト

**テストファイル**: `tests/integrations/github/pr-cleanup.test.ts`

**テストケース**:
1. **PR マージ状態確認**
   - マージ済み PR → `merged = true` を返す
   - 未マージ PR → `merged = false` を返す
   - 存在しない PR → 404 エラー

2. **ブランチ削除**
   - 通常のブランチ → 削除成功
   - 保護ブランチ → 例外をスロー
   - 存在しないブランチ → 警告のみ（エラーにしない）

3. **データベース更新**
   - `specs.branch_name` が `NULL` に更新される
   - `github_sync.pr_merged_at` が記録される
   - トランザクションのロールバック確認

4. **イベント発火**
   - `spec.pr_merged` イベントが発火する
   - イベントデータに `prNumber`, `branchName`, `mergedAt` が含まれる

#### モック対象

- **GitHub API**: Octokit をモック化
- **Git 操作**: `execSync` をモック化（テスト実行時にブランチが変更されることを防止）
- **データベース**: `:memory:` モードで実行

#### E2E テスト

**テストシナリオ**:
1. 仕様書を作成 (`requirements` フェーズ)
2. `completed` フェーズに移行（PR 自動作成）
3. `/cft:pr-cleanup <spec-id>` を実行
4. ブランチ削除とデータベース更新を確認

**実装方針**:
- GitHub API とブランチ削除をモック化
- E2E テスト実行時は `E2E_TEST=true` 環境変数を設定し、実際の Git 操作をスキップ
---

### 7.6. エラーハンドリング

#### エラー分類と処理方針

| エラー種別 | 処理 | データベース更新 | ユーザー通知 |
|---|---|---|---|
| PR が見つからない | 例外をスロー | なし | エラーメッセージ表示 |
| PR が未マージ | 例外をスロー | なし | 「PR はまだマージされていません」 |
| 保護ブランチ削除試行 | 例外をスロー | なし | 「保護ブランチは削除できません」 |
| ローカルブランチ削除失敗 | 警告表示、継続 | なし | 警告メッセージ表示 |
| リモートブランチ削除失敗 (404) | 警告表示、継続 | 実施 | 「リモートブランチは既に削除済み」 |
| データベース更新失敗 | 例外をスロー | ロールバック | エラーメッセージ表示 |
| イベント発火失敗 | ログ記録、継続 | 実施済み | ログのみ（ユーザーには通知なし） |

#### エラーメッセージ例

```typescript
// PR が見つからない
throw new PRCleanupError('PR が作成されていません。先に /cft:spec-phase <spec-id> completed を実行してください。');

// PR が未マージ
throw new PRCleanupError(`PR #${prNumber} はまだマージされていません。GitHub でマージを完了してから再実行してください。`);

// 保護ブランチ削除試行
throw new BranchProtectionError(`保護ブランチは削除できません: ${branchName}`);

// ローカルブランチ削除失敗
console.warn(`ローカルブランチの削除に失敗しました: ${branchName}. 手動で削除してください。`);

// リモートブランチ削除失敗 (404)
console.warn(`リモートブランチは既に削除済みです: ${branchName}`);
```
---

## 8. 実装タスクリスト

### データベース層

- [ ] **マイグレーション 009_add_pr_merged_at.ts を作成**
  - `github_sync` テーブルに `pr_merged_at` カラムを追加
  - 既存のマイグレーション形式に従う
  - パス: `src/core/database/migrations/009_add_pr_merged_at.ts`

- [ ] **データベース更新ヘルパー関数を追加**
  - `clearSpecBranchName(specId: string)` を実装
  - `updatePrMergedStatus(prNumber: number)` を実装
  - パス: `src/core/database/helpers.ts`

### Git 操作層

- [ ] **Git ブランチ削除モジュールを実装**
  - `deleteLocalBranch(branchName: string)` を実装
  - `deleteRemoteBranch(branchName: string)` を実装
  - 保護ブランチチェックを統合
  - エラーハンドリング（警告表示、継続処理）
  - パス: `src/core/workflow/branch-cleanup.ts`

### GitHub 統合層

- [ ] **PR マージ検知モジュールを実装**
  - `checkPullRequestMerged(prNumber: number)` を実装
  - `cleanupMergedPullRequest(specId: string)` を実装
  - エラーハンドリング（PR 未マージ、404 エラー等）
  - パス: `src/integrations/github/pr-cleanup.ts`

### イベント層

- [ ] **イベントハンドラー登録を追加**
  - `spec.pr_merged` イベント発火処理を実装
  - `src/core/workflow/github-integration.ts` にハンドラー登録
  - non-blocking 実行を確保

### ユーザーインターフェース層

- [ ] **スラッシュコマンド /cft:pr-cleanup を作成**
  - 引数: `<spec-id>`
  - `pr-cleanup.ts` を呼び出す
  - エラーメッセージの表示
  - パス: `src/slash-commands/pr-cleanup.md`

### テスト層

- [ ] **PR マージ検知モジュールの単体テストを作成**
  - PR マージ状態確認のテスト
  - エラーハンドリングのテスト
  - パス: `tests/integrations/github/pr-cleanup.test.ts`

- [ ] **Git ブランチ削除モジュールのテストを作成**
  - ブランチ削除成功のテスト
  - 保護ブランチ削除試行のテスト
  - 存在しないブランチ削除のテスト
  - パス: `tests/core/workflow/branch-cleanup.test.ts`

### 同期とビルド

- [ ] **npm run sync:dogfood でスラッシュコマンドを同期**
  - `.cc-craft-kit/` に同期
  - 動作確認

- [ ] **全テストを実行して品質を確認**
  - `npm test` でテスト実行
  - カバレッジ確認
  - 型チェック (`npx tsc --noEmit`)
---

### 依存関係と優先度

**Phase 1: データベースとインフラ (最優先)**
1. マイグレーション 009_add_pr_merged_at.ts
2. データベース更新ヘルパー関数

**Phase 2: コア機能実装**
3. Git ブランチ削除モジュール
4. PR マージ検知モジュール
5. イベントハンドラー登録

**Phase 3: ユーザーインターフェース**
6. スラッシュコマンド /cft:pr-cleanup

**Phase 4: テストと検証**
7. 単体テスト作成
8. 同期とビルド
9. 全テスト実行
