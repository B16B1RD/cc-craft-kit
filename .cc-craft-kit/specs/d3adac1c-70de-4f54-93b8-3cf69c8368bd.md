# completed 後に PR のマージを報告するフェーズが欲しい

**仕様書 ID:** d3adac1c-70de-4f54-93b8-3cf69c8368bd
**フェーズ:** design
**作成日時:** 2025/11/23 17:28:38
**更新日時:** 2025/11/23 17:44:44

---

## 1. 背景と目的

### 背景

現在、cc-craft-kit では PR を `completed` フェーズで自動作成するが、PR がマージされた後の後処理が手動になっている。

- ローカルブランチとリモートブランチが残り続ける
- データベースの `specs.branch_name` カラムにマージ済みブランチ名が残る
- PR マージ後の状態を追跡できない

これにより、開発者が手動でブランチ削除やデータベース更新を行う必要があり、運用コストが増加している。

### 目的

`completed` フェーズの後に PR マージを検知し、以下の後処理を自動化する:

1. PR のマージ状態を GitHub API で確認
2. マージ済みブランチをローカル・リモート両方から削除
3. データベースの `specs.branch_name` をクリア
4. マージ完了イベントを発火(将来的な拡張性)

---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `completed` フェーズで作成された PR のマージ状態を GitHub API で取得できる
- [ ] PR がマージされた場合、ローカルブランチとリモートブランチを削除できる
- [ ] データベースの `specs.branch_name` カラムをクリア(NULL に更新)できる

### 機能要件

- [ ] PR マージ検知機能の実装(GitHub API `/repos/{owner}/{repo}/pulls/{pull_number}` の `merged` フィールドを確認)
- [ ] ローカルブランチ削除機能の実装(`git branch -D <branch-name>`)
- [ ] リモートブランチ削除機能の実装(`git push origin --delete <branch-name>`)
- [ ] データベース更新機能の実装(`UPDATE specs SET branch_name = NULL WHERE id = ?`)
- [ ] 処理完了後に `spec.pr_merged` イベントを発火
- [ ] エラーハンドリング(ブランチ削除失敗時の警告表示など)

### 非機能要件

- [ ] GitHub API のレート制限を考慮した実装
- [ ] 処理失敗時のロールバック戦略(ブランチ削除失敗時はデータベース更新をスキップ)
- [ ] 安全性: 保護ブランチ(main/develop)は削除しない

---

## 4. 制約条件

### 技術的制約

1. **GitHub API**
   - Octokit(REST API)を使用
   - レート制限対応が必須
   - `GITHUB_TOKEN` 環境変数で認証

2. **データベース操作**
   - `getDatabase()` を使用(複数インスタンス化禁止)
   - Kysely のパラメータ化クエリのみ使用

3. **Git 操作**
   - `execSync` を使用してブランチ削除
   - 保護ブランチ(main/develop)の削除禁止
   - エラーハンドリング必須

4. **イベント駆動**
   - `spec.pr_merged` イベント発火(将来的な拡張性)
   - non-blocking 実行

### セキュリティ制約

- API キーをコードに直接記述しない
- Git 操作のモック化(テスト実行時)

---

## 5. 依存関係

### 関連モジュール

- **GitHub 統合モジュール**
  - `GitHubClient` (REST API)
  - `GitHubSyncService` (同期ステータス管理)

- **Git 操作モジュール**
  - `branch-guard.ts` (保護ブランチ判定)

- **データベース**
  - `specs` テーブル(`branch_name` カラム)
  - `github_sync` テーブル(`pr_number` カラム)

- **イベントバス**
  - `EventBus` (`spec.pr_merged` イベント発火)

### データフロー

```
PR マージ検知トリガー(手動コマンドまたは自動)
  ↓
GitHub API で PR マージ状態を確認
  ↓
マージ済みの場合
  ├─ ローカルブランチ削除
  ├─ リモートブランチ削除
  ├─ データベース更新(specs.branch_name = NULL)
  └─ spec.pr_merged イベント発火
```

---

## 6. 参考情報

### 既存の実装

- PR 作成機能: `/home/autum/Projects/personal/cc-craft-kit/src/integrations/github/pull-request.ts`
- ブランチ管理: `/home/autum/Projects/personal/cc-craft-kit/src/core/workflow/branch-management.ts`
- フェーズ遷移: `/home/autum/Projects/personal/cc-craft-kit/src/commands/spec/phase.ts`

### GitHub API ドキュメント

- [Get a pull request](https://docs.github.com/en/rest/pulls/pulls#get-a-pull-request)
- [Delete a reference](https://docs.github.com/en/rest/git/refs#delete-a-reference)

### データベーススキーマ

- マイグレーション 004: `004_add_pr_support.ts` (PR フィールド追加)
- マイグレーション 006: `006_add_branch_name_to_specs.ts` (ブランチ名カラム追加)
