# implementation フェーズのテスト処理中に勝手にブランチが作成され切り替わる

**仕様書 ID:** d062a0fd-6ef6-469d-9000-00aaa7d8f750
**フェーズ:** completed
**作成日時:** 2025/11/22 11:22:58
**更新日時:** 2025/11/22 11:36:46

---

## 1. 背景と目的

### 背景

**発生状況:**

- `npm test` 実行時に、テストコード内で `createSpecBranch()` が実際に呼び出され、新しいブランチが作成される
- テスト実行前は `develop` ブランチだったが、実行後に `spec/12345678` ブランチに切り替わってしまう
- 特に E2E テスト（`tests/e2e/**/*.test.ts`）で頻発している

**問題の影響:**

1. **開発者の作業効率低下**: テスト実行のたびに元のブランチに戻る必要がある
2. **CI/CD の不安定化**: GitHub Actions 上でブランチ状態が変わり、後続のステップが失敗する
3. **Git 履歴の汚染**: 不要なブランチが大量に作成され、`git branch` の出力が見づらくなる
4. **テストの独立性喪失**: テスト間でブランチ状態が干渉し、テスト結果が不安定になる

**根本原因の仮説:**

- `createSpecBranch()` 関数がモック化されておらず、実際の Git 操作が実行されている
- テストクリーンアップ処理（`afterEach`, `afterAll`）でブランチを元に戻す処理が不足している
- `test-generator` サブエージェントが Git 操作を含むテストを生成する際、自動的にモックを追加していない

### 目的

テスト実行時に意図しないブランチ作成・切り替えが発生する問題を根本的に解決し、以下を実現する。

1. **テストの独立性確保**: テスト実行が Git リポジトリの状態に影響を与えないこと
2. **既存テストの修正**: 問題のあるテストコードを特定し、適切にモック化すること
3. **再発防止**: テスト生成時のガイドライン・サブエージェント設定を改善すること
4. **CI/CD 環境の安定化**: 自動テスト実行時にブランチ状態が不安定になる問題を解消すること

---

## 2. 対象ユーザー

### プライマリユーザー

- **cc-craft-kit の開発者**: テスト実行時に Git 状態が勝手に変更されることで、作業中のブランチを見失う問題を解決
- **CI/CD 環境の運用者**: 自動テスト実行時のブランチ状態の不安定さを解消し、信頼性の高いパイプラインを実現

### セカンダリユーザー

- **cc-craft-kit の利用者**: 将来的に配布されるパッケージのテスト品質が向上し、バグの少ない安定版を利用可能
- **新規コントリビューター**: テストコードのベストプラクティスが明確化され、初回の貢献時に迷わない

---

## 3. 受け入れ基準

### 必須要件

- [ ] 既存の全テストファイル（`tests/**/*.test.ts`）を調査し、`createSpecBranch()` または `git checkout -b` を直接呼び出している箇所を特定する
- [ ] 特定された問題箇所をすべてモック化し、実際の Git 操作を行わないように修正する
- [ ] `npm test` 実行前後で Git ブランチが変更されないことを確認する（自動化テスト）
- [ ] CI/CD パイプライン上でテスト実行が安定することを確認する（3 回連続成功）

### 機能要件

- [ ] テストコードの問題パターンを 3 種類以上特定する
  - 例: `createSpecBranch()` の直接呼び出し、モックなしの Git コマンド実行、テスト後のクリーンアップ不足
- [ ] `test-generator` サブエージェントの設定を更新し、Git 操作を含むテスト生成時に自動的にモックを使用するようにする
- [ ] テスト実行前後のブランチ状態を検証する E2E テストを追加する
- [ ] 修正後のテストで、`git status` の出力に変更がないことを確認する自動チェックを追加する

### 非機能要件

- [ ] テスト実行時間が修正前と比較して 10% 以上増加しないこと
- [ ] すべてのテストが並列実行可能であること（Git 状態に依存しない）
- [ ] テストコードの可読性が低下しないこと（モック化によるコード複雑化を最小限に）
- [ ] ドキュメント（CLAUDE.md）にテスト作成時の注意事項を追記する

---

## 4. 制約条件

### 技術的制約

- **既存テストの互換性**: 修正後もテストの意図（ブランチ作成ロジックの検証）は維持すること
- **モックライブラリの選定**: Vitest の標準モック機能を使用し、新規依存関係を追加しないこと
- **型安全性**: モック化後も TypeScript の型チェックを通過すること

### 作業範囲の制約

- **対象ファイル**: `tests/` ディレクトリ配下のみ（`src/` の実装コードは変更しない）
- **実装期間**: 2 日以内に完了すること（緊急度: 高）
- **破壊的変更の禁止**: テスト実行コマンド（`npm test`）は変更しないこと

### 環境制約

- **Git バージョン**: Git 2.30 以降を想定（`git branch --show-current` コマンドを使用）
- **Node.js バージョン**: 18.x 以降（プロジェクトの要件に準拠）

---

## 5. 依存関係

### 依存する仕様・コンポーネント

- **`src/core/git/branch-creation.ts`**: `createSpecBranch()` 関数の実装（モック対象）
- **`src/core/git/branch-cache.ts`**: `getCurrentBranch()`, `clearBranchCache()` 関数（モック対象）
- **Vitest モック機能**: `vi.mock()`, `vi.spyOn()` を使用したモック化
- **`test-generator` サブエージェント**: テスト生成時のモック自動追加ロジック

### ブロッカー

- なし（独立して実装可能）

### この仕様完了後に影響を受ける項目

- **新規テストの作成**: `/cft:test-generate` 実行時に、Git 操作を含むテストが自動的にモック化される
- **CI/CD パイプライン**: GitHub Actions でのテスト実行が安定化する
- **ドキュメント**: CLAUDE.md にテスト作成時のガイドラインが追記される

---

## 6. 参考情報

### 関連ドキュメント

- **CLAUDE.md**: テスト戦略セクション（単体テスト、E2E テスト）
- **`.claude/agents/test-generator.md`**: テスト自動生成サブエージェントの設定
- **`src/core/git/branch-creation.ts`**: ブランチ作成ロジックの実装

### 問題の再現手順

```bash
# 1. 現在のブランチを確認
git branch --show-current  # 例: develop

# 2. テスト実行
npm test

# 3. ブランチが変更されていることを確認（問題）
git branch --show-current  # 例: spec/12345678
```

### 関連 Issue・PR

- GitHub Issue #269: https://github.com/B16B1RD/cc-craft-kit/issues/269

### 技術的参考資料

- [Vitest - Mocking Functions](https://vitest.dev/guide/mocking.html)
- [Vitest - Mocking Modules](https://vitest.dev/guide/mocking.html#modules)
- [Git - Branch Management Best Practices](https://git-scm.com/book/en/v2/Git-Branching-Branching-Workflows)

---

## 7. 設計方針

### 修正対象ファイルの特定方法

1. **Grep による検索**: `createSpecBranch` または `git checkout -b` を含むファイルを検索
2. **手動レビュー**: 検索結果から、実際に Git 操作を実行している箇所を特定

### モック化の設計

**パターン 1: `createSpecBranch()` のモック化**

```typescript
import { vi } from 'vitest';
import * as branchCreation from '../../src/core/git/branch-creation.js';

// テストファイルの先頭でモック化
vi.mock('../../src/core/git/branch-creation.js', () => ({
  createSpecBranch: vi.fn(() => ({
    created: true,
    branchName: 'spec/12345678',
    originalBranch: 'develop',
  })),
}));

// テスト内での動作確認
expect(branchCreation.createSpecBranch).toHaveBeenCalledWith('spec-id-123');
```

**パターン 2: `execSync` のスパイ化**

```typescript
import { vi } from 'vitest';
import { execSync } from 'child_process';

// execSync をスパイ化（実行せずに監視のみ）
const execSyncSpy = vi.spyOn(childProcess, 'execSync').mockImplementation(() => Buffer.from(''));

// テスト実行後、実際の Git コマンドが呼ばれていないことを確認
expect(execSyncSpy).not.toHaveBeenCalledWith(expect.stringContaining('git checkout -b'));
```

### テストクリーンアップの設計

```typescript
describe('仕様書作成テスト', () => {
  let originalBranch: string;

  beforeEach(() => {
    // テスト開始前のブランチを記録
    originalBranch = execSync('git branch --show-current', { encoding: 'utf8' }).trim();
  });

  afterEach(() => {
    // テスト終了後、元のブランチに戻す（モック化後は不要）
    if (execSync('git branch --show-current', { encoding: 'utf8' }).trim() !== originalBranch) {
      execSync(`git checkout ${originalBranch}`);
    }
  });

  // テスト本体
});
```

### `test-generator` サブエージェントの改善

**追加する指示（`.claude/agents/test-generator.md`）:**

テスト対象のコードが以下を含む場合、自動的にモックを追加すること。

- `createSpecBranch()` 関数の呼び出し
- `execSync()` による Git コマンド実行
- ファイルシステム操作（`writeFileSync`, `unlinkSync`）

**モックのテンプレート:**

```typescript
import { vi } from 'vitest';

vi.mock('../../src/core/git/branch-creation.js', () => ({
  createSpecBranch: vi.fn(() => ({
    created: true,
    branchName: 'spec/mock-branch',
    originalBranch: 'develop',
  })),
}));
```

---

## 8. 実装タスクリスト

### タスク 1: 既存テストファイルから問題箇所を特定する

**目的**: `tests/**/*.test.ts` から `createSpecBranch()` または `git checkout -b` を直接呼び出している箇所を特定する

**作業内容**:
1. Grep ツールで `createSpecBranch` を検索
2. Grep ツールで `git checkout -b` を検索
3. 検索結果を分析し、問題パターンを分類する（3 種類以上）
4. 修正対象ファイルのリストを作成

**受け入れ基準**:
- [ ] すべての問題箇所が特定されている
- [ ] 問題パターンが 3 種類以上分類されている
- [ ] 修正対象ファイルリストが作成されている

### タスク 2: 特定された問題箇所をモック化する

**目的**: 実際の Git 操作を行わないようにテストコードを修正する

**作業内容**:
1. `createSpecBranch()` のモック化パターンを適用
2. `execSync()` のスパイ化パターンを適用
3. テストクリーンアップ処理を追加（必要に応じて）
4. 型安全性を確認（TypeScript 型チェック通過）

**受け入れ基準**:
- [ ] すべての問題箇所がモック化されている
- [ ] テストが正常に実行される（`npm test` 成功）
- [ ] TypeScript 型チェックが通過する（`npx tsc --noEmit`）

### タスク 3: ブランチ変更検証テストを追加

**目的**: テスト実行前後でブランチが変更されないことを自動的に検証する

**作業内容**:
1. `tests/e2e/test-branch-stability.test.ts` を作成
2. テスト実行前のブランチを記録
3. すべてのテストを実行
4. テスト実行後のブランチを確認
5. ブランチが変更されていないことをアサート

**受け入れ基準**:
- [ ] ブランチ変更検証テストが追加されている
- [ ] テストが正常に実行される
- [ ] `git status` の出力に変更がないことを確認

### タスク 4: test-generator サブエージェントの設定を更新

**目的**: Git 操作を含むテスト生成時に自動的にモックを追加する

**作業内容**:
1. `.claude/agents/test-generator.md` を編集
2. Git 操作の自動モック化ルールを追加
3. モックのテンプレートを追加
4. ファイルシステム操作のモック化ルールを追加

**受け入れ基準**:
- [ ] test-generator の設定が更新されている
- [ ] Git 操作を含むテスト生成時に自動的にモックが追加される
- [ ] 生成されたテストが正常に実行される

### タスク 5: CLAUDE.md にテスト作成時の注意事項を追記

**目的**: 今後のテスト作成時に同様の問題が発生しないようにドキュメント化する

**作業内容**:
1. CLAUDE.md のテスト戦略セクションを確認
2. Git 操作を含むテストの注意事項を追記
3. モック化のベストプラクティスを記載
4. 参考コード例を追加

**受け入れ基準**:
- [ ] CLAUDE.md が更新されている
- [ ] Git 操作のモック化に関する注意事項が記載されている
- [ ] 参考コード例が含まれている

### タスク 6: 最終検証（npm test でブランチが変更されないこと）

**目的**: すべての修正が完了し、テスト実行前後でブランチが変更されないことを確認する

**作業内容**:
1. 現在のブランチを記録
2. `npm test` を実行
3. テスト実行後のブランチを確認
4. テスト実行時間を計測（修正前と比較して 10% 以内）

**受け入れ基準**:
- [ ] `npm test` 実行前後でブランチが変更されない
- [ ] すべてのテストが成功する
- [ ] テスト実行時間が修正前と比較して 10% 以上増加していない

### タスク 7: CI/CD パイプラインでの安定性確認

**目的**: GitHub Actions 上でテスト実行が安定することを確認する

**作業内容**:
1. GitHub Actions でテストを 3 回実行
2. すべて成功することを確認
3. ブランチ状態が不安定にならないことを確認
4. 後続のステップが失敗しないことを確認

**受け入れ基準**:
- [ ] GitHub Actions で 3 回連続成功
- [ ] ブランチ状態が安定している
- [ ] 後続のステップが正常に実行される
