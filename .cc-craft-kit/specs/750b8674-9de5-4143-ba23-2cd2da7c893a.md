---
id: "750b8674-9de5-4143-ba23-2cd2da7c893a"
name: "completed フェーズで仕様書のフェーズを completed に変更している"
phase: "implementation"
branch_name: "fix/spec-750b8674-completed-phase-timing"
github_issue_number: null
created_at: "2025-12-06T12:00:00+09:00"
updated_at: "2025-12-06T12:20:00+09:00"
---

# completed フェーズで仕様書のフェーズを completed に変更している

## 1. 背景と目的

### 背景

completed フェーズは、PR マージ後に実行されるので、仕様書は review フェーズの PR 作成前に completed にフェーズ変更しておくべきである。

現在の実装では、`/cft:spec phase <id> completed` を実行すると、以下の問題が発生する:

1. completed フェーズで仕様書の `phase` を `completed` に変更してコミット
2. その後、develop ブランチに切り替え
3. 作業ブランチを削除

この順序では、作業ブランチで行った `phase: completed` への変更が develop ブランチに反映されない（PR がまだマージされていないため）。

### 目的

- completed フェーズの「ケース B: PR がマージされていない、または PR がない場合」の処理を修正する
- 作業ブランチでコミットした変更が develop に反映されるよう、処理フローを見直す

---

## 2. 対象ユーザー

- cc-craft-kit を使用して仕様駆動開発を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] completed フェーズ実行後、develop ブランチで仕様書が `phase: completed` になっていること

### 機能要件

- [ ] ケース B（PR 未マージ/PR なし）で、作業ブランチの変更を develop にマージしてから完了処理を行う

### 非機能要件

- [ ] 既存の仕様書の整合性を壊さないこと
- [ ] ケース A（PR マージ済み）の処理は変更しないこと

---

## 4. 制約条件

- スラッシュコマンド（.md ファイル）のみで実装すること
- TypeScript/npm は使用しないこと

---

## 5. 依存関係

- `.claude/commands/cft/spec.md` の `phase` サブコマンド

---

## 6. 参考情報

- 関連ファイル: `.claude/commands/cft/spec.md`

---

## 7. 設計詳細

### 7.1 問題の根本原因

現在のケース B の処理フロー:

```
1. 作業ブランチで phase: completed に変更してコミット
2. develop に切り替え
3. 作業ブランチを削除
```

この処理では、作業ブランチのコミットが develop にマージされないため、仕様書の `phase: completed` への変更が失われる。

### 7.2 解決アプローチ

ケース B の処理フローを以下のように修正:

```
1. 作業ブランチで phase: completed に変更してコミット
2. develop に切り替え・最新化
3. 作業ブランチを develop にマージ（--no-ff オプションなし）
4. develop をプッシュ
5. 作業ブランチを削除
```

### 7.3 修正後のケース B フロー

```markdown
#### ケース B: PR がマージされていない、または PR がない場合

1. **まず仕様書ファイルの変更をコミット**:
   ```bash
   git add ".cc-craft-kit/specs/$SPEC_ID.md"
   git commit -m "feat: $SPEC_NAME を完了"
   ```

2. **ベースブランチに切り替え・最新化**:
   ```bash
   git checkout develop
   git pull origin develop
   ```

3. **作業ブランチを develop にマージ**:
   ```bash
   git merge "$BRANCH_NAME"
   ```

4. **develop をプッシュ**:
   ```bash
   git push origin develop
   ```

5. **ローカル作業ブランチを削除**:
   ```bash
   git branch -D "$BRANCH_NAME"
   ```

6. **GitHub Issue がある場合はクローズ**:
   ```bash
   gh issue close $GITHUB_ISSUE_NUMBER --comment "✅ 仕様書が完了しました"
   ```
```

### 7.4 考慮事項

- **マージコンフリクト**: develop との差分が大きい場合、コンフリクトが発生する可能性がある。その場合はユーザーに手動解決を促す。
- **PR なしでのマージ**: ケース B は PR がない/未マージの場合なので、直接マージは許容される。正式な変更は PR 経由で行うべきだが、仕様書のフェーズ変更のみであれば影響は限定的。

---

## 8. タスクリスト

- [ ] `.claude/commands/cft/spec.md` のケース B セクションを修正
  - [ ] ステップ 2 の後に「作業ブランチを develop にマージ」を追加
  - [ ] ステップ 3 の後に「develop をプッシュ」を追加
  - [ ] コンフリクト発生時のエラーハンドリングを追加
