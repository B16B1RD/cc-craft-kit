---
id: "750b8674-9de5-4143-ba23-2cd2da7c893a"
name: "completed フェーズで仕様書のフェーズを completed に変更している"
phase: "completed"
branch_name: "fix/spec-750b8674-completed-phase-timing"
github_issue_number: null
created_at: "2025-12-06T12:00:00+09:00"
updated_at: "2025-12-06T12:40:00+09:00"
---

# completed フェーズで仕様書のフェーズを completed に変更している

## 1. 背景と目的

### 背景

completed フェーズは、PR マージ後に実行されるので、仕様書は review フェーズの PR 作成前に completed にフェーズ変更しておくべきである。

現在の実装では、`/cft:spec phase <id> completed` を実行すると、以下の問題が発生する:

1. completed フェーズで仕様書の `phase` を `completed` に変更してコミット
2. その後、develop ブランチに切り替え
3. 作業ブランチを削除

この順序では、作業ブランチで行った `phase: completed` への変更が develop ブランチに反映されない（PR がまだマージされていないため）。

### 目的

- completed フェーズの「ケース B: PR がマージされていない、または PR がない場合」の処理を修正する
- 作業ブランチでコミットした変更が develop に反映されるよう、処理フローを見直す

---

## 2. 対象ユーザー

- cc-craft-kit を使用して仕様駆動開発を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] completed フェーズ実行後、develop ブランチで仕様書が `phase: completed` になっていること

### 機能要件

- [ ] ケース B（PR 未マージ/PR なし）で、作業ブランチの変更を develop にマージしてから完了処理を行う

### 非機能要件

- [ ] 既存の仕様書の整合性を壊さないこと
- [ ] ケース A（PR マージ済み）の処理は変更しないこと

---

## 4. 制約条件

- スラッシュコマンド（.md ファイル）のみで実装すること
- TypeScript/npm は使用しないこと

---

## 5. 依存関係

- `.claude/commands/cft/spec.md` の `phase` サブコマンド

---

## 6. 参考情報

- 関連ファイル: `.claude/commands/cft/spec.md`
- PR: https://github.com/B16B1RD/cc-craft-kit/pull/949

---

## 7. 設計詳細

### 7.1 問題の根本原因

現在のケース B の処理フロー:

```
1. 作業ブランチで phase: completed に変更してコミット
2. develop に切り替え
3. 作業ブランチを削除
```

この処理では、作業ブランチのコミットが develop にマージされないため、仕様書の `phase: completed` への変更が失われる。

### 7.2 解決アプローチ

**review フェーズで PR 作成前に `phase: completed` に更新する**

これにより、PR がマージされた時点で develop には `phase: completed` の仕様書が含まれる。
completed フェーズは PR マージ後のクリーンアップ処理（ブランチ削除、Issue クローズ）のみを行う。

### 7.3 修正後のフロー

**review フェーズ:**
1. 品質チェック
2. **仕様書のフェーズを completed に更新してコミット**
3. PR 作成

**completed フェーズ:**
1. develop に切り替え・最新化
2. 作業ブランチを削除
3. GitHub Issue をクローズ

### 7.4 考慮事項

- review フェーズで仕様書を completed に更新することで、PR マージ後に再度 completed フェーズを実行してフェーズ変更する必要がなくなる
- completed フェーズはクリーンアップ処理のみなので、シンプルになる

---

## 8. タスクリスト

- [x] `.claude/commands/cft/spec.md` を修正
  - [x] review フェーズで仕様書を completed に更新する処理を追加
  - [x] completed フェーズをクリーンアップ処理のみに簡略化
  - [x] 不要になったケース A/B の分岐を削除
