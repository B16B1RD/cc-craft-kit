---
id: "112bb02d-42c2-4943-9f22-75b3c6c4e733"
name: "/cft:spec-create をどのブランチにいても中断することなく実行できるようにする"
phase: "completed"
branch_name: "develop"
github_issue_number: null
pr_url: null
created_at: "2025-12-01T08:57:13.060Z"
updated_at: "2025-12-02T20:13:00Z"
---

# /cft:spec-create をどのブランチにいても中断することなく実行できるようにする


## 1. 背景と目的

### 背景

現在の `/cft:spec-create` コマンドは、Step 4.6「実行元ブランチの確認と警告」において、ベースブランチ（通常は `develop`）以外のブランチから実行した場合、`AskUserQuestion` ツールでユーザーに確認を求める。ユーザーが「中断」を選択すると、処理が完全に停止し、手動でベースブランチに切り替えてから再実行する必要がある。

この設計は、作業ブランチがベースブランチから正しく派生することを保証するための安全策だが、以下の問題がある：

- CI/CD パイプラインやスクリプトからの自動実行が困難
- 別の仕様書で作業中に新しい仕様書を作成する際、毎回ブランチ切り替えが必要
- 元のブランチに自動復帰するため、実質的に「中断」の必要性が低い

### 目的

`/cft:spec-create` コマンドを、どのブランチからでも中断することなく実行できるようにする。警告メッセージは維持しつつ、ユーザー確認（`AskUserQuestion`）を廃止し、処理を自動続行する。最終的に Step 10 で元のブランチに復帰するため、ユーザーの作業状態は保持される。
---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者。特に以下のユースケースを持つ開発者：

- 別の仕様書で作業中に、新しいアイデアや課題を仕様書として記録したい
- CI/CD パイプラインから仕様書を自動作成したい
- 作業フローを中断せずに仕様書を作成したい
---

## 3. 受け入れ基準

### 必須要件

- [ ] ベースブランチ以外から `/cft:spec-create` を実行しても、処理が中断しないこと
- [ ] 処理完了後、元のブランチ（`ORIGINAL_BRANCH`）に自動復帰すること
- [ ] 新規作成された仕様書ブランチは、常にベースブランチ（`BASE_BRANCH`）から派生すること

### 機能要件

- [ ] ベースブランチ以外からの実行時、警告メッセージを表示すること（情報提供のみ）
- [ ] `AskUserQuestion` によるユーザー確認を廃止すること
- [ ] 警告後、自動的に Step 5 へ進むこと
- [ ] Step 10 で確実に元ブランチに復帰すること

### 非機能要件

- [ ] 処理全体の実行時間に大きな影響を与えないこと
- [ ] 既存のテストケースが引き続きパスすること
- [ ] ドキュメント（エラーハンドリングまとめ）が更新されていること
---

## 4. 制約条件

- **プロンプトファースト原則**: 本修正はプロンプト（`.md`ファイル）のみで実現可能。スクリプト（`.ts`）の変更は不要。
- **変更対象ファイル**: `src/slash-commands/spec-create.md` の Step 4.6 セクションのみ
- **Git ブランチ**: 新規仕様書ブランチは常に `BASE_BRANCH` から派生する（現行動作を維持）
- **警告メッセージ**: 廃止ではなく、ユーザー確認を廃止。情報提供としての警告は維持。
---

## 5. 依存関係

### 関連ファイル

| ファイル | 役割 | 修正必要 |
|---------|------|---------|
| `src/slash-commands/spec-create.md` | `/cft:spec-create` コマンド定義 | ✓ 要修正 |
| `.cc-craft-kit/slash-commands/spec-create.md` | 自動生成版（同期管理） | 自動同期 |
| `tests/slash-commands/spec-create.test.ts` | テストケース | 確認必要 |

### 関連コンポーネント

- `src/core/git/branch-cache.ts`: 現在のブランチ名取得
- `src/commands/spec/register.ts`: DB 登録処理
---

## 6. 参考情報

- [Step 4.6 の現在実装](src/slash-commands/spec-create.md) - Line 109-158
- コミット `e4af508`: 実行元ブランチ警告・自動コミット追加
- 類似実装: `src/slash-commands/session-start.md`（セッション管理パターン）
---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
ユーザー実行: /cft:spec-create "<name>"
    ↓
┌──────────────────────────────────────────────────────┐
│ spec-create.md プロンプト                              │
├──────────────────────────────────────────────────────┤
│ Step 1-4: 前処理                                      │
│   └─ UUID 生成、ブランチ名判定、BASE_BRANCH 取得        │
│                                                       │
│ Step 4.6: ブランチ確認 ← 修正対象                      │
│   現在: AskUserQuestion で確認                         │
│   修正後: 警告表示のみで自動続行                        │
│                                                       │
│ Step 5-9: メイン処理                                  │
│   └─ ブランチ作成、仕様書作成、DB 登録、コミット          │
│                                                       │
│ Step 10: 後処理                                       │
│   └─ 元ブランチ（ORIGINAL_BRANCH）に自動復帰            │
└──────────────────────────────────────────────────────┘
```

#### 設計方針

- **プロンプトファースト原則**: `.md` ファイルの修正のみで完結
- **既存フロー維持**: Step 4.6 以外の処理フローは変更なし
- **後方互換性**: 新規ブランチは常に `BASE_BRANCH` から派生（現行動作維持）

#### 処理フロー詳細

**修正前（現在の実装）:**

```
Step 4.6 開始
    ↓
ORIGINAL_BRANCH == BASE_BRANCH?
    ├─ Yes → Step 5 へ
    └─ No  → AskUserQuestion ツール
                ├─ 「このまま続行」 → Step 5 へ
                └─ 「中断」 → 処理停止、手動でブランチ切替必要
```

**修正後:**

```
Step 4.6 開始
    ↓
ORIGINAL_BRANCH == BASE_BRANCH?
    ├─ Yes → 「ベースブランチから実行しています」表示 → Step 5 へ
    └─ No  → 警告メッセージ表示（情報提供のみ）→ Step 5 へ
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/slash-commands/spec-create.md` | Step 4.6 セクションの `AskUserQuestion` 削除、警告メッセージ形式変更 |
| `tests/slash-commands/spec-create.test.ts` | Step 4.6 の新仕様検証テスト追加 |

#### Step 4.6 修正内容

**削除:**
- `AskUserQuestion` ツールの呼び出し
- 「中断」選択時のエラーハンドリング

**追加:**
- 警告メッセージ（情報提供のみ）
- 自動続行の案内テキスト

**維持:**
- `ORIGINAL_BRANCH` の取得・保存ロジック
- `BASE_BRANCH` からのブランチ派生ロジック

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| ブランチ確認 | `AskUserQuestion` で確認 | 警告表示のみ | Step 4.6 |
| ユーザー選択 | 「続行」/「中断」 | なし（自動続行） | Step 4.6 |
| 中断処理 | エラーメッセージ表示 | 削除 | Step 4.6 |
| 警告表示 | 質問形式 | 情報提供形式 | Step 4.6 |
| エラーハンドリングテーブル | 「中断を選択」エントリあり | 削除 | エラーハンドリングまとめ |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| Step 4.6 存在確認 | セクションが存在すること | 文字列検索 |
| AskUserQuestion 廃止 | Step 4.6 に `AskUserQuestion` が含まれないこと | 否定検索 |
| 警告メッセージ | 警告メッセージが含まれること | 文字列検索 |
| 自動続行 | 「自動続行」または「Step 5 へ」が含まれること | 文字列検索 |
| エラーテーブル更新 | 「中断を選択」エントリが削除されていること | 否定検索 |

### 7.5 移行計画

#### Phase 1: Step 4.6 修正

1. `src/slash-commands/spec-create.md` の Step 4.6 セクションを修正
2. `AskUserQuestion` ブロックを削除
3. 警告メッセージを情報提供形式に変更
4. エラーハンドリングまとめテーブルを更新

#### Phase 2: テスト追加・検証

1. `tests/slash-commands/spec-create.test.ts` にテストケース追加
2. テスト実行・確認
3. `npm run sync:dogfood` で同期確認
---

## 8. 実装タスクリスト

### Phase 1: Step 4.6 修正

- [x] Step 4.6 の `AskUserQuestion` ブロックを削除し、警告メッセージのみに変更 (#502)
- [x] エラーハンドリングまとめテーブルから「中断を選択」エントリを削除 (#503)

### Phase 2: テスト追加・検証

- [x] テストケース追加: Step 4.6 に `AskUserQuestion` が含まれないこと (#504)
- [x] テストケース追加: 警告メッセージが情報提供形式であること (#505)
- [x] `npm run sync:dogfood` で同期確認 (#506)
- [x] `npm test` でテスト実行・確認 (#507)
---

## Pull Request

- https://github.com/B16B1RD/cc-craft-kit/pull/508
