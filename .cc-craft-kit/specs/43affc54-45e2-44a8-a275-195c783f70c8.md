# GitHub Sub Issue の連携ができていない

**仕様書 ID:** 43affc54-45e2-44a8-a275-195c783f70c8
**フェーズ:** requirements
**作成日時:** 2025/11/30 12:00:00
**更新日時:** 2025/11/30 12:00:00

---

## 1. 背景と目的

### 背景

Sub Issue を作成した後、その Sub Issue と親 Issue が放置されている。進捗に合わせた更新がされていない。処理が終了してもクローズされていない。など多々問題がある。Issue #420 - #429 がそれ。

コードベース調査により、以下の問題が判明した:

1. **メタデータ管理の不完全性**: `github_sync` テーブルで Sub Issue の `github_id` に `owner/repo` を保存しており、本来の Issue ID が記録されていない
2. **親 Issue との関連性追跡機能なし**: Sub Issue から親 Issue への逆引きが困難
3. **イベントチェーンの断絶**: `task.completed` イベントで taskId が null の場合、Sub Issue が放置される
4. **親 Issue の自動クローズ機能なし**: 子 Issue がすべて完了しても、親 Issue は自動クローズされない
5. **進捗追跡機能の欠落**: Sub Issue の生成～更新～クローズの全フェーズで可視性が低い

### 目的

GitHub Sub Issue と親 Issue のライフサイクル全体を適切に管理し、仕様書の進捗に合わせて Issue が自動更新・クローズされるようにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] Sub Issue 作成時に親 Issue との関連性が正しく DB に記録される
- [ ] タスク完了時に対応する Sub Issue が自動的にクローズされる
- [ ] すべての Sub Issue がクローズされたら親 Issue も自動的にクローズされる
- [ ] 既存の Issue #420-429 の問題が解消される

### 機能要件

- [ ] `github_sync` テーブルに `parent_issue_number` と `parent_spec_id` カラムを追加
- [ ] Sub Issue 作成時に `github_id` に正しい Issue ID を保存
- [ ] `task.completed` イベントハンドラーで taskId が null の場合のリカバリ処理を追加
- [ ] 親 Issue の本文に Sub Issue リストを自動埋め込み
- [ ] Sub Issue のステータス変更時に親 Issue のチェックボックスを同期
- [ ] 親 Issue クローズ前に全 Sub Issue のステータスを確認するバリデーション

### 非機能要件

- [ ] GitHub API レート制限を考慮したバッチ処理の実装
- [ ] Sub Issue 作成・更新時のエラーハンドリングとリトライ機構
- [ ] 部分的な失敗時のロールバック機能

---

## 4. 制約条件

- GitHub API レート制限: Sub Issue 作成時に複数の API 呼び出しが発生するため、バッチ処理が必要
- GraphQL Node ID: Sub Issue の GraphQL Node ID は REST API では取得不可、別途取得処理が必要
- トランザクション非対応: GitHub API は分散トランザクションをサポートしないため、部分的な失敗時の対応が複雑
- イベント駆動の信頼性: Event Bus はメモリ内の実装のため、アプリケーション再起動時にイベント履歴が失われる

---

## 5. 依存関係

### 関連ファイル

| ファイルパス | 役割 |
|---|---|
| `src/integrations/github/sub-issues.ts` | SubIssueManager クラス（主要な修正対象） |
| `src/commands/github/create-sub-issues.ts` | Sub Issue 作成コマンド |
| `src/commands/task/done.ts` | タスク完了コマンド |
| `src/core/workflow/github-integration.ts` | GitHub 統合ハンドラー |
| `src/core/database/schema.ts` | DB スキーマ定義 |

### 関連コンポーネント

- EventBus (`src/core/workflow/event-bus.ts`)
- GitHub Issues API (`src/integrations/github/issues.ts`)
- GitHub Projects API (`src/integrations/github/projects.ts`)
- GitHub Sync Service (`src/integrations/github/sync.ts`)

---

## 6. 参考情報

- Issue #420 - #429: 問題が発生している実例
- 既存の Issue クローズ処理: `src/core/workflow/github-integration.ts` (487-517行)
- Projects ステータス更新パターン: `src/core/workflow/github-integration.ts` (329-426行)
