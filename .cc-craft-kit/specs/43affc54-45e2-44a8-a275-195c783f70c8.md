# GitHub Sub Issue の連携ができていない

**仕様書 ID:** 43affc54-45e2-44a8-a275-195c783f70c8
**フェーズ:** implementation
**作成日時:** 2025/11/30 12:00:00
**更新日時:** 2025/11/30 18:05:00

---

## 1. 背景と目的

### 背景

Sub Issue を作成した後、その Sub Issue と親 Issue が放置されている。進捗に合わせた更新がされていない。処理が終了してもクローズされていない。など多々問題がある。Issue #420 - #429 がそれ。

コードベース調査により、以下の問題が判明した:

1. **メタデータ管理の不完全性**: `github_sync` テーブルで Sub Issue の `github_id` に `owner/repo` を保存しており、本来の Issue ID が記録されていない
2. **親 Issue との関連性追跡機能なし**: Sub Issue から親 Issue への逆引きが困難
3. **イベントチェーンの断絶**: `task.completed` イベントで taskId が null の場合、Sub Issue が放置される
4. **親 Issue の自動クローズ機能なし**: 子 Issue がすべて完了しても、親 Issue は自動クローズされない
5. **進捗追跡機能の欠落**: Sub Issue の生成～更新～クローズの全フェーズで可視性が低い

### 目的

GitHub Sub Issue と親 Issue のライフサイクル全体を適切に管理し、仕様書の進捗に合わせて Issue が自動更新・クローズされるようにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] Sub Issue 作成時に親 Issue との関連性が正しく DB に記録される
- [ ] タスク完了時に対応する Sub Issue が自動的にクローズされる
- [ ] すべての Sub Issue がクローズされたら親 Issue も自動的にクローズされる
- [ ] 既存の Issue #420-429 の問題が解消される

### 機能要件

- [ ] `github_sync` テーブルに `parent_issue_number` と `parent_spec_id` カラムを追加
- [ ] Sub Issue 作成時に `github_id` に正しい Issue ID を保存
- [ ] `task.completed` イベントハンドラーで taskId が null の場合のリカバリ処理を追加
- [ ] 親 Issue の本文に Sub Issue リストを自動埋め込み
- [ ] Sub Issue のステータス変更時に親 Issue のチェックボックスを同期
- [ ] 親 Issue クローズ前に全 Sub Issue のステータスを確認するバリデーション

### 非機能要件

- [ ] GitHub API レート制限を考慮したバッチ処理の実装
- [ ] Sub Issue 作成・更新時のエラーハンドリングとリトライ機構
- [ ] 部分的な失敗時のロールバック機能

---

## 4. 制約条件

- GitHub API レート制限: Sub Issue 作成時に複数の API 呼び出しが発生するため、バッチ処理が必要
- GraphQL Node ID: Sub Issue の GraphQL Node ID は REST API では取得不可、別途取得処理が必要
- トランザクション非対応: GitHub API は分散トランザクションをサポートしないため、部分的な失敗時の対応が複雑
- イベント駆動の信頼性: Event Bus はメモリ内の実装のため、アプリケーション再起動時にイベント履歴が失われる

---

## 5. 依存関係

### 関連ファイル

| ファイルパス | 役割 |
|---|---|
| `src/integrations/github/sub-issues.ts` | SubIssueManager クラス（主要な修正対象） |
| `src/commands/github/create-sub-issues.ts` | Sub Issue 作成コマンド |
| `src/commands/task/done.ts` | タスク完了コマンド |
| `src/core/workflow/github-integration.ts` | GitHub 統合ハンドラー |
| `src/core/database/schema.ts` | DB スキーマ定義 |

### 関連コンポーネント

- EventBus (`src/core/workflow/event-bus.ts`)
- GitHub Issues API (`src/integrations/github/issues.ts`)
- GitHub Projects API (`src/integrations/github/projects.ts`)
- GitHub Sync Service (`src/integrations/github/sync.ts`)

---

## 6. 参考情報

- Issue #420 - #429: 問題が発生している実例
- 既存の Issue クローズ処理: `src/core/workflow/github-integration.ts` (487-517行)
- Projects ステータス更新パターン: `src/core/workflow/github-integration.ts` (329-426行)

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          コマンドレイヤー                                │
├─────────────────────────────────────────────────────────────────────────┤
│  create-sub-issues.ts    task/done.ts                                   │
│         │                     │                                         │
│         ▼                     ▼                                         │
│  SubIssueManager      EventBus.emit('task.completed')                   │
└─────────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        イベント駆動レイヤー                              │
├─────────────────────────────────────────────────────────────────────────┤
│  github-integration.ts                                                  │
│  ├── 'task.completed' ハンドラー                                        │
│  │   ├── Sub Issue ステータス更新（既存）                               │
│  │   ├── 親 Issue チェックボックス同期（新規）                          │
│  │   └── 親 Issue 自動クローズ判定（新規）                              │
│  └── 'spec.phase_changed' ハンドラー（既存）                            │
└─────────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          統合レイヤー                                    │
├─────────────────────────────────────────────────────────────────────────┤
│  sub-issues.ts (SubIssueManager)                                        │
│  ├── createSubIssuesFromTaskList()  - Sub Issue 一括作成                │
│  ├── recordSubIssueSyncData()       - DB 記録（拡張）                   │
│  ├── updateSubIssueStatus()         - ステータス更新                    │
│  ├── syncParentIssueCheckbox()      - 親 Issue チェックボックス同期(新規)│
│  ├── checkAllSubIssuesClosed()      - 全 Sub Issue 完了判定（新規）     │
│  └── closeParentIssue()             - 親 Issue クローズ（新規）         │
│                                                                         │
│  issues.ts (GitHubIssues)                                               │
│  └── update() - Issue 更新（body, state 対応）                          │
└─────────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        データベースレイヤー                              │
├─────────────────────────────────────────────────────────────────────────┤
│  github_sync テーブル                                                   │
│  ├── 既存カラム: id, entity_type, entity_id, github_id, ...            │
│  └── 新規カラム: parent_issue_number, parent_spec_id                   │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 設計方針

1. **既存アーキテクチャの継承**: イベント駆動パターンを踏襲し、`task.completed` ハンドラーを拡張
2. **後方互換性の確保**: 新規カラムは NULL 許容とし、既存データに影響を与えない
3. **段階的実装**: 3 フェーズに分けて実装し、各フェーズで動作確認を行う
4. **エラー耐性**: 既存パターン（警告ログ＋スキップ）を継承し、部分的な失敗でも処理を継続

#### 処理フロー詳細

**Sub Issue 作成フロー（拡張）:**

```
1. タスクリスト解析
   ↓
2. 親 Issue の Node ID 取得（REST API）
   ↓
3. 各タスクに対して:
   a. Sub Issue 作成（REST API）
   b. Sub Issue の Node ID 取得
   c. 親 Issue に Sub Issue 追加（GraphQL API）
   d. github_sync テーブルに記録
      - entity_id: taskId
      - github_id: owner/repo（変更なし）
      - github_number: Sub Issue 番号
      - parent_issue_number: 親 Issue 番号（新規）
      - parent_spec_id: 仕様書 ID（新規）
   ↓
4. 親 Issue 本文に Sub Issue リスト埋め込み（新規）
```

**タスク完了フロー（拡張）:**

```
1. task.completed イベント受信
   ↓
2. Sub Issue ステータス更新（'closed'）
   ↓
3. 親 Issue チェックボックス同期（新規）
   a. github_sync から parent_issue_number 取得
   b. 親 Issue 本文取得
   c. 対応するチェックボックスを更新
   d. 親 Issue 本文更新
   ↓
4. 全 Sub Issue 完了判定（新規）
   a. parent_issue_number に紐づく全 Sub Issue を取得
   b. 全て closed かチェック
   ↓
5. 親 Issue 自動クローズ（新規・条件付き）
   a. 全 Sub Issue が closed の場合のみ実行
   b. 親 Issue をクローズ
   c. コメントで完了を記録
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/core/database/schema.ts` | `github_sync` テーブルに `parent_issue_number`, `parent_spec_id` カラム追加 |
| `src/core/database/migrations/` | マイグレーションファイル追加 |
| `src/integrations/github/sub-issues.ts` | `recordSubIssueSyncData()` 拡張、新規メソッド追加 |
| `src/core/workflow/github-integration.ts` | `task.completed` ハンドラー拡張 |
| `src/commands/github/create-sub-issues.ts` | 親 Issue 情報を SubIssueManager に渡す |

#### recordSubIssueSyncData 拡張

```typescript
// 現在の実装
async recordSubIssueSyncData(
  db: Kysely<Database>,
  taskId: string,
  issueNumber: number,
  nodeId: string,
  repository: string
): Promise<void>

// 拡張後
async recordSubIssueSyncData(
  db: Kysely<Database>,
  taskId: string,
  issueNumber: number,
  nodeId: string,
  repository: string,
  options?: {
    parentIssueNumber?: number;
    parentSpecId?: string;
  }
): Promise<void>
```

#### 新規メソッド

```typescript
// 親 Issue のチェックボックスを同期
async syncParentIssueCheckbox(
  parentIssueNumber: number,
  subIssueNumber: number,
  status: 'open' | 'closed',
  githubToken: string
): Promise<void>

// 全 Sub Issue が完了したかチェック
async checkAllSubIssuesClosed(
  db: Kysely<Database>,
  parentIssueNumber: number
): Promise<boolean>

// 親 Issue をクローズ
async closeParentIssue(
  parentIssueNumber: number,
  githubToken: string
): Promise<void>
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| Sub Issue DB 記録 | taskId のみ保存 | parent_issue_number, parent_spec_id 追加 | `sub-issues.ts:recordSubIssueSyncData()` |
| 親 Issue 逆引き | 不可 | parent_issue_number で可能 | `github_sync` テーブル |
| タスク完了時 Sub Issue クローズ | 実装済み | 変更なし | `github-integration.ts` |
| 親 Issue チェックボックス同期 | なし | 新規実装 | `sub-issues.ts:syncParentIssueCheckbox()` |
| 親 Issue 自動クローズ | なし | 新規実装 | `sub-issues.ts:closeParentIssue()` |
| taskId null 時のリカバリ | スキップ | Issue 番号から逆引き | `github-integration.ts` |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| スキーマ変更 | マイグレーション成功、NULL 許容 | 単体テスト（:memory: DB） |
| recordSubIssueSyncData 拡張 | 新カラムへの保存、後方互換性 | 単体テスト |
| syncParentIssueCheckbox | チェックボックス更新、本文保持 | 単体テスト（API モック） |
| checkAllSubIssuesClosed | 全完了判定、部分完了判定 | 単体テスト |
| closeParentIssue | クローズ成功、コメント追加 | 単体テスト（API モック） |
| task.completed ハンドラー | 一連の処理フロー | 統合テスト |

### 7.5 移行計画

#### Phase 1: データベーススキーマ拡張

1. `github_sync` テーブルに `parent_issue_number` カラム追加（NULL 許容）
2. `github_sync` テーブルに `parent_spec_id` カラム追加（NULL 許容）
3. マイグレーションファイル作成・適用
4. 単体テストで検証

#### Phase 2: Sub Issue 作成時の親 Issue 関連性記録

1. `recordSubIssueSyncData()` に `options` パラメータ追加
2. `create-sub-issues.ts` から親 Issue 情報を渡す
3. 親 Issue 本文に Sub Issue リスト埋め込み（オプション）
4. 単体テスト・統合テストで検証

#### Phase 3: タスク完了時の親 Issue 連携

1. `syncParentIssueCheckbox()` 実装
2. `checkAllSubIssuesClosed()` 実装
3. `closeParentIssue()` 実装
4. `task.completed` ハンドラー拡張
5. 統合テストで検証

---

## 8. 実装タスクリスト

### Phase 1: データベーススキーマ拡張

- [ ] `github_sync` テーブルに `parent_issue_number` カラムを追加するマイグレーション作成
- [ ] `github_sync` テーブルに `parent_spec_id` カラムを追加するマイグレーション作成
- [ ] `src/core/database/schema.ts` の型定義を更新
- [ ] マイグレーション適用と単体テスト作成

### Phase 2: Sub Issue 作成時の親 Issue 関連性記録

- [ ] `recordSubIssueSyncData()` メソッドに `options` パラメータを追加
- [ ] `create-sub-issues.ts` から親 Issue 番号と仕様書 ID を渡すよう修正
- [ ] `createSubIssuesFromTaskList()` の引数を拡張
- [ ] 単体テスト更新と検証

### Phase 3: タスク完了時の親 Issue 連携

- [ ] `syncParentIssueCheckbox()` メソッドを実装
- [ ] `checkAllSubIssuesClosed()` メソッドを実装
- [ ] `closeParentIssue()` メソッドを実装
- [ ] `task.completed` ハンドラーを拡張して親 Issue 連携を追加
- [ ] 統合テスト作成と検証
