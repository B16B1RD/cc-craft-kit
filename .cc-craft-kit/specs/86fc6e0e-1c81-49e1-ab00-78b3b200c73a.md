# インストール構成の見直し

**仕様書 ID:** 86fc6e0e-1c81-49e1-ab00-78b3b200c73a
**フェーズ:** design
**作成日時:** 2025/12/04 18:08:20
**更新日時:** 2025/12/04 18:45:00

---

## 1. 背景と目的

### 背景

現在のインストール構成には以下の問題がある:

1. **不要なシンボリックリンク**
   - `.claude/commands/cft` → `../../src/slash-commands`（開発環境）
   - シンボリックリンクを使う理由がない。直接ファイルを配置すればよい

2. **`.cc-craft-kit/` に不要なファイルが大量にある**
   - 開発用スクリプト（`fix-*.ts`, `check-*.ts` など 30 ファイル以上）
   - バックアップ DB、テスト用アーカイブ
   - ユーザー環境には不要

3. **スキル・サブエージェントが適切な場所にない**
   - `.cc-craft-kit/core/skills/impl/` に配置されている
   - `.cc-craft-kit/core/subagents/impl/` に配置されている
   - Claude Code の規約では `.claude/skills/` と `.claude/agents/` に配置すべき

4. **役割の重複・曖昧さ**
   - `.cc-craft-kit/slash-commands/` と `.claude/commands/cft/` が重複
   - どちらがマスターなのか不明確

### 調査結果

#### Anthropic 公式の見解
- `.claude/` は Claude Code 専用（commands, agents, skills, hooks）
- **プロジェクト固有のデータは `.claude/` 外に配置するのが標準**
- Plugins 機能: `.claude-plugin/plugin.json` で定義し、`~/.claude/plugins/` にインストール可能

#### 他のツールキットの構成
| ツールキット | データ配置 | スキル/エージェント |
|-------------|-----------|-------------------|
| **claudekit** | `.claudekit/` (別ディレクトリ) | `.claude/` 内 |
| **claude-code-spec-kit** | `specs/` (ルート直下) | 言及なし |
| **Claude Code Dev Kit** | 3層ドキュメント | `.claude/` 外 |

**結論: プロジェクト固有データを `.claude/` 外に配置するのが一般的**

### 目的

インストール構成を整理し、Claude Code の規約に従った配置にする:
1. シンボリックリンクを廃止し、直接ファイル配置に変更
2. `.cc-craft-kit/` には本当に必要なもののみを配置
3. スキル・サブエージェントを `.claude/` 配下の適切な場所に配置
4. ユーザー環境での Git 管理方針を明確化

---

## 2. 対象ユーザー

cc-craft-kit をプロジェクトにインストールして使用する開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] シンボリックリンクを廃止し、直接ファイル配置に変更すること
- [ ] スキルが `.claude/skills/` に配置されること
- [ ] サブエージェントが `.claude/agents/` に配置されること
- [ ] スラッシュコマンドが `.claude/commands/cft/` に直接配置されること
- [ ] 開発用スクリプトがユーザー環境にインストールされないこと

### 機能要件

- [ ] `.cc-craft-kit/` にはランタイムに必要なファイルのみ配置
  - `core/` - TypeScript 実装（DB操作、GitHub API等）
  - `integrations/` - 外部連携
  - `commands/` - CLI コマンド実装
  - `specs/` - 仕様書データ
  - `cc-craft-kit.db` - データベース
- [ ] インストールスクリプトが適切な場所にファイルを配置すること

### 非機能要件

- [ ] インストール後のファイル数が現在より大幅に削減されること
- [ ] Windows/macOS/Linux の全プラットフォームで動作すること
- [ ] ドキュメントが更新されていること

---

## 4. 制約条件

- 既存の Claude Code との互換性を維持すること
- プロンプトファースト原則に従い、Markdown で実現できるものは Markdown で
- マイグレーション不要（テスト段階のためユーザーはいない）

---

## 5. 依存関係

### 関連ファイル
- `scripts/install.sh` - インストールスクリプト（大幅な変更が必要）
- `src/scripts/sync-dogfood.ts` - 同期スクリプト（見直しが必要）
- `.github/workflows/release.yml` - リリースワークフロー（アーカイブ構成の変更）
- `.gitignore` - Git 無視設定

### 関連コンポーネント
- `.cc-craft-kit/core/skills/impl/` → `.claude/skills/` に移動
- `.cc-craft-kit/core/subagents/impl/` → `.claude/agents/` に移動
- `.cc-craft-kit/slash-commands/` → `.claude/commands/cft/` に移動

---

## 6. 設計: 選択肢 D（ハイブリッド構成）

### 最終構成

```
.claude/
├── commands/
│   └── cft/                     # スラッシュコマンド（直接配置）
│       ├── task.md
│       ├── spec-create.md
│       └── ...（24ファイル）
├── skills/                      # スキル（直接配置）
│   ├── database-schema-validator/
│   │   └── SKILL.md
│   ├── typescript-eslint/
│   │   └── SKILL.md
│   ├── pr-creator/
│   │   └── SKILL.md
│   └── git-operations/
│       └── SKILL.md
├── agents/                      # エージェント（直接配置）
│   ├── refactoring-assistant.md
│   ├── test-generator.md
│   └── code-reviewer.md
├── settings.json
└── settings.local.json

.cc-craft-kit/                   # ランタイム専用
├── core/                        # TypeScript 実装
│   ├── database/
│   ├── workflow/
│   ├── sync/
│   └── ...
├── integrations/                # 外部連携
│   └── github/
├── commands/                    # CLI コマンド実装
├── specs/                       # 仕様書（Git 管理対象）
└── cc-craft-kit.db              # データベース（Git 除外）
```

### 選択理由

1. **Claude Code 規約準拠**: スキル・エージェント・コマンドは `.claude/` 内
2. **データ分離**: プロジェクト固有データは `.claude/` 外
3. **Git 管理明確**: `specs/` は管理、`db` は除外
4. **他ツールキットと同様のアプローチ**: claudekit も `.claudekit/` を別途持つ

---

## 7. 実装タスク

### Phase 1: シンボリックリンク削除・コマンド移動
- `.claude/commands/cft` (シンボリックリンク) → 削除
- `src/slash-commands/*.md` → `.claude/commands/cft/` にコピー

### Phase 2: 不要ファイル削除
**削除対象:**
```
scripts/fix-*.ts, check-*.ts, cleanup-*.ts, repair-*.ts
scripts/rebuild-*.ts, import-*.ts, update-*.ts, run-*.ts
scripts/add-*.ts, test-*.ts, close-*.ts, monitor-*.ts
backups/, *.db-wal, *.db-shm, *-recovered.db, *-new.db
test-archive.tar.gz, slash-commands/, quality-templates/
```

### Phase 3: ソース構成の見直し
- `src/slash-commands/` はマスターとして維持
- `npm run sync:dogfood` で `.claude/commands/cft/` にコピー

### Phase 4: インストールスクリプト更新
- シンボリックリンク作成を削除
- `.claude/commands/cft/`, `.claude/skills/`, `.claude/agents/` に直接コピー
- `.cc-craft-kit/` にはランタイムファイルのみ展開

### Phase 5: 同期スクリプト更新
- 同期先を `.claude/commands/cft/` に変更

### Phase 6: リリースワークフロー更新
- アーカイブ作成処理を更新
- 不要ファイルの除外

### Phase 7: .gitignore 更新
```gitignore
.cc-craft-kit/cc-craft-kit.db
.cc-craft-kit/*.db-*
.cc-craft-kit/backups/
.claude/commands/cft/  # sync:dogfood で生成
```

### Phase 8: ドキュメント更新
- README.md, docs/QUICK_START.md, docs/ARCHITECTURE.md, CLAUDE.md

---

## 8. Git 管理方針（ユーザー環境）

| ディレクトリ | Git 管理 | 理由 |
|-------------|----------|------|
| `.claude/commands/cft/` | ✗ 除外 | ツール提供、変更不可 |
| `.claude/skills/` | ✗ 除外 | ツール提供、変更不可 |
| `.claude/agents/` | △ 選択 | カスタマイズする場合は管理 |
| `.cc-craft-kit/specs/` | ✓ 管理 | プロジェクト固有データ |
| `.cc-craft-kit/cc-craft-kit.db` | ✗ 除外 | 生成ファイル |

---

## 9. 参考リンク

- [Plugins reference - Claude Code Docs](https://code.claude.com/docs/en/plugins-reference)
- [claudekit](https://github.com/carlrannaberg/claudekit)
- [claude-code-spec-kit](https://github.com/VanguardiaAI/claude-code-spec-kit)
