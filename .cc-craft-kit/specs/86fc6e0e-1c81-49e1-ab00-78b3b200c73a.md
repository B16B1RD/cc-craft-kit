# インストール構成の見直し

**仕様書 ID:** 86fc6e0e-1c81-49e1-ab00-78b3b200c73a
**フェーズ:** implementation
**作成日時:** 2025/12/04 18:08:20
**更新日時:** 2025/12/04 19:15:00

---

## 1. 背景と目的

### 背景

現在のインストール構成には以下の問題がある:

1. **不要なシンボリックリンク**
   - `.claude/commands/cft` → `../../src/slash-commands`（開発環境）
   - シンボリックリンクを使う理由がない。直接ファイルを配置すればよい

2. **`.cc-craft-kit/` に不要なファイルが大量にある**
   - 開発用スクリプト（`fix-*.ts`, `check-*.ts` など 30 ファイル以上）
   - バックアップ DB、テスト用アーカイブ
   - ユーザー環境には不要

3. **スキル・サブエージェントが適切な場所にない**
   - `.cc-craft-kit/core/skills/impl/` に配置されている
   - `.cc-craft-kit/core/subagents/impl/` に配置されている
   - Claude Code の規約では `.claude/skills/` と `.claude/agents/` に配置すべき

4. **役割の重複・曖昧さ**
   - `.cc-craft-kit/slash-commands/` と `.claude/commands/cft/` が重複
   - どちらがマスターなのか不明確

### 調査結果

#### Anthropic 公式の見解
- `.claude/` は Claude Code 専用（commands, agents, skills, hooks）
- **プロジェクト固有のデータは `.claude/` 外に配置するのが標準**
- Plugins 機能: `.claude-plugin/plugin.json` で定義し、`~/.claude/plugins/` にインストール可能

#### 他のツールキットの構成
| ツールキット | データ配置 | スキル/エージェント |
|-------------|-----------|-------------------|
| **claudekit** | `.claudekit/` (別ディレクトリ) | `.claude/` 内 |
| **claude-code-spec-kit** | `specs/` (ルート直下) | 言及なし |
| **Claude Code Dev Kit** | 3層ドキュメント | `.claude/` 外 |

**結論: プロジェクト固有データを `.claude/` 外に配置するのが一般的**

### 目的

インストール構成を整理し、Claude Code の規約に従った配置にする:
1. シンボリックリンクを廃止し、直接ファイル配置に変更
2. `.cc-craft-kit/` には本当に必要なもののみを配置
3. スキル・サブエージェントを `.claude/` 配下の適切な場所に配置
4. ユーザー環境での Git 管理方針を明確化

---

## 2. 対象ユーザー

cc-craft-kit をプロジェクトにインストールして使用する開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] シンボリックリンクを廃止し、直接ファイル配置に変更すること
- [ ] スキルが `.claude/skills/` に配置されること
- [ ] サブエージェントが `.claude/agents/` に配置されること
- [ ] スラッシュコマンドが `.claude/commands/cft/` に直接配置されること
- [ ] 開発用スクリプトがユーザー環境にインストールされないこと

### 機能要件

- [ ] `.cc-craft-kit/` にはランタイムに必要なファイルのみ配置
  - `core/` - TypeScript 実装（DB操作、GitHub API等）
  - `integrations/` - 外部連携
  - `commands/` - CLI コマンド実装
  - `specs/` - 仕様書データ
  - `cc-craft-kit.db` - データベース
- [ ] インストールスクリプトが適切な場所にファイルを配置すること

### 非機能要件

- [ ] インストール後のファイル数が現在より大幅に削減されること
- [ ] Windows/macOS/Linux の全プラットフォームで動作すること
- [ ] ドキュメントが更新されていること

---

## 4. 制約条件

- 既存の Claude Code との互換性を維持すること
- プロンプトファースト原則に従い、Markdown で実現できるものは Markdown で
- マイグレーション不要（テスト段階のためユーザーはいない）

---

## 5. 依存関係

### 関連ファイル
- `scripts/install.sh` - インストールスクリプト（大幅な変更が必要）
- `src/scripts/sync-dogfood.ts` - 同期スクリプト（見直しが必要）
- `.github/workflows/release.yml` - リリースワークフロー（アーカイブ構成の変更）
- `.gitignore` - Git 無視設定

### 関連コンポーネント
- `.cc-craft-kit/core/skills/impl/` → `.claude/skills/` に移動
- `.cc-craft-kit/core/subagents/impl/` → `.claude/agents/` に移動
- `.cc-craft-kit/slash-commands/` → `.claude/commands/cft/` に移動

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
プロジェクトルート/
├── .claude/                         # Claude Code 標準ディレクトリ
│   ├── commands/
│   │   └── cft/                     # スラッシュコマンド（直接配置）
│   │       ├── task.md
│   │       ├── spec-create.md
│   │       └── ...（24ファイル）
│   ├── skills/                      # スキル（直接配置）
│   │   ├── database-schema-validator/
│   │   │   └── SKILL.md
│   │   ├── typescript-eslint/
│   │   │   └── SKILL.md
│   │   ├── pr-creator/
│   │   │   └── SKILL.md
│   │   └── git-operations/
│   │       └── SKILL.md
│   ├── agents/                      # エージェント（直接配置）
│   │   ├── refactoring-assistant.md
│   │   ├── test-generator.md
│   │   └── code-reviewer.md
│   ├── settings.json
│   └── settings.local.json
│
├── .cc-craft-kit/                   # ランタイム専用（プロジェクトデータ）
│   ├── core/                        # TypeScript 実装
│   │   ├── database/
│   │   ├── workflow/
│   │   ├── sync/
│   │   └── ...
│   ├── integrations/                # 外部連携
│   │   └── github/
│   ├── commands/                    # CLI コマンド実装
│   ├── specs/                       # 仕様書（Git 管理対象）
│   └── cc-craft-kit.db              # データベース（Git 除外）
│
└── src/                             # 開発用ソース（マスター）
    ├── slash-commands/              # スラッシュコマンド定義
    ├── skills/                      # スキル定義
    ├── agents/                      # エージェント定義
    └── ...
```

#### 設計方針

1. **Claude Code 規約準拠**: スキル・エージェント・コマンドは `.claude/` 内
2. **データ分離**: プロジェクト固有データは `.claude/` 外（`.cc-craft-kit/`）
3. **シンボリックリンク廃止**: 直接ファイルコピーで信頼性向上
4. **他ツールキットと同様のアプローチ**: claudekit も `.claudekit/` を別途持つ

#### 処理フロー詳細

**開発時（sync:dogfood）:**
```
src/slash-commands/*.md  ──copy──>  .claude/commands/cft/*.md
src/skills/**/*.md       ──copy──>  .claude/skills/**/*.md
src/agents/*.md          ──copy──>  .claude/agents/*.md
src/**/*.ts              ──copy──>  .cc-craft-kit/**/*.ts
```

**インストール時:**
```
.cc-craft-kit.tar.gz
├── .cc-craft-kit/       ──extract──>  .cc-craft-kit/
├── .claude/commands/cft/ ──extract──>  .claude/commands/cft/
├── .claude/skills/      ──extract──>  .claude/skills/
└── .claude/agents/      ──extract──>  .claude/agents/
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/scripts/sync-dogfood.ts` | 同期先を `.claude/` 配下に変更、不要ファイル削除処理追加 |
| `scripts/install.sh` | シンボリックリンク作成を削除、アーカイブ構造変更に対応 |
| `.github/workflows/release.yml` | アーカイブ構成を変更（.claude/ を含める） |
| `.gitignore` | `.claude/commands/cft/`、`.claude/skills/`、`.claude/agents/` を追加 |
| `README.md` | インストール手順・構成図を更新 |
| `docs/QUICK_START.md` | セットアップ手順を更新 |
| `docs/ARCHITECTURE.md` | アーキテクチャ図を更新 |
| `CLAUDE.md` | 構成説明を更新 |

#### 削除対象ファイル

開発用スクリプト（`.cc-craft-kit/scripts/` から削除）:
- `fix-*.ts`, `check-*.ts`, `cleanup-*.ts`, `repair-*.ts`
- `rebuild-*.ts`, `import-*.ts`, `update-*.ts`, `run-*.ts`
- `add-*.ts`, `test-*.ts`, `close-*.ts`, `monitor-*.ts`

不要ディレクトリ:
- `.cc-craft-kit/slash-commands/` - `.claude/commands/cft/` に移動
- `.cc-craft-kit/quality-templates/` - 不要
- `.cc-craft-kit/backups/` - 開発用

### 7.3 機能マッピング

| 機能 | 現在の配置 | 新しい配置 | 変更内容 |
|-----|----------|----------|---------|
| スラッシュコマンド | `.claude/commands/cft` → シンボリックリンク | `.claude/commands/cft/` 直接配置 | 直接コピー |
| スキル | `.cc-craft-kit/core/skills/` | `.claude/skills/` | ディレクトリ移動 |
| エージェント | `.cc-craft-kit/core/subagents/` | `.claude/agents/` | ディレクトリ移動 |
| TypeScript実装 | `.cc-craft-kit/` | `.cc-craft-kit/` | 変更なし |
| 仕様書データ | `.cc-craft-kit/specs/` | `.cc-craft-kit/specs/` | 変更なし |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| sync-dogfood | 正しい場所にファイルがコピーされること | ファイル存在確認、内容比較 |
| install.sh | インストール後の構成が正しいこと | 新規プロジェクトでインストール実行 |
| アーカイブ構成 | 必要なファイルのみ含まれること | tar -tvf で内容確認 |
| スラッシュコマンド | `/cft:*` が動作すること | 実際にコマンド実行 |
| スキル | Skill ツールで呼び出せること | スキル実行テスト |

### 7.5 移行計画

#### Phase 1: シンボリックリンク削除・ファイル移動
1. `.claude/commands/cft` シンボリックリンクを削除
2. `src/slash-commands/*.md` を `.claude/commands/cft/` に直接コピー
3. スキル・エージェント定義ファイルを `.claude/` 配下に移動

#### Phase 2: 不要ファイル削除
1. `.cc-craft-kit/` から開発用スクリプトを削除
2. 不要なディレクトリを削除（backups, quality-templates など）

#### Phase 3: 同期スクリプト更新
1. `sync-dogfood.ts` の同期先を `.claude/` 配下に変更
2. 不要ファイル削除処理を追加

#### Phase 4: インストールスクリプト更新
1. シンボリックリンク作成処理を削除
2. アーカイブ展開処理を更新

#### Phase 5: リリースワークフロー更新
1. アーカイブに `.claude/` を含める
2. 不要ファイルを除外

#### Phase 6: ドキュメント・設定更新
1. `.gitignore` を更新
2. README.md, docs/QUICK_START.md, docs/ARCHITECTURE.md, CLAUDE.md を更新

---

## 8. 実装タスクリスト

### Phase 1: シンボリックリンク削除・ファイル移動

- [x] `.claude/commands/cft` シンボリックリンクを削除 (#690)
- [x] `src/slash-commands/*.md` を `.claude/commands/cft/` にコピー (#691)
- [x] `src/skills/` ディレクトリを作成し、スキル定義を移動 (#692)
- [x] `src/agents/` ディレクトリを作成し、エージェント定義を移動 (#693)

### Phase 2: 不要ファイル削除

- [x] `.cc-craft-kit/scripts/` から開発用スクリプトを削除 (#694)
- [x] `.cc-craft-kit/slash-commands/` ディレクトリを削除 (#695)
- [x] `.cc-craft-kit/quality-templates/` ディレクトリを削除 (#696)
- [x] `.cc-craft-kit/backups/` ディレクトリを削除 (#697)

### Phase 3: 同期スクリプト更新

- [ ] `sync-dogfood.ts` の同期先を `.claude/commands/cft/` に変更 (#698)
- [ ] スキル・エージェントの同期処理を追加 (#699)
- [ ] 不要ファイル削除処理を追加 (#700)

### Phase 4: インストールスクリプト更新

- [ ] `install.sh` からシンボリックリンク作成処理を削除 (#701)
- [ ] アーカイブ展開後の構成を更新 (#702)

### Phase 5: リリースワークフロー更新

- [ ] `release.yml` のアーカイブ作成処理を更新 (#703)
- [ ] `.claude/` ディレクトリをアーカイブに含める (#704)
- [ ] 不要ファイルを除外する処理を追加 (#705)

### Phase 6: ドキュメント・設定更新

- [ ] `.gitignore` に `.claude/commands/cft/`、`.claude/skills/`、`.claude/agents/` を追加 (#706)
- [ ] `README.md` のインストール手順・構成図を更新 (#707)
- [ ] `docs/QUICK_START.md` のセットアップ手順を更新 (#708)
- [ ] `docs/ARCHITECTURE.md` のアーキテクチャ図を更新 (#709)
- [ ] `CLAUDE.md` の構成説明を更新 (#710)

---

## 9. Git 管理方針（ユーザー環境）

| ディレクトリ | Git 管理 | 理由 |
|-------------|----------|------|
| `.claude/commands/cft/` | ✗ 除外 | ツール提供、変更不可 |
| `.claude/skills/` | ✗ 除外 | ツール提供、変更不可 |
| `.claude/agents/` | △ 選択 | カスタマイズする場合は管理 |
| `.cc-craft-kit/specs/` | ✓ 管理 | プロジェクト固有データ |
| `.cc-craft-kit/cc-craft-kit.db` | ✗ 除外 | 生成ファイル |

## 10. 参考リンク

- [Plugins reference - Claude Code Docs](https://code.claude.com/docs/en/plugins-reference)
- [claudekit](https://github.com/carlrannaberg/claudekit)
- [claude-code-spec-kit](https://github.com/VanguardiaAI/claude-code-spec-kit)
