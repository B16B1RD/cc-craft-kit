# インストーラーでエラー

**仕様書 ID:** 7771d1e1-fea7-4631-b4b9-3a5fa07e4fbc
**フェーズ:** completed
**作成日時:** 2025/12/04 12:00:00
**更新日時:** 2025/12/04 22:15:00

---

## 1. 背景と目的

### 背景

インストーラーで以下のエラーが発生する。
$ curl -fsSL https://raw.githubusercontent.com/B16B1RD/cc-craft-kit/main/scripts/install.sh | sh
cc-craft-kit のインストールを開始します...

環境をチェックしています...
✓ 環境チェック完了
GitHub Releases から最新バージョンを取得しています...
✓ 最新バージョン: v0.1.6
エラー: 無効なアーカイブです。.cc-craft-kit/ ディレクトリが見つかりません。

### 目的

リリースワークフローで生成されるアーカイブの構造を修正し、インストールスクリプトが正常に動作するようにする。

---

## 2. 対象ユーザー

cc-craft-kit を新規インストールするユーザー

---

## 3. 受け入れ基準

### 必須要件

- [ ] `curl -fsSL ... | sh` でインストールが正常に完了すること
- [ ] リリースアーカイブに `.cc-craft-kit/` ディレクトリが正しく含まれること

### 機能要件

- [ ] `.github/workflows/release.yml` のアーカイブ生成ロジックを修正する
- [ ] `scripts/install.sh` の検証ロジックを堅牢化する（オプション）

### 非機能要件

- [ ] 既存の v0.1.6 ユーザーへの影響を最小化する
- [ ] CI/CD パイプラインの変更を最小限に抑える

---

## 4. 制約条件

- リリースワークフローは GitHub Actions で実行される
- `tar` コマンドのアーカイブ構造に依存した設計
- install.sh は `^\.cc-craft-kit/` パターンでアーカイブを検証している

---

## 5. 依存関係

- `.github/workflows/release.yml` - リリースワークフロー
- `scripts/install.sh` - インストールスクリプト
- `src/scripts/sync-dogfood.ts` - ソース同期スクリプト

---

## 6. 参考情報

- 根本原因: `tar -czf ../.cc-craft-kit.tar.gz .` がディレクトリ内から実行されるため、アーカイブ内に `.cc-craft-kit/` プレフィックスが含まれない
- 修正案: `tar -czf .cc-craft-kit.tar.gz .cc-craft-kit/` を親ディレクトリから実行する

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
リリースフロー:
┌─────────────────────────────────────────────────────────────┐
│ GitHub Actions: release.yml                                  │
├─────────────────────────────────────────────────────────────┤
│ 1. npm run sync:dogfood                                      │
│    └─ src/ → .cc-craft-kit/ へ同期                           │
│                                                              │
│ 2. Create archive (★修正対象)                                │
│    現在: cd .cc-craft-kit && tar -czf ../.cc-craft-kit.tar.gz . │
│    修正: tar -czf .cc-craft-kit.tar.gz .cc-craft-kit/        │
│                                                              │
│ 3. GitHub Release へアップロード                             │
│    └─ .cc-craft-kit.tar.gz                                  │
└─────────────────────────────────────────────────────────────┘

インストールフロー:
┌─────────────────────────────────────────────────────────────┐
│ scripts/install.sh                                           │
├─────────────────────────────────────────────────────────────┤
│ 1. fetch_latest_version                                      │
│    └─ GitHub API から最新バージョン取得                       │
│                                                              │
│ 2. download_archive                                          │
│    └─ .cc-craft-kit.tar.gz をダウンロード                    │
│                                                              │
│ 3. verify_archive (★エラー発生箇所)                          │
│    └─ grep -q '^\.cc-craft-kit/' で検証                      │
│    └─ 現在のアーカイブ: ^\./ でプレフィックス不一致           │
│                                                              │
│ 4. extract_archive                                           │
│    └─ tar -xzf で展開                                        │
└─────────────────────────────────────────────────────────────┘
```

#### 設計方針

**方式A: アーカイブ構造修正（採用）**

release.yml のアーカイブ生成ロジックを修正し、親ディレクトリから `.cc-craft-kit/` をプレフィックス付きで圧縮する。

- シンプルで直感的
- install.sh の検証ロジック変更不要
- 展開後に自動的に正しいディレクトリ構造が作成される

#### 処理フロー詳細

```
修正前のアーカイブ構造:
.cc-craft-kit.tar.gz
├── ./
├── ./slash-commands/
├── ./commands/
├── ./core/
└── ...

修正後のアーカイブ構造:
.cc-craft-kit.tar.gz
├── .cc-craft-kit/
├── .cc-craft-kit/slash-commands/
├── .cc-craft-kit/commands/
├── .cc-craft-kit/core/
└── ...
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `.github/workflows/release.yml` | アーカイブ生成ロジックを親ディレクトリから実行するよう修正 |

#### 具体的な修正内容

**release.yml 31-35行目:**

```yaml
# 修正前
- name: Create archive
  run: |
    cd .cc-craft-kit
    tar -czf ../.cc-craft-kit.tar.gz .
    cd ..

# 修正後
- name: Create archive
  run: tar -czf .cc-craft-kit.tar.gz .cc-craft-kit/
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| アーカイブ生成 | `.cc-craft-kit/` 内から `tar -czf ../.cc-craft-kit.tar.gz .` | 親ディレクトリから `tar -czf .cc-craft-kit.tar.gz .cc-craft-kit/` | `.github/workflows/release.yml:31-35` |
| アーカイブ検証 | `grep -q '^\.cc-craft-kit/'` | 変更なし | `scripts/install.sh:94` |
| アーカイブ展開 | `tar -xzf "$ARCHIVE_FILE" -C "$INSTALL_DIR"` | 変更なし | `scripts/install.sh:224` |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| アーカイブ構造 | `.cc-craft-kit/` プレフィックスが含まれること | `tar -tzf .cc-craft-kit.tar.gz \| head -5` |
| 検証ロジック | install.sh の verify_archive が成功すること | ローカルでアーカイブを生成し install.sh を実行 |
| 展開結果 | 正しいディレクトリ構造が作成されること | 展開後に `.cc-craft-kit/commands/` の存在を確認 |
| CI パイプライン | release.yml が正常に動作すること | GitHub Actions のログを確認 |

### 7.5 移行計画

#### Phase 1: release.yml 修正

1. `.github/workflows/release.yml` のアーカイブ生成ロジックを修正
2. ローカルで動作確認（`npm run sync:dogfood && tar -czf .cc-craft-kit.tar.gz .cc-craft-kit/`）
3. アーカイブ構造を検証（`tar -tzf .cc-craft-kit.tar.gz | grep '^\.cc-craft-kit/'`）

#### Phase 2: テスト・検証

1. 生成したアーカイブで install.sh を実行
2. 展開後のディレクトリ構造を確認
3. シンボリックリンクが正しく機能することを確認

---

## 8. 実装タスクリスト

### Phase 1: release.yml 修正

- [x] `.github/workflows/release.yml` のアーカイブ生成ロジックを修正 (#615)
- [x] ローカルでアーカイブを生成し構造を検証 (#616)

### Phase 2: テスト・検証

- [x] 生成したアーカイブで install.sh を実行してエラーが解消されることを確認 (#617)
- [x] 展開後のディレクトリ構造が正しいことを確認 (#618)
