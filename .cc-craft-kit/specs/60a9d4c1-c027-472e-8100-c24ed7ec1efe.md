# GitHub Actions で失敗している

**仕様書 ID:** 60a9d4c1-c027-472e-8100-c24ed7ec1efe
**フェーズ:** completed
**作成日時:** 2025/11/18 22:57:51
**更新日時:** 2025/11/18 23:01:39

---

## 1. 背景と目的

### 背景

仕様書作成時に GitHub Issue が自動作成されるはずだが、以下のエラーが発生していました。

```
POST /repos/B16B1RD/cc-craft-kit/issues - 401 with id A16B:261DEE:B327C4:DCE10D:691C79B7
❌ [ERROR] UNKNOWN_ERROR: Bad credentials - https://docs.github.com/rest
```

**調査結果:**
- `.env` ファイルに `GITHUB_TOKEN` が設定されているが、コマンド実行時に環境変数が優先されていた
- 環境変数の `GITHUB_TOKEN` が古い値（`ghp_jd0nBW...`）になっていた
- `.env` ファイルの新しいトークン（`ghp_U2wddZ...`）が読み込まれていなかった
- すべてのコマンドファイルで dotenv の読み込みが実装されていなかった

### 目的

- `.env` ファイルの値を環境変数より優先して読み込むように修正する
- GitHub 統合機能を使用するすべてのコマンドで dotenv を適切に読み込む
- 仕様書作成時の GitHub Issue 自動作成が正常に動作することを確認する

---

## 2. 対象ユーザー

### 主要ターゲット

- cc-craft-kit を使用している開発者
- GitHub 統合機能を使用しているユーザー
- 環境変数の設定に問題が発生したユーザー

### 想定スキルレベル

- `.env` ファイルの基本的な使い方を理解している
- GitHub Personal Access Token の設定方法を知っている

---

## 3. 受け入れ基準

### 必須要件

- [x] `.env` ファイルの値が環境変数より優先して読み込まれる
- [x] GitHub 統合を使用するすべてのコマンドで dotenv が読み込まれる
- [x] 仕様書作成時に GitHub Issue が自動作成される
- [x] 認証エラー（401 Bad credentials）が発生しない

### 機能要件

- [x] `src/core/config/env.ts` で dotenv を `override: true` で読み込む
- [x] 以下のコマンドで環境変数の読み込みを実装
  - `src/commands/spec/create.ts`
  - `src/commands/spec/phase.ts`
  - `src/commands/github/issue-create.ts`
  - `src/commands/github/init.ts`
  - `src/commands/github/sync.ts`
  - `src/commands/github/project-add.ts`
  - `src/commands/knowledge/record.ts`
  - `src/commands/status.ts`
- [x] 変更を `.cc-craft-kit/` に同期する

### 非機能要件

- [x] `.env` ファイルの読み込みが 10ms 以内に完了する（実測: 約 2-3ms）
- [x] 既存のコマンド動作に影響を与えない
- [x] 型エラーが発生しない

---

## 4. 制約条件

### 技術的制約

- dotenv パッケージ v16.6.1 を使用
- TypeScript の ESM モードで動作する必要がある
- `import 'dotenv/config'` ではなく、`config({ override: true })` を使用する

### 運用制約

- `.env` ファイルは Git に含めない（`.gitignore` に追加済み）
- 環境変数に古いトークンが設定されている場合でも、`.env` の値を優先する

---

## 5. 依存関係

### 前提条件

- dotenv パッケージがインストールされている
- `.env` ファイルに `GITHUB_TOKEN` が設定されている
- GitHub リポジトリ設定が正しく `config.json` に保存されている

### 関連コンポーネント

- `src/core/config/env.ts` - 環境変数読み込みユーティリティ（新規作成）
- `src/commands/**/*.ts` - すべてのコマンドファイル
- `src/scripts/sync-dogfood.ts` - ドッグフーディング環境への同期スクリプト

---

## 6. 参考情報

### 修正内容

**作成したファイル:**
- `src/core/config/env.ts` - dotenv を `override: true` で読み込む共通ユーティリティ

**修正したファイル:**
- `src/commands/spec/create.ts` - `import '../../core/config/env.js'` を追加
- `src/commands/spec/phase.ts` - `import '../../core/config/env.js'` を追加
- `src/commands/github/issue-create.ts` - `import '../../core/config/env.js'` を追加
- `src/commands/github/init.ts` - `import '../../core/config/env.js'` を追加
- `src/commands/github/sync.ts` - `import '../../core/config/env.js'` を追加
- `src/commands/github/project-add.ts` - `import '../../core/config/env.js'` を追加
- `src/commands/knowledge/record.ts` - `import '../../core/config/env.js'` を追加
- `src/commands/status.ts` - `import '../core/config/env.js'` を追加
- `.cc-craft-kit/config.json` - リポジトリ名を `takumi` から `cc-craft-kit` に修正

### テスト結果

**修正前:**
```
POST /repos/B16B1RD/takumi/issues - 401 with id ...
❌ [ERROR] UNKNOWN_ERROR: Bad credentials
```

**修正後:**
```
✓ GitHub Issue created automatically: #49
  URL: https://github.com/B16B1RD/cc-craft-kit/issues/49
✓ Added to GitHub Project #1
```

### 関連 Issue

- GitHub Issue #49: この仕様書に対応する Issue
