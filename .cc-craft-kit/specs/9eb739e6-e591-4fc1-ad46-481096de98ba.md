# /cft:spec-create がブランチ作成後すぐに元のブランチに戻り、間違ったブランチでコミットされる

**仕様書 ID:** 9eb739e6-e591-4fc1-ad46-481096de98ba
**フェーズ:** requirements
**作成日時:** 2025/11/22 20:13:26
**更新日時:** 2025/11/22 20:13:26

---

## 1. 背景と目的

### 背景

現在、`/cft:spec-create` コマンドは以下の順序で動作しています。

1. 新しいブランチを作成（例: `feature/spec-9eb739e6-fix-spec-create-branch-commit`）
2. **すぐに元のブランチ（develop 等）に戻る**
3. **元のブランチで**データベースレコードとファイルを作成
4. **元のブランチで**Git コミットを実行（問題）

この動作により、仕様書の初回コミットが誤って develop ブランチへ記録され、以下の問題が発生します。

- develop ブランチで push が必要な状態になる（保護ブランチへの直接コミット）
- 作成された feature ブランチにはコミットが存在しない
- 手動で cherry-pick とリセットを行う必要がある

### 目的

`/cft:spec-create` コマンドの実行順序を修正し、以下の正しいフローを実現します。

1. 新しいブランチを作成
2. **新しいブランチに切り替える**
3. **新しいブランチで**データベースレコードとファイルを作成
4. **新しいブランチで**Git コミットを実行
5. 元のブランチに戻る

---

## 2. 対象ユーザー

- cc-craft-kit を使用するすべての開発者
- `/cft:spec-create` コマンドを使用して仕様書を作成する開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-create` 実行時、ブランチ作成後に新しいブランチへ切り替わること
- [ ] 仕様書ファイル作成とコミットが新しいブランチで実行されること
- [ ] コミット完了後、元のブランチに戻ること
- [ ] 元のブランチ（develop 等）に仕様書作成のコミットが残らないこと

### 機能要件

- [ ] ブランチ切り替え処理を `createSpecBranch()` 関数の後に実行すること
- [ ] ブランチ切り替え失敗時、エラーを返して仕様書作成を中断すること
- [ ] コミット完了後、`git checkout <original-branch>` で元のブランチに戻ること
- [ ] 元のブランチに戻る際も、エラーハンドリングを実装すること

### 非機能要件

- [ ] ブランチ切り替え処理は 3 秒以内に完了すること
- [ ] エラー発生時、ロールバック処理が正常に動作すること（ブランチ削除、DB レコード削除、ファイル削除）
- [ ] すべての Git 操作は try-catch でエラーハンドリングすること

### テスト要件

- [ ] 仕様書作成後、feature ブランチにコミットが存在することを E2E テストで検証すること
- [ ] 仕様書作成後、develop ブランチに未コミット変更や未 push コミットが存在しないことを E2E テストで検証すること
- [ ] ブランチ切り替え失敗時、ロールバックが正常に動作することを単体テストで検証すること
- [ ] Git 操作のモック化により、実際のブランチ切り替えを伴わないテストを実装すること

---

## 4. 制約条件

### 技術的制約

- v0.3.0 の仕様「ブランチ作成後の動作」を維持すること（最終的に元のブランチに戻る）
- ブランチ切り替え時にコンフリクトが発生する場合、エラーを返し、手動解決を促すこと
- Git リポジトリが未初期化の場合、エラーを返すこと

### ビジネス的制約

- 保護ブランチ（main, develop）への直接コミットを防ぐこと
- エラー発生時、ユーザーに分かりやすいメッセージを表示すること

---

## 5. 依存関係

### 依存する既存機能

- `src/core/git/branch-creation.ts` - `createSpecBranch()` 関数
- `src/core/git/branch-cache.ts` - ブランチキャッシュ機構（`clearBranchCache()`）
- `src/commands/spec/create.ts` - 仕様書作成コマンド実装

### 影響を受ける機能

- `/cft:spec-create` コマンド実装（`src/commands/spec/create.ts`）
- E2E テスト（`tests/e2e/test-branch-stability.test.ts` 等）

### 関連する仕様書

- `f12b0d21-7e2f-488b-9da0-201935b6f1ff` - `/cft:spec-phase` でのブランチ自動切り替え機能（この仕様書で発見されたバグ）

---

## 6. 参考情報

- CLAUDE.md「ブランチ管理」セクション
- `src/core/git/branch-creation.ts` - ブランチ作成ロジック
- `tests/e2e/test-branch-stability.test.ts` - ブランチ切り替えテストの実装例
- GitHub Issue #287
