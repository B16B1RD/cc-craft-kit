# completed フェーズ移行時にブランチ削除が失敗する

**仕様書 ID:** 7a42a7d3-2383-489d-9333-b4a3c0283023
**フェーズ:** requirements
**作成日時:** 2025/12/04 23:55:51
**更新日時:** 2025/12/04 23:55:51

---

## 1. 背景と目的

### 背景

現在、`/cft:spec-phase <spec-id> completed` で completed フェーズに移行する際、ユーザーが作業ブランチ（例: `fix/spec-12345678-xxx`）にいたまま実行すると、ブランチ削除処理が失敗する。これは Git の仕様として「現在チェックアウト中のブランチは削除できない」ためである。

実際の問題発生例（仕様書 2feaa5bf の完了時）:
```
⚠️  ローカルブランチの削除に失敗しました: fix/spec-2feaa5bf-fix-ci-failing-pr-creation
   手動で削除してください
⚠️  リモートブランチの削除に失敗しました: fix/spec-2feaa5bf-fix-ci-failing-pr-creation
   手動で削除してください
```

ユーザーは手動で `git checkout develop` → `git branch -D <branch>` を実行する必要があり、開発体験が低下している。

### 目的

completed フェーズ移行時に、削除対象ブランチが現在のブランチである場合、自動的にベースブランチ（develop）に切り替えてからブランチ削除を実行し、手動介入なしで完了できるようにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] 作業ブランチにいたまま completed フェーズに移行しても、ブランチ削除が成功する
- [ ] ブランチ削除前に自動的にベースブランチに切り替わる

### 機能要件

- [ ] 削除対象ブランチが現在のブランチかどうかを判定する
- [ ] 現在のブランチと削除対象が同一の場合、ベースブランチに自動切り替えする
- [ ] 切り替え後にローカル・リモートブランチを削除する
- [ ] 切り替え時に未コミット変更がある場合は警告を表示する

### 非機能要件

- [ ] プロンプトファースト原則に従い、TypeScript の変更は最小限に抑える
- [ ] 既存の `deleteLocalBranch()` 関数の後方互換性を維持する

---

## 4. 制約条件

- プロンプトファースト原則: 可能な限り .md ファイルでロジックを実装
- 後方互換性: 既存 API の型シグネチャは変更しない
- Git の制限: 現在チェックアウト中のブランチは削除不可（Git の仕様）
- エラーハンドリング: ブランチ削除失敗時も Issue クローズ処理は継続

---

## 5. 依存関係

- `src/slash-commands/spec-phase.md` - completed フェーズ移行のフロー定義
- `src/core/workflow/branch-cleanup.ts` - ブランチ削除の低レベル実装
- `src/integrations/github/pr-cleanup.ts` - PR マージ後の後処理
- `src/core/git/branch-switching.ts` - ブランチ切り替えロジック（既存）
- `src/core/git/branch-cache.ts` - 現在のブランチ取得（既存）

---

## 6. 参考情報

- 仕様書 2feaa5bf-2257-4c65-a4c0-0e770274a811: CI が失敗する PR が作成される（完了時に問題発生）
- `src/core/git/branch-switching.ts`: 既存のブランチ切り替え実装（参考パターン）
- Git ドキュメント: `git branch -D` は現在のブランチには使用不可
