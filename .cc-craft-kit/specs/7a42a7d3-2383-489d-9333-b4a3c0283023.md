# completed フェーズ移行時にブランチ削除が失敗する

**仕様書 ID:** 7a42a7d3-2383-489d-9333-b4a3c0283023
**フェーズ:** implementation
**作成日時:** 2025/12/04 23:55:51
**更新日時:** 2025/12/05 22:56:00

---

## 1. 背景と目的

### 背景

現在、`/cft:spec-phase <spec-id> completed` で completed フェーズに移行する際、ユーザーが作業ブランチ（例: `fix/spec-12345678-xxx`）にいたまま実行すると、ブランチ削除処理が失敗する。これは Git の仕様として「現在チェックアウト中のブランチは削除できない」ためである。

実際の問題発生例（仕様書 2feaa5bf の完了時）:
```
⚠️  ローカルブランチの削除に失敗しました: fix/spec-2feaa5bf-fix-ci-failing-pr-creation
   手動で削除してください
⚠️  リモートブランチの削除に失敗しました: fix/spec-2feaa5bf-fix-ci-failing-pr-creation
   手動で削除してください
```

ユーザーは手動で `git checkout develop` → `git branch -D <branch>` を実行する必要があり、開発体験が低下している。

### 目的

completed フェーズ移行時に、削除対象ブランチが現在のブランチである場合、自動的にベースブランチ（develop）に切り替えてからブランチ削除を実行し、手動介入なしで完了できるようにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] 作業ブランチにいたまま completed フェーズに移行しても、ブランチ削除が成功する
- [ ] ブランチ削除前に自動的にベースブランチに切り替わる

### 機能要件

- [ ] 削除対象ブランチが現在のブランチかどうかを判定する
- [ ] 現在のブランチと削除対象が同一の場合、ベースブランチに自動切り替えする
- [ ] 切り替え後にローカル・リモートブランチを削除する
- [ ] 切り替え時に未コミット変更がある場合は警告を表示する

### 非機能要件

- [ ] プロンプトファースト原則に従い、TypeScript の変更は最小限に抑える
- [ ] 既存の `deleteLocalBranch()` 関数の後方互換性を維持する

---

## 4. 制約条件

- プロンプトファースト原則: 可能な限り .md ファイルでロジックを実装
- 後方互換性: 既存 API の型シグネチャは変更しない
- Git の制限: 現在チェックアウト中のブランチは削除不可（Git の仕様）
- エラーハンドリング: ブランチ削除失敗時も Issue クローズ処理は継続

---

## 5. 依存関係

- `src/slash-commands/spec-phase.md` - completed フェーズ移行のフロー定義
- `src/core/workflow/branch-cleanup.ts` - ブランチ削除の低レベル実装
- `src/integrations/github/pr-cleanup.ts` - PR マージ後の後処理
- `src/core/git/branch-switching.ts` - ブランチ切り替えロジック（既存）
- `src/core/git/branch-cache.ts` - 現在のブランチ取得（既存）

---

## 6. 参考情報

- 仕様書 2feaa5bf-2257-4c65-a4c0-0e770274a811: CI が失敗する PR が作成される（完了時に問題発生）
- `src/core/git/branch-switching.ts`: 既存のブランチ切り替え実装（参考パターン）
- Git ドキュメント: `git branch -D` は現在のブランチには使用不可

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
/cft:spec-phase $SPEC_ID completed
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│  spec-phase.md (プロンプト層)                                │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  Step 8: completed フェーズ移行処理                          │
│    │                                                        │
│    ├─ 8.0 [NEW] 現在のブランチを確認                         │
│    │     └─ git rev-parse --abbrev-ref HEAD                 │
│    │                                                        │
│    ├─ 8.1 [NEW] 削除対象ブランチと同一か判定                  │
│    │     └─ $CURRENT_BRANCH == $BRANCH_NAME ?               │
│    │                                                        │
│    ├─ 8.2 [NEW] 同一の場合: ベースブランチに切り替え          │
│    │     ├─ 未コミット変更チェック (git status --porcelain)  │
│    │     │     └─ 変更あり → 警告表示 + 自動コミット         │
│    │     └─ git checkout $BASE_BRANCH                       │
│    │                                                        │
│    └─ 8.3 DB 更新 + イベント発火                             │
│          └─ npx tsx update-phase.ts                         │
└─────────────────────────────────────────────────────────────┘
       │
       ▼ spec.phase_changed イベント
┌─────────────────────────────────────────────────────────────┐
│  github-integration.ts (TypeScript 層)                      │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  cleanupMergedPullRequest()                                 │
│    ├─ deleteLocalBranch()   ← 既に別ブランチにいるので成功   │
│    ├─ deleteRemoteBranch()                                  │
│    ├─ DB 更新                                               │
│    └─ GitHub Issue クローズ                                  │
└─────────────────────────────────────────────────────────────┘
```

#### 設計方針

1. **プロンプトファースト原則の適用**
   - ブランチ切り替えロジックは `spec-phase.md` で実装
   - TypeScript 層（`branch-cleanup.ts`）は変更不要
   - 既存の `deleteLocalBranch()` 関数はそのまま利用

2. **最小限の変更**
   - `spec-phase.md` の Step 8（completed フェーズ移行時）に処理を追加
   - 新しい TypeScript ファイルの作成は不要

3. **後方互換性の維持**
   - 既存の API シグネチャは変更しない
   - ベースブランチにいる状態で実行した場合も正常動作

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/slash-commands/spec-phase.md` | Step 8 に「現在ブランチ確認 → 自動切り替え」ロジックを追加 |

#### 処理フロー詳細

**Step 8.0: 現在のブランチを確認**

```bash
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo "現在のブランチ: $CURRENT_BRANCH"
echo "削除対象ブランチ: $BRANCH_NAME"
```

**Step 8.1: 削除対象ブランチと同一か判定**

```bash
if [ "$CURRENT_BRANCH" = "$BRANCH_NAME" ]; then
  echo "⚠️ 現在のブランチが削除対象です。ベースブランチに切り替えます..."
  # Step 8.2 へ
else
  echo "✓ 別ブランチにいます。そのまま処理を続行します。"
  # Step 8.3 へ
fi
```

**Step 8.2: ベースブランチへの自動切り替え**

```bash
# 未コミット変更チェック
if [ -n "$(git status --porcelain)" ]; then
  echo "⚠️ 未コミットの変更があります"
  git status --short
  echo ""
  echo "変更を自動コミットします..."
  git add -A
  git commit -m "chore: completed フェーズ移行前の自動コミット"
fi

# ベースブランチに切り替え
git checkout "$BASE_BRANCH"
echo "✓ $BASE_BRANCH に切り替えました"
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| 現在ブランチ確認 | なし | `git rev-parse --abbrev-ref HEAD` | spec-phase.md Step 8.0 |
| ブランチ同一判定 | なし | `$CURRENT_BRANCH == $BRANCH_NAME` | spec-phase.md Step 8.1 |
| 自動切り替え | なし | `git checkout $BASE_BRANCH` | spec-phase.md Step 8.2 |
| 未コミット変更処理 | なし | `git status --porcelain` + 自動コミット | spec-phase.md Step 8.2 |
| ブランチ削除 | `deleteLocalBranch()` | 変更なし | branch-cleanup.ts |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| 同一ブランチ判定 | 作業ブランチにいる状態で completed 移行 | 手動テスト: ブランチ削除が成功することを確認 |
| 別ブランチ判定 | develop にいる状態で completed 移行 | 手動テスト: 従来通り動作することを確認 |
| 未コミット変更処理 | 変更がある状態で completed 移行 | 手動テスト: 自動コミット + 切り替えが成功することを確認 |
| エラーハンドリング | ベースブランチが存在しない場合 | 手動テスト: 適切なエラーメッセージが表示されることを確認 |

### 7.5 移行計画

#### Phase 1: spec-phase.md の修正

1. Step 8（completed フェーズ移行時）の先頭に以下を追加:
   - Step 8.0: 現在のブランチ確認
   - Step 8.1: 削除対象ブランチとの同一判定
   - Step 8.2: ベースブランチへの自動切り替え（条件付き）

2. 既存の Step 8 の処理内容を Step 8.3 以降に移動

#### Phase 2: 動作確認

1. 同期: `npm run sync:dogfood`
2. 型チェック・リント: `npm run typecheck && npm run lint`
3. 手動テスト: 作業ブランチにいる状態で `/cft:spec-phase <spec-id> completed` を実行

---

## 8. 実装タスクリスト

### Phase 1: spec-phase.md の修正

- [x] Step 8.0 追加: 現在のブランチを確認する処理を追加 (#776)
- [x] Step 8.1 追加: 削除対象ブランチとの同一判定ロジックを追加 (#777)
- [x] Step 8.2 追加: ベースブランチへの自動切り替え処理を追加（未コミット変更の自動コミット含む） (#778)
- [x] 既存 Step 8 の処理を Step 8.3 以降にリナンバリング (#779)

### Phase 2: 動作確認

- [x] npm run sync:dogfood で同期 (#780)
- [x] npm run typecheck && npm run lint で品質チェック (#781)
- [x] 手動テスト: 作業ブランチで completed 移行が成功することを確認 (#782)
