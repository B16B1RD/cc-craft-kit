# データベースと GitHub Issue の同期がとれていない

**仕様書 ID:** 0924a344-7a2b-496c-9533-14d52e342a15
**フェーズ:** completed
**作成日時:** 2025/11/17 10:30:07
**更新日時:** 2025/11/17 11:14:47

---

## 1. 背景と目的

### 背景

cc-craft-kit では、仕様書と GitHub Issue の同期状態を`github_sync`テーブルで管理している。このテーブルには`entity_type`カラムがあり、仕様書(`spec`)、タスク(`task`)、Issue(`issue`)、プロジェクト(`project`)などのエンティティタイプを区別する設計になっている。

しかし、実装を調査した結果、以下の問題が発見された：

1. **`entity_type`の誤使用**: 仕様書と Issue を同期する際、`entity_type`に`'spec'`を設定すべきところを、すべて`'issue'`と記録している
2. **19件すべての仕様書で不整合**: 全 19 件の仕様書に`github_issue_id`が設定されているが、`github_sync`テーブルには対応する`entity_type='spec'`のレコードが存在しない
3. **複数箇所での同じバグ**: 以下 3 つのファイルで同じ誤りが存在
   - `src/commands/github/issue-create.ts:146`
   - `src/core/workflow/github-integration.ts:117`
   - `src/integrations/github/sync.ts:313`

### 目的

`github_sync`テーブルの`entity_type`を正しく使用し、仕様書と GitHub Issue の同期状態を正確に追跡できるようにする。

---

## 2. 対象ユーザー

- cc-craft-kit 開発者
- cc-craft-kit を使用して仕様駆動開発を行う開発チーム

---

## 3. 受け入れ基準

### 必須要件

- [ ] `entity_type='spec'`として同期レコードが記録されること
- [ ] 既存の 19 件の不整合レコードが正しい`entity_type`に修正されること
- [ ] 新規仕様書作成時に正しい`entity_type`でレコードが作成されること

### 機能要件

- [ ] `src/commands/github/issue-create.ts`の`entity_type`を`'issue'`から`'spec'`に修正
- [ ] `src/core/workflow/github-integration.ts`の`entity_type`を`'issue'`から`'spec'`に修正
- [ ] `src/integrations/github/sync.ts`の`entity_type`を`'issue'`から`'spec'`に修正
- [ ] 既存レコードを`entity_type='spec'`に一括更新するマイグレーションスクリプトを作成
- [ ] マイグレーション実行後、不整合チェックスクリプトでゼロ件になることを確認

### 非機能要件

- [ ] マイグレーションはべき等性を保証すること（複数回実行しても問題ないこと）
- [ ] マイグレーション実行前にバックアップを取得すること
- [ ] テストケースを追加して、今後同じバグが発生しないようにすること

---

## 4. 制約条件

- `github_sync`テーブルのスキーマは変更しない（`entity_type`カラムの値のみ修正）
- 既存の GitHub Issue 番号や同期状態は維持すること
- ダウンタイムなしで修正できること

---

## 5. 依存関係

- データベーススキーマ: `src/core/database/schema.ts`
- GitHub 統合コード: `src/integrations/github/`配下のすべてのモジュール
- イベントバス: `src/core/workflow/event-bus.ts`

---

## 6. 参考情報

### 調査結果

#### データベース不整合の詳細

```bash
# github_sync テーブルには entity_type='issue' のレコードしか存在しない
$ npx tsx scripts/check-sync-status.ts

=== GitHub Sync Table ===
# すべてのレコードが entity_type='issue' になっている

=== Inconsistency Check ===
# 19件すべての仕様書で github_issue_id は設定されているが
# github_sync に対応する entity_type='spec' のレコードが存在しない
⚠️  Spec 68c7eecc (...) has github_issue_id=12 but NO github_sync record
⚠️  Spec 25698797 (...) has github_issue_id=11 but NO github_sync record
... (合計19件)
```

#### 問題のコード箇所

**1. `src/commands/github/issue-create.ts:146`**
```typescript
await db
  .insertInto('github_sync')
  .values({
    entity_type: 'issue',  // ❌ 誤り: 'spec' であるべき
    entity_id: spec.id,
    github_id: issue.number.toString(),
    last_synced_at: new Date().toISOString(),
    sync_status: 'success',
  })
  .execute();
```

**2. `src/core/workflow/github-integration.ts:117`**
```typescript
await db
  .insertInto('github_sync')
  .values({
    entity_type: 'issue',  // ❌ 誤り: 'spec' であるべき
    entity_id: spec.id,
    github_id: issue.number.toString(),
    last_synced_at: new Date().toISOString(),
    sync_status: 'success',
  })
  .execute();
```

**3. `src/integrations/github/sync.ts:313`**
```typescript
await this.db
  .insertInto('github_sync')
  .values({
    id: randomUUID(),
    entity_type: 'issue',  // ❌ 誤り: 'spec' であるべき
    entity_id: params.spec_id,
    github_id: params.github_issue_id.toString(),
    github_number: params.github_issue_id,
    last_synced_at: new Date().toISOString(),
    sync_status: params.status === 'success' ? 'success' : 'failed',
    error_message: params.status === 'error' ? JSON.stringify(params.details) : null,
  })
  .execute();
```

### スキーマ定義（参考）

`src/core/database/schema.ts`より:

```typescript
export type GitHubEntityType = 'spec' | 'task' | 'issue' | 'project';

export interface GitHubSyncTable {
  id: Generated<string>;
  entity_type: GitHubEntityType;
  entity_id: string; // spec_id or task_id
  github_id: string; // GitHub Issue ID or Project ID
  github_number: number | null;
  last_synced_at: ColumnType<Date, string | undefined, string>;
  sync_status: 'success' | 'failed' | 'pending';
  error_message: string | null;
}
```

### 修正方針

1. **コード修正**: 3 箇所の`entity_type: 'issue'`を`entity_type: 'spec'`に変更
2. **データ修正**: マイグレーションスクリプトで既存レコードを更新
3. **テスト追加**: `entity_type`が正しく設定されることを確認するテストを追加
4. **ドキュメント更新**: `CLAUDE.md`にこの問題の教訓を記録

---

## 7. 設計

### 7.1 アーキテクチャ概要

この修正は 3 つのレイヤーに影響します：

```
┌─────────────────────────────────────┐
│  Commands Layer                     │
│  - issue-create.ts                  │  ← 修正対象1
├─────────────────────────────────────┤
│  Workflow Layer                     │
│  - github-integration.ts            │  ← 修正対象2
├─────────────────────────────────────┤
│  Integration Layer                  │
│  - sync.ts                          │  ← 修正対象3
├─────────────────────────────────────┤
│  Database Layer                     │
│  - github_sync テーブル              │  ← マイグレーション対象
└─────────────────────────────────────┘
```

### 7.2 コード修正設計

#### 7.2.1 `src/commands/github/issue-create.ts`

**修正箇所**: 行 146

**変更前:**
```typescript
await db
  .insertInto('github_sync')
  .values({
    entity_type: 'issue',  // ❌
    entity_id: spec.id,
    github_id: issue.number.toString(),
    last_synced_at: new Date().toISOString(),
    sync_status: 'success',
  })
  .execute();
```

**変更後:**
```typescript
await db
  .insertInto('github_sync')
  .values({
    entity_type: 'spec',  // ✅ 修正
    entity_id: spec.id,
    github_id: issue.number.toString(),
    last_synced_at: new Date().toISOString(),
    sync_status: 'success',
  })
  .execute();
```

#### 7.2.2 `src/core/workflow/github-integration.ts`

**修正箇所**: 行 117

**変更前:**
```typescript
await db
  .insertInto('github_sync')
  .values({
    entity_type: 'issue',  // ❌
    entity_id: spec.id,
    github_id: issue.number.toString(),
    last_synced_at: new Date().toISOString(),
    sync_status: 'success',
  })
  .execute();
```

**変更後:**
```typescript
await db
  .insertInto('github_sync')
  .values({
    entity_type: 'spec',  // ✅ 修正
    entity_id: spec.id,
    github_id: issue.number.toString(),
    last_synced_at: new Date().toISOString(),
    sync_status: 'success',
  })
  .execute();
```

#### 7.2.3 `src/integrations/github/sync.ts`

**修正箇所**: 行 313（`recordSyncLog`メソッド内）

**変更前:**
```typescript
await this.db
  .insertInto('github_sync')
  .values({
    id: randomUUID(),
    entity_type: 'issue',  // ❌
    entity_id: params.spec_id,
    github_id: params.github_issue_id.toString(),
    github_number: params.github_issue_id,
    last_synced_at: new Date().toISOString(),
    sync_status: params.status === 'success' ? 'success' : 'failed',
    error_message: params.status === 'error' ? JSON.stringify(params.details) : null,
  })
  .execute();
```

**変更後:**
```typescript
await this.db
  .insertInto('github_sync')
  .values({
    id: randomUUID(),
    entity_type: 'spec',  // ✅ 修正
    entity_id: params.spec_id,
    github_id: params.github_issue_id.toString(),
    github_number: params.github_issue_id,
    last_synced_at: new Date().toISOString(),
    sync_status: params.status === 'success' ? 'success' : 'failed',
    error_message: params.status === 'error' ? JSON.stringify(params.details) : null,
  })
  .execute();
```

### 7.3 データマイグレーション設計

#### 7.3.1 マイグレーションスクリプト

**ファイル名**: `scripts/migrate-github-sync-entity-type.ts`

**処理フロー**:
1. データベースバックアップ作成（`.cc-craft-kit/cc-craft-kit.db.backup-YYYYMMDD-HHmmss`）
2. 現在の不整合状態を確認・表示
3. `entity_type='issue'`かつ`entity_id`が仕様書 ID のレコードを特定
4. 対象レコードを`entity_type='spec'`に一括更新
5. 更新件数を表示
6. 不整合チェックを再実行（ゼロ件を期待）

**べき等性の保証**:
- 既に`entity_type='spec'`のレコードは更新しない
- `WHERE entity_type = 'issue' AND entity_id IN (...)`条件を使用
- 複数回実行しても安全

**SQL例**:
```typescript
// 仕様書IDのリストを取得
const specIds = await db
  .selectFrom('specs')
  .select('id')
  .execute();

const specIdList = specIds.map(s => s.id);

// entity_type を 'spec' に更新
const result = await db
  .updateTable('github_sync')
  .set({
    entity_type: 'spec',
    last_synced_at: new Date().toISOString()
  })
  .where('entity_type', '=', 'issue')
  .where('entity_id', 'in', specIdList)
  .execute();

console.log(`Updated ${result.numUpdatedRows} records`);
```

#### 7.3.2 実行手順

```bash
# 1. バックアップ確認
ls -lh .cc-craft-kit/cc-craft-kit.db*

# 2. マイグレーション実行
npx tsx scripts/migrate-github-sync-entity-type.ts

# 3. 不整合チェック
npx tsx scripts/check-sync-status.ts
# 期待結果: "=== Inconsistency Check ===" セクションに警告ゼロ件
```

### 7.4 テスト設計

#### 7.4.1 単体テスト

**ファイル名**: `tests/integrations/github/sync.test.ts`

**テストケース**:
1. `GitHubSyncService.recordSyncLog` が `entity_type='spec'` を正しく記録すること
2. Issue 作成時に `entity_type='spec'` の同期レコードが作成されること
3. 仕様書 ID と一致する `entity_id` が記録されること

**モック対象**:
- データベース（Kysely）
- GitHub API クライアント

#### 7.4.2 統合テスト

**ファイル名**: `tests/integration/github-sync.integration.test.ts`

**テストシナリオ**:
1. 仕様書作成 → GitHub Issue 自動作成 → `github_sync`テーブル確認
2. `entity_type='spec'` であること
3. `entity_id` が仕様書 ID と一致すること
4. `sync_status='success'` であること

#### 7.4.3 マイグレーションテスト

**ファイル名**: `tests/scripts/migrate-github-sync.test.ts`

**テストケース**:
1. マイグレーション前の不整合状態を再現
2. マイグレーション実行
3. 不整合がゼロ件になることを確認
4. べき等性確認（2 回目実行しても問題ないこと）

### 7.5 エラーハンドリング設計

#### 7.5.1 マイグレーション失敗時

- バックアップファイルからリストア手順を表示
- エラー詳細をログ出力
- 終了コード 1 で終了

#### 7.5.2 コード修正後の動作確認

- 新規仕様書作成時にエラーが発生した場合、ロールバック不要（Issue 作成は成功）
- 警告メッセージで手動同期を案内

### 7.6 ドキュメント更新設計

#### 7.6.1 `CLAUDE.md` への教訓追加

**追加セクション**: "## トラブルシューティング > GitHub 同期エラー"

**内容**:
- `entity_type` の正しい使い方
- 仕様書 = `'spec'`、タスク = `'task'`
- Issue や Project は別の概念であることを明記
- 同期レコード作成時のチェックリスト

#### 7.6.2 コメント追加

各修正箇所に以下のコメントを追加:
```typescript
// 仕様書とIssueの同期記録
// entity_type は 'spec' を使用（'issue' ではない）
entity_type: 'spec',
```

### 7.7 実装順序

1. **コード修正** (src/)
   - `src/commands/github/issue-create.ts:146`
   - `src/core/workflow/github-integration.ts:117`
   - `src/integrations/github/sync.ts:313`

2. **マイグレーションスクリプト作成** (scripts/)
   - `scripts/migrate-github-sync-entity-type.ts`

3. **テストケース作成** (tests/)
   - `tests/integrations/github/sync.test.ts`
   - `tests/integration/github-sync.integration.test.ts`

4. **ドキュメント更新**
   - `CLAUDE.md` に教訓追加

5. **ビルド & 同期**
   - `npm run build`
   - `npm run sync:dogfood`

6. **マイグレーション実行**
   - バックアップ作成
   - `npx tsx scripts/migrate-github-sync-entity-type.ts`
   - 不整合チェック

7. **動作確認**
   - 新規仕様書作成テスト
   - GitHub Issue 作成テスト
   - 同期レコード確認

### 7.8 影響範囲分析

#### 7.8.1 影響を受けるコンポーネント

- ✅ GitHub Issue 作成機能
- ✅ GitHub Issue 同期機能
- ✅ イベントバス（`spec.created`）
- ❌ タスク機能（影響なし）
- ❌ GitHub Projects 機能（影響なし）
- ❌ その他の機能（影響なし）

#### 7.8.2 破壊的変更

なし。既存の GitHub Issue 番号や同期状態は維持される。

#### 7.8.3 ダウンタイム

不要。マイグレーションは数秒で完了する見込み。

---

## 8. タスク分解

### タスク一覧

#### タスク1: コード修正 - issue-create.ts
- **ファイル**: `src/commands/github/issue-create.ts`
- **行番号**: 146
- **内容**: `entity_type: 'issue'` を `entity_type: 'spec'` に変更
- **工数**: 5 分
- **依存**: なし
- **優先度**: 高

#### タスク2: コード修正 - github-integration.ts
- **ファイル**: `src/core/workflow/github-integration.ts`
- **行番号**: 117
- **内容**: `entity_type: 'issue'` を `entity_type: 'spec'` に変更
- **工数**: 5 分
- **依存**: なし
- **優先度**: 高

#### タスク3: コード修正 - sync.ts
- **ファイル**: `src/integrations/github/sync.ts`
- **行番号**: 313
- **内容**: `entity_type: 'issue'` を `entity_type: 'spec'` に変更
- **工数**: 5 分
- **依存**: なし
- **優先度**: 高

#### タスク4: マイグレーションスクリプト作成
- **ファイル**: `scripts/migrate-github-sync-entity-type.ts`
- **内容**:
  - データベースバックアップ機能
  - 不整合チェック機能
  - entity_type 一括更新機能
  - べき等性保証
- **工数**: 1 時間
- **依存**: なし
- **優先度**: 高

#### タスク5: ビルド & 同期
- **コマンド**: `npm run build && npm run sync:dogfood`
- **内容**: ソースコード修正後のビルドとドッグフーディング環境への同期
- **工数**: 10 分
- **依存**: タスク 1, 2, 3
- **優先度**: 高

#### タスク6: マイグレーション実行
- **コマンド**: `npx tsx scripts/migrate-github-sync-entity-type.ts`
- **内容**: 既存 19 件のレコードを修正
- **工数**: 5 分
- **依存**: タスク 4, 5
- **優先度**: 高

#### タスク7: 不整合チェック
- **コマンド**: `npx tsx scripts/check-sync-status.ts`
- **内容**: マイグレーション後の検証（警告ゼロ件を期待）
- **工数**: 5 分
- **依存**: タスク 6
- **優先度**: 高

#### タスク8: 単体テスト作成
- **ファイル**: `tests/integrations/github/sync.test.ts`
- **内容**:
  - `entity_type='spec'` 検証テスト
  - モックを使用した単体テスト
- **工数**: 30 分
- **依存**: タスク 5
- **優先度**: 中

#### タスク9: 統合テスト作成
- **ファイル**: `tests/integration/github-sync.integration.test.ts`
- **内容**:
  - 仕様書作成→Issue 自動作成→同期レコード確認
  - E2E フローの検証
- **工数**: 45 分
- **依存**: タスク 5
- **優先度**: 中

#### タスク10: 動作確認テスト
- **内容**:
  - 新規仕様書作成
  - GitHub Issue 自動作成
  - `github_sync`テーブルで`entity_type='spec'`を確認
- **工数**: 15 分
- **依存**: タスク 6, 7
- **優先度**: 高

#### タスク11: ドキュメント更新
- **ファイル**: `CLAUDE.md`
- **内容**:
  - トラブルシューティングセクション追加
  - `entity_type`の正しい使い方を記載
  - 教訓を記録
- **工数**: 20 分
- **依存**: タスク 10
- **優先度**: 中

### タスク依存関係図

```
タスク1, 2, 3 (コード修正)
    ↓
タスク5 (ビルド & 同期)
    ↓                    ↘
タスク4 (マイグレーション    タスク8, 9 (テスト作成)
       スクリプト作成)
    ↓
タスク6 (マイグレーション実行)
    ↓
タスク7 (不整合チェック)
    ↓
タスク10 (動作確認)
    ↓
タスク11 (ドキュメント更新)
```

### 工数見積もり

| タスクカテゴリ | 工数 |
|---|---|
| コード修正 (1-3) | 15分 |
| マイグレーション (4, 6, 7) | 1時間10分 |
| ビルド & 同期 (5) | 10分 |
| テスト (8, 9, 10) | 1時間30分 |
| ドキュメント (11) | 20分 |
| **合計** | **約3時間25分** |

### 実装の順序（推奨）

1. **フェーズ1: コード修正** (15 分)
   - タスク 1, 2, 3 を並行実行

2. **フェーズ2: ビルド** (10 分)
   - タスク 5 を実行

3. **フェーズ3: マイグレーション準備** (1 時間)
   - タスク 4 を実行

4. **フェーズ4: データ修正** (10 分)
   - タスク 6, 7 を順次実行

5. **フェーズ5: 動作確認** (15 分)
   - タスク 10 を実行

6. **フェーズ6: テスト & ドキュメント** (1 時間 50 分)
   - タスク 8, 9, 11 を並行実行可能

### リスク管理

| リスク | 影響 | 対策 |
|---|---|---|
| マイグレーション失敗 | データ不整合継続 | バックアップから即座にリストア |
| コード修正漏れ | 新規レコードで再発 | テストケースで検出 |
| 既存Issueへの影響 | Issue番号の変更 | マイグレーションではIssue番号を変更しない設計 |
