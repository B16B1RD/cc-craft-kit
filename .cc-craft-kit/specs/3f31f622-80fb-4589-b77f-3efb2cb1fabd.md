# 存在しないフェーズ testing が案内されることがある

**仕様書 ID:** 3f31f622-80fb-4589-b77f-3efb2cb1fabd
**フェーズ:** design
**作成日時:** 2025/11/24 15:58:07
**更新日時:** 2025/11/25 11:13:45

---

## 1. 背景と目的

### 背景

現在、ユーザーが `/cft:spec-phase` コマンドで `testing` フェーズへの遷移を試みると、以下の問題が発生します:

1. **GitHub Project ステータスマッピングの不完全性**: `src/integrations/github/phase-status-mapper.ts` の `Phase` 型定義に `testing` フェーズが含まれておらず、`mapPhaseToStatus()` 関数のマッピングにも欠落している
2. **次ステップガイダンスの欠落**: `src/commands/spec/phase.ts` の `switch` 文に `testing` ケースが実装されていない
3. **ドキュメントと実装の乖離**: 仕様書 (`spec-phase.md`) では `testing` フェーズが公式に案内されているが、実装は不完全

この問題により、ユーザーが `testing` フェーズに遷移しても適切なガイダンスが表示されず、GitHub Project のステータス更新時にエラーが発生する可能性があります。

### 目的

`testing` フェーズをサポートするための実装を完全化し、ドキュメントと実装の一貫性を確保します。具体的には:

1. `phase-status-mapper.ts` の `Phase` 型定義とマッピングに `testing` フェーズを追加
2. `src/commands/spec/phase.ts` に `testing` フェーズのガイダンスを追加
3. テストケースを追加して、将来のリグレッションを防止
4. ドキュメントの正確性を検証

---

## 2. 対象ユーザー

- **cc-craft-kit を使用する開発者**: `/cft:spec-phase` コマンドで `testing` フェーズへの遷移を試みるユーザー
- **開発キット保守担当者**: フェーズ定義の一貫性を保つ必要がある開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `src/integrations/github/phase-status-mapper.ts` の `Phase` 型定義に `testing` フェーズを追加
- [ ] `mapPhaseToStatus()` 関数のマッピングに `testing` フェーズを追加（`'In Progress'` にマッピング）
- [ ] `src/commands/spec/phase.ts` の `switch` 文に `testing` ケースを追加
- [ ] `testing` フェーズのガイダンスメッセージを実装（テスト生成・実行、カバレッジ確認、`completed` フェーズへの遷移案内）

### 機能要件

- [ ] `/cft:spec-phase <id> testing` コマンドが正常に実行される
- [ ] `testing` フェーズへの遷移後、適切なガイダンスメッセージが表示される
- [ ] GitHub Project のステータスが正しく更新される（`In Progress`）
- [ ] テストケース（`phase-status-mapper.test.ts`）に `testing` フェーズのテストを追加

### 非機能要件

- [ ] 既存のフェーズ遷移に影響を与えない（`requirements`, `design`, `tasks`, `implementation`, `completed`）
- [ ] 型安全性が保たれている（TypeScript の型チェックでエラーが出ない）
- [ ] テストカバレッジが維持される（追加されたコードがテストでカバーされる）

---

## 4. 制約条件

- **TypeScript の型安全性**: `Phase` 型定義の変更は、すべての型依存箇所に影響します（`mapPhaseToStatus()`, `validatePhase()`, テストケースなど）
- **後方互換性**: 既存のフェーズ定義（`requirements`, `design`, `tasks`, `implementation`, `completed`）は変更しません
- **GitHub Project 統合**: `testing` フェーズは GitHub Project の `In Progress` ステータスにマッピングされます
- **テストカバレッジ**: 追加されたコードは単体テストでカバーする必要があります（カバレッジ目標 80%以上）

---

## 5. 依存関係

### 修正対象ファイル

1. **`src/integrations/github/phase-status-mapper.ts`** (最重要)
   - `Phase` 型定義に `testing` フェーズを追加
   - `mapPhaseToStatus()` 関数のマッピングに `testing: 'In Progress'` を追加

2. **`src/commands/spec/phase.ts`** (205-239行)
   - `switch` 文に `testing` ケースを追加
   - ガイダンスメッセージの実装

3. **`tests/integrations/github/phase-status-mapper.test.ts`** (26-34行)
   - `testing` フェーズのテストケースを追加

### 関連コンポーネント

- **フェーズ定義**: `src/core/database/schema.ts` (SpecPhase 型)
- **フェーズバリデーション**: `src/commands/utils/validation.ts` (VALID_PHASES)
- **GitHub 統合**: `src/core/workflow/github-integration.ts` (252行目で `mapPhaseToStatus()` を使用)
- **フェーズ自動処理**: `src/core/workflow/phase-automation.ts`

---

## 6. 参考情報

### 実装パターン

- **フェーズ定義の一貫性**: すべてのフェーズ定義ファイルで同じフェーズリストを使用すること
- **型安全性の確保**: `Phase` 型定義を更新したら、型依存箇所をすべて確認すること
- **テスト駆動開発**: テストケースを追加してから実装を修正すること

### コードベース解析結果

Explore サブエージェントで調査した結果、以下の問題が特定されました:

1. `phase-status-mapper.ts` の `Phase` 型定義に `testing` が欠落
2. `src/commands/spec/phase.ts` の `switch` 文に `testing` ケースが未実装
3. テストケース（`phase-status-mapper.test.ts`）で `testing` フェーズが検証されていない

詳細は、Explore サブエージェントの分析レポートを参照してください。

### 関連ドキュメント

- **CLAUDE.md**: プロジェクト規約（スクリプトとプロンプトの使い分け指針）
- **src/slash-commands/spec-phase.md**: ユーザー向けフェーズ遷移ガイド（`testing` フェーズが案内されている）

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
フェーズ定義の一貫性確保

┌─────────────────────────────────────────────────────────────────────┐
│                          フェーズ管理レイヤー                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  src/core/database/schema.ts         ← SpecPhase 型（testing 含む）   │
│            ↓                                                        │
│  src/commands/utils/validation.ts    ← VALID_PHASES（testing 含む）   │
│            ↓                                                        │
│  src/core/workflow/phase-mapping.ts  ← PHASE_ALIASES（testing 対応）  │
│            ↓                                                        │
│  src/core/workflow/phase-automation.ts ← handleTestingPhase()        │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│                     【修正が必要なレイヤー】                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  src/integrations/github/phase-status-mapper.ts                     │
│  ❌ Phase 型に testing が欠落                                        │
│  ❌ mapPhaseToStatus() のマッピングに testing が欠落                  │
│            ↓                                                        │
│  src/commands/spec/phase.ts                                         │
│  ❌ switch 文に testing ケースが未実装                                │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│                         GitHub 統合レイヤー                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  src/core/workflow/github-integration.ts                            │
│  → mapPhaseToStatus() を呼び出し（252行目）                          │
│  → Phase 型更新で自動的に対応                                        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

#### 設計方針

1. **既存アーキテクチャの不整合解消**: 新しいフェーズを追加するのではなく、既に定義済みの `testing` フェーズの実装を補完
2. **型安全性の活用**: `Record<Phase, ProjectStatus>` の型制約により、マッピング漏れは TypeScript コンパイラが検出
3. **最小変更の原則**: 修正範囲を 3 ファイルに限定し、既存機能への影響を最小化

#### 処理フロー詳細

```
ユーザー入力: /cft:spec-phase <id> testing
    │
    ▼
┌─────────────────────────────────────────┐
│ 1. フェーズ名の正規化                     │
│    phase-mapping.ts: normalizePhase()   │
│    'test' → 'testing' に変換            │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 2. フェーズバリデーション                  │
│    validation.ts: VALID_PHASES          │
│    'testing' が含まれるので OK           │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 3. DB 更新                              │
│    spec/update-phase.ts                 │
│    specs.phase = 'testing'              │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 4. GitHub Project ステータス更新         │
│    phase-status-mapper.ts:              │
│    mapPhaseToStatus('testing')          │
│    → 'In Progress' を返す【修正必要】    │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 5. フェーズ自動処理                       │
│    phase-automation.ts:                 │
│    handleTestingPhase()【実装済み】      │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 6. ユーザーガイダンス表示                  │
│    spec/phase.ts: switch 文              │
│    testing ケースを追加【修正必要】       │
└─────────────────────────────────────────┘
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/integrations/github/phase-status-mapper.ts` | `Phase` 型に `'testing'` を追加、マッピングに `testing: 'In Progress'` を追加 |
| `src/commands/spec/phase.ts` | `switch` 文に `case 'testing':` を追加、ガイダンスメッセージを実装 |
| `tests/integrations/github/phase-status-mapper.test.ts` | `testing` フェーズの個別テストと統合テストを追加 |

#### phase-status-mapper.ts の修正詳細

**現在の実装:**
```typescript
export type Phase = 'requirements' | 'design' | 'tasks' | 'implementation' | 'completed';

export function mapPhaseToStatus(phase: Phase): ProjectStatus {
  const mapping: Record<Phase, ProjectStatus> = {
    requirements: 'Todo',
    design: 'In Progress',
    tasks: 'In Progress',
    implementation: 'In Progress',
    completed: 'Done',
  };
  return mapping[phase];
}
```

**修正後:**
```typescript
export type Phase = 'requirements' | 'design' | 'tasks' | 'implementation' | 'testing' | 'completed';

export function mapPhaseToStatus(phase: Phase): ProjectStatus {
  const mapping: Record<Phase, ProjectStatus> = {
    requirements: 'Todo',
    design: 'In Progress',
    tasks: 'In Progress',
    implementation: 'In Progress',
    testing: 'In Progress',
    completed: 'Done',
  };
  return mapping[phase];
}
```

#### phase.ts のガイダンス追加

既存パターンに従い、以下のガイダンスを追加:

```typescript
case 'testing':
  console.log('  • テストを生成・実行してください');
  console.log('  • カバレッジを確認してください');
  console.log('  • 完了後: /cft:spec-phase ' + spec.id.substring(0, 8) + ' completed');
  break;
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| Phase 型定義 | 5 フェーズのみ | 6 フェーズ（testing 追加） | `phase-status-mapper.ts:5` |
| ステータスマッピング | testing 未対応 | `testing: 'In Progress'` | `phase-status-mapper.ts:mapPhaseToStatus()` |
| ガイダンス表示 | testing ケースなし | testing ケース追加 | `phase.ts:switch文` |
| テストケース | testing 未検証 | testing テスト追加 | `phase-status-mapper.test.ts` |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| `mapPhaseToStatus('testing')` | `'In Progress'` を返すこと | Jest の `expect().toBe()` |
| 統合テスト | すべてのフェーズがマッピングされていること | `phases` 配列に `testing` を追加して全フェーズをループ |
| 型安全性 | TypeScript コンパイルエラーがないこと | `npm run typecheck` |

#### テストコード追加

```typescript
// 個別テスト
it('testing フェーズは In Progress にマッピングされる', () => {
  expect(mapPhaseToStatus('testing')).toBe('In Progress');
});

// 統合テスト（phases 配列を更新）
const phases: Phase[] = ['requirements', 'design', 'tasks', 'implementation', 'testing', 'completed'];
```

### 7.5 移行計画

#### Phase 1: 型定義とマッピングの修正

1. `phase-status-mapper.ts` の `Phase` 型に `'testing'` を追加
2. `mapPhaseToStatus()` のマッピングに `testing: 'In Progress'` を追加
3. `npm run typecheck` で型エラーがないことを確認

#### Phase 2: ガイダンス実装

1. `phase.ts` の `switch` 文に `case 'testing':` を追加
2. テスト生成・実行、カバレッジ確認、completed への遷移を案内

#### Phase 3: テスト追加

1. `phase-status-mapper.test.ts` に個別テストを追加
2. 統合テストの `phases` 配列を更新
3. `npm test` で全テストが通ることを確認

#### Phase 4: 動作確認

1. `/cft:spec-phase <id> testing` を実行
2. GitHub Project のステータスが `In Progress` に更新されることを確認
3. 適切なガイダンスメッセージが表示されることを確認
