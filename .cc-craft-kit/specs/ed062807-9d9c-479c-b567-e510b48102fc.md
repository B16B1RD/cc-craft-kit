# CLI コマンドの見直し

**仕様書 ID:** ed062807-9d9c-479c-b567-e510b48102fc
**フェーズ:** completed
**作成日時:** 2025/11/16 14:36:47
**更新日時:** 2025/11/17 01:01:28

---

## 1. 背景と目的

### 背景

Takumi は当初、CLI コマンド（`takumi` コマンド）とカスタムスラッシュコマンド（`/cft:*`）の両方を提供していたが、実際の利用形態として Claude Code 上でのカスタムスラッシュコマンドのみが想定されている。CLI コマンドは以下の理由で不要と判断:

- **主要な利用環境**: Claude Code のチャット UI 上でのカスタムスラッシュコマンド実行
- **ユーザー数**: 現在のユーザーは開発者のみ（1 名）で、既存ユーザーへの影響なし
- **メンテナンスコスト**: CLI とスラッシュコマンドの二重メンテナンスは非効率
- **コードベースの簡素化**: CLI レイヤーを削除することでコードベースを大幅に簡素化可能

### 目的

1. **CLI コマンド全体を廃止**し、カスタムスラッシュコマンド（`/cft:*`）に完全移行する
2. **コードベースを簡素化**し、メンテナンス性を向上させる
3. **ユーザー体験を統一**し、Claude Code での利用に最適化する
4. **将来的な拡張性を向上**させ、スラッシュコマンドベースの機能開発に集中する

---

## 2. 対象ユーザー

- Takumi 開発者（現在は 1 名のみ）
- 将来的に Takumi を利用する Claude Code ユーザー

**影響を受けるユーザー**: なし（既存の外部ユーザーは存在しない）

---

## 3. 受け入れ基準

### 必須要件

- [ ] すべてのカスタムスラッシュコマンドが正常に動作する（CLI 経由での実行）
- [ ] CLI エントリーポイント（`src/cli/index.ts`）を削除
- [ ] `package.json` の `bin` フィールドを削除
- [ ] `npm start` コマンドを削除または用途変更
- [ ] README.md および関連ドキュメントから CLI コマンドの記述を削除

### 機能要件

- [ ] カスタムスラッシュコマンドが CLI コマンドロジックを直接呼び出す構造に変更
- [ ] 以下のスラッシュコマンドが引き続き動作する:
  - `/cft:init` - プロジェクト初期化
  - `/cft:status` - プロジェクト状況表示
  - `/cft:spec-create` - 仕様書作成
  - `/cft:spec-list` - 仕様書一覧
  - `/cft:spec-get` - 仕様書詳細
  - `/cft:spec-phase` - フェーズ更新
  - `/cft:github-init` - GitHub 統合初期化
  - `/cft:github-issue-create` - Issue 作成
  - `/cft:github-sync` - GitHub 同期
  - `/cft:github-project-add` - Project 追加
  - `/cft:knowledge-progress` - 進捗記録
  - `/cft:knowledge-error` - エラー解決策記録
  - `/cft:knowledge-tip` - Tips 記録

### 非機能要件

- [ ] 既存のテストが引き続き通過する
- [ ] コードカバレッジが低下しない（80%以上を維持）
- [ ] ビルドサイズが削減される（CLI レイヤー削除による）
- [ ] ドキュメントが最新の状態に更新される

---

## 4. 制約条件

- **既存ユーザーへの影響**: なし（開発者のみが使用）
- **段階的移行の必要性**: なし（一度に全廃止可能）
- **後方互換性**: 不要（破壊的変更として実施）
- **リリースタイミング**: 次のマイナーバージョン（v0.2.0）で実施

---

## 5. 依存関係

### 関連仕様書

- **#11 カスタムスラッシュコマンドで案内するカスタムスラッシュコマンドの表記を改善** (completed)
  - CLI 出力内のコマンド表示を `/cft:` 形式に統一済み
  - この仕様書の前提条件として完了

### 技術的依存関係

- カスタムスラッシュコマンドの実装（`.claude/commands/takumi/`）
- コアロジック層（`src/core/`）は維持
- データベース層（`src/core/database/`）は維持
- GitHub 統合層（`src/integrations/github/`）は維持

---

## 6. 実装計画

### Phase 1: 準備（Design フェーズ）

1. **アーキテクチャ設計の見直し**
   - CLI レイヤーを削除した後のアーキテクチャ図作成
   - スラッシュコマンドから直接コアロジックを呼び出す設計

2. **影響範囲の調査**
   - 削除対象ファイルのリストアップ
   - スラッシュコマンドの修正箇所の特定

### Phase 2: 実装（Implementation フェーズ）

1. **スラッシュコマンドのリファクタリング**
   - `.claude/commands/takumi/*.md` を修正
   - CLI コマンド呼び出しから、コアロジック直接呼び出しに変更

2. **CLI レイヤーの削除**
   - `src/cli/` ディレクトリ全体を削除
   - `package.json` の `bin` フィールド削除
   - `npm start` スクリプトの削除

3. **テストの修正**
   - CLI テストを削除
   - コアロジックのテストは維持
   - スラッシュコマンドの統合テスト追加

4. **ドキュメントの更新**
   - README.md から CLI コマンドの記述を削除
   - QUICK_START.md をスラッシュコマンドのみに変更
   - CLAUDE.md の「よく使うコマンド」セクション更新

### Phase 3: 検証（Review）

1. **動作確認**
   - すべてのスラッシュコマンドが正常動作することを確認
   - エラーハンドリングが適切に動作することを確認

2. **テスト実行**
   - `npm test` が全て通過することを確認
   - カバレッジが 80% 以上を維持していることを確認

3. **ビルド確認**
   - `npm run build` が成功することを確認
   - ビルドサイズが削減されていることを確認

---

## 7. 削除対象ファイル（予定）

```
src/cli/
├── index.ts                         # CLI エントリーポイント
├── commands/
│   ├── init.ts                      # プロジェクト初期化
│   ├── status.ts                    # ステータス表示
│   ├── spec/
│   │   ├── create.ts                # 仕様書作成
│   │   ├── list.ts                  # 仕様書一覧
│   │   ├── get.ts                   # 仕様書取得
│   │   └── phase.ts                 # フェーズ更新
│   ├── github/
│   │   ├── init.ts                  # GitHub 初期化
│   │   ├── issue-create.ts          # Issue 作成
│   │   ├── sync.ts                  # GitHub 同期
│   │   └── project-add.ts           # Project 追加
│   └── knowledge/
│       └── record.ts                # ナレッジベース記録
└── utils/
    ├── output.ts                    # CLI 出力ユーティリティ
    ├── validation.ts                # 引数バリデーション
    └── error-handler.ts             # CLI エラーハンドリング
```

**削減される LOC（推定）**: 約 2,000 行

---

## 8. 移行後のアーキテクチャ

```
┌─────────────────────────────────────────────┐
│  Slash Commands (.claude/commands/takumi/)  │  ← ユーザーインターフェース
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│        Core Modules (src/core/)             │  ← ビジネスロジック
│  - workflow/ (仕様書・タスク管理)               │
│  - database/ (データ永続化)                    │
│  - events/ (イベント駆動)                      │
│  - templates/ (テンプレート)                   │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│  Integrations (src/integrations/github/)    │  ← 外部連携
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│    Database Layer (Kysely + SQLite)         │  ← データ永続化
└─────────────────────────────────────────────┘
```

**利点**:
- レイヤーが削減され、シンプルな構造になる
- スラッシュコマンドから直接コアロジックを呼び出せる
- CLI 特有のエラーハンドリング・出力フォーマットが不要になる

---

## 9. リスクと対策

### リスク 1: スラッシュコマンドの動作不良

**対策**:
- Phase 2 実装前に、全スラッシュコマンドの動作確認を徹底
- 統合テストを追加して、リグレッションを防ぐ

### リスク 2: ドキュメントの更新漏れ

**対策**:
- 全ドキュメントファイルを Grep で検索し、`takumi` コマンドの記述を漏れなく削除
- CLAUDE.md、README.md、QUICK_START.md を重点的に確認

### リスク 3: テストカバレッジの低下

**対策**:
- CLI テスト削除前に、コアロジックのテストが十分であることを確認
- 必要に応じて、コアロジックのテストを追加

---

## 10. 実装タスク分解

### Task 1: 現行アーキテクチャの分析

**目的**: CLI レイヤー削除の影響範囲を正確に把握する

**作業内容**:
- [ ] 削除対象ファイルの最終確認（`src/cli/` 配下全ファイル）
- [ ] スラッシュコマンドと CLI の依存関係マッピング作成
- [ ] CLI コマンドからコアロジックへの呼び出しフローを図式化
- [ ] 現行の `package.json` の `bin`、`scripts` 設定を確認

**成果物**:
- 削除対象ファイルリスト（Markdown 表）
- 依存関係マップ（図またはテキスト）

**工数**: 1-2 時間

---

### Task 2: 新アーキテクチャの設計

**目的**: スラッシュコマンド → コアロジック直接呼び出しの設計を確立

**作業内容**:
- [ ] スラッシュコマンドから直接 `src/core/` を呼び出す設計
- [ ] エラーハンドリング方針の策定（CLI エラーハンドラーの代替）
- [ ] 出力フォーマット処理の方針（現在は CLI の `output.ts` に依存）
- [ ] バリデーション処理の統合方針（CLI の `validation.ts` の機能を移行）

**成果物**:
- 新アーキテクチャ設計ドキュメント
- エラーハンドリング・バリデーションの設計方針

**工数**: 2-3 時間

---

### Task 3: コアロジック層の抽出・整理

**目的**: CLI 固有のロジックをコアロジックから分離し、再利用可能にする

**作業内容**:
- [ ] CLI コマンドからビジネスロジックを `src/core/` に移行
- [ ] CLI 固有の出力フォーマット処理を削除
- [ ] バリデーションロジックを `src/core/` に統合
- [ ] エラーハンドリングロジックを `src/core/` に統合

**影響ファイル**:
- 新規作成: `src/core/commands/` ディレクトリ
- 新規作成: `src/core/validation/` ディレクトリ（または既存 workflow に統合）
- 新規作成: `src/core/errors/` の拡張

**成果物**:
- コアロジック層の抽出完了
- ユニットテストの追加

**工数**: 4-6 時間

---

### Task 4: スラッシュコマンドのリファクタリング

**目的**: スラッシュコマンドを CLI 経由からコアロジック直接呼び出しに変更

**作業内容**:
- [ ] `.claude/commands/takumi/*.md` を修正（13 ファイル）
- [ ] `takumi` コマンド呼び出しを削除
- [ ] コアロジック呼び出しに変更（例: Node.js スクリプト実行）
- [ ] エラーハンドリングをスラッシュコマンド内で実装

**影響ファイル**:
- `.claude/commands/takumi/init.md`
- `.claude/commands/takumi/status.md`
- `.claude/commands/takumi/spec-create.md`
- `.claude/commands/takumi/spec-list.md`
- `.claude/commands/takumi/spec-get.md`
- `.claude/commands/takumi/spec-phase.md`
- `.claude/commands/takumi/github-init.md`
- `.claude/commands/takumi/github-issue-create.md`
- `.claude/commands/takumi/github-sync.md`
- `.claude/commands/takumi/github-project-add.md`
- `.claude/commands/takumi/knowledge-progress.md`
- `.claude/commands/takumi/knowledge-error.md`
- `.claude/commands/takumi/knowledge-tip.md`

**成果物**:
- リファクタリング完了した 13 個のスラッシュコマンド

**工数**: 6-8 時間

---

### Task 5: CLI レイヤーの削除

**目的**: `src/cli/` ディレクトリ全体を削除し、関連設定を整理

**作業内容**:
- [ ] `src/cli/` ディレクトリを削除
- [ ] `package.json` の `bin` フィールドを削除
- [ ] `package.json` の `scripts.start` を削除または用途変更
- [ ] `tsconfig.json` の調整（必要に応じて）
- [ ] `.gitignore` の調整（必要に応じて）

**削除対象ディレクトリ**:
```
src/cli/                             # 削除
├── index.ts
├── commands/
│   ├── init.ts
│   ├── status.ts
│   ├── spec/
│   ├── github/
│   └── knowledge/
└── utils/
```

**成果物**:
- CLI レイヤー削除完了
- `package.json` 更新

**工数**: 1 時間

---

### Task 6: テストの修正

**目的**: CLI テストを削除し、コアロジックのテストを強化

**作業内容**:
- [ ] CLI テストファイルを削除（`tests/cli/` 配下）
- [ ] コアロジックの単体テストを追加・修正
- [ ] スラッシュコマンドの統合テストを追加（E2E テスト）
- [ ] カバレッジレポートを確認（80%以上維持）

**影響ファイル**:
- 削除: `tests/cli/**/*.test.ts`
- 追加: `tests/core/commands/**/*.test.ts`
- 追加: `tests/integration/slash-commands.test.ts`

**成果物**:
- テスト修正完了
- カバレッジレポート（80%以上）

**工数**: 4-6 時間

---

### Task 7: ドキュメントの更新

**目的**: 全ドキュメントから CLI コマンドの記述を削除

**作業内容**:
- [ ] `README.md` から CLI コマンドの記述を削除
- [ ] `QUICK_START.md` をスラッシュコマンドのみに変更
- [ ] `CLAUDE.md` の「よく使うコマンド」セクション更新
- [ ] `docs/ARCHITECTURE.md` のアーキテクチャ図更新
- [ ] `package.json` の `description` フィールド更新
- [ ] Grep で `takumi` コマンド記述を全検索し、漏れがないか確認

**影響ファイル**:
- `README.md`
- `QUICK_START.md`
- `CLAUDE.md`
- `docs/ARCHITECTURE.md`
- `package.json`

**検索コマンド**:
```bash
grep -r "takumi " docs/ README.md QUICK_START.md CLAUDE.md
```

**成果物**:
- ドキュメント更新完了
- CLI コマンド記述の完全削除確認

**工数**: 2-3 時間

---

### Task 8: 動作確認

**目的**: 全スラッシュコマンドが正常に動作することを確認

**作業内容**:
- [ ] 13 個のスラッシュコマンドを手動実行
- [ ] 正常系の動作確認
- [ ] エラーケース（引数不足、不正な値等）の確認
- [ ] GitHub 連携機能の動作確認

**確認対象コマンド**:
- `/cft:init`
- `/cft:status`
- `/cft:spec-create`
- `/cft:spec-list`
- `/cft:spec-get`
- `/cft:spec-phase`
- `/cft:github-init`
- `/cft:github-issue-create`
- `/cft:github-sync`
- `/cft:github-project-add`
- `/cft:knowledge-progress`
- `/cft:knowledge-error`
- `/cft:knowledge-tip`

**成果物**:
- 動作確認チェックリスト（全項目 ✓）

**工数**: 2-3 時間

---

### Task 9: テスト・ビルド確認

**目的**: テストとビルドが正常に通過し、ビルドサイズが削減されることを確認

**作業内容**:
- [ ] `npm test` 実行（全テスト通過確認）
- [ ] `npm run test:coverage` 実行（80%以上確認）
- [ ] `npm run build` 実行（ビルド成功確認）
- [ ] ビルドサイズの測定（CLI レイヤー削除前後の比較）
- [ ] 型チェック `npm run typecheck` 実行

**成果物**:
- 全テスト通過
- カバレッジレポート（80%以上）
- ビルド成功
- ビルドサイズ削減確認

**工数**: 1 時間

---

### タスク依存関係

```
Task 1 (分析) → Task 2 (設計)
                    ↓
Task 3 (コアロジック抽出) → Task 4 (スラッシュコマンドリファクタリング)
                                          ↓
                          Task 5 (CLI削除) → Task 6 (テスト修正)
                                                       ↓
                          Task 7 (ドキュメント更新) → Task 8 (動作確認)
                                                                ↓
                                                       Task 9 (テスト・ビルド確認)
```

### 総工数見積もり

- **Task 1**: 1-2 時間
- **Task 2**: 2-3 時間
- **Task 3**: 4-6 時間
- **Task 4**: 6-8 時間
- **Task 5**: 1 時間
- **Task 6**: 4-6 時間
- **Task 7**: 2-3 時間
- **Task 8**: 2-3 時間
- **Task 9**: 1 時間

**合計**: 23-34 時間（約 3-4 日）

---

## 11. 参考情報

- **関連 Issue**: #11 カスタムスラッシュコマンドの表記改善（完了済み）
- **アーキテクチャドキュメント**: `docs/ARCHITECTURE.md`
- **クイックスタートガイド**: `docs/QUICK_START.md`
- **Claude Code カスタムスラッシュコマンド仕様**: `.claude/commands/README.md`
