---
id: "ea8aadc5-4750-4995-a2d7-4304eb786b8f"
name: "TDD の見直し"
phase: "completed"
branch_name: "main"
github_issue_number: null
pr_url: null
created_at: "2025-11-28T02:10:48.586Z"
updated_at: "2025-11-28T20:52:00Z"
---

# TDD の見直し


## 1. 背景と目的

### 背景

https://gihyo.jp/article/2024/01/automated-test-and-tdd を注意深く読み、真の TDD を理解し、本開発キットの TDD がこれに沿ったものとなっているかチェックし、設計と実装を見直してほしい。

### 目的

参考記事が示す「真の TDD」の原則に基づき、本開発キットの TDD 実践状況を評価・改善する。特に以下の観点で見直しを行う：

1. **TDD の本質理解**: テストファーストだけでなく、Red-Green-Refactor サイクルによる設計改善
2. **カバレッジ目標の適正化**: 現状 33% → 80% への段階的引き上げ
3. **テスト生成機能の高度化**: ボイラープレート生成から実装解析ベースへ進化
4. **ドキュメントの統一**: TDD_GUIDE.md の Jest 対応・SDD スタイルへの更新
---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発（SDD）を行う開発者、および TDD を実践したい開発者
---

## 3. 受け入れ基準

### 必須要件

- [ ] 参考記事の TDD 原則（Red-Green-Refactor、テストファースト≠TDD の区別）が理解され、文書化される
- [ ] 現在のテスト戦略が参考記事の原則に照らして評価され、ギャップが特定される

### 機能要件

- [ ] jest.config.js のカバレッジ閾値を段階的に引き上げる計画を策定する（33% → 50% → 70% → 80%）
- [ ] TDD_GUIDE.md を Jest 対応・SDD スタイルに更新する
- [ ] `/cft:test-generate` コマンドを実装解析ベースのテスト生成に高度化する
- [ ] テスト除外ファイル（testPathIgnorePatterns）を削減する方針を策定する

### 非機能要件

- [ ] テストの保守性が向上し、モックパターンが統一される
- [ ] 記事が警告する「100% カバレッジの追求」を避け、無駄なく漏れのないテスト設計を目指す
---

## 4. 制約条件

- 既存のテストスイート（934 テストケース）を破壊しない
- Jest v29.7.0 を継続使用（Vitest への移行は別仕様で検討）
- CLAUDE.md のプロンプトファースト原則に従い、テスト生成はプロンプトベースを優先
- 記事の警告に従い、過度な先行設計（スコープクリープ）を避ける
---

## 5. 依存関係

- `jest.config.js` - テスト設定（カバレッジ閾値）
- `docs/TDD_GUIDE.md` - TDD 実践ガイド（更新対象）
- `src/slash-commands/test-generate.md` - テスト生成コマンド定義
- `src/core/subagents/impl/test-creator.ts` - テスト生成サブエージェント実装
- `tests/` - テストスイート全体
---

## 6. 参考情報

### 参考記事の要点

- **TDD の本質**: 単なるテスト手法ではなく、プログラミング中の不安をコントロールする手法
- **テストファースト ≠ TDD**: テストファーストは試験性を高めるが、TDD はリファクタリングを含む
- **Red-Green-Refactor**: 各ステップで焦点を分離し、「動作するきれいなコード」を達成
- **警告**: 100% カバレッジ追求は「手段の目的化」、過度な先行設計は「スコープクリープ」

### 現状評価

| 項目 | 現状 | 課題 |
|------|------|------|
| カバレッジ閾値 | 33% | 目標 80% との乖離 |
| テスト成功率 | 97.6% | 良好 |
| テスト除外 | 9 パターン | import.meta 問題など |
| ドキュメント | Vitest 記載 | Jest に更新必要 |

### 参考リンク

- https://gihyo.jp/article/2024/01/automated-test-and-tdd
---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
TDD 見直しの影響範囲
├── ドキュメント層
│   └── docs/TDD_GUIDE.md          # Jest 対応・SDD スタイルに更新
├── 設定層
│   └── jest.config.js             # カバレッジ閾値の段階的引き上げ
├── コマンド層（プロンプトベース）
│   └── src/slash-commands/test-generate.md  # 実装解析ベースの指示追加
└── テストスイート
    └── tests/                     # 既存 79 ファイル・934 テストケース維持
```

#### 設計方針

1. **プロンプトファースト原則の遵守**
   - test-generate.md はプロンプトベースのまま改善
   - test-creator.ts（スクリプト）の改修は最小限に留める
   - Claude Code の Read/Edit ツールを活用した実装解析をプロンプトで指示

2. **段階的なカバレッジ向上**
   - 一度に 80% を目指さず、33% → 50% → 70% → 80% の 4 段階で引き上げ
   - 各段階で品質を確認し、「手段の目的化」を防止

3. **既存テストの維持**
   - 934 テストケースを破壊しない
   - testPathIgnorePatterns の削減は段階的に実施

#### 処理フロー詳細

**TDD_GUIDE.md 更新フロー:**
```
1. 現在の TDD_GUIDE.md を Read で確認
2. Vitest → Jest への置換箇所を特定
3. 既存テスト（tests/examples/tdd-example.test.ts）を参考に実例更新
4. SDD との統合ガイダンスを追加
5. Edit ツールで更新
```

**カバレッジ閾値引き上げフロー:**
```
Phase 1: 33% → 50%（現在 + 17%）
  └── ユーティリティ関数のテスト拡充

Phase 2: 50% → 70%（+ 20%）
  └── コアモジュールのテスト拡充

Phase 3: 70% → 80%（+ 10%）
  └── 統合テスト・境界テストの追加
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `docs/TDD_GUIDE.md` | Vitest → Jest 統一、SDD スタイル更新、実例コード修正 |
| `jest.config.js` | coverageThreshold のコメント追加（段階計画明記） |
| `src/slash-commands/test-generate.md` | 実装解析ベースの指示追加、AAA パターン明示 |

#### 変更しないファイル（スコープ外）

| ファイル | 理由 |
|---------|------|
| `src/core/subagents/impl/test-creator.ts` | プロンプトファースト原則に従い、プロンプト層で対応 |
| `tests/**/*.test.ts` | 既存テストは維持（新規テスト追加は別仕様） |

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| TDD ガイド | Vitest 記載・旧スタイル | Jest 統一・SDD スタイル | docs/TDD_GUIDE.md |
| カバレッジ閾値 | 33% 固定 | 段階計画コメント付き | jest.config.js |
| テスト生成指示 | ボイラープレート生成 | 実装解析ベース指示 | src/slash-commands/test-generate.md |
| TDD 原則文書化 | なし | 参考記事の要点を反映 | docs/TDD_GUIDE.md |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| TDD_GUIDE.md 更新 | Vitest 記載がないこと | Grep で `vitest` 検索 |
| jest.config.js | 閾値コメントの存在 | Read で確認 |
| test-generate.md | 実装解析指示の存在 | Read で確認 |
| 既存テスト維持 | 934 テストが通ること | `npm test` 実行 |

### 7.5 移行計画

#### Phase 1: ドキュメント整備

1. TDD_GUIDE.md を Jest 対応に更新
2. 参考記事の TDD 原則を文書化
3. SDD との統合ガイダンスを追加

#### Phase 2: 設定・指示更新

1. jest.config.js に段階計画コメントを追加
2. test-generate.md に実装解析ベースの指示を追加

#### Phase 3: 検証

1. 既存テストスイートが全て通ることを確認
2. npm run test:coverage でカバレッジレポート確認
---

## 8. 実装タスクリスト

### Phase 1: ドキュメント整備

- [x] TDD_GUIDE.md の Vitest → Jest 置換（import 文、vi.fn() など）
- [x] TDD_GUIDE.md に Red-Green-Refactor サイクルの詳細説明を追加
- [x] TDD_GUIDE.md に「テストファースト ≠ TDD」の説明を追加
- [x] TDD_GUIDE.md に SDD との統合ガイダンスを追加

### Phase 2: 設定・指示更新

- [x] jest.config.js に段階的カバレッジ向上計画のコメントを追加
- [x] test-generate.md に実装解析ベースのテスト生成指示を追加
- [x] test-generate.md に AAA パターン（Arrange-Act-Assert）の明示を追加

### Phase 3: 検証

- [x] npm test で既存 934 テストケースが全て通ることを確認
- [x] npm run test:coverage でカバレッジレポートを確認
- [x] Grep で TDD_GUIDE.md に `vitest` が残っていないことを確認
---

## Pull Request

- https://github.com/B16B1RD/cc-craft-kit/pull/412
