# 作成済みの GitHub Issue が認識されない問題が解決していない

**仕様書 ID:** 3e313ec5-5349-4138-aea7-0e2fd97ff618
**フェーズ:** completed
**作成日時:** 2025/11/30 12:00:00
**更新日時:** 2025/11/30 19:40:00

---

## 1. 背景と目的

### 背景

GitHub Issue があるにもかかわらず「Step 3.5: GitHub Issue 連携状態確認 - GITHUB_ISSUE_NUMBER が null のため、警告を表示します。」というメッセージが表示され処理を中断するか無視して継続するかの質問がされる。

### 目的

`/cft:spec-phase` コマンド実行時に、作成済みの GitHub Issue が正しく認識され、不要な警告や確認ダイアログが表示されないようにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発（SDD）を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `resolve-id.ts` で `github_number` カラムを正しく SELECT する
- [ ] `/cft:spec-phase` 実行時に作成済み Issue が認識される

### 機能要件

- [ ] `npx tsx .cc-craft-kit/commands/spec/resolve-id.ts <spec-id>` が正しい `github_issue_number` を返す
- [ ] フェーズ移行時に不要な「GitHub Issue なしで移行しますか？」の確認が表示されない

### 非機能要件

- [ ] 既存のテストが全て通過する
- [ ] 修正後に `npm run sync:dogfood` で `.cc-craft-kit/` に同期される

---

## 4. 制約条件

- 既存の `github_sync` テーブルスキーマを変更しない（後方互換性維持）
- `issue_number` カラムの削除は別タスクとして分離する
- Kysely のパラメータ化クエリを使用する

---

## 5. 依存関係

- `src/commands/spec/resolve-id.ts` - 仕様書 ID 解決スクリプト（修正対象）
- `src/core/database/schema.ts` - データベーススキーマ定義
- `src/core/database/migrations/007_add_unique_constraint_to_github_sync.ts` - github_sync テーブル定義

---

## 6. 参考情報

- 関連 Issue: #448 (GitHub Sub Issue が更新されない)
- 根本原因: `resolve-id.ts` 行 69 で旧カラム名 `issue_number` を SELECT している
- 修正箇所: `select(['issue_number'])` → `select(['github_number'])`

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```text
/cft:spec-phase コマンド
       │
       ▼
resolve-id.ts (resolveSpecById)
       │
       ├── specs テーブル → 仕様書基本情報
       │
       └── github_sync テーブル → GitHub 連携情報
              │
              ├── github_number ← ✅ 正しいカラム
              └── issue_number  ← ❌ 旧カラム（現在参照中）
```

#### 設計方針

**カラム名の統一:** `github_sync` テーブルでは `github_number` が標準カラムであり、`issue_number` は後方互換性のために残存している。新規コードおよび修正コードは `github_number` を使用する。

#### 処理フロー詳細

```text
1. resolveSpecById(partialId)
   ├── specs テーブルから仕様書を取得
   ├── github_sync テーブルから github_number を取得 ← 修正対象
   └── 結果を返す: { spec, github_issue_number }

2. resolveSpecByIssueNumber(issueNumber)
   ├── github_sync テーブルで github_number を検索 ← 修正対象
   └── 該当する仕様書を返す
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/commands/spec/resolve-id.ts` (行 69) | `select(['issue_number'])` → `select(['github_number'])` |
| `src/commands/spec/resolve-id.ts` (行 85) | `sync?.issue_number` → `sync?.github_number` |
| `src/commands/spec/resolve-id.ts` (行 102, 104) | `issue_number` → `github_number` |
| `src/commands/spec/resolve-id.ts` (行 139) | `sync.issue_number` → `sync.github_number` |

#### 追加修正対象（発見された問題）

| ファイル | 変更内容 |
|---------|---------|
| `src/integrations/github/pull-request.ts` (行 58) | `syncRecord.issue_number` → `syncRecord.github_number` |

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| 仕様書 ID から GitHub Issue 番号取得 | `issue_number` を SELECT | `github_number` を SELECT | resolve-id.ts:69 |
| 戻り値の組み立て | `sync?.issue_number` | `sync?.github_number` | resolve-id.ts:85 |
| GitHub Issue 番号から仕様書検索 | `issue_number` で WHERE | `github_number` で WHERE | resolve-id.ts:102-104 |
| 検索結果の戻り値 | `sync.issue_number` | `sync.github_number` | resolve-id.ts:139 |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| resolveSpecById | GitHub Issue 番号が正しく返されること | 既存テストの修正（モック更新） |
| resolveSpecByIssueNumber | Issue 番号での検索が機能すること | 既存テストで検証 |
| /cft:spec-phase | 不要な確認ダイアログが表示されないこと | 手動検証 |

### 7.5 移行計画

#### Phase 1: 緊急修正

1. `resolve-id.ts` の 4 箇所を修正
2. `pull-request.ts` の 1 箇所を修正
3. 既存テストを更新
4. `npm run sync:dogfood` で同期

#### Phase 2: 検証

1. `npm run typecheck` で型チェック
2. `npm test` で全テスト実行
3. `/cft:spec-phase` で動作確認

---

## 8. 実装タスクリスト

### Phase 1: 緊急修正

- [x] `resolve-id.ts` の `resolveSpecById` 関数で `github_number` を SELECT するように修正
- [x] `resolve-id.ts` の戻り値で `sync?.github_number` を使用するように修正
- [x] `resolve-id.ts` の `resolveSpecByIssueNumber` 関数で `github_number` を使用するように修正
- [x] `pull-request.ts` の `syncRecord.issue_number` を `syncRecord.github_number` に修正

### Phase 2: 検証

- [x] `npm run sync:dogfood` で `.cc-craft-kit/` に同期
- [x] `npm run typecheck` で型チェック実行
- [x] `npm test` で全テスト実行
- [x] `/cft:spec-phase` で動作確認（GitHub Issue が認識されることを確認）

---

## Pull Request

- https://github.com/B16B1RD/cc-craft-kit/pull/450
