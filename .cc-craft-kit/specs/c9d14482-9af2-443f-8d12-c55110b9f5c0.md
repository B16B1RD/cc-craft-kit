# /cft:spec-phase <id> implementation で、実装が自動実行されない

**仕様書 ID:** c9d14482-9af2-443f-8d12-c55110b9f5c0
**フェーズ:** implementation
**作成日時:** 2025/11/28 12:00:00
**更新日時:** 2025/11/28 19:32:00

---

## 1. 背景と目的

### 背景

現在の `/cft:spec-phase <id> implementation` コマンドは、フェーズの切り替えとガイダンスメッセージの表示のみを行い、実装開始はユーザーが指示しないと始まらない。

具体的な問題:
- `spec-phase.md` では「自動実行フロー」と記述されているが、実際の実装（`phase-automation.ts` の `handleImplementationPhase()`）ではタスク一覧の表示のみ
- タスク粒度バリデーション、TodoWrite によるタスク進捗管理、型チェック・リント実行が未実装
- ユーザーは手動で実装を開始する必要があり、開発フローが中断される

### 目的

implementation フェーズに移行した際に、実装作業を自動で開始し、開発者の手間を削減する。フェーズ移行→タスク読み込み→実装開始までをシームレスに連携させる。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発（SDD）を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-phase <id> implementation` 実行後、ユーザーの追加指示なしに実装が自動開始される
- [ ] 仕様書の「実装タスクリスト」セクションからタスクを読み込み、TodoWrite で進捗管理を開始する

### 機能要件

- [ ] タスク粒度バリデーションを実行し、粗すぎるタスクがある場合は分割を提案する
- [ ] 型チェック（typescript-eslint スキル）を自動実行し、エラーがあれば表示する
- [ ] 最初のタスクから順に実装を開始する（タスクを in_progress に設定）
- [ ] 実装対象ファイルの特定と、設計詳細セクションの確認を自動で行う

### 非機能要件

- [ ] プロンプトファースト原則に従い、可能な限りプロンプト層（.md）で実装する
- [ ] 自動実行中もユーザーが中断・制御できるようにする

---

## 4. 制約条件

- プロンプトファースト原則: Claude Code のツール（Read/Write/Edit/Task/Skill/TodoWrite）で実現可能な処理はプロンプト層で実装する
- 既存の EventBus アーキテクチャとの整合性を維持する
- `spec-phase.md` の自動実行フロー定義に従う

---

## 5. 依存関係

- `src/slash-commands/spec-phase.md` - スラッシュコマンド定義
- `src/core/workflow/phase-automation.ts` - フェーズ自動処理ハンドラー
- `src/commands/spec/update-phase.ts` - フェーズ更新 CLI スクリプト
- `typescript-eslint` スキル - 型チェック・リント実行

---

## 6. 参考情報

- `CLAUDE.md` - プロンプトファースト原則、設計・実装方法の選択ガイド
- `src/slash-commands/spec-create.md` - 自動実行フローの参考実装
- `src/slash-commands/spec-phase.md` の Step 8 - implementation フェーズの自動処理定義

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
┌─────────────────────────────────────────────────────────────────┐
│  /cft:spec-phase <id> implementation                            │
│  (spec-phase.md - プロンプト層)                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 5: DB 更新 + イベント発火                                 │
│  (update-phase.ts - スクリプト層)                               │
│  - specs.phase を 'implementation' に更新                       │
│  - spec.phase_changed イベント発火                              │
└─────────────────────────────────────────────────────────────────┘
                              │
          ┌───────────────────┴───────────────────┐
          ▼                                       ▼
┌─────────────────────────┐       ┌─────────────────────────────────┐
│ phase-automation.ts     │       │ git-integration.ts              │
│ (イベントハンドラー)    │       │ (Git 自動コミット)              │
│ - メッセージ表示        │       │ - フェーズ移行コミット          │
│ - タスク一覧表示        │       └─────────────────────────────────┘
└─────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 8: implementation フェーズ固有処理                        │
│  (spec-phase.md - プロンプト層)                                 │
│  ★ ここの自動実行が不完全 - 今回の修正対象                      │
│                                                                  │
│  現状: タスク一覧表示 + ガイダンスメッセージのみ                │
│  期待: タスク解析 → 進捗管理 → 型チェック → 実装開始            │
└─────────────────────────────────────────────────────────────────┘
```

#### 設計方針

**プロンプトファースト原則の適用**:
- implementation フェーズの自動実行処理は、すべてプロンプト層（`spec-phase.md`）で実装
- TypeScript スクリプトは DB 操作・イベント発火のみを担当（現状維持）
- design フェーズの自動実行パターンを踏襲

**責務分離**:
| レイヤー | 責務 | 修正要否 |
|----------|------|----------|
| `spec-phase.md` | implementation フェーズの詳細実行フロー定義 | ★ 修正必要 |
| `phase-automation.ts` | メッセージ表示・タスク一覧表示 | 修正不要 |
| `update-phase.ts` | DB 更新・イベント発火 | 修正不要 |

#### 処理フロー詳細

```
/cft:spec-phase <id> impl 実行
        │
        ▼
Step 1-7: フェーズ更新（既存処理）
        │
        ▼
Step 8: implementation フェーズ固有処理
        │
        ├─→ 8.1 実装タスクリスト読み込み
        │        Read ツールで「## 8. 実装タスクリスト」を取得
        │
        ├─→ 8.1.5 タスク粒度バリデーション（新規追加）
        │        - タスク数チェック（3未満は警告）
        │        - 曖昧表現チェック
        │
        ├─→ 8.2 タスク解析・進捗管理開始
        │        TodoWrite でタスクリストを登録
        │        最初の未完了タスクを in_progress に設定
        │
        ├─→ 8.3 設計詳細確認
        │        「## 7. 設計詳細 → 7.2 実装方針」から
        │        修正対象ファイルを表示
        │
        ├─→ 8.4 型チェック・リント実行
        │        Skill: typescript-eslint
        │
        └─→ 8.5 結果表示・ガイダンス
                 タスク進捗、修正対象、次のステップを表示
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/slash-commands/spec-phase.md` | Step 8 の implementation フェーズ処理を強化（現在の定義は存在するが実行されていない箇所を修正） |

#### 修正不要のファイル

| ファイル | 理由 |
|---------|------|
| `src/core/workflow/phase-automation.ts` | メッセージ表示のみの責務を維持（プロンプトファースト原則） |
| `src/commands/spec/update-phase.ts` | DB 操作・イベント発火のみで責務が完結 |

#### 実装アプローチ

**問題の本質**:
`spec-phase.md` の Step 8 には implementation フェーズの詳細処理が定義されているが、現在の処理フローでは以下の実行が不完全:
1. タスク粒度バリデーション（Step 8 - 1.5）が定義のみで自動実行されていない
2. TodoWrite によるタスク進捗管理が実行されていない
3. 型チェック・リント実行後の「実装開始」への遷移がない

**解決策**:
`spec-phase.md` の implementation フェーズ処理を見直し、design フェーズと同様に「自動実行フロー」として明確化する。具体的には:
1. 各ステップの実行条件を明確化
2. エラー時の分岐処理を強化
3. 「実装開始」への自動遷移を追加

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| タスクリスト読み込み | 定義あり（実行不完全） | 自動実行を保証 | `spec-phase.md` Step 8.1 |
| タスク粒度バリデーション | 定義あり（実行されない） | 自動実行を保証 | `spec-phase.md` Step 8.1.5 |
| TodoWrite 進捗管理 | 定義あり（実行されない） | 自動実行を保証 | `spec-phase.md` Step 8.2 |
| 型チェック・リント | 定義あり（実行される） | 維持 | `spec-phase.md` Step 8.4 |
| 実装開始ガイダンス | ガイダンス表示のみ | 実装自動開始を追加 | `spec-phase.md` Step 8.5 |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| タスクリスト読み込み | 「## 8. 実装タスクリスト」が正しく解析される | 手動テスト（コマンド実行） |
| タスク粒度バリデーション | 3未満のタスク数で警告が表示される | 手動テスト |
| 曖昧表現チェック | 「全て実装」等の表現で警告が表示される | 手動テスト |
| TodoWrite 連携 | タスクが pending/in_progress で登録される | 手動テスト（Todo リスト確認） |
| 型チェック実行 | typescript-eslint スキルが実行される | 手動テスト |

### 7.5 移行計画

#### Phase 1: spec-phase.md の修正

1. Step 8 の implementation フェーズ処理を見直し
2. 各ステップの自動実行を明確化
3. 「実装自動開始」セクションを追加

#### Phase 2: 動作確認

1. `/cft:spec-phase <id> impl` を実行
2. タスクリスト読み込み、TodoWrite 登録、型チェックが自動実行されることを確認
3. 実装開始ガイダンスが表示されることを確認

---

## 8. 実装タスクリスト

### Phase 1: spec-phase.md の修正

- [ ] Step 8 の implementation フェーズ処理に「実装自動開始」セクションを追加
- [ ] 型チェック・リント実行後、最初のタスクの実装を自動で開始する処理を追加
- [ ] 実装開始時のガイダンスメッセージを改善（現在のタスク内容、修正対象ファイルを明示）

### Phase 2: 動作確認

- [ ] `/cft:spec-phase <id> impl` 実行後、TodoWrite でタスクが登録されることを確認
- [ ] 型チェック・リントが自動実行されることを確認
- [ ] 実装開始ガイダンスが正しく表示されることを確認
