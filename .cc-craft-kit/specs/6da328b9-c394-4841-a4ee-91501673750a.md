# GitHub Actions が失敗する

**仕様書 ID:** 6da328b9-c394-4841-a4ee-91501673750a
**フェーズ:** requirements
**作成日時:** 2025/11/20 10:49:06
**更新日時:** 2025/11/20 10:49:06

---

## 1. 背景と目的

### 背景

GitHub Actions の CI テストが失敗しています。`tests/e2e/branch-and-pr-workflow.test.ts` で 4 つのテストケースが失敗しており、何度も再発しています。

**失敗しているテスト:**

1. Feature 開発フロー: 仕様書作成 → tasks → implementation → completed の完全フロー
2. Hotfix 緊急修正フロー: 緊急修正は main ブランチから分岐する
3. エラーハンドリング: ブランチ作成失敗時、フェーズをロールバックする
4. 保護ブランチチェック: main ブランチで直接作業している場合、警告を表示する

### 目的

- GitHub Actions のテスト失敗を修正する
- テストが安定して通過するようにする
- 今後二度と同じ問題が発生しないための再発防止策を実装する

---

## 2. 対象ユーザー

- cc-craft-kit 開発者
- CI/CD 運用担当者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `tests/e2e/branch-and-pr-workflow.test.ts` の全テストが通過する
- [ ] GitHub Actions の CI が成功する
- [ ] 修正内容がドキュメント化されている

### 機能要件

- [ ] テストモックが実装コードの動作と一致している
- [ ] エラーハンドリングのテストが正しく動作している
- [ ] ブランチ管理のテストが正しく動作している

### 非機能要件

- [ ] テストの実行時間が許容範囲内（30 秒以内）
- [ ] テストの安定性が向上している（フレーキーテストなし）
- [ ] コードカバレッジが 80%以上を維持している

---

## 4. 制約条件

- 既存の機能に影響を与えない
- テストのモック設定を最小限の変更で修正する
- CI/CD パイプラインの設定変更は不要とする

---

## 5. 依存関係

- `src/core/workflow/branch-management.ts` - ブランチ管理機能
- `tests/helpers/test-database.ts` - テストデータベースヘルパー
- Jest のモック機能

---

## 6. 参考情報

- GitHub Actions ワークフロー: `.github/workflows/ci.yml`
- 失敗したワークフロー: <https://github.com/B16B1RD/cc-craft-kit/actions/runs/19522505022>
- 関連 Issue: #220

---

## 7. 根本原因分析

### 原因1: テストモックの設定ミス

**問題**: `git rev-parse --verify` のモック設定が不適切で、ブランチが常に「存在する」と判定されていた。

**詳細**:

- `beforeEach` のモック設定で、`git rev-parse --verify` が `status: 0` を返していた
- `branchExists()` 関数が常に `true` を返すため、新しいブランチ作成ではなく、既存ブランチのチェックアウトが実行されていた
- `checkoutBranch()` は `-b` フラグを使わないため、テストの期待値と不一致

**修正内容**:

- `execSync` のモックで `git rev-parse --verify` が常に例外をスローするように変更
- これにより、`branchExists()` が `false` を返し、新しいブランチが作成されるようになった

### 原因2: エラーハンドリングテストのモック設定ミス

**問題**: ブランチ作成失敗をシミュレートするモックが `execSync` で設定されているが、実装は `spawnSync` を使用。

**詳細**:

- エラーハンドリングテストで、`execSync` のモックでブランチ作成を失敗させる設定があった
- 実装コードは `spawnSync` を使っているため、モックが適用されなかった
- フェーズロールバックが正しくテストされていなかった

**修正内容**:

- エラーハンドリングテストの `spawnSync` モックをオーバーライドして、ブランチ作成失敗をシミュレート

### 原因3: Hotfix テストと保護ブランチテストのモック不整合

**問題**: 特定のテストケースで `execSync` のモックを再設定しているが、`git rev-parse --verify` の処理が漏れている。

**詳細**:

- Hotfix テストと保護ブランチテストで、`execSync` のモックを再実装している
- `git rev-parse --verify` の例外スローが設定されていないため、既存ブランチと判定される

**修正内容**:

- (未修正) 各テストケースのモック設定を統一する必要がある

---

## 8. 調査中の問題

### 残りの失敗テスト

1. **Feature開発フロー**: `spawnSync` が呼ばれていない (Number of calls: 0)
   - 原因: 不明（詳細調査が必要）

2. **Hotfix緊急修正フロー**: `-b` フラグがない
   - 原因: Hotfix テストで `execSync` モックを再設定しているが、`git rev-parse --verify` の処理が漏れている

3. **エラーハンドリング**: フェーズ更新が失敗していない
   - 原因: `updateSpecPhase()` ヘルパー関数がエラーをキャッチして `success: true` を返している可能性

4. **保護ブランチチェック**: `-b` フラグがない
   - 原因: 保護ブランチテストで `execSync` モックを再設定しているが、`git rev-parse --verify` の処理が漏れている
