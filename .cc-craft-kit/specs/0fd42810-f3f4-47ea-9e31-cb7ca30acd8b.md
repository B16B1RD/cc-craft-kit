# Sub Issue を活用

**仕様書 ID:** 0fd42810-f3f4-47ea-9e31-cb7ca30acd8b
**フェーズ:** requirements
**作成日時:** 2025/11/18 11:55:20
**更新日時:** 2025/11/18 11:55:20

---

## 1. 背景と目的

### 背景

GitHub の Sub Issue 機能が 2025年に正式リリースされ、従来の tasklist blocks は 2025年4月30日に廃止予定です。cc-craft-kit では、仕様書から GitHub Issue を作成し、タスク分割を行う際に、より効率的な進捗管理とタスク階層化を実現する必要があります。

**Sub Issue の主な特徴:**
- 親子関係による階層構造の管理（最大8レベル、親あたり最大100個のサブ課題）
- 親課題への進捗ロールアップ（子タスク完了情報の自動集約）
- GraphQL API による操作（`addSubIssue`, `removeSubIssue`, `reprioritizeSubIssue`）
- リポジトリ間での Sub Issue 管理対応
- `has:sub-issues-progress` と `has:parent-issue` フィルター対応

### 目的

cc-craft-kit のタスク管理ワークフローに GitHub Sub Issue を統合し、仕様書の「8. 実装タスクリスト」から自動的に Sub Issue を作成・管理することで、以下を実現する。

1. 仕様書のタスクと GitHub Issue の Sub Issue を同期
2. 親課題（仕様書の GitHub Issue）の進捗を自動的にロールアップ
3. タスク完了時に Sub Issue のステータスを自動更新
4. GitHub Projects での進捗可視化を強化

---

## 2. 対象ユーザー

- cc-craft-kit を使用して仕様駆動開発を行う開発者
- GitHub Projects を使用してタスク管理を行うチーム
- 階層的なタスク構造で進捗を可視化したいプロジェクトマネージャー

---

## 3. 受け入れ基準

### 必須要件

- [ ] 仕様書から GitHub Issue を作成した際、親課題として識別される
- [ ] `/cc-craft-kit:spec-phase <spec-id> tasks` 実行時、「8. 実装タスクリスト」の各タスクが Sub Issue として自動作成される
- [ ] Sub Issue の作成に GraphQL API の `addSubIssue` mutation を使用
- [ ] Sub Issue 作成時に `GraphQL-Features: sub_issues` ヘッダーを含める
- [ ] Issue の Node ID（GraphQL ID）を REST API または GraphQL で取得

### 機能要件

- [ ] タスク完了時に対応する Sub Issue のステータスを `closed` に更新
- [ ] 親課題の進捗を Sub Issue の完了状況から自動計算
- [ ] 既存の GitHub 統合（`/cc-craft-kit:github-issue-create`, `/cc-craft-kit:github-sync`）と互換性を保つ
- [ ] Sub Issue のタイトルは「8. 実装タスクリスト」の各タスク内容から自動生成
- [ ] Sub Issue の説明には、仕様書 ID と元のタスク番号を含める
- [ ] `reprioritizeSubIssue` を使用してタスクの順序変更に対応

### 非機能要件

- [ ] Sub Issue 作成は仕様書あたり最大100個まで対応（GitHub の制限に準拠）
- [ ] GraphQL API のレート制限（5,000ポイント/時）に対応
- [ ] Sub Issue 作成失敗時のエラーハンドリングとリトライ処理
- [ ] 既存の仕様書との後方互換性を保つ

---

## 4. 制約条件

### GitHub API の制約

- Sub Issue は最大8レベルまでネスト可能（cc-craft-kit ではフラットな構造のみ使用）
- 親課題あたり最大100個の Sub Issue まで作成可能
- GraphQL API のレート制限: 5,000ポイント/時
- Sub Issue 機能を使用するには `GraphQL-Features: sub_issues` ヘッダーが必須

### cc-craft-kit の制約

- 仕様書の「8. 実装タスクリスト」は Markdown チェックリスト形式
- タスク数が100を超える場合は警告を表示し、手動で分割を促す
- Sub Issue 作成は requirements フェーズ完了後（tasks フェーズ移行時）に実行

---

## 5. 依存関係

### 既存の cc-craft-kit 機能

- `src/integrations/github/sync.ts` - GitHub Issue 同期処理
- `src/core/workflow/event-bus.ts` - イベント駆動アーキテクチャ
- `src/commands/spec/phase.ts` - フェーズ移行コマンド
- `src/core/templates/spec-template.ts` - 仕様書テンプレート

### GitHub API

- GitHub REST API v3 - Issue の Node ID 取得
- GitHub GraphQL API v4 - Sub Issue 作成・管理
- `@octokit/graphql` - GraphQL クライアント

---

## 6. 参考情報

### 公式ドキュメント

- [Introducing sub-issues: Enhancing issue management on GitHub](https://github.blog/engineering/architecture-optimization/introducing-sub-issues-enhancing-issue-management-on-github/)
- [Adding sub-issues - GitHub Docs](https://docs.github.com/en/issues/managing-your-tasks-with-tasklists/creating-a-tasklist)
- [Sub-issues Public Preview - GitHub Community Discussion #148714](https://github.com/orgs/community/discussions/148714)
- [GitHub GraphQL API Mutations](https://docs.github.com/en/graphql/reference/mutations)

### 実装参考記事

- [Create GitHub issue hierarchy using the API](https://jessehouwing.net/create-github-issue-hierarchy-using-the-api/)
- [tasklist が廃止されるので sub-issue に移行しよう](https://zenn.dev/ncdc/articles/102516af97b172)

### GraphQL Mutation 例

```graphql
mutation addSubIssue {
  addSubIssue(input: { issueId: "I_123", subIssueId: "I_456" }) {
    issue {
      title
      subIssues {
        totalCount
      }
    }
    subIssue {
      title
      number
    }
  }
}
```
