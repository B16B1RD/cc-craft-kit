# Sub Issue を活用

**仕様書 ID:** 0fd42810-f3f4-47ea-9e31-cb7ca30acd8b
**フェーズ:** implementation
**作成日時:** 2025/11/18 11:55:20
**更新日時:** 2025/11/18 14:01:04

---

## 1. 背景と目的

### 背景

GitHub の Sub Issue 機能が 2025 年に正式リリースされ、従来の tasklist blocks は 2025 年 4 月 30 日に廃止予定です。cc-craft-kit では、仕様書から GitHub Issue を作成し、タスク分割を行う際に、より効率的な進捗管理とタスク階層化を実現する必要があります。

**Sub Issue の主な特徴:**
- 親子関係による階層構造の管理（最大 8 レベル、親あたり最大 100 個のサブ課題）
- 親課題への進捗ロールアップ（子タスク完了情報の自動集約）
- GraphQL API による操作（`addSubIssue`, `removeSubIssue`, `reprioritizeSubIssue`）
- リポジトリ間での Sub Issue 管理対応
- `has:sub-issues-progress` と `has:parent-issue` フィルター対応

### 目的

cc-craft-kit のタスク管理ワークフローに GitHub Sub Issue を統合し、仕様書の「8. 実装タスクリスト」から自動的に Sub Issue を作成・管理することで、以下を実現する。

1. 仕様書のタスクと GitHub Issue の Sub Issue を同期
2. 親課題（仕様書の GitHub Issue）の進捗を自動的にロールアップ
3. タスク完了時に Sub Issue のステータスを自動更新
4. GitHub Projects での進捗可視化を強化

---

## 2. 対象ユーザー

- cc-craft-kit を使用して仕様駆動開発を行う開発者
- GitHub Projects を使用してタスク管理を行うチーム
- 階層的なタスク構造で進捗を可視化したいプロジェクトマネージャー

---

## 3. 受け入れ基準

### 必須要件

- [ ] 仕様書から GitHub Issue を作成した際、親課題として識別される
- [ ] `/cc-craft-kit:spec-phase <spec-id> tasks` 実行時、「8. 実装タスクリスト」の各タスクが Sub Issue として自動作成される
- [ ] Sub Issue の作成に GraphQL API の `addSubIssue` mutation を使用
- [ ] Sub Issue 作成時に `GraphQL-Features: sub_issues` ヘッダーを含める
- [ ] Issue の Node ID（GraphQL ID）を REST API または GraphQL で取得

### 機能要件

- [ ] タスク完了時に対応する Sub Issue のステータスを `closed` に更新
- [ ] 親課題の進捗を Sub Issue の完了状況から自動計算
- [ ] 既存の GitHub 統合（`/cc-craft-kit:github-issue-create`, `/cc-craft-kit:github-sync`）と互換性を保つ
- [ ] Sub Issue のタイトルは「8. 実装タスクリスト」の各タスク内容から自動生成
- [ ] Sub Issue の説明には、仕様書 ID と元のタスク番号を含める
- [ ] `reprioritizeSubIssue` を使用してタスクの順序変更に対応

### 非機能要件

- [ ] Sub Issue 作成は仕様書あたり最大 100 個まで対応（GitHub の制限に準拠）
- [ ] GraphQL API のレート制限（5,000 ポイント/時）に対応
- [ ] Sub Issue 作成失敗時のエラーハンドリングとリトライ処理
- [ ] 既存の仕様書との後方互換性を保つ

---

## 4. 制約条件

### GitHub API の制約

- Sub Issue は最大 8 レベルまでネスト可能（cc-craft-kit ではフラットな構造のみ使用）
- 親課題あたり最大 100 個の Sub Issue まで作成可能
- GraphQL API のレート制限: 5,000 ポイント/時
- Sub Issue 機能を使用するには `GraphQL-Features: sub_issues` ヘッダーが必須

### cc-craft-kit の制約

- 仕様書の「8. 実装タスクリスト」は Markdown チェックリスト形式
- タスク数が 100 を超える場合は警告を表示し、手動で分割を促す
- Sub Issue 作成は requirements フェーズ完了後（tasks フェーズ移行時）に実行

---

## 5. 依存関係

### 既存の cc-craft-kit 機能

- `src/integrations/github/sync.ts` - GitHub Issue 同期処理
- `src/core/workflow/event-bus.ts` - イベント駆動アーキテクチャ
- `src/commands/spec/phase.ts` - フェーズ移行コマンド
- `src/core/templates/spec-template.ts` - 仕様書テンプレート

### GitHub API

- GitHub REST API v3 - Issue の Node ID 取得
- GitHub GraphQL API v4 - Sub Issue 作成・管理
- `@octokit/graphql` - GraphQL クライアント

---

## 6. 参考情報

### 公式ドキュメント

- [Introducing sub-issues: Enhancing issue management on GitHub](https://github.blog/engineering/architecture-optimization/introducing-sub-issues-enhancing-issue-management-on-github/)
- [Adding sub-issues - GitHub Docs](https://docs.github.com/en/issues/managing-your-tasks-with-tasklists/creating-a-tasklist)
- [Sub-issues Public Preview - GitHub Community Discussion #148714](https://github.com/orgs/community/discussions/148714)
- [GitHub GraphQL API Mutations](https://docs.github.com/en/graphql/reference/mutations)

### 実装参考記事

- [Create GitHub issue hierarchy using the API](https://jessehouwing.net/create-github-issue-hierarchy-using-the-api/)
- [tasklist が廃止されるので sub-issue に移行しよう](https://zenn.dev/ncdc/articles/102516af97b172)

### GraphQL Mutation 例

```graphql
mutation addSubIssue {
  addSubIssue(input: { issueId: "I_123", subIssueId: "I_456" }) {
    issue {
      title
      subIssues {
        totalCount
      }
    }
    subIssue {
      title
      number
    }
  }
}
```

---

## 7. 設計詳細

### アーキテクチャ概要

Sub Issue 統合は、既存の GitHub 統合モジュール（`src/integrations/github/`）を拡張し、GraphQL API を使用して Sub Issue を管理します。

```
┌─────────────────────────────────────────────────────────┐
│  Slash Command: /cc-craft-kit:spec-phase <id> tasks    │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│  src/commands/spec/phase.ts                             │
│  - フェーズ更新処理                                         │
│  - EventBus.emit('spec.phase_changed')                  │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│  src/core/workflow/event-bus.ts                         │
│  - イベントハンドラー: onPhaseChanged()                     │
│  - tasks フェーズ移行時に Sub Issue 作成を自動実行            │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│  src/integrations/github/sub-issues.ts (新規)            │
│  - createSubIssuesFromTaskList()                        │
│  - getIssueNodeId()                                     │
│  - createSubIssueViaGraphQL()                           │
│  - updateSubIssueStatus()                               │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│  GitHub GraphQL API v4                                  │
│  - addSubIssue mutation                                 │
│  - removeSubIssue mutation                              │
│  - reprioritizeSubIssue mutation                        │
└─────────────────────────────────────────────────────────┘
```

### データモデル

#### 既存テーブルの拡張

`github_sync` テーブルに Sub Issue 情報を記録します。

```typescript
interface GitHubSyncRecord {
  id: string;
  entity_type: 'spec' | 'task' | 'sub_issue'; // 'sub_issue' を追加
  entity_id: string; // Sub Issue の場合、タスク ID を使用
  github_type: 'issue' | 'pull_request' | 'sub_issue'; // 'sub_issue' を追加
  github_id: number; // Sub Issue の Issue 番号
  github_node_id: string; // GraphQL で使用する Node ID
  repository: string;
  last_synced_at: string;
}
```

#### タスク情報の拡張（任意）

`tasks` テーブルに Sub Issue の GitHub Issue 番号を記録する列を追加（オプション）。

```sql
ALTER TABLE tasks ADD COLUMN github_issue_number INTEGER;
```

### API 設計

#### 新規モジュール: `src/integrations/github/sub-issues.ts`

```typescript
import { graphql } from '@octokit/graphql';
import type { Kysely } from 'kysely';
import type { Database } from '../../core/database/schema.js';

export interface SubIssueConfig {
  owner: string;
  repo: string;
  parentIssueNumber: number;
  taskList: Array<{ id: string; title: string; description?: string }>;
  githubToken: string;
}

export class SubIssueManager {
  constructor(
    private db: Kysely<Database>,
    private graphqlClient: typeof graphql
  ) {}

  /**
   * 仕様書の親 Issue から Sub Issue を一括作成
   */
  async createSubIssuesFromTaskList(
    config: SubIssueConfig
  ): Promise<void> {
    // 1. 親 Issue の Node ID を取得
    const parentNodeId = await this.getIssueNodeId(
      config.owner,
      config.repo,
      config.parentIssueNumber,
      config.githubToken
    );

    // 2. タスク数が 100 を超える場合は警告
    if (config.taskList.length > 100) {
      throw new Error(
        `Task count (${config.taskList.length}) exceeds GitHub limit (100)`
      );
    }

    // 3. 各タスクを Sub Issue として作成
    for (const task of config.taskList) {
      const subIssueNumber = await this.createSubIssue(
        config.owner,
        config.repo,
        task.title,
        task.description,
        config.githubToken
      );

      // 4. 親 Issue に Sub Issue を追加
      await this.addSubIssueToParent(
        parentNodeId,
        await this.getIssueNodeId(
          config.owner,
          config.repo,
          subIssueNumber,
          config.githubToken
        ),
        config.githubToken
      );

      // 5. github_sync テーブルに記録
      await this.recordSubIssueSyncData(
        task.id,
        subIssueNumber,
        config.owner,
        config.repo
      );
    }
  }

  /**
   * REST API で Issue の Node ID を取得
   */
  private async getIssueNodeId(
    owner: string,
    repo: string,
    issueNumber: number,
    token: string
  ): Promise<string> {
    const response = await fetch(
      `https://api.github.com/repos/${owner}/${repo}/issues/${issueNumber}`,
      {
        headers: {
          Authorization: `Bearer ${token}`,
          Accept: 'application/vnd.github+json',
        },
      }
    );

    if (!response.ok) {
      throw new Error(`Failed to get issue: ${response.statusText}`);
    }

    const issue = await response.json();
    return issue.node_id;
  }

  /**
   * REST API で Sub Issue を作成
   */
  private async createSubIssue(
    owner: string,
    repo: string,
    title: string,
    body: string | undefined,
    token: string
  ): Promise<number> {
    const response = await fetch(
      `https://api.github.com/repos/${owner}/${repo}/issues`,
      {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${token}`,
          Accept: 'application/vnd.github+json',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          title,
          body: body || '',
        }),
      }
    );

    if (!response.ok) {
      throw new Error(`Failed to create sub issue: ${response.statusText}`);
    }

    const issue = await response.json();
    return issue.number;
  }

  /**
   * GraphQL API で親 Issue に Sub Issue を追加
   */
  private async addSubIssueToParent(
    parentNodeId: string,
    subIssueNodeId: string,
    token: string
  ): Promise<void> {
    const mutation = `
      mutation addSubIssue($parentId: ID!, $subIssueId: ID!) {
        addSubIssue(input: { issueId: $parentId, subIssueId: $subIssueId }) {
          issue {
            title
            subIssues {
              totalCount
            }
          }
          subIssue {
            title
            number
          }
        }
      }
    `;

    await this.graphqlClient({
      query: mutation,
      parentId: parentNodeId,
      subIssueId: subIssueNodeId,
      headers: {
        authorization: `token ${token}`,
        'GraphQL-Features': 'sub_issues',
      },
    });
  }

  /**
   * github_sync テーブルに Sub Issue 情報を記録
   */
  private async recordSubIssueSyncData(
    taskId: string,
    issueNumber: number,
    owner: string,
    repo: string
  ): Promise<void> {
    await this.db
      .insertInto('github_sync')
      .values({
        id: crypto.randomUUID(),
        entity_type: 'sub_issue',
        entity_id: taskId,
        github_type: 'sub_issue',
        github_id: issueNumber,
        repository: `${owner}/${repo}`,
        last_synced_at: new Date().toISOString(),
      })
      .execute();
  }

  /**
   * Sub Issue のステータスを更新（タスク完了時）
   */
  async updateSubIssueStatus(
    taskId: string,
    status: 'open' | 'closed',
    token: string
  ): Promise<void> {
    // 1. github_sync から Sub Issue の GitHub Issue 番号を取得
    const syncRecord = await this.db
      .selectFrom('github_sync')
      .selectAll()
      .where('entity_id', '=', taskId)
      .where('entity_type', '=', 'sub_issue')
      .executeTakeFirst();

    if (!syncRecord) {
      throw new Error(`Sub issue not found for task: ${taskId}`);
    }

    const [owner, repo] = syncRecord.repository.split('/');

    // 2. REST API で Issue のステータスを更新
    const response = await fetch(
      `https://api.github.com/repos/${owner}/${repo}/issues/${syncRecord.github_id}`,
      {
        method: 'PATCH',
        headers: {
          Authorization: `Bearer ${token}`,
          Accept: 'application/vnd.github+json',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          state: status,
        }),
      }
    );

    if (!response.ok) {
      throw new Error(
        `Failed to update sub issue status: ${response.statusText}`
      );
    }

    // 3. github_sync の last_synced_at を更新
    await this.db
      .updateTable('github_sync')
      .set({ last_synced_at: new Date().toISOString() })
      .where('id', '=', syncRecord.id)
      .execute();
  }
}
```

#### イベントハンドラーの拡張: `src/core/workflow/event-bus.ts`

`spec.phase_changed` イベントで tasks フェーズに移行した際、自動的に Sub Issue を作成します。

```typescript
eventBus.on('spec.phase_changed', async (event) => {
  if (event.payload.newPhase === 'tasks') {
    const spec = await db
      .selectFrom('specs')
      .selectAll()
      .where('id', '=', event.entityId)
      .executeTakeFirst();

    if (!spec) return;

    // 仕様書から「8. 実装タスクリスト」を解析
    const taskList = parseTaskListFromSpec(spec.file_path);

    // GitHub 統合が有効な場合、Sub Issue を作成
    const githubConfig = await getGitHubConfig(db);
    if (githubConfig) {
      const subIssueManager = new SubIssueManager(db, graphql);
      await subIssueManager.createSubIssuesFromTaskList({
        owner: githubConfig.owner,
        repo: githubConfig.repo,
        parentIssueNumber: spec.github_issue_number,
        taskList,
        githubToken: githubConfig.token,
      });
    }
  }
});
```

### 実装方針

#### Phase 1: 基本機能実装

1. `src/integrations/github/sub-issues.ts` を新規作成
2. `SubIssueManager` クラスを実装
3. `createSubIssuesFromTaskList()` を実装
4. `getIssueNodeId()` を REST API で実装
5. `addSubIssueToParent()` を GraphQL API で実装

#### Phase 2: イベント統合

1. `src/core/workflow/event-bus.ts` に `spec.phase_changed` ハンドラーを追加
2. tasks フェーズ移行時に Sub Issue を自動作成
3. `parseTaskListFromSpec()` ユーティリティを実装

#### Phase 3: タスク完了時のステータス更新

1. `task.completed` イベントハンドラーを追加
2. `updateSubIssueStatus()` を実装
3. タスク完了時に Sub Issue を自動的に `closed` に更新

#### Phase 4: エラーハンドリングとリトライ

1. GraphQL API のレート制限エラーを検出
2. リトライロジックを実装（指数バックオフ）
3. Sub Issue 作成失敗時のログ記録

### セキュリティ考慮事項

- GitHub トークンは環境変数（`.env`）で管理し、コードに直接記述しない
- GraphQL API のレスポンスにセンシティブ情報が含まれる場合、ログに記録しない
- Sub Issue の説明に仕様書 ID を含めるが、機密情報は含めない

### パフォーマンス考慮事項

- Sub Issue 作成は非同期で実行し、ユーザーの操作をブロックしない
- GraphQL API のバッチ処理を検討（複数の Sub Issue を一度に作成）
- レート制限に達した場合、リトライ間隔を動的に調整

### 後方互換性

- 既存の仕様書は Sub Issue 機能を使用しない（オプトイン方式）
- `github_sync` テーブルに `entity_type` と `github_type` を追加しても、既存レコードに影響なし
- Sub Issue 機能を無効にする設定オプションを提供（`.env` の `ENABLE_SUB_ISSUES=false`）

---

## 8. 実装タスクリスト

### Phase 1: データベースとパッケージの準備

- [ ] **タスク 1**: データベーススキーマを拡張（github_sync テーブルに entity_type と github_type を追加）
  - マイグレーションファイルを作成
  - `entity_type` に `'sub_issue'` を追加
  - `github_type` に `'sub_issue'` を追加
  - `github_node_id` 列を追加（GraphQL で使用）
  - マイグレーションを実行してスキーマを更新

- [ ] **タスク 2**: @octokit/graphql パッケージをインストール
  - `npm install @octokit/graphql` を実行
  - `package.json` と `package-lock.json` を更新
  - 型定義ファイル（`@types/node`）が必要な場合は追加

### Phase 2: Sub Issue 管理モジュールの実装

- [ ] **タスク 3**: src/integrations/github/sub-issues.ts を新規作成
  - ファイルを作成し、基本的なインポート文を追加
  - `SubIssueConfig` インターフェースを定義
  - `SubIssueManager` クラスの骨組みを作成

- [ ] **タスク 4**: SubIssueManager クラスの基本構造を実装
  - コンストラクタで `Kysely<Database>` と `graphql` クライアントを受け取る
  - TSyringe による DI 対応（`@injectable()` デコレーター）
  - エラーハンドリング用の基底クラスを継承

- [ ] **タスク 5**: getIssueNodeId() メソッドを実装（REST API で Node ID 取得）
  - REST API で Issue の詳細を取得
  - `node_id` フィールドを抽出
  - エラーハンドリング（404 Not Found, 401 Unauthorized 等）
  - レート制限チェック

- [ ] **タスク 6**: createSubIssue() メソッドを実装（REST API で Issue 作成）
  - REST API で新しい Issue を作成
  - タイトルと説明を設定
  - Issue 番号を返す
  - エラーハンドリング（422 Validation Failed 等）

- [ ] **タスク 7**: addSubIssueToParent() メソッドを実装（GraphQL API で親子関係を作成）
  - GraphQL mutation `addSubIssue` を実行
  - `GraphQL-Features: sub_issues` ヘッダーを含める
  - 親 Issue の Node ID と Sub Issue の Node ID を渡す
  - エラーハンドリング（GraphQL エラーレスポンス）

- [ ] **タスク 8**: createSubIssuesFromTaskList() メソッドを実装（タスクリストから一括作成）
  - タスク数が 100 を超える場合はエラー
  - 各タスクを順次処理
  - Sub Issue を作成し、親 Issue に追加
  - `github_sync` テーブルに記録
  - プログレス表示（進捗ログ）

- [ ] **タスク 9**: updateSubIssueStatus() メソッドを実装（タスク完了時のステータス更新）
  - `github_sync` から Sub Issue の Issue 番号を取得
  - REST API で Issue のステータスを `open` / `closed` に更新
  - `last_synced_at` を更新
  - エラーハンドリング

### Phase 3: イベント統合とユーティリティ

- [ ] **タスク 10**: parseTaskListFromSpec() ユーティリティを実装（仕様書からタスクリスト解析）
  - 仕様書ファイルを読み込み
  - 「## 8. 実装タスクリスト」セクションを抽出
  - Markdown チェックリストを解析
  - タスク ID, タイトル, 説明を抽出
  - タスク配列を返す

- [ ] **タスク 11**: src/core/workflow/event-bus.ts にイベントハンドラーを追加（tasks フェーズ移行時の自動作成）
  - `spec.phase_changed` イベントを購読
  - `newPhase === 'tasks'` の場合に処理
  - `parseTaskListFromSpec()` でタスクリストを解析
  - `SubIssueManager.createSubIssuesFromTaskList()` を呼び出し
  - エラーハンドリングとログ記録

- [ ] **タスク 12**: task.completed イベントハンドラーを追加（タスク完了時の自動ステータス更新）
  - `task.completed` イベントを購読
  - `SubIssueManager.updateSubIssueStatus()` を呼び出し
  - Sub Issue のステータスを `closed` に更新
  - エラーハンドリングとログ記録

### Phase 4: エラーハンドリングとテスト

- [ ] **タスク 13**: エラーハンドリングとリトライロジックを実装（レート制限対応）
  - GraphQL API のレート制限エラー（`RATE_LIMITED`）を検出
  - 指数バックオフでリトライ（最大 3 回）
  - リトライ間隔を動的に調整（1秒 → 2秒 → 4秒）
  - ログにリトライ回数を記録

- [ ] **タスク 14**: 単体テストを作成（SubIssueManager クラスのテスト）
  - `tests/integrations/github/sub-issues.test.ts` を作成
  - `getIssueNodeId()` のテスト（モック REST API）
  - `createSubIssue()` のテスト（モック REST API）
  - `addSubIssueToParent()` のテスト（モック GraphQL API）
  - `createSubIssuesFromTaskList()` のテスト（統合）
  - `updateSubIssueStatus()` のテスト

- [ ] **タスク 15**: 統合テストを作成（E2E でフェーズ移行から Sub Issue 作成まで検証）
  - `tests/e2e/sub-issues-workflow.test.ts` を作成
  - 仕様書作成 → GitHub Issue 作成 → tasks フェーズ移行 → Sub Issue 自動作成を検証
  - タスク完了 → Sub Issue ステータス更新を検証
  - GitHub API のモック化（レート制限回避）

### 実装の依存関係

```
タスク 1 → タスク 3, 4
タスク 2 → タスク 7
タスク 3 → タスク 4, 5, 6, 7, 8, 9
タスク 4 → タスク 5, 6, 7, 8, 9
タスク 5, 6, 7 → タスク 8
タスク 8, 9 → タスク 11, 12
タスク 10 → タスク 11
タスク 11, 12 → タスク 15
タスク 13 → タスク 14, 15
```

### 工数見積もり

| フェーズ | タスク数 | 見積もり工数 |
|---|---|---|
| Phase 1 | 2 | 2-3 時間 |
| Phase 2 | 7 | 12-16 時間 |
| Phase 3 | 3 | 6-8 時間 |
| Phase 4 | 3 | 6-8 時間 |
| **合計** | **15** | **26-35 時間** |
