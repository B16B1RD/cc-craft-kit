---
id: "2bd1d231-d699-45c3-ad1d-61ef939a73fb"
name: "completed フェーズ移行時にブランチ切り替えが行われない"
phase: "review"
branch_name: "fix/spec-2bd1d231-completed-phase-branch-switch"
github_issue_number: null
pr_url: null
created_at: "2025-12-07T05:35:00.000Z"
updated_at: "2025-12-07T06:30:00.000Z"
---

# completed フェーズ移行時にブランチ切り替えが行われない

## 1. 背景と目的

### 背景

`/cft:spec phase <id> completed` を実行した際、以下の問題が発生する:

1. 作業ブランチにいたまま completed フェーズに移行してしまう
2. ローカルの作業ブランチが削除されない
3. ユーザーが手動で develop に切り替え、ブランチを削除する必要がある

**原因:**
`.claude/commands/cft/spec.md` の Step 7（フェーズ固有の後処理）の completed フェーズの記述に、develop への切り替え処理が含まれていない。

現在の記述:
```markdown
**completed フェーズ:**
- ブランチ削除（`git branch -d`）
- GitHub Issue クローズ（`gh issue close`）
```

### 目的

completed フェーズ移行時に、自動的に develop ブランチに切り替え、ローカルの作業ブランチを削除するように修正する。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] completed フェーズ移行後、develop ブランチにいること
- [ ] ローカルの作業ブランチが削除されていること

### 機能要件

- [ ] `/cft:spec phase <id> completed` 実行時に develop に自動切り替え
- [ ] 切り替え後にローカルブランチを削除
- [ ] GitHub Issue をクローズ

### 非機能要件

- [ ] 未コミットの変更がある場合は警告を表示
- [ ] ブランチ削除失敗時は警告表示のみ（処理を中断しない）

---

## 4. 制約条件

- スラッシュコマンド（.md ファイル）のみで実装
- TypeScript は使用しない

---

## 5. 依存関係

- `.claude/commands/cft/spec.md`

---

## 6. 参考情報

- 発生した Issue: 仕様書 #843775ce の completed フェーズ移行時

---

## 7. 設計詳細

### 7.1 修正対象ファイル

| ファイル | 修正内容 |
|----------|----------|
| `.claude/commands/cft/spec.md` | completed フェーズの後処理に develop 切り替えとブランチ削除の順序を明記 |

### 7.2 現状の問題点

`.claude/commands/cft/spec.md` の Step 7（フェーズ固有の後処理）の completed フェーズの記述:

```markdown
**completed フェーズ:**
- ブランチ削除（`git branch -d`）
- GitHub Issue クローズ（`gh issue close`）
```

**問題点:**
1. 作業ブランチにいる状態で `git branch -d` を実行しても、自分自身は削除できない
2. develop への切り替え処理が記述されていない
3. 実行順序が不明確

### 7.3 修正方針

completed フェーズの後処理を以下のように修正:

```markdown
**completed フェーズ:**
- ベースブランチ（develop）に切り替え（`git checkout develop && git pull origin develop`）
- ローカル作業ブランチを削除（`git branch -D "$BRANCH_NAME"`）
- GitHub Issue クローズ（`gh issue close`）
```

**修正ポイント:**
1. まず develop に切り替え、最新化する
2. その後でローカルブランチを削除（`-D` で強制削除）
3. 最後に GitHub Issue をクローズ

### 7.4 エラーハンドリング

| ケース | 対応 |
|--------|------|
| 未コミットの変更がある | 警告を表示し、stash を提案 |
| develop への切り替え失敗 | エラーメッセージを表示し、処理を中断 |
| ブランチ削除失敗 | 警告を表示し、処理を継続 |
| Issue クローズ失敗 | 警告を表示し、処理を継続 |

### 7.5 変更差分

`.claude/commands/cft/spec.md` の 391-393 行目付近:

**Before:**
```markdown
**completed フェーズ:**
- ブランチ削除（`git branch -d`）
- GitHub Issue クローズ（`gh issue close`）
```

**After:**
```markdown
**completed フェーズ:**
- ベースブランチ（develop）に切り替え・最新化（`git checkout develop && git pull origin develop`）
- ローカル作業ブランチを削除（`git branch -D "$BRANCH_NAME"`）
- GitHub Issue クローズ（`gh issue close`）
```

---

## 8. 実装タスクリスト

### Phase 1: spec.md の修正

- [x] Step 7 の completed フェーズ後処理を修正
