---
id: "a3d481a7-e2c8-4864-948a-c8915c55f5b9"
name: "Git 自動コミット機能が .gitignore により失敗する問題を修正"
phase: "completed"
branch_name: "main"
github_issue_number: null
pr_url: null
created_at: "2025-11-19T22:11:47Z"
updated_at: "2025-11-19T22:23:04Z"
---

# Git 自動コミット機能が .gitignore により失敗する問題を修正


## 1. 背景と目的

### 背景

completed フェーズ移行時、.cc-craft-kit/ ディレクトリが .gitignore に含まれているため、Git 自動コミットが 'No staged files found' エラーで失敗する。仕様書ファイルの変更履歴が記録されず、開発履歴の追跡が不可能になっている。

### 目的

Git 自動コミット機能を修正し、`.gitignore` に含まれるファイルでもエラーなく動作するようにすることで、仕様書の変更履歴を適切に記録し、開発プロセスの透明性を確保する。
---

## 2. 対象ユーザー

cc-craft-kit の開発者および、cc-craft-kit を使用してプロジェクト管理を行う全ユーザー
---

## 3. 受け入れ基準

### 必須要件

- [ ] completed フェーズ移行時に Git 自動コミットが "No staged files found" エラーで失敗しない
- [ ] `.gitignore` に含まれるファイルがある場合でも、Git 管理されているファイルは正常にコミットされる
- [ ] `git log --oneline .cc-craft-kit/specs/` で仕様書の全フェーズ変更コミットが表示されること
- [ ] `git show <commit-hash>` で各フェーズ時点の仕様書内容が確認可能であること

### 機能要件

- [ ] `.gitignore` に以下の形式で設定を追加する：
  ```
  .cc-craft-kit/
  !.cc-craft-kit/specs/
  !.cc-craft-kit/specs/*.md
  ```
- [ ] 変更後、`git add .cc-craft-kit/specs/test.md && git status` で仕様書ファイルがステージング対象になることを確認
- [ ] データベースファイル（`.cc-craft-kit/cc-craft-kit.db`）は引き続き `.gitignore` に含め、コミット対象外であることを確認
- [ ] フェーズ移行時の自動コミットメッセージに仕様書名を含める

### 非機能要件

- [ ] 既存のフェーズ移行ワークフローに影響を与えない
- [ ] Git 操作のエラーハンドリングが適切に実装されている
- [ ] ドキュメント（CLAUDE.md）にファイル管理方針を明記する
---

## 4. 制約条件

- `.cc-craft-kit/` ディレクトリはドッグフーディング用のため、基本的に `.gitignore` に含める必要がある
- 仕様書ファイルのみ例外的に Git 管理する設計とする
- Git 自動コミット機能は `src/core/workflow/git-integration.ts` で実装されている
- `.gitignore` の変更は慎重に行い、意図しないファイルがコミットされないようにする
---

## 5. 依存関係

- `src/core/workflow/git-integration.ts` - Git 自動コミット処理
- `src/core/workflow/event-bus.ts` - イベント駆動アーキテクチャ
- `.gitignore` - Git 管理対象外ファイルの定義
- GitHub Actions CI ワークフロー（`.github/workflows/ci.yml`）
---

## 6. 参考情報

- Issue #213: https://github.com/B16B1RD/cc-craft-kit/issues/213
- 関連するエラーログ: "No staged files found" at `git-integration.ts:199`
- Git ドキュメント: https://git-scm.com/docs/gitignore
- `.gitignore` のネゲーションパターン: `!` プレフィックスで除外を上書き可能
---

## 7. テスト方法

### テスト環境

- Git リポジトリが初期化されている
- `.cc-craft-kit/` ディレクトリが `.gitignore` に含まれている

### テストケース 1: 仕様書ファイルがコミット対象になることを確認

1. `/cft:spec-create "テスト仕様書" "テスト用の仕様書"` で新仕様書を作成
2. `git status` で `.cc-craft-kit/specs/<spec-id>.md` がステージング対象になることを確認
3. `/cft:spec-phase <spec-id> tasks` で `tasks` フェーズに移行
4. `git log --oneline .cc-craft-kit/specs/` でコミットが記録されていることを確認
5. `git show HEAD:.cc-craft-kit/specs/<spec-id>.md` で仕様書内容が保存されていることを確認

### テストケース 2: データベースファイルはコミット対象外であることを確認

1. `.cc-craft-kit/cc-craft-kit.db` が存在することを確認
2. `git add .cc-craft-kit/cc-craft-kit.db` を実行
3. `git status` で「The following paths are ignored by one of your .gitignore files」と表示されることを確認

### テストケース 3: completed フェーズで全変更ファイルがコミットされることを確認

1. 実装ファイルを編集（例: `src/commands/test.ts`）
2. `/cft:spec-phase <spec-id> completed` で `completed` フェーズに移行
3. `git log --oneline -1` で実装ファイルと仕様書ファイルを含むコミットが記録されていることを確認
4. "No staged files found" エラーが発生しないことを確認

### テストケース 4: フェーズ移行時のコミットメッセージ確認

1. `/cft:spec-phase <spec-id> design` でフェーズ移行
2. `git log --oneline -1` で「feat: <仕様書名> の設計を完了」というコミットメッセージが記録されていることを確認
---

## 8. 実装タスクリスト

### タスク概要

受け入れ基準を基に、以下の実装タスクに分解しました。各タスクは独立して実行可能です。

### タスク一覧

| # | タスク | ステータス | 優先度 | 依存関係 |
|---|---|---|---|---|
| 1 | `.gitignore` にネゲーションパターンを追加して `.cc-craft-kit/specs/` を Git 管理対象にする | 未着手 | 高 | なし |
| 2 | 仕様書ファイルがステージング対象になることを確認するテストを実行 | 未着手 | 高 | タスク 1 |
| 3 | データベースファイルがコミット対象外であることを確認するテストを実行 | 未着手 | 中 | タスク 1 |
| 4 | completed フェーズ移行時の全変更ファイルコミットをテスト | 未着手 | 高 | タスク 1, 2, 3 |
| 5 | CLAUDE.md にファイル管理方針を明記する | 未着手 | 中 | タスク 1 |

### タスク詳細

#### タスク 1: `.gitignore` にネゲーションパターンを追加

**目的:** `.cc-craft-kit/specs/` ディレクトリのみ Git 管理対象にする

**実施内容:**
1. `.gitignore` ファイルを開く
2. 既存の `.cc-craft-kit/` エントリを確認
3. 以下のネゲーションパターンを追加:
   ```
   .cc-craft-kit/
   !.cc-craft-kit/specs/
   !.cc-craft-kit/specs/*.md
   ```
4. `git status` で `.cc-craft-kit/specs/` 配下のファイルがステージング対象になることを確認

**期待結果:** 仕様書ファイル（`.cc-craft-kit/specs/*.md`）が Git 管理対象になる

#### タスク 2: 仕様書ファイルのステージング確認テスト

**目的:** `.gitignore` の変更が正しく機能することを確認

**実施内容:**
1. テスト用の仕様書ファイルを作成: `touch .cc-craft-kit/specs/test.md`
2. `git add .cc-craft-kit/specs/test.md` を実行
3. `git status` でファイルがステージングされていることを確認
4. テストファイルを削除: `git reset HEAD .cc-craft-kit/specs/test.md && rm .cc-craft-kit/specs/test.md`

**期待結果:** 仕様書ファイルが正常にステージングされる

#### タスク 3: データベースファイルのコミット対象外確認テスト

**目的:** データベースファイルが引き続き `.gitignore` で除外されることを確認

**実施内容:**
1. `.cc-craft-kit/cc-craft-kit.db` が存在することを確認
2. `git add .cc-craft-kit/cc-craft-kit.db` を実行
3. `git status` で「The following paths are ignored by one of your .gitignore files」と表示されることを確認

**期待結果:** データベースファイルがコミット対象外であることを確認

#### タスク 4: completed フェーズ移行時の全変更ファイルコミットをテスト

**目的:** フェーズ移行時に仕様書ファイルと実装ファイルの両方が正常にコミットされることを確認

**実施内容:**
1. 本仕様書 (a3d481a7) を implementation フェーズに移行
2. タスク 1-3 を実装
3. `/cft:spec-phase a3d481a7 completed` で completed フェーズに移行
4. `git log --oneline -1` でコミットが記録されていることを確認
5. "No staged files found" エラーが発生しないことを確認

**期待結果:** エラーなく自動コミットが実行され、仕様書ファイルの変更が記録される

#### タスク 5: CLAUDE.md にファイル管理方針を明記

**目的:** `.cc-craft-kit/` ディレクトリのファイル管理方針をドキュメント化

**実施内容:**
1. `CLAUDE.md` を開く
2. 「## ソースコード管理」セクションを探す
3. 以下の内容を追加:
   ```markdown
   ### .cc-craft-kit/ ディレクトリのファイル管理

   - **基本方針**: `.cc-craft-kit/` ディレクトリは `.gitignore` に含まれ、Git 管理対象外
   - **例外**: `.cc-craft-kit/specs/*.md` (仕様書ファイル) のみ Git 管理対象
   - **理由**: ドッグフーディング環境のため、データベース等の自動生成ファイルは除外するが、仕様書の変更履歴は記録する必要がある
   ```

**期待結果:** ファイル管理方針が CLAUDE.md に明記される

### 工数見積もり

| タスク | 見積もり時間 |
|---|---|
| タスク 1 | 10 分 |
| タスク 2 | 10 分 |
| タスク 3 | 5 分 |
| タスク 4 | 15 分 |
| タスク 5 | 10 分 |
| **合計** | **50 分**
