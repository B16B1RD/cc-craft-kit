# インストールで警告表示

**仕様書 ID:** f88b168a-bafe-481a-b04c-3d6517858195
**フェーズ:** review
**作成日時:** 2025/12/04 12:00:00
**更新日時:** 2025/12/04 22:27:00

---

## 1. 背景と目的

### 背景

インストール実行時（`curl -fsSL ... | sh`）に以下の警告が表示される問題がある：

1. **`.env.example` が見つからない警告**: リリースアーカイブ（`.cc-craft-kit.tar.gz`）に `.env.example` が含まれていないため、`generate_env()` 関数で警告が表示される
2. **`\n` が改行されない問題**: `warn()` 関数で `\n` がリテラル文字列として表示され、改行エスケープシーケンスが機能していない
3. **既存 `.env` の上書きリスク**: 現在の実装では既存 `.env` はスキップされるが、ユーザーへのフィードバックが不明確

### 目的

インストールスクリプトの警告表示を修正し、ユーザーが問題なくセットアップを完了できるようにする

---

## 2. 対象ユーザー

cc-craft-kit を新規インストールする開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `.env.example` がリリースアーカイブに含まれ、インストール時に `.env` が自動生成される
- [ ] 警告メッセージ内の `\n` が正しく改行として表示される

### 機能要件

- [ ] `release.yml` で `.env.example` を `.cc-craft-kit/` にコピーしてからアーカイブを作成する
- [ ] `install.sh` の `warn()` 関数で改行エスケープシーケンスが正しく処理される
- [ ] 既存 `.env` が存在する場合、上書きせず保持する旨を明確に表示する

### 非機能要件

- [ ] POSIX シェル準拠を維持する（macOS、Linux、Git Bash 対応）
- [ ] 既存のインストールフローを破壊しない

---

## 4. 制約条件

- シェルスクリプトは POSIX 準拠を維持する必要がある
- GitHub Actions 環境（ubuntu-latest）での動作確認が必要
- プロンプトファースト原則に従い、TypeScript よりシェルスクリプト修正を優先

---

## 5. 依存関係

- `scripts/install.sh` - インストールスクリプト本体
- `.github/workflows/release.yml` - リリースアーカイブ生成
- `.env.example` - 環境変数テンプレート

---

## 6. 参考情報

- 問題のあるコード箇所:
  - `scripts/install.sh:260, 267` - `\n` が改行されない warn 呼び出し
  - `scripts/install.sh:287` - `.env.example` の探索パス
  - `.github/workflows/release.yml:32` - アーカイブ生成（`.env.example` 未包含）

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
[GitHub Release Process]
    │
    ▼
┌─────────────────────────────┐
│  release.yml                │
│  ├─ .env.example コピー     │  ← 追加: アーカイブ前に .cc-craft-kit/ へコピー
│  └─ tar -czf アーカイブ作成 │
└─────────────────────────────┘
    │
    ▼ .cc-craft-kit.tar.gz
    │
┌─────────────────────────────┐
│  install.sh                 │
│  ├─ アーカイブ展開          │
│  ├─ シンボリックリンク作成  │  ← 修正: 複数行警告の表示改善
│  └─ generate_env()          │  ← 修正: 既存 .env 時のメッセージ改善
└─────────────────────────────┘
```

#### 設計方針

1. **最小限の変更**: 既存のアーキテクチャを維持しつつ、問題箇所のみを修正
2. **POSIX 準拠**: `echo -e` 等の非移植的機能を避け、複数の `echo` 呼び出しで対応
3. **UX 改善**: ユーザーに明確なフィードバックを提供

#### 処理フロー詳細

**リリース時フロー（release.yml）:**
```
1. バージョン取得
2. .env.example を .cc-craft-kit/ にコピー  ← 追加
3. tar -czf でアーカイブ作成
4. GitHub Release 作成
5. コピーした .env.example を削除（クリーンアップ）  ← 追加
```

**インストール時フロー（install.sh）:**
```
1. アーカイブダウンロード・展開
2. シンボリックリンク作成
   └─ 失敗時: 複数行で警告表示  ← 修正
3. generate_env() 実行
   ├─ .env 存在時: 「保持します」と明示  ← 修正
   └─ .env.example 存在時: .env 生成
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `.github/workflows/release.yml` | アーカイブ作成前に `.env.example` を `.cc-craft-kit/` にコピー |
| `scripts/install.sh:260` | `\n` を含む警告を複数の `echo` に分割 |
| `scripts/install.sh:267` | `\n` を含む警告を複数の `echo` に分割 |
| `scripts/install.sh:283-285` | 既存 `.env` 保持時のメッセージを明確化 |

#### 複数行警告の実装パターン

**修正前:**
```sh
warn "シンボリックリンク作成失敗。\n手動で作成: ln -s ..."
```

**修正後:**
```sh
warn "シンボリックリンクの作成に失敗しました。"
echo "  手動で作成してください:" >&2
echo "    ln -s ../../.cc-craft-kit/commands \$INSTALL_DIR/.claude/commands/cft" >&2
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| アーカイブ生成 | `.cc-craft-kit/` のみ圧縮 | `.env.example` をコピー後に圧縮 | release.yml:31-35 |
| 警告メッセージ | `\n` がリテラル出力 | 複数 `echo` で改行表示 | install.sh:260, 267 |
| 既存 .env 処理 | 暗黙的にスキップ | 「保持します」と明示 | install.sh:283-285 |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| release.yml | アーカイブに `.env.example` が含まれる | `tar -tzf` で内容確認 |
| install.sh 警告表示 | 改行が正しく表示される | 手動実行テスト |
| install.sh .env 生成 | 既存ファイル時のメッセージ | 既存 .env がある状態でインストール |
| クロスプラットフォーム | macOS, Linux, Git Bash | 各環境で手動テスト |

### 7.5 移行計画

#### Phase 1: release.yml 修正
1. `.env.example` を `.cc-craft-kit/` にコピーするステップ追加
2. アーカイブ作成後にコピーしたファイルを削除（リポジトリをクリーンに保つ）

#### Phase 2: install.sh 警告表示修正
1. 行260の `warn()` 呼び出しを複数行に分割
2. 行267の `warn()` 呼び出しを複数行に分割

#### Phase 3: install.sh .env 生成改善
1. 既存 `.env` 存在時のメッセージを明確化
2. 「上書きせず保持します」と明示

---

## 8. 実装タスクリスト

### Phase 1: アーカイブ生成修正

- [x] release.yml でアーカイブ作成前に `.env.example` を `.cc-craft-kit/` にコピー (#673)
- [x] release.yml でアーカイブ作成後にコピーした `.env.example` を削除（クリーンアップ） (#674)

### Phase 2: 警告表示修正

- [x] install.sh:260 の `warn()` 呼び出しを複数の `echo` に分割 (#675)
- [x] install.sh:267 の `warn()` 呼び出しを複数の `echo` に分割 (#676)

### Phase 3: .env 生成改善

- [x] install.sh の `generate_env()` で既存 `.env` 保持時のメッセージを明確化 (#677)

---

## Pull Request

- https://github.com/B16B1RD/cc-craft-kit/pull/678
