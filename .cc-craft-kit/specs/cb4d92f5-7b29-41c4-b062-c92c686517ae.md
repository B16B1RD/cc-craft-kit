# Issue のプロジェクトステータスが更新されない

**仕様書 ID:** cb4d92f5-7b29-41c4-b062-c92c686517ae
**フェーズ:** completed
**作成日時:** 2025/11/16 19:51:38
**更新日時:** 2025/11/16 20:36:23

---

## 1. 背景と目的

### 背景

現在、Takumi は仕様書作成時に GitHub Issue を自動作成し、Project に追加する機能を持っています。
また、`spec.phase_changed` イベントで Issue のラベルを `phase:XXX` に更新しています。

しかし、GitHub Project のステータスフィールド（例: "Todo", "In Progress", "Done"）は更新されていません。
これにより、Project ボード上でフェーズ変更が視覚的に反映されず、進捗管理が困難になっています。

### 目的

仕様書のフェーズが変更されたとき、GitHub Project のステータスフィールドを自動的に更新し、
Project ボード上で進捗を視覚的に追跡できるようにする。

---

## 2. 対象ユーザー

- Takumi を使用して GitHub Projects で進捗管理を行っている開発者
- 複数の仕様書のフェーズを視覚的に追跡したい開発チーム

---

## 3. 受け入れ基準

### 必須要件

- [ ] `takumi spec phase <spec-id> <phase>` コマンド実行時、GitHub Project のステータスフィールドが自動更新される
- [ ] フェーズとステータスのマッピングが正しく適用される
- [ ] Project に追加されていない仕様書の場合、エラーが発生しない（スキップする）

### 機能要件

- [ ] フェーズ → ステータスのマッピング実装
  - `requirements` → "Todo"
  - `design` → "In Progress"
  - `tasks` → "In Progress"
  - `implementation` → "In Progress"
  - `completed` → "Done"
- [ ] `spec.phase_changed` イベントハンドラーに Project ステータス更新処理を追加
- [ ] Project Item ID をデータベースに保存（`specs.github_project_item_id` カラム追加）
- [ ] GitHub Projects GraphQL API の `updateProjectV2ItemFieldValue` を使用

### 非機能要件

- [ ] GitHub API レート制限を考慮したエラーハンドリング
- [ ] Project ステータス更新失敗時も仕様書のフェーズ変更は成功させる（ベストエフォート）
- [ ] 既存のテストを破壊しない

---

## 4. 制約条件

- GitHub Projects v2 API（GraphQL）を使用する必要がある（REST API では Project フィールド更新が未対応）
- Project のステータスフィールド名は "Status" を前提とする（カスタマイズ可能にすることも検討）
- GitHub Personal Access Token に `project` スコープが必要
- Classic Personal Access Token が推奨（Fine-grained PAT は Organization Projects のみ対応）

---

## 5. 依存関係

### 既存コンポーネント

- `src/integrations/github/projects.ts` - `GitHubProjects` クラスに既存の `updateItemField()` メソッドがある
- `src/core/workflow/github-integration.ts` - `spec.phase_changed` イベントハンドラーが存在
- `src/core/database/schema.ts` - `specs` テーブルにカラム追加が必要

### 新規追加が必要

- データベースマイグレーション（`github_project_item_id` カラム追加）
- Project のステータスフィールド ID を取得する機能
- フェーズ → ステータス値のマッピングロジック

---

## 6. 参考情報

### 関連コード

- `src/integrations/github/projects.ts:179-205` - `updateItemField()` メソッド
- `src/core/workflow/github-integration.ts:169-211` - `spec.phase_changed` イベントハンドラー
- `src/cli/commands/github/project-add.ts:113-117` - Project への Issue 追加処理

### GitHub API ドキュメント

- [Projects v2 GraphQL API](https://docs.github.com/en/graphql/reference/mutations#updateprojectv2itemfieldvalue)
- [Project フィールド取得](https://docs.github.com/en/graphql/reference/objects#projectv2field)

### 技術課題

1. Project Item ID の取得方法
   - Issue を Project に追加したときの戻り値 `item.id` を保存する
   - または GraphQL で Issue から Project Item ID を逆引きする

2. ステータスフィールド ID の取得方法
   - Project のフィールド一覧を取得して "Status" フィールドを検索
   - フィールド ID とオプション ID（"Todo", "In Progress", "Done"）を取得

3. SINGLE_SELECT フィールドの値更新方法
   - `updateProjectV2ItemFieldValue` mutation に `singleSelectOptionId` を渡す

---

## 7. 設計

### 7.1 データベーススキーマ変更

#### マイグレーション: `002_add_project_item_id.ts`

```typescript
// specs テーブルに新しいカラムを追加
ALTER TABLE specs ADD COLUMN github_project_item_id TEXT;
```

**カラム詳細:**

- `github_project_item_id` (TEXT, nullable) - GitHub Project v2 の Item Node ID

### 7.2 アーキテクチャ

```text
┌─────────────────────────────────────────────────────────────┐
│  CLI: takumi spec phase <spec-id> <phase>                   │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  WorkflowPipeline.updatePhase()                             │
│  - データベース更新                                          │
│  - spec.phase_changed イベント発火                          │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│  EventBus: spec.phase_changed                               │
└───────────┬─────────────────────────────────────────────────┘
            │
            ├─────────────────────────────────────────────────┐
            │                                                 │
            ▼                                                 ▼
┌───────────────────────────┐      ┌──────────────────────────────────┐
│ Issue ラベル更新          │      │ Project ステータス更新 (NEW!)   │
│ (既存実装)                │      │                                  │
│ - GitHubIssues.update()   │      │ 1. Project Item ID 取得          │
│ - labels: [phase:XXX]     │      │ 2. ステータスフィールド ID 取得  │
└───────────────────────────┘      │ 3. フェーズ→ステータス変換       │
                                   │ 4. GitHubProjects.updateStatus() │
                                   └──────────────────────────────────┘
```

### 7.3 GitHub Projects API 設計

#### 新規メソッド: `GitHubProjects.getProjectFields()`

プロジェクトのフィールド一覧とオプションを取得します。

```graphql
query($owner: String!, $number: Int!) {
  user(login: $owner) {
    projectV2(number: $number) {
      id
      fields(first: 20) {
        nodes {
          ... on ProjectV2SingleSelectField {
            id
            name
            options {
              id
              name
            }
          }
        }
      }
    }
  }
}
```

**レスポンス例:**

```json
{
  "fields": {
    "nodes": [
      {
        "id": "PVTSSF_lADO...",
        "name": "Status",
        "options": [
          { "id": "f75ad846", "name": "Todo" },
          { "id": "47fc9ee4", "name": "In Progress" },
          { "id": "98236657", "name": "Done" }
        ]
      }
    ]
  }
}
```

#### 改善メソッド: `GitHubProjects.updateItemField()`

既存の `updateItemField()` を SINGLE_SELECT フィールド対応に改善します。

**変更前:**

```typescript
async updateItemField(params: UpdateProjectItemFieldParams): Promise<{ id: string }> {
  // value を { text: params.value.toString() } で渡している
}
```

**変更後:**

```typescript
async updateItemField(params: UpdateProjectItemFieldParams & {
  fieldType: 'TEXT' | 'SINGLE_SELECT';
  optionId?: string; // SINGLE_SELECT の場合に必要
}): Promise<{ id: string }> {
  const value = params.fieldType === 'SINGLE_SELECT'
    ? { singleSelectOptionId: params.optionId }
    : { text: params.value.toString() };

  // mutation に value を渡す
}
```

#### 新規メソッド: `GitHubProjects.updateProjectStatus()`

高レベル API として、ステータス更新をラップします。

```typescript
async updateProjectStatus(params: {
  owner: string;
  projectNumber: number;
  itemId: string;
  status: 'Todo' | 'In Progress' | 'Done';
}): Promise<void> {
  // 1. Project のフィールド一覧を取得
  const fields = await this.getProjectFields(params.owner, params.projectNumber);

  // 2. "Status" フィールドを検索
  const statusField = fields.find(f => f.name === 'Status');
  if (!statusField) {
    throw new Error('Status field not found in project');
  }

  // 3. ステータスオプション ID を検索
  const option = statusField.options.find(o => o.name === params.status);
  if (!option) {
    throw new Error(`Status option "${params.status}" not found`);
  }

  // 4. フィールド更新
  const project = await this.get(params.owner, params.projectNumber);
  await this.updateItemField({
    projectId: project.id,
    itemId: params.itemId,
    fieldId: statusField.id,
    fieldType: 'SINGLE_SELECT',
    optionId: option.id,
  });
}
```

### 7.4 フェーズ → ステータスマッピング

```typescript
// src/integrations/github/phase-status-mapper.ts

export type Phase = 'requirements' | 'design' | 'tasks' | 'implementation' | 'completed';
export type ProjectStatus = 'Todo' | 'In Progress' | 'Done';

export function mapPhaseToStatus(phase: Phase): ProjectStatus {
  const mapping: Record<Phase, ProjectStatus> = {
    requirements: 'Todo',
    design: 'In Progress',
    tasks: 'In Progress',
    implementation: 'In Progress',
    completed: 'Done',
  };

  return mapping[phase];
}
```

### 7.5 イベントハンドラー拡張

`src/core/workflow/github-integration.ts` の `spec.phase_changed` ハンドラーに追加します。

```typescript
eventBus.on<{ oldPhase: string; newPhase: string }>(
  'spec.phase_changed',
  async (event: WorkflowEvent<{ oldPhase: string; newPhase: string }>) => {
    try {
      const githubToken = process.env.GITHUB_TOKEN;
      if (!githubToken) return;

      const cwd = process.cwd();
      const ccCraftKitDir = join(cwd, '.cc-craft-kit');
      const githubConfig = getGitHubConfig(ccCraftKitDir);
      if (!githubConfig) return;

      const spec = await db
        .selectFrom('specs')
        .where('id', '=', event.specId)
        .selectAll()
        .executeTakeFirst();

      if (!spec || !spec.github_issue_id) return;

      const client = new GitHubClient({ token: githubToken });
      const issues = new GitHubIssues(client);
      const projects = new GitHubProjects(client);

      // Issue ラベル更新（既存）
      await issues.update({
        owner: githubConfig.owner,
        repo: githubConfig.repo,
        issueNumber: spec.github_issue_id,
        labels: [`phase:${event.data.newPhase}`],
      });

      // ========== ここから新規追加 ==========

      // Project ステータス更新
      if (spec.github_project_item_id) {
        try {
          const projectNumber = await resolveProjectId(ccCraftKitDir, githubToken);
          if (!projectNumber) return;

          const newStatus = mapPhaseToStatus(event.data.newPhase as Phase);

          await projects.updateProjectStatus({
            owner: githubConfig.owner,
            projectNumber,
            itemId: spec.github_project_item_id,
            status: newStatus,
          });

          console.log(`✓ Updated project status to "${newStatus}"`);
        } catch (projectError) {
          // Project 更新失敗は警告のみ（Issue 更新は成功）
          console.warn('Warning: Failed to update project status:', projectError);
        }
      }

      // ========== ここまで新規追加 ==========

    } catch (error) {
      console.error('Warning: Failed to update GitHub issue labels:', error);
    }
  }
);
```

### 7.6 Project Item ID の保存

`src/integrations/github/sync.ts` の `addSpecToProject()` メソッドを修正します。

**変更前:**

```typescript
// Projectにアイテム追加
const item = await this.projects.addItem({
  projectId: project.id,
  contentId: issueNodeId,
});

// 仕様書更新
await this.db
  .updateTable('specs')
  .set({ github_project_id: project.id })  // ← Project ID のみ保存
  .where('id', '=', params.specId)
  .execute();
```

**変更後:**

```typescript
// Projectにアイテム追加
const item = await this.projects.addItem({
  projectId: project.id,
  contentId: issueNodeId,
});

// 仕様書更新
await this.db
  .updateTable('specs')
  .set({
    github_project_id: project.id,
    github_project_item_id: item.id,  // ← Item ID も保存
  })
  .where('id', '=', params.specId)
  .execute();
```

### 7.7 エラーハンドリング

```typescript
// パターン1: Project に追加されていない仕様書
if (!spec.github_project_item_id) {
  // スキップ（エラーにしない）
  return;
}

// パターン2: Status フィールドが見つからない
try {
  const statusField = fields.find(f => f.name === 'Status');
  if (!statusField) {
    console.warn('Status field not found in project. Skipping status update.');
    return;
  }
} catch (error) {
  console.warn('Failed to fetch project fields:', error);
  return;
}

// パターン3: GitHub API レート制限
try {
  await projects.updateProjectStatus(...);
} catch (error) {
  if (error.message.includes('rate limit')) {
    console.warn('GitHub API rate limit exceeded. Status update will be retried later.');
    // TODO: リトライキューに追加
  } else {
    throw error;
  }
}
```

### 7.8 実装ファイル一覧

| ファイル | 変更内容 |
|---------|----------|
| `src/core/database/migrations/002_add_project_item_id.ts` | 新規作成（マイグレーション） |
| `src/core/database/schema.ts` | `specs` テーブルの型定義に `github_project_item_id` 追加 |
| `src/integrations/github/projects.ts` | `getProjectFields()`, `updateProjectStatus()` メソッド追加 |
| `src/integrations/github/phase-status-mapper.ts` | 新規作成（マッピングロジック） |
| `src/integrations/github/sync.ts` | `addSpecToProject()` で Item ID を保存 |
| `src/core/workflow/github-integration.ts` | `spec.phase_changed` ハンドラーに Project ステータス更新追加 |
| `tests/integrations/github/projects.test.ts` | 新規メソッドのテスト追加 |
| `tests/core/workflow/github-integration.test.ts` | Project ステータス更新のテスト追加 |

---

## 8. 実装タスク

### タスク 1: データベースマイグレーション作成

**目的:** `specs` テーブルに `github_project_item_id` カラムを追加

**ファイル:**

- `src/core/database/migrations/002_add_project_item_id.ts` (新規作成)
- `src/core/database/schema.ts` (型定義更新)

**作業内容:**

1. マイグレーションファイル作成
2. `up()` に `ALTER TABLE specs ADD COLUMN github_project_item_id TEXT;`
3. `down()` に `ALTER TABLE specs DROP COLUMN github_project_item_id;`
4. `Database` 型の `specs` テーブルに `github_project_item_id?: string | null` 追加

**見積もり:** 30 分

**依存関係:** なし

**受け入れ基準:**

- [ ] マイグレーションが正常に実行される
- [ ] 既存のデータに影響がない
- [ ] TypeScript の型チェックがパスする

---

### タスク 2: フェーズ → ステータスマッピングロジック実装

**目的:** フェーズから GitHub Project ステータスへの変換ロジック

**ファイル:**

- `src/integrations/github/phase-status-mapper.ts` (新規作成)
- `tests/integrations/github/phase-status-mapper.test.ts` (新規作成)

**作業内容:**

1. `Phase` 型と `ProjectStatus` 型を定義
2. `mapPhaseToStatus()` 関数を実装
3. ユニットテストを作成

**見積もり:** 30 分

**依存関係:** なし

**受け入れ基準:**

- [ ] すべてのフェーズが正しいステータスにマッピングされる
- [ ] テストカバレッジ 100%

---

### タスク 3: GitHub Projects API - フィールド取得機能

**目的:** Project のフィールド一覧とオプションを取得する GraphQL クエリ実装

**ファイル:**

- `src/integrations/github/projects.ts` (メソッド追加)
- `tests/integrations/github/projects.test.ts` (テスト追加)

**作業内容:**

1. `ProjectFieldResponse` 型を定義
2. `getProjectFields(owner, projectNumber)` メソッド実装
3. GraphQL クエリで SINGLE_SELECT フィールドとオプションを取得
4. ユニットテスト作成（モック使用）

**見積もり:** 1 時間

**依存関係:** なし

**受け入れ基準:**

- [ ] Status フィールドのオプション（"Todo", "In Progress", "Done"）を取得できる
- [ ] フィールドが存在しない場合は空配列を返す
- [ ] テストがパスする

---

### タスク 4: GitHub Projects API - updateItemField() 改善

**目的:** SINGLE_SELECT フィールドの更新に対応

**ファイル:**

- `src/integrations/github/projects.ts` (既存メソッド修正)
- `tests/integrations/github/projects.test.ts` (テスト追加)

**作業内容:**

1. `UpdateProjectItemFieldParams` に `fieldType` と `optionId` を追加
2. `updateItemField()` メソッドで SINGLE_SELECT フィールドに対応
3. GraphQL mutation の value を `{ singleSelectOptionId }` 形式に変更
4. テスト追加

**見積もり:** 45 分

**依存関係:** なし

**受け入れ基準:**

- [ ] TEXT フィールドと SINGLE_SELECT フィールドの両方に対応
- [ ] 既存の使用箇所が破壊されない
- [ ] テストがパスする

---

### タスク 5: GitHub Projects API - updateProjectStatus() 実装

**目的:** 高レベル API としてステータス更新をラップ

**ファイル:**

- `src/integrations/github/projects.ts` (メソッド追加)
- `tests/integrations/github/projects.test.ts` (テスト追加)

**作業内容:**

1. `updateProjectStatus()` メソッド実装
2. フィールド取得 → Status フィールド検索 → オプション ID 検索 → 更新の流れ
3. エラーハンドリング（フィールドが見つからない場合など）
4. ユニットテスト作成

**見積もり:** 1 時間

**依存関係:** タスク 3, タスク 4

**受け入れ基準:**

- [ ] ステータスを正しく更新できる
- [ ] Status フィールドが存在しない場合は適切なエラーを投げる
- [ ] テストがパスする

---

### タスク 6: Project Item ID の保存処理

**目的:** Issue を Project に追加したときに Item ID をデータベースに保存

**ファイル:**

- `src/integrations/github/sync.ts` (既存メソッド修正)
- `src/core/workflow/github-integration.ts` (既存イベントハンドラー修正)

**作業内容:**

1. `GitHubSyncService.addSpecToProject()` で `github_project_item_id` を保存
2. `spec.created` イベントハンドラーで Item ID を保存
3. 既存のテスト更新

**見積もり:** 45 分

**依存関係:** タスク 1

**受け入れ基準:**

- [ ] Project に追加したときに Item ID が DB に保存される
- [ ] 既存の動作が破壊されない
- [ ] テストがパスする

---

### タスク 7: spec.phase_changed イベントハンドラー拡張

**目的:** フェーズ変更時に Project ステータスを自動更新

**ファイル:**

- `src/core/workflow/github-integration.ts` (既存ハンドラー修正)
- `tests/core/workflow/github-integration.test.ts` (テスト追加)

**作業内容:**

1. `spec.phase_changed` イベントハンドラーに Project ステータス更新処理を追加
2. `github_project_item_id` が存在する場合のみ実行
3. エラーハンドリング（ベストエフォート）
4. ユニットテスト作成

**見積もり:** 1 時間 30 分

**依存関係:** タスク 2, タスク 5, タスク 6

**受け入れ基準:**

- [ ] フェーズ変更時に Project ステータスが更新される
- [ ] Project Item ID がない場合はスキップ（エラーにしない）
- [ ] Project 更新失敗時も仕様書のフェーズ変更は成功する
- [ ] テストがパスする

---

### タスク 8: E2E テスト作成

**目的:** 実際のワークフローをテスト

**ファイル:**

- `tests/e2e/project-status-update.test.ts` (新規作成)

**作業内容:**

1. 仕様書作成 → Project 追加 → フェーズ変更のフローをテスト
2. GitHub API をモック化
3. データベースは `:memory:` モード使用

**見積もり:** 1 時間

**依存関係:** タスク 7

**受け入れ基準:**

- [ ] エンドツーエンドのフローが正常に動作する
- [ ] テストがパスする

---

### タスク概要

| タスク | 見積もり | 依存関係 | 優先度 |
|--------|----------|----------|--------|
| 1. データベースマイグレーション | 30分 | なし | 高 |
| 2. フェーズ → ステータスマッピング | 30分 | なし | 高 |
| 3. フィールド取得機能 | 1時間 | なし | 高 |
| 4. updateItemField() 改善 | 45分 | なし | 高 |
| 5. updateProjectStatus() 実装 | 1時間 | タスク 3, 4 | 高 |
| 6. Project Item ID の保存 | 45分 | タスク 1 | 高 |
| 7. イベントハンドラー拡張 | 1時間30分 | タスク 2, 5, 6 | 高 |
| 8. E2E テスト | 1時間 | タスク 7 | 中 |

**合計見積もり:** 約 7 時間

**推奨実装順序:**

1. タスク 1, 2, 3, 4（並列可）
2. タスク 5
3. タスク 6
4. タスク 7
5. タスク 8
