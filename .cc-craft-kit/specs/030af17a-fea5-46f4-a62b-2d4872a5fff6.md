# 各フェーズの実行に際し、既存のサブエージェントとスキルでは不足する場合は、適切なサブエージェントとスキルを自動作成し、適用する仕組みを実現

**仕様書 ID:** 030af17a-fea5-46f4-a62b-2d4872a5fff6
**フェーズ:** requirements
**作成日時:** 2025/11/19 11:08:21
**更新日時:** 2025/11/19 11:08:21

---

## 1. 背景と目的

### 背景

cc-craft-kit は仕様駆動開発をサポートするため、各フェーズ（requirements, design, tasks, implementation, completed）で品質チェックを実施しています。現在、以下のサブエージェントとスキルを利用可能です。

**利用可能なサブエージェント:**
- `code-reviewer`: コード品質、セキュリティ、ベストプラクティスの検証
- `test-generator`: 単体テストの自動生成
- `refactoring-assistant`: コード構造改善、パフォーマンス最適化

**利用可能なスキル:**
- `typescript-eslint`: TypeScript コンパイルエラー・ESLint 警告の検出
- `database-schema-validator`: Kysely スキーマとマイグレーションの検証
- `git-operations`: Git リポジトリ管理、コミット履歴解析

しかし、特定のプロジェクトやドメインに応じて、これらのサブエージェント・スキルでは不足する場合があります。例えば、セキュリティ監査、API ドキュメント生成、パフォーマンステスト、UI/UX レビューなど、プロジェクト固有の品質チェックが必要になることがあります。

### 目的

各フェーズの実行時、既存のサブエージェント・スキルでは品質保証が不十分な場合に、プロジェクトの要件に応じた新しいサブエージェント・スキルを自動生成し、適用する仕組みを実現します。これにより、プロジェクトごとのカスタマイズされた品質保証プロセスを構築できます。

---

## 2. 対象ユーザー

この機能は以下のユーザーを対象とします。

- **cc-craft-kit 利用者**: 既存のサブエージェント・スキルでは不足する品質チェックを自動化したい開発者
- **プロジェクトオーナー**: プロジェクト固有の品質基準を自動的に適用したい管理者
- **Claude Code ユーザー**: プロジェクトに応じた柔軟な品質保証プロセスを構築したいユーザー

---

## 3. 受け入れ基準

### 必須要件

- [ ] プロジェクト固有の品質チェック要件を `.cc-craft-kit/quality-requirements.yaml` に定義できること
- [ ] 各フェーズ実行時、既存のサブエージェント・スキルと品質要件を比較し、不足を検出できること
- [ ] 不足している品質チェックを実現するサブエージェント・スキルを自動生成できること
- [ ] 生成されたサブエージェント・スキルを `.claude/agents/` または `.claude/skills/` へ配置できること
- [ ] 生成されたサブエージェント・スキルを即座に実行できること

### 機能要件

#### フェーズ1: 基本機能（MVP）

- [ ] 品質要件定義ファイル（`.cc-craft-kit/quality-requirements.yaml`）のスキーマを設計すること
- [ ] `/cft:quality-init` コマンドで品質要件定義ファイルのテンプレートを生成できること
- [ ] 品質要件定義ファイルを手動で編集できること
- [ ] `/cft:quality-generate <type> <name>` コマンドで手動サブエージェント・スキル生成を実行できること
- [ ] テンプレートベースのサブエージェント・スキル生成エンジンを実装すること

#### フェーズ2: 自動化機能

- [ ] 品質要件とサブエージェント・スキルのマッピングロジックを実装すること
- [ ] フェーズ移行時の品質チェック不足検出ロジックを実装すること
- [ ] `/cft:quality-check <spec-id>` コマンドで手動品質チェック不足検出を実行できること
- [ ] イベントバス（`src/core/workflow/event-bus.ts`）への統合を実装すること

#### フェーズ3: 高度な自動化（将来対応）

- [ ] 不足している品質チェックを実現するサブエージェント・スキルを自動生成できること
- [ ] 生成されたサブエージェント・スキルを即座に実行できること
- [ ] サブエージェント・スキル生成履歴を専用テーブルまたは `logs.metadata` へ記録すること

#### サブエージェント自動生成方式

**方式1: テンプレートベース生成（フェーズ1で実装）**

- [ ] `.cc-craft-kit/quality-templates/subagents/` にサブエージェントテンプレートを配置
- [ ] `.cc-craft-kit/quality-templates/skills/` にスキルテンプレートを配置
- [ ] 品質要件 YAML の `template` フィールドに応じてテンプレートを選択
- [ ] Handlebars で変数を置換し、`.claude/agents/<name>.md` または `.claude/skills/<name>/SKILL.md` へ出力

**方式2: LLMベース生成（フェーズ3で検討）**

- [ ] 品質要件の自然言語記述を Claude Code の Task ツールへ渡す
- [ ] 「次の品質要件を満たすサブエージェントを生成してください」と指示
- [ ] 生成結果を `.claude/agents/<name>.md` へ保存

#### 品質要件スキーマの具体例

```yaml
# .cc-craft-kit/quality-requirements.yaml
version: "1.0"

quality_requirements:
  # セキュリティ監査
  - name: "security-audit"
    type: "subagent"
    trigger_phase: "implementation"
    description: "OWASP Top 10 に基づくセキュリティ脆弱性チェック"
    template: "security-auditor"
    tools: ["Read", "Grep", "Bash"]
    parameters:
      owasp_version: "2021"
      severity_threshold: "high"

  # API ドキュメント生成
  - name: "api-documentation-generator"
    type: "skill"
    trigger_phase: "completed"
    description: "OpenAPI 仕様書から API ドキュメントを自動生成"
    template: "api-doc-generator"
    tools: ["Read", "Write"]
    parameters:
      spec_format: "OpenAPI 3.0"
      output_format: "Markdown"
```

### 非機能要件

- [ ] サブエージェント・スキル生成時間:
  - テンプレートベース方式: 1 秒以内
  - LLM ベース方式: 30 秒以内（Claude API のレスポンス時間を考慮）
- [ ] タイムアウト時はエラーログを記録し、フェーズ移行を継続すること（品質チェックは失敗として記録）
- [ ] 生成されたサブエージェントは、既存の `.claude/agents/*.md` と同じフロントマター構造を持つこと
- [ ] 生成されたスキルは、既存の `.claude/skills/**/SKILL.md` と同じフロントマター構造を持つこと
- [ ] 生成後、YAML パーサーでフロントマターを検証し、必須フィールドの欠落をチェックすること
- [ ] 生成結果のサンプルを単体テストで検証すること
- [ ] 品質要件定義ファイルは YAML Schema でバリデーション可能であること
- [ ] 生成履歴は監査可能な形式で記録されること

---

## 4. 制約条件

- Claude Code のサブエージェント・スキル仕様に厳密に準拠する必要があります
- 品質要件定義ファイルは Git 管理対象とし、プロジェクト全体で共有可能である必要があります
- 既存のサブエージェント・スキルとの命名衝突を回避する必要があります

### 技術検証が必要な事項

実装前に以下の技術検証（PoC）を実施する必要があります。

- [ ] Claude Code でサブエージェント・スキルを動的に生成・登録する方法を調査
- [ ] 生成後の即座実行が可能かを検証（`.claude/agents/`, `.claude/skills/` への配置で認識されるか）
- [ ] Claude Code の内部 API またはファイルシステムベースの登録メカニズムを確認

### 代替アプローチ（動的生成が実現不可能な場合）

- 品質要件定義ファイルに基づき、既存テンプレートからサブエージェント・スキルファイルを生成
- 生成後、ユーザーに手動で Claude Code を再起動させる方式
- または、品質チェックスクリプト（Bash スクリプト）を生成し、`/cft:quality-check` で実行する方式

### 命名衝突回避策

1. **プレフィックス付与**: 自動生成されたサブエージェントには `custom-` プレフィックスを付与（例: `custom-security-audit`）
2. **生成前チェック**: `.claude/agents/` および `.claude/skills/` ディレクトリをスキャンし、同名ファイル存在時は連番を付与
3. **品質要件定義ファイルでの検証**: `/cft:quality-init` 実行時、既存のサブエージェント・スキル名をチェックし、衝突があれば警告表示

---

## 5. 依存関係

### 内部依存

- `src/core/workflow/event-bus.ts`: `spec.phase_changed` イベントをリッスン
- `src/core/workflow/phase-automation-registration.ts`: 品質チェック不足検出ハンドラーを登録
- `src/core/workflow/quality-automation.ts`（新規）: 品質要件とサブエージェント・スキルのマッピング処理
- `src/core/database/schema.ts`: 品質チェック履歴の記録（`logs` テーブルまたは専用テーブル）
- `src/core/templates/engine.ts`: サブエージェント・スキルテンプレートレンダリング（拡張が必要）

#### イベントフロー

1. ユーザーが `/cft:spec-phase <spec-id> tasks` を実行
2. `spec.phase_changed` イベントが発火
3. `quality-automation.ts` のハンドラーが品質要件をチェック
4. 不足があれば、サブエージェント・スキルを自動生成
5. 生成されたサブエージェント・スキルを即座に実行（Task ツールまたは Skill ツールで）
6. 結果を `logs` テーブルまたは専用テーブルへ記録

#### テンプレートエンジンの拡張

`src/core/templates/engine.ts` に以下のメソッドを追加する必要があります。

- `renderSubagent(templateName: string, vars: SubagentTemplateVars): Promise<string>`
- `renderSkill(templateName: string, vars: SkillTemplateVars): Promise<string>`

```typescript
export interface SubagentTemplateVars {
  name: string;
  description: string;
  tools: string[]; // ["Read", "Grep", "Bash"]
  model: string; // "sonnet" | "opus"
  responsibilities: string[];
  outputFormat: string;
  examples?: string[];
  parameters?: Record<string, unknown>;
}

export interface SkillTemplateVars {
  name: string;
  description: string;
  capabilities: string[];
  usageExamples: string[];
  commonIssues?: Array<{ issue: string; solution: string }>;
  configFiles?: string[];
  parameters?: Record<string, unknown>;
}
```

#### データベーススキーマ拡張（オプション）

専用テーブルを作成する場合、新規マイグレーション `004_add_quality_checks_table.ts` を追加します。

```typescript
export interface QualityChecksTable {
  id: Generated<string>;
  spec_id: string; // FK to specs.id
  requirement_name: string; // 品質要件名（例: "api-documentation-generator"）
  agent_or_skill_name: string; // 生成されたサブエージェント・スキル名
  type: 'subagent' | 'skill';
  generated_at: ColumnType<Date, string | undefined, never>;
  executed_at: ColumnType<Date, string | undefined, string> | null;
  status: 'generated' | 'executed' | 'failed';
  error_message: string | null;
  result_metadata: string | null; // JSON string
}
```

または、`logs.metadata` に以下の構造を JSON として記録します。

```json
{
  "quality_check": {
    "requirement_name": "api-documentation-generator",
    "agent_or_skill_name": "api-doc-generator",
    "type": "subagent",
    "status": "executed"
  }
}
```

### 外部依存

- Claude Code Guide: サブエージェント・スキル仕様の参照
- YAML Schema: 品質要件定義ファイルのバリデーション
- 既存のサブエージェント（`.claude/agents/`）
- 既存のスキル（`.claude/skills/`）

### 関連仕様

- なし（新規仕様）

---

## 6. 参考情報

- [Claude Code Guide - サブエージェント仕様](https://docs.claude.ai/code/agents)
- [Claude Code Guide - スキル仕様](https://docs.claude.ai/code/skills)
- [YAML Schema Specification](https://json-schema.org/understanding-json-schema/)
- `.claude/agents/code-reviewer.md` - 既存サブエージェントの参考実装
- `.claude/skills/typescript-eslint/SKILL.md` - 既存スキルの参考実装
