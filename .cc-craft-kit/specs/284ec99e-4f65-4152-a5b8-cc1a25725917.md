---
id: "284ec99e-4f65-4152-a5b8-cc1a25725917"
name: "GitHub Actions が失敗している(再掲)"
phase: "completed"
branch_name: "main"
github_issue_number: null
pr_url: null
created_at: "2025-11-18T23:06:01Z"
updated_at: "2025-11-18T23:52:55Z"
---

# GitHub Actions が失敗している(再掲)


## 1. 背景と目的

### 背景

cc-craft-kit プロジェクトは TypeScript を直接実行する設計（`npx tsx`）を採用しており、**ビルドステップを必要としない**アーキテクチャになっています。しかし、GitHub Actions の CI ワークフローファイル（`.github/workflows/ci.yml` および `.github/workflows/release.yml`）には、存在しない `npm run build` コマンドが記述されており、以下の問題が発生しています。

- **Check Source Sync ジョブ**（L117）: `npm run build` が失敗し、後続の `npm run check:sync` が実行されない
- **Build ジョブ**（L149）: 前提ジョブの失敗により実行されない
- **Release ワークフロー**（`.github/workflows/release.yml` L26）: リリース時に `npm run build` が失敗する
- **Test ジョブ**: タイムアウトまたはキャンセルされている（原因調査が必要）

このため、プルリクエストのマージや新規リリースがブロックされ、開発ワークフローが停止しています。

### 目的

1. GitHub Actions の CI/CD ワークフローを cc-craft-kit のビルドレス設計に適合させる
2. 存在しない `npm run build` コマンドを削除し、正しい検証フローを確立する
3. Test ジョブの失敗原因を特定し、安定した CI 実行を実現する
4. 継続的インテグレーションを復旧し、開発フローを正常化する
---

## 2. 対象ユーザー

- **cc-craft-kit プロジェクト開発者**: プルリクエストをマージできるようにする
- **cc-craft-kit メンテナー**: リリースプロセスを正常化する
- **コントリビューター**: CI 失敗により作業がブロックされている開発者
- **新規ユーザー**: GitHub Actions のステータスバッジが緑色になり、プロジェクトの品質が保証される
---

## 3. 受け入れ基準

### 必須要件

- [ ] `.github/workflows/ci.yml` から存在しない `npm run build` コマンドを削除する
- [ ] `.github/workflows/release.yml` から存在しない `npm run build` コマンドを削除する
- [ ] `check-sync` ジョブが正常に実行され、`src/` と `.cc-craft-kit/` の同期状態を検証する
- [ ] すべての CI ジョブ（lint, typecheck, docs, test, check-sync）が成功する
- [ ] main ブランチへの push 時に CI が正常に完了する

### 機能要件

- [ ] Test ジョブのタイムアウト/キャンセル原因を特定し、修正する
- [ ] Test ジョブが Node.js 18 と 20 の両方で正常に実行される
- [ ] Coverage レポートが Codecov へ正常にアップロードされる
- [ ] Security Audit ジョブが正常に完了する（Snyk トークン未設定の警告は許容）
- [ ] Release ワークフローが正常に実行され、GitHub Release とアーカイブが作成される

### 非機能要件

- [ ] CI 実行時間が 5 分以内に収まる（現状: 27 分以上のタイムアウト）
- [ ] ワークフローファイルが cc-craft-kit のアーキテクチャ設計（ビルドレス）と整合している
- [ ] エラーメッセージが分かりやすく、問題の原因が即座に特定できる
- [ ] CI 失敗時の通知が適切に行われる
---

## 4. 制約条件

- cc-craft-kit は TypeScript を直接実行するため、`npm run build` スクリプトは存在しない（`dist/` ディレクトリも生成されない）
- `package.json` の `scripts` セクションに `build` コマンドを追加してはならない（アーキテクチャ設計に反する）
- 既存のテストスイート（Jest）、Lint（ESLint）、型チェック（TypeScript）を維持する
- Node.js 18 以上をサポートする
- Codecov、Snyk などの外部サービスとの統合を維持する
---

## 5. 依存関係

- **前提条件**: なし（独立した修正）
- **影響を受ける仕様**: なし
- **関連するコンポーネント**:
  - GitHub Actions ワークフローファイル (`.github/workflows/ci.yml`, `.github/workflows/release.yml`)
  - `package.json` の scripts セクション
  - ソースコード同期スクリプト (`src/scripts/check-sync.ts`, `src/scripts/sync-dogfood.ts`)
  - Jest テスト設定 (`jest.config.js` または `package.json` の jest セクション)
---

## 6. 参考情報

- GitHub Actions ログ: `gh run view 19468137121`
- 失敗したジョブ詳細:
  - Check Source Sync: `gh run view --log-failed --job=55708015683`
  - Test (Node.js 20): `gh run view --log-failed --job=55708015636`
  - Test (Node.js 18): `gh run view --log-failed --job=55708015706`
- プロジェクトアーキテクチャ: `CLAUDE.md` - "cc-craft-kit は TypeScript を直接実行するため、ビルド不要です"
- CI ワークフローファイル: `/home/autum/Projects/personal/cc-craft-kit/.github/workflows/ci.yml`
- Release ワークフローファイル: `/home/autum/Projects/personal/cc-craft-kit/.github/workflows/release.yml`
- 利用可能な npm スクリプト一覧: `npm run` コマンドの出力結果
---

## 7. 追加の調査が必要な項目

1. **Test ジョブのタイムアウト原因**: Jest の設定、無限ループ、非同期処理の待機漏れなどを調査する必要があります
2. **Check Source Sync の実装**: `npm run check:sync` がビルド生成物（`dist/`）を前提としているか確認が必要です
3. **Release ワークフローの Archive 作成**: ビルド生成物がない場合、`.cc-craft-kit.tar.gz` に何を含めるべきか明確化が必要です
---

## 8. 設計

### 8.1 問題の根本原因

#### 1. 存在しない `npm run build` コマンド

**現状:**
- `.github/workflows/ci.yml` L117: `check-sync` ジョブで `npm run build` を実行
- `.github/workflows/ci.yml` L149: `build` ジョブで `npm run build` を実行
- `.github/workflows/release.yml` L26: リリース時に `npm run build` を実行

**原因:**
- `package.json` の `scripts` セクションに `build` コマンドが存在しない
- cc-craft-kit はビルドレス設計（`npx tsx` で直接実行）のため、`build` コマンドは不要

**影響:**
- `check-sync` ジョブが失敗し、`npm run check:sync` が実行されない
- `build` ジョブが前提ジョブの失敗により実行されない
- Release ワークフローが失敗し、リリースがブロックされる

#### 2. Test ジョブのタイムアウト

**原因（調査結果）:**
- `package.json` L28: `"pretest": "npm run lint:all"` が設定されている
- `npm test` 実行時に `npm run lint:all` が自動的に実行される
- `lint:all` は ESLint、markdownlint、textlint をすべて実行するため、処理時間が長い
- CI では lint、typecheck、docs ジョブで既にリント処理が実行されているため、重複している

**影響:**
- Test ジョブが 27 分以上かかり、タイムアウトまたはキャンセルされる
- CI 全体の実行時間が大幅に延長される

#### 3. Build ジョブの不要性

**現状:**
- `.github/workflows/ci.yml` L130-156: `build` ジョブが定義されている
- `build` ジョブは `npm run build` を実行し、`dist/` ディレクトリをアーティファクトとしてアップロード

**原因:**
- cc-craft-kit はビルドレス設計のため、`dist/` ディレクトリは生成されない
- ビルドステップは不要

**影響:**
- Build ジョブが失敗し続ける
- 不要なジョブが CI に含まれている

### 8.2 解決策の設計

#### 修正 1: ci.yml から `npm run build` を削除

**対象ファイル:** `.github/workflows/ci.yml`

**変更内容:**

1. **check-sync ジョブ（L117-118）:**
   - 削除: `npm run build`
   - 理由: `npm run check:sync` は TypeScript ファイルを直接比較するため、ビルド不要

2. **build ジョブ（L130-156）:**
   - ジョブ全体を削除
   - 理由: ビルドステップは不要（ビルドレス設計）

**修正後の check-sync ジョブ:**

```yaml
check-sync:
  runs-on: ubuntu-latest
  name: Check Source Sync

  steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check source synchronization
      run: npm run check:sync

    - name: Report sync status
      if: failure()
      run: |
        echo "❌ Source files are out of sync!"
        echo "Please run 'npm run sync:dogfood' to synchronize."
        exit 1
```

#### 修正 2: release.yml から `npm run build` を削除

**対象ファイル:** `.github/workflows/release.yml`

**変更内容:**

1. **L25-26 を削除:**
   - 削除: `npm run build`
   - 理由: ビルドステップは不要

**修正後の release ジョブ:**

```yaml
- name: Install dependencies
  run: npm ci

- name: Sync to dogfood environment
  run: npm run sync:dogfood

- name: Create archive
  run: |
    cd .cc-craft-kit
    tar -czf ../.cc-craft-kit.tar.gz .
    cd ..
```

#### 修正 3: pretest スクリプトを削除

**対象ファイル:** `package.json`

**変更内容:**

1. **L28 を削除:**
   - 削除: `"pretest": "npm run lint:all",`
   - 理由: CI で lint、typecheck、docs ジョブが既に実行されているため、重複を避ける

**修正後の scripts セクション:**

```json
{
  "scripts": {
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    ...
  }
}
```

#### 修正 4: Jest のタイムアウト設定を追加（オプション）

**対象ファイル:** `jest.config.js`

**変更内容:**

1. **タイムアウト設定を追加（安全策）:**

```javascript
export default {
  preset: 'ts-jest/presets/default-esm',
  testEnvironment: 'node',
  testTimeout: 10000, // 10秒（デフォルトは5秒）
  ...
};
```

### 8.3 CI ワークフローの最終構成

**修正後のジョブ構成:**

```text
┌─────────────────────────────────────┐
│           CI Workflow (ci.yml)      │
├─────────────────────────────────────┤
│  1. lint                            │
│  2. typecheck                       │
│  3. docs                            │
│  4. test (Node.js 18, 20)           │
│  5. check-sync                      │
│  6. security                        │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│      Release Workflow (release.yml) │
├─────────────────────────────────────┤
│  1. Install dependencies            │
│  2. Sync to dogfood environment     │
│  3. Create archive (.tar.gz)        │
│  4. Generate changelog              │
│  5. Create GitHub Release           │
│  6. Deploy install.sh to Pages      │
└─────────────────────────────────────┘
```

**削除されるジョブ:**
- `build` ジョブ（不要）

**修正されるジョブ:**
- `check-sync`: `npm run build` を削除
- `test`: `pretest` フックを削除し、テストのみ実行

### 8.4 期待される結果

#### CI 実行時間の短縮

**現状:**
- Test ジョブ: 27 分以上（タイムアウト）
- CI 全体: 30 分以上

**修正後（予想）:**
- Test ジョブ: 2-3 分
- CI 全体: 5 分以内

#### 成功するジョブ

**現状:**
- ✅ lint
- ✅ typecheck
- ✅ docs
- ❌ test (タイムアウト)
- ❌ check-sync (`npm run build` 失敗)
- ❌ build (前提ジョブ失敗)
- ✅ security

**修正後（予想）:**
- ✅ lint
- ✅ typecheck
- ✅ docs
- ✅ test (Node.js 18, 20)
- ✅ check-sync
- ✅ security

### 8.5 検証計画

#### 1. ローカル環境での検証

```bash
# 1. 修正前の状態確認
npm test  # タイムアウトするか確認

# 2. package.json を修正（pretest 削除）

# 3. 修正後のテスト実行
npm test  # 正常に完了するか確認

# 4. 同期チェック
npm run check:sync  # ビルドなしで正常に動作するか確認
```

#### 2. CI 環境での検証

```bash
# 1. Pull Request を作成
git checkout -b fix/github-actions-failure
git add .github/workflows/ci.yml .github/workflows/release.yml package.json
git commit -m "fix: GitHub Actions のビルドレス設計への適合"
git push origin fix/github-actions-failure

# 2. CI の実行結果を確認
gh pr view --web

# 3. すべてのジョブが成功することを確認
```

#### 3. リリースフローの検証

```bash
# 1. タグを作成してリリースをテスト
git tag v0.1.1
git push origin v0.1.1

# 2. Release ワークフローの実行結果を確認
gh run list --workflow=release.yml

# 3. GitHub Release が作成され、.tar.gz がアップロードされることを確認
```

### 8.6 リスク評価

| リスク | 発生確率 | 影響度 | 対策 |
|---|---|---|---|
| pretest 削除により、開発者がローカルでテスト前にリントを実行しない | 中 | 低 | lint-staged（pre-commit フック）が既に設定されているため、コミット時に自動実行される |
| check-sync がビルド生成物を前提としている可能性 | 低 | 中 | `src/scripts/check-sync.ts` を確認し、ビルド生成物を前提としていないことを確認 |
| Jest のタイムアウトが他の要因で発生している可能性 | 低 | 中 | ローカル環境でテスト実行時間を計測し、問題がないことを確認 |
| Release ワークフローで .tar.gz に含めるべき内容が不明確 | 低 | 低 | 現状の `.cc-craft-kit/` ディレクトリ全体をアーカイブする設計で問題なし |

### 8.7 代替案の検討

#### 代替案 1: `build` コマンドを追加して `dist/` を生成する

**内容:**
- `package.json` に `"build": "tsc"` を追加
- TypeScript をコンパイルして `dist/` を生成

**却下理由:**
- cc-craft-kit のアーキテクチャ設計に反する
- ビルドレス設計の利点（高速な開発サイクル、TypeScript 直接実行）を失う
- `CLAUDE.md` に明記されている設計方針に違反

#### 代替案 2: `pretest` を維持し、CI で `npm test -- --skip-pretest` を実行

**内容:**
- `pretest` をそのまま維持
- CI の test ジョブで `npm test -- --skip-pretest` を実行してリントをスキップ

**却下理由:**
- `--skip-pretest` オプションは npm に存在しない
- 複雑な回避策であり、保守性が低い
- `pretest` 自体が不要（lint-staged で十分）

### 8.8 データモデル

**変更なし** - データベーススキーマへの影響はありません。

### 8.9 API 設計

**変更なし** - 外部 API への影響はありません。

### 8.10 セキュリティ考慮事項

**変更なし** - セキュリティへの影響はありません。

- GitHub Actions の Secrets は既に適切に管理されている
- `npm run build` の削除により、セキュリティリスクは発生しない
---

## 9. 実装タスクリスト

### タスク 1: ci.yml の check-sync ジョブから npm run build を削除

**対象ファイル:** `.github/workflows/ci.yml`

**変更内容:**
- L117-118 の `- name: Build TypeScript` と `run: npm run build` を削除

**受け入れ基準:**
- [ ] `npm run build` ステップが削除されている
- [ ] `check-sync` ジョブが `npm run check:sync` を直接実行する
- [ ] ローカル環境で `npm run check:sync` が正常に動作する
---

### タスク 2: ci.yml の build ジョブ全体を削除

**対象ファイル:** `.github/workflows/ci.yml`

**変更内容:**
- L130-156 の `build` ジョブ全体を削除

**受け入れ基準:**
- [ ] `build` ジョブが完全に削除されている
- [ ] 他のジョブの `needs` セクションから `build` が削除されている（該当なし）
- [ ] CI ワークフローが正常に実行される
---

### タスク 3: release.yml から npm run build を削除

**対象ファイル:** `.github/workflows/release.yml`

**変更内容:**
- L25-26 の `- name: Build project` と `run: npm run build` を削除

**受け入れ基準:**
- [ ] `npm run build` ステップが削除されている
- [ ] `npm run sync:dogfood` が正常に実行される
- [ ] `.cc-craft-kit.tar.gz` が正常に作成される
---

### タスク 4: package.json から pretest スクリプトを削除

**対象ファイル:** `package.json`

**変更内容:**
- L28 の `"pretest": "npm run lint:all",` を削除

**受け入れ基準:**
- [ ] `pretest` スクリプトが削除されている
- [ ] `npm test` を実行してもリントが実行されない
- [ ] テストが正常に完了する
---

### タスク 5: jest.config.js にタイムアウト設定を追加（オプション）

**対象ファイル:** `jest.config.js`

**変更内容:**
- `testTimeout: 10000` を追加（10 秒）

**受け入れ基準:**
- [ ] `testTimeout` 設定が追加されている
- [ ] テストが正常に完了する
- [ ] タイムアウトエラーが発生しない
---

### タスク 6: ローカル環境で npm test を実行して正常動作を確認

**検証内容:**
- 修正後の `npm test` を実行
- テストが 5 分以内に完了することを確認
- すべてのテストが成功することを確認

**受け入れ基準:**
- [ ] `npm test` が正常に完了する
- [ ] 実行時間が 5 分以内
- [ ] Coverage レポートが生成される
---

### タスク 7: ローカル環境で npm run check:sync を実行して正常動作を確認

**検証内容:**
- 修正後の `npm run check:sync` を実行
- `src/` と `.cc-craft-kit/` の同期状態が正常に検証されることを確認

**受け入れ基準:**
- [ ] `npm run check:sync` が正常に完了する
- [ ] ビルドステップなしで動作する
- [ ] 同期エラーが適切に検出される
---

### タスク 8: 変更をコミットして PR を作成

**作業内容:**
- 修正したファイルをステージング
- コミットメッセージ: `fix: GitHub Actions のビルドレス設計への適合`
- ブランチ名: `fix/github-actions-failure`
- PR を作成

**受け入れ基準:**
- [ ] すべての変更がコミットされている
- [ ] PR が作成されている
- [ ] PR の説明に変更内容が記載されている
---

### タスク 9: CI の実行結果を確認し、すべてのジョブが成功することを検証

**検証内容:**
- PR の CI 実行結果を確認
- すべてのジョブ（lint, typecheck, docs, test, check-sync, security）が成功することを確認

**受け入れ基準:**
- [ ] lint ジョブが成功
- [ ] typecheck ジョブが成功
- [ ] docs ジョブが成功
- [ ] test ジョブ（Node.js 18, 20）が成功
- [ ] check-sync ジョブが成功
- [ ] security ジョブが成功
- [ ] CI 実行時間が 5 分以内
---

## 10. 完了条件

すべてのタスクが完了し、以下の条件を満たした場合、本仕様は完了とします。

- [ ] すべての CI ジョブが成功する
- [ ] CI 実行時間が 5 分以内
- [ ] main ブランチへの push 時に CI が正常に完了する
- [ ] Release ワークフローが正常に実行される（タグ作成時）
- [ ] GitHub Actions のステータスバッジが緑色になる
