---
id: "30f4b007-481c-4eb0-aaae-feb96c82e0ac"
name: "Sub Issue が放置されている"
phase: "completed"
branch_name: "main"
github_issue_number: null
pr_url: null
created_at: "2025-11-27T11:05:07.875Z"
updated_at: "2025-11-28T00:15:00Z"
---

# Sub Issue が放置されている


## 1. 背景と目的

### 背景

Sub Issue が作られるのは良いが、中身は空っぽで更新されず、ステータスも変わらず、クローズもされないままとなっている。また、GitHub Projects 上でも Todo ステータスのままとなっている。

### 目的

Sub Issue のライフサイクルを適切に管理し、タスク完了時に以下の処理が自動実行されるようにする:

1. Sub Issue 本文にタスク説明を含める
2. タスク完了時に Sub Issue を自動クローズする
3. GitHub Projects 上で Sub Issue のステータスを同期する
---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発（SDD）を行う開発者。
特に、GitHub Projects でタスク進捗を管理している開発者。
---

## 3. 受け入れ基準

### 必須要件

- [x] `/cft:task-done` 実行時に `task.completed` イベントが発火され、Sub Issue が自動クローズされる
- [x] Sub Issue 作成時に、タスク説明が本文に含まれる

### 機能要件

- [x] `/cft:task-done` でタスク完了時、対応する Sub Issue がクローズされる
- [x] `/cft:task-done` でタスク完了時、GitHub Projects 上の Sub Issue ステータスが "Done" に更新される
- [x] Sub Issue 作成時、仕様書の「実装タスクリスト」からタスク説明を抽出して本文に設定する
- [x] Sub Issue 作成時、GitHub Projects に自動追加する

### 非機能要件

- [x] イベント駆動アーキテクチャを維持し、疎結合な実装とする
- [x] 既存の `task.completed` イベントハンドラーを活用する
---

## 4. 制約条件

- プロンプトファースト原則: プロンプト（.md）で実現可能な処理はプロンプトで実装する
- DB 操作、GitHub API、イベント発火はスクリプト（.ts）で実装する
- 既存のイベント駆動アーキテクチャ（EventBus）を活用する
- GitHub GraphQL/REST API のレート制限を考慮する
---

## 5. 依存関係

### 関連モジュール

- `src/core/workflow/event-bus.ts` - イベント定義（`task.completed` イベント）
- `src/core/workflow/github-integration.ts` - GitHub統合ハンドラー（`task.completed` ハンドラー実装済み）
- `src/integrations/github/sub-issues.ts` - SubIssueManager（Sub Issue 作成・更新）
- `src/integrations/github/projects.ts` - GitHub Projects 管理
- `src/commands/github/create-sub-issues.ts` - Sub Issue 一括作成コマンド
- `src/core/utils/task-parser.ts` - タスクリスト解析
- `src/slash-commands/task-done.md` - タスク完了プロンプト

### データベース

- `github_sync` テーブル: Sub Issue 情報を `entity_type: 'sub_issue'` で管理
- `github_node_id` カラム: GraphQL Node ID を保存（Projects 連携に使用）
---

## 6. 参考情報

### 問題の根本原因

1. **`task.completed` イベントが発火されない**: `/cft:task-done` は Bash/gh CLI ベースのプロンプトで、イベント発火メカニズムがない
2. **Sub Issue 本文が空**: `createSubIssue()` で description が省略されている
3. **Sub Issue が Projects に未追加**: 親 Issue のみ Projects に追加され、Sub Issue は追加されていない

### 解析結果

- `task.completed` ハンドラーは `github-integration.ts:920-970` に実装済み
- イベントが発火されれば `SubIssueManager.updateSubIssueStatus()` が呼ばれる
- GitHub Projects への Sub Issue 追加機能は未実装
---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```text
┌─────────────────────────────────────────────────────────────────────────┐
│                              User Layer                                  │
│  /cft:task-done <issue-number>                                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          Command Layer                                   │
│  src/commands/task/done.ts (新規作成)                                   │
│  - Issue クローズ処理                                                    │
│  - task.completed イベント発火                                           │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           Event Layer                                    │
│  src/core/workflow/event-bus.ts                                          │
│  - task.completed イベント配信                                           │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         Handler Layer                                    │
│  src/core/workflow/github-integration.ts                                 │
│  - task.completed ハンドラー                                             │
│    - Sub Issue ステータス更新 (closed)                                   │
│    - Sub Issue の Projects ステータス更新 (Done)                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    ▼                               ▼
┌─────────────────────────────────┐  ┌─────────────────────────────────┐
│   Integration Layer (GitHub)    │  │   Integration Layer (Projects)  │
│   src/integrations/github/      │  │   src/integrations/github/      │
│   sub-issues.ts                 │  │   projects.ts                   │
│   - updateSubIssueStatus()      │  │   - updateProjectStatus()       │
└─────────────────────────────────┘  └─────────────────────────────────┘
                    │                               │
                    ▼                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          Data Layer                                      │
│  github_sync テーブル                                                    │
│  - entity_type: 'sub_issue'                                              │
│  - github_node_id: GraphQL Node ID                                       │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 設計方針

1. **イベント駆動アーキテクチャの維持**: 既存の `task.completed` ハンドラーを活用し、疎結合を維持
2. **プロンプトファースト原則の適用**: `/cft:task-done` プロンプトは維持し、TypeScript コマンドを呼び出す形式に変更
3. **既存 API の拡張**: `SubIssueManager` と `GitHubProjects` の既存メソッドを拡張

#### 処理フロー詳細

```text
/cft:task-done <issue-number> 実行
        │
        ▼
┌───────────────────────────────────────────────┐
│ Step 1: Sub Issue 情報取得                    │
│ - github_sync テーブルから Sub Issue 検索     │
│ - spec_id, task_id を特定                     │
└───────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────┐
│ Step 2: GitHub API で Issue クローズ          │
│ - gh issue close <issue-number>               │
└───────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────┐
│ Step 3: task.completed イベント発火           │
│ - eventBus.emit('task.completed', {...})      │
└───────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────┐
│ Step 4: ハンドラー実行（自動）                │
│ - Sub Issue ステータス更新                    │
│ - Projects ステータス更新 (Done)              │
└───────────────────────────────────────────────┘
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/slash-commands/task-done.md` | TypeScript コマンド呼び出しを追加（イベント発火用） |
| `src/commands/task/done.ts` | **新規作成**: タスク完了コマンド（イベント発火機能） |
| `src/integrations/github/sub-issues.ts` | `createSubIssue()` で description をサポート |
| `src/commands/github/create-sub-issues.ts` | タスク description を Sub Issue 本文に設定 |
| `src/core/workflow/github-integration.ts` | `task.completed` ハンドラーで Projects ステータス更新 |
| `tests/commands/task/done.test.ts` | **新規作成**: コマンドテスト |

#### プロンプトファースト適用方針

| 処理 | 実装方式 | 理由 |
|-----|---------|------|
| Issue クローズ | プロンプト（Bash/gh CLI） | 既存の動作を維持 |
| イベント発火 | スクリプト（TypeScript） | EventBus が必要 |
| DB 更新 | スクリプト（TypeScript） | Kysely が必要 |
| Projects ステータス更新 | スクリプト（TypeScript） | GitHub GraphQL API が必要 |

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| タスク完了時の Issue クローズ | Bash/gh CLI で直接クローズ | 同左 + イベント発火 | `task-done.md` + `task/done.ts` |
| task.completed イベント発火 | 未実装 | TypeScript コマンドで発火 | `src/commands/task/done.ts` |
| Sub Issue ステータス更新 | ハンドラー実装済み（未発火） | イベント発火後に自動実行 | `github-integration.ts` |
| Sub Issue 本文設定 | 空文字列 | タスク説明を設定 | `sub-issues.ts` |
| Sub Issue の Projects 追加 | 未実装 | 作成時に自動追加 | `sub-issues.ts` |
| Sub Issue の Projects ステータス更新 | 未実装 | task.completed ハンドラーで実行 | `github-integration.ts` |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| `task/done.ts` コマンド | イベント発火の確認 | EventBus のモック検証 |
| Sub Issue 本文設定 | description が正しく設定されるか | GitHub API モック検証 |
| Projects ステータス更新 | GraphQL mutation が正しく呼ばれるか | fetch モック検証 |
| E2E ワークフロー | タスク完了 → Sub Issue クローズ → Projects 更新 | 統合テスト |

### 7.5 移行計画

#### Phase 1: Sub Issue 本文対応

1. `SubIssueManager.createSubIssue()` で description パラメータをサポート
2. `createSubIssuesFromTaskList()` でタスク説明を description に設定
3. ユニットテスト追加

#### Phase 2: イベント駆動実装

1. `src/commands/task/done.ts` 新規作成（task.completed イベント発火）
2. `src/slash-commands/task-done.md` を更新（TypeScript コマンド呼び出し追加）
3. ユニットテスト追加

#### Phase 3: Projects 連携

1. `task.completed` ハンドラーに Projects ステータス更新を追加
2. E2E テスト追加・既存テスト更新
---

## 8. 実装タスクリスト

### Phase 1: Sub Issue 本文対応

- [ ] `src/integrations/github/sub-issues.ts` の `createSubIssue()` に description パラメータを追加
- [ ] `src/commands/github/create-sub-issues.ts` でタスク説明を Sub Issue 本文に設定
- [ ] Sub Issue 本文設定のユニットテストを追加

### Phase 2: イベント駆動実装

- [ ] `src/commands/task/done.ts` を新規作成（task.completed イベント発火機能）
- [ ] `src/slash-commands/task-done.md` に TypeScript コマンド呼び出しを追加
- [ ] `tests/commands/task/done.test.ts` を新規作成（コマンドテスト）

### Phase 3: Projects 連携

- [ ] `src/core/workflow/github-integration.ts` の `task.completed` ハンドラーに Projects ステータス更新を追加
- [ ] E2E テスト追加・既存テスト更新（`tests/integrations/sub-issue-workflow.test.ts`）
---

## Pull Request

- https://github.com/B16B1RD/cc-craft-kit/pull/403
