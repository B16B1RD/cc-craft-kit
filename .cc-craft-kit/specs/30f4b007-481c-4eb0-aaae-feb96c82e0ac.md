# Sub Issue が放置されている

**仕様書 ID:** 30f4b007-481c-4eb0-aaae-feb96c82e0ac
**フェーズ:** design
**作成日時:** 2025/11/27 21:30:00
**更新日時:** 2025/11/27 20:09:01

---

## 1. 背景と目的

### 背景

Sub Issue が作られるのは良いが、中身は空っぽで更新されず、ステータスも変わらず、クローズもされないままとなっている。また、GitHub Projects 上でも Todo ステータスのままとなっている。

### 目的

Sub Issue のライフサイクルを適切に管理し、タスク完了時に以下の処理が自動実行されるようにする:

1. Sub Issue 本文にタスク説明を含める
2. タスク完了時に Sub Issue を自動クローズする
3. GitHub Projects 上で Sub Issue のステータスを同期する

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発（SDD）を行う開発者。
特に、GitHub Projects でタスク進捗を管理している開発者。

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:task-done` 実行時に `task.completed` イベントが発火され、Sub Issue が自動クローズされる
- [ ] Sub Issue 作成時に、タスク説明が本文に含まれる

### 機能要件

- [ ] `/cft:task-done` でタスク完了時、対応する Sub Issue がクローズされる
- [ ] `/cft:task-done` でタスク完了時、GitHub Projects 上の Sub Issue ステータスが "Done" に更新される
- [ ] Sub Issue 作成時、仕様書の「実装タスクリスト」からタスク説明を抽出して本文に設定する
- [ ] Sub Issue 作成時、GitHub Projects に自動追加する

### 非機能要件

- [ ] イベント駆動アーキテクチャを維持し、疎結合な実装とする
- [ ] 既存の `task.completed` イベントハンドラーを活用する

---

## 4. 制約条件

- プロンプトファースト原則: プロンプト（.md）で実現可能な処理はプロンプトで実装する
- DB 操作、GitHub API、イベント発火はスクリプト（.ts）で実装する
- 既存のイベント駆動アーキテクチャ（EventBus）を活用する
- GitHub GraphQL/REST API のレート制限を考慮する

---

## 5. 依存関係

### 関連モジュール

- `src/core/workflow/event-bus.ts` - イベント定義（`task.completed` イベント）
- `src/core/workflow/github-integration.ts` - GitHub統合ハンドラー（`task.completed` ハンドラー実装済み）
- `src/integrations/github/sub-issues.ts` - SubIssueManager（Sub Issue 作成・更新）
- `src/integrations/github/projects.ts` - GitHub Projects 管理
- `src/commands/github/create-sub-issues.ts` - Sub Issue 一括作成コマンド
- `src/core/utils/task-parser.ts` - タスクリスト解析
- `src/slash-commands/task-done.md` - タスク完了プロンプト

### データベース

- `github_sync` テーブル: Sub Issue 情報を `entity_type: 'sub_issue'` で管理
- `github_node_id` カラム: GraphQL Node ID を保存（Projects 連携に使用）

---

## 6. 参考情報

### 問題の根本原因

1. **`task.completed` イベントが発火されない**: `/cft:task-done` は Bash/gh CLI ベースのプロンプトで、イベント発火メカニズムがない
2. **Sub Issue 本文が空**: `createSubIssue()` で description が省略されている
3. **Sub Issue が Projects に未追加**: 親 Issue のみ Projects に追加され、Sub Issue は追加されていない

### 解析結果

- `task.completed` ハンドラーは `github-integration.ts:920-970` に実装済み
- イベントが発火されれば `SubIssueManager.updateSubIssueStatus()` が呼ばれる
- GitHub Projects への Sub Issue 追加機能は未実装
