# 仕様書とデータベース間の同期がとれていない

**仕様書 ID:** edcc66aa-6963-4042-9772-847733c802bb
**フェーズ:** completed
**作成日時:** 2025/11/19 10:47:58
**更新日時:** 2025/11/19 11:54:05

---

## 1. 背景と目的

### 背景

**深刻な同期不整合を発見:**

2025/11/19 の調査により、以下の問題が判明しました:

- **ファイルシステム**: `.cc-craft-kit/specs/` に **48個の仕様書ファイル (.md)** が存在
- **データベース**: `specs` テーブルに **2個のレコード** のみ存在
- **同期率**: わずか **4.2% (2/48)**

**具体的な問題:**

1. 過去に作成された 46 個の仕様書がデータベースに登録されていない
2. `/cft:spec-list` コマンドで表示されるのは 2 個のみ
3. `/cft:spec-get` コマンドで古い仕様書にアクセスできない
4. GitHub Issue との連携が不完全な可能性

**影響範囲:**

- 仕様書の検索・一覧表示が機能していない
- フェーズ管理が不可能
- GitHub 統合が不完全
- プロジェクト管理機能全体に影響

**想定される原因:**

1. データベース初期化時に既存ファイルのインポート処理が実行されていない
2. 過去にデータベースが削除/再作成された
3. マイグレーション時にデータ移行が実施されていない
4. 仕様書作成時にファイルのみ作成し、データベース登録をスキップした可能性

### 目的

仕様書ファイルとデータベース間の完全な同期を実現し、以下を達成する:

1. **既存ファイルのインポート**: 48 個すべての仕様書をデータベースに登録
2. **整合性チェック機構**: ファイルと DB 間の不整合を検出
3. **自動同期機能**: 起動時・定期的に同期を実行
4. **修復ツール**: 同期ズレを自動修復するコマンド提供
5. **予防策**: 今後、同じ問題が発生しないための仕組み構築

---

## 2. 対象ユーザー

- cc-craft-kit プロジェクト開発者全員
- プロジェクトマネージャー (仕様書管理者)
- CI/CD パイプライン (自動整合性チェック)
- 新規参加メンバー (既存仕様書の参照)

---

## 3. 受け入れ基準

### 必須要件

- [ ] 48 個すべての仕様書ファイルがデータベースに登録される
- [ ] `/cft:spec-list` で 48 個すべてが表示される
- [ ] `/cft:spec-get <spec-id>` ですべての仕様書にアクセス可能
- [ ] ファイルと DB 間の整合性が 100%になる

### 機能要件

- [ ] `/cft:sync-check` コマンドで整合性チェックを実行できる
- [ ] `/cft:sync-repair` コマンドで自動修復を実行できる
- [ ] プロジェクト起動時に自動整合性チェックが実行される
- [ ] 不整合検出時に警告メッセージが表示される
- [ ] 仕様書ファイルからメタデータ(ID, name, phase, created_at)を自動抽出できる
- [ ] GitHub Issue との連携状態も同期チェックに含まれる

### 非機能要件

- [ ] 48 個のインポート処理が 5 秒以内に完了する
- [ ] 整合性チェックが CI/CD パイプラインで自動実行される
- [ ] エラー時のログが詳細に記録される
- [ ] データベース破損時のバックアップ・リストア機能がある

---

## 4. 制約条件

- 既存の 48 個の仕様書ファイルを削除してはならない
- データベーススキーマの変更は最小限にする
- 既存の `/cft:spec-*` コマンドとの互換性を保つ
- 実行中のプロジェクトに影響を与えない (停止不要)
- SQLite の ACID トランザクション特性を活用する

---

## 5. 依存関係

### データベース
- `src/core/database/schema.ts` - specs テーブル定義
- `src/core/database/connection.ts` - DB 接続管理

### 仕様書管理
- `src/commands/spec/create.ts` - 仕様書作成ロジック
- `src/commands/spec/list.ts` - 一覧表示ロジック
- `src/commands/spec/get.ts` - 詳細取得ロジック

### GitHub統合
- `src/integrations/github/sync.ts` - GitHub Issue 同期
- `src/core/database/schema.ts` - github_sync テーブル

---

## 6. 参考情報

- GitHub Issue: #53
- 類似問題: `c9d9d620-4e73-4fd8-9422-b48ba49e3abd.md` (テスト同期問題)
- データベーススキーマ: `src/core/database/migrations/`
- 仕様書ファイル命名規則: `{UUID}.md`

---

## 7. 設計

### アーキテクチャ概要

```
┌─────────────────────────────────────┐
│  スラッシュコマンド層              │
│  - /cft:sync-check                  │
│  - /cft:sync-repair                 │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│  同期管理サービス層                 │
│  - SyncService                      │
│  - IntegrityChecker                 │
│  - SpecFileParser                   │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│  データ層                           │
│  - Database (specs table)           │
│  - FileSystem (.cc-craft-kit/specs/)│
│  - GitHub Sync (github_sync table)  │
└─────────────────────────────────────┘
```

### コアコンポーネント

#### 1. SpecFileParser

仕様書ファイルからメタデータを抽出します。

```typescript
interface SpecMetadata {
  id: string;
  name: string;
  phase: Phase;
  created_at: string;
  updated_at: string;
}

class SpecFileParser {
  parseFile(filePath: string): SpecMetadata;
  extractFrontMatter(content: string): Record<string, string>;
  extractTitle(content: string): string;
}
```

**抽出ルール:**
- ID: ファイル名から UUID を抽出
- Name: マークダウンの第 1 行目 (# タイトル)
- Phase: `**フェーズ:** tasks` のパターンでマッチング
- Created/Updated: `**作成日時:**`, `**更新日時:**` から抽出

#### 2. IntegrityChecker

ファイルシステムとデータベース間の整合性をチェックします。

```typescript
interface IntegrityReport {
  filesOnly: string[];      // ファイルのみ存在 (DB未登録)
  dbOnly: string[];         // DBのみ存在 (ファイル削除済み)
  mismatch: string[];       // メタデータ不一致
  synced: string[];         // 正常に同期済み
  totalFiles: number;
  totalDbRecords: number;
  syncRate: number;         // 同期率 (%)
}

class IntegrityChecker {
  async check(): Promise<IntegrityReport>;
  async repair(report: IntegrityReport): Promise<void>;
}
```

#### 3. SyncService

同期処理の中核ロジックを実装します。

```typescript
class SyncService {
  async importFromFiles(fileIds: string[]): Promise<void>;
  async exportToFiles(specIds: string[]): Promise<void>;
  async syncGitHubStatus(): Promise<void>;
}
```

### データフロー

#### 同期チェック (`/cft:sync-check`)

```
1. specsディレクトリから全.mdファイルを取得
2. データベースから全specsレコードを取得
3. IntegrityChecker.check() で差分を検出
4. レポートをコンソールに出力
```

#### 同期修復 (`/cft:sync-repair`)

```
1. IntegrityChecker.check() で差分を検出
2. filesOnly → SyncService.importFromFiles()
3. dbOnly → 警告表示 (ファイル削除済みの可能性)
4. mismatch → ファイル優先で上書き更新
5. 修復完了レポートを出力
```

#### 起動時チェック

```
1. プロジェクト初期化時にIntegrityChecker.check()を実行
2. syncRate < 100% の場合、警告メッセージを表示
3. /cft:sync-repair の実行を推奨
```

### エラーハンドリング

- **ファイル読み込みエラー**: スキップしてログ記録、次のファイルへ継続
- **データベースエラー**: トランザクションロールバック、エラーメッセージ表示
- **GitHub API エラー**: 警告ログ記録、同期チェックは継続
- **メタデータ抽出エラー**: デフォルト値を使用、警告ログ記録

### パフォーマンス最適化

- **バッチインサート**: 48 個の仕様書を一括挿入 (トランザクション内)
- **並列処理**: ファイル読み込みを Promise.all() で並列化
- **インデックス活用**: specs.id, specs.phase にインデックス設定済み
- **キャッシュ**: 頻繁にアクセスされる仕様書はメモリキャッシュ (将来実装)

---

## 8. 実装タスクリスト

### フェーズ1: コアロジック実装

1. **仕様書ファイルからメタデータを抽出するパーサー実装**
   - ファイル: `src/core/sync/spec-file-parser.ts`
   - 実装内容:
     - マークダウンファイルからタイトル、フェーズ、日時を抽出
     - UUID 検証とフォーマットチェック
     - エラーハンドリングとデフォルト値設定
   - テスト: `tests/core/sync/spec-file-parser.test.ts`

2. **データベースへの一括インポート機能実装**
   - ファイル: `src/core/sync/sync-service.ts`
   - 実装内容:
     - トランザクション内での一括インサート
     - 重複チェック (upsert ロジック)
     - エラーログ記録
   - テスト: `tests/core/sync/sync-service.test.ts`

### フェーズ2: 整合性チェック機能

3. **整合性チェッカーの実装**
   - ファイル: `src/core/sync/integrity-checker.ts`
   - 実装内容:
     - ファイルシステムと DB の差分検出
     - メタデータ不一致の検出
     - 同期率の計算
     - レポート生成
   - テスト: `tests/core/sync/integrity-checker.test.ts`

4. **GitHub Issue同期状態のチェック機能実装**
   - ファイル: `src/core/sync/github-sync-checker.ts`
   - 実装内容:
     - github_sync テーブルとの照合
     - Issue 作成漏れの検出
     - 同期エラーの記録
   - テスト: `tests/core/sync/github-sync-checker.test.ts`

### フェーズ3: コマンド実装

5. **/cft:sync-check コマンドの実装**
   - ファイル: `src/commands/sync/check.ts`
   - スラッシュコマンド: `src/slash-commands/sync-check.md`
   - 実装内容:
     - IntegrityChecker 呼び出し
     - レポート整形と表示
     - カラー出力対応
   - テスト: E2E テストで検証

6. **/cft:sync-repair コマンドの実装**
   - ファイル: `src/commands/sync/repair.ts`
   - スラッシュコマンド: `src/slash-commands/sync-repair.md`
   - 実装内容:
     - 自動修復ロジック
     - ユーザー確認プロンプト (--force オプション)
     - 修復結果レポート
   - テスト: E2E テストで検証

### フェーズ4: 自動化機能

7. **起動時の自動整合性チェック機能実装**
   - ファイル: `src/core/sync/auto-check.ts`
   - 実装内容:
     - プロジェクト起動時フック
     - 警告メッセージ表示
     - 修復推奨メッセージ
   - テスト: 統合テストで検証

8. **CI/CDパイプラインへの整合性チェック組み込み**
   - ファイル: `.github/workflows/integrity-check.yml`
   - 実装内容:
     - GitHub Actions ワークフロー作成
     - npm run sync:check コマンド追加
     - 不整合検出時のビルド失敗
   - テスト: GitHub Actions で検証

### フェーズ5: テストとドキュメント

9. **単体テストの作成**
   - 対象ファイル: 上記すべてのコアロジック
   - カバレッジ目標: 80%以上
   - テストケース:
     - 正常系: 48 個のインポート成功
     - 異常系: ファイル読み込みエラー、DB 接続エラー
     - エッジケース: 空ファイル、不正フォーマット

10. **ドキュメントの更新**
    - ファイル: `CLAUDE.md`, `docs/ARCHITECTURE.md`
    - 実装内容:
      - 同期機能の説明追加
      - トラブルシューティングセクション更新
      - コマンド一覧の更新
