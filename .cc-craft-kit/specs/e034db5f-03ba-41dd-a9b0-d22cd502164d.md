# GitHub Issue の運用見直し

**仕様書 ID:** e034db5f-03ba-41dd-a9b0-d22cd502164d
**フェーズ:** completed
**作成日時:** 2025/01/25 10:30:00
**更新日時:** 2025/11/25 14:37:00

---

## 1. 背景と目的

### 背景

現在の cc-craft-kit では、GitHub Issue と仕様書の連携において以下の課題がある:

- **Issue 本文の更新タイミングが限定的**: 仕様書更新時に Issue 本文が更新されるが、テンプレート状態からの更新のみが対象となっており、一度編集された Issue 本文は再同期されない場合がある
- **チェックリスト同期機能が未実装**: 仕様書内の受け入れ基準（チェックボックス形式）と GitHub Issue のチェックボックスが連動しておらず、手動での二重管理が必要
- **変更履歴の記録が不十分**: 仕様書更新時のコメントは「更新されました」という通知のみで、何が変更されたかの要約がない

### 目的

GitHub Issue を「仕様書の可視化ビュー」として位置づけ、以下を実現する:

- Issue 本文を常に最新の仕様書内容で同期（Source of Truth は仕様書ファイル）
- 受け入れ基準のチェックボックス状態を双方向同期
- 仕様書の変更履歴をコメントで要約付きで記録

---

## 2. 対象ユーザー

- cc-craft-kit を使用して仕様駆動開発を行う開発者
- GitHub Issue で進捗を確認するプロジェクト管理者

---

## 3. 受け入れ基準

### 必須要件

- [ ] Issue 本文が仕様書の内容と常に同期されること
- [ ] 仕様書ファイルが Source of Truth として機能すること
- [ ] 受け入れ基準のチェックボックスが双方向同期されること

### 機能要件

- [ ] 仕様書更新時に Issue 本文を自動更新する機能
- [ ] チェックボックス状態の仕様書 → Issue 同期機能
- [ ] チェックボックス状態の Issue → 仕様書 同期機能
- [ ] 変更履歴をコメントで記録する機能（変更要約付き）
- [ ] 同期競合時の解決ポリシーの実装

### 非機能要件

- [ ] GitHub API レート制限を考慮した設計
- [ ] 同期処理のエラーハンドリングとリトライ機構
- [ ] 同期状態の可視化（最終同期日時、同期ステータス）

---

## 4. 制約条件

- 既存の cc-craft-kit アーキテクチャに準拠すること
- GitHub API v3/v4 の仕様に準拠すること
- プロンプトファースト原則に従い、可能な限りプロンプトベースで実装すること

---

## 5. 依存関係

- `src/integrations/github/` - 既存の GitHub 連携モジュール
- `src/core/workflow/event-bus.ts` - イベント駆動アーキテクチャ
- `src/core/sync/` - 同期サービス

---

## 6. 参考情報

- GitHub API ドキュメント: https://docs.github.com/en/rest
- 既存の Issue 同期実装: `src/integrations/github/sync.ts`

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
┌─────────────────────────────────────────────────────────────────┐
│                        cc-craft-kit                              │
├─────────────────────────────────────────────────────────────────┤
│  仕様書ファイル (.cc-craft-kit/specs/*.md)                        │
│       │                              ▲                           │
│       │ spec.updated イベント         │ Webhook (checkbox変更)    │
│       ▼                              │                           │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │              GitHub Sync Service (拡張)                  │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │    │
│  │  │BodySyncer  │  │CheckboxSync │  │ChangeLogWriter │  │    │
│  │  │(常時同期)   │  │(双方向)     │  │(差分要約)       │  │    │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘  │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│                     GitHub API (REST/GraphQL)                    │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                      GitHub Issue                                │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ [design] 機能名                                          │    │
│  ├─────────────────────────────────────────────────────────┤    │
│  │ # 仕様書タイトル                                         │    │
│  │ ## 3. 受け入れ基準                                       │    │
│  │ - [x] 完了した要件 ← 双方向同期                          │    │
│  │ - [ ] 未完了の要件                                       │    │
│  ├─────────────────────────────────────────────────────────┤    │
│  │ 💬 コメント                                              │    │
│  │ - 📝 仕様書更新 (差分要約付き)                           │    │
│  │ - 🔄 フェーズ移行                                        │    │
│  │ - ✅ チェックボックス更新                                │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

#### Source of Truth の原則

| データ | Source of Truth | 同期方向 |
|--------|----------------|----------|
| 仕様書本文 | 仕様書ファイル | 仕様書 → Issue（常時上書き） |
| チェックボックス | 仕様書ファイル | 双方向（仕様書優先、競合時は仕様書が勝つ） |
| フェーズ | DB (specs.phase) | DB → Issue（ラベル・タイトル） |
| 変更履歴 | Issue コメント | 仕様書 → Issue（追記のみ） |

### 7.2 機能設計

#### 7.2.1 Issue 本文の常時同期

**現状の問題:**
- `sync.ts:79-92` でテンプレート判定を行い、テンプレート状態の場合のみ本文を更新
- 一度編集された Issue 本文は再同期されない

**解決策:**
テンプレート判定ロジックを削除し、常に仕様書ファイルの内容で Issue 本文を上書きする。

**変更箇所:**

| ファイル | 変更内容 |
|----------|----------|
| `src/integrations/github/sync.ts` | テンプレート判定ロジック削除、常時上書きに変更 |
| `src/core/workflow/github-integration.ts` | `spec.updated` ハンドラーは変更不要（既に常時更新） |

**実装詳細:**

```typescript
// sync.ts の syncSpecToIssue メソッド内
// 変更前（79-92行）
const existingIssue = await this.issues.get(...);
const isTemplate = existingIssue.body?.includes('(背景を記述してください)') || ...;
...(isTemplate ? { body: await this.buildIssueBody(spec) } : {}),

// 変更後
// テンプレート判定を削除し、常に本文を更新
const updateParams: UpdateIssueParams = {
  owner: params.owner,
  repo: params.repo,
  issueNumber: spec.github_issue_number,
  title: `[${spec.phase}] ${spec.name}`,
  body: await this.buildIssueBody(spec),  // 常に更新
  labels: [this.getPhaseLabel(spec.phase)],
};
```

#### 7.2.2 チェックボックス双方向同期

**新規モジュール:** `src/integrations/github/checkbox-sync.ts`

**データフロー:**

```
仕様書 → Issue 方向:
  1. spec.updated イベント発火
  2. CheckboxSyncService.syncToIssue() 呼び出し
  3. 仕様書からチェックボックス状態を抽出
  4. Issue 本文全体を更新（既存の常時同期に統合）

Issue → 仕様書 方向:
  1. GitHub Webhook で issue.edited イベント受信
  2. CheckboxSyncService.syncToSpec() 呼び出し
  3. Issue 本文からチェックボックス状態を抽出
  4. 仕様書ファイルを更新
  5. git commit で変更を記録
```

**チェックボックス抽出ロジック:**

```typescript
interface CheckboxItem {
  line: number;         // 行番号
  text: string;         // チェックボックスのテキスト
  checked: boolean;     // チェック状態
  section: string;      // 所属セクション（"必須要件", "機能要件" など）
}

function parseCheckboxes(markdown: string): CheckboxItem[] {
  const lines = markdown.split('\n');
  const checkboxes: CheckboxItem[] = [];
  let currentSection = '';

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];

    // セクション見出しを追跡
    if (line.match(/^###?\s+(.+)/)) {
      currentSection = RegExp.$1;
    }

    // チェックボックスを検出
    const checkboxMatch = line.match(/^(\s*)-\s*\[([ xX])\]\s*(.+)$/);
    if (checkboxMatch) {
      checkboxes.push({
        line: i + 1,
        text: checkboxMatch[3].trim(),
        checked: checkboxMatch[2].toLowerCase() === 'x',
        section: currentSection,
      });
    }
  }

  return checkboxes;
}
```

**競合解決ポリシー:**

| 状態 | 仕様書 | Issue | 解決 |
|------|--------|-------|------|
| 一致 | ✓ | ✓ | そのまま |
| 一致 | ☐ | ☐ | そのまま |
| 不一致（仕様書優先） | ✓ | ☐ | Issue を ✓ に更新 |
| 不一致（Issue 更新検出） | ☐ | ✓ | 仕様書を ✓ に更新 |

**同期タイミング:**

| トリガー | 同期方向 | 処理 |
|----------|----------|------|
| `spec.updated` イベント | 仕様書 → Issue | Issue 本文全体を更新 |
| Webhook `issue.edited` | Issue → 仕様書 | チェックボックス部分のみ更新 |
| `/cft:github-sync pull` | Issue → 仕様書 | 手動プル |
| `/cft:github-sync push` | 仕様書 → Issue | 手動プッシュ |

#### 7.2.3 変更履歴の要約記録

**新規モジュール:** `src/integrations/github/changelog-writer.ts`

**差分検出アルゴリズム:**

```typescript
interface ChangelogEntry {
  type: 'added' | 'removed' | 'modified';
  section: string;      // 変更されたセクション
  summary: string;      // 変更内容の要約
}

function detectChanges(oldContent: string, newContent: string): ChangelogEntry[] {
  const oldSections = parseSections(oldContent);
  const newSections = parseSections(newContent);
  const changes: ChangelogEntry[] = [];

  // セクション単位で比較
  for (const [name, content] of newSections) {
    if (!oldSections.has(name)) {
      changes.push({ type: 'added', section: name, summary: `新規追加` });
    } else if (oldSections.get(name) !== content) {
      changes.push({
        type: 'modified',
        section: name,
        summary: generateDiffSummary(oldSections.get(name)!, content)
      });
    }
  }

  // 削除されたセクションを検出
  for (const [name] of oldSections) {
    if (!newSections.has(name)) {
      changes.push({ type: 'removed', section: name, summary: `削除` });
    }
  }

  return changes;
}
```

**コメント形式:**

```markdown
## 📝 仕様書更新

仕様書が更新されました。

### 変更内容
- **## 3. 受け入れ基準**: 2件の要件を追加
- **## 4. 制約条件**: 文言を修正

**更新日時:** 2025/01/25 10:30
**差分:** [コミット abc1234](../../commit/abc1234)
**最新の仕様書:** [`.cc-craft-kit/specs/xxx.md`](../../.cc-craft-kit/specs/xxx.md)
```

### 7.3 データベース設計

#### 既存テーブルの拡張

`github_sync` テーブルに以下のカラムを追加:

```sql
ALTER TABLE github_sync ADD COLUMN checkbox_hash TEXT;
ALTER TABLE github_sync ADD COLUMN last_body_hash TEXT;
```

| カラム | 型 | 説明 |
|--------|-----|------|
| `checkbox_hash` | TEXT | チェックボックス状態のハッシュ（競合検出用） |
| `last_body_hash` | TEXT | 最終同期時の Issue 本文ハッシュ |

**マイグレーションファイル:**

```typescript
// src/core/database/migrations/009_add_sync_hashes.ts
import { Kysely, sql } from 'kysely';

export async function up(db: Kysely<unknown>): Promise<void> {
  await db.schema
    .alterTable('github_sync')
    .addColumn('checkbox_hash', 'text')
    .execute();

  await db.schema
    .alterTable('github_sync')
    .addColumn('last_body_hash', 'text')
    .execute();
}

export async function down(db: Kysely<unknown>): Promise<void> {
  // SQLite は ALTER TABLE DROP COLUMN をサポートしていないため、
  // テーブル再作成が必要
}
```

### 7.4 イベント設計

#### 新規イベント

| イベント名 | トリガー | データ |
|------------|----------|--------|
| `checkbox.synced` | チェックボックス同期完了 | `{ specId, direction, changes }` |
| `changelog.written` | 変更履歴コメント追加完了 | `{ specId, issueNumber, commentId }` |

#### 既存イベントの活用

| イベント名 | 用途 |
|------------|------|
| `spec.updated` | Issue 本文 + チェックボックス同期トリガー |
| `spec.phase_changed` | Issue ラベル + Project ステータス更新 |

### 7.5 API 設計

#### 新規スラッシュコマンド

**`/cft:github-sync`** - 手動同期コマンド

```markdown
# 使用方法
/cft:github-sync <direction> <spec-id>

# パラメータ
- direction: pull | push | status
  - pull: Issue → 仕様書（チェックボックスのみ）
  - push: 仕様書 → Issue（本文全体）
  - status: 同期状態を表示
- spec-id: 仕様書 ID（8文字以上）

# 例
/cft:github-sync pull e034db5f   # Issue のチェックボックス状態を仕様書に反映
/cft:github-sync push e034db5f   # 仕様書を Issue に強制同期
/cft:github-sync status e034db5f # 同期状態を確認
```

### 7.6 Webhook 設計

#### 必要な Webhook イベント

| イベント | アクション | 処理 |
|----------|------------|------|
| `issues` | `edited` | チェックボックス変更を検出し仕様書に反映 |

**Webhook ハンドラー拡張:**

```typescript
// src/integrations/github/webhook.ts の handleIssueEdited を拡張
private async handleIssueEdited(specId: string, issue: {
  title: string;
  body: string;  // 追加
}): Promise<void> {
  // 既存: タイトルから仕様名を抽出
  const match = issue.title.match(/^\[.*?\]\s*(.+)$/);
  const name = match ? match[1] : issue.title;

  // 新規: チェックボックス同期
  const checkboxSync = new CheckboxSyncService(this.db);
  await checkboxSync.syncToSpec({
    specId,
    issueBody: issue.body,
  });

  await this.db
    .updateTable('specs')
    .set({
      name,
      updated_at: new Date().toISOString(),
    })
    .where('id', '=', specId)
    .execute();
}
```

### 7.7 テスト戦略

#### 単体テスト

| テスト対象 | テストケース |
|------------|--------------|
| `parseCheckboxes()` | 正常系、ネストあり、セクションなし |
| `detectChanges()` | 追加、削除、変更、変更なし |
| `CheckboxSyncService` | 仕様書→Issue、Issue→仕様書、競合解決 |
| `ChangelogWriter` | コメント生成、差分要約 |

#### 統合テスト

| テストシナリオ | 検証内容 |
|----------------|----------|
| 仕様書更新フロー | spec.updated → Issue 本文更新 → コメント追加 |
| Webhook フロー | issue.edited → チェックボックス同期 → 仕様書更新 |
| 競合解決フロー | 同時編集 → 仕様書優先 → 警告表示 |

#### モック対象

- GitHub API（Octokit）
- データベース（`:memory:` モード）
- ファイルシステム（仕様書ファイル）
- Git 操作

### 7.8 実装優先度

| 優先度 | 機能 | 理由 |
|--------|------|------|
| P0 | Issue 本文の常時同期 | 既存コードの修正のみで実現可能 |
| P1 | 変更履歴の要約記録 | ユーザー体験の向上に直結 |
| P2 | チェックボックス 仕様書→Issue | 片方向のみで実用的 |
| P3 | チェックボックス Issue→仕様書 | Webhook 設定が必要 |

### 7.9 プロンプトファースト評価

| 機能 | 実装方法 | 理由 |
|------|----------|------|
| Issue 本文同期 | スクリプト | GitHub API（Octokit）が必要 |
| チェックボックス解析 | スクリプト | 正規表現処理、ファイル I/O が必要 |
| 変更履歴コメント | スクリプト | GitHub API（Octokit）が必要 |
| 手動同期コマンド | プロンプト | スクリプト呼び出しのラッパー |
| 同期状態表示 | プロンプト | DB 読み取り + 表示のみ |

### 7.10 リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| GitHub API レート制限 | 同期失敗 | 指数バックオフ、バッチ処理 |
| 同時編集による競合 | データ不整合 | 仕様書優先ポリシー、警告表示 |
| Webhook 未設定 | 片方向同期のみ | 手動プルコマンドで代替 |
| 大きな仕様書 | Issue 本文サイズ超過 | 65,000文字制限チェック、警告 |

---

## 8. 実装タスクリスト

設計に基づき、以下のタスクを実装優先度順に実行します。

### P0: Issue 本文の常時同期 ✅

- [x] `src/integrations/github/sync.ts` のテンプレート判定ロジックを削除
- [x] 常に `buildIssueBody()` で本文を更新するように変更
- [x] 単体テスト: `sync.ts` の本文更新ロジック

### P1: 変更履歴の要約記録 ✅

- [x] `src/integrations/github/changelog-writer.ts` を新規作成
  - [x] `parseSections()` - Markdown セクション解析
  - [x] `detectChanges()` - セクション単位の差分検出
  - [x] `generateDiffSummary()` - 差分要約生成
  - [x] `buildChangelogComment()` - コメント本文生成
- [x] `src/core/workflow/github-integration.ts` の `spec.updated` ハンドラーに統合
- [x] 単体テスト: `changelog-writer.ts` (55件)

### P2: チェックボックス同期（仕様書 → Issue） ✅

- [x] `src/integrations/github/checkbox-sync.ts` を新規作成
  - [x] `parseCheckboxes()` - チェックボックス抽出
  - [x] `CheckboxSyncService.syncToIssue()` - 仕様書 → Issue 同期
- [x] 既存の Issue 本文同期に統合（追加作業なし、本文全体を更新するため）
- [x] 単体テスト: `parseCheckboxes()` (37件)

### P3: チェックボックス同期（Issue → 仕様書） ✅

- [x] `CheckboxSyncService.syncToSpec()` を実装
  - [x] Issue 本文からチェックボックス状態を抽出
  - [x] 仕様書ファイルを更新
  - [ ] git commit で変更を記録（将来対応）
- [x] `src/integrations/github/webhook.ts` の `handleIssueEdited` を拡張
- [x] DB マイグレーション: `checkbox_hash`, `last_body_hash` カラム追加 (010_add_sync_hashes.ts)
- [x] `/cft:github-sync` コマンドを更新（チェックボックス同期対応）
- [x] 単体テスト: `CheckboxSyncService.syncToSpec()` (含む checkbox-sync.test.ts)
- [x] 統合テスト: Webhook フロー (含む github-issue-sync.test.ts)

### 共通 ✅

- [x] 全機能の統合テスト (9件: github-issue-sync.test.ts)
- [ ] ドキュメント更新（README、ARCHITECTURE.md）（任意）

---

## Pull Request

- https://github.com/B16B1RD/cc-craft-kit/pull/369
