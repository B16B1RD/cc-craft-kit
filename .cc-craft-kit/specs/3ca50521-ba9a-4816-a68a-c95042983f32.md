---
id: "3ca50521-ba9a-4816-a68a-c95042983f32"
name: "/cft:spec phase <id> completed で仕様書のフェーズが review のまま"
phase: "review"
branch_name: "fix/spec-3ca50521-phase-stuck-on-review"
github_issue_number: null
pr_url: null
created_at: "2025-12-06T15:30:00.000Z"
updated_at: "2025-12-06T18:45:00.000Z"
---

# /cft:spec phase <id> completed で仕様書のフェーズが review のまま

## 1. 背景と目的

### 背景

`/cft:spec phase <spec-id> completed` コマンドを実行しても、仕様書のフェーズが `completed` に更新されず、`review` のままになるバグが発生している。

### 目的

`/cft:spec phase <id> completed` コマンドが正しく動作し、仕様書のフェーズが確実に `completed` に更新されるようにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec phase <id> completed` 実行後、仕様書の phase が "completed" に更新される
- [ ] YAML フロントマターの updated_at が現在時刻に更新される

### 機能要件

- [ ] コマンド実行後、変更がコミットされる
- [ ] ベースブランチへの切り替えが行われる
- [ ] 作業ブランチが削除される（オプション）

### 非機能要件

- [ ] エラーが発生した場合、適切なメッセージが表示される

---

## 4. 制約条件

- 既存の `/cft:spec phase` コマンドの仕様に準拠する
- YAML フロントマター形式を維持する

---

## 5. 依存関係

- `.claude/commands/cft/spec.md` - spec コマンドの定義
- Git 操作（コミット、ブランチ切り替え）

---

## 6. 参考情報

- 関連する既存の仕様書: 1019511f（同様の問題を修正済み）
- PR #944 で類似の修正が行われた可能性あり

---

## 7. 設計詳細

### 7.1 問題分析

#### 根本原因: PR マージ後のローカルブランチ残存

PR #944 の修正では、以下の問題が解決されていなかった:

1. **PR マージ後のシナリオ未対応**: review フェーズで PR を作成し、GitHub 上でマージされた後に `/cft:spec phase <id> completed` を実行すると、ローカルの作業ブランチが残ったまま
2. **古い状態の仕様書が見える**: `/cft:spec list` が他ブランチの仕様書を表示する機能で、削除されるべきブランチの古い状態（review）を拾ってしまう
3. **二重管理状態**: develop では completed、作業ブランチでは review という矛盾した状態

### 7.2 修正内容

`.claude/commands/cft/spec.md` の completed フェーズ後処理セクションを以下のように修正:

1. **ケース分岐を追加**: PR がマージ済みかどうかを `gh pr view` で確認
2. **ケース A（PR マージ済み）**: develop を pull してからブランチ削除
3. **ケース B（PR 未マージまたはなし）**: 従来通りコミット→ブランチ切り替え→削除

### 7.3 修正後のフロー

```
PR がマージ済み？
├─ はい → develop に切り替え → pull → ブランチ削除
└─ いいえ → コミット → develop に切り替え → ブランチ削除
```

---

## 8. 実装タスクリスト

- [x] マージ済みブランチのクリーンアップ
- [x] spec.md に PR マージ済みケースの処理を追加
- [ ] この仕様書を completed に更新して完了
