---
id: "3ca50521-ba9a-4816-a68a-c95042983f32"
name: "/cft:spec phase <id> completed で仕様書のフェーズが review のまま"
phase: "design"
branch_name: "fix/spec-3ca50521-phase-stuck-on-review"
github_issue_number: null
pr_url: null
created_at: "2025-12-06T15:30:00.000Z"
updated_at: "2025-12-06T18:23:00.000Z"
---

# /cft:spec phase <id> completed で仕様書のフェーズが review のまま

## 1. 背景と目的

### 背景

`/cft:spec phase <spec-id> completed` コマンドを実行しても、仕様書のフェーズが `completed` に更新されず、`review` のままになるバグが発生している。

### 目的

`/cft:spec phase <id> completed` コマンドが正しく動作し、仕様書のフェーズが確実に `completed` に更新されるようにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec phase <id> completed` 実行後、仕様書の phase が "completed" に更新される
- [ ] YAML フロントマターの updated_at が現在時刻に更新される

### 機能要件

- [ ] コマンド実行後、変更がコミットされる
- [ ] ベースブランチへの切り替えが行われる
- [ ] 作業ブランチが削除される（オプション）

### 非機能要件

- [ ] エラーが発生した場合、適切なメッセージが表示される

---

## 4. 制約条件

- 既存の `/cft:spec phase` コマンドの仕様に準拠する
- YAML フロントマター形式を維持する

---

## 5. 依存関係

- `.claude/commands/cft/spec.md` - spec コマンドの定義
- Git 操作（コミット、ブランチ切り替え）

---

## 6. 参考情報

- 関連する既存の仕様書: 1019511f（同様の問題を修正済み）
- PR #944 で類似の修正が行われた可能性あり

---

## 7. 設計詳細

### 7.1 問題分析

#### 根本原因: コミット順序の曖昧性

修正前の `spec.md` では completed フェーズの後処理が箇条書きで記述されていたため、以下の問題が発生していた:

1. **段階的実行の順序が不明確**: Claude Code が Step 6（自動コミット）の実行を待たずに Step 7（ブランチ切り替え）を実行する可能性
2. **ファイルシステムの状態が矛盾**: 変更がコミットされずに develop ブランチに切り替わり、作業ブランチが削除される
3. **仕様書ファイルの可視性の喪失**: develop に切り替えると、変更が反映されていないファイルが見える

### 7.2 修正内容

`.claude/commands/cft/spec.md` の completed フェーズ後処理セクション（行 439-464）を以下のように修正:

1. **明示的な順序強調**: "**重要**: 以下の順序で**必ず**実行すること" という注意書きを追加
2. **番号付きリスト**: 4つのステップを番号付きで明確化
3. **コミット実行の強調**: "※ このコミットが完了するまで、次のステップに進んではならない" という注記
4. **バッチコマンドの回避**: `&&` で連結せず、各コマンドを個別ステップに分割

### 7.3 実装状況

**この問題は既に修正済みです。**

- 修正 PR: #944
- 修正コミット: `91953cf`, `c96ca2a`
- 修正日: 2025-12-06

---

## 8. 実装タスクリスト

- [x] `.claude/commands/cft/spec.md` の completed フェーズ後処理セクションを修正（PR #944 で完了）
- [x] コミット順序を明示的に強調する文言を追加（PR #944 で完了）
- [ ] この仕様書を completed に更新して完了
