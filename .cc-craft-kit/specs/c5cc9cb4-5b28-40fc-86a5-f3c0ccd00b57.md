# /cft:pr-cleanup が正しく動作していない

**仕様書 ID:** c5cc9cb4-5b28-40fc-86a5-f3c0ccd00b57
**フェーズ:** requirements
**作成日時:** 2025/11/24 09:20:32
**更新日時:** 2025/11/24 09:20:32

---

## 1. 背景と目的

### 背景

以下の3つの問題を修正する必要があります:

1. **PR存在判定の誤り**: PR作成済みなのに「PRが作成されていません」と判定される
   - github_syncテーブルのJOIN条件が正しくない可能性
   - PR作成時のデータベース記録が不完全な可能性

2. **branch_nameカラム更新値の誤り**: PRのマージ先ブランチ名を設定すべきなのに、空文字列を設定している
   - PRがdevelopブランチにマージされた場合、branch_nameは'develop'にすべき
   - 現在は空文字列''を設定している

3. **SQLクエリの誤り**: github_syncテーブルに存在しないg.spec_idカラムを参照
   - 正しくはentity_idカラムを使用すべき

参考ログ: PR #330はdevelopブランチにマージ済み（2025-11-24T00:11:59Z）、feature/spec-a6e1c24a-add-design-implementation-rules ブランチから作成

### 目的

`/cft:pr-cleanup` コマンドが PR マージ後の後処理を正しく実行できるようにする。具体的には:

1. PR の存在判定を正確に行う
2. データベースの `branch_name` カラムをマージ先ブランチ名（develop または main）に更新する
3. SQL クエリで正しいカラム名を使用する

---

## 2. 対象ユーザー

- cc-craft-kit を使用する開発者
- 仕様駆動開発（SDD）で PR マージ後の後処理を実行するユーザー

---

## 3. 受け入れ基準

### 必須要件

- [ ] PR が作成済みの場合、正しく検出できること
- [ ] PR マージ後、`specs.branch_name` カラムがマージ先ブランチ名（`develop` または `main`）に更新されること
- [ ] SQL クエリで存在しないカラム（`g.spec_id`）を参照しないこと（`entity_id` を使用すること）

### 機能要件

- [ ] `getSpecWithGitHubInfo()` が `github_sync` テーブルと正しく JOIN できること
- [ ] `updateSpecBranchToBaseBranch()` が PR のベースブランチ名（`pr.base.ref`）を受け取り、`specs.branch_name` に設定できること
- [ ] PR が作成されていない場合、適切なエラーメッセージを表示すること
- [ ] PR がマージされていない場合、適切なエラーメッセージを表示すること

### 非機能要件

- [ ] データベース更新がトランザクション内で実行されること
- [ ] エラーメッセージがユーザーにとって理解しやすいこと
- [ ] GitHub API のレート制限を考慮した実装であること

---

## 4. 制約条件

- Kysely の型安全性を維持すること
- `specs.branch_name` カラムは NOT NULL 制約があるため、空文字列ではなく有効なブランチ名（`develop` または `main`）を設定すること
- `github_sync` テーブルの `entity_id` カラムと `specs.id` カラムを JOIN すること（`spec_id` カラムは存在しない）

---

## 5. 依存関係

### 関連ファイル

- `src/integrations/github/pr-cleanup.ts:104-271` - `cleanupMergedPullRequest()` 関数
- `src/core/database/helpers.ts:36-82` - `getSpecWithGitHubInfo()` 関数
- `src/core/database/helpers.ts:177-183` - `updateSpecBranchToBaseBranch()` 関数
- `src/core/database/helpers.ts:192-203` - `updatePrMergedStatus()` 関数

### データベーススキーマ

- `specs` テーブル: `branch_name` カラム（NOT NULL 制約）
- `github_sync` テーブル: `entity_id`, `entity_type`, `pr_number`, `pr_url`, `pr_merged_at` カラム

---

## 6. 参考情報

### 問題の詳細分析

#### 問題1: PR存在判定の誤り

**現象**: PR #330が作成済みなのに「PRが作成されていません」と判定される

**原因**: `github_sync` テーブルに PR 情報が記録されていない可能性。`getSpecWithGitHubInfo()` は正しく動作しているが、PR 作成時にデータベースへの記録が失敗している可能性がある。

**修正方針**: PR 作成時の処理（`/cft:spec-phase <spec-id> completed`）を確認し、`github_sync` テーブルへの記録が確実に行われるようにする。

#### 問題2: `branch_name` カラム更新値の誤り

**現象**: PRがdevelopブランチにマージされたのに、`branch_name`を空文字列に更新

**原因**: ログを見ると、Claudeが手動で `UPDATE specs SET branch_name = ''` を実行している。しかし、`updateSpecBranchToBaseBranch()` 関数は正しく `pr.base.ref`（マージ先ブランチ名）を受け取っているため、関数自体は正しく動作している。

**修正方針**: `cleanupMergedPullRequest()` 関数内で `updateSpecBranchToBaseBranch()` が正しく呼び出されていることを確認する（`src/integrations/github/pr-cleanup.ts:233`）。実装は正しいため、問題はログに記録されている手動SQLクエリの実行にある。

**注意**: ログでは、Claude が `sqlite3` コマンドで `UPDATE specs SET branch_name = ''` を実行しているが、これは**誤った手動操作**である。`cleanupMergedPullRequest()` 関数は `updateSpecBranchToBaseBranch(trx, spec.id, baseBranch)` を呼び出しており、`baseBranch` には `pr.base.ref`（develop）が渡されているはずである。

#### 問題3: SQLクエリの誤り

**現象**: 最初のJOINクエリで `g.spec_id` カラムを参照してエラー

**原因**: ログを見ると、Claudeが手動で以下のSQLクエリを実行している:

```sql
SELECT s.id, s.name, s.phase, s.branch_name, g.pr_number, g.pr_url, g.pr_merged_at
FROM specs s
LEFT JOIN github_sync g ON g.spec_id = s.id
```

しかし、`github_sync` テーブルには `spec_id` カラムが存在せず、`entity_id` カラムを使用すべきである。

**修正方針**: `getSpecWithGitHubInfo()` 関数は正しく `entity_id` を使用している（`src/core/database/helpers.ts:44`）。問題はログに記録されている手動SQLクエリの実行にある。

### 根本原因

ログを詳細に確認したところ、以下の根本原因が判明:

1. **PR存在判定の誤り**: `cleanupMergedPullRequest()` 関数は `getSpecWithGitHubInfo()` を呼び出し、`spec.pr_number` が存在しない場合にエラーを返している（`src/integrations/github/pr-cleanup.ts:150-156`）。しかし、ログでは PR #330 が作成済みなのに、`github_sync` テーブルに記録されていないため、`spec.pr_number` が `null` になっている。

2. **手動SQLクエリの誤り**: ログでは、Claudeが手動で `sqlite3` コマンドを実行し、誤ったSQLクエリ（`g.spec_id`）を使用している。これは、`getSpecWithGitHubInfo()` 関数を使用せず、手動でSQLクエリを実行したことが原因である。

3. **branch_name カラム更新値の誤り**: `cleanupMergedPullRequest()` 関数は `updateSpecBranchToBaseBranch(trx, spec.id, baseBranch)` を呼び出しており、`baseBranch` には `pr.base.ref` が渡されている（`src/integrations/github/pr-cleanup.ts:233`）。しかし、最初の PR 存在判定でエラーが発生し、関数が早期リターンしたため、データベース更新処理が実行されていない。その後、Claudeが手動で `UPDATE specs SET branch_name = ''` を実行したことが誤りの原因である。

### 修正が必要な箇所

1. **PR作成時のデータベース記録処理**: `/cft:spec-phase <spec-id> completed` 実行時に、`github_sync` テーブルへの記録が確実に行われるようにする。

2. **PR存在判定のフォールバック処理**: `github_sync` テーブルに PR 情報が記録されていない場合、GitHub API で直接 PR を検索する処理を追加する（ブランチ名から PR を検索）。

3. **エラーメッセージの改善**: PR が作成されていない場合と、データベース記録が不完全な場合を区別し、適切なエラーメッセージを表示する。
