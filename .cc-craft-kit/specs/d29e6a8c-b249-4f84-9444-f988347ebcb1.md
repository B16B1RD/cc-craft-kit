# /cft:status が機能していない

**仕様書 ID:** d29e6a8c-b249-4f84-9444-f988347ebcb1
**フェーズ:** implementation
**作成日時:** 2025/12/05 16:30:00
**更新日時:** 2025/12/05 17:12:00

---

## 1. 背景と目的

### 背景

cc-craft-kit v0.1.5 でデータベース機能（SQLite + Kysely）を完全削除し、JSON ストレージベースに移行した。しかし、`/cft:status` コマンドのプロンプト定義（`src/slash-commands/status.md`）には、削除済みの機能への参照が残っている:

1. **database-schema-validator スキル呼び出し**: DB 整合性チェックステップで呼び出されるが、DB が存在しないため意味不明な出力となる
2. **--verbose オプションの DB 情報表示**: `db/info.ts` を参照するが、該当ファイルは存在しない
3. **仕様書状況の不整合**: specs.json には completed フェーズの仕様書が 0 件だが、実際のファイル（`.cc-craft-kit/specs/*.md`）には 178 件の completed 仕様書が存在する

### 目的

`/cft:status` コマンドを JSON ストレージベースのアーキテクチャに適合させ、正確なプロジェクト状況を表示できるようにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発（SDD）を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:status` 実行時に「Database Schema Validation Report」が表示されない
- [ ] 仕様書状況でファイルベースの正確なフェーズ別集計が表示される
- [ ] completed フェーズの仕様書数が正しく表示される

### 機能要件

- [ ] `status.md` から database-schema-validator スキル呼び出しを削除
- [ ] `status.md` の --verbose オプションを JSON ストレージ対応に修正
- [ ] 仕様書ファイルからフェーズ情報を読み取る仕組みの実装または修正

### 非機能要件

- [ ] 既存の `/cft:status` コマンドの出力フォーマットを維持
- [ ] パフォーマンス: 仕様書が 200 件以上でも 5 秒以内に結果を表示

---

## 4. 制約条件

- データベース（SQLite + Kysely）は使用しない（削除済み）
- JSON ストレージ（`.cc-craft-kit/meta/specs.json`）をメタデータソースとして使用
- 仕様書ファイル（`.cc-craft-kit/specs/*.md`）との整合性を維持

---

## 5. 依存関係

- `src/slash-commands/status.md` - ステータスコマンドのプロンプト定義
- `src/core/storage/` - JSON ストレージモジュール
- `.cc-craft-kit/commands/status/` - CLI 実装
- `src/skills/database-schema-validator/` - 削除対象のスキル参照

---

## 6. 参考情報

- 関連コミット: `02e52a0` - "chore: .cc-craft-kit/ から残存していた database ファイルを削除"
- 関連コミット: `1640412` - "refactor: データベース機能を完全削除し JSON ストレージへ移行"
- JSON ストレージ実装: `src/core/storage/specs-storage.ts`

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
/cft:status コマンド実行フロー

┌─────────────────────────────────────────────────────────────┐
│ status.md（スラッシュコマンド定義）                           │
│                                                             │
│  Step 1: 設定読み込み ─────────────────────────────────────┐ │
│           │                                               │ │
│           ▼                                               │ │
│  Step 2: 仕様書情報取得 ─────────────────────────────────┐│ │
│           │                              Bash ツール      ││ │
│           ▼                                   │          ││ │
│  [削除] Step 3: DB 整合性チェック ←──────────────────────┘│ │
│                                                          │ │
│  Step 4: 品質チェック ───────────────────────────────────┘ │
│           │                                               │
│           ▼                                               │
│  Step 5: 出力整形・表示                                    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ .cc-craft-kit/commands/status/                              │
│                                                             │
│  info.ts ───────────────────────────────────────────────────┤
│    │                                                       │
│    ├─→ getSpecsFromStorage()  ← specs.json                 │
│    ├─→ getLogsFromStorage()   ← logs.jsonl                 │
│    └─→ getGitHubSyncInfo()    ← github-sync.json           │
└─────────────────────────────────────────────────────────────┘
```

#### 設計方針

1. **プロンプトファースト原則の適用**
   - ファイル操作・表示ロジックは `status.md` で実現
   - データ取得のみ CLI スクリプト（`info.ts`）を利用

2. **JSON ストレージへの完全移行**
   - `specs.json` を仕様書メタデータの唯一の情報源として扱う
   - ファイル Front Matter との不整合は許容（表示用のため）

3. **削除対象**
   - `database-schema-validator` スキル呼び出し（Step 3 全体）
   - `db/info.ts` への参照（--verbose オプション内）

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/slash-commands/status.md` | DB 関連処理の削除、--verbose オプション修正 |

#### 詳細変更箇所

1. **Step 3 削除**（行 77-81 付近）
   - `database-schema-validator` スキル呼び出しを完全削除
   - Step 番号を繰り上げ

2. **--verbose オプション修正**（行 235-289 付近）
   - `npx tsx .cc-craft-kit/commands/db/info.ts` を削除
   - JSON ストレージ統計情報に置き換え:
     - `.cc-craft-kit/meta/` 配下のファイルサイズ
     - specs.json のエントリ数
     - logs.jsonl の行数

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| 仕様書フェーズ集計 | specs.json から取得 | 変更なし | info.ts |
| DB 整合性チェック | database-schema-validator スキル | 削除 | status.md |
| --verbose DB 情報 | db/info.ts (存在しない) | JSON ストレージ統計 | status.md |
| 進捗バー表示 | 未実装（一部） | プロンプトでパース | status.md |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| status.md | DB 関連出力がないこと | `/cft:status` 実行、出力確認 |
| status.md | --verbose が動作すること | `/cft:status --verbose` 実行 |
| 仕様書集計 | フェーズ別件数が正確 | specs.json と出力の比較 |

### 7.5 移行計画

#### Phase 1: DB 参照の削除

1. status.md の Step 3（DB 整合性チェック）を削除
2. Step 番号を繰り上げ

#### Phase 2: --verbose オプション修正

1. db/info.ts への参照を削除
2. JSON ストレージ統計情報の表示に置き換え

---

## 8. 実装タスクリスト

### Phase 1: DB 参照の削除

- [x] status.md から database-schema-validator スキル呼び出し（Step 3）を削除 (#889)
- [x] Step 番号の繰り上げ（Step 4 → Step 3、Step 5 → Step 4 等） (#890)

### Phase 2: --verbose オプション修正

- [ ] status.md の --verbose セクションから db/info.ts 参照を削除 (#891)
- [ ] JSON ストレージ統計情報の表示を追加（ファイルサイズ、エントリ数） (#892)

### Phase 3: 動作確認

- [ ] `/cft:status` 実行時に DB 関連出力がないことを確認 (#893)
- [ ] `/cft:status --verbose` が正常動作することを確認 (#894)
- [ ] 同期実行（`npm run sync:dogfood`） (#895)
