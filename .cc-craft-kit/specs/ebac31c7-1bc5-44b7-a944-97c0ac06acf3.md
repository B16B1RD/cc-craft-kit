# 仕様書をどのフェーズからでも破棄（クローズ）できるようにしたい

**仕様書 ID:** ebac31c7-1bc5-44b7-a944-97c0ac06acf3
**フェーズ:** design
**作成日時:** 2025/11/23 13:34:24
**更新日時:** 2025/11/23 13:57:46

---

## 1. 背景と目的

### 背景

現在、`/cft:spec-delete` コマンドは実装済みであり、データベースレコード削除・仕様書ファイル削除・イベント発火は正常に動作している。しかし、以下の問題が存在する：

1. **GitHub Issue クローズ機能が未実装**: `--close-github-issue` オプションは実装されているが、実際のクローズ処理がコメントアウトされている（`src/commands/spec/delete.ts:139-146`）
2. **ユーザビリティの問題**: 仕様書削除時に GitHub Issue を手動でクローズする必要があり、運用が煩雑

### 目的

仕様書削除時に GitHub Issue を自動的にクローズする機能を実装し、仕様書のライフサイクル管理を完全自動化する。これにより、以下を実現する：

- 仕様書削除と GitHub Issue クローズの一貫性を保証
- 手動オペレーションを削減し、開発者の負担を軽減
- どのフェーズからでも安全に仕様書を破棄できる運用を確立

---

## 2. 対象ユーザー

- **開発者**: cc-craft-kit を使用して仕様駆動開発を行う開発者
- **プロジェクトマネージャー**: 仕様書のライフサイクル管理を行う責任者
- **利用シーン**: 仕様書が不要になった際に、GitHub Issue とともに完全に破棄したい場合

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-delete <spec-id> --close-github-issue` を実行すると、GitHub Issue が自動的にクローズされる
- [ ] GitHub Issue クローズ失敗時、エラーメッセージを表示し、削除処理をロールバックする
- [ ] どのフェーズからでも仕様書を削除できる（フェーズ制約なし）

### 機能要件

- [ ] `src/commands/spec/delete.ts:139-146` のコメントアウトされたコードを有効化する
- [ ] `src/integrations/github/issues.ts:147-154` の `close()` メソッドを呼び出す
- [ ] GitHub Issue クローズ後、`github_sync` テーブルの関連レコードを削除する（オプション）
- [ ] GitHub API レート制限エラーに対応する

### 非機能要件

- [ ] GitHub API 呼び出しのタイムアウトは 10 秒以内
- [ ] エラーハンドリングは既存パターン（`handleCLIError()`）に従う
- [ ] 型安全性を保証（TypeScript strict mode）

---

## 4. 制約条件

### 技術的制約

- **GitHub API 認証**: `GITHUB_TOKEN` 環境変数が設定されている必要がある
- **Octokit バージョン**: `@octokit/rest` の `update()` メソッドを使用（既存実装に準拠）
- **データベース**: Kysely の型安全なクエリのみ使用（SQL インジェクション対策）

### 運用制約

- **ロールバック戦略**: GitHub Issue クローズ失敗時、データベース削除・ファイル削除をロールバックする
- **イベント発火**: `spec.deleted` イベントは削除成功時のみ発火する
- **--yes フラグ**: 確認プロンプトをスキップする場合も、GitHub Issue クローズは実行する

---

## 5. 依存関係

### 既存モジュール

- **`src/commands/spec/delete.ts`**: 仕様書削除のメインロジック（修正対象）
- **`src/integrations/github/issues.ts`**: GitHub Issue 操作（`close()` メソッドを使用）
- **`src/core/workflow/event-bus.ts`**: イベント駆動アーキテクチャ（`spec.deleted` イベント）
- **`src/core/database/schema.ts`**: データベーススキーマ定義（`github_sync` テーブル）

### 外部依存

- **GitHub API**: Issue クローズのため、有効な `GITHUB_TOKEN` が必要
- **@octokit/rest**: GitHub API クライアント

---

## 6. 参考情報

### 修正対象コード

- **`src/commands/spec/delete.ts:139-146`**: コメントアウトされた GitHub Issue クローズ処理
  ```typescript
  // if (closeGitHubIssue && githubSync?.github_number) {
  //   logger.info(`Closing GitHub Issue #${githubSync.github_number}...`);
  //   const githubService = await getGitHubService();
  //   await githubService.issues.close(owner, repo, githubSync.github_number);
  //   logger.success(`GitHub Issue #${githubSync.github_number} closed successfully`);
  // }
  ```

### 参考実装

- **`src/integrations/github/issues.ts:147-154`**: GitHub Issue クローズメソッド
- **`src/commands/spec/create.ts:240-288`**: ロールバック処理の実装例
- **`src/core/workflow/phase-transition-validator.ts`**: フェーズ遷移制約（削除には制約なし）

### 関連 Issue

- GitHub Issue #310: 本仕様書に対応する Issue
