# 仕様書をどのフェーズからでも破棄（クローズ）できるようにしたい

**仕様書 ID:** ebac31c7-1bc5-44b7-a944-97c0ac06acf3
**フェーズ:** tasks
**作成日時:** 2025/11/23 13:34:24
**更新日時:** 2025/11/23 14:15:19

---

## 1. 背景と目的

### 背景

現在、`/cft:spec-delete` コマンドは実装済みであり、データベースレコード削除・仕様書ファイル削除・イベント発火は正常に動作している。しかし、以下の問題が存在する：

1. **GitHub Issue クローズ機能が未実装**: `--close-github-issue` オプションは実装されているが、実際のクローズ処理がコメントアウトされている（`src/commands/spec/delete.ts:139-146`）
2. **ユーザビリティの問題**: 仕様書削除時に GitHub Issue を手動でクローズする必要があり、運用が煩雑

### 目的

仕様書削除時に GitHub Issue を自動的にクローズする機能を実装し、仕様書のライフサイクル管理を完全自動化する。これにより、以下を実現する：

- 仕様書削除と GitHub Issue クローズの一貫性を保証
- 手動オペレーションを削減し、開発者の負担を軽減
- どのフェーズからでも安全に仕様書を破棄できる運用を確立

---

## 2. 対象ユーザー

- **開発者**: cc-craft-kit を使用して仕様駆動開発を行う開発者
- **プロジェクトマネージャー**: 仕様書のライフサイクル管理を行う責任者
- **利用シーン**: 仕様書が不要になった際に、GitHub Issue とともに完全に破棄したい場合

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-delete <spec-id> --close-github-issue` を実行すると、GitHub Issue が自動的にクローズされる
- [ ] GitHub Issue クローズ失敗時、エラーメッセージを表示し、削除処理をロールバックする
- [ ] どのフェーズからでも仕様書を削除できる（フェーズ制約なし）

### 機能要件

- [ ] `src/commands/spec/delete.ts:139-146` のコメントアウトされたコードを有効化する
- [ ] `src/integrations/github/issues.ts:147-154` の `close()` メソッドを呼び出す
- [ ] GitHub Issue クローズ後、`github_sync` テーブルの関連レコードを削除する（オプション）
- [ ] GitHub API レート制限エラーに対応する

### 非機能要件

- [ ] GitHub API 呼び出しのタイムアウトは 10 秒以内
- [ ] エラーハンドリングは既存パターン（`handleCLIError()`）に従う
- [ ] 型安全性を保証（TypeScript strict mode）

---

## 4. 制約条件

### 技術的制約

- **GitHub API 認証**: `GITHUB_TOKEN` 環境変数が設定されている必要がある
- **Octokit バージョン**: `@octokit/rest` の `update()` メソッドを使用（既存実装に準拠）
- **データベース**: Kysely の型安全なクエリのみ使用（SQL インジェクション対策）

### 運用制約

- **ロールバック戦略**: GitHub Issue クローズ失敗時、データベース削除・ファイル削除をロールバックする
- **イベント発火**: `spec.deleted` イベントは削除成功時のみ発火する
- **--yes フラグ**: 確認プロンプトをスキップする場合も、GitHub Issue クローズは実行する

---

## 5. 依存関係

### 既存モジュール

- **`src/commands/spec/delete.ts`**: 仕様書削除のメインロジック（修正対象）
- **`src/integrations/github/issues.ts`**: GitHub Issue 操作（`close()` メソッドを使用）
- **`src/core/workflow/event-bus.ts`**: イベント駆動アーキテクチャ（`spec.deleted` イベント）
- **`src/core/database/schema.ts`**: データベーススキーマ定義（`github_sync` テーブル）

### 外部依存

- **GitHub API**: Issue クローズのため、有効な `GITHUB_TOKEN` が必要
- **@octokit/rest**: GitHub API クライアント

---

## 6. 参考情報

### 修正対象コード

- **`src/commands/spec/delete.ts:139-146`**: コメントアウトされた GitHub Issue クローズ処理
  ```typescript
  // if (closeGitHubIssue && githubSync?.github_number) {
  //   logger.info(`Closing GitHub Issue #${githubSync.github_number}...`);
  //   const githubService = await getGitHubService();
  //   await githubService.issues.close(owner, repo, githubSync.github_number);
  //   logger.success(`GitHub Issue #${githubSync.github_number} closed successfully`);
  // }
  ```

### 参考実装

- **`src/integrations/github/issues.ts:147-154`**: GitHub Issue クローズメソッド
- **`src/commands/spec/create.ts:240-288`**: ロールバック処理の実装例
- **`src/core/workflow/phase-transition-validator.ts`**: フェーズ遷移制約（削除には制約なし）

### 関連 Issue

- GitHub Issue #310: 本仕様書に対応する Issue

---

## 7. 設計詳細

### 7.1. アーキテクチャ設計

#### 7.1.1 仕様書破棄（クローズ）の処理フロー

仕様書削除時に GitHub Issue を自動的にクローズする機能を実装します。

```
ユーザー入力: /cft:spec-delete <spec-id> --close-github-issue
         ↓
┌─────────────────────────────────────────┐
│ 1. カスタムスラッシュコマンド (.md)         │
│    - spec-delete.md の自動実行フロー読み込み │
└─────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────┐
│ 2. スクリプト実行                          │
│    - npx tsx .cc-craft-kit/commands/    │
│      spec/delete.ts                     │
│    - 引数検証、確認プロンプト              │
│    - GitHub Issue クローズ処理 (NEW)      │
│    - データベース削除                      │
│    - ファイル削除                          │
│    - イベント発火 (spec.deleted)          │
└─────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────┐
│ 3. コア層                                │
│    - GitHubIssues.close() (issues.ts)   │
│    - Database.delete() (database.ts)    │
│    - EventBus.emit() (event-bus.ts)     │
└─────────────────────────────────────────┘
```

#### 7.1.2 ロールバック戦略

GitHub Issue クローズ失敗時、以下の順序でロールバックを実施します。

```
┌─────────────────────────────────────────┐
│ 通常フロー                                │
│ 1. GitHub Issue クローズ (API 呼び出し)    │
│    ↓ [成功]                              │
│ 2. データベース削除                        │
│    ↓ [成功]                              │
│ 3. ファイル削除                           │
│    ↓ [成功]                              │
│ 4. spec.deleted イベント発火              │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ ロールバックフロー                         │
│ 1. GitHub Issue クローズ                 │
│    ↓ [失敗] → エラーメッセージ表示         │
│    ↓ 削除処理をスキップ                   │
│    ↓ イベント発火なし                     │
│ 終了 (削除キャンセル)                      │
└─────────────────────────────────────────┘
```

**設計上の重要ポイント**:
- GitHub Issue クローズを**最初に実行**（失敗時に状態が変更されない）
- データベース削除・ファイル削除は**Issue クローズ成功後のみ実行**
- イベント発火は**すべて成功後のみ実行**

#### 7.1.3 フェーズ制約なしの設計根拠

調査結果により、`PhaseTransitionValidator` は仕様書削除操作に対する制約を持たないことが確認されています。したがって、以下のフェーズから削除可能です:

- `requirements` (要件定義)
- `design` (設計)
- `tasks` (タスク分解)
- `implementation` (実装)
- `testing` (テスト)
- `completed` (完了)

この設計により、不要になった仕様書をどのタイミングでも破棄可能な運用を実現します。

### 7.2. データモデル

#### 7.2.1 関連テーブル

**specs テーブル**:
```typescript
export interface SpecsTable {
  id: Generated<string>;           // UUID
  name: string;
  description: string | null;
  phase: SpecPhase;
  branch_name: string;
  created_at: ColumnType<Date>;
  updated_at: ColumnType<Date>;
}
```

**github_sync テーブル**:
```typescript
export interface GitHubSyncTable {
  id: Generated<string>;
  entity_type: GitHubEntityType;  // 'spec', 'task', 'issue'
  entity_id: string;               // spec_id or task_id
  github_id: string;               // GitHub Issue ID
  github_number: number | null;    // GitHub Issue 番号 (#xxx)
  github_node_id: string | null;   // GraphQL Node ID
  issue_number: number | null;     // 後方互換性
  issue_url: string | null;
  pr_number: number | null;
  pr_url: string | null;
  last_synced_at: ColumnType<Date>;
  updated_at: ColumnType<Date>;
  sync_status: 'success' | 'failed' | 'pending';
  error_message: string | null;
}
```

#### 7.2.2 データフロー

```
1. spec 削除リクエスト
   ↓
2. github_sync テーブルからレコード取得
   WHERE entity_type = 'spec' AND entity_id = <spec-id>
   ↓
3. GitHub Issue クローズ (Octokit)
   GitHubIssues.close(owner, repo, github_number)
   ↓ [成功]
4. specs テーブルからレコード削除
   DELETE FROM specs WHERE id = <spec-id>
   ↓
5. github_sync テーブルからレコード削除
   DELETE FROM github_sync WHERE entity_id = <spec-id>
   ↓
6. ファイル削除
   rm .cc-craft-kit/specs/<spec-id>.md
```

### 7.3. API の仕様

#### 7.3.1 GitHub Issue クローズ API

**既存実装**: `src/integrations/github/issues.ts:147-154`

```typescript
async close(
  owner: string,
  repo: string,
  issueNumber: number
): Promise<IssueResponse> {
  const response = await this.octokit.issues.update({
    owner,
    repo,
    issue_number: issueNumber,
    state: 'closed',
  });
  return response.data;
}
```

**呼び出し方法**:
```typescript
const githubService = await getGitHubService();
await githubService.issues.close(owner, repo, githubSync.github_number);
```

#### 7.3.2 エラーハンドリング

GitHub API 呼び出し時の主要なエラーパターン:

| エラーコード | 原因 | 対処方法 |
|---|---|---|
| 401 Unauthorized | GITHUB_TOKEN が無効 | エラーメッセージ表示、削除処理スキップ |
| 403 Forbidden | レート制限超過 | エラーメッセージ表示、削除処理スキップ |
| 404 Not Found | Issue が存在しない | 警告表示、削除処理続行（Issue は既に削除済み） |
| 500 Server Error | GitHub API 障害 | エラーメッセージ表示、削除処理スキップ |

### 7.4. セキュリティ考慮事項

#### 7.4.1 認証情報の管理

- **GITHUB_TOKEN**: 環境変数 `.env` で管理
- **トークンチェック**: `process.env.GITHUB_TOKEN` が未設定の場合、エラーメッセージを表示して削除処理をスキップ
- **ログ出力**: トークンをログに出力しない（既存実装に準拠）

#### 7.4.2 SQL インジェクション対策

- Kysely のパラメータ化クエリのみを使用
- ユーザー入力（spec-id）は UUID バリデーション済み（`spec/delete.ts:51-60`）

#### 7.4.3 ファイルシステム操作の安全性

- ファイルパスは絶対パス（`.cc-craft-kit/specs/<spec-id>.md`）のみ許可
- ディレクトリトラバーサル攻撃を防止（既存実装に準拠）

### 7.5. テスト戦略

#### 7.5.1 単体テスト

**テストファイル**: `tests/commands/spec/delete.test.ts`

**テストケース**:
1. `--close-github-issue` 指定時、GitHub Issue が正常にクローズされる
2. GitHub Issue クローズ失敗時、削除処理がロールバックされる
3. GitHub Issue が存在しない場合（404エラー）、警告表示後に削除続行
4. `GITHUB_TOKEN` が未設定の場合、エラーメッセージ表示
5. `--yes` フラグ指定時も、GitHub Issue クローズが実行される

#### 7.5.2 統合テスト

**テストファイル**: `tests/integrations/github/issues.test.ts`

**テストケース**:
1. `GitHubIssues.close()` が Octokit の `update()` を正しく呼び出す
2. GitHub API レート制限エラーに対応する
3. 認証エラー時、適切なエラーメッセージを返す

#### 7.5.3 モック化

- **GitHub API**: `@octokit/rest` の `update()` メソッドをモック化
- **データベース**: `:memory:` モードで実行
- **ファイルシステム**: `fs.promises.unlink()` をモック化

---

## 8. 実装タスクリスト

（このセクションは tasks フェーズに移行時に自動生成されます）
