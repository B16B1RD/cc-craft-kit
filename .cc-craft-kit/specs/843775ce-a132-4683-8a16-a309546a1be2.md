---
id: "843775ce-a132-4683-8a16-a309546a1be2"
name: "タスク完了時に対応する Sub Issue がクローズされない"
phase: "implementation"
branch_name: "fix/spec-843775ce-sub-issue-not-closed-on-completed"
github_issue_number: 936
pr_url: null
created_at: "2025-12-07T02:50:00.000Z"
updated_at: "2025-12-07T03:30:00.000Z"
---

# タスク完了時に対応する Sub Issue がクローズされない

## 1. 背景と目的

### 背景

`/cft:task done` でタスクを完了した際、対応する Sub Issue（タスク Issue）がクローズされない。

本来の動作フロー:
1. タスク完了時（`/cft:task done`）→ 対応する Sub Issue をクローズ
2. 全タスク完了後、completed フェーズ移行時 → 親 Issue をクローズ

実際に発生した事例:

- 仕様書 #905「構成見直し」の実装中、各タスクを完了
- タスク完了時に対応する Sub Issue #912〜#934 がクローズされなかった
- completed フェーズ移行時に親 Issue #905 のみクローズ
- Sub Issue（23 件）がオープンのまま残っていた

### 目的

タスク完了時（`/cft:task done`）に、対応する Sub Issue を自動的にクローズするように修正する。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] タスク完了時に、対応する Sub Issue を特定できる
- [ ] 特定した Sub Issue をクローズする
- [ ] クローズ時に適切なコメントを残す

### 機能要件

- [ ] `/cft:task done` 実行時に対応する Sub Issue を自動クローズ
- [ ] タスクと Sub Issue の対応関係を仕様書内のタスクリストから特定（Issue 番号の記載）

### 非機能要件

- [ ] クローズ処理は並列実行で高速化
- [ ] クローズ失敗時もエラーで処理を中断しない（警告表示のみ）

---

## 4. 制約条件

- `gh` CLI のみで実装（Octokit 不使用）
- 親 Issue と Sub Issue の関連付け方法は現在の実装に依存

---

## 5. 依存関係

- `/cft:task` コマンド（`.claude/commands/cft/task.md`）

---

## 6. 参考情報

- 発生した Issue: #905（親）、#912〜#934（Sub Issue、23 件）

---

## 7. 設計詳細

### 7.1 修正対象ファイル

| ファイル | 修正内容 |
|----------|----------|
| `.claude/commands/cft/task.md` | `done` サブコマンドに Sub Issue クローズ処理を追加 |

### 7.2 現状の問題点

`/cft:task done` コマンドの Step D9 では、引数で渡された Issue 番号のみをクローズしている。
タスク完了時に、対応する仕様書から Sub Issue 番号を特定してクローズするロジックが存在しない。

### 7.3 修正方針

`/cft:task done` の Step D9（Issue クローズ）の前に、以下の処理を追加:

1. **Step D8.5: 仕様書の特定**
   - 引数の Issue 番号から対応する仕様書を特定
   - `.cc-craft-kit/specs/*.md` を検索し、タスクリスト内に該当 Issue 番号を含む仕様書を見つける

2. **Step D8.6: Sub Issue 番号の抽出**
   - 仕様書の「## 8. 実装タスクリスト」セクションから Issue 番号を抽出
   - 完了したタスクに対応する Sub Issue 番号を特定

3. **Step D8.7: Sub Issue のクローズ**
   - `gh issue close <ISSUE_NUMBER>` で Sub Issue をクローズ
   - クローズ失敗時は警告表示のみ（処理を中断しない）

### 7.4 タスクリストの Issue 番号フォーマット

仕様書のタスクリストでは、以下の形式で Issue 番号を記載:

```markdown
- [x] タスク名 (#ISSUE_NUMBER)
- [ ] 別のタスク (#ISSUE_NUMBER)
```

正規表現パターン: `\(#(\d+)\)`

### 7.5 エラーハンドリング

| ケース | 対応 |
|--------|------|
| 仕様書が見つからない | 警告を表示し、通常の Issue クローズのみ実行 |
| タスクリストに Issue 番号がない | 警告を表示し、通常の Issue クローズのみ実行 |
| Sub Issue クローズ失敗 | 警告を表示し、処理を継続 |

---

## 8. 実装タスクリスト

### Phase 1: task.md の修正

- [x] Step D8.5: 仕様書特定ロジックを追加 (#937)
- [x] Step D8.6: タスクリストから Issue 番号抽出ロジックを追加 (#938)
- [x] Step D8.7: Sub Issue クローズ処理を追加 (#939)

### Phase 2: テスト・検証

- [x] 手動テスト: `/cft:task done` でタスク完了時に Sub Issue がクローズされることを確認 (#940)
