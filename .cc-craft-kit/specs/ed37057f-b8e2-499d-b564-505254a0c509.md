# セッション再開時にワークフロー状態が引き継がれない

**仕様書 ID:** ed37057f-b8e2-499d-b564-505254a0c509
**フェーズ:** requirements
**作成日時:** 2025/12/02 22:30:00
**更新日時:** 2025/12/02 22:30:00

---

## 1. 背景と目的

### 背景

cc-craft-kit の `/cft:spec-phase impl` コマンドは、実装フェーズ移行時に以下のワークフローを定義している：

1. タスクリストを読み込み
2. 各タスクについて `task/start.ts` を実行（Sub Issue を In Progress に更新）
3. タスクを実装
4. `task/done.ts` を実行（Sub Issue を Done に更新・クローズ）
5. 次のタスクへ遷移

しかし、Claude Code のセッションがコンテキスト上限に達して再開された場合、このワークフローの「ループ状態」が失われる。再開後のサマリーには「タスク #530 を実行中」という情報は含まれるが、「各タスク完了時に `task/done.ts` を呼ぶ必要がある」という制御フローの情報が伝わらない。

結果として、実装は完了しても Sub Issue が更新されず、GitHub 上の進捗管理が破綻する。

### 発生した問題（実例）

仕様書「旧名称の Takumi が残存している」（#524）の実装時：
- 13 個の Sub Issue（#525-#537）が作成された
- セッション再開後、タスクは正常に実装・完了された
- しかし `task/done.ts` が呼ばれず、全 Sub Issue が OPEN のまま残った
- 手動でクローズする必要があった

### 目的

セッション再開後も、実行中のワークフロー状態を復元し、タスク完了時の処理（Sub Issue 更新等）が確実に実行されるようにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] セッション再開後も、実行中のタスクに関する状態が復元される
- [ ] タスク完了時に `task/done.ts` が確実に呼ばれる（セッション再開後も）
- [ ] Sub Issue のステータスが正しく更新される（In Progress → Done）

### 機能要件

- [ ] 実行中のワークフロー状態がデータベースまたはファイルに永続化される
- [ ] セッション再開時に、前回のワークフロー状態が自動的に復元される
- [ ] 仕様書のタスクリストと Sub Issue の状態が同期される

### 非機能要件

- [ ] 既存のワークフロー（/cft:spec-phase）との後方互換性を維持
- [ ] プロンプトファースト原則に従い、可能な限りプロンプト層で解決

---

## 4. 制約条件

- Claude Code のセッションは任意のタイミングでコンテキスト上限に達する可能性がある
- セッション再開時のサマリーは LLM が生成するため、必ずしも完全な情報が含まれるとは限らない
- 既存の `/cft:spec-phase` コマンドの動作を大きく変更しない

---

## 5. 依存関係

- `.cc-craft-kit/slash-commands/spec-phase.md` - 現在のワークフロー定義
- `src/commands/task/start.ts` - タスク開始処理
- `src/commands/task/done.ts` - タスク完了処理
- `src/core/database/schema.ts` - データベーススキーマ

---

## 6. 参考情報

### 問題の根本原因

1. **状態の永続化不足**: 「現在どのタスクを実行中か」「タスク完了時に何をすべきか」がセッション間で引き継がれない
2. **ワークフローの強制力不足**: プロンプトベースの指示は、コンテキストが切れると失われる

### 考えられる解決アプローチ

#### A案: ワークフロー状態のデータベース永続化

- `workflow_state` テーブルを追加
- 実行中のワークフロー（spec_id, current_task, next_action 等）を記録
- セッション再開時に状態を復元

#### B案: Sub Issue 状態からの自動復元

- セッション再開時に、仕様書のタスクリストと Sub Issue の状態を比較
- 不整合があれば自動修正（例：タスクが完了済みなら Sub Issue をクローズ）

#### C案: タスクチェックボックス更新時の自動フック

- Edit ツールで `- [ ]` → `- [x]` の変更を検出
- 自動的に `task/done.ts` を呼び出す

#### D案: セッション再開用の復元コマンド

- `/cft:session-resume` のようなコマンドを提供
- 前回のセッション状態を読み込み、ワークフローを再開

### 関連する設計思想

cc-craft-kit は「作業記録を残し、セッション再開を自然にできるようにする」ことを目的の一つとしている。GitHub Issue との連携は、この目的を達成するための重要な機能である。

