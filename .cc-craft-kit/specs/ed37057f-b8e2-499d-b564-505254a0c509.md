# セッション再開時にワークフロー状態が引き継がれない

**仕様書 ID:** ed37057f-b8e2-499d-b564-505254a0c509
**フェーズ:** implementation
**作成日時:** 2025/12/02 22:30:00
**更新日時:** 2025/12/03 00:53:00

---

## 1. 背景と目的

### 背景

cc-craft-kit の `/cft:spec-phase impl` コマンドは、実装フェーズ移行時に以下のワークフローを定義している：

1. タスクリストを読み込み
2. 各タスクについて `task/start.ts` を実行（Sub Issue を In Progress に更新）
3. タスクを実装
4. `task/done.ts` を実行（Sub Issue を Done に更新・クローズ）
5. 次のタスクへ遷移

しかし、Claude Code のセッションがコンテキスト上限に達して再開された場合、このワークフローの「ループ状態」が失われる。再開後のサマリーには「タスク #530 を実行中」という情報は含まれるが、「各タスク完了時に `task/done.ts` を呼ぶ必要がある」という制御フローの情報が伝わらない。

結果として、実装は完了しても Sub Issue が更新されず、GitHub 上の進捗管理が破綻する。

### 発生した問題（実例）

仕様書「旧名称の Takumi が残存している」（#524）の実装時：
- 13 個の Sub Issue（#525-#537）が作成された
- セッション再開後、タスクは正常に実装・完了された
- しかし `task/done.ts` が呼ばれず、全 Sub Issue が OPEN のまま残った
- 手動でクローズする必要があった

### 目的

セッション再開後も、実行中のワークフロー状態を復元し、タスク完了時の処理（Sub Issue 更新等）が確実に実行されるようにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] セッション再開後も、実行中のタスクに関する状態が復元される
- [ ] タスク完了時に `task/done.ts` が確実に呼ばれる（セッション再開後も）
- [ ] Sub Issue のステータスが正しく更新される（In Progress → Done）

### 機能要件

- [ ] 実行中のワークフロー状態がデータベースまたはファイルに永続化される
- [ ] セッション再開時に、前回のワークフロー状態が自動的に復元される
- [ ] 仕様書のタスクリストと Sub Issue の状態が同期される

### 非機能要件

- [ ] 既存のワークフロー（/cft:spec-phase）との後方互換性を維持
- [ ] プロンプトファースト原則に従い、可能な限りプロンプト層で解決

---

## 4. 制約条件

- Claude Code のセッションは任意のタイミングでコンテキスト上限に達する可能性がある
- セッション再開時のサマリーは LLM が生成するため、必ずしも完全な情報が含まれるとは限らない
- 既存の `/cft:spec-phase` コマンドの動作を大きく変更しない

---

## 5. 依存関係

- `.cc-craft-kit/slash-commands/spec-phase.md` - 現在のワークフロー定義
- `src/commands/task/start.ts` - タスク開始処理
- `src/commands/task/done.ts` - タスク完了処理
- `src/core/database/schema.ts` - データベーススキーマ

---

## 6. 参考情報

### 問題の根本原因

1. **状態の永続化不足**: 「現在どのタスクを実行中か」「タスク完了時に何をすべきか」がセッション間で引き継がれない
2. **ワークフローの強制力不足**: プロンプトベースの指示は、コンテキストが切れると失われる

### Claude Code フック機能の調査結果

Claude Code には、この問題を解決するための**セッション管理フック**が用意されている。

#### 利用可能なフック一覧（全10種類）

| カテゴリ | フック名 | 発火タイミング |
|---|---|---|
| **セッション管理** | `SessionStart` | セッション開始時 **または再開時** |
| | `SessionEnd` | セッション終了時 |
| **コンテキスト** | `PreCompact` | コンテキスト圧縮実行前 |
| ツール実行 | `PreToolUse` | ツール呼び出し前 |
| | `PostToolUse` | ツール実行完了後 |
| | `PermissionRequest` | 権限ダイアログ表示時 |
| ユーザー操作 | `UserPromptSubmit` | プロンプト送信前 |
| | `Notification` | 通知送信時 |
| 実行フロー | `Stop` | メインエージェント応答完了時 |
| | `SubagentStop` | サブエージェント完了時 |

#### 重要なフックの詳細

**SessionStart** - セッション開始/再開時に発火

以下のマッチャーで起動源を識別可能：
- `startup` - 初期起動時
- `resume` - `--resume`、`--continue`、または `/resume` から再開
- `clear` - `/clear` コマンドから実行
- `compact` - **自動または手動圧縮後の再開**

**PreCompact** - コンテキスト圧縮実行直前に発火

コンテキストウィンドウが満杯になり、自動圧縮が実行される際に発火。フルコンテキスト状態でカスタム処理を実装可能。

**SessionEnd** - セッション終了時に発火

終了理由は以下で識別：
- `clear` - `/clear` コマンドで終了
- `logout` - ログアウト
- `prompt_input_exit` - プロンプト入力で終了
- `other` - その他の理由

#### フック設定例

```json
{
  "hooks": {
    "PreCompact": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "npx tsx .cc-craft-kit/hooks/pre-compact.ts"
          }
        ]
      }
    ],
    "SessionStart": [
      {
        "matcher": "compact|resume",
        "hooks": [
          {
            "type": "command",
            "command": "npx tsx .cc-craft-kit/hooks/session-resume.ts"
          }
        ]
      }
    ]
  }
}
```

### 考えられる解決アプローチ

#### A案: ワークフロー状態のデータベース永続化

- `workflow_state` テーブルを追加
- 実行中のワークフロー（spec_id, current_task, next_action 等）を記録
- セッション再開時に状態を復元

#### B案: Sub Issue 状態からの自動復元

- セッション再開時に、仕様書のタスクリストと Sub Issue の状態を比較
- 不整合があれば自動修正（例：タスクが完了済みなら Sub Issue をクローズ）

#### C案: タスクチェックボックス更新時の自動フック

- Edit ツールで `- [ ]` → `- [x]` の変更を検出
- 自動的に `task/done.ts` を呼び出す

#### D案: セッション再開用の復元コマンド

- `/cft:session-resume` のようなコマンドを提供
- 前回のセッション状態を読み込み、ワークフローを再開

#### E案: Claude Code フック活用（推奨）

**フック機能を活用した自動復元アプローチ**

1. **`PreCompact` または `SessionEnd`** でワークフロー状態を永続化
   - 現在実行中の仕様書 ID
   - 現在のタスク番号
   - 次に実行すべきアクション（`task/done.ts` 等）

2. **`SessionStart (compact|resume)`** で状態を復元
   - 永続化された状態を読み込み
   - CLAUDE.md またはプロンプトに復元情報を注入
   - ワークフローを自動的に再開

**メリット:**
- プロンプトファースト原則に適合
- スクリプトは最小限（状態の保存/復元のみ）
- ユーザー操作なしで自動復元
- 既存のワークフローを変更せずに追加実装可能

### 関連する設計思想

cc-craft-kit は「作業記録を残し、セッション再開を自然にできるようにする」ことを目的の一つとしている。GitHub Issue との連携は、この目的を達成するための重要な機能である。

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
┌─────────────────────────────────────────────────────────────────┐
│                    Claude Code セッション                        │
├─────────────────────────────────────────────────────────────────┤
│  PreCompact フック        SessionStart フック                    │
│  (コンテキスト圧縮前)      (セッション再開時)                       │
│         │                        │                              │
│         ▼                        ▼                              │
│  ┌─────────────┐          ┌─────────────┐                       │
│  │ save-state  │          │restore-state│                       │
│  │    .ts      │          │    .ts      │                       │
│  └──────┬──────┘          └──────┬──────┘                       │
│         │                        │                              │
└─────────┼────────────────────────┼──────────────────────────────┘
          │                        │
          ▼                        ▼
    ┌───────────────────────────────────────┐
    │         workflow_state テーブル        │
    │  ・spec_id                            │
    │  ・current_task_number                │
    │  ・current_task_title                 │
    │  ・next_action                        │
    │  ・github_issue_number                │
    └───────────────────────────────────────┘
```

#### 設計方針

**採用アプローチ: E案（Claude Code フック活用）+ 既存セッション管理との統合**

1. **最小限の DB スキーマ拡張**: `workflow_state` テーブルを追加し、実行中のワークフロー状態のみを保持
2. **フック駆動**: Claude Code の `PreCompact` / `SessionStart` フックを活用し、ユーザー操作なしで自動的に状態を保存・復元
3. **既存セッション管理との統合**: `/cft:session-start` / `/cft:session-end` コマンドとの連携により、フックと手動操作の両方をサポート
4. **プロンプトファースト**: 復元された状態をプロンプトに注入し、Claude Code が適切なアクションを実行

#### 処理フロー詳細

**セッション終了/圧縮時の状態保存フロー:**

```
1. PreCompact フック発火
   ↓
2. save-state.ts 実行
   ↓
3. 現在のセッション状態を解析
   - 実行中の仕様書 ID を特定
   - 実行中のタスク番号を特定
   - 次に実行すべきアクションを判定
   ↓
4. workflow_state テーブルに UPSERT
   ↓
5. 標準出力に保存完了メッセージ
```

**セッション再開時の状態復元フロー:**

```
1. SessionStart フック発火 (matcher: "compact|resume")
   ↓
2. restore-state.ts 実行
   ↓
3. workflow_state テーブルから最新の状態を取得
   ↓
4. 状態が存在する場合:
   - 復元情報を標準出力に出力
   - Claude Code がプロンプトとして受け取り
   - 適切なアクションを自動実行
   ↓
5. 状態が存在しない場合:
   - 何も出力せず終了
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/core/database/schema.ts` | `workflow_state` テーブルの型定義を追加 |
| `src/core/database/migrations/` | `workflow_state` テーブル作成マイグレーション追加 |
| `src/commands/workflow/save-state.ts` | **新規**: ワークフロー状態保存コマンド |
| `src/commands/workflow/restore-state.ts` | **新規**: ワークフロー状態復元コマンド |
| `.cc-craft-kit/hooks/pre-compact.ts` | **新規**: PreCompact フック処理 |
| `.cc-craft-kit/hooks/session-resume.ts` | **新規**: SessionStart フック処理 |
| `.claude/settings.json` | フック設定を追加 |
| `.cc-craft-kit/slash-commands/session-start.md` | ワークフロー状態復元処理を追加 |
| `.cc-craft-kit/slash-commands/session-end.md` | ワークフロー状態保存処理を追加 |

#### workflow_state テーブル設計

```typescript
export interface WorkflowStateTable {
  id: Generated<string>;            // UUID
  spec_id: string;                  // 仕様書 ID（ユニーク制約）
  current_task_number: number;      // 実行中のタスク番号（1-based）
  current_task_title: string;       // タスクのタイトル
  next_action: string;              // 'task_start' | 'task_done' | 'none'
  github_issue_number: number | null; // 現在の Sub Issue 番号
  saved_at: ColumnType<Date, string | undefined, string>;
  updated_at: ColumnType<Date, string | undefined, string>;
}
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| ワークフロー状態永続化 | なし（セッション内のみ） | DB に保存 | `save-state.ts` |
| ワークフロー状態復元 | なし | DB から読み込み + プロンプト注入 | `restore-state.ts` |
| 自動保存トリガー | なし | PreCompact フック | `pre-compact.ts` |
| 自動復元トリガー | なし | SessionStart フック | `session-resume.ts` |
| 手動保存 | なし | `/cft:session-end` 内で呼び出し | `session-end.md` |
| 手動復元 | なし | `/cft:session-start` 内で呼び出し | `session-start.md` |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| `save-state.ts` | ワークフロー状態の正常保存 | Jest 単体テスト |
| `save-state.ts` | 既存レコードの UPSERT | Jest 単体テスト |
| `restore-state.ts` | 状態復元・出力形式 | Jest 単体テスト |
| `restore-state.ts` | 状態が存在しない場合の挙動 | Jest 単体テスト |
| フック連携 | PreCompact → save-state 実行 | 手動テスト（Claude Code 実行） |
| フック連携 | SessionStart → restore-state 実行 | 手動テスト（Claude Code 実行） |
| E2E | セッション終了 → 再開 → 状態復元 | 手動テスト |

### 7.5 移行計画

#### Phase 1: DB スキーマ拡張

1. `workflow_state` テーブルの型定義追加（schema.ts）
2. マイグレーションファイル作成
3. マイグレーション実行

#### Phase 2: コアコマンド実装

1. `save-state.ts` 実装
2. `restore-state.ts` 実装
3. 単体テスト作成・実行

#### Phase 3: フック実装

1. `pre-compact.ts` 実装
2. `session-resume.ts` 実装
3. `.claude/settings.json` にフック設定追加
4. フック連携テスト

#### Phase 4: 既存コマンド統合

1. `session-start.md` に復元処理追加
2. `session-end.md` に保存処理追加
3. E2E テスト

---

## 8. 実装タスクリスト

### Phase 1: DB スキーマ拡張

- [ ] schema.ts に WorkflowStateTable 型定義を追加 (#541)
- [ ] workflow_state テーブル作成マイグレーションを追加 (#542)
- [ ] マイグレーションを実行してテーブル作成 (#543)

### Phase 2: コアコマンド実装

- [ ] src/commands/workflow/save-state.ts を実装 (#544)
- [ ] src/commands/workflow/restore-state.ts を実装 (#545)
- [ ] save-state.ts の単体テストを作成 (#546)
- [ ] restore-state.ts の単体テストを作成 (#547)

### Phase 3: フック実装

- [ ] .cc-craft-kit/hooks/pre-compact.ts を実装 (#548)
- [ ] .cc-craft-kit/hooks/session-resume.ts を実装 (#549)
- [ ] .claude/settings.json にフック設定を追加 (#550)

### Phase 4: 既存コマンド統合

- [ ] session-start.md にワークフロー状態復元処理を追加 (#551)
- [ ] session-end.md にワークフロー状態保存処理を追加 (#552)
- [ ] E2E テストを実行して動作確認 (#553)

