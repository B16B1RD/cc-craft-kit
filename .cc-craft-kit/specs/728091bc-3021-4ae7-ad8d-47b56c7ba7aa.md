# completed フェーズにおいて PR の作成に失敗する

**仕様書 ID:** 728091bc-3021-4ae7-ad8d-47b56c7ba7aa
**フェーズ:** requirements
**作成日時:** 2025/11/24 21:04:52
**更新日時:** 2025/11/24 21:04:52

---

## 1. 背景と目的

### 背景

以下に会話ログを示す。プロンプトによる指示だと問題なく PR が作成できる。プロンプトファースト原則に従って実装しなおしてほしい。
> /cft:spec-phase is running… 79695221 comp 

● フェーズを completed に移行します。

● Bash(npx tsx .cc-craft-kit/commands/spec/phase.ts "79695221" "comp")
  ⎿  # Updating Spec Phase                        

     Spec ID: 79695221-d46e-48a5-8ef6-1b30a5c38b3c
     … +106 lines (ctrl+o to expand)

● フェーズ移行が成功しましたが、PR
  作成時にエラーが発生しました。ブランチがリモートにプッシュされていない可能性があります。Git
  状態を確認します。

● Bash(git status --porcelain)
  ⎿  (No content)

● Bash(git status)
  ⎿  ブランチ feature/spec-79695221-create-branch-from-base-branch
     nothing to commit, working tree clean

● ブランチはクリーンです。ブランチがリモートにプッシュされているか確認します。

● Bash(git branch -vv)
  ⎿   develop                                              2d96d3e [origin/develop] Merge pull request #348 fr
    om B16B1RD/feature/spec-eba108ca-ensure-commit-on-phase-completion
      feature/spec-3f31f622-fix-invalid-phase-guidance     20f67db docs:
    仕様書を自動完成（背景・目的・受け入れ基準・制約条件・依存関係・参考情報）
    … +4 lines (ctrl+o to expand)


● ブランチがリモートにプッシュされていません。リモートにプッシュします。

● Bash(git push -u origin feature/spec-79695221-create-branch-from-base-branch)
  ⎿ branch 'feature/spec-79695221-create-branch-from-base-branch' set up to track 'origin/feature/spec-7969522
    1-create-branch-from-base-branch'.
    remote:
    … +8 lines (ctrl+o to expand)


● ブランチがリモートにプッシュされました。未コミットファイルを確認します。

● Bash(git status --porcelain)
  ⎿  (No content)

● すべての変更がコミット済みです。

  フェーズ移行が正常に完了し、すべての変更が自動コミットされました。

  次のステップ:
  - GitHub Issue を更新: /cft:spec-update 79695221
  - 仕様書の詳細確認: /cft:spec-get 79695221
  - PR を手動で作成:
  https://github.com/B16B1RD/cc-craft-kit/pull/new/feature/spec-79695221-create-branch-from-base-branch

  ---
  実装完了

  仕様書ID: 79695221-d46e-48a5-8ef6-1b30a5c38b3c
  仕様書名: /cft:spec-create でブランチを作成する際、カレントブランチから作成される
  フェーズ: implementation → completed
  ブランチ: feature/spec-79695221-create-branch-from-base-branch

  実装内容

  1. ログ追加（ブランチ作成処理）

  - ブランチ作成前に「Creating branch from BASE_BRANCH (develop)...」を表示
  - ブランチ作成後に「Created branch:  (from develop)」を表示
  - src/core/git/branch-creation.ts:131, 155

  2. テストの追加

  - ログ出力検証テストを追加（3つのテストケース）
  - tests/core/git/branch-creation.test.ts:421-470
  - すべてのテスト（25/25）がパス

  3. ドキュメント更新

  - README.md: ブランチ作成の動作説明を追加
  - docs/QUICK_START.md: BASE_BRANCH 環境変数の説明を追加

  品質チェック結果

  - TypeScript 型チェック: エラーなし
  - ESLint: 警告・エラーなし
  - 単体テスト: 25/25 パス
  - コードレビュー評価: 8.5/10

  GitHub Issue

  - Issue #345: 自動的にクローズされました

  次のアクション

  1. PR を作成: 上記リンクから PR を作成してください
  2. develop にマージ: PR をレビュー後、develop にマージしてください

  実装が正常に完了しました。
> PR を作成してください 

● PRを作成します。

● Bash(git log develop..HEAD --oneline)
  ⎿  3a99fdc feat: /cft:spec-create でブランチを作成する際、カレントブランチから作成される を実装完了        
     d318005 feat: /cft:spec-create でブランチを作成する際、カレントブランチから作成される の実装を開始
     1ede289 feat: /cft:spec-create でブランチを作成する際、カレントブランチから作成される のタスク分解を完了
     … +3 lines (ctrl+o to expand)

● Bash(git diff develop...HEAD --stat)
  ⎿   .cc-craft-kit/commands/spec/create.ts              |   2 -                    
      .../specs/79695221-d46e-48a5-8ef6-1b30a5c38b3c.md  | 445 +++++++++++++++++++++
      README.md                                          |  14 +
     … +5 lines (ctrl+o to expand)

● 変更内容を確認しました。PRを作成します。

● Bash(gh pr create --title "feat: ブランチ作成時に BASE_BRANCH からの派生を明示するログを追加" --body "##
      Summary…)
  ⎿  https://github.com/B16B1RD/cc-craft-kit/pull/349

● PRが正常に作成されました\!

  PR作成完了

  PR #349: https://github.com/B16B1RD/cc-craft-kit/pull/349

  PR概要

  タイトル: feat: ブランチ作成時に BASE_BRANCH からの派生を明示するログを追加

  主な変更内容:

  1. ログ追加: ブランチ作成処理にログを追加し、BASE_BRANCH からの派生を明示
  2. テスト追加: ログ出力検証テストを3つ追加（25/25テストがパス）
  3. ドキュメント更新: README.md と QUICK_START.md にブランチ作成の動作説明を追加

  統計:
  - 変更ファイル数: 7ファイル
  - 削除行数: 4行

  品質チェック:
  - TypeScript 型チェック: ✓ エラーなし
  - ESLint: ✓ 警告・エラーなし
  - 単体テスト: ✓ 25/25 パス
  - コードレビュー評価: 8.5/10

  次のステップ

  1. PRのレビューを待つ
  2. CI/CDチェックの結果を確認
  3. レビュー承認後、develop ブランチにマージ

  実装が正常に完了し、PRが作成されました。

### 目的

`/cft:spec-phase` コマンドで仕様書を completed フェーズに移行する際、PR 作成をプロンプトファースト原則に従って実装し直すことで、以下を実現する:

1. **PR 作成処理の透明性向上**: ユーザーが「何が自動的に実行されているか」を理解しやすくする
2. **エラーハンドリングの強化**: PR 作成失敗時の対応策を明確にする
3. **保守性の向上**: GitHub CLI (`gh`) を活用し、Octokit API の複雑性を削減する
4. **デバッグ性の向上**: プロンプト側で明示的な自動実行フローを記述することで、トラブルシューティングを容易にする

---

## 2. 対象ユーザー

- **cc-craft-kit を使用する開発者**: 仕様駆動開発（SDD）を実践する開発者
- **PR 作成を自動化したい開発者**: completed フェーズ移行時に自動的に PR を作成して、手動作業を削減したい開発者
- **プロンプトファースト原則に従って開発する開発者**: スクリプトの複雑性を減らし、保守性を重視する開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] completed フェーズ移行時に PR 作成が自動的に実行される
- [ ] ブランチがリモートにプッシュされていない場合、自動的にプッシュされる
- [ ] PR 作成成功時、PR URL がユーザーに表示される
- [ ] PR 作成失敗時、失敗理由とトラブルシューティング情報が表示される

### 機能要件

- [ ] `spec-phase.md` に completed フェーズ移行時の自動 PR 作成フローが記述されている
- [ ] PR 本文は仕様書から受け入れ基準を抽出して自動生成される
- [ ] GitHub CLI (`gh pr create`) を使用して PR を作成する
- [ ] ブランチがリモートにプッシュされているか確認し、プッシュされていない場合は `git push -u origin <branch>` を実行する
- [ ] 未コミットファイルが存在する場合、警告メッセージを表示する

### 非機能要件

- [ ] プロンプトファースト原則に従い、PR 作成処理はプロンプト側（`spec-phase.md`）で実装される
- [ ] スクリプト側（`src/commands/spec/phase.ts`、`src/core/workflow/branch-management.ts`）から PR 作成ロジックが削除される
- [ ] エラーハンドリングが明確で、ユーザーが失敗理由を理解しやすい
- [ ] 既存のテストケースがすべてパスする（リグレッションテストを含む）

---

## 4. 制約条件

### 技術的制約

- **TypeScript strict mode**: 型安全性を厳格に維持する
- **Kysely パラメータ化クエリ**: SQL インジェクション対策
- **GitHub CLI (`gh`) の使用**: GitHub API (Octokit) の代わりに GitHub CLI を活用
- **環境変数 `GITHUB_TOKEN`**: GitHub CLI が自動認証するための環境変数が設定されている必要がある

### アーキテクチャ制約

- **プロンプトファースト原則**: PR 作成はプロンプト側（`spec-phase.md`）で実装
- **3層アーキテクチャ**: コマンド層（スラッシュコマンド）、ドメイン層（スクリプト）、インフラ層（データベース、GitHub API）の役割分離
- **イベント駆動アーキテクチャ**: `spec.phase_changed` イベントの活用（ただし PR 作成はイベントハンドラーから削除）

### Git 操作制約

- **ブランチがリモートにプッシュされていること**: PR 作成前に `git push -u origin <branch>` を実行
- **未コミットファイルがないこと**: PR 作成前に仕様書以外の未コミットファイルがある場合は警告を表示

### 後方互換性制約

- **既存のテストケースの互換性**: スクリプト側から PR 作成ロジックを削除しても、既存のテストケースはすべてパスする必要がある
- **データベーススキーマの互換性**: `github_sync` テーブルのスキーマは変更しない

---

## 5. 依存関係

### 依存するコンポーネント

- **`src/slash-commands/spec-phase.md`**: completed フェーズ移行時の自動実行フローを記述
- **`src/commands/spec/phase.ts`**: フェーズ更新スクリプト（PR 作成ロジックを削除する対象）
- **`src/core/workflow/branch-management.ts`**: ブランチ管理（PR 作成ロジックを削除する対象）
- **`src/integrations/github/pull-request.ts`**: PR 作成の詳細実装（削除またはリファクタリング対象）

### 依存する外部ツール

- **GitHub CLI (`gh`)**: PR 作成に使用
- **Git**: ブランチのリモートプッシュ
- **Bash**: コマンド実行環境

### 関連する仕様書

- **79695221-d46e-48a5-8ef6-1b30a5c38b3c**: `/cft:spec-create` でブランチを作成する際、カレントブランチから作成される問題（会話ログの元となった仕様書）
- **eba108ca**: 各フェーズ完了時に未コミットのものがあれば自動コミットする（フェーズ移行時の自動コミット処理）

### データベーステーブル

- **`specs`**: 仕様書の基本情報
- **`github_sync`**: GitHub Issue/PR との同期情報

---

## 6. 参考情報

### ドキュメント

- **CLAUDE.md**: プロンプトファースト原則（144-188 行）、実装パターンマトリクス（209-225 行）
- **CLAUDE.md**: スクリプトとプロンプトの使い分け指針（124-141 行）
- **CLAUDE.md**: 実装前のチェックポイント（305-327 行）

### 参考実装

- **`src/slash-commands/spec-create.md`**: 複雑な自動実行フロー（フェーズ 0〜5）（103-188 行）
- **`src/slash-commands/github-issue-create.md`**: シンプルなスクリプト + プロンプト連携
- **`src/slash-commands/pr-cleanup.md`**: エラーハンドリングと警告表示の参考実装

### 技術資料

- GitHub CLI ドキュメント: https://cli.github.com/manual/gh_pr_create
- Octokit REST API: https://octokit.github.io/rest.js/v18 (削減対象)

### 会話ログ

ユーザーが提供した会話ログから、以下の知見を得られる:

1. **問題の現象**: completed フェーズ移行時、PR 作成が失敗する
2. **失敗理由**: ブランチがリモートにプッシュされていない
3. **プロンプト指示の成功例**: ユーザーが手動で「PR を作成してください」と指示すると、プロンプトベースで正常に PR が作成される
4. **改善方針**: プロンプトファースト原則に従って実装し直す
