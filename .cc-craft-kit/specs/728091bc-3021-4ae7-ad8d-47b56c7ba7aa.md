# completed フェーズにおいて PR の作成に失敗する

**仕様書 ID:** 728091bc-3021-4ae7-ad8d-47b56c7ba7aa
**フェーズ:** implementation
**作成日時:** 2025/11/24 21:04:52
**更新日時:** 2025/11/24 21:22:36

---

## 1. 背景と目的

### 背景

以下に会話ログを示す。プロンプトによる指示だと問題なく PR が作成できる。プロンプトファースト原則に従って実装しなおしてほしい。
> /cft:spec-phase is running… 79695221 comp 

● フェーズを completed に移行します。

● Bash(npx tsx .cc-craft-kit/commands/spec/phase.ts "79695221" "comp")
  ⎿  # Updating Spec Phase                        

     Spec ID: 79695221-d46e-48a5-8ef6-1b30a5c38b3c
     … +106 lines (ctrl+o to expand)

● フェーズ移行が成功しましたが、PR
  作成時にエラーが発生しました。ブランチがリモートにプッシュされていない可能性があります。Git
  状態を確認します。

● Bash(git status --porcelain)
  ⎿  (No content)

● Bash(git status)
  ⎿  ブランチ feature/spec-79695221-create-branch-from-base-branch
     nothing to commit, working tree clean

● ブランチはクリーンです。ブランチがリモートにプッシュされているか確認します。

● Bash(git branch -vv)
  ⎿   develop                                              2d96d3e [origin/develop] Merge pull request #348 fr
    om B16B1RD/feature/spec-eba108ca-ensure-commit-on-phase-completion
      feature/spec-3f31f622-fix-invalid-phase-guidance     20f67db docs:
    仕様書を自動完成（背景・目的・受け入れ基準・制約条件・依存関係・参考情報）
    … +4 lines (ctrl+o to expand)


● ブランチがリモートにプッシュされていません。リモートにプッシュします。

● Bash(git push -u origin feature/spec-79695221-create-branch-from-base-branch)
  ⎿ branch 'feature/spec-79695221-create-branch-from-base-branch' set up to track 'origin/feature/spec-7969522
    1-create-branch-from-base-branch'.
    remote:
    … +8 lines (ctrl+o to expand)


● ブランチがリモートにプッシュされました。未コミットファイルを確認します。

● Bash(git status --porcelain)
  ⎿  (No content)

● すべての変更がコミット済みです。

  フェーズ移行が正常に完了し、すべての変更が自動コミットされました。

  次のステップ:
  - GitHub Issue を更新: /cft:spec-update 79695221
  - 仕様書の詳細確認: /cft:spec-get 79695221
  - PR を手動で作成:
  https://github.com/B16B1RD/cc-craft-kit/pull/new/feature/spec-79695221-create-branch-from-base-branch

  ---
  実装完了

  仕様書ID: 79695221-d46e-48a5-8ef6-1b30a5c38b3c
  仕様書名: /cft:spec-create でブランチを作成する際、カレントブランチから作成される
  フェーズ: implementation → completed
  ブランチ: feature/spec-79695221-create-branch-from-base-branch

  実装内容

  1. ログ追加（ブランチ作成処理）

  - ブランチ作成前に「Creating branch from BASE_BRANCH (develop)...」を表示
  - ブランチ作成後に「Created branch:  (from develop)」を表示
  - src/core/git/branch-creation.ts:131, 155

  2. テストの追加

  - ログ出力検証テストを追加（3つのテストケース）
  - tests/core/git/branch-creation.test.ts:421-470
  - すべてのテスト（25/25）がパス

  3. ドキュメント更新

  - README.md: ブランチ作成の動作説明を追加
  - docs/QUICK_START.md: BASE_BRANCH 環境変数の説明を追加

  品質チェック結果

  - TypeScript 型チェック: エラーなし
  - ESLint: 警告・エラーなし
  - 単体テスト: 25/25 パス
  - コードレビュー評価: 8.5/10

  GitHub Issue

  - Issue #345: 自動的にクローズされました

  次のアクション

  1. PR を作成: 上記リンクから PR を作成してください
  2. develop にマージ: PR をレビュー後、develop にマージしてください

  実装が正常に完了しました。
> PR を作成してください 

● PRを作成します。

● Bash(git log develop..HEAD --oneline)
  ⎿  3a99fdc feat: /cft:spec-create でブランチを作成する際、カレントブランチから作成される を実装完了        
     d318005 feat: /cft:spec-create でブランチを作成する際、カレントブランチから作成される の実装を開始
     1ede289 feat: /cft:spec-create でブランチを作成する際、カレントブランチから作成される のタスク分解を完了
     … +3 lines (ctrl+o to expand)

● Bash(git diff develop...HEAD --stat)
  ⎿   .cc-craft-kit/commands/spec/create.ts              |   2 -                    
      .../specs/79695221-d46e-48a5-8ef6-1b30a5c38b3c.md  | 445 +++++++++++++++++++++
      README.md                                          |  14 +
     … +5 lines (ctrl+o to expand)

● 変更内容を確認しました。PRを作成します。

● Bash(gh pr create --title "feat: ブランチ作成時に BASE_BRANCH からの派生を明示するログを追加" --body "##
      Summary…)
  ⎿  https://github.com/B16B1RD/cc-craft-kit/pull/349

● PRが正常に作成されました\!

  PR作成完了

  PR #349: https://github.com/B16B1RD/cc-craft-kit/pull/349

  PR概要

  タイトル: feat: ブランチ作成時に BASE_BRANCH からの派生を明示するログを追加

  主な変更内容:

  1. ログ追加: ブランチ作成処理にログを追加し、BASE_BRANCH からの派生を明示
  2. テスト追加: ログ出力検証テストを3つ追加（25/25テストがパス）
  3. ドキュメント更新: README.md と QUICK_START.md にブランチ作成の動作説明を追加

  統計:
  - 変更ファイル数: 7ファイル
  - 削除行数: 4行

  品質チェック:
  - TypeScript 型チェック: ✓ エラーなし
  - ESLint: ✓ 警告・エラーなし
  - 単体テスト: ✓ 25/25 パス
  - コードレビュー評価: 8.5/10

  次のステップ

  1. PRのレビューを待つ
  2. CI/CDチェックの結果を確認
  3. レビュー承認後、develop ブランチにマージ

  実装が正常に完了し、PRが作成されました。

### 目的

`/cft:spec-phase` コマンドで仕様書を completed フェーズに移行する際、PR 作成をプロンプトファースト原則に従って実装し直すことで、以下を実現する:

1. **PR 作成処理の透明性向上**: ユーザーが「何が自動的に実行されているか」を理解しやすくする
2. **エラーハンドリングの強化**: PR 作成失敗時の対応策を明確にする
3. **保守性の向上**: 既存のイベント駆動アーキテクチャを活用し、エラーメッセージを改善する
4. **デバッグ性の向上**: プロンプト側で明示的な自動実行フローを記述することで、トラブルシューティングを容易にする

---

## 2. 対象ユーザー

- **cc-craft-kit を使用する開発者**: 仕様駆動開発（SDD）を実践する開発者
- **PR 作成を自動化したい開発者**: completed フェーズ移行時に自動的に PR を作成して、手動作業を削減したい開発者
- **プロンプトファースト原則に従って開発する開発者**: スクリプトの複雑性を減らし、保守性を重視する開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] completed フェーズ移行時に PR 作成が自動的に実行される
- [ ] ブランチがリモートにプッシュされていない場合、自動的にプッシュされる
- [ ] PR 作成成功時、PR URL がユーザーに表示される
- [ ] PR 作成失敗時、失敗理由とトラブルシューティング情報が表示される

### 機能要件

- [ ] `spec-phase.md` に completed フェーズ移行時の自動 PR 作成フローが記述されている
- [ ] PR 本文は仕様書から受け入れ基準を抽出して自動生成される
- [ ] GitHub CLI (`gh pr create`) を使用して PR を作成する
- [ ] ブランチがリモートにプッシュされているか確認し、プッシュされていない場合は `git push -u origin <branch>` を実行する
- [ ] 未コミットファイルが存在する場合、警告メッセージを表示する

### 非機能要件

- [ ] プロンプトファースト原則に従い、PR 作成処理はプロンプト側（`spec-phase.md`）で実装される
- [ ] スクリプト側（`src/commands/spec/phase.ts`、`src/core/workflow/branch-management.ts`）から PR 作成ロジックが削除される
- [ ] エラーハンドリングが明確で、ユーザーが失敗理由を理解しやすい
- [ ] 既存のテストケースがすべてパスする（リグレッションテストを含む）

---

## 4. 制約条件

### 技術的制約

- **TypeScript strict mode**: 型安全性を厳格に維持する
- **Kysely パラメータ化クエリ**: SQL インジェクション対策
- **GitHub CLI (`gh`) の使用**: GitHub API (Octokit) の代わりに GitHub CLI を活用
- **環境変数 `GITHUB_TOKEN`**: GitHub CLI が自動認証するための環境変数が設定されている必要がある

### アーキテクチャ制約

- **プロンプトファースト原則**: PR 作成はプロンプト側（`spec-phase.md`）で実装
- **3層アーキテクチャ**: コマンド層（スラッシュコマンド）、ドメイン層（スクリプト）、インフラ層（データベース、GitHub API）の役割分離
- **イベント駆動アーキテクチャ**: `spec.phase_changed` イベントの活用（ただし PR 作成はイベントハンドラーから削除）

### Git 操作制約

- **ブランチがリモートにプッシュされていること**: PR 作成前に `git push -u origin <branch>` を実行
- **未コミットファイルがないこと**: PR 作成前に仕様書以外の未コミットファイルがある場合は警告を表示

### 後方互換性制約

- **既存のテストケースの互換性**: スクリプト側から PR 作成ロジックを削除しても、既存のテストケースはすべてパスする必要がある
- **データベーススキーマの互換性**: `github_sync` テーブルのスキーマは変更しない

---

## 5. 依存関係

### 依存するコンポーネント

- **`src/slash-commands/spec-phase.md`**: completed フェーズ移行時の自動実行フローを記述
- **`src/commands/spec/phase.ts`**: フェーズ更新スクリプト（PR 作成ロジックを削除する対象）
- **`src/core/workflow/branch-management.ts`**: ブランチ管理（PR 作成ロジックを削除する対象）
- **`src/integrations/github/pull-request.ts`**: PR 作成の詳細実装（削除またはリファクタリング対象）

### 依存する外部ツール

- **GitHub CLI (`gh`)**: PR 作成に使用
- **Git**: ブランチのリモートプッシュ
- **Bash**: コマンド実行環境

### 関連する仕様書

- **79695221-d46e-48a5-8ef6-1b30a5c38b3c**: `/cft:spec-create` でブランチを作成する際、カレントブランチから作成される問題（会話ログの元となった仕様書）
- **eba108ca**: 各フェーズ完了時に未コミットのものがあれば自動コミットする（フェーズ移行時の自動コミット処理）

### データベーステーブル

- **`specs`**: 仕様書の基本情報
- **`github_sync`**: GitHub Issue/PR との同期情報

---

## 6. 参考情報

### ドキュメント

- **CLAUDE.md**: プロンプトファースト原則（144-188 行）、実装パターンマトリクス（209-225 行）
- **CLAUDE.md**: スクリプトとプロンプトの使い分け指針（124-141 行）
- **CLAUDE.md**: 実装前のチェックポイント（305-327 行）

### 参考実装

- **`src/slash-commands/spec-create.md`**: 複雑な自動実行フロー（フェーズ 0〜5）（103-188 行）
- **`src/slash-commands/github-issue-create.md`**: シンプルなスクリプト + プロンプト連携
- **`src/slash-commands/pr-cleanup.md`**: エラーハンドリングと警告表示の参考実装

### 技術資料

- GitHub CLI ドキュメント: https://cli.github.com/manual/gh_pr_create
- Octokit REST API: https://octokit.github.io/rest.js/v18 (削減対象)

### 会話ログ

ユーザーが提供した会話ログから、以下の知見を得られる:

1. **問題の現象**: completed フェーズ移行時、PR 作成が失敗する
2. **失敗理由**: ブランチがリモートにプッシュされていない
3. **プロンプト指示の成功例**: ユーザーが手動で「PR を作成してください」と指示すると、プロンプトベースで正常に PR が作成される
4. **改善方針**: プロンプトファースト原則に従って実装し直す

---

## 7. 設計詳細

### 7.1. アーキテクチャ設計

#### 現在のアーキテクチャ（問題あり）

```
ユーザー
  ↓
spec-phase.md (プロンプト)
  ↓
phase.ts (スクリプト：フェーズ遷移)
  ↓
event-bus (イベント: spec.phase_changed)
  ↓
branch-management.ts (ハンドラー：PR作成トリガー)
  ├─ createPullRequest() → ❌ ブランチ未プッシュでエラー
  └─ recordPullRequestToIssue() → スキップ
```

**問題点:**
- ブランチがリモートにプッシュされていない場合、PR 作成が失敗する
- エラーメッセージが不明瞭（ユーザーが対応策を理解しにくい）
- エラー時の自動リトライ処理がない

#### 改善後のアーキテクチャ（プロンプトファースト）

```
ユーザー
  ↓
spec-phase.md (プロンプト)
  ├─ → phase.ts (スクリプト：フェーズ遷移)
  │    ↓
  │    event-bus (イベント: spec.phase_changed)
  │    ↓
  │    branch-management.ts (ハンドラー：PR作成トリガー)
  │    ├─ [事前チェック] ブランチがリモートにプッシュされているか確認
  │    │   ↓ No
  │    │   → git push -u origin <branch>（自動プッシュ）
  │    │   ↓ Yes
  │    ├─ → pull-request.ts (スクリプト：PR作成実装)
  │    │    ↓
  │    └─ → github_sync テーブル更新
  │
  └─ (プロンプト自動実行) completed フェーズ移行後の処理
       ├─ [1] git status 確認
       ├─ [2] 未コミットファイル検出 + 警告/成功メッセージ
       └─ [3] 次ステップ案内
```

**改善点:**
1. **事前チェック追加**: ブランチがリモートにプッシュされているか確認
2. **自動プッシュ**: プッシュされていない場合は自動的に `git push -u origin <branch>` を実行
3. **エラーメッセージ改善**: 失敗理由と対応策を明示
4. **プロンプト側でのフォローアップ**: Git 状態確認と次ステップ案内

#### 処理フロー詳細

**フェーズ1: スクリプト側の事前チェック（branch-management.ts）**

```typescript
// 1. ブランチがリモートにプッシュされているか確認
const isRemoteBranchExists = await checkRemoteBranchExists(currentBranch);

if (!isRemoteBranchExists) {
  // 2. 自動プッシュ
  console.log(`\n⚠️  ブランチがリモートにプッシュされていません。自動プッシュを実行します...`);

  const pushResult = await execCommand(`git push -u origin ${currentBranch}`);

  if (pushResult.exitCode !== 0) {
    console.error(`\n❌ ブランチのプッシュに失敗しました: ${pushResult.stderr}`);
    console.error(`\n対応策: 以下のコマンドで手動プッシュしてください:`);
    console.error(`  git push -u origin ${currentBranch}`);
    return; // PR作成をスキップ
  }

  console.log(`\n✓ ブランチをリモートにプッシュしました: ${currentBranch}`);
}

// 3. PR作成処理
const result = await createPullRequest(db, {
  specId: event.specId,
  branchName: currentBranch,
  defaultBaseBranch,
});
```

**フェーズ2: プロンプト側の自動実行フロー（spec-phase.md）**

```markdown
## completed フェーズ移行後の自動処理

重要: フェーズ移行が完了したら、以下の処理を**自動的に実行**してください。

### 1. Git 状態確認（必須・自動実行）

Bash ツールで以下のコマンドを実行してください:

git status --porcelain

### 2. 未コミットファイルの検出と警告（必須・自動実行）

- **出力が空（長さ0）の場合**: 成功メッセージを表示
- **出力が空でない場合**: 警告メッセージ + ファイル一覧を表示

### 3. 次のステップ案内（必須・自動実行）

- GitHub Issue を更新: `/cft:spec-update <spec-id>`
- 仕様書の詳細確認: `/cft:spec-get <spec-id>`
- PR マージ後の処理: `/cft:pr-cleanup <spec-id>`
```

### 7.2. データモデル

#### 影響を受けるテーブル

**`specs` テーブル（変更なし）:**
```sql
CREATE TABLE specs (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  phase TEXT NOT NULL,
  branch_name TEXT,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL
);
```

**`github_sync` テーブル（変更なし）:**
```sql
CREATE TABLE github_sync (
  entity_id TEXT NOT NULL,
  entity_type TEXT NOT NULL,
  github_issue_id TEXT,
  github_project_id TEXT,
  github_milestone_id TEXT,
  pr_number INTEGER,
  pr_url TEXT,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  PRIMARY KEY (entity_id, entity_type)
);
```

#### データフロー

```
[phase.ts]
  ↓ UPDATE specs SET phase = 'completed', updated_at = NOW()
  ↓ event-bus.emit('spec.phase_changed', { specId, oldPhase, newPhase })
[branch-management.ts]
  ↓ checkRemoteBranchExists()
  ↓ git push -u origin <branch>（必要時）
  ↓ createPullRequest()
  ↓ UPDATE github_sync SET pr_number = ?, pr_url = ?, updated_at = NOW()
  ↓ recordPullRequestToIssue()
[spec-phase.md]
  ↓ git status --porcelain
  ↓ 警告/成功メッセージ表示
```

### 7.3. API の仕様

該当なし（GitHub API 呼び出しは既存の `pull-request.ts` を使用）

### 7.4. セキュリティ考慮事項

#### 1. Git 認証情報の保護

**リスク:**
- `git push` 時に認証情報が標準出力に漏洩する可能性

**対策:**
```typescript
const pushResult = await execCommand(`git push -u origin ${currentBranch}`, {
  env: {
    ...process.env,
    GIT_ASKPASS: 'echo', // 認証プロンプトを無効化
    GIT_TERMINAL_PROMPT: '0', // ターミナルプロンプトを無効化
  },
});

// ログ出力時にトークンをマスク
if (pushResult.stderr) {
  const maskedStderr = pushResult.stderr.replace(/(https?:\/\/)[^@]+@/g, '$1***@');
  console.error(maskedStderr);
}
```

#### 2. GitHub トークンの保護

**リスク:**
- PR 本文に機密情報が含まれる可能性

**対策:**
```typescript
// 仕様書から PR 本文を生成する際、機密情報をサニタイズ
const body = sanitizePullRequestBody(rawBody);

function sanitizePullRequestBody(content: string): string {
  // 環境変数のパターンをマスク
  return content
    .replace(/GITHUB_TOKEN=[^\s]+/g, 'GITHUB_TOKEN=***')
    .replace(/API_KEY=[^\s]+/g, 'API_KEY=***');
}
```

#### 3. コマンドインジェクション対策

**リスク:**
- ブランチ名に不正なコマンドが含まれる可能性

**対策:**
```typescript
// ブランチ名のバリデーション（既存実装を活用）
const VALID_BRANCH_NAME_PATTERN = /^[a-zA-Z0-9/_-]+$/;

if (!VALID_BRANCH_NAME_PATTERN.test(currentBranch)) {
  throw new Error(`Invalid branch name: ${currentBranch}`);
}

// execCommand でシェルエスケープを使用
const pushResult = await execCommand(`git push -u origin "${currentBranch}"`);
```

### 7.5. テスト戦略

#### 単体テスト

**テスト対象:**
- `src/core/workflow/branch-management.ts`
  - `handlePullRequestCreationOnCompleted()`
  - `checkRemoteBranchExists()`（新規追加）
  - `pushBranchToRemote()`（新規追加）

**テストケース:**

```typescript
describe('handlePullRequestCreationOnCompleted', () => {
  it('ブランチがリモートにプッシュされていない場合、自動プッシュする', async () => {
    // モック設定
    mockCheckRemoteBranchExists.mockResolvedValue(false);
    mockExecCommand.mockResolvedValue({ exitCode: 0, stdout: '', stderr: '' });
    mockCreatePullRequest.mockResolvedValue({ success: true, pullRequestUrl: 'https://...' });

    await handlePullRequestCreationOnCompleted(event);

    // git push が呼ばれたことを確認
    expect(mockExecCommand).toHaveBeenCalledWith('git push -u origin feature/test-branch', expect.any(Object));

    // PR 作成が呼ばれたことを確認
    expect(mockCreatePullRequest).toHaveBeenCalled();
  });

  it('ブランチプッシュ失敗時、PR作成をスキップする', async () => {
    mockCheckRemoteBranchExists.mockResolvedValue(false);
    mockExecCommand.mockResolvedValue({ exitCode: 1, stdout: '', stderr: 'Permission denied' });

    await handlePullRequestCreationOnCompleted(event);

    // PR 作成が呼ばれていないことを確認
    expect(mockCreatePullRequest).not.toHaveBeenCalled();
  });

  it('ブランチがリモートにプッシュ済みの場合、即座にPR作成する', async () => {
    mockCheckRemoteBranchExists.mockResolvedValue(true);
    mockCreatePullRequest.mockResolvedValue({ success: true, pullRequestUrl: 'https://...' });

    await handlePullRequestCreationOnCompleted(event);

    // git push が呼ばれていないことを確認
    expect(mockExecCommand).not.toHaveBeenCalled();

    // PR 作成が呼ばれたことを確認
    expect(mockCreatePullRequest).toHaveBeenCalled();
  });
});
```

#### 統合テスト

**テスト対象:**
- `/cft:spec-phase <spec-id> completed` の実行フロー

**テストケース:**

```typescript
describe('/cft:spec-phase completed', () => {
  it('completed フェーズ移行時、PR が自動作成される', async () => {
    // 仕様書を作成
    const specId = await createTestSpec({ phase: 'implementation' });

    // ブランチを作成（リモートにプッシュしない）
    await execCommand(`git checkout -b feature/test-branch`);

    // フェーズ移行を実行
    await execCommand(`npx tsx .cc-craft-kit/commands/spec/phase.ts ${specId} completed`);

    // PR が作成されたことを確認
    const githubSync = await db.selectFrom('github_sync').where('entity_id', '=', specId).executeTakeFirst();
    expect(githubSync?.pr_number).toBeDefined();
    expect(githubSync?.pr_url).toMatch(/^https:\/\/github\.com/);
  });
});
```

#### E2Eテスト

**テスト対象:**
- プロンプト側の自動実行フロー（`spec-phase.md`）

**テストケース:**
- 手動テスト（Claude Code 上で実行）
  1. 仕様書を作成し、implementation フェーズに移行
  2. `/cft:spec-phase <spec-id> completed` を実行
  3. PR が自動作成されることを確認
  4. `git status --porcelain` が自動実行されることを確認
  5. 警告/成功メッセージが表示されることを確認

---

## 8. 実装タスクリスト

### タスク 1: ブランチリモートプッシュチェック機能の追加

**対象ファイル:** `src/core/workflow/branch-management.ts`

**実装内容:**
- `checkRemoteBranchExists(branchName: string): Promise<boolean>` 関数を新規作成
- `git ls-remote --heads origin <branch>` コマンドでリモートブランチの存在を確認
- エラーハンドリング（Git コマンド実行失敗時）

**受け入れ基準:**
- ブランチがリモートに存在する場合、`true` を返す
- ブランチがリモートに存在しない場合、`false` を返す
- Git コマンド実行失敗時、適切なエラーメッセージを表示

**優先度:** 高（タスク 2 の前提条件）

---

### タスク 2: 自動プッシュ処理の実装

**対象ファイル:** `src/core/workflow/branch-management.ts`

**実装内容:**
- `handlePullRequestCreationOnCompleted()` 関数内で、PR 作成前にブランチリモートプッシュチェックを実行
- ブランチがリモートにプッシュされていない場合、`git push -u origin <branch>` を自動実行
- プッシュ成功時、成功メッセージを表示
- プッシュ失敗時、エラーメッセージと手動プッシュ手順を表示し、PR 作成をスキップ

**受け入れ基準:**
- ブランチがリモートにプッシュされていない場合、自動的にプッシュされる
- プッシュ成功後、PR 作成が実行される
- プッシュ失敗時、PR 作成がスキップされる
- エラーメッセージに対応策が含まれる

**優先度:** 高（タスク 1 に依存）

---

### タスク 3: エラーメッセージの改善

**対象ファイル:** `src/core/workflow/branch-management.ts`

**実装内容:**
- PR 作成失敗時のエラーメッセージに、ユーザーフレンドリーな対応策を追加
- エラーケース別にメッセージを分岐
  - GitHub クライアント未初期化 → `/cft:github-init` を案内
  - リポジトリ情報が見つからない → `.env` 設定を案内
  - ブランチプッシュ失敗 → 手動プッシュ手順を案内
  - その他のエラー → GitHub CLI (`gh pr create`) での手動 PR 作成を案内

**受け入れ基準:**
- エラーメッセージが明確で、ユーザーが失敗理由を理解しやすい
- エラーメッセージに対応策が含まれる
- エラーケース別にメッセージが適切に分岐される

**優先度:** 中（タスク 2 と並行実施可能）

---

### タスク 4: セキュリティ対策の実装

**対象ファイル:**
- `src/core/workflow/branch-management.ts`
- `src/integrations/github/pull-request.ts`

**実装内容:**

#### 4-1. Git 認証情報の保護
- `git push` 時に認証情報が標準出力に漏洩しないよう、環境変数 `GIT_ASKPASS='echo'`, `GIT_TERMINAL_PROMPT='0'` を設定
- ログ出力時にトークンをマスク（`/(https?:\/\/)[^@]+@/g` をマッチしてマスク）

#### 4-2. コマンドインジェクション対策
- ブランチ名のバリデーション（`/^[a-zA-Z0-9/_-]+$/` パターン）
- `execCommand` でシェルエスケープを使用

**受け入れ基準:**
- Git 認証情報が標準出力に表示されない
- ログ出力時にトークンがマスクされる
- 不正なブランチ名が検出された場合、エラーメッセージを表示

**優先度:** 中（タスク 2 と並行実施可能）

---

### タスク 5: 単体テストの追加

**対象ファイル:** `tests/core/workflow/branch-management.test.ts`

**実装内容:**
- `checkRemoteBranchExists()` のテストケース
  - ブランチがリモートに存在する場合
  - ブランチがリモートに存在しない場合
  - Git コマンド実行失敗時
- `handlePullRequestCreationOnCompleted()` のテストケース
  - ブランチがリモートにプッシュされていない場合、自動プッシュする
  - ブランチプッシュ失敗時、PR 作成をスキップする
  - ブランチがリモートにプッシュ済みの場合、即座に PR 作成する

**受け入れ基準:**
- すべてのテストケースがパスする
- カバレッジが 80% 以上
- モック化が適切に実施されている（Git 操作、GitHub API）

**優先度:** 中（タスク 1〜4 の実装完了後）

---

### タスク 6: 既存テストケースの互換性確認

**対象ファイル:** すべてのテストファイル

**実装内容:**
- 既存のテストケースをすべて実行
- リグレッションテストを実施
- テスト失敗が発生した場合、原因を特定して修正

**受け入れ基準:**
- 既存のテストケースがすべてパスする
- リグレッションが発生していない

**優先度:** 高（タスク 5 完了後、実装完了前に実施）

---

### 実装順序

```
タスク 1 (ブランチリモートプッシュチェック)
  ↓
タスク 2 (自動プッシュ処理) + タスク 3 (エラーメッセージ改善) + タスク 4 (セキュリティ対策)
  ↓
タスク 5 (単体テスト追加)
  ↓
タスク 6 (既存テストケース互換性確認)
```

**推定作業時間:**
- タスク 1: 30分
- タスク 2: 1時間
- タスク 3: 30分
- タスク 4: 45分
- タスク 5: 1時間30分
- タスク 6: 30分

**合計:** 約5時間
