---
id: "9019c7de-f013-49e9-8e7a-4c0f147269f0"
name: "作成された Issue が GitHub Projects に登録されない"
phase: "design"
branch_name: "fix/spec-9019c7de-issue-not-added-to-projects"
github_issue_number: null
pr_url: null
created_at: "2025-12-07T04:00:00.000Z"
updated_at: "2025-12-07T07:35:00.000Z"
---

# 作成された Issue が GitHub Projects に登録されない

## 1. 背景と目的

### 背景

`/cft:github issue-create` や `/cft:spec phase design`（Sub Issue 作成時）で GitHub Issue を作成した際、Issue が GitHub Projects に自動登録されない。

現状の動作:
- Issue は正常に作成される
- しかし GitHub Projects には追加されない
- 手動で Projects に追加する必要がある

発生した事例:
- Issue #936〜#940 が作成されたが、Projects には登録されていない

### 目的

Issue 作成時に、自動的に GitHub Projects に追加する処理を実装する。

---

## 2. 対象ユーザー

cc-craft-kit を使用して GitHub Projects でタスク管理を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] Issue 作成時に GitHub Projects へ自動追加される
- [ ] Projects への追加失敗時はエラーで処理を中断しない（警告のみ）

### 機能要件

- [ ] `/cft:github issue-create` 実行時に Projects へ追加
- [ ] `/cft:spec phase design`（Sub Issue 作成時）に Projects へ追加
- [ ] config.json から Project ID を取得

### 非機能要件

- [ ] gh CLI の GraphQL API を使用
- [ ] Project が設定されていない場合はスキップ

---

## 4. 制約条件

- `gh` CLI のみで実装（Octokit 不使用）
- GitHub Projects v2 API を使用

---

## 5. 依存関係

- `/cft:github` コマンド（`.claude/commands/cft/github.md`）
- `/cft:spec` コマンド（`.claude/commands/cft/spec.md`）

---

## 6. 参考情報

- 発生した Issue: #936〜#940（Projects に未登録）
- GitHub Projects v2 API: `addProjectV2ItemById` mutation
- Project ID: `PVT_kwHOAA1CPM4BIPQk`（cc-craft-kit プロジェクト）

---

## 7. 設計詳細

### 7.1 問題の根本原因

現在の実装では、Issue 作成後に GitHub Projects への追加処理が存在しない。

**関連箇所**:
- `.claude/commands/cft/github.md`: Issue 作成処理（Lines 90-96）
- `.claude/commands/cft/spec.md`: design フェーズで Sub Issue 作成（Lines 428）

### 7.2 解決アプローチ

Issue 作成直後に `addProjectV2ItemById` GraphQL mutation を実行して Projects に追加する。

**処理フロー**:

```
Issue 作成
    ↓
Issue Node ID 取得（gh issue view --json id）
    ↓
Project ID 取得（config.json または GraphQL で解決）
    ↓
addProjectV2ItemById mutation 実行
    ↓
成功: 完了
失敗: 警告ログのみ（処理は継続）
```

### 7.3 config.json スキーマ拡張

Projects v2 の Global Node ID を保存するため、config.json を拡張:

```json
{
  "github": {
    "owner": "B16B1RD",
    "repo": "cc-craft-kit",
    "project_v2": {
      "number": 1,
      "id": "PVT_kwHOAA1CPM4BIPQk",
      "name": "cc-craft-kit",
      "cached_at": "2025-12-07T00:00:00.000Z"
    }
  }
}
```

### 7.4 GraphQL mutation 仕様

**Issue Node ID 取得**:

```bash
ISSUE_NODE_ID=$(gh issue view <issue-number> --json id -q .id)
```

**Projects 追加**:

```bash
gh api graphql -f query='
  mutation($projectId: ID!, $contentId: ID!) {
    addProjectV2ItemById(input: {projectId: $projectId, contentId: $contentId}) {
      item { id }
    }
  }
' -f projectId="$PROJECT_V2_ID" -f contentId="$ISSUE_NODE_ID"
```

### 7.5 エラーハンドリング

- Project が設定されていない場合: スキップ（警告なし）
- Project ID が無効な場合: 警告を出力して続行
- GraphQL API エラー: 警告を出力して続行

```
⚠️ GitHub Projects への追加に失敗しました（Issue #123 は正常に作成されています）
```

---

## 8. 実装タスクリスト

### 8.1 config.json スキーマ拡張

- [ ] `project_name_cache` を `project_v2` にリネーム
- [ ] `project_v2.id` フィールドを追加（Global Node ID）
- [ ] Project ID 解決時に `id` を保存するよう更新

### 8.2 github.md の修正

- [ ] Issue 作成後に Projects 追加処理を追加
- [ ] `gh issue view --json id` で Issue Node ID を取得
- [ ] `addProjectV2ItemById` mutation を実行
- [ ] エラー時は警告のみで続行

### 8.3 spec.md の修正

- [ ] design フェーズの Sub Issue 作成後に Projects 追加処理を追加
- [ ] github.md と同じパターンで実装

### 8.4 Project ID 解決処理の追加

- [ ] config.json に `project_v2.id` がない場合、GraphQL で取得
- [ ] 取得した ID を config.json にキャッシュ
