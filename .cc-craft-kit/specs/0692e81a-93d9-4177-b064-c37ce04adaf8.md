# .env の GITHUB_PROJECT_NAME が機能していない

**仕様書 ID:** 0692e81a-93d9-4177-b064-c37ce04adaf8
**フェーズ:** completed
**作成日時:** 2025/11/16 16:01:28
**更新日時:** 2025/11/16 20:37:35

---

## 1. 背景と目的

### 背景

.env の GITHUB_PROJECT_NAME にプロジェクト名を設定していても `/cft:status` で確認すると Project ID が未設定と表示される。これを正しく機能するようにしたい。

### 目的

環境変数 `GITHUB_PROJECT_NAME` で指定したプロジェクト名から GitHub Projects v2 の番号を動的に解決し、`takumi status` コマンドで正しく表示できるようにする。

---

## 2. 対象ユーザー

GitHub Projects v2 を使用して開発タスクを管理している Takumi ユーザー。特に複数のプロジェクトを切り替えて作業するユーザー。

---

## 3. 受け入れ基準

### 必須要件

- [x] `.env` に `GITHUB_PROJECT_NAME` を設定した場合、`takumi status` で Project 番号が表示される
- [x] プロジェクト名が見つからない場合、エラーメッセージが表示される
- [x] `GITHUB_PROJECT_NAME` が未設定の場合は、従来通り config.json の `project_id` を使用する

### 機能要件

- [x] GitHub GraphQL API でプロジェクト名から番号を検索する機能
- [x] 個人アカウントと Organization の両方に対応
- [x] 一度解決した Project 番号を config.json にキャッシュ
- [x] 環境変数の値が変わった場合は再検索

### 非機能要件

- [x] API 呼び出しは必要最小限（キャッシュ活用）
- [x] エラーハンドリングが適切
- [x] レスポンス時間は 2 秒以内

---

## 4. 設計詳細

### アーキテクチャ

**ハイブリッドアプローチ:**

1. 環境変数 `GITHUB_PROJECT_NAME` 優先
2. config.json の `project_id` フォールバック
3. 解決結果をキャッシュ

### データフロー

```text
1. status コマンド実行
   ↓
2. GITHUB_PROJECT_NAME 環境変数チェック
   ↓
3a. 設定あり → GitHub API でプロジェクト検索
   ↓
3b. 見つかった → 番号を表示 & キャッシュ保存
   ↓
4a. 設定なし → config.json の project_id を使用
   ↓
5. 表示
```

### 実装ファイル

1. **`src/cli/commands/status.ts`**
   - `resolveProjectId()` メソッド追加
   - 環境変数読み込み
   - GitHub API 呼び出し
   - キャッシュ管理

2. **`src/integrations/github/projects.ts`**
   - `searchByName()` メソッド追加
   - プロジェクト名で検索する GraphQL クエリ

3. **`.cc-craft-kit/config.json`**
   - `project_name_cache` フィールド追加（オプション）
   - キャッシュされた環境変数名とプロジェクト番号

### GraphQL クエリ例

```graphql
query($owner: String!, $projectName: String!) {
  user(login: $owner) {
    projectsV2(first: 100) {
      nodes {
        id
        number
        title
      }
    }
  }
}
```

### config.json スキーマ拡張

```json
{
  "project": { ... },
  "github": {
    "owner": "B16B1RD",
    "repo": "takumi",
    "project_id": 1,
    "project_name_cache": {
      "GITHUB_PROJECT_NAME": "Takumi Development",
      "resolved_number": 1,
      "cached_at": "2025-11-16T07:00:00Z"
    }
  }
}
```

---

## 5. 制約条件

- GitHub API のレート制限（5000 リクエスト/時）
- プロジェクト名は大文字小文字を区別
- 個人アカウントは Classic PAT が必須（Fine-grained PAT 非対応）
- Organization は Fine-grained PAT または Classic PAT

---

## 6. 依存関係

- GitHub GraphQL API（Projects v2）
- `src/integrations/github/projects.ts`
- `src/integrations/github/client.ts`
- 環境変数 `GITHUB_TOKEN`

---

## 7. 参考情報

- [GitHub Projects v2 API ドキュメント](https://docs.github.com/en/graphql/reference/objects#projectv2)
- Fine-grained PAT の制限: <https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens#personal-access-tokens-classic>
