# /cft:spec-phase で適切に指定した id の仕様書があるブランチに切り替わるか確認

**仕様書 ID:** f12b0d21-7e2f-488b-9da0-201935b6f1ff
**フェーズ:** requirements
**作成日時:** 2025/11/22 19:57:30
**更新日時:** 2025/11/22 19:57:30

---

## 1. 背景と目的

### 背景

現在、`/cft:spec-phase` コマンドを実行する際、以下の課題があります。

1. 現在のブランチが仕様書の作成ブランチと異なる場合、フェーズ変更はできるが、仕様書ファイルの変更が反映されない
2. 未コミットの変更が残っている状態でブランチ切り替えを試みると、Git がエラーを返す
3. ユーザーが手動でブランチを切り替える必要があり、ワークフローが煩雑

### 目的

`/cft:spec-phase` コマンド実行時に、以下を自動的に実行することで、シームレスなフェーズ移行を実現します。

1. 指定された仕様書 ID に紐づくブランチを自動検出
2. 未コミット変更がある場合は自動コミット
3. 対象ブランチへの自動切り替え
4. フェーズ変更の実行

---

## 2. 対象ユーザー

- cc-craft-kit を使用する開発者
- 複数の仕様書を並行して開発している開発者
- ブランチ切り替えを頻繁に行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-phase <spec-id> <phase>` 実行時、指定された仕様書 ID に紐づくブランチ名をデータベースから取得できること
- [ ] 取得したブランチ名が現在のブランチと異なる場合、自動的にブランチ切り替えを試みること
- [ ] ブランチ切り替え前に未コミット変更がある場合、適切なコミットメッセージで自動コミットを実行すること
- [ ] ブランチ切り替え失敗時、ユーザーに分かりやすいエラーメッセージを表示すること

### 機能要件

- [ ] 未コミット変更のチェックに `checkGitStatus()` 関数を使用すること
- [ ] 自動コミット時のコミットメッセージは `chore: auto-commit before switching to branch <branch-name>` とすること
- [ ] ブランチ切り替えに `git checkout <branch-name>` を使用すること
- [ ] ブランチ切り替え後、ブランチキャッシュをクリアすること (`clearBranchCache()`)
- [ ] ブランチ切り替え成功後、通常のフェーズ変更処理を実行すること

### 非機能要件

- [ ] ブランチ切り替え処理は 3 秒以内に完了すること
- [ ] 自動コミット失敗時、ブランチ切り替えを中断し、ロールバックすること
- [ ] エラーメッセージには、手動での対処方法を含めること
- [ ] すべての Git 操作は、try-catch でエラーハンドリングすること

### セキュリティ要件

- [ ] ブランチ名のサニタイゼーション処理を実装すること（英数字、ハイフン、スラッシュのみ許可）
- [ ] 自動コミット前に `.gitignore` で除外されたファイルがステージングされていないことを確認すること
- [ ] ブランチ切り替え失敗時、未コミット変更が失われないよう、`git stash` での一時退避を検討すること
- [ ] すべての Git コマンド実行時、`stdio: 'pipe'` オプションを使用してエラー出力を制御すること

### テスト要件

- [ ] 未コミット変更がある状態でブランチ切り替えが成功することを E2E テストで検証すること
- [ ] 未コミット変更がない状態でブランチ切り替えが成功することを E2E テストで検証すること
- [ ] ブランチ切り替え失敗時、適切なエラーメッセージが表示されることを単体テストで検証すること
- [ ] 自動コミット失敗時、ロールバックが正常に動作することを単体テストで検証すること
- [ ] Git 操作のモック化により、実際のブランチ切り替えを伴わないテストを実装すること

---

## 4. 制約条件

### 技術的制約

- 対象ブランチが存在しない場合、エラーを返すこと（ブランチの自動作成は行わない）
- Git リポジトリが未初期化の場合、エラーを返すこと
- ブランチ切り替え時にコンフリクトが発生する場合、エラーを返し、手動解決を促すこと

### ビジネス的制約

- 保護ブランチ（main, develop）へは切り替えを禁止すること
- ブランチ切り替え前に必ず確認メッセージを表示すること（任意: 環境変数 `AUTO_BRANCH_SWITCH=true` で確認スキップ可能）

---

## 5. 依存関係

### 依存する既存機能

- `src/core/git/branch-cache.ts` - ブランチキャッシュ機構
- `src/core/workflow/git-integration.ts` - Git 統合ハンドラー（`checkGitStatus()`, `gitCommit()`）
- `src/commands/spec/helpers.ts` - `getSpecWithGitHubInfo()` で仕様書の `branch_name` 取得

### 影響を受ける機能

- `/cft:spec-phase` コマンド実装（`src/commands/spec/phase.ts`）
- フェーズ変更イベントハンドラー（既存の自動コミット処理と競合しないよう調整が必要）

---

## 6. 参考情報

- CLAUDE.md「ブランチ管理」セクション
- `src/core/git/branch-creation.ts` - ブランチ作成ロジック（参考実装）
- `tests/e2e/test-branch-stability.test.ts` - ブランチ切り替えテストの実装例
- GitHub Issue #286
