---
id: "f12b0d21-7e2f-488b-9da0-201935b6f1ff"
name: "/cft:spec-phase で適切に指定した id の仕様書があるブランチに切り替わるか確認"
phase: "completed"
branch_name: "main"
github_issue_number: null
pr_url: null
created_at: "2025-11-22T10:57:30.485Z"
updated_at: "2025-11-22T21:42:30Z"
---

# /cft:spec-phase で適切に指定した id の仕様書があるブランチに切り替わるか確認


## 1. 背景と目的

### 背景

現在、`/cft:spec-phase` コマンドを実行する際、以下の課題があります。

1. 現在のブランチが仕様書の作成ブランチと異なる場合、フェーズ変更はできるが、仕様書ファイルの変更が反映されない
2. 未コミットの変更が残っている状態でブランチ切り替えを試みると、Git がエラーを返す
3. ユーザーが手動でブランチを切り替える必要があり、ワークフローが煩雑

### 目的

`/cft:spec-phase` コマンド実行時に、以下を自動的に実行することで、シームレスなフェーズ移行を実現します。

1. 指定された仕様書 ID に紐づくブランチを自動検出
2. 未コミット変更がある場合は自動コミット
3. 対象ブランチへの自動切り替え
4. フェーズ変更の実行
---

## 2. 対象ユーザー

- cc-craft-kit を使用する開発者
- 複数の仕様書を並行して開発している開発者
- ブランチ切り替えを頻繁に行う開発者
---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-phase <spec-id> <phase>` 実行時、指定された仕様書 ID に紐づくブランチ名をデータベースから取得できること
- [ ] 取得したブランチ名が現在のブランチと異なる場合、自動的にブランチ切り替えを試みること
- [ ] ブランチ切り替え前に未コミット変更がある場合、適切なコミットメッセージで自動コミットを実行すること
- [ ] ブランチ切り替え失敗時、ユーザーに分かりやすいエラーメッセージを表示すること

### 機能要件

- [ ] 未コミット変更のチェックに `checkGitStatus()` 関数を使用すること
- [ ] 自動コミット時のコミットメッセージは `chore: auto-commit before switching to branch <branch-name>` とすること
- [ ] ブランチ切り替えに `git checkout <branch-name>` を使用すること
- [ ] ブランチ切り替え後、ブランチキャッシュをクリアすること (`clearBranchCache()`)
- [ ] ブランチ切り替え成功後、通常のフェーズ変更処理を実行すること

### 非機能要件

- [ ] ブランチ切り替え処理は 3 秒以内に完了すること
- [ ] 自動コミット失敗時、ブランチ切り替えを中断し、ロールバックすること
- [ ] エラーメッセージには、手動での対処方法を含めること
- [ ] すべての Git 操作は、try-catch でエラーハンドリングすること

### セキュリティ要件

- [ ] ブランチ名のサニタイゼーション処理を実装すること（英数字、ハイフン、スラッシュのみ許可）
- [ ] 自動コミット前に `.gitignore` で除外されたファイルがステージングされていないことを確認すること
- [ ] ブランチ切り替え失敗時、未コミット変更が失われないよう、`git stash` での一時退避を検討すること
- [ ] すべての Git コマンド実行時、`stdio: 'pipe'` オプションを使用してエラー出力を制御すること

### テスト要件

- [ ] 未コミット変更がある状態でブランチ切り替えが成功することを E2E テストで検証すること
- [ ] 未コミット変更がない状態でブランチ切り替えが成功することを E2E テストで検証すること
- [ ] ブランチ切り替え失敗時、適切なエラーメッセージが表示されることを単体テストで検証すること
- [ ] 自動コミット失敗時、ロールバックが正常に動作することを単体テストで検証すること
- [ ] Git 操作のモック化により、実際のブランチ切り替えを伴わないテストを実装すること
---

## 4. 制約条件

### 技術的制約

- 対象ブランチが存在しない場合、エラーを返すこと（ブランチの自動作成は行わない）
- Git リポジトリが未初期化の場合、エラーを返すこと
- ブランチ切り替え時にコンフリクトが発生する場合、エラーを返し、手動解決を促すこと

### ビジネス的制約

- 保護ブランチ（main, develop）へは切り替えを禁止すること
- ブランチ切り替え前に必ず確認メッセージを表示すること（任意: 環境変数 `AUTO_BRANCH_SWITCH=true` で確認スキップ可能）
---

## 5. 依存関係

### 依存する既存機能

- `src/core/git/branch-cache.ts` - ブランチキャッシュ機構
- `src/core/workflow/git-integration.ts` - Git 統合ハンドラー（`checkGitStatus()`, `gitCommit()`）
- `src/commands/spec/helpers.ts` - `getSpecWithGitHubInfo()` で仕様書の `branch_name` 取得

### 影響を受ける機能

- `/cft:spec-phase` コマンド実装（`src/commands/spec/phase.ts`）
- フェーズ変更イベントハンドラー（既存の自動コミット処理と競合しないよう調整が必要）
---

## 6. 参考情報

- CLAUDE.md「ブランチ管理」セクション
- `src/core/git/branch-creation.ts` - ブランチ作成ロジック（参考実装）
- `tests/e2e/test-branch-stability.test.ts` - ブランチ切り替えテストの実装例
- GitHub Issue #286
---

## 7. 詳細設計

### 7.1 アーキテクチャ設計

#### モジュール構成

```text
src/
├── commands/spec/
│   └── phase.ts                    # 既存: フェーズ変更コマンド（修正）
├── core/git/
│   ├── branch-cache.ts             # 既存: ブランチキャッシュ
│   ├── branch-creation.ts          # 既存: ブランチ作成ロジック
│   └── branch-switching.ts         # 新規: ブランチ切り替えロジック
└── core/workflow/
    └── git-integration.ts          # 既存: Git 統合ハンドラー（参照のみ）
```

#### 処理フロー

```text
┌─────────────────────────────────────────┐
│ /cft:spec-phase <spec-id> <phase>       │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│ 1. 仕様書情報取得                        │
│    - getSpecWithGitHubInfo(spec-id)     │
│    - branch_name フィールド取得          │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│ 2. ブランチ切り替えが必要か判定          │
│    - getCurrentBranch() で現在のブランチ │
│    - 比較: current !== target           │
└──────────────┬──────────────────────────┘
               │
               ▼ (必要な場合のみ)
┌─────────────────────────────────────────┐
│ 3. 未コミット変更をチェック              │
│    - checkGitStatus()                   │
│    - hasChanges が true なら自動コミット │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│ 4. ブランチ切り替え実行                  │
│    - switchBranch(targetBranch)         │
│    - clearBranchCache()                 │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│ 5. フェーズ変更実行                      │
│    - 既存の updatePhase() 処理           │
└─────────────────────────────────────────┘
```

### 7.2 API 設計

#### 新規関数: `switchBranch()`

**ファイル:** `src/core/git/branch-switching.ts`

```typescript
/**
 * 指定されたブランチに切り替える
 *
 * @param targetBranch - 切り替え先のブランチ名
 * @returns ブランチ切り替え結果
 * @throws BranchSwitchError - ブランチ切り替えに失敗した場合
 */
export function switchBranch(targetBranch: string): BranchSwitchResult {
  // 1. ブランチ名のバリデーション
  validateBranchName(targetBranch);

  // 2. 保護ブランチチェック
  if (isProtectedBranch(targetBranch)) {
    throw new BranchSwitchError(`保護ブランチ ${targetBranch} への切り替えは禁止されています`);
  }

  // 3. ブランチ存在確認
  if (!branchExists(targetBranch)) {
    throw new BranchSwitchError(`ブランチ ${targetBranch} が見つかりません`);
  }

  // 4. 現在のブランチを取得
  const currentBranch = getCurrentBranch();

  // 5. 同じブランチの場合はスキップ
  if (currentBranch === targetBranch) {
    return {
      switched: false,
      currentBranch,
      targetBranch,
      reason: 'Already on target branch',
    };
  }

  // 6. 未コミット変更をチェック
  const gitStatus = checkGitStatus();
  if (gitStatus.hasChanges) {
    // 自動コミット実行
    autoCommitBeforeSwitch(targetBranch);
  }

  // 7. ブランチ切り替え実行
  try {
    execSync(`git checkout ${targetBranch}`, { stdio: 'pipe' });
  } catch (error) {
    throw new BranchSwitchError(
      `ブランチ切り替えに失敗しました: ${error.message}\n` +
      `手動で切り替えてください: git checkout ${targetBranch}`
    );
  }

  // 8. 切り替え成功を検証
  const newBranch = execSync('git branch --show-current', { encoding: 'utf-8' }).trim();
  if (newBranch !== targetBranch) {
    throw new BranchSwitchError(
      `ブランチ切り替え後の検証に失敗しました。期待: ${targetBranch}, 実際: ${newBranch}`
    );
  }

  // 9. ブランチキャッシュをクリア
  clearBranchCache();

  return {
    switched: true,
    currentBranch,
    targetBranch,
    previousBranch: currentBranch,
  };
}
```

#### ヘルパー関数

```typescript
/**
 * ブランチ名のバリデーション
 * 英数字、ハイフン、スラッシュ、アンダースコアのみ許可
 */
function validateBranchName(branchName: string): void {
  const validPattern = /^[a-zA-Z0-9/_-]+$/;
  if (!validPattern.test(branchName)) {
    throw new BranchSwitchError(`無効なブランチ名: ${branchName}`);
  }
}

/**
 * 保護ブランチかどうかを判定
 */
function isProtectedBranch(branchName: string): boolean {
  const protectedBranches = process.env.PROTECTED_BRANCHES?.split(',') || ['main', 'develop'];
  return protectedBranches.includes(branchName);
}

/**
 * ブランチが存在するかチェック
 */
function branchExists(branchName: string): boolean {
  try {
    execSync(`git rev-parse --verify ${branchName}`, { stdio: 'pipe' });
    return true;
  } catch {
    return false;
  }
}

/**
 * ブランチ切り替え前の自動コミット
 */
function autoCommitBeforeSwitch(targetBranch: string): void {
  try {
    execSync('git add .', { stdio: 'pipe' });

    const commitMessage = `chore: auto-commit before switching to branch ${targetBranch}

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>`;

    execSync(`git commit -m "${commitMessage}"`, { stdio: 'pipe' });
  } catch (error) {
    throw new BranchSwitchError(
      `自動コミットに失敗しました: ${error.message}\n` +
      `手動でコミットしてください: git add . && git commit -m "chore: auto-commit"`
    );
  }
}
```

#### 型定義

```typescript
/**
 * ブランチ切り替え結果
 */
export interface BranchSwitchResult {
  switched: boolean;          // ブランチが切り替わったか
  currentBranch: string;      // 切り替え前のブランチ
  targetBranch: string;       // 切り替え先のブランチ
  previousBranch?: string;    // 切り替え前のブランチ（switched=true の場合のみ）
  reason?: string;            // スキップされた理由（switched=false の場合）
}

/**
 * ブランチ切り替えエラー
 */
export class BranchSwitchError extends Error {
  constructor(message: string) {
    super(message);
    this.name = 'BranchSwitchError';
  }
}
```

#### 既存ファイルの修正: `src/commands/spec/phase.ts`

```typescript
// 既存の phase.ts に追加する処理

import { switchBranch } from '../../core/git/branch-switching.js';
import { getSpecWithGitHubInfo } from './helpers.js';

async function updatePhase(specId: string, newPhase: string) {
  const db = getDatabase();

  // 1. 仕様書情報を取得（branch_name を含む）
  const spec = await getSpecWithGitHubInfo(db, specId);

  if (!spec) {
    throw new Error(`仕様書が見つかりません: ${specId}`);
  }

  // 2. ブランチ切り替えが必要かチェック
  if (spec.branch_name) {
    try {
      const result = switchBranch(spec.branch_name);

      if (result.switched) {
        console.log(`✓ Switched to branch: ${result.targetBranch}`);
      }
    } catch (error) {
      if (error instanceof BranchSwitchError) {
        console.error(`❌ ${error.message}`);
        throw error;
      }
      throw error;
    }
  }

  // 3. 既存のフェーズ変更処理を実行
  // ... (既存の処理)
}
```

### 7.3 データモデル

#### データベーススキーマ（変更なし）

既存の `specs` テーブルの `branch_name` カラムを使用します。

```typescript
interface SpecsTable {
  id: string;                  // UUID
  name: string;
  description: string | null;
  phase: SpecPhase;
  branch_name: string | null;  // ← この値を使用
  created_at: string;
  updated_at: string;
}
```

#### 環境変数

```bash
# .env
PROTECTED_BRANCHES=main,develop           # 保護ブランチのリスト（カンマ区切り）
AUTO_BRANCH_SWITCH=true                   # 確認なしで自動切り替え（デフォルト: false）
```

### 7.4 エラーハンドリング

#### エラーケースと対処

| エラーケース | 検出方法 | エラーメッセージ | 対処方法 |
|---|---|---|---|
| ブランチ名が不正 | `validateBranchName()` | `無効なブランチ名: <name>` | 仕様書の `branch_name` を修正 |
| 保護ブランチへの切り替え | `isProtectedBranch()` | `保護ブランチ <name> への切り替えは禁止されています` | 手動でブランチを作成 |
| ブランチが存在しない | `branchExists()` | `ブランチ <name> が見つかりません` | 手動でブランチを作成 |
| 自動コミット失敗 | `autoCommitBeforeSwitch()` | `自動コミットに失敗しました: <error>` | 手動でコミット |
| ブランチ切り替え失敗 | `execSync('git checkout')` | `ブランチ切り替えに失敗しました: <error>` | 手動で切り替え |
| Git 未初期化 | `execSync()` 例外 | `Git リポジトリが初期化されていません` | `git init` 実行 |

#### ロールバック処理

自動コミット失敗時のロールバックは実装しません（理由: `git add .` が成功した時点で、ロールバックしてもステージングは残る）。代わりに、エラーメッセージで手動対処を促します。

### 7.5 セキュリティ設計

#### 1. ブランチ名のサニタイゼーション

```typescript
function validateBranchName(branchName: string): void {
  // コマンドインジェクション対策
  const validPattern = /^[a-zA-Z0-9/_-]+$/;
  if (!validPattern.test(branchName)) {
    throw new BranchSwitchError(`無効なブランチ名: ${branchName}`);
  }

  // 予約語チェック
  const reservedNames = ['HEAD', 'refs/heads/', 'refs/tags/'];
  if (reservedNames.some(reserved => branchName.includes(reserved))) {
    throw new BranchSwitchError(`予約語を含むブランチ名は使用できません: ${branchName}`);
  }
}
```

#### 2. Git コマンド実行の安全性

```typescript
// stdio: 'pipe' でエラー出力を制御
execSync(`git checkout ${targetBranch}`, { stdio: 'pipe' });

// テンプレートリテラルではなく、検証済みの変数のみ使用
const validatedBranch = validateBranchName(targetBranch);
```

#### 3. .gitignore の尊重

自動コミット時、`.gitignore` で除外されたファイルはステージングされません（`git add .` の仕様により自動的に除外されます）。

### 7.6 テスト設計

#### 単体テスト: `tests/core/git/branch-switching.test.ts`

```typescript
describe('switchBranch()', () => {
  describe('ブランチ名バリデーション', () => {
    it('有効なブランチ名を受け入れる', () => {
      expect(() => validateBranchName('feature/test')).not.toThrow();
      expect(() => validateBranchName('spec/12345678')).not.toThrow();
    });

    it('無効なブランチ名を拒否する', () => {
      expect(() => validateBranchName('feature/../main')).toThrow(BranchSwitchError);
      expect(() => validateBranchName('feature; rm -rf /')).toThrow(BranchSwitchError);
    });
  });

  describe('保護ブランチチェック', () => {
    it('main と develop への切り替えを拒否する', () => {
      expect(() => switchBranch('main')).toThrow('保護ブランチ');
      expect(() => switchBranch('develop')).toThrow('保護ブランチ');
    });
  });

  describe('ブランチ切り替え', () => {
    it('存在しないブランチへの切り替えを拒否する', () => {
      expect(() => switchBranch('nonexistent-branch')).toThrow('が見つかりません');
    });

    it('同じブランチの場合はスキップする', () => {
      const result = switchBranch('current-branch');
      expect(result.switched).toBe(false);
      expect(result.reason).toBe('Already on target branch');
    });
  });

  describe('自動コミット', () => {
    it('未コミット変更がある場合、自動コミットを実行する', () => {
      // モックで checkGitStatus() が hasChanges: true を返す
      // モックで execSync('git add .') と execSync('git commit') が成功する
      const result = switchBranch('target-branch');
      expect(result.switched).toBe(true);
    });
  });
});
```

#### E2E テスト: `tests/e2e/auto-branch-switch.test.ts`

```typescript
describe('/cft:spec-phase の自動ブランチ切り替え', () => {
  it('未コミット変更がある状態で、対象ブランチに切り替えてフェーズを変更する', async () => {
    // 1. 仕様書を作成（feature/spec-12345678 ブランチが作成される）
    // 2. develop ブランチに切り替え
    // 3. テストファイルを編集して未コミット変更を作成
    // 4. /cft:spec-phase 12345678 design を実行
    // 5. 期待: 自動コミット → feature/spec-12345678 に切り替え → フェーズ変更成功
  });

  it('未コミット変更がない状態で、対象ブランチに切り替えてフェーズを変更する', async () => {
    // 1. 仕様書を作成（feature/spec-12345678 ブランチが作成される）
    // 2. develop ブランチに切り替え
    // 3. /cft:spec-phase 12345678 design を実行
    // 4. 期待: feature/spec-12345678 に切り替え → フェーズ変更成功
  });

  it('ブランチ切り替え失敗時、エラーメッセージを表示する', async () => {
    // 1. 仕様書を作成
    // 2. データベースの branch_name を存在しないブランチ名に変更
    // 3. /cft:spec-phase 12345678 design を実行
    // 4. 期待: エラーメッセージ「ブランチ <name> が見つかりません」
  });
});
```

### 7.7 パフォーマンス設計

#### 処理時間の目標

| 処理 | 目標時間 |
|---|---|
| ブランチ名バリデーション | < 1ms |
| ブランチ存在確認 | < 100ms |
| 未コミット変更チェック | < 200ms |
| 自動コミット | < 1s |
| ブランチ切り替え | < 1s |
| **合計** | **< 3s** |

#### 最適化方針

1. **ブランチキャッシュの活用**: `getCurrentBranch()` はキャッシュされた値を返すため、追加のオーバーヘッドなし
2. **並列処理の回避**: Git コマンドは順次実行（並列実行によるコンフリクトを防止）
3. **不要な Git コマンドの削減**: ブランチ切り替え後の検証を最小限に抑える
---

## 8. 実装タスクリスト

### 8.1 コア機能実装

- [ ] **タスク 1**: 新規ファイル `src/core/git/branch-switching.ts` を作成し、`switchBranch()` 関数を実装
  - ブランチ名のバリデーション
  - 保護ブランチチェック
  - ブランチ存在確認
  - 未コミット変更チェックと自動コミット
  - ブランチ切り替え実行と検証
  - ブランチキャッシュのクリア

- [ ] **タスク 2**: ヘルパー関数を実装
  - `validateBranchName()`: ブランチ名のサニタイゼーション
  - `isProtectedBranch()`: 保護ブランチ判定
  - `branchExists()`: ブランチ存在確認
  - `autoCommitBeforeSwitch()`: 自動コミット実行

- [ ] **タスク 3**: 型定義を追加
  - `BranchSwitchResult` インターフェース
  - `BranchSwitchError` クラス

### 8.2 既存機能の修正

- [ ] **タスク 4**: `src/commands/spec/phase.ts` を修正し、ブランチ切り替えロジックを組み込む
  - `switchBranch()` のインポート
  - フェーズ変更前にブランチ切り替えを実行
  - エラーハンドリングとユーザーへの通知

### 8.3 テスト実装

- [ ] **タスク 5**: 単体テスト `tests/core/git/branch-switching.test.ts` を作成
  - ブランチ名バリデーションのテスト
  - 保護ブランチチェックのテスト
  - ブランチ切り替え成功/失敗のテスト
  - 自動コミットのテスト
  - Git 操作のモック化

- [ ] **タスク 6**: E2E テスト `tests/e2e/auto-branch-switch.test.ts` を作成
  - 未コミット変更がある状態でのブランチ切り替えテスト
  - 未コミット変更がない状態でのブランチ切り替えテスト
  - ブランチ切り替え失敗時のエラーメッセージ検証

### 8.4 統合と検証

- [ ] **タスク 7**: ドッグフーディング環境へ同期 (`npm run sync:dogfood`)
  - `src/` の変更を `.cc-craft-kit/` へコピー
  - 整合性チェック (`npm run check:sync`)

- [ ] **タスク 8**: すべてのテストを実行して動作確認
  - 単体テスト実行 (`npm test`)
  - E2E テスト実行
  - カバレッジ確認 (`npm run test:coverage`)
