# 各フェーズで仕様書を更新した際、GitHub Issue の本文が更新されない

**仕様書 ID:** d5cea6a9-94a8-49b8-a51a-f5386197bbb3
**フェーズ:** completed
**作成日時:** 2025/11/24 16:16:24
**更新日時:** 2025/11/24 17:15:29

---

## 1. 背景と目的

### 背景

現在、フェーズ遷移時（`/cft:spec-phase` コマンド実行時）に GitHub Issue の本文が最新の仕様書内容に更新されない問題があります。

**コードベース解析の結果:**

1. **`spec.updated` イベントハンドラーは正常に動作**:
   - `src/core/workflow/github-integration.ts:606-695` で Issue 本文を仕様書の最新内容に更新
   - ファイル監視（`watcher.ts`）が正常に動作し、仕様書編集時に Issue 本文が更新される

2. **`spec.phase_changed` イベントハンドラーの設計判断**:
   - `src/core/workflow/github-integration.ts:192` で「履歴保持のため」Issue 本文を更新しない設計
   - Issue タイトル、ラベル、Project ステータスのみ更新
   - フェーズ移行時に仕様書が更新されても、Issue 本文は古いまま残る

3. **問題のシナリオ**:
   - ユーザーがフェーズ遷移前に仕様書を編集（デザイン内容を追記など）
   - `/cft:spec-phase` で `design` フェーズに移行
   - Issue タイトルは `[design]` に更新されるが、本文は `requirements` フェーズの内容のまま
   - ユーザーは Issue を見ても最新の仕様書内容を確認できない

### 目的

フェーズ遷移時に GitHub Issue の本文を最新の仕様書内容に更新し、Issue を見れば常に最新状態を確認できるようにします。具体的には:

1. `spec.phase_changed` イベントハンドラーで Issue 本文を仕様書ファイルから読み込んで更新
2. `/cft:spec-phase` スラッシュコマンドの後処理で自動的に Issue を更新
3. 更新処理のテストを追加して、将来のリグレッションを防止
4. ドキュメント（README.md、QUICK_START.md）で Issue 同期の動作を明記

---

## 2. 対象ユーザー

- **cc-craft-kit を使用する開発者**: `/cft:spec-phase` コマンドでフェーズ遷移を実行し、GitHub Issue で仕様書の最新状態を確認したいユーザー
- **プロジェクト管理者**: GitHub Project ボードで Issue を管理し、最新の仕様書内容を確認したいユーザー
- **レビュアー**: GitHub Issue で仕様書の内容をレビューし、フィードバックを提供したいユーザー

---

## 3. 受け入れ基準

### 必須要件

- [ ] `spec.phase_changed` イベントハンドラーで仕様書ファイルを読み込み、Issue 本文を更新（`src/core/workflow/github-integration.ts:192-199`）
- [ ] `/cft:spec-phase` スラッシュコマンドの後処理で Issue 更新を確実に実行
- [ ] Issue 本文更新時にエラーが発生した場合、適切なエラーメッセージを表示
- [ ] 更新処理のテスト（単体テスト、統合テスト）を追加

### 機能要件

- [ ] フェーズ遷移後、GitHub Issue の本文が最新の仕様書内容に更新される
- [ ] Issue 本文更新時に「Updated spec content on phase change」というコメントを追加（オプション）
- [ ] 仕様書ファイルが存在しない場合は、Issue 本文を更新しない（エラーハンドリング）
- [ ] Issue 本文の更新結果をログに出力（`info` レベル）

### 非機能要件

- [ ] 既存のフェーズ遷移処理に影響を与えない（後方互換性）
- [ ] GitHub API のレート制限を考慮（Issue 更新は 1 回のみ）
- [ ] テストカバレッジが維持される（追加されたコードがテストでカバーされる）
- [ ] Issue 本文が大きい場合でも、GitHub API の制限（65536 文字）を超えないことを確認

---

## 4. 制約条件

- **GitHub API のレート制限**: 認証済みの場合、1 時間あたり 5000 リクエスト（Issue 更新は 1 回のみなので影響は小さい）
- **Issue 本文のサイズ制限**: GitHub API は Issue 本文を 65536 文字まで許可（仕様書ファイルがこの制限を超える場合はエラー）
- **後方互換性**: 既存のフェーズ遷移処理（タイトル、ラベル、Project ステータス更新）を維持する必要がある
- **ファイル読み込みの非同期性**: 仕様書ファイルが存在しない場合や読み込みに失敗した場合のエラーハンドリングが必要
- **テストの複雑性**: GitHub API のモック化が必要（Octokit のモック、Issue 更新の検証）

---

## 5. 依存関係

### 修正対象ファイル

1. **`src/core/workflow/github-integration.ts`** (786行)
   - `handlePhaseChange()` 関数（192-199行）を修正
   - 仕様書ファイルを読み込んで Issue 本文を更新
   - エラーハンドリングの追加

2. **`src/slash-commands/spec-phase.md`** (188行)
   - フェーズ遷移後の後処理に Issue 更新確認を追加（オプション）
   - 「GitHub Issue が最新の仕様書内容で更新されました」というメッセージを表示

3. **テストファイルの追加/更新**
   - `tests/core/workflow/github-integration.test.ts` - フェーズ変更時の Issue 本文更新テスト
   - `tests/integrations/github/sync.test.ts` - GitHub Issue 同期の統合テスト

### 関連コンポーネント

- **GitHub API ラッパー**: `src/integrations/github/issues.ts` (Issue 更新処理)
- **Issue 同期サービス**: `src/integrations/github/sync.ts` (Issue 本文の生成)
- **イベント駆動システム**: `src/core/workflow/event-bus.ts` (spec.phase_changed イベント)
- **ファイル監視**: `src/core/filesystem/watcher.ts` (spec.updated イベント発火)
- **仕様書更新コマンド**: `src/commands/spec/update.ts` (手動での Issue 更新)

---

## 6. 参考情報

### 実装パターン

- **Issue 本文の読み込み**: `readFileSync(specPath, 'utf-8')` で仕様書ファイルを読み込み
- **Issue 更新**: `issues.update({ owner, repo, issueNumber, body })` で Issue 本文を更新
- **エラーハンドリング**: `try-catch` でファイル読み込み失敗時にエラーメッセージを表示
- **ログ出力**: `logger.info()` で Issue 更新結果をログに出力

### コードベース解析結果

Explore サブエージェントで調査した結果、以下が判明しました:

1. **`spec.updated` イベントハンドラーは正常に動作**: ファイル監視時や `/cft:spec-update` 実行時に Issue 本文を更新
2. **`spec.phase_changed` イベントハンドラーの設計判断**: 「履歴保持のため」Issue 本文を更新しない設計（`github-integration.ts:192`）
3. **修正箇所**: `handlePhaseChange()` 関数で仕様書ファイルを読み込み、Issue 本文を更新する処理を追加

詳細は、Explore サブエージェントの分析レポートを参照してください。

### 修正方針の選択肢

**Option A: `spec.phase_changed` ハンドラーで Issue 本文を更新（推奨）**
- メリット: フェーズ遷移時に自動的に Issue 本文が更新される
- デメリット: 既存の設計判断（「履歴保持」）を変更する

**Option B: `/cft:spec-phase` スラッシュコマンドで `/cft:spec-update` を自動実行**
- メリット: 既存のイベントハンドラーを変更しない
- デメリット: スラッシュコマンドの後処理が複雑になる

本仕様では、Option A を推奨します。

### 既存の実装例

**`spec.updated` イベントハンドラー**（`github-integration.ts:652-657`）:
```typescript
const specContent = readFileSync(specPath, 'utf-8');

await issues.update({
  owner: githubConfig.owner,
  repo: githubConfig.repo,
  issueNumber: spec.github_issue_number,
  body: specContent,
});
```

この実装パターンを `handlePhaseChange()` 関数でも適用します。

### 関連ドキュメント

- **CLAUDE.md**: プロジェクト規約（イベント駆動アーキテクチャ）
- **src/slash-commands/spec-phase.md**: フェーズ遷移スラッシュコマンド
- **src/core/workflow/event-bus.ts**: イベント駆動システムの実装
- **GitHub API ドキュメント**: [Issues API](https://docs.github.com/en/rest/issues/issues#update-an-issue)

---

## 7. 設計詳細

### 7.1. アーキテクチャ設計

#### 既存のアーキテクチャ

現在のシステムは、イベント駆動アーキテクチャを採用しています:

```
仕様書フェーズ更新 (phase.ts)
  ↓
EventBus.emit('spec.phase_changed')
  ↓
handlePhaseChange() (github-integration.ts)
  ↓
GitHub API (Issue 更新)
```

#### 修正後のアーキテクチャ

`handlePhaseChange()` 関数に Issue 本文更新処理を追加します:

```
handlePhaseChange() (github-integration.ts:192-199)
  ↓
1. Issue タイトル・ラベル更新（既存）
  ↓
2. 仕様書ファイルを読み込み（新規）
  ↓
3. Issue 本文を更新（新規）
  ↓
4. Project ステータス更新（既存）
```

#### 処理フロー

1. **フェーズ遷移コマンド実行**: `/cft:spec-phase <spec-id> <new-phase>`
2. **イベント発火**: `spec.phase_changed` イベントを EventBus で発火
3. **Issue タイトル・ラベル更新**: 既存の処理でタイトルとラベルを更新
4. **仕様書ファイル読み込み**: `readFileSync()` で `.cc-craft-kit/specs/<spec-id>.md` を読み込み
5. **Issue 本文更新**: `issues.update()` で Issue 本文を仕様書内容で更新
6. **エラーハンドリング**: ファイル読み込み失敗時にエラーログを出力
7. **Project ステータス更新**: 既存の処理で Project ステータスを更新

### 7.2. データモデル

既存のデータモデルを使用します。変更なし。

**Spec テーブル** (`src/core/database/schema.ts`):
- `id`: UUID
- `name`: 仕様書名
- `phase`: フェーズ (`requirements`, `design`, `tasks`, `implementation`, `testing`, `completed`)
- `github_issue_number`: GitHub Issue 番号
- `updated_at`: 更新日時

### 7.3. API 設計

#### GitHub API

**Issue 更新 API** (`src/integrations/github/issues.ts`):
```typescript
interface UpdateIssueParams {
  owner: string;
  repo: string;
  issueNumber: number;
  title?: string;
  body?: string;
  state?: 'open' | 'closed';
  labels?: string[];
  assignees?: string[];
  milestone?: number | null;
}

async function update(params: UpdateIssueParams): Promise<void> {
  await octokit.rest.issues.update({
    owner: params.owner,
    repo: params.repo,
    issue_number: params.issueNumber,
    ...(params.title && { title: params.title }),
    ...(params.body && { body: params.body }),
    ...(params.state && { state: params.state }),
    ...(params.labels && { labels: params.labels }),
    ...(params.assignees && { assignees: params.assignees }),
    ...(params.milestone !== undefined && { milestone: params.milestone }),
  });
}
```

#### 修正箇所

**`handlePhaseChange()` 関数** (`src/core/workflow/github-integration.ts:192-199`):
```typescript
// 修正前
const updateParams: UpdateIssueParams = {
  owner: githubConfig.owner,
  repo: githubConfig.repo,
  issueNumber: spec.github_issue_number,
  title: `[${event.data.newPhase}] ${spec.name}`,
  labels: [`phase:${event.data.newPhase}`],
};
await issues.update(updateParams);

// 修正後
const specPath = join(ccCraftKitDir, 'specs', `${spec.id}.md`);
let body: string | undefined;

if (existsSync(specPath)) {
  try {
    body = readFileSync(specPath, 'utf-8');
  } catch (error) {
    logger.error(`Failed to read spec file: ${specPath}`, error);
  }
}

const updateParams: UpdateIssueParams = {
  owner: githubConfig.owner,
  repo: githubConfig.repo,
  issueNumber: spec.github_issue_number,
  title: `[${event.data.newPhase}] ${spec.name}`,
  labels: [`phase:${event.data.newPhase}`],
  ...(body && { body }),
};
await issues.update(updateParams);
```

### 7.4. セキュリティ考慮事項

#### GitHub API トークン

- **環境変数**: `GITHUB_TOKEN` で管理（`.env` ファイル）
- **権限**: `repo` スコープが必要（Issue の読み書き）
- **レート制限**: 認証済みの場合、1 時間あたり 5000 リクエスト

#### エラーハンドリング

- **ファイル読み込み失敗**: `try-catch` でエラーをキャッチし、ログに出力
- **GitHub API エラー**: Octokit のエラーハンドリングに依存
- **Issue 本文サイズ制限**: GitHub API は 65536 文字まで許可（事前チェックは不要）

### 7.5. テスト戦略

#### 単体テスト

**`tests/core/workflow/github-integration.test.ts`**:
- `handlePhaseChange()` が仕様書ファイルを読み込むことを検証
- Issue 本文が仕様書内容で更新されることを検証
- ファイル読み込み失敗時にエラーログが出力されることを検証

**モック化**:
- `readFileSync()`: ファイル読み込みをモック化
- `issues.update()`: GitHub API 呼び出しをモック化

#### 統合テスト

**`tests/integrations/github/sync.test.ts`**:
- フェーズ遷移時に Issue 本文が更新されることを E2E で検証
- 実際の GitHub API を使用（テスト用リポジトリ）

#### テストケース

1. **正常系**: フェーズ遷移時に Issue 本文が更新される
2. **異常系**: 仕様書ファイルが存在しない場合、エラーログが出力される
3. **異常系**: ファイル読み込みに失敗した場合、エラーログが出力される
4. **正常系**: Issue 本文が GitHub API の制限（65536 文字）以内の場合、更新される

---

## 8. 実装タスクリスト

### タスク 1: handlePhaseChange() で Issue 本文更新処理を実装

**対象ファイル**: `src/core/workflow/github-integration.ts` (192-199行)

**実装内容**:
1. 仕様書ファイルパスを生成（`join(ccCraftKitDir, 'specs', '${spec.id}.md')`）
2. `existsSync()` でファイル存在確認
3. `readFileSync()` で仕様書ファイルを読み込み
4. `updateParams` に `body` プロパティを追加
5. `issues.update()` で Issue 本文を更新

**依存関係**: なし

**優先度**: 高

---

### タスク 2: エラーハンドリングを追加

**対象ファイル**: `src/core/workflow/github-integration.ts` (192-199行)

**実装内容**:
1. `try-catch` でファイル読み込みをラップ
2. エラー発生時に `logger.error()` でログ出力
3. エラー時は Issue 本文を更新しない（タイトルとラベルのみ更新）

**依存関係**: タスク 1

**優先度**: 高

---

### タスク 3: ログ出力処理を実装

**対象ファイル**: `src/core/workflow/github-integration.ts` (192-199行)

**実装内容**:
1. Issue 本文更新成功時に `logger.info()` でログ出力
2. ログメッセージ: `Updated GitHub Issue body on phase change: #${issueNumber}`

**依存関係**: タスク 1、タスク 2

**優先度**: 中

---

### タスク 4: 単体テストを追加

**対象ファイル**: `tests/core/workflow/github-integration.test.ts`

**実装内容**:
1. `handlePhaseChange()` が仕様書ファイルを読み込むことを検証
2. Issue 本文が仕様書内容で更新されることを検証
3. ファイル読み込み失敗時にエラーログが出力されることを検証
4. モック化: `readFileSync()`, `issues.update()`

**依存関係**: タスク 1、タスク 2、タスク 3

**優先度**: 高

---

### タスク 5: 統合テストを追加

**対象ファイル**: `tests/integrations/github/sync.test.ts`

**実装内容**:
1. フェーズ遷移時に Issue 本文が更新されることを E2E で検証
2. 実際の GitHub API を使用（テスト用リポジトリ）

**依存関係**: タスク 1、タスク 2、タスク 3、タスク 4

**優先度**: 中

---

### タスク 6: 型チェックと ESLint の確認

**実行コマンド**:
- `npx tsc --noEmit`
- `npm run lint`

**実装内容**:
1. 型エラーがないことを確認
2. ESLint 警告がないことを確認
3. 必要に応じて `npm run lint:fix` で自動修正

**依存関係**: すべてのタスク

**優先度**: 高
