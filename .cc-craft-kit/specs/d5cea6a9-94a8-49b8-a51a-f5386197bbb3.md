# 各フェーズで仕様書を更新した際、GitHub Issue の本文が更新されない

**仕様書 ID:** d5cea6a9-94a8-49b8-a51a-f5386197bbb3
**フェーズ:** requirements
**作成日時:** 2025/11/24 16:16:24
**更新日時:** 2025/11/24 16:16:24

---

## 1. 背景と目的

### 背景

現在、フェーズ遷移時（`/cft:spec-phase` コマンド実行時）に GitHub Issue の本文が最新の仕様書内容に更新されない問題があります。

**コードベース解析の結果:**

1. **`spec.updated` イベントハンドラーは正常に動作**:
   - `src/core/workflow/github-integration.ts:606-695` で Issue 本文を仕様書の最新内容に更新
   - ファイル監視（`watcher.ts`）が正常に動作し、仕様書編集時に Issue 本文が更新される

2. **`spec.phase_changed` イベントハンドラーの設計判断**:
   - `src/core/workflow/github-integration.ts:192` で「履歴保持のため」Issue 本文を更新しない設計
   - Issue タイトル、ラベル、Project ステータスのみ更新
   - フェーズ移行時に仕様書が更新されても、Issue 本文は古いまま残る

3. **問題のシナリオ**:
   - ユーザーがフェーズ遷移前に仕様書を編集（デザイン内容を追記など）
   - `/cft:spec-phase` で `design` フェーズに移行
   - Issue タイトルは `[design]` に更新されるが、本文は `requirements` フェーズの内容のまま
   - ユーザーは Issue を見ても最新の仕様書内容を確認できない

### 目的

フェーズ遷移時に GitHub Issue の本文を最新の仕様書内容に更新し、Issue を見れば常に最新状態を確認できるようにします。具体的には:

1. `spec.phase_changed` イベントハンドラーで Issue 本文を仕様書ファイルから読み込んで更新
2. `/cft:spec-phase` スラッシュコマンドの後処理で自動的に Issue を更新
3. 更新処理のテストを追加して、将来のリグレッションを防止
4. ドキュメント（README.md、QUICK_START.md）で Issue 同期の動作を明記

---

## 2. 対象ユーザー

- **cc-craft-kit を使用する開発者**: `/cft:spec-phase` コマンドでフェーズ遷移を実行し、GitHub Issue で仕様書の最新状態を確認したいユーザー
- **プロジェクト管理者**: GitHub Project ボードで Issue を管理し、最新の仕様書内容を確認したいユーザー
- **レビュアー**: GitHub Issue で仕様書の内容をレビューし、フィードバックを提供したいユーザー

---

## 3. 受け入れ基準

### 必須要件

- [ ] `spec.phase_changed` イベントハンドラーで仕様書ファイルを読み込み、Issue 本文を更新（`src/core/workflow/github-integration.ts:192-199`）
- [ ] `/cft:spec-phase` スラッシュコマンドの後処理で Issue 更新を確実に実行
- [ ] Issue 本文更新時にエラーが発生した場合、適切なエラーメッセージを表示
- [ ] 更新処理のテスト（単体テスト、統合テスト）を追加

### 機能要件

- [ ] フェーズ遷移後、GitHub Issue の本文が最新の仕様書内容に更新される
- [ ] Issue 本文更新時に「Updated spec content on phase change」というコメントを追加（オプション）
- [ ] 仕様書ファイルが存在しない場合は、Issue 本文を更新しない（エラーハンドリング）
- [ ] Issue 本文の更新結果をログに出力（`info` レベル）

### 非機能要件

- [ ] 既存のフェーズ遷移処理に影響を与えない（後方互換性）
- [ ] GitHub API のレート制限を考慮（Issue 更新は 1 回のみ）
- [ ] テストカバレッジが維持される（追加されたコードがテストでカバーされる）
- [ ] Issue 本文が大きい場合でも、GitHub API の制限（65536 文字）を超えないことを確認

---

## 4. 制約条件

- **GitHub API のレート制限**: 認証済みの場合、1 時間あたり 5000 リクエスト（Issue 更新は 1 回のみなので影響は小さい）
- **Issue 本文のサイズ制限**: GitHub API は Issue 本文を 65536 文字まで許可（仕様書ファイルがこの制限を超える場合はエラー）
- **後方互換性**: 既存のフェーズ遷移処理（タイトル、ラベル、Project ステータス更新）を維持する必要がある
- **ファイル読み込みの非同期性**: 仕様書ファイルが存在しない場合や読み込みに失敗した場合のエラーハンドリングが必要
- **テストの複雑性**: GitHub API のモック化が必要（Octokit のモック、Issue 更新の検証）

---

## 5. 依存関係

### 修正対象ファイル

1. **`src/core/workflow/github-integration.ts`** (786行)
   - `handlePhaseChange()` 関数（192-199行）を修正
   - 仕様書ファイルを読み込んで Issue 本文を更新
   - エラーハンドリングの追加

2. **`src/slash-commands/spec-phase.md`** (188行)
   - フェーズ遷移後の後処理に Issue 更新確認を追加（オプション）
   - 「GitHub Issue が最新の仕様書内容で更新されました」というメッセージを表示

3. **テストファイルの追加/更新**
   - `tests/core/workflow/github-integration.test.ts` - フェーズ変更時の Issue 本文更新テスト
   - `tests/integrations/github/sync.test.ts` - GitHub Issue 同期の統合テスト

### 関連コンポーネント

- **GitHub API ラッパー**: `src/integrations/github/issues.ts` (Issue 更新処理)
- **Issue 同期サービス**: `src/integrations/github/sync.ts` (Issue 本文の生成)
- **イベント駆動システム**: `src/core/workflow/event-bus.ts` (spec.phase_changed イベント)
- **ファイル監視**: `src/core/filesystem/watcher.ts` (spec.updated イベント発火)
- **仕様書更新コマンド**: `src/commands/spec/update.ts` (手動での Issue 更新)

---

## 6. 参考情報

### 実装パターン

- **Issue 本文の読み込み**: `readFileSync(specPath, 'utf-8')` で仕様書ファイルを読み込み
- **Issue 更新**: `issues.update({ owner, repo, issueNumber, body })` で Issue 本文を更新
- **エラーハンドリング**: `try-catch` でファイル読み込み失敗時にエラーメッセージを表示
- **ログ出力**: `logger.info()` で Issue 更新結果をログに出力

### コードベース解析結果

Explore サブエージェントで調査した結果、以下が判明しました:

1. **`spec.updated` イベントハンドラーは正常に動作**: ファイル監視時や `/cft:spec-update` 実行時に Issue 本文を更新
2. **`spec.phase_changed` イベントハンドラーの設計判断**: 「履歴保持のため」Issue 本文を更新しない設計（`github-integration.ts:192`）
3. **修正箇所**: `handlePhaseChange()` 関数で仕様書ファイルを読み込み、Issue 本文を更新する処理を追加

詳細は、Explore サブエージェントの分析レポートを参照してください。

### 修正方針の選択肢

**Option A: `spec.phase_changed` ハンドラーで Issue 本文を更新（推奨）**
- メリット: フェーズ遷移時に自動的に Issue 本文が更新される
- デメリット: 既存の設計判断（「履歴保持」）を変更する

**Option B: `/cft:spec-phase` スラッシュコマンドで `/cft:spec-update` を自動実行**
- メリット: 既存のイベントハンドラーを変更しない
- デメリット: スラッシュコマンドの後処理が複雑になる

本仕様では、Option A を推奨します。

### 既存の実装例

**`spec.updated` イベントハンドラー**（`github-integration.ts:652-657`）:
```typescript
const specContent = readFileSync(specPath, 'utf-8');

await issues.update({
  owner: githubConfig.owner,
  repo: githubConfig.repo,
  issueNumber: spec.github_issue_number,
  body: specContent,
});
```

この実装パターンを `handlePhaseChange()` 関数でも適用します。

### 関連ドキュメント

- **CLAUDE.md**: プロジェクト規約（イベント駆動アーキテクチャ）
- **src/slash-commands/spec-phase.md**: フェーズ遷移スラッシュコマンド
- **src/core/workflow/event-bus.ts**: イベント駆動システムの実装
- **GitHub API ドキュメント**: [Issues API](https://docs.github.com/en/rest/issues/issues#update-an-issue)
