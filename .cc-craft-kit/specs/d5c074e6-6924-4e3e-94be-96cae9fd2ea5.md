# フェーズおよび Issue ステータスの見直し

**仕様書 ID:** d5c074e6-6924-4e3e-94be-96cae9fd2ea5
**フェーズ:** implementation
**作成日時:** 2025/12/04 18:30:00
**更新日時:** 2025/12/04 20:15:00

---

## 1. 背景と目的

### 背景

GitHub Projects の Issue のステータス遷移を以下のように見直したい。

1. /cft:spec-create → Todo
2. /cft:spec-phase <id> design → In Progress
3. /cft:spec-phase <id> implementation → In Progress
4. /cft:spec-phase <id> completed → In Review
5. /cft:pr-cleanup → Done

なお、completed フェーズで In Review となるのは違和感があるので、PR を作成してレビュー待ちである「In Review」を表現する新たなフェーズを設けたい。

さらに、/cft:pr-cleanup コマンドは、completed フェーズで行うこととしたい。

1. /cft:spec-create → Todo
2. /cft:spec-phase <id> design → In Progress
3. /cft:spec-phase <id> implementation → In Progress
4. /cft:spec-phase <id> xxx → In Review（従来の /cft:phase <id> completed の処理）
5. /cft:spec-phase <id> completed → Done（従来の /cft:pr-cleanup の処理）

### 目的

フェーズと GitHub Projects Issue ステータスの対応関係を見直し、より直感的で実態に即したワークフローを実現する。特に「レビュー待ち」状態を明確に表現する新フェーズを追加し、pr-cleanup の処理を completed フェーズに統合する。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発（SDD）を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] 新フェーズ「review」（仮称）を追加し、PR 作成後のレビュー待ち状態を表現できること
- [ ] フェーズと GitHub Projects ステータスのマッピングが以下の通りであること:
  - requirements → Todo
  - design → In Progress
  - implementation → In Progress
  - review（新規） → In Review
  - completed → Done
- [ ] completed フェーズへの遷移時に、従来の pr-cleanup の処理（ブランチ削除、DB 更新）が実行されること

### 機能要件

- [ ] `/cft:spec-phase <id> review` コマンドで review フェーズに遷移できること
- [ ] review フェーズでは従来の completed フェーズの処理（Issue クローズ以外）が実行されること
- [ ] `/cft:spec-phase <id> completed` コマンドで従来の pr-cleanup の処理が実行されること
- [ ] `/cft:pr-cleanup` コマンドは廃止または completed フェーズへのエイリアスとすること
- [ ] フェーズ省略形（rev, r など）をサポートすること

### 非機能要件

- [ ] 既存の仕様書との後方互換性を維持すること
- [ ] フェーズ遷移のバリデーションルールを更新すること

---

## 4. 制約条件

- フェーズ定義は `src/core/database/schema.ts` の `SpecPhase` 型に追加が必要
- GitHub Projects ステータスマッピングは `src/core/config/github-status-config.ts` で管理
- イベント駆動アーキテクチャ（EventBus）を維持すること
- 既存の 4 段階ステータス（Todo, In Progress, In Review, Done）を前提とする

---

## 5. 依存関係

### 関連ファイル

- `src/core/database/schema.ts` - SpecPhase 型定義
- `src/core/config/github-status-config.ts` - ステータスマッピング設定
- `src/core/workflow/phase-mapping.ts` - フェーズ省略形マッピング
- `src/commands/spec/phase.ts` - spec-phase コマンド実装
- `src/core/workflow/github-integration.ts` - GitHub 連携イベントハンドラー
- `src/integrations/github/pr-cleanup.ts` - PR クリーンアップ処理
- `src/commands/github/pr-cleanup.ts` - pr-cleanup コマンド
- `src/core/workflow/phase-transition-validator.ts` - フェーズ遷移バリデーション

---

## 6. 参考情報

- 現在のフェーズ定義: `'requirements' | 'design' | 'tasks' | 'implementation' | 'completed'`
- tasks フェーズは非推奨（後方互換性のため残存）
- フェーズ→ステータスマッピングは `config.json` でカスタマイズ可能

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
┌─────────────────────────────────────────────────────────────────┐
│                        フェーズ遷移フロー                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  requirements ─→ design ─→ implementation ─→ review ─→ completed │
│      │              │            │             │          │      │
│      ↓              ↓            ↓             ↓          ↓      │
│    Todo      In Progress   In Progress    In Review     Done    │
│                                                                 │
│  (GitHub Projects ステータス)                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 設計方針

1. **新フェーズ「review」の追加**
   - `implementation` と `completed` の間に `review` フェーズを挿入
   - `review` フェーズは PR 作成後のコードレビュー待ち状態を表現
   - GitHub Projects ステータスは「In Review」にマッピング

2. **completed フェーズの再定義**
   - `completed` フェーズは最終的な完了状態を表現
   - 従来の `pr-cleanup` 処理を `completed` フェーズ遷移時に統合
   - GitHub Projects ステータスは「Done」にマッピング

3. **イベント駆動アーキテクチャの維持**
   - `spec.phase_changed` イベントで GitHub 連携を実行
   - `completed` フェーズ遷移時に `spec.pr_merged` 相当の処理を実行

#### 処理フロー詳細

**review フェーズへの遷移時（implementation → review）:**

```
1. フェーズバリデーション
   └─ 実装タスクがすべて完了していることを確認

2. DB 更新
   └─ specs.phase = 'review'

3. イベント発火（spec.phase_changed）
   ├─ GitHub Issue ラベル更新（phase:review）
   ├─ GitHub Projects ステータス更新（In Review）
   └─ PR 作成（pr-creator スキル実行）

4. 自動コミット
   └─ 仕様書ファイル更新
```

**completed フェーズへの遷移時（review → completed）:**

```
1. フェーズバリデーション
   └─ PR がマージ済みであることを確認

2. pr-cleanup 処理実行
   ├─ ローカルブランチ削除
   ├─ リモートブランチ削除
   └─ DB 更新（branch_name をベースブランチに）

3. DB 更新
   └─ specs.phase = 'completed'

4. イベント発火（spec.phase_changed）
   ├─ GitHub Issue ラベル更新（phase:completed）
   ├─ GitHub Projects ステータス更新（Done）
   └─ GitHub Issue クローズ

5. 自動コミット
   └─ 仕様書ファイル更新
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/core/database/schema.ts` | SpecPhase 型に `'review'` を追加 |
| `src/core/config/github-status-config.ts` | StatusMapping に review エントリを追加、completed を Done に変更 |
| `src/core/workflow/phase-mapping.ts` | PHASE_ALIASES に review 省略形を追加 |
| `src/core/workflow/phase-transition-validator.ts` | review フェーズ遷移ルールを追加 |
| `src/core/workflow/github-integration.ts` | review/completed フェーズ固有処理を追加 |
| `src/commands/spec/phase.ts` | review フェーズのガイダンスを追加 |
| `src/commands/github/pr-cleanup.ts` | 廃止警告を追加、completed フェーズへのエイリアス化 |
| `.cc-craft-kit/commands/spec/phase.md` | review フェーズの後処理を追加 |

#### 新規作成ファイル

なし（既存ファイルの修正のみ）

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| PR 作成 | completed フェーズで実行 | review フェーズで実行 | `phase.md`（Step 8） |
| Issue クローズ | completed フェーズで実行 | completed フェーズで実行（変更なし） | `github-integration.ts` |
| ブランチ削除 | pr-cleanup コマンドで実行 | completed フェーズで自動実行 | `github-integration.ts` |
| Projects ステータス更新 | completed → In Review | review → In Review, completed → Done | `github-status-config.ts` |
| pr-cleanup コマンド | 独立コマンド | 廃止（completed へのエイリアス） | `pr-cleanup.ts` |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| SpecPhase 型 | review が有効なフェーズとして認識される | 型チェック |
| StatusMapping | review → In Review, completed → Done のマッピング | ユニットテスト |
| PHASE_ALIASES | rev, review が review フェーズに正規化される | ユニットテスト |
| フェーズ遷移 | implementation → review → completed の遷移が可能 | 統合テスト |
| GitHub 連携 | review フェーズで Projects ステータスが In Review に更新 | E2E テスト |
| ブランチ削除 | completed フェーズで自動的にブランチ削除 | E2E テスト |
| 後方互換性 | 既存仕様書が正常に動作する | 回帰テスト |

### 7.5 移行計画

#### Phase 1: 型定義・マッピング更新

1. SpecPhase 型に `'review'` を追加
2. StatusMapping インターフェースに review エントリを追加
3. DEFAULT_STATUS_MAPPING を更新（review: In Review, completed: Done）
4. PHASE_ALIASES に review 省略形を追加

#### Phase 2: フェーズ遷移ロジック更新

1. phase-transition-validator.ts に review フェーズ遷移ルールを追加
2. github-integration.ts に review/completed フェーズ固有処理を追加
3. phase.ts に review フェーズのガイダンスを追加

#### Phase 3: コマンド統合

1. phase.md の Step 8 を更新（review フェーズで PR 作成）
2. completed フェーズで pr-cleanup 処理を実行するロジックを追加
3. pr-cleanup.ts に廃止警告を追加

#### Phase 4: 動作確認・ドキュメント更新

1. npm run typecheck && npm run lint でエラーがないことを確認
2. 手動テストで review → completed の遷移を確認
3. README.md やドキュメントを更新

---

## 8. 実装タスクリスト

### Phase 1: 型定義・マッピング更新

- [x] SpecPhase 型に 'review' を追加（schema.ts） (#621)
- [x] StatusMapping インターフェースに review エントリを追加（github-status-config.ts） (#622)
- [x] DEFAULT_STATUS_MAPPING を更新（review: In Review, completed: Done） (#623)
- [x] validateStatusConfig の requiredPhases に review を追加 (#624)
- [x] PHASE_ALIASES に review 省略形（rev）を追加（phase-mapping.ts） (#625)

### Phase 2: フェーズ遷移ロジック更新

- [x] implementation → review の遷移ルールを追加（phase-transition-validator.ts） (#626)
- [x] review → completed の遷移ルールを追加（PR マージ済み確認） (#627)
- [x] review フェーズ遷移時の GitHub 連携処理を追加（github-integration.ts） (#628)
- [x] completed フェーズ遷移時に pr-cleanup 処理を統合（github-integration.ts） (#629)
- [ ] phase.ts に review フェーズのガイダンスを追加 (#630)

### Phase 3: コマンド統合

- [ ] phase.md の Step 8 を更新（review フェーズで PR 作成） (#631)
- [ ] pr-cleanup.ts に廃止警告と completed フェーズへの誘導を追加 (#632)

### Phase 4: 動作確認

- [ ] npm run typecheck && npm run lint でエラーがないことを確認 (#633)
- [ ] npm run sync:dogfood で変更を同期 (#634)
