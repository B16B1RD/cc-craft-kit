# /cft:spec-phase \<id\> design 完了時、仕様書のコミットがされていない

**仕様書 ID:** bf2faf6a-3c63-47d6-8d49-35e242135878
**フェーズ:** design
**作成日時:** 2025/11/22 16:10:01
**更新日時:** 2025/11/22 17:00:24

---

## 1. 背景と目的

### 背景

cc-craft-kit では、`/cft:spec-phase <id> <phase>` コマンドでフェーズを移行する際、自動的に Git コミットを実行する機能が実装されています（Git 自動コミット機能）。しかし、design フェーズへの移行時にコミットが実行されず、仕様書ファイルの変更が未コミット状態のまま残る問題が報告されています。

他のフェーズ（requirements、tasks、implementation）でも同様の問題が発生している可能性があるため、包括的な検証が必要です。

**既知の動作:**

- `spec.phase_changed` イベントが発火し、`handlePhaseChangeCommit()` が呼び出される
- 未コミット変更がない場合、スキップメッセージが表示される
- pre-commit フック失敗時、ステージングがロールバックされる

**問題の症状:**

- design フェーズ移行時、仕様書ファイルが未コミット状態のまま残る
- 自動コミット成功メッセージが表示されない

### 目的

すべてのフェーズ移行時に、仕様書ファイルの変更が適切に Git コミットされることを保証し、開発者がコミット漏れにより発生するバージョン管理の問題を防止します。

---

## 2. 対象ユーザー

- cc-craft-kit を使用する開発者
- 仕様駆動開発（SDD）ワークフローを実践するチーム
- Git でバージョン管理するプロジェクト

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-phase <id> design` 実行時、仕様書ファイルが自動コミットされること
- [ ] `/cft:spec-phase <id> tasks` 実行時、仕様書ファイルが自動コミットされること
- [ ] `/cft:spec-phase <id> implementation` 実行時、仕様書ファイルが自動コミットされること
- [ ] `/cft:spec-phase <id> completed` 実行時、全変更ファイルが自動コミットされること
- [ ] requirements フェーズでも同様にコミットが実行されること

### 機能要件

- [ ] コミットメッセージがフェーズに応じた適切な内容であること（例: `feat: <仕様書名> の設計を完了`）
- [ ] 既存の Git 自動コミット機能（`src/core/workflow/git-integration.ts`）を利用すること
- [ ] コミット失敗時、エラーログを記録し、手動コミット手順をユーザーに案内すること
- [ ] 未コミット変更がない場合、コミットをスキップすること（無駄なコミット防止）
- [ ] pre-commit フック失敗時、ステージングを自動ロールバックすること（`git reset HEAD`）

### 非機能要件

- [ ] Git リポジトリ未初期化時でもエラーで停止せず、警告のみ表示すること
- [ ] コミット失敗時もフェーズ移行は成功すること（ユーザー操作を妨げない）
- [ ] 単体テストで各フェーズ移行時のコミット動作を検証すること
- [ ] E2E テストでフェーズ移行からコミット成功までの一連の動作を検証すること

---

## 4. 制約条件

- `src/core/workflow/git-integration.ts` の既存ロジック（`handlePhaseChangeCommit()`）を再利用すること
- Git コマンド実行は `execSync()` または `spawnSync()` を使用すること（非同期処理は避ける）
- pre-commit フック失敗時は、ステージングをロールバックすること（`git reset HEAD`）
- completed フェーズ以外では、仕様書ファイルのみをコミット対象とすること
- completed フェーズでは、全変更ファイル（`git add .`）をコミット対象とすること
- コミット対象ファイルが `.gitignore` で除外されている場合、コミットをスキップすること

---

## 5. 依存関係

- `src/core/workflow/git-integration.ts` - Git 自動コミット機能の実装
  - `handlePhaseChangeCommit()` - フェーズ変更時の自動コミット処理 (259-344 行目)
  - `generateCommitMessage()` - コミットメッセージ生成 (126-135 行目)
  - `getCommitTargets()` - コミット対象ファイルの決定 (167-184 行目)
  - `gitCommit()` - Git コミット実行 (192-254 行目)
  - `hasUncommittedChanges()` - 未コミット変更のチェック (113-121 行目)
- `src/core/workflow/event-bus.ts` - `spec.phase_changed` イベントのハンドラー登録
- `src/commands/spec/phase.ts` - `/cft:spec-phase` コマンド実装
- `tests/core/workflow/git-integration.test.ts` - 単体テスト

---

## 6. 参考情報

- CLAUDE.md: Git 自動コミット機能のセクション
- `src/core/workflow/git-integration.ts:259-344` - 既存の `handlePhaseChangeCommit()` 実装
- `src/core/workflow/git-integration.ts:126-135` - コミットメッセージ生成ロジック
- GitHub Issue: #277
