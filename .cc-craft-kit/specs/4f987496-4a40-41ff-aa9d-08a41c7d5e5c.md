# /cft:spec-create でブランチが作成されない

**仕様書 ID:** 4f987496-4a40-41ff-aa9d-08a41c7d5e5c
**フェーズ:** completed
**作成日時:** 2025/11/20 19:54:35
**更新日時:** 2025/11/20 20:22:49

---

## 1. 背景と目的

### 背景

現在、`/cft:spec-create` コマンドを実行した際に、以下の問題が確認されています。

**問題:**

- 保護ブランチ（main, develop）では仕様書作成時にブランチを作成しないことは期待通りの動作
- しかし、feature ブランチなど、保護されていないブランチでもブランチを作成しないケースが報告されている

**現在の実装の想定動作:**

- 仕様書作成時、自動的に `spec/<仕様書IDの先頭8文字>` 形式のブランチが作成される
- 保護ブランチ（main, develop）ではブランチ作成をスキップする

**実際の動作:**

- 保護ブランチ以外でもブランチを作成しない場合がある

### 目的

`/cft:spec-create` コマンド実行時のブランチ作成ロジックを検証し、以下を達成する。

1. **保護ブランチの正確な検出**: 環境変数 `PROTECTED_BRANCHES` および Git のデフォルトブランチを正しく識別する
2. **非保護ブランチでのブランチ作成保証**: feature ブランチなどでは確実にブランチが作成されるようにする
3. **エラーハンドリングの改善**: ブランチ作成失敗時に適切なエラーメッセージを表示し、ロールバックを実行する
4. **テストカバレッジの拡充**: E2E テストで保護ブランチ・非保護ブランチの両方をカバーする

---

## 2. 対象ユーザー

cc-craft-kit を使用するすべての開発者。

特に以下のシナリオで影響を受けます。

- feature ブランチから新しい仕様書を作成する開発者。
- main または develop ブランチから仕様書を作成する開発者（期待通りの動作を確認）。
- CI/CD 環境で自動的に仕様書を作成するスクリプト。

---

## 3. 受け入れ基準

### 必須要件

- [ ] 保護ブランチ（main, develop, または環境変数 `PROTECTED_BRANCHES` で指定されたブランチ）で `/cft:spec-create` を実行した場合、ブランチが作成されないこと
- [ ] 非保護ブランチ（feature/*, fix/*, refactor/* など）で `/cft:spec-create` を実行した場合、`spec/<仕様書IDの先頭8文字>` 形式のブランチが作成されること
- [ ] ブランチ作成失敗時に適切なエラーメッセージが表示され、データベースレコードとファイルがロールバックされること

### 機能要件

- [ ] 保護ブランチの検出ロジックを実装（環境変数 `PROTECTED_BRANCHES` の読み取り）
- [ ] Git デフォルトブランチの自動検出（`git symbolic-ref refs/remotes/origin/HEAD` の結果を使用）
- [ ] ブランチ作成コマンド（`git checkout -b spec/<id>`）の実行成功を検証
- [ ] ブランチ作成失敗時のロールバック処理を実装（データベースレコード削除、ファイル削除、元のブランチに戻る）

### 非機能要件

- [ ] ブランチ作成処理のパフォーマンス劣化がないこと（1 秒以内に完了）
- [ ] E2E テストで以下のシナリオをカバーすること：
  - main ブランチから仕様書作成（ブランチ未作成を確認）
  - develop ブランチから仕様書作成（ブランチ未作成を確認）
  - feature ブランチから仕様書作成（ブランチ作成を確認）
- [ ] ログレベル `info` でブランチ作成の成功/スキップを記録すること

---

## 4. 制約条件

- Git リポジトリが初期化されていること（`.git` ディレクトリが存在）
- ブランチ作成権限があること（リモートリポジトリへのプッシュ権限は不要）
- 環境変数 `PROTECTED_BRANCHES` はカンマ区切りで複数指定可能（デフォルト: `main,develop`）
- ブランチ名の最大長は Git の制約に従う（通常 255 文字）
- 同名のブランチが既に存在する場合、エラーとして扱う

---

## 5. 依存関係

- `src/commands/spec/create.ts` - 仕様書作成コマンドの実装
- `src/core/git/branch-cache.ts` - 現在のブランチ名の取得
- `src/core/database/connection.ts` - データベース接続
- `src/core/errors/index.ts` - エラーハンドリング
- Git コマンド（`git checkout`, `git branch`, `git symbolic-ref`）の実行環境

---

## 6. 参考情報

- [CLAUDE.md - ブランチ管理](./CLAUDE.md#ブランチ管理)
- [src/commands/spec/create.ts](../src/commands/spec/create.ts) - 現在の実装
- Git ブランチ管理のベストプラクティス: <https://git-scm.com/book/ja/v2/Git-%E3%81%AE%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81%E6%A9%9F%E8%83%BD-%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81%E3%81%A8%E3%81%AF>

---

## 7. 設計

### 7.1. 現在の実装の問題点

`src/commands/spec/create.ts` の 140 行目〜172 行目のブランチ作成ロジックを分析した結果、以下の問題が確認されました。

**ブランチ作成ロジック（現在の実装）:**

```typescript
try {
  // Git リポジトリの存在確認
  execSync('git rev-parse --is-inside-work-tree', { stdio: 'ignore' });

  // 現在のブランチ名を取得
  originalBranch = getCurrentBranch();

  // 保護ブランチチェック
  const protectedBranches = (process.env.PROTECTED_BRANCHES || 'main,develop').split(',');
  if (protectedBranches.includes(originalBranch)) {
    console.log(formatInfo(`保護ブランチ ${originalBranch} では仕様書作成時にブランチを作成しません。`, options.color));
  } else {
    // ブランチ作成
    execSync(`git checkout -b ${branchName}`, { stdio: 'inherit' });
    branchCreated = true;
    console.log(formatInfo(`Created new branch: ${branchName}`, options.color));
  }
} catch {
  // Git リポジトリ未初期化、またはその他のエラー
  console.log(formatInfo('ブランチ作成に失敗しました。仕様書はブランチなしで作成されます。', options.color));
}
```

**問題点:**

1. **過度に広い catch ブロック**: すべてのエラーを catch しているため、以下が区別できない。
   - Git リポジトリ未初期化
   - 保護ブランチの検出失敗
   - ブランチ作成コマンド失敗（権限不足、同名ブランチ存在など）

2. **エラーメッセージの不明確さ**:「ブランチ作成に失敗しました」という汎用的なメッセージのみで、原因が特定できない。

3. **ブランチ作成コマンドの検証不足**: `execSync()` が成功しても、ブランチが実際に作成されたかを確認していない。

4. **ロールバック処理の不完全性**: ブランチ作成失敗時、`branchCreated` フラグが false のままになるため、ロールバック処理でブランチ削除がスキップされる。

### 7.2. 改善案

#### 7.2.1. エラーハンドリングの細分化

```typescript
// ブランチ作成処理を細分化
try {
  // 1. Git リポジトリの存在確認
  execSync('git rev-parse --is-inside-work-tree', { stdio: 'ignore' });
} catch {
  console.log(formatInfo('Git リポジトリが初期化されていません。ブランチ作成をスキップします。', options.color));
  return; // 早期リターン
}

try {
  // 2. 現在のブランチ名を取得
  originalBranch = getCurrentBranch();
} catch (error) {
  console.error(formatInfo('現在のブランチ名の取得に失敗しました。', options.color));
  throw error;
}

// 3. 保護ブランチチェック
const protectedBranches = (process.env.PROTECTED_BRANCHES || 'main,develop').split(',');
if (protectedBranches.includes(originalBranch)) {
  console.log(formatInfo(`保護ブランチ ${originalBranch} では仕様書作成時にブランチを作成しません。`, options.color));
  return; // 早期リターン
}

try {
  // 4. ブランチ作成
  execSync(`git checkout -b ${branchName}`, { stdio: 'pipe' });

  // 5. ブランチ作成の検証
  const currentBranch = execSync('git rev-parse --abbrev-ref HEAD', { encoding: 'utf-8' }).trim();
  if (currentBranch !== branchName) {
    throw new Error(`ブランチ作成に失敗しました。期待: ${branchName}, 実際: ${currentBranch}`);
  }

  branchCreated = true;
  console.log(formatInfo(`Created new branch: ${branchName}`, options.color));
} catch (error) {
  console.error(formatInfo(`ブランチ作成に失敗しました: ${error.message}`, options.color));
  throw error; // 上位でロールバック処理を実行
}
```

#### 7.2.2. ブランチ作成ロジックの関数化

`src/core/git/branch-creation.ts` として新規ファイルを作成し、ブランチ作成ロジックを独立させる。

```typescript
export interface BranchCreationResult {
  created: boolean;
  branchName: string | null;
  originalBranch: string | null;
  reason?: string; // スキップされた理由
}

export async function createSpecBranch(specId: string): Promise<BranchCreationResult> {
  const shortSpecId = specId.substring(0, 8);
  const branchName = `spec/${shortSpecId}`;

  // 1. Git リポジトリの存在確認
  try {
    execSync('git rev-parse --is-inside-work-tree', { stdio: 'ignore' });
  } catch {
    return { created: false, branchName: null, originalBranch: null, reason: 'Git リポジトリが初期化されていません' };
  }

  // 2. 現在のブランチ名を取得
  const originalBranch = getCurrentBranch();

  // 3. 保護ブランチチェック
  const protectedBranches = (process.env.PROTECTED_BRANCHES || 'main,develop').split(',');
  if (protectedBranches.includes(originalBranch)) {
    return { created: false, branchName: null, originalBranch, reason: `保護ブランチ ${originalBranch} ではブランチを作成しません` };
  }

  // 4. ブランチ作成
  try {
    execSync(`git checkout -b ${branchName}`, { stdio: 'pipe' });

    // 5. ブランチ作成の検証
    const currentBranch = execSync('git rev-parse --abbrev-ref HEAD', { encoding: 'utf-8' }).trim();
    if (currentBranch !== branchName) {
      throw new Error(`ブランチ作成に失敗しました。期待: ${branchName}, 実際: ${currentBranch}`);
    }

    return { created: true, branchName, originalBranch };
  } catch (error) {
    throw new Error(`ブランチ作成に失敗しました: ${error.message}`);
  }
}
```

#### 7.2.3. E2E テストの追加

`tests/e2e/spec-create-branch.test.ts` として新規ファイルを作成し、以下のシナリオをテストする。

**テストケース:**

1. **main ブランチから仕様書作成**: ブランチ未作成を確認
2. **develop ブランチから仕様書作成**: ブランチ未作成を確認
3. **feature ブランチから仕様書作成**: ブランチ作成を確認
4. **ブランチ作成失敗時のロールバック**: データベースレコードとファイルが削除されることを確認
5. **Git リポジトリ未初期化**: エラーメッセージが表示され、仕様書作成が継続されることを確認

### 7.3. 実装計画

#### フェーズ 1: ブランチ作成ロジックの関数化

- `src/core/git/branch-creation.ts` を新規作成
- `createSpecBranch()` 関数を実装
- `src/commands/spec/create.ts` から呼び出し

#### フェーズ 2: エラーハンドリングの改善

- `createSpecBranch()` のエラーハンドリングを細分化
- 各エラーケースで適切なメッセージを表示
- ロールバック処理の改善

#### フェーズ 3: E2E テストの追加

- `tests/e2e/spec-create-branch.test.ts` を新規作成
- 保護ブランチ・非保護ブランチのシナリオをテスト
- ロールバック処理のテスト

#### フェーズ 4: ドキュメント更新

- CLAUDE.md のブランチ管理セクションを更新
- 保護ブランチの設定方法を明記

---

## 8. 実装タスクリスト

### フェーズ 1: ブランチ作成ロジックの関数化

- [ ] `src/core/git/branch-creation.ts` を新規作成し、`createSpecBranch()` 関数を実装
- [ ] `createSpecBranch()` 関数で Git リポジトリの存在確認ロジックを実装
- [ ] 保護ブランチ検出ロジックを実装（環境変数 `PROTECTED_BRANCHES` の読み取り）
- [ ] ブランチ作成コマンドの実行と検証を実装
- [ ] エラーハンドリングと明確な結果オブジェクトの返却を実装
- [ ] `src/commands/spec/create.ts` から `createSpecBranch()` を呼び出すように修正

### フェーズ 2: エラーハンドリングの改善

- [ ] ブランチ作成失敗時のロールバック処理を改善

### フェーズ 3: E2E テストの追加

- [ ] `tests/e2e/spec-create-branch.test.ts` を新規作成（保護ブランチでの非作成テスト）
- [ ] 非保護ブランチでのブランチ作成テストを追加
- [ ] ブランチ作成失敗時のロールバックテストを追加
- [ ] Git リポジトリ未初期化時の処理テストを追加
- [ ] すべてのテストを実行して成功を確認

### フェーズ 4: ドキュメント更新

- [ ] CLAUDE.md のブランチ管理セクションを更新

---

**実装優先度:**

1. **高**: フェーズ 1（ブランチ作成ロジックの関数化）
2. **高**: フェーズ 2（エラーハンドリングの改善）
3. **中**: フェーズ 3（E2E テストの追加）
4. **低**: フェーズ 4（ドキュメント更新）
