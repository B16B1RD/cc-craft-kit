# /cft:spec-create でブランチが作成されない

**仕様書 ID:** 4f987496-4a40-41ff-aa9d-08a41c7d5e5c
**フェーズ:** design
**作成日時:** 2025/11/20 19:54:35
**更新日時:** 2025/11/20 19:57:17

---

## 1. 背景と目的

### 背景

現在、`/cft:spec-create` コマンドを実行した際に、以下の問題が確認されています。

**問題:**

- 保護ブランチ（main, develop）では仕様書作成時にブランチを作成しないことは期待通りの動作
- しかし、feature ブランチなど、保護されていないブランチでもブランチを作成しないケースが報告されている

**現在の実装の想定動作:**

- 仕様書作成時、自動的に `spec/<仕様書IDの先頭8文字>` 形式のブランチが作成される
- 保護ブランチ（main, develop）ではブランチ作成をスキップする

**実際の動作:**

- 保護ブランチ以外でもブランチを作成しない場合がある

### 目的

`/cft:spec-create` コマンド実行時のブランチ作成ロジックを検証し、以下を達成する。

1. **保護ブランチの正確な検出**: 環境変数 `PROTECTED_BRANCHES` および Git のデフォルトブランチを正しく識別する
2. **非保護ブランチでのブランチ作成保証**: feature ブランチなどでは確実にブランチが作成されるようにする
3. **エラーハンドリングの改善**: ブランチ作成失敗時に適切なエラーメッセージを表示し、ロールバックを実行する
4. **テストカバレッジの拡充**: E2E テストで保護ブランチ・非保護ブランチの両方をカバーする

---

## 2. 対象ユーザー

cc-craft-kit を使用するすべての開発者。

特に以下のシナリオで影響を受けます。

- feature ブランチから新しい仕様書を作成する開発者。
- main または develop ブランチから仕様書を作成する開発者（期待通りの動作を確認）。
- CI/CD 環境で自動的に仕様書を作成するスクリプト。

---

## 3. 受け入れ基準

### 必須要件

- [ ] 保護ブランチ（main, develop, または環境変数 `PROTECTED_BRANCHES` で指定されたブランチ）で `/cft:spec-create` を実行した場合、ブランチが作成されないこと
- [ ] 非保護ブランチ（feature/*, fix/*, refactor/* など）で `/cft:spec-create` を実行した場合、`spec/<仕様書IDの先頭8文字>` 形式のブランチが作成されること
- [ ] ブランチ作成失敗時に適切なエラーメッセージが表示され、データベースレコードとファイルがロールバックされること

### 機能要件

- [ ] 保護ブランチの検出ロジックを実装（環境変数 `PROTECTED_BRANCHES` の読み取り）
- [ ] Git デフォルトブランチの自動検出（`git symbolic-ref refs/remotes/origin/HEAD` の結果を使用）
- [ ] ブランチ作成コマンド（`git checkout -b spec/<id>`）の実行成功を検証
- [ ] ブランチ作成失敗時のロールバック処理を実装（データベースレコード削除、ファイル削除、元のブランチに戻る）

### 非機能要件

- [ ] ブランチ作成処理のパフォーマンス劣化がないこと（1 秒以内に完了）
- [ ] E2E テストで以下のシナリオをカバーすること：
  - main ブランチから仕様書作成（ブランチ未作成を確認）
  - develop ブランチから仕様書作成（ブランチ未作成を確認）
  - feature ブランチから仕様書作成（ブランチ作成を確認）
- [ ] ログレベル `info` でブランチ作成の成功/スキップを記録すること

---

## 4. 制約条件

- Git リポジトリが初期化されていること（`.git` ディレクトリが存在）
- ブランチ作成権限があること（リモートリポジトリへのプッシュ権限は不要）
- 環境変数 `PROTECTED_BRANCHES` はカンマ区切りで複数指定可能（デフォルト: `main,develop`）
- ブランチ名の最大長は Git の制約に従う（通常 255 文字）
- 同名のブランチが既に存在する場合、エラーとして扱う

---

## 5. 依存関係

- `src/commands/spec/create.ts` - 仕様書作成コマンドの実装
- `src/core/git/branch-cache.ts` - 現在のブランチ名の取得
- `src/core/database/connection.ts` - データベース接続
- `src/core/errors/index.ts` - エラーハンドリング
- Git コマンド（`git checkout`, `git branch`, `git symbolic-ref`）の実行環境

---

## 6. 参考情報

- [CLAUDE.md - ブランチ管理](./CLAUDE.md#ブランチ管理)
- [src/commands/spec/create.ts](../src/commands/spec/create.ts) - 現在の実装
- Git ブランチ管理のベストプラクティス: <https://git-scm.com/book/ja/v2/Git-%E3%81%AE%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81%E6%A9%9F%E8%83%BD-%E3%83%96%E3%83%A9%E3%83%B3%E3%83%81%E3%81%A8%E3%81%AF>
