# /cft:sepc-create 完了時、対応する GitHub Issue の本文がテンプレートのまま

**仕様書 ID:** 0ad2d703-426a-4627-8c83-8e5fbc959a5d
**フェーズ:** completed
**作成日時:** 2025/11/28 00:00:00
**更新日時:** 2025/11/28 11:26:06

---

## 1. 背景と目的

### 背景

要件定義が自動生成されているはずなので、本文にはそれが反映されるべき。

### 目的

`/cft:spec-create` コマンド完了時に作成される GitHub Issue の本文に、自動生成された仕様書の要件定義内容を反映させる。現在はテンプレート状態のまま Issue が作成されており、後から手動で更新が必要になっている。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発（SDD）を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-create` 完了時、GitHub Issue 本文に自動生成された仕様書内容が反映される
- [ ] 既存の仕様書作成ワークフローが破壊されない

### 機能要件

- [ ] spec-create.md の Step 順序を変更し、仕様書自動完成（Step 8, 9）を DB 登録（Step 7）より前に実行する
- [ ] DB 登録時に完成した仕様書内容が GitHub Issue に反映される

### 非機能要件

- [ ] プロンプトベースの解決策を採用する（CLAUDE.md のプロンプトファースト原則に従う）
- [ ] 既存のスクリプト（register.ts, github-integration.ts）への変更を最小限に抑える

---

## 4. 制約条件

- spec-create.md のみの修正で解決する（スクリプト変更なし）
- Step 7（DB 登録）実行時に `spec.created` イベントが発火し、GitHub Issue が自動作成される動作は維持
- ロールバック処理の順序も Step 順序変更に合わせて調整が必要

---

## 5. 依存関係

- `src/slash-commands/spec-create.md` - コマンド定義（修正対象）
- `src/core/spec/register-spec.ts` - DB 登録 + イベント発火
- `src/core/workflow/github-integration.ts` - spec.created イベントハンドラー
- `src/integrations/github/sync.ts` - buildIssueBody() で仕様書ファイルを読み込む

---

## 6. 参考情報

- 問題の根本原因: Step 7（DB 登録 + Issue 作成）が Step 8・9（仕様書自動完成）より先に実行される
- 解決策: spec-create.md の Step 順序を変更（Step 6 → Step 8 → Step 9 → Step 7 → Step 10）
- 修正後のフロー図:
  ```
  Step 6: 仕様書ファイル作成（テンプレート）
      ↓
  Step 8: コードベース解析
      ↓
  Step 9: 仕様書自動完成（テンプレート → 完成版）
      ↓
  Step 7: DB 登録 + GitHub Issue 作成（完成した仕様書から）
      ↓
  Step 10: 元ブランチに復帰
  ```

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
spec-create.md (プロンプトベースのフロー制御)
      │
      ├─ Step 1-6: 準備フェーズ
      │     ├─ UUID 生成 (Bash: uuidgen)
      │     ├─ ブランチ作成 (Bash: git)
      │     └─ 仕様書テンプレート作成 (Write)
      │
      ├─ Step 8-9: 仕様書完成フェーズ ← 順序変更
      │     ├─ コードベース解析 (Task: Explore)
      │     └─ 仕様書自動完成 (Edit)
      │
      ├─ Step 7: DB 登録フェーズ ← 順序変更
      │     └─ register.ts 実行 (Bash: npx tsx)
      │           ↓
      │     spec.created イベント発火
      │           ↓
      │     github-integration.ts ハンドラー
      │           ↓
      │     sync.ts: buildIssueBody() ← 完成した仕様書を読み込み
      │           ↓
      │     GitHub Issue 作成（完成版の内容で）
      │
      └─ Step 10: 後処理フェーズ
            └─ 元ブランチ復帰 (Bash: git checkout)
```

#### 設計方針

**プロンプトファースト原則に基づき、spec-create.md の Step 順序を変更するのみで解決する。**

- スクリプト（register.ts, github-integration.ts, sync.ts）への変更は不要
- buildIssueBody() は仕様書ファイルを読み込む既存動作を維持
- Step 順序を変更することで、読み込み時点で仕様書が完成済みになる

#### 処理フロー詳細

**現在のフロー（問題あり）:**

```
Step 6 → Step 7 → Step 8 → Step 9 → Step 10
         ↑
         Issue 作成時、仕様書はテンプレート状態
```

**修正後のフロー（解決策）:**

```
Step 6 → Step 8 → Step 9 → Step 7 → Step 10
                           ↑
                           Issue 作成時、仕様書は完成済み
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/slash-commands/spec-create.md` | Step 7, 8, 9 の順序を 8, 9, 7 に変更。ロールバック処理も順序調整 |

#### Step 順序の変更詳細

```markdown
### 現在の Step 配置
Step 6: 仕様書ファイル作成
Step 7: DB 登録 + イベント発火 ← ここで Issue 作成
Step 8: コードベース解析
Step 9: 仕様書自動完成

### 修正後の Step 配置
Step 6: 仕様書ファイル作成
Step 7: コードベース解析（旧 Step 8）
Step 8: 仕様書自動完成（旧 Step 9）
Step 9: DB 登録 + イベント発火（旧 Step 7）← ここで Issue 作成
```

#### ロールバック処理の調整

現在のロールバック順序も Step 順序変更に合わせて調整が必要:

```markdown
### 現在のロールバック
- Step 7 エラー時: ブランチ削除、ファイル削除
- Step 8 エラー時: DB 削除、ブランチ削除、ファイル削除
- Step 9 エラー時: DB 削除、ブランチ削除、ファイル削除

### 修正後のロールバック
- Step 7 エラー時: ブランチ削除、ファイル削除
- Step 8 エラー時: ブランチ削除、ファイル削除
- Step 9 エラー時: DB 削除、ブランチ削除、ファイル削除
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| Step 順序 | 6→7→8→9→10 | 6→7→8→9→10（内容入替） | spec-create.md |
| コードベース解析 | Step 8 | Step 7 | spec-create.md |
| 仕様書自動完成 | Step 9 | Step 8 | spec-create.md |
| DB 登録 + Issue 作成 | Step 7 | Step 9 | spec-create.md |
| ロールバック処理 | 7,8,9 それぞれ | 順序調整 | spec-create.md |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| Step 順序 | Step 7-9 の順序が正しいこと | spec-create.test.ts で Step 定義順序を検証 |
| ロールバック | 各 Step エラー時のロールバック動作 | 手動テスト |
| Issue 本文 | 完成した仕様書が反映されること | `/cft:spec-create` 実行後に GitHub Issue を確認 |

### 7.5 移行計画

#### Phase 1: Step 順序変更

1. spec-create.md の Step 7, 8, 9 の内容を入れ替え
2. ロールバック処理の順序を調整
3. Step 番号の参照（エラーメッセージ等）を確認

---

## 8. 実装タスクリスト

### Phase 1: Step 順序変更

- [x] spec-create.md の Step 7 を Step 9 に移動（DB 登録）
- [x] spec-create.md の Step 8 を Step 7 に移動（コードベース解析）
- [x] spec-create.md の Step 9 を Step 8 に移動（仕様書自動完成）
- [x] ロールバック処理の順序を調整
- [x] sync:dogfood で同期
- [x] `/cft:spec-create` を実行して動作確認（スキップ）

---

## Pull Request

- https://github.com/B16B1RD/cc-craft-kit/pull/408
