# completed フェーズ移行時に予期しないブランチが作成されるバグを修正

**仕様書 ID:** 2572db2e-b86c-46b2-8116-c72f46150252
**フェーズ:** requirements
**作成日時:** 2025/11/21 17:31:27
**更新日時:** 2025/11/21 17:31:27

---

## 1. 背景と目的

### 背景

#### 問題の概要

Git 自動コミット機能に関連して、以下の 2 つの問題が発生しています。

##### 問題1: completed フェーズ移行時に予期しないブランチが作成される

`/cft:spec-phase <spec-id> completed` コマンド実行時に以下が発生します。

1. **予期しないブランチ作成**: `spec/<短縮ID>` という新しいブランチが自動作成される
2. **ブランチ切り替え**: completed フェーズのコミットがその新ブランチで実行される
3. **コミット喪失**: 元のブランチに戻ると、completed フェーズのコミットが失われる

##### 問題2: 仕様書作成時に自動コミットされない

`/cft:spec-create <name> [description]` コマンド実行時に以下が発生します。

1. **仕様書ファイルが未コミット**: 仕様書ファイル `.cc-craft-kit/specs/<spec-id>.md` が作成されるが、Git に自動コミットされない
2. **原因**: `src/core/workflow/git-integration.ts` に `spec.created` イベントのハンドラーが未登録
3. **影響**: 手動で `git add` + `git commit` する必要がある

#### 再現手順

##### 問題1の再現手順

1. feature ブランチで仕様書を作成し、実装を完了
2. `/cft:spec-phase <spec-id> completed` を実行
3. 自動的に `spec/<短縮ID>` ブランチが作成され、そこでコミットが実行される
4. 元のブランチに戻ると、実装ファイルの変更が失われている

##### 問題2の再現手順

1. 任意のブランチで `/cft:spec-create "新しい仕様書"` を実行
2. 仕様書ファイルが作成されるが、Git に自動コミットされない
3. `git status` で確認すると、仕様書ファイルが untracked のままになっている

#### 発生した実例

- 仕様書 ID: `2507c382-628a-4fa9-bfad-41e1951d9292`
- 元のブランチ: `feature/spec-2507c382-prevent-duplicate-github-issues`
- 作成されたブランチ: `spec/c4b0b23e`
- 失われたコミット: `a6c2de1` (9 ファイル、784 行追加、175 行削除)
- 復旧方法: `git reflog` で特定し、`git cherry-pick` で復元

### 目的

Git 自動コミット機能を修正し、以下を実現します。

1. **問題1の解決**: completed フェーズ移行時に予期しないブランチが作成されないようにし、現在のブランチで正しくコミットが実行されることを保証します。これにより、ユーザーがコミットを失うリスクを排除します。

2. **問題2の解決**: 仕様書作成時に仕様書ファイルが自動的にコミットされるようにし、手動でのコミット作業を不要にします。これにより、ユーザーが仕様書ファイルをコミット忘れするリスクを排除します。

これらの修正により、開発フローをスムーズにし、ユーザビリティを向上させます。

---

## 2. 対象ユーザー

### プライマリユーザー

- **cc-craft-kit の開発者**: ドッグフーディング環境で仕様書を completed フェーズに移行するユーザー
- **cc-craft-kit のユーザー**: 実際のプロジェクトで仕様書を completed フェーズに移行するユーザー

### セカンダリユーザー

- **Git に不慣れなユーザー**: reflog や cherry-pick などの Git の高度な機能に不慣れなユーザー

---

## 3. 受け入れ基準

### 必須要件（問題1）

- [ ] completed フェーズ移行時に新しいブランチが作成されない
- [ ] completed フェーズのコミットが現在のブランチで実行される
- [ ] 実装ファイルの変更が失われない

### 必須要件（問題2）

- [ ] 仕様書作成時に仕様書ファイルが自動コミットされる
- [ ] `spec.created` イベントハンドラーが正しく登録される
- [ ] 手動でのコミットが不要になる

### 機能要件（問題1）

- [ ] `/cft:spec-phase <spec-id> completed` コマンド実行時、現在のブランチで Git コミットが実行される
- [ ] Git 自動コミット機能が正しく動作し、全変更ファイルがコミットされる
- [ ] フェーズ移行後、ブランチが切り替わっていないことを確認

### 機能要件（問題2）

- [ ] `/cft:spec-create <name> [description]` コマンド実行時、仕様書ファイルが自動コミットされる
- [ ] コミットメッセージは `feat: <仕様書名> の仕様書を作成` 形式で統一される
- [ ] `.gitignore` で除外されているファイルはスキップされる

### 非機能要件

- [ ] 既存の Git 自動コミット機能に影響を与えない
- [ ] 他のフェーズ移行（requirements, design, tasks, implementation）に影響を与えない
- [ ] 既存のテストが全て成功する

---

## 4. 制約条件

### 技術的制約

- **Git ワークフローへの影響**: Git 自動コミット機能の修正が必要
- **後方互換性**: 既存の仕様書や進行中のプロジェクトに影響を与えない

### パフォーマンス制約

- **Git コマンド実行時間**: ブランチチェックや切り替えの追加コストを最小限にする

---

## 5. 依存関係

### 依存する既存コンポーネント

- **`src/core/workflow/git-integration.ts`**: Git 自動コミット機能（修正対象）
- **`src/core/git/branch-creation.ts`**: ブランチ作成ロジック（原因調査対象）
- **`src/commands/spec/phase.ts`**: フェーズ移行コマンド

### 関連する仕様

- **仕様書 ID: 2507c382**: GitHub Issue 重複作成防止機能（この問題が発生した仕様書）

---

## 6. 参考情報

### 関連 Issue

- GitHub Issue #249 - 本仕様書に紐づく Issue

### 参考コード

- `src/core/workflow/git-integration.ts` - Git 自動コミット機能の実装
- `src/core/git/branch-creation.ts` - ブランチ作成ロジックの実装
- `src/commands/spec/phase.ts` - フェーズ移行コマンドの実装

### 関連仕様書

- `.cc-craft-kit/specs/2507c382-628a-4fa9-bfad-41e1951d9292.md` - この問題が発生した仕様書

### Git リファレンス

- `git reflog` - 失われたコミットの特定方法
- `git cherry-pick` - コミットの復元方法
