# ブランチの作成タイミングの検討

**仕様書 ID:** 68ff98ee-95c5-47ac-9805-7c87fae55d19
**フェーズ:** design
**作成日時:** 2025/11/20 17:56:09
**更新日時:** 2025/11/20 18:01:24

---

## 1. 背景と目的

### 背景

仕様書の作成時にブランチを作成すべきと考えるが、ブランチを切り替えるとデータベースの不整合が起きる気がする。データベースにはあるが仕様書がない状態が存在し得る。となると、その状態を管理するカラムが必要になる気がする。どうだろうか。ちなみに、現状は仕様書作成時にブランチが作成されないので、それはそれで問題。

### 目的

本仕様書は、以下の 3 つの課題を解決するための設計方針を決定することを目的とします。

1. **ブランチ作成タイミングの最適化**
   - 仕様書作成時に自動的に作業ブランチを作成する機能の実装

2. **データベース整合性の保証**
   - ブランチ切り替え時に発生し得る「データベースレコードは存在するが仕様書ファイルが存在しない」状態を防止する仕組みの設計

3. **ブランチ間の仕様書状態管理**
   - 仕様書がどのブランチで作成されたか、どのブランチで参照可能かを管理するデータモデルの設計

---

## 2. 対象ユーザー

本機能の対象ユーザーは以下の通りです。

1. **cc-craft-kit の開発者**
   - 仕様駆動開発（SDD）ワークフローに従って開発を進める開発者
   - Git ブランチを適切に管理しながら、仕様書と実装を同期させたい開発者

2. **チーム開発における複数の開発者**
   - 同一リポジトリで複数の仕様書を並行開発する開発者
   - ブランチ切り替え時にデータベース不整合を避けたい開発者

3. **cc-craft-kit のメンテナー**
   - ブランチ管理の仕組みを理解し、トラブルシューティングを行う必要があるメンテナー

---

## 3. 受け入れ基準

### 必須要件

- [ ] ブランチ作成タイミングの仕様が明確に定義されている
- [ ] データベース整合性を保証する仕組みが設計されている
- [ ] ブランチ間の仕様書状態管理の仕組みが設計されている
- [ ] 既存の仕様書作成フローとの互換性が保たれている
- [ ] Git ブランチ管理のベストプラクティスに準拠している

### 機能要件

- [ ] 仕様書作成時に、適切なブランチ名（例: `spec/<spec-id>` または `feature/<spec-name>`）で自動的に作業ブランチが作成される
- [ ] ブランチ切り替え時に、そのブランチで参照可能な仕様書のみが表示される
- [ ] ブランチ間で仕様書の状態（作成中、レビュー中、マージ済みなど）が追跡可能である
- [ ] 仕様書がマージされた後、main/develop ブランチで正しく参照できる
- [ ] ブランチ削除時に、孤立した仕様書レコードが自動的にクリーンアップされる

### 非機能要件

- [ ] ブランチ切り替え時のデータベース整合性チェックが 1 秒以内に完了する
- [ ] データベースに `branch_name` カラムを追加してもパフォーマンスが劣化しない（インデックス設計を含む）
- [ ] 複数の Claude Code インスタンスから同時にブランチ作成しても競合が発生しない
- [ ] 既存の仕様書データに対して、マイグレーションスクリプトで `branch_name` を自動設定できる
- [ ] エラーハンドリングが適切に実装され、ブランチ作成失敗時にデータベースがロールバックされる

---

## 4. 制約条件

### 技術的制約

1. **SQLite の単一ファイル制約**
   - cc-craft-kit は SQLite を使用しており、データベースファイル（`.cc-craft-kit/cc-craft-kit.db`）は Git 管理されていない
   - ブランチ切り替え時にデータベースファイルは切り替わらないため、ブランチ A で作成した仕様書のレコードがブランチ B でも参照可能になる

2. **仕様書ファイルの Git 管理**
   - 仕様書ファイル（`.cc-craft-kit/specs/*.md`）は Git 管理対象である
   - ブランチ切り替え時に、仕様書ファイルはブランチの状態に応じて切り替わる

3. **不整合シナリオ**

   **シナリオ 1: ブランチ A で仕様書作成後、ブランチ B に切り替え**

   ```bash
   # ブランチ A で仕様書作成
   git checkout -b feature/spec-a
   /cft:spec-create "仕様書A" "説明"
   # => データベースにレコード挿入 + specs/<spec-id>.md ファイル作成

   # ブランチ B に切り替え
   git checkout feature/spec-b
   # => specs/<spec-id>.md ファイルは存在しないが、データベースレコードは残る
   # => /cft:spec-list で "仕様書A" が表示されるが、ファイルを開くとエラー
   ```

   **シナリオ 2: main ブランチで仕様書作成後、feature ブランチに切り替え**

   ```bash
   # main ブランチで仕様書作成
   git checkout main
   /cft:spec-create "仕様書M" "説明"

   # feature ブランチに切り替え
   git checkout -b feature/new-feature
   # => specs/<spec-id>.md ファイルは存在する（main から引き継がれる）
   # => データベースレコードも存在する
   # => 問題なく参照可能
   ```

4. **Git ワークフローとの整合性**
   - プロジェクトは GitHub Flow + develop ブランチを採用しており、以下のブランチ戦略を持つ
     - main: 本番リリース済み
     - develop: 次期リリース候補
     - feature/*: 新機能開発
     - fix/*: バグ修正
   - 仕様書作成時にブランチを自動作成する場合、既存のブランチ戦略と矛盾しないようにする必要がある

### 設計上の制約

1. **後方互換性**
   - 既存の仕様書データ（`branch_name` カラムがない）に対して、マイグレーションで適切なブランチ名を設定する必要がある

2. **パフォーマンス**
   - `/cft:spec-list` などのコマンド実行時に、毎回 Git ブランチ情報を取得するとパフォーマンスが劣化する可能性がある
   - データベースにブランチ情報をキャッシュする仕組みが必要

3. **複数 Claude Code インスタンス**
   - 複数の Claude Code を同時起動して使用する場合、ブランチ作成が競合する可能性がある
   - WAL モード + busy_timeout で対処可能だが、トランザクション設計を慎重に行う必要がある

---

## 5. 依存関係

### 内部依存

- **データベーススキーマ** (`src/core/database/schema.ts`)
  - `specs` テーブルに `branch_name` カラムを追加する必要がある
  - マイグレーションスクリプト（`src/core/database/migrations/`）を作成する必要がある

- **仕様書作成コマンド** (`src/commands/spec/create.ts`)
  - 仕様書作成時にブランチを自動作成するロジックを追加する必要がある

- **仕様書一覧コマンド** (`src/commands/spec/list.ts`)
  - 現在のブランチで参照可能な仕様書のみをフィルタリングするロジックを追加する必要がある

- **Git 統合** (`src/core/workflow/git-integration.ts`)
  - ブランチ作成ロジックを再利用する必要がある

### 外部依存

- **Git リポジトリ**
  - Git リポジトリが初期化されている必要がある
  - リモートリポジトリとの同期が正常に動作している必要がある

- **環境変数**
  - `PROTECTED_BRANCHES` 設定と矛盾しないようにブランチを作成する必要がある

---

## 6. 参考情報

### 関連ドキュメント

- [CLAUDE.md - Git ワークフロー基本方針](./CLAUDE.md#git-ワークフロー基本方針)
- [CLAUDE.md - データベース接続の安全性](./CLAUDE.md#データベース接続の安全性)
- [CLAUDE.md - .cc-craft-kit/ ディレクトリのファイル管理](./CLAUDE.md#cc-craft-kit-ディレクトリのファイル管理)

### 関連 Issue

- GitHub Issue #227: <https://github.com/B16B1RD/cc-craft-kit/issues/227>

### 参考実装

- `src/core/workflow/git-integration.ts` - 既存の Git 自動コミット機能
- `src/commands/spec/create.ts` - 仕様書作成コマンド
- `src/core/database/schema.ts` - データベーススキーマ定義

### 技術的背景

1. **SQLite のブランチ管理の課題**
   - SQLite はファイルベースのデータベースであり、Git では管理されない
   - ブランチ切り替え時にデータベースファイルは切り替わらない
   - この課題は、多くの Git ベースの開発ツールで共通の問題である

2. **解決策の例**
   - **オプション A**: データベースに `branch_name` カラムを追加し、クエリ時にフィルタリング
   - **オプション B**: ブランチごとに異なるデータベースファイルを使用（`.cc-craft-kit/db/<branch-name>.db`）
   - **オプション C**: 仕様書ファイルをマスターデータとし、データベースはキャッシュとして扱う（起動時にファイルからデータベースを再構築）

3. **推奨アプローチ**
   - **オプション A** を推奨（データベースに `branch_name` カラムを追加）
   - 理由:
     - 実装が最もシンプル
     - 既存のデータベース設計を大きく変更しない
     - パフォーマンスへの影響が最小限
     - 複数ブランチ間の仕様書を横断検索する場合にも対応可能
