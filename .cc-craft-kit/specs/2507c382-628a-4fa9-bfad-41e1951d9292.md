# GitHub Issue の重複作成を防止する仕組みの実装

**仕様書 ID:** 2507c382-628a-4fa9-bfad-41e1951d9292
**フェーズ:** design
**作成日時:** 2025/11/21 16:00:34
**更新日時:** 2025/11/21 16:17:54

---

## 1. 背景と目的

### 背景

#### 問題の概要

同一の仕様書に対して複数の GitHub Issue が作成されてしまうバグが発生しています。これにより以下の問題が発生しています。

1. データベース不整合: github_sync テーブルに同一 spec_id の重複レコード
2. ユーザー混乱: どの Issue が正しいか判断できない
3. 手動対応コスト: 重複 Issue を手動で削除する必要がある

#### 原因分析

根本原因は、`/cft:github-issue-create` コマンド実行時に **既存 Issue の存在チェックが実装されていない** ことです。

**現在のコードフロー:**

```typescript
// src/commands/github/issue-create.ts (現状)
export async function createIssue(specId: string) {
  const spec = await getSpec(specId);
  const issue = await githubClient.issues.create({ ... }); // チェックなしで直接作成
  await db.insertInto('github_sync').values({ ... }); // 重複レコード挿入
}
```

**問題点:**

- `github_sync` テーブルの UNIQUE 制約がない（entity_type, entity_id の複合ユニーク制約未設定）
- 既存 Issue の有無をチェックするロジックがない
- トランザクション制御がないため、競合状態で重複作成される可能性

#### 発生条件

- 同一仕様書に対して `/cft:github-issue-create <spec-id>` を複数回実行
- ネットワーク遅延により GitHub API のレスポンスが遅い場合、連続実行で競合
- github_sync テーブルの INSERT 前に既存レコードをチェックしていない

### 目的

本仕様の目的は、GitHub Issue の重複作成バグを修正し、データベース整合性を保証することです。具体的には以下を実現します。

1. **データ整合性の向上**: github_sync テーブルと GitHub 実体の 1:1 マッピングを保証
2. **ユーザー体験の改善**: 重複 Issue による混乱を防ぎ、正しい Issue URL を即座に提示
3. **保守性の向上**: 既存 Issue の存在チェックを標準化し、今後の機能追加時の不整合を防止
4. **開発効率の向上**: Issue 重複による手動削除作業を削減し、開発フローをスムーズに

このバグは v0.1.x で報告され、ドッグフーディング環境で複数回発生しており、優先度は「高」と判断しています。

---

## 2. 対象ユーザー

### プライマリユーザー

- **cc-craft-kit の開発者**: ドッグフーディング環境で `/cft:github-issue-create` を使用する開発者
- **cc-craft-kit のユーザー**: インストール後に GitHub 統合を使用するすべてのユーザー

### セカンダリユーザー

- **GitHub リポジトリの管理者**: Issue 重複による混乱を防ぎ、適切なプロジェクト管理を実現
- **コードレビュアー**: データベース整合性の保証により、レビュー時の混乱を削減

### 影響範囲

本修正は既存の `/cft:github-issue-create` コマンドの動作を変更しますが、**後方互換性は維持**されます。

- 既存の Issue が存在しない場合、従来通り新規作成される
- 既存の Issue が存在する場合、エラーメッセージと URL を表示（新しい動作）

---

## 3. 受け入れ基準

### 必須要件

- [ ] 同一仕様書 ID に対して GitHub Issue が既に存在する場合、新規作成を防ぐ
- [ ] `/cft:github-issue-create <spec-id>` 実行時に github_sync テーブルをチェックし、既存 Issue の有無を確認
- [ ] 既存 Issue が存在する場合、エラーメッセージと Issue URL を表示して処理を中断
- [ ] github_sync テーブルの entity_type='spec' かつ entity_id=`<spec-id>` のレコードが存在する場合、重複と判定

### 機能要件

- [ ] 重複チェックロジックを `src/integrations/github/issue-create.ts` に実装
- [ ] エラーメッセージ:「この仕様書には既に GitHub Issue が作成されています: {IssueURL}」
- [ ] github_sync テーブルの sync_status='success' のレコードのみを有効な Issue として判定
- [ ] sync_status='failed' または 'pending' のレコードは無視し、再作成を許可
- [ ] 仕様書作成時の自動 Issue 作成（spec.created イベント）にも同じチェックロジックを適用

### 非機能要件

- [ ] 重複チェックのクエリは 100ms 以内に完了すること（パフォーマンス）
- [ ] トランザクション内でチェックと作成をし、競合状態を防ぐこと（データ整合性）
- [ ] 単体テストで重複作成が防がれることを検証（テストカバレッジ 100%）
- [ ] E2E テストで実際のコマンド実行シナリオを検証（連続実行 10 回で重複 0 件）

---

## 4. 制約条件

### 技術的制約

- **データベーススキーマ変更の制限**: UNIQUE 制約の追加はマイグレーションが必要だが、既存データに重複がある場合は失敗する
  - 対策: マイグレーション前に重複レコードをクリーンアップするスクリプトを実行
- **トランザクション分離レベル**: SQLite の WAL モードで SERIALIZABLE 相当の動作を保証する必要がある
  - 対策: `BEGIN IMMEDIATE TRANSACTION` を使用し、チェックと作成を同一トランザクション内で実行

### パフォーマンス制約

- **GitHub API レート制限**: Issue 作成は REST API を使用するため、5,000 リクエスト/時の制限がある
  - 影響: 重複チェックに失敗しても、リトライで API クォータを消費しない設計にする
- **データベースクエリ時間**: 重複チェッククエリは 100ms 以内に完了する必要がある
  - 対策: github_sync テーブルに (entity_type, entity_id) の複合インデックスを作成済み

### 後方互換性の制約

- **既存コマンドの動作変更**: `/cft:github-issue-create` の動作が変わるため、ドキュメント更新が必要
- **既存データの整合性**: 既に重複レコードが存在する場合、修復スクリプトで対処する必要がある

---

## 5. 依存関係

### 依存する既存コンポーネント

- **`src/integrations/github/issue-create.ts`**: Issue 作成ロジックの中核（修正対象）
- **`src/core/database/connection.ts`**: データベース接続とトランザクション管理
- **`src/core/database/schema.ts`**: github_sync テーブルの型定義
- **`src/commands/github/issue-create.ts`**: CLI コマンドのエントリーポイント

### 依存する他の仕様

- **データベーススキーマ v1.0**: github_sync テーブルの構造に依存
  - 必要なカラム: entity_type、entity_id、github_id、github_number、sync_status
- **GitHub REST API v3**: Issue 作成エンドポイント (`POST /repos/{owner}/{repo}/issues`)
- **EventEmitter2**: `github.issue_created` イベントの発火タイミングを変更する可能性

### 影響を受けるコンポーネント

- **`/cft:github-issue-create` コマンド**: 既存 Issue がある場合の動作が変わる
- **`/cft:github-sync` コマンド**: 重複レコードの同期処理に影響する可能性
- **自動 Issue 作成（spec.created イベント）**: 仕様書作成時の自動 Issue 作成にも同じチェックが必要

### マイグレーション依存

- **マイグレーションファイル新規作成**: `00X_add_unique_constraint_to_github_sync.ts`
  - github_sync テーブルに UNIQUE 制約 (entity_type, entity_id) を追加
  - 既存の重複レコードがある場合はマイグレーション失敗のため、事前クリーンアップが必須

---

## 6. 参考情報

### 関連 Issue

- <https://github.com/B16B1RD/cc-craft-kit/issues/106> - 重複作成されたオリジナル Issue（クローズ済み）
- <https://github.com/B16B1RD/cc-craft-kit/issues/224> - 実際に作業が進んだ Issue（クローズ済み）
- <https://github.com/B16B1RD/cc-craft-kit/issues/248> - 本仕様書に紐づく Issue

### 参考ドキュメント

- [CLAUDE.md - データベーススキーマ](../../CLAUDE.md#データベーススキーマ)
  - github_sync テーブルの構造と役割
- [ARCHITECTURE.md - GitHub 統合](../../docs/ARCHITECTURE.md)
  - GitHub 統合の設計思想とデータフロー
- [GitHub REST API - Issues](https://docs.github.com/en/rest/issues/issues#create-an-issue)
  - Issue 作成エンドポイントの仕様

### 既存コード

- `src/integrations/github/issue-create.ts` - Issue 作成ロジック（修正対象）
- `src/commands/spec/helpers.ts` - `getSpecWithGitHubInfo()` - 仕様書と GitHub 情報の結合取得
- `src/core/database/migrations/` - マイグレーションファイルの参考例

### テストケース参考

- `tests/integrations/github/issue-create.test.ts` - 既存の単体テスト
- `tests/e2e/github-integration.test.ts` - E2E テストシナリオ
