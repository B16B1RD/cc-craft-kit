# /cft:spec-get において別ブランチの仕様書が表示できない

**仕様書 ID:** 607968f7-26dd-4d89-8d2a-3ffc379078e6
**フェーズ:** completed
**作成日時:** 2025/11/21 23:32:32
**更新日時:** 2025/11/21 23:59:40

---

## 1. 背景と目的

### 背景

cc-craft-kit では、仕様書作成時に自動的に専用ブランチ（`spec/<短縮ID>` または `feature/spec-<短縮ID>`）が作成され、仕様書レコードに `branch_name` カラムでブランチ情報が記録されます。

現在、`/cft:spec-list` コマンドはブランチフィルタリング機能により、現在のブランチに応じて適切な仕様書のみを表示します。しかし、`/cft:spec-get <spec-id>` コマンドでは、このブランチフィルタリングが実装されていないため、以下の問題が発生しています。

1. **別ブランチの仕様書が表示されない**:
   - 仕様書 ID を指定しても、データベースに存在する場合でも「仕様書が見つかりません」エラーが表示される
   - 実際にはファイルは存在するが、ブランチが異なるため Git 管理下に存在しない

2. **エラーメッセージが不適切**:
   - 「仕様書が見つかりません」では、ユーザーがブランチの問題であることに気づけない
   - デバッグが困難になる

### 目的

`/cft:spec-get` コマンドに適切なブランチフィルタリング機能を実装し、以下を実現します。

1. 現在のブランチで参照できない仕様書を指定した場合、明確なエラーメッセージを表示する
2. ブランチフィルタリングのロジックを `/cft:spec-list` と統一する
3. ユーザーが適切なブランチに切り替えられるよう、必要な情報を提供する

---

## 2. 対象ユーザー

- cc-craft-kit を使用する開発者
- 特に、複数のブランチで並行して作業している開発者
- Git ブランチと仕様書の関係を理解する必要がある開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-get` コマンドが、現在のブランチで参照できない仕様書を指定した場合、別ブランチにあることを明確に案内すること
- [ ] エラーメッセージに、仕様書が作成されたブランチ名を明示すること
- [ ] エラーメッセージに、現在のブランチ名を表示すること
- [ ] ユーザーに対して、ブランチを切り替えて仕様書を表示するかどうかを選択できるようにすること（**ベストプラクティス**）

### 機能要件

- [ ] ブランチフィルタリングのロジックを `getSpecsWithGitHubInfo` ヘルパー関数と統一すること
- [ ] フィルタリングルール:
  - `main` ブランチ: `main` と `develop` で作成された仕様書のみ表示
  - `develop` ブランチ: `main` と `develop` で作成された仕様書のみ表示
  - `feature/*` ブランチ: `main`, `develop`, および現在のブランチで作成された仕様書を表示
- [ ] 仕様書が存在しない場合と、ブランチが異なる場合を区別してエラーメッセージを表示すること
- [ ] ブランチ切り替えの選択肢を提供する際は、以下のオプションを用意すること:
  - オプション 1: ブランチを切り替えて仕様書を表示
  - オプション 2: 現在のブランチに留まる（キャンセル）
- [ ] ユーザーがブランチ切り替えを選択した場合、`git checkout` を実行し、再度 `/cft:spec-get` を実行すること

### 非機能要件

- [ ] 既存のテストが引き続きパスすること
- [ ] パフォーマンスへの影響が最小限であること（キャッシュ機構を活用）
- [ ] エラーメッセージがユーザーフレンドリーであること

---

## 4. 制約条件

- `src/commands/spec/get.ts` の既存の実装を大幅に変更しないこと
- `src/commands/spec/helpers.ts` の `getSpecWithGitHubInfo` 関数を活用すること
- `src/core/git/branch-cache.ts` のキャッシュ機構を使用すること
- データベーススキーマの変更は不要（既存の `branch_name` カラムを使用）
- ユーザー入力の処理には、Node.js の標準入力（`process.stdin`）または `readline` モジュールを使用すること
- ブランチ切り替え時は、未保存の変更がないことを確認すること（`git status --porcelain` で検証）
- ブランチ切り替え後は、ブランチキャッシュをクリアすること（`clearBranchCache()`）

---

## 5. 依存関係

### 既存の関連機能

- `src/commands/spec/helpers.ts:getSpecWithGitHubInfo` - 単一の仕様書を取得するヘルパー
- `src/commands/spec/helpers.ts:getSpecsWithGitHubInfo` - 複数の仕様書を取得するヘルパー（ブランチフィルタリング実装済み）
- `src/core/git/branch-cache.ts:getCurrentBranch` - ブランチ名取得（キャッシュ機構付き）
- `src/core/database/schema.ts` - `specs.branch_name` カラム定義

### 影響を受けるコマンド

- `/cft:spec-get <spec-id>` - 本仕様の対象コマンド
- `/cft:spec-list [phase]` - 既にブランチフィルタリング実装済み（参考実装）

---

## 6. 参考情報

### 関連する Issue・仕様書

- Issue #255: `spec-get コマンドが GitHub Issue を重複作成するバグを修正`
- 仕様書 `7d86e424`: `整合性チェックが別ブランチの仕様書を誤検知する問題を修正` (completed)

### 実装の参考

- `src/commands/spec/list.ts:56-73` - ブランチフィルタリングの実装例
- `CLAUDE.md:### ブランチフィルタリング` - ブランチフィルタリングの仕様

### 実装の技術的な詳細

**ユーザー入力の処理方法:**

```typescript
import * as readline from 'readline';

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout,
});

rl.question('選択してください (1/2): ', (answer) => {
  if (answer === '1') {
    // ブランチ切り替え処理
  } else {
    // キャンセル処理
  }
  rl.close();
});
```

**ブランチ切り替えの安全性チェック:**

```typescript
import { execSync } from 'child_process';

// 未保存の変更をチェック
const status = execSync('git status --porcelain', { encoding: 'utf-8' });
if (status.trim()) {
  console.error('⚠️  未保存の変更があります。先にコミットまたはstashしてください。');
  process.exit(1);
}
```

**ブランチ切り替え後の処理:**

```typescript
import { clearBranchCache } from '../core/git/branch-cache.js';

// ブランチ切り替え
execSync(`git checkout ${targetBranch}`, { stdio: 'inherit' });

// キャッシュをクリア
clearBranchCache();

// 再度仕様書を取得
const spec = await getSpecWithGitHubInfo(db, specId);
```

### エラーメッセージと選択UIの例

#### パターン 1: ブランチが異なる場合（選択UI付き）

```text
⚠️  この仕様書は別のブランチで作成されています

仕様書情報:
  仕様書 ID: 607968f7-26dd-4d89-8d2a-3ffc379078e6
  仕様書名: /cft:spec-get において別ブランチの仕様書が表示できない
  作成されたブランチ: feature/spec-607968f7-fix-spec-get-cross-branch

現在のブランチ: develop

ブランチを切り替えて仕様書を表示しますか？
  1. はい - ブランチを切り替えて表示
  2. いいえ - 現在のブランチに留まる

選択してください (1/2): _
```

#### パターン 2: 仕様書が存在しない場合

```text
❌ 仕様書が見つかりません

指定された仕様書 ID に一致する仕様書がデータベースに存在しません。
  仕様書 ID: 12345678

仕様書の一覧を確認してください：
  /cft:spec-list
```

---

## 7. 設計

### 7.1 アーキテクチャ概要

`/cft:spec-get` コマンドの実行フローを以下のように設計します。

```text
ユーザー入力
    ↓
仕様書ID検証
    ↓
データベースクエリ（ブランチフィルタリング適用）
    ↓
┌─────────────────────┐
│ 仕様書が見つかった？ │
└─────────────────────┘
    ↓ Yes              ↓ No
仕様書を表示      データベースに存在するか確認
                       ↓
                 ┌─────────────────────┐
                 │ DBに存在する？       │
                 └─────────────────────┘
                   ↓ Yes        ↓ No
              ブランチが異なる  仕様書が存在しない
                   ↓
              ユーザーに選択を促す
                   ↓
              ┌──────────────┐
              │ 切り替える？  │
              └──────────────┘
                ↓ Yes   ↓ No
          ブランチ切り替え  終了
                ↓
          再度仕様書を表示
```

### 7.2 モジュール設計

#### 7.2.1 修正対象ファイル

**`src/commands/spec/get.ts`**

既存の実装に以下の機能を追加します。

1. **ブランチフィルタリング機能の追加**
   - `getSpecWithGitHubInfo` ヘルパーを拡張し、ブランチフィルタリングオプションを追加
   - または、`getSpecsWithGitHubInfo` を使用して単一仕様書を取得

2. **エラーハンドリングの改善**
   - 仕様書が見つからない場合の原因を特定（ブランチの違い vs 存在しない）
   - 適切なエラーメッセージを表示

3. **ユーザー選択UIの実装**
   - `readline` モジュールを使用した対話的な選択 UI
   - ブランチ切り替え機能

**`src/commands/spec/helpers.ts`**

既存のヘルパー関数を拡張します。

1. **`getSpecWithGitHubInfo` の拡張**
   - オプショナルなブランチフィルタリングパラメータを追加
   - フィルタリングロジックを `getSpecsWithGitHubInfo` と統一

#### 7.2.2 新規ユーティリティ関数

**`src/commands/spec/branch-switch.ts`** (新規作成)

ブランチ切り替えの共通ロジックを実装します。

```typescript
export interface BranchSwitchOptions {
  targetBranch: string;
  specId: string;
  checkUnsavedChanges?: boolean; // デフォルト: true
}

export interface BranchSwitchResult {
  success: boolean;
  switched: boolean;
  error?: string;
}

export async function promptBranchSwitch(
  currentBranch: string,
  targetBranch: string,
  specInfo: { id: string; name: string }
): Promise<boolean>;

export async function switchBranch(
  options: BranchSwitchOptions
): Promise<BranchSwitchResult>;
```

### 7.3 処理フロー詳細

#### 7.3.1 仕様書取得フロー

```typescript
// 1. 仕様書IDの検証
const specId = resolveSpecId(args[0]);

// 2. 現在のブランチを取得
const currentBranch = getCurrentBranch();

// 3. ブランチフィルタリング付きで仕様書を取得
const specs = await getSpecsWithGitHubInfo(db, {
  id: specId,
  branchName: currentBranch,
});

if (specs.length === 0) {
  // 4. ブランチフィルタリングなしで再取得
  const allSpecs = await getSpecsWithGitHubInfo(db, { id: specId });

  if (allSpecs.length === 0) {
    // 仕様書が存在しない
    showSpecNotFoundError(specId);
  } else {
    // ブランチが異なる
    const spec = allSpecs[0];
    await handleBranchMismatch(spec, currentBranch);
  }
} else {
  // 5. 仕様書を表示
  displaySpec(specs[0]);
}
```

#### 7.3.2 ブランチ切り替えフロー

```typescript
async function handleBranchMismatch(
  spec: SpecWithGitHub,
  currentBranch: string
): Promise<void> {
  // 1. エラーメッセージを表示
  console.log(chalk.yellow('⚠️  この仕様書は別のブランチで作成されています'));
  console.log();
  console.log('仕様書情報:');
  console.log(`  仕様書 ID: ${spec.id}`);
  console.log(`  仕様書名: ${spec.name}`);
  console.log(`  作成されたブランチ: ${spec.branch_name}`);
  console.log();
  console.log(`現在のブランチ: ${currentBranch}`);
  console.log();

  // 2. ユーザーに選択を促す
  const shouldSwitch = await promptBranchSwitch(
    currentBranch,
    spec.branch_name,
    { id: spec.id, name: spec.name }
  );

  if (!shouldSwitch) {
    console.log('キャンセルしました。');
    process.exit(0);
  }

  // 3. ブランチを切り替え
  const result = await switchBranch({
    targetBranch: spec.branch_name,
    specId: spec.id,
    checkUnsavedChanges: true,
  });

  if (!result.success) {
    console.error(chalk.red(`❌ ブランチ切り替えに失敗しました: ${result.error}`));
    process.exit(1);
  }

  // 4. 再度仕様書を表示
  console.log(chalk.green('✓ ブランチを切り替えました'));
  console.log();

  // ブランチキャッシュをクリア
  clearBranchCache();

  // 再度取得
  const updatedSpec = await getSpecWithGitHubInfo(db, spec.id);
  if (updatedSpec) {
    displaySpec(updatedSpec);
  }
}
```

### 7.4 データフロー

#### 7.4.1 データベースクエリ

```typescript
// ブランチフィルタリング付きクエリ（既存の getSpecsWithGitHubInfo を活用）
async function getSpecWithBranchFiltering(
  db: Kysely<Database>,
  specId: string,
  currentBranch: string
): Promise<SpecWithGitHub | null> {
  const specs = await getSpecsWithGitHubInfo(db, {
    id: specId,
    branchName: currentBranch,
  });
  return specs.length > 0 ? specs[0] : null;
}

// ブランチフィルタリングなしクエリ
async function getSpecWithoutFiltering(
  db: Kysely<Database>,
  specId: string
): Promise<SpecWithGitHub | null> {
  const specs = await getSpecsWithGitHubInfo(db, { id: specId });
  return specs.length > 0 ? specs[0] : null;
}
```

### 7.5 エラーハンドリング

#### 7.5.1 エラー分類

| エラー種別 | 原因 | 対応 |
|---|---|---|
| **仕様書が存在しない** | データベースに該当IDの仕様書がない | エラーメッセージを表示し、`/cft:spec-list` を案内 |
| **ブランチが異なる** | 仕様書は存在するが、別ブランチで作成されている | ブランチ切り替えの選択UIを表示 |
| **未保存の変更がある** | ブランチ切り替え時に未コミットの変更がある | エラーメッセージを表示し、`git status` を案内 |
| **ブランチ切り替え失敗** | `git checkout` が失敗 | Git のエラーメッセージを表示 |

#### 7.5.2 エラーメッセージ設計

```typescript
// エラーメッセージのテンプレート
const ERROR_MESSAGES = {
  SPEC_NOT_FOUND: (specId: string) => `
❌ 仕様書が見つかりません

指定された仕様書 ID に一致する仕様書がデータベースに存在しません。
  仕様書 ID: ${specId}

仕様書の一覧を確認してください：
  /cft:spec-list
`,

  BRANCH_MISMATCH: (spec: SpecInfo, currentBranch: string) => `
⚠️  この仕様書は別のブランチで作成されています

仕様書情報:
  仕様書 ID: ${spec.id}
  仕様書名: ${spec.name}
  作成されたブランチ: ${spec.branch}

現在のブランチ: ${currentBranch}
`,

  UNSAVED_CHANGES: () => `
⚠️  未保存の変更があります

ブランチを切り替える前に、変更をコミットまたはstashしてください。
  git status          # 変更を確認
  git add .           # 変更をステージング
  git commit -m "..." # コミット
  または
  git stash           # 一時的に退避
`,
};
```

### 7.6 ユーザーインターフェース設計

#### 7.6.1 選択UIの実装

```typescript
import * as readline from 'readline';
import chalk from 'chalk';

async function promptBranchSwitch(
  currentBranch: string,
  targetBranch: string,
  specInfo: { id: string; name: string }
): Promise<boolean> {
  console.log('ブランチを切り替えて仕様書を表示しますか？');
  console.log(chalk.green('  1. はい - ブランチを切り替えて表示'));
  console.log(chalk.gray('  2. いいえ - 現在のブランチに留まる'));
  console.log();

  return new Promise((resolve) => {
    const rl = readline.createInterface({
      input: process.stdin,
      output: process.stdout,
    });

    rl.question('選択してください (1/2): ', (answer) => {
      rl.close();
      resolve(answer.trim() === '1');
    });
  });
}
```

### 7.7 テスト設計

#### 7.7.1 単体テスト

**テストケース:**

1. **正常系**:
   - 現在のブランチで作成された仕様書を取得 → 正常に表示
   - `main` ブランチで作成された仕様書を `develop` ブランチから取得 → 正常に表示

2. **異常系**:
   - 存在しない仕様書 ID を指定 → エラーメッセージ表示
   - 別ブランチの仕様書を指定 → ブランチ切り替え選択 UI 表示
   - 未保存の変更がある状態でブランチ切り替え → エラーメッセージ表示

3. **エッジケース**:
   - `branch_name` が `null` の仕様書 → データベース修復を案内
   - Git リポジトリが初期化されていない → エラーメッセージ表示

#### 7.7.2 E2Eテスト

**シナリオ:**

1. **ブランチ切り替えフロー**:
   - `develop` ブランチで仕様書作成
   - `feature` ブランチに切り替え
   - `/cft:spec-get` で仕様書を取得 → ブランチ切り替え選択 UI 表示
   - 選択肢 1 を選択 → ブランチが切り替わり、仕様書が表示される

2. **キャンセルフロー**:
   - 選択肢 2 を選択 → 現在のブランチに留まり、終了

### 7.8 パフォーマンス最適化

- **ブランチキャッシュの活用**: `getCurrentBranch()` を使用してブランチ名取得のコストを削減
- **クエリの最適化**: 2 段階クエリ（フィルタリング付き → フィルタリングなし）により、不要な処理を回避
- **非同期処理**: `readline` の Promise ラッパーにより、UI をブロックせずに処理

### 7.9 セキュリティ考慮事項

- **コマンドインジェクション対策**: ブランチ名のサニタイゼーション（Git 互換文字のみ許可）
- **入力検証**: 仕様書 ID の UUID フォーマット検証
- **権限チェック**: Git 操作の実行前に、リポジトリの状態を確認

---

## 8. 実装タスクリスト

以下のタスクを順番に実装します。

### タスク 1: ブランチ切り替えユーティリティの実装

**ファイル**: `src/commands/spec/branch-switch.ts` (新規作成)

**内容**:

- `promptBranchSwitch()` 関数を実装（readline モジュールを使用した対話的 UI）
- `switchBranch()` 関数を実装（未保存の変更チェック、ブランチ切り替え、キャッシュクリア）
- エラーメッセージのテンプレート定義

**依存関係**: なし。

**受け入れ基準**:

- [ ] ユーザーに対してブランチ切り替えの選択肢を提供できること。
- [ ] 未保存の変更がある場合、エラーメッセージを表示すること。
- [ ] ブランチ切り替え後、ブランチキャッシュをクリアすること。

---

### タスク 2: spec-get コマンドのブランチフィルタリング機能追加

**ファイル**: `src/commands/spec/get.ts`

**内容**:

- 現在のブランチを取得する処理を追加
- ブランチフィルタリング付きで仕様書を取得する処理を追加
- ブランチフィルタリングなしで再取得する処理を追加（仕様書が見つからない場合）

**依存関係**: なし。

**受け入れ基準**:

- [ ] 現在のブランチで参照可能な仕様書のみを取得できること。
- [ ] `getSpecsWithGitHubInfo` ヘルパー関数を活用すること。
- [ ] フィルタリングルールが `/cft:spec-list` と一致すること。

---

### タスク 3: エラーハンドリングの改善

**ファイル**: `src/commands/spec/get.ts`

**内容**:

- 仕様書が見つからない場合の原因を特定する処理を追加
- ブランチが異なる場合と、仕様書が存在しない場合を区別する
- 適切なエラーメッセージを表示する

**依存関係**: タスク 1、タスク 2。

**受け入れ基準**:

- [ ] 仕様書が存在しない場合、明確なエラーメッセージを表示すること。
- [ ] ブランチが異なる場合、ブランチ情報を含むメッセージを表示すること。
- [ ] エラーメッセージがユーザーフレンドリーであること。

---

### タスク 4: ユーザー選択 UI とブランチ切り替え機能の統合

**ファイル**: `src/commands/spec/get.ts`

**内容**:

- `handleBranchMismatch()` 関数を実装
- ブランチ切り替えユーティリティを呼び出す処理を追加
- ブランチ切り替え後、再度仕様書を表示する処理を追加

**依存関係**: タスク 1、タスク 3。

**受け入れ基準**:

- [ ] ユーザーがブランチ切り替えを選択できること。
- [ ] ブランチ切り替え後、仕様書が正常に表示されること。
- [ ] キャンセルした場合、現在のブランチに留まること。

---

### タスク 5: 単体テストの作成

**ファイル**: `tests/commands/spec/get.test.ts`

**内容**:

- 正常系のテストケース（現在のブランチで作成された仕様書を取得）
- 異常系のテストケース（存在しない仕様書、別ブランチの仕様書）
- エッジケースのテストケース（`branch_name` が `null`、Git 未初期化）

**依存関係**: タスク 1、タスク 2、タスク 3、タスク 4。

**受け入れ基準**:

- [ ] 正常系、異常系、エッジケースのすべてをカバーすること。
- [ ] モックを使用して、Git コマンドの実行を回避すること。
- [ ] テストカバレッジ 80%以上を達成すること。

---

### タスク 6: E2E テストの作成

**ファイル**: `tests/e2e/spec-get-branch-switching.test.ts`

**内容**:

- ブランチ切り替えフローのテスト（選択肢 1 を選択）
- キャンセルフローのテスト（選択肢 2 を選択）
- 未保存の変更がある場合のテスト

**依存関係**: タスク 5。

**受け入れ基準**:

- [ ] 実際のブランチ切り替えを伴うテストが動作すること。
- [ ] ユーザー入力をシミュレートできること。
- [ ] テストが自動化され、CI で実行可能であること。

---

### タスク 7: 既存テストの実行とリグレッションチェック

**内容**:

- `npm test` を実行し、すべてのテストがパスすることを確認
- リグレッションが発生した場合、修正する

**依存関係**: タスク 6。

**受け入れ基準**:

- [ ] すべての既存テストがパスすること。
- [ ] 新しいテストがすべてパスすること。
- [ ] テストカバレッジが低下していないこと。

---

### タスク 8: ソースコードの同期

**内容**:

- `npm run sync:dogfood` を実行し、`src/` から `.cc-craft-kit/` へ同期
- `npm run check:sync` で整合性を確認

**依存関係**: タスク 7。

**受け入れ基準**:

- [ ] 同期が正常に完了すること。
- [ ] `npm run check:sync` で差分が 0 件であること。
- [ ] `.cc-craft-kit/` でコマンドが正常に動作すること。

---

### 実装の優先度

1. **タスク 1** - ブランチ切り替えユーティリティ（基盤となる共通ロジック）
2. **タスク 2** - ブランチフィルタリング機能（コア機能）
3. **タスク 3** - エラーハンドリング（ユーザー体験の向上）
4. **タスク 4** - UI 統合（機能の完成）
5. **タスク 5** - 単体テスト（品質保証）
6. **タスク 6** - E2E テスト（統合テスト）
7. **タスク 7** - リグレッションチェック（安定性確認）
8. **タスク 8** - ソースコード同期（デプロイ準備）
