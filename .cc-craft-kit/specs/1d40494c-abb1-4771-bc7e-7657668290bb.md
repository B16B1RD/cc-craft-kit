# ブランチを作成せずに作業が実施される

**仕様書 ID:** 1d40494c-abb1-4771-bc7e-7657668290bb
**フェーズ:** tasks
**作成日時:** 2025/11/20 09:57:45
**更新日時:** 2025/11/20 10:05:15

---

## 1. 背景と目的

### 背景

本プロジェクトのケースでは、仕様書ごとに develop ブランチから適切なブランチを作成して作業を進めなければならないが、ブランチを作成せず作業を進めて
main ブランチにコミットしてしまっている。また、PR も作成されない。また、.env で保護対象ブランチの指定はあるが、ブランチ派生元の指定がないため、
develop ブランチから派生したブランチの作成はできないものと思われる。このため、PR を作成したとしても develop へマージする PR は作成できないものと思われる。

### 目的

以下の問題を解決し、GitHub Flow + develop ブランチモデルに準拠した開発ワークフローを確立する。

1. **ブランチ作成の自動化**: 仕様書フェーズ移行時（tasks → implementation）に、develop ブランチから適切なブランチ（feature/fix など）を自動作成
2. **保護ブランチへの直接コミット防止**: main/develop ブランチへの直接コミットを防ぎ、作業ブランチでの作業を強制
3. **PR 自動作成**: completed フェーズ移行時に、作業ブランチから develop へのプルリクエストを自動作成
4. **ベースブランチの設定**: .env でブランチ派生元（デフォルト: develop）を指定可能にする

---

## 2. 対象ユーザー

- cc-craft-kit を使用して仕様駆動開発を行う開発者
- GitHub Flow + develop ブランチモデルを採用しているチーム
- 複数の仕様書を並行して開発しているプロジェクト

---

## 3. 受け入れ基準

### 必須要件

- [ ] tasks → implementation フェーズ移行時に、develop ブランチから作業ブランチが自動作成される
- [ ] ブランチ名は仕様書名から自動生成される（例: `feature/add-user-auth`, `fix/database-connection-leak`）
- [ ] completed フェーズ移行時に、作業ブランチから develop へのプルリクエストが自動作成される
- [ ] main/develop ブランチでの作業時は、フェーズ移行前に警告が表示される

### 機能要件

- [ ] .env に `BASE_BRANCH` 設定を追加（デフォルト: develop）
- [ ] ブランチプレフィックスの自動判定（feature/fix/refactor/docs/chore/hotfix）を仕様書名または説明から推論
- [ ] hotfix ブランチの場合、completed フェーズ移行時に main へ PR を作成
- [ ] hotfix マージ後、develop へのバックポート PR を自動作成（または手動作成を案内）
- [ ] hotfix ブランチ判定ロジック（仕様書名に「緊急」「Hotfix」「Critical」が含まれる、またはブランチプレフィックスが `hotfix/`）
- [ ] PR タイトル・本文を仕様書の内容から自動生成
- [ ] PR 作成後、GitHub Issue にリンクを自動記録
- [ ] 既にブランチが存在する場合は、そのブランチをチェックアウト

### 非機能要件

- [ ] Git コマンド実行時のエラーハンドリングを実装
- [ ] ブランチ作成失敗時は、フェーズ移行をロールバック
- [ ] PR 作成失敗時は、警告のみ表示し、フェーズ移行は成功させる
- [ ] ログレベルは info（成功）、warn（スキップ）、error（失敗）を適切に使い分ける

### テストケース

- [ ] tasks → implementation フェーズ移行時、develop ブランチから feature ブランチが作成されることを確認
- [ ] 既にブランチが存在する場合、新規作成せずチェックアウトされることを確認
- [ ] main ブランチでの作業時、フェーズ移行前に警告が表示されることを確認
- [ ] completed フェーズ移行時、develop へ PR が作成されることを確認
- [ ] hotfix ブランチの場合、main へ PR が作成されることを確認
- [ ] ブランチ作成失敗時、フェーズがロールバックされることを確認

---

## 4. 制約条件

- Git リポジトリが初期化されていない場合、ブランチ作成はスキップ
- GitHub 統合が未設定の場合、PR 作成はスキップ
- 現在のブランチが保護対象ブランチでない場合、ブランチ作成はスキップ
- 作業ブランチが既に存在する場合、新規作成せずチェックアウト

---

## 5. 依存関係

- **Git 自動コミット機能** (`src/core/workflow/git-integration.ts`): フェーズ移行時の自動コミット処理
- **GitHub 統合** (`src/integrations/github/`): プルリクエスト作成 API
- **イベント駆動アーキテクチャ** (`src/core/workflow/event-bus.ts`): spec.phase_changed イベントの購読
- **保護ブランチチェック** (`src/core/utils/git-branch-protection.ts`): 既存の保護ブランチ判定ロジック

---

## 6. 参考情報

- **CLAUDE.md のブランチ戦略**: GitHub Flow + develop ブランチモデルの詳細
- **既存の Git 自動コミット機能**: `src/core/workflow/git-integration.ts:100-150`
- **保護ブランチチェック**: `src/core/utils/git-branch-protection.ts:10-30`
- **イベントバス**: `src/core/workflow/event-bus.ts:50-100`
- **GitHub PR 作成**: `src/integrations/github/pull-request.ts`（新規作成予定）

---

## 7. 技術的検討事項

### ブランチ名生成ロジック

仕様書名から適切なブランチ名を生成する。

- **プレフィックス判定**:
  1. 仕様書名に「修正」「バグ」「Fix」「Bug」が含まれる場合は `fix/`
  2. 「リファクタリング」「Refactor」「改善」が含まれる場合は `refactor/`
  3. 「ドキュメント」「Docs」「README」が含まれる場合は `docs/`
  4. 「依存関係」「更新」「Chore」が含まれる場合は `chore/`
  5. 「緊急」「Hotfix」「Critical」が含まれる場合は `hotfix/` (main ブランチから派生)
  6. それ以外は `feature/` (デフォルト)
- **フォールバック**: キーワードマッチングに失敗した場合、`feature/` を使用
- **ブランチ名正規化**: 仕様書名をスラッグ化（小文字、スペース→ハイフン、特殊文字除去、最大 50 文字に切り詰め）
- **例**:
  - 「ユーザー認証機能を追加」→ `feature/add-user-auth`
  - 「データベース接続バグを修正」→ `fix/database-connection-leak`
  - 「パフォーマンスの改善」→ `refactor/improve-performance`
  - 「本番環境の緊急修正」→ `hotfix/production-critical-fix`

### PR 自動作成のタイミング

- **implementation → completed フェーズ移行時**: 作業ブランチから develop へ PR 作成（hotfix の場合は main へ作成）
- **PR タイトル**: 仕様書名
- **PR 本文**: 以下のフォーマットで生成

  ```markdown
  ## Summary
  <仕様書の「1. 背景と目的」の要約を箇条書き（1-3項目）>

  ## 受け入れ基準
  <仕様書の「3. 受け入れ基準」からチェックリストを転記>

  ## Test plan
  - [ ] 単体テスト実行（`npm test`）
  - [ ] ESLint・型チェック実行（`npm run lint`）
  - [ ] E2E テスト実行（該当する場合）

  🤖 Generated with [Claude Code](https://claude.com/claude-code)
  ```

### エラーハンドリング方針

| エラーケース | 動作 |
|---|---|
| Git リポジトリ未初期化 | 警告ログのみ、フェーズ移行は成功 |
| ブランチ作成失敗（権限なし） | エラーログ、フェーズ移行をロールバック |
| PR 作成失敗（GitHub API エラー） | 警告ログのみ、フェーズ移行は成功 |
| 既にブランチが存在 | 既存ブランチをチェックアウト、info ログ |

### ロールバック処理

| エラーケース | ロールバック内容 |
|---|---|
| ブランチ作成失敗 | 1. フェーズを前の状態に戻す<br>2. エラーログを記録<br>3. ユーザーに手動ブランチ作成を案内 |
| チェックアウト失敗 | 1. フェーズを前の状態に戻す<br>2. エラーログを記録<br>3. 作業ディレクトリの状態を確認 |

### Hotfix ワークフローの特別処理

- **ブランチ作成元**: main ブランチ
- **PR 作成先**: main ブランチ
- **バックポート**: main マージ後、develop へのバックポート PR を自動作成
- **判定条件**: 仕様書名に「緊急」「Hotfix」「Critical」が含まれる、またはブランチプレフィックスが `hotfix/`

### .env 設定

| 環境変数 | デフォルト値 | 説明 |
|---|---|---|
| `BASE_BRANCH` | `develop` | 作業ブランチの派生元ブランチ |
| `PROTECTED_BRANCHES` | `main,develop` | 直接コミット禁止ブランチ（カンマ区切り） |
| `GITHUB_DEFAULT_BASE_BRANCH` | `develop` | PR 作成時のベースブランチ（hotfix の場合は `main` に自動切替） |
