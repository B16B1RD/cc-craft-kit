# データベース廃止前の仕様書情報が移行できていない

**仕様書 ID:** 7ae68b97-e109-439f-ba52-afe3737132e8
**フェーズ:** implementation
**作成日時:** 2025/12/05 23:45:30
**更新日時:** 2025/12/06 00:20:38

---

## 1. 背景と目的

### 背景

cc-craft-kit は PR #887 でデータベース（SQLite）を廃止し、JSON ファイルベースのストレージに移行した。しかし、移行時に以下の問題が発生している:

1. **データ移行の不完全性**: 旧 DB に 187 件の仕様書（全て completed）が存在するが、JSON には 34 件のみ登録されている（移行率 18.2%）
2. **ファイルとメタデータの不整合**: `.cc-craft-kit/specs/` に 189 件の .md ファイルが存在するが、`specs.json` には 34 件のみ
3. **ブランチフィルタリングの問題**: `/cft:status` がブランチ名でフィルタリングするため、他ブランチの仕様書が表示されない

例えば、`/cft:status` で件数に反映されていない。

### 目的

データベース廃止前の仕様書情報を完全に JSON ストレージに移行し、`/cft:status` で正確な仕様書件数が表示されるようにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者（プロジェクトの仕様書履歴を確認したいユーザー）

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:status` で全ての仕様書が件数に反映される
- [ ] 旧 DB の 187 件の completed 仕様書が JSON に移行される

### 機能要件

- [ ] `.cc-craft-kit/specs/` 内の全 .md ファイルが `specs.json` に登録される
- [ ] 仕様書のフェーズ情報（特に completed）が正しく移行される
- [ ] `/cft:status` のブランチフィルタリングを削除または改善する

### 非機能要件

- [ ] 移行処理は既存データを破壊しない
- [ ] 移行後の整合性チェックが可能である

---

## 4. 制約条件

- JSON ストレージ形式（`specs.json`）を使用する（DB への逆移行は不可）
- 仕様書ファイル（.md）のメタデータ形式を変更しない
- `src/core/storage/` 配下の既存インターフェースを維持する

---

## 5. 依存関係

- `src/core/storage/specs-storage.ts` - JSON 仕様書読み書き実装
- `src/core/storage/helpers.ts` - `getSpecsWithGitHubInfo` 実装（ブランチフィルタリング）
- `src/commands/status/get-status.ts` - `/cft:status` 用データ取得
- `src/core/sync/sync-service.ts` - ファイル→JSON 同期実装
- `.cc-craft-kit/meta/specs.json` - JSON 仕様書メタデータ
- `.cc-craft-kit/cc-craft-kit.db` - 旧 SQLite データベース（読み取り専用）

---

## 6. 参考情報

- PR #887: データベース廃止の実装
- `.cc-craft-kit/cc-craft-kit.db`: 旧データベース（187 件の completed 仕様書を含む）
- `src/core/storage/helpers.ts:107-111`: ブランチフィルタリングロジック

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
.cc-craft-kit/
├── meta/
│   ├── specs.json          ← JSON ストレージ（現在 34 件、移行後 189+ 件）
│   └── github-sync.json
├── specs/                  ← Markdown ファイル（189 件）
│   ├── *.md
│   └── ...
└── cc-craft-kit.db         ← 旧 SQLite DB（187 件、読み取り専用）

src/core/storage/
├── specs-storage.ts        ← JSON 読み書き（変更なし）
├── json-storage.ts         ← 共通 I/O（変更なし）
├── helpers.ts              ← フィルタリング（修正対象）
└── schemas.ts              ← Zod スキーマ（変更なし）

src/core/sync/
├── sync-service.ts         ← .md インポート（既存活用）
└── spec-file-parser.ts     ← .md パース（変更なし）

src/commands/status/
└── get-status.ts           ← /cft:status（修正対象）
```

#### 設計方針

1. **SyncService の既存機能活用**: .md ファイルからのインポート機能 `importFromDirectory()` を利用
2. **ブランチフィルタリングの改善**: `getSpecsWithGitHubInfo()` に `includeAllBranches` オプション追加
3. **/cft:status の修正**: ブランチフィルタリングを削除し、全仕様書を表示

#### 処理フロー詳細

```
移行フロー:
1. SyncService.importFromDirectory('.cc-craft-kit/specs/') 実行
   ↓
2. 各 .md ファイルを SpecFileParser でパース
   ↓
3. specs.json に upsert（既存は更新、新規は挿入）
   ↓
4. 移行結果レポート出力

/cft:status 改善フロー:
1. getSpecsWithGitHubInfo({ includeAllBranches: true }) 呼び出し
   ↓
2. ブランチフィルタリングをスキップ
   ↓
3. 全仕様書を集計・表示
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/core/storage/helpers.ts` | `GetSpecsWithGitHubInfoOptions` に `includeAllBranches` オプション追加、フィルタリングロジック修正 |
| `src/commands/status/get-status.ts` | `includeAllBranches: true` オプションを使用するよう修正 |
| `src/scripts/migrate-specs-from-files.ts`（新規） | .md ファイルからの一括移行スクリプト |

#### API 変更

```typescript
// helpers.ts - オプション追加
export interface GetSpecsWithGitHubInfoOptions {
  phase?: SpecPhase;
  branchName?: string;
  includeAllBranches?: boolean;  // 新規追加
  limit?: number;
  orderBy?: 'created_at' | 'updated_at';
  orderDirection?: 'asc' | 'desc';
}
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| 仕様書取得 | ブランチフィルタリング強制 | `includeAllBranches` オプションで全件取得可能 | `helpers.ts:107-111` |
| /cft:status | 現在ブランチのみ表示 | 全ブランチの仕様書を表示 | `get-status.ts:71` |
| .md → JSON 同期 | 手動実行なし | 一括移行スクリプト提供 | `migrate-specs-from-files.ts` |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| `getSpecsWithGitHubInfo()` | `includeAllBranches=true` で全件取得 | 単体テスト |
| `getSpecsWithGitHubInfo()` | 既存のブランチフィルタリング動作維持 | 単体テスト |
| 移行スクリプト | 189 件の .md ファイルが移行される | 統合テスト |
| /cft:status | 全仕様書が件数に反映される | 手動確認 |

### 7.5 移行計画

#### Phase 1: helpers.ts のブランチフィルタリング改善

1. `GetSpecsWithGitHubInfoOptions` に `includeAllBranches` オプション追加
2. フィルタリングロジックを条件分岐に変更
3. 既存の動作は維持（後方互換性）

#### Phase 2: /cft:status の修正

1. `get-status.ts` で `includeAllBranches: true` オプションを使用
2. 全仕様書が件数に反映されることを確認

#### Phase 3: .md ファイルからの一括移行

1. SyncService.importFromDirectory() を使用した移行スクリプト作成
2. 189 件の .md ファイルを specs.json に同期
3. 移行結果を確認

---

## 8. 実装タスクリスト

### Phase 1: ブランチフィルタリング改善

- [ ] `src/core/storage/helpers.ts` に `includeAllBranches` オプションを追加 (#898)
- [ ] `getSpecsWithGitHubInfo()` のフィルタリングロジックを修正 (#899)

### Phase 2: /cft:status の修正

- [ ] `src/commands/status/get-status.ts` で `includeAllBranches: true` を使用するよう修正 (#900)

### Phase 3: .md ファイル一括移行

- [ ] `src/scripts/migrate-specs-from-files.ts` 移行スクリプトを作成 (#901)
- [ ] SyncService.importFromDirectory() を呼び出して 189 件の .md ファイルを移行 (#902)
- [ ] 移行後の整合性チェック（specs.json の件数確認） (#903)
