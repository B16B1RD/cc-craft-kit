---
id: "570644e2-814c-4f8b-a42b-b5f654e610e4"
name: "開発キットが .env の BASE_BRANCH や GITHUB_DEFAULT_BASE_BRANCH を参照していない"
phase: "completed"
branch_name: "main"
github_issue_number: null
pr_url: null
created_at: "2025-11-24T03:45:06.869Z"
updated_at: "2025-11-24T13:11:07Z"
---

# 開発キットが .env の BASE_BRANCH や GITHUB_DEFAULT_BASE_BRANCH を参照していない


## 1. 背景と目的

### 背景

開発キットは、カレントブランチを前提とするのではなく、.env の BASE_BRANCH や GITHUB_DEFAULT_BASE_BRANCH を前提とすること。また、GITHUB_DEFAULT_BASE_BRANCH は必要だろうか。BASE_BRANCH だけでいいような気もするがどうなんだろうか。この仕様については、どうあるべきか改めて検討して決めて欲しい。

### 目的

開発キットが `.env` の `BASE_BRANCH` および `GITHUB_DEFAULT_BASE_BRANCH` を正しく参照し、以下を実現する：

1. **ブランチ作成時の派生元を正しく設定**: カレントブランチではなく、`BASE_BRANCH` から作業ブランチを作成
2. **PR作成時のベースブランチを正しく設定**: `GITHUB_DEFAULT_BASE_BRANCH` を使用してPRのマージ先を決定
3. **環境変数の役割を明確化**: `BASE_BRANCH` と `GITHUB_DEFAULT_BASE_BRANCH` の使い分けが必要かどうかを検討し、最適な設計を決定
---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者（特に、チーム開発で Git ブランチ戦略を運用している開発者）
---

## 3. 受け入れ基準

### 必須要件

- [ ] `BASE_BRANCH` 環境変数を `.env` から読み込み、デフォルト値は `develop` とする
- [ ] `GITHUB_DEFAULT_BASE_BRANCH` 環境変数を `.env` から読み込み、デフォルト値は `develop` とする
- [ ] `BASE_BRANCH` と `GITHUB_DEFAULT_BASE_BRANCH` の役割を明確に定義し、両方が必要かどうかを決定する

### 機能要件

- [ ] `src/core/config/github-config.ts` の `GitHubConfig` インターフェースに `baseBranch` フィールドを追加
- [ ] `BASE_BRANCH` 環境変数を読み込むロジックを実装（`PROTECTED_BRANCHES` の参照パターンに準拠）
- [ ] 仕様書作成時（`/cft:spec-create`）のブランチ復帰処理で、`BASE_BRANCH` を参照して戻り先ブランチを決定
- [ ] ブランチ作成処理（`src/core/git/branch-creation.ts`）で `baseBranch` を使用するよう更新
- [ ] PR作成処理で `GITHUB_DEFAULT_BASE_BRANCH` を正しく参照（既存実装の確認）
- [ ] 分析結果に基づき、`BASE_BRANCH` と `GITHUB_DEFAULT_BASE_BRANCH` の使い分けを実装

### 非機能要件

- [ ] エラーハンドリング: 無効な環境変数値が設定された場合、デフォルト値（`develop`）を使用し、警告を表示
- [ ] テストカバレッジ: `PROTECTED_BRANCHES` の参照パターンに準拠したテストケースを追加
- [ ] ドキュメント: `.env.example` のコメントを更新し、各環境変数の役割を明確化
---

## 4. 制約条件

- **Git操作の制約**: ブランチ切り替えは、未コミット変更がない状態でのみ安全に実行可能
- **環境変数の読み込み**: `dotenv` パッケージを使用し、`.env` ファイルから環境変数を読み込む
- **既存実装との互換性**: `GITHUB_DEFAULT_BASE_BRANCH` は既に `src/core/config/github-config.ts:33` で参照されているため、既存の動作を壊さないよう注意
- **デフォルト値の一貫性**: すべてのブランチ関連の環境変数で、デフォルト値は `develop` に統一
- **TypeScript の型安全性**: `GitHubConfig` インターフェースの拡張により、コンパイル時に型チェックを実施
---

## 5. 依存関係

### 関連仕様書

- **1d40494c-abb1-4771-bc7e-7657668290bb** (completed): ブランチを作成せずに作業が実施される
  - `BASE_BRANCH` 環境変数の導入を定義
  - 本仕様書は、この仕様の実装不足を修正するもの
- **71dc7902-75fd-4c8e-b5f3-fadd8fd3cca9** (completed): spec-phase completed 時に PR が自動作成されない
  - PR作成時のベースブランチ決定ロジックに関連

### 依存モジュール

- `src/core/config/github-config.ts`: GitHub設定の読み込みロジック
- `src/core/git/branch-creation.ts`: ブランチ作成ロジック
- `src/core/git/branch-cache.ts`: 現在のブランチ名のキャッシュ管理
- `src/commands/spec/create.ts`: 仕様書作成コマンド（ブランチ復帰処理を含む）
- `src/slash-commands/spec-create.md`: 仕様書作成のスラッシュコマンド定義
---

## 6. 参考情報

### 分析結果の要約

コードベース解析により、以下が明らかになりました：

1. **環境変数の役割分担が必要**
   - `BASE_BRANCH`: ブランチ作成時の派生元（例: develop から feature/xxx を作成）
   - `GITHUB_DEFAULT_BASE_BRANCH`: PR作成時のマージ先（例: feature/xxx から develop へPR）
   - 異なるタイミングで使用されるため、両方の環境変数が必要

2. **現在の実装状況**
   - `GITHUB_DEFAULT_BASE_BRANCH` は `src/core/config/github-config.ts:33` で参照済み
   - `BASE_BRANCH` は `.env.example` に定義されているが、コードでは参照されていない

3. **実装パターン**
   - `PROTECTED_BRANCHES` の参照パターンに準拠
   - `GitHubConfig` インターフェースの拡張
   - デフォルト値: `develop`

### 関連ドキュメント

- `.env.example` (34-40行): 環境変数の定義と説明
- `CLAUDE.md`: Git ワークフロー基本方針
- `docs/ARCHITECTURE.md`: アーキテクチャ設計
---

## 7. 設計詳細

### 7.1. アーキテクチャ設計

#### 環境変数の役割分担

本仕様では、以下の2つの環境変数の役割を明確に分離します：

1. **`BASE_BRANCH`**: ブランチ作成時の派生元
   - 用途: `feature/xxx` や `spec/xxx` ブランチを作成する際の **起点** ブランチ
   - タイミング: `/cft:spec-create` 時、およびブランチ作成処理時
   - デフォルト値: `develop`

2. **`GITHUB_DEFAULT_BASE_BRANCH`**: PR作成時のマージ先
   - 用途: Pull Request の **マージ先** ブランチ
   - タイミング: PR作成時（`/cft:spec-phase <spec-id> completed`）
   - デフォルト値: `develop`

#### 実装方針

既存の実装パターンに準拠し、以下のように実装します：

```typescript
// src/core/config/github-config.ts
export interface GitHubConfig {
  owner: string | null;
  repo: string | null;
  baseBranch: string;  // 追加
  defaultBaseBranch: string;
  protectedBranches: string[];
}

export function getGitHubConfig(): GitHubConfig {
  return {
    owner: process.env.GITHUB_OWNER?.trim() || null,
    repo: process.env.GITHUB_REPO?.trim() || null,
    baseBranch: process.env.BASE_BRANCH?.trim() || 'develop',  // 追加
    defaultBaseBranch: process.env.GITHUB_DEFAULT_BASE_BRANCH?.trim() || 'develop',
    protectedBranches: process.env.PROTECTED_BRANCHES?.split(',')
      .map((b) => b.trim())
      .filter(Boolean) || ['main', 'develop'],
  };
}
```

#### 影響範囲

1. **ブランチ作成処理** (`src/core/git/branch-creation.ts`)
   - `baseBranch` を参照してブランチを作成
   - 保護ブランチチェックとの統合

2. **ブランチ復帰処理** (`src/commands/spec/create.ts`)
   - ブランチ作成後の復帰先を `baseBranch` に変更
   - エラー時のロールバック処理も同様に修正

3. **PR作成処理** (`src/integrations/github/pull-request.ts`)
   - 既に `GITHUB_DEFAULT_BASE_BRANCH` を参照しているため、変更不要

### 7.2. データモデル

本仕様ではデータベーススキーマの変更は不要です。

### 7.3. 環境変数読み込みの統一化

#### 現在の問題点

- `PROTECTED_BRANCHES` は各モジュールで直接 `process.env.PROTECTED_BRANCHES` を参照
- `GITHUB_DEFAULT_BASE_BRANCH` は `GitHubConfig` を経由して参照
- **不統一**: 実装パターンが混在している

#### 統一方針

すべてのGit/GitHub関連の環境変数を `GitHubConfig` 経由で参照するよう統一します：

```typescript
// 修正前（非推奨）
const protectedBranches = (process.env.PROTECTED_BRANCHES || 'main,develop')
  .split(',')
  .map((b) => b.trim());

// 修正後（推奨）
import { getGitHubConfig } from '../../core/config/github-config.js';

const config = getGitHubConfig();
const protectedBranches = config.protectedBranches;
const baseBranch = config.baseBranch;
```

### 7.4. セキュリティ考慮事項

#### 1. 環境変数の検証

- **無効な値の処理**: 空文字列や空白文字のみの場合、デフォルト値 `'develop'` を使用
- **ブランチ名のサニタイゼーション**: 既存の `sanitizeBranchName()` 関数を活用

#### 2. Git操作の安全性

- **未コミット変更のチェック**: ブランチ切り替え前に `git status --porcelain` で確認
- **エラーハンドリング**: ブランチ作成失敗時のロールバック処理を維持

#### 3. デフォルト値の一貫性

- すべてのブランチ関連の環境変数で、デフォルト値を `'develop'` に統一
- `.env.example` のコメントとコードの動作を一致させる

### 7.5. テスト戦略

#### 1. 単体テスト

- **`src/core/config/github-config.ts`**
  - `BASE_BRANCH` 環境変数が正しく読み込まれるか
  - デフォルト値 `'develop'` が使用されるか
  - 空文字列の場合にデフォルト値が使用されるか

- **`src/core/git/branch-creation.ts`**
  - `baseBranch` を参照してブランチが作成されるか
  - 保護ブランチチェックとの統合が正しく動作するか

- **`src/commands/spec/create.ts`**
  - ブランチ復帰処理で `baseBranch` を参照するか
  - エラー時のロールバック処理が正しく動作するか

#### 2. 統合テスト

- **既存テスト**: `tests/core/workflow/branch-management-pr-creation.test.ts`
  - 環境変数 `BASE_BRANCH=develop` を設定
  - ブランチ作成から PR 作成までのフローをテスト

#### 3. テストパターン

```typescript
// tests/core/config/github-config.test.ts
describe('getGitHubConfig', () => {
  it('BASE_BRANCH 環境変数を正しく読み込む', () => {
    process.env.BASE_BRANCH = 'main';
    const config = getGitHubConfig();
    expect(config.baseBranch).toBe('main');
  });

  it('BASE_BRANCH が未設定の場合、デフォルト値 develop を使用', () => {
    delete process.env.BASE_BRANCH;
    const config = getGitHubConfig();
    expect(config.baseBranch).toBe('develop');
  });

  it('BASE_BRANCH が空文字列の場合、デフォルト値 develop を使用', () => {
    process.env.BASE_BRANCH = '';
    const config = getGitHubConfig();
    expect(config.baseBranch).toBe('develop');
  });
});
```

#### 4. カバレッジ目標

- 新規コードのカバレッジ: **100%**
- 修正コードのカバレッジ: **90%以上**
---

## 8. 実装順序

実装は以下の順序で進めます：

1. **Phase 1: 環境変数読み込み**
   - `src/core/config/github-config.ts` に `baseBranch` フィールドを追加
   - 単体テストを追加

2. **Phase 2: ブランチ作成処理の更新**
   - `src/core/git/branch-creation.ts` を修正して `baseBranch` を参照
   - 単体テストを追加

3. **Phase 3: ブランチ復帰処理の更新**
   - `src/commands/spec/create.ts` のブランチ復帰ロジックを修正
   - 単体テストを追加

4. **Phase 4: 統合テスト**
   - `tests/core/workflow/branch-management-pr-creation.test.ts` で統合テスト実施
   - カバレッジ確認

5. **Phase 5: ドキュメント更新**
   - `.env.example` のコメントを更新
   - `CLAUDE.md` にブランチ戦略を追記（必要に応じて）
---

## 9. ロールバック計画

実装後に問題が発生した場合、以下のロールバック手順に従います：

1. **Phase 1-2 で問題発生**: `GitHubConfig` の変更を元に戻す
2. **Phase 3 で問題発生**: ブランチ復帰ロジックを元に戻す
3. **Phase 4 で問題発生**: テストケースを見直し、実装を修正

すべてのフェーズで、Git によるバージョン管理を活用し、コミット単位でロールバック可能な状態を維持します。
---

## 10. 実装タスクリスト

### Phase 1: 環境変数読み込み

- [ ] `src/core/config/github-config.ts` に `baseBranch` フィールドを追加
  - `GitHubConfig` インターフェースを拡張
  - `getGitHubConfig()` 関数で `BASE_BRANCH` 環境変数を読み込み
  - デフォルト値: `'develop'`
- [ ] 単体テストを追加 (`tests/core/config/github-config.test.ts`)
  - `BASE_BRANCH` 環境変数の読み込みテスト
  - デフォルト値のテスト
  - 空文字列のテスト

### Phase 2: ブランチ作成処理の更新

- [ ] `src/core/git/branch-creation.ts` を修正して `baseBranch` を参照
  - `getGitHubConfig()` から `baseBranch` を取得
  - ブランチ作成時に `baseBranch` を使用
  - 保護ブランチチェックとの統合
- [ ] 単体テストを追加
  - `baseBranch` を参照したブランチ作成のテスト
  - 保護ブランチチェックとの統合テスト

### Phase 3: ブランチ復帰処理の更新

- [ ] `src/commands/spec/create.ts` のブランチ復帰ロジックを修正
  - `getGitHubConfig()` から `baseBranch` を取得
  - ブランチ復帰処理で `baseBranch` を参照
  - エラー時のロールバック処理も同様に修正
- [ ] 単体テストを追加
  - ブランチ復帰処理のテスト
  - エラー時のロールバック処理のテスト

### Phase 4: 統合テスト

- [ ] `tests/core/workflow/branch-management-pr-creation.test.ts` で統合テスト実施
  - 環境変数 `BASE_BRANCH=develop` を設定
  - ブランチ作成から PR 作成までのフローをテスト
- [ ] カバレッジ確認
  - 新規コードのカバレッジ: 100%
  - 修正コードのカバレッジ: 90%以上

### Phase 5: ドキュメント更新

- [ ] `.env.example` のコメントを更新
  - `BASE_BRANCH` と `GITHUB_DEFAULT_BASE_BRANCH` の役割を明確化
  - コメントとコードの動作を一致させる
- [ ] `CLAUDE.md` にブランチ戦略を追記（必要に応じて）

### 最終確認

- [ ] `npm run sync:dogfood` で同期
- [ ] `npx tsc --noEmit` で型チェック
- [ ] `npm run lint:fix` でリント・フォーマット
- [ ] すべてのテストが成功することを確認
