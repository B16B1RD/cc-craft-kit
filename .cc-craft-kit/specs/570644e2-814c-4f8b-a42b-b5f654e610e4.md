# 開発キットが .env の BASE_BRANCH や GITHUB_DEFAULT_BASE_BRANCH を参照していない

**仕様書 ID:** 570644e2-814c-4f8b-a42b-b5f654e610e4
**フェーズ:** design
**作成日時:** 2025/11/24 12:45:06
**更新日時:** 2025/11/24 12:53:15

---

## 1. 背景と目的

### 背景

開発キットは、カレントブランチを前提とするのではなく、.env の BASE_BRANCH や GITHUB_DEFAULT_BASE_BRANCH を前提とすること。また、GITHUB_DEFAULT_BASE_BRANCH は必要だろうか。BASE_BRANCH だけでいいような気もするがどうなんだろうか。この仕様については、どうあるべきか改めて検討して決めて欲しい。

### 目的

開発キットが `.env` の `BASE_BRANCH` および `GITHUB_DEFAULT_BASE_BRANCH` を正しく参照し、以下を実現する：

1. **ブランチ作成時の派生元を正しく設定**: カレントブランチではなく、`BASE_BRANCH` から作業ブランチを作成
2. **PR作成時のベースブランチを正しく設定**: `GITHUB_DEFAULT_BASE_BRANCH` を使用してPRのマージ先を決定
3. **環境変数の役割を明確化**: `BASE_BRANCH` と `GITHUB_DEFAULT_BASE_BRANCH` の使い分けが必要かどうかを検討し、最適な設計を決定

---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者（特に、チーム開発で Git ブランチ戦略を運用している開発者）

---

## 3. 受け入れ基準

### 必須要件

- [ ] `BASE_BRANCH` 環境変数を `.env` から読み込み、デフォルト値は `develop` とする
- [ ] `GITHUB_DEFAULT_BASE_BRANCH` 環境変数を `.env` から読み込み、デフォルト値は `develop` とする
- [ ] `BASE_BRANCH` と `GITHUB_DEFAULT_BASE_BRANCH` の役割を明確に定義し、両方が必要かどうかを決定する

### 機能要件

- [ ] `src/core/config/github-config.ts` の `GitHubConfig` インターフェースに `baseBranch` フィールドを追加
- [ ] `BASE_BRANCH` 環境変数を読み込むロジックを実装（`PROTECTED_BRANCHES` の参照パターンに準拠）
- [ ] 仕様書作成時（`/cft:spec-create`）のブランチ復帰処理で、`BASE_BRANCH` を参照して戻り先ブランチを決定
- [ ] ブランチ作成処理（`src/core/git/branch-creation.ts`）で `baseBranch` を使用するよう更新
- [ ] PR作成処理で `GITHUB_DEFAULT_BASE_BRANCH` を正しく参照（既存実装の確認）
- [ ] 分析結果に基づき、`BASE_BRANCH` と `GITHUB_DEFAULT_BASE_BRANCH` の使い分けを実装

### 非機能要件

- [ ] エラーハンドリング: 無効な環境変数値が設定された場合、デフォルト値（`develop`）を使用し、警告を表示
- [ ] テストカバレッジ: `PROTECTED_BRANCHES` の参照パターンに準拠したテストケースを追加
- [ ] ドキュメント: `.env.example` のコメントを更新し、各環境変数の役割を明確化

---

## 4. 制約条件

- **Git操作の制約**: ブランチ切り替えは、未コミット変更がない状態でのみ安全に実行可能
- **環境変数の読み込み**: `dotenv` パッケージを使用し、`.env` ファイルから環境変数を読み込む
- **既存実装との互換性**: `GITHUB_DEFAULT_BASE_BRANCH` は既に `src/core/config/github-config.ts:33` で参照されているため、既存の動作を壊さないよう注意
- **デフォルト値の一貫性**: すべてのブランチ関連の環境変数で、デフォルト値は `develop` に統一
- **TypeScript の型安全性**: `GitHubConfig` インターフェースの拡張により、コンパイル時に型チェックを実施

---

## 5. 依存関係

### 関連仕様書

- **1d40494c-abb1-4771-bc7e-7657668290bb** (completed): ブランチを作成せずに作業が実施される
  - `BASE_BRANCH` 環境変数の導入を定義
  - 本仕様書は、この仕様の実装不足を修正するもの
- **71dc7902-75fd-4c8e-b5f3-fadd8fd3cca9** (completed): spec-phase completed 時に PR が自動作成されない
  - PR作成時のベースブランチ決定ロジックに関連

### 依存モジュール

- `src/core/config/github-config.ts`: GitHub設定の読み込みロジック
- `src/core/git/branch-creation.ts`: ブランチ作成ロジック
- `src/core/git/branch-cache.ts`: 現在のブランチ名のキャッシュ管理
- `src/commands/spec/create.ts`: 仕様書作成コマンド（ブランチ復帰処理を含む）
- `src/slash-commands/spec-create.md`: 仕様書作成のスラッシュコマンド定義

---

## 6. 参考情報

### 分析結果の要約

コードベース解析により、以下が明らかになりました：

1. **環境変数の役割分担が必要**
   - `BASE_BRANCH`: ブランチ作成時の派生元（例: develop から feature/xxx を作成）
   - `GITHUB_DEFAULT_BASE_BRANCH`: PR作成時のマージ先（例: feature/xxx から develop へPR）
   - 異なるタイミングで使用されるため、両方の環境変数が必要

2. **現在の実装状況**
   - `GITHUB_DEFAULT_BASE_BRANCH` は `src/core/config/github-config.ts:33` で参照済み
   - `BASE_BRANCH` は `.env.example` に定義されているが、コードでは参照されていない

3. **実装パターン**
   - `PROTECTED_BRANCHES` の参照パターンに準拠
   - `GitHubConfig` インターフェースの拡張
   - デフォルト値: `develop`

### 関連ドキュメント

- `.env.example` (34-40行): 環境変数の定義と説明
- `CLAUDE.md`: Git ワークフロー基本方針
- `docs/ARCHITECTURE.md`: アーキテクチャ設計
