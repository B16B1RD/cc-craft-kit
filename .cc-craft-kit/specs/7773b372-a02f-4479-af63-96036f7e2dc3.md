# .cc-craft-kit/ の内容見直し

**仕様書 ID:** 7773b372-a02f-4479-af63-96036f7e2dc3
**フェーズ:** completed
**作成日時:** 2025/12/05 21:00:00
**更新日時:** 2025/12/05 23:09:00

---

## 1. 背景と目的

### 背景

無駄（不要）なファイルやディレクトリが大量にある。

cc-craft-kit は本来、**カスタムスラッシュコマンド、スキル、サブエージェント**で構成されるべき性質のツールキットである。しかし現状では、`.cc-craft-kit/` 配下に大量の TypeScript 実装（約 1.3MB、152 ファイル）が存在し、スラッシュコマンド（.md）から `npx tsx .cc-craft-kit/commands/...` を呼び出す設計となっている。

これは「プロンプトファースト」原則が**過剰に適用**された結果、本来スキルとして実装されるべき機能が TypeScript スクリプトとして実装され、スラッシュコマンドがそれらを呼び出す「ラッパー」に成り下がっている可能性がある。

### 現状の構成

```
.cc-craft-kit/              ← 約 4.7MB
├── specs/          2.9M    ← 仕様書データ（必要）
├── core/           740K    ← TypeScript 実装（疑問）
├── backups/        424K    ← 古いバックアップ（不要）
├── commands/       344K    ← TypeScript 実装（疑問）
├── integrations/   152K    ← GitHub API 等（疑問）
├── plugins/        40K     ← プラグイン実装（疑問）
├── scripts/        24K     ← ユーティリティ（疑問）
├── hooks/          20K     ← フック実装（疑問）
├── skills/         16K     ← スキル（重複？）
├── cc-craft-kit.db 454K    ← ランタイムDB（必要）
└── config.json     358B    ← 設定ファイル（必要）
```

### 本来あるべき構成

```
.claude/                    ← Claude Code 標準
├── commands/cft/           ← スラッシュコマンド（プロンプト）
├── skills/                 ← スキル（プロンプト + 最小限のスクリプト）
└── agents/                 ← サブエージェント（プロンプト）

.cc-craft-kit/              ← ランタイムデータのみ
├── specs/                  ← 仕様書データ
├── cc-craft-kit.db         ← ランタイムDB
└── config.json             ← 設定ファイル
```

### 目的

1. `.cc-craft-kit/` ディレクトリ内の不要なファイル・ディレクトリを整理し、リポジトリサイズを削減する
2. 現在の設計が「プロンプトファースト」原則に適合しているか検証する
3. スキルが本来の構成（プロンプト中心）で実装されているか確認し、必要に応じて再設計する
4. `.cc-craft-kit/` をランタイムデータ専用ディレクトリに再定義する

---

## 2. 対象ユーザー

- cc-craft-kit の開発者
- cc-craft-kit を使用してプロジェクトを管理するユーザー

---

## 3. 受け入れ基準

### 必須要件

- [ ] `.cc-craft-kit/backups/` ディレクトリの古いバックアップファイルを削除する
- [ ] 同期対象外で不要と判断されたファイル・ディレクトリを特定して削除する
- [ ] 現在の TypeScript 実装が本当に必要か検証する

### 機能要件

- [ ] TypeScript 実装の必要性を分類する:
  - DB 操作（Kysely）→ 必要（プロンプトでは不可）
  - GitHub API（Octokit）→ 必要（プロンプトでは不可）
  - ファイル監視（Chokidar）→ 必要（プロンプトでは不可）
  - それ以外 → プロンプト化を検討
- [ ] スキルの実装状況を確認し、本来の構成に修正する
- [ ] 削除後も `npm run sync:dogfood` が正常に動作することを確認する

### 非機能要件

- [ ] リポジトリサイズが削減される（不要ファイル削除による）
- [ ] 保持すべきファイル（specs/、cc-craft-kit.db、config.json）が影響を受けないこと
- [ ] プロンプトファースト原則に適合した構成になること

---

## 4. 制約条件

- `.cc-craft-kit/specs/` ディレクトリは削除不可（ユーザー作成の仕様書データ）
- `.cc-craft-kit/cc-craft-kit.db` は削除不可（ランタイムデータベース）
- `.cc-craft-kit/config.json` は削除不可（GitHub連携設定）
- `src/` から同期される以下のディレクトリは同期後のみ存在:
  - `commands/`, `core/`, `hooks/`, `integrations/`, `plugins/`, `scripts/`

---

## 5. 依存関係

- `src/scripts/sync-dogfood.ts` - 同期スクリプト（削除パターンの追加対象）
- `npm run sync:dogfood` - 同期コマンド
- CLAUDE.md - ディレクトリ構成の説明を含む

---

## 6. 参考情報

### 6.1 不要と判断されたファイル

- `.cc-craft-kit/backups/` - 古いバックアップファイル（2025/12/04）

### 6.2 検証が必要なファイル・ディレクトリ

| ディレクトリ | サイズ | 内容 | 検証観点 |
|---|---|---|---|
| `commands/` | 344K | CLI コマンド実装 | スラッシュコマンドで代替可能か |
| `core/` | 740K | コア機能実装 | DB/GitHub API 以外をプロンプト化可能か |
| `hooks/` | 20K | フック実装 | Claude Code フック機能で代替可能か |
| `integrations/` | 152K | GitHub API 等 | 必要（Octokit 依存） |
| `plugins/` | 40K | プラグイン実装 | スキルで代替可能か |
| `scripts/` | 24K | ユーティリティ | 必要性を個別に検証 |
| `skills/` | 16K | スキル定義 | `.claude/skills/` との重複を確認 |

### 6.3 保持すべきファイル（確定）

- `.cc-craft-kit/specs/` - 仕様書データ
- `.cc-craft-kit/cc-craft-kit.db` - ランタイムDB
- `.cc-craft-kit/config.json` - 設定ファイル

### 6.4 設計上の懸念事項

1. **プロンプトファースト原則の過剰適用**
   - 現状: スラッシュコマンド（.md）→ TypeScript スクリプト呼び出し
   - 問題: スラッシュコマンドが単なるラッパーになっている
   - 本来: プロンプトで実現可能な処理はプロンプト内で完結すべき

2. **スキルの実装不備**
   - 現状: `.claude/skills/` に 4 つのスキルが存在
   - 問題: TypeScript 実装がスキル外に分散している可能性
   - 本来: スキルは「プロンプト + 必要最小限のスクリプト」で構成すべき
   - **対応方針**: スキルは公式仕様（ベストプラクティス）に沿って再実装する（後述 6.6 参照）

3. **ディレクトリ構成の混乱**
   - `.cc-craft-kit/skills/` と `.claude/skills/` の役割が不明確
   - `src/` → `.cc-craft-kit/` の同期が本当に必要か

### 6.5 プロンプトファースト原則（参考）

> プロンプト（.md）で実現できることはプロンプトで済ませる。
> スクリプト（.ts）は以下の場合のみ:
> - DB 操作（Kysely）
> - GitHub API（Octokit）
> - イベント駆動（EventBus）
> - ファイル監視（Chokidar）

**ただし、スキルはその性質上プログラムを内包するものであり、プロンプトファースト原則の例外となる。**
スキルについては、Claude Code 公式仕様（ベストプラクティス）に従って実装すべきである。

### 6.6 スキルの公式仕様（ベストプラクティス）

スキルは公式仕様に沿って実装する必要がある。以下は Claude Code 公式ドキュメントに基づく。

#### スキルの本来の構成

```
.claude/skills/
├── skill-name/
│   ├── SKILL.md              ← 必須: プロンプト本体
│   ├── reference.md          ← オプション: 参考資料
│   ├── templates/            ← オプション: テンプレート
│   └── scripts/              ← オプション: ユーティリティスクリプト
```

#### SKILL.md の必須要素

```yaml
---
name: skill-name              # 必須: 小文字・数字・ハイフンのみ（最大64文字）
description: What this does   # 必須: 機能説明と使用場面（最大1024文字）
---
```

#### スキル vs スラッシュコマンドの使い分け

| 観点 | スキル | スラッシュコマンド |
|------|--------|-----------------|
| **呼び出し方** | Claude が自動検出・使用（自律的） | ユーザーが `/command` で明示的に実行 |
| **トリガー** | タスクの文脈から自動判断 | ユーザーの明示的な指示 |
| **複雑性** | 複雑な機能・参考資料を含む | シンプルなプロンプト |
| **ファイル構成** | ディレクトリ（複数ファイル可） | 単一の `.md` ファイル |

#### スキルに含めるべきもの

- **概要セクション**: 機能一覧
- **使用例**: コード例（Good/Bad パターン）
- **ベストプラクティス**: 推奨される使い方
- **トラブルシューティング**: よくある問題と解決策
- **出力フォーマット**: レポート構造の指定
- **チェックリスト**: バリデーション項目

#### スキルが使用できるツール

- `Read/Glob/Grep`: ファイル読み込み・検索
- `Bash`: コマンド実行（`tsc`, `eslint`, `npm test` など）
- `Edit`: ファイル編集
- `WebFetch`: 外部リソース取得

#### 公式ドキュメント参照

- Skills 公式: https://docs.anthropic.com/en/docs/claude-code/skills
- Slash Commands: https://docs.anthropic.com/en/docs/claude-code/slash-commands

### 6.7 現在のスキル実装状況と課題

現在 `.claude/skills/` に存在するスキル:

| スキル名 | 状態 | コードブロック数 | 課題 |
|---|---|---:|---|
| `database-schema-validator` | SKILL.md のみ | 46 | スクリプトがプロンプト内に記述 |
| `git-operations` | SKILL.md のみ | 44 | スクリプトがプロンプト内に記述 |
| `pr-creator` | SKILL.md のみ | 24 | スクリプトがプロンプト内に記述 |
| `typescript-eslint` | SKILL.md のみ | 16 | スクリプトがプロンプト内に記述 |

**問題点**:

1. **`.cc-craft-kit/skills/` に別のスキル定義が存在**
   - `.claude/skills/` と役割が重複・混乱している

2. **TypeScript 実装がスキルディレクトリ外に分散**
   - `.cc-craft-kit/core/` 等に配置されている
   - スキルが必要とするスクリプトはスキルディレクトリ内の `scripts/` に配置すべき

3. **SKILL.md 内にスクリプトが直接記述されている**
   - 各スキルの SKILL.md に多数のコードブロック（16〜46個）が存在
   - 実行可能なスクリプト（`gh pr create`, `git commit` 等）がプロンプト内に埋め込まれている
   - **対応方針**: 実行可能なスクリプトは `scripts/` ディレクトリに分離し、SKILL.md からは参照のみとすべき

#### 推奨されるスキル構成（修正後）

```
.claude/skills/
├── pr-creator/
│   ├── SKILL.md              ← プロンプト（処理フローの説明）
│   ├── reference.md          ← 参考資料（詳細な仕様）
│   └── scripts/
│       └── create-pr.sh      ← 実行可能スクリプト
├── database-schema-validator/
│   ├── SKILL.md
│   └── scripts/
│       └── validate-schema.ts
└── ...
```

**メリット**:
- プロンプト（SKILL.md）と実装（scripts/）の責務が明確に分離される
- スクリプトの再利用性・テスト容易性が向上する
- SKILL.md の可読性が向上する

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

コードベース解析の結果、現在の `.cc-craft-kit/` は以下の 3 層構造となっていることが判明:

```
.cc-craft-kit/
├── ランタイムデータ層（必須・削除不可）
│   ├── cc-craft-kit.db     ← SQLite データベース（仕様書・同期情報）
│   ├── specs/              ← 仕様書ファイル（184 個）
│   └── config.json         ← プロジェクト設定
│
├── 実装層（TypeScript・必須）
│   ├── core/               ← DB 操作・業務ロジック（89 ファイル）
│   ├── commands/           ← CLI コマンド実装
│   ├── integrations/       ← GitHub API（Octokit）
│   ├── hooks/              ← ライフサイクルフック
│   └── scripts/            ← ユーティリティ
│
├── 拡張層（保持）
│   ├── plugins/            ← 公式プラグイン
│   └── skills/             ← スキル実装（重複あり）
│
└── 管理層（削除候補）
    └── backups/            ← 古いバックアップ DB（430KB）
```

#### 設計方針

**結論: 現在の TypeScript 実装は必要**

コードベース解析の結果、当初の懸念（「プロンプトファースト原則の過剰適用」）は**杞憂**であることが判明:

1. **TypeScript 実装は正当な理由で存在する**
   - DB 操作（Kysely）: `core/database/` - プロンプトでは不可
   - GitHub API（Octokit）: `integrations/github/` - プロンプトでは不可
   - イベント駆動（EventBus）: `core/workflow/` - プロンプトでは不可

2. **スラッシュコマンドの設計は適切**
   - `.md` ファイルでプロンプト定義
   - `npx tsx` で TypeScript スクリプト呼び出し
   - これは「プロンプトファースト」の正しい解釈

3. **削除対象は限定的**
   - `backups/` ディレクトリ（古いバックアップ）のみ
   - `.cc-craft-kit/skills/` の整理（重複解消）

#### 処理フロー詳細

```
削除処理フロー:

1. 不要ファイル削除
   └── .cc-craft-kit/backups/ を rm -rf で削除

2. 重複スキル整理
   └── .cc-craft-kit/skills/ の内容を確認
   └── .claude/skills/ との重複を解消

3. sync-dogfood.ts 更新（任意）
   └── backups/ を削除パターンに追加

4. 動作確認
   └── npm run sync:dogfood 実行
   └── 既存機能のテスト
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `.cc-craft-kit/backups/` | ディレクトリごと削除 |
| `.cc-craft-kit/skills/` | 重複確認・整理 |
| `src/scripts/sync-dogfood.ts` | backups/ 削除パターン追加（任意） |

#### 削除対象の詳細

| パス | サイズ | 理由 |
|------|--------|------|
| `.cc-craft-kit/backups/cc-craft-kit-2025-12-04T13-32-18-101Z.db` | 430KB | 古いバックアップ（復元不要） |

#### 検証対象の詳細

| パス | 確認内容 |
|------|---------|
| `.cc-craft-kit/skills/prompt-first-reviewer/` | 用途不明・src/ に対応なし |

### 7.3 機能マッピング

| 機能 | 現在の実装 | 変更後 | 実装場所 |
|-----|----------|--------|---------|
| バックアップ管理 | backups/ に古い DB が存在 | 削除（不要） | - |
| スキル定義 | .cc-craft-kit/skills/ と .claude/skills/ が重複 | .claude/skills/ に統一 | .claude/skills/ |
| 同期スクリプト | backups/ 未対応 | backups/ 削除パターン追加 | src/scripts/sync-dogfood.ts |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| 削除後の同期 | `npm run sync:dogfood` が正常動作 | コマンド実行・エラーなし |
| スキル動作 | 既存スキルが正常動作 | `/cft:lint-check` 等の実行 |
| 仕様書操作 | 仕様書の CRUD が正常 | `/cft:spec-list`, `/cft:spec-get` |

### 7.5 移行計画

#### Phase 1: 不要ファイル削除

1. `.cc-craft-kit/backups/` ディレクトリを削除
2. 削除後の動作確認（sync-dogfood 実行）

#### Phase 2: スキル重複整理

1. `.cc-craft-kit/skills/` の内容を確認
2. `.claude/skills/` との重複を解消
3. 不要なスキル定義を削除

#### Phase 3: 同期スクリプト更新（任意）

1. `src/scripts/sync-dogfood.ts` に backups/ 削除パターンを追加
2. 今後の自動削除を有効化

---

## 8. 実装タスクリスト

### Phase 1: 不要ファイル削除

- [x] `.cc-craft-kit/backups/` ディレクトリを削除する (#796)
- [x] 削除後に `npm run sync:dogfood` が正常に動作することを確認する (#797)

### Phase 2: スキル重複整理

- [x] `.cc-craft-kit/skills/` の内容を確認し、用途不明なスキルを特定する (#798)
- [x] `.claude/skills/` との重複を解消する（不要なスキル定義を削除） (#799)

### Phase 3: 同期スクリプト更新

- [x] `src/scripts/sync-dogfood.ts` に `backups/` ディレクトリの削除パターンを追加する (#800)
- [x] 最終動作確認を行う（lint, typecheck, test） (#801)

---

## Pull Request

- https://github.com/B16B1RD/cc-craft-kit/pull/802
