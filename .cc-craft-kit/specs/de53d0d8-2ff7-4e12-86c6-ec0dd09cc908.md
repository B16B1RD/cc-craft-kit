# /cft:spec-delete で GitHub Issue のクローズはオプションなしでできるようにしたい

**仕様書 ID:** de53d0d8-2ff7-4e12-86c6-ec0dd09cc908
**フェーズ:** tasks
**作成日時:** 2025/11/23 15:35:13
**更新日時:** 2025/11/23 15:45:39

---

## 1. 背景と目的

### 背景

現在、`/cft:spec-delete` コマンドで仕様書を削除する際、関連する GitHub Issue をクローズするには `--close-github-issue` オプションを明示的に指定する必要があります。しかし、仕様書削除時には通常 GitHub Issue も不要になるため、毎回オプションを指定するのは手間です。

また、フェーズ `completed` 時には GitHub Issue が自動的にクローズされる実装があり、一貫性の観点からも仕様書削除時にも自動クローズが望ましいと考えられます。

### 目的

- `/cft:spec-delete` コマンド実行時、デフォルトで GitHub Issue を自動的にクローズできるようにする
- オプション指定の手間を削減し、ユーザー体験を向上させる
- GitHub 統合の一貫性を保つ（completed フェーズと同様の自動クローズ動作）

---

## 2. 対象ユーザー

- **cc-craft-kit を使用する開発者**
  - 仕様書と GitHub Issue を統合して管理している開発者
  - 仕様書削除時に手動で GitHub Issue をクローズする手間を削減したいユーザー

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-delete` コマンドをオプションなしで実行した際、GitHub Issue がデフォルトで自動的にクローズされること
- [ ] `--close-github-issue` オプションを指定した場合も正常に動作すること（後方互換性）
- [ ] GitHub 未設定時や GitHub Issue が存在しない場合でも、エラーなく仕様書削除が完了すること

### 機能要件

- [ ] `src/commands/spec/delete.ts` の `closeGitHubIssue` のデフォルト値を `false` から `true` に変更すること
- [ ] 確認プロンプトに「GitHub Issue がクローズされる」旨のメッセージが表示されること
- [ ] GitHub API エラー時（404, 401, 403, 500）のエラーハンドリングが正常に動作すること
- [ ] スラッシュコマンドのドキュメント（`src/slash-commands/spec-delete.md`）を更新すること

### 非機能要件

- [ ] 既存のエラーハンドリング、トランザクション設計を変更しないこと
- [ ] GitHub API レート制限に配慮した実装であること
- [ ] 型安全性（TypeScript strict mode）を維持すること

---

## 4. 制約条件

- **技術的制約**
  - CLI パーサーは Node.js 標準の `process.argv` を使用（外部ライブラリ非依存）
  - GitHub API レート制限: 認証あり 5,000 requests/hour、認証なし 60 requests/hour
  - TypeScript strict mode を有効にした型チェックが必須

- **互換性制約**
  - 既存の `--close-github-issue` オプションは後方互換性のため維持すること
  - 既存のエラーハンドリングロジックを変更しないこと
  - 確認プロンプト（`--yes` オプション）の動作を変更しないこと

- **安全性制約**
  - GitHub Issue クローズ失敗時、仕様書削除処理をロールバックすること（既存の動作を維持）
  - GITHUB_TOKEN 未設定時は適切なエラーメッセージを表示すること

---

## 5. 依存関係

- **ファイル依存**
  - `src/commands/spec/delete.ts` - メイン実装ファイル（デフォルト値変更）
  - `src/slash-commands/spec-delete.md` - ドキュメント更新
  - `src/integrations/github/issues.ts` - GitHub API クライアント（変更なし）

- **関連する既存機能**
  - フェーズ `completed` 時の自動 Issue クローズ機能（`src/core/workflow/github-integration.ts:384-414`）
  - GitHub 統合の初期化（`/cft:github-init`）
  - GitHub Issue 自動リカバリー（`ensureGitHubIssue`）

- **外部依存**
  - GitHub API (REST API v3)
  - 環境変数 `GITHUB_TOKEN`（GitHub 認証）

---

## 6. 参考情報

- **実装ファイル**
  - `src/commands/spec/delete.ts:64` - デフォルト値定義箇所
  - `src/commands/spec/delete.ts:151-228` - GitHub Issue クローズロジック
  - `src/core/workflow/github-integration.ts:384-414` - completed フェーズの自動クローズ実装

- **設計指針**
  - コードベース解析の推奨設計: デフォルト値を `false` → `true` に変更（1行の変更）
  - 既存のエラーハンドリング、確認プロンプトはそのまま活用
  - 後方互換性を維持（破壊的変更なし）

- **GitHub API ドキュメント**
  - [GitHub REST API - Issues](https://docs.github.com/en/rest/issues/issues#update-an-issue)
  - [GitHub API レート制限](https://docs.github.com/en/rest/rate-limit)

---

## 7. 設計詳細

### 7.1. アーキテクチャ設計

#### 7.1.1 現在の処理フロー

`/cft:spec-delete` コマンドの実行フローは以下の通りです。

```
ユーザー入力: /cft:spec-delete <spec-id> [--close-github-issue] [--yes]
        ↓
┌──────────────────────────────────────────┐
│ 1. カスタムスラッシュコマンド (.md)            │
│    - spec-delete.md のプロンプト展開          │
└──────────────────────────────────────────┘
        ↓
┌──────────────────────────────────────────┐
│ 2. TypeScript スクリプト実行                │
│    - npx tsx .cc-craft-kit/commands/      │
│      spec/delete.ts <spec-id> [options]   │
└──────────────────────────────────────────┘
        ↓
┌──────────────────────────────────────────┐
│ 3. deleteSpec() 関数 (delete.ts:64)       │
│    - 引数パース                            │
│    - デフォルト値適用 (closeGitHubIssue)   │
│    - バリデーション                        │
└──────────────────────────────────────────┘
        ↓
┌──────────────────────────────────────────┐
│ 4. 確認プロンプト (delete.ts:113-142)      │
│    - 削除対象の確認                        │
│    - GitHub Issue クローズの警告            │
│    - ユーザー入力待機 (y/N)                │
└──────────────────────────────────────────┘
        ↓
┌──────────────────────────────────────────┐
│ 5. GitHub Issue クローズ (delete.ts:151)   │
│    - GITHUB_TOKEN 確認                    │
│    - GitHub 設定確認                       │
│    - issues.close() API 呼び出し           │
│    - エラーハンドリング (404は警告のみ)      │
└──────────────────────────────────────────┘
        ↓ [成功]
┌──────────────────────────────────────────┐
│ 6. データベース削除 (delete.ts:230)        │
│    - specs テーブルからレコード削除         │
└──────────────────────────────────────────┘
        ↓
┌──────────────────────────────────────────┐
│ 7. ファイル削除 (delete.ts:233-237)       │
│    - .cc-craft-kit/specs/<id>.md 削除     │
└──────────────────────────────────────────┘
        ↓
┌──────────────────────────────────────────┐
│ 8. イベント発火 (delete.ts:239-246)       │
│    - spec.deleted イベント発火            │
└──────────────────────────────────────────┘
```

#### 7.1.2 修正設計

**変更内容**: デフォルト値を `false` から `true` に変更

**変更箇所**: `src/commands/spec/delete.ts:64`

```typescript
// 修正前
const { color = true, skipConfirmation = false, closeGitHubIssue = false } = options;

// 修正後
const { color = true, skipConfirmation = false, closeGitHubIssue = true } = options;
```

**設計の根拠**:
1. **一貫性**: completed フェーズ移行時に GitHub Issue が自動クローズされる実装と整合
2. **ユーザビリティ**: 仕様書削除時は通常 GitHub Issue も不要になるため、デフォルトで自動クローズが望ましい
3. **後方互換性**: `--close-github-issue` オプションは引き続き動作（明示的な指定が可能）
4. **安全性**: 確認プロンプトで「GitHub Issue がクローズされる」旨を表示し、ユーザーに確認を求める

#### 7.1.3 エラーハンドリング設計

GitHub Issue クローズ時のエラーハンドリングは、既存の実装を維持します。

| エラータイプ | 状態コード | 処理 | 結果 |
|---|---|---|---|
| Issue が存在しない | 404 | 警告表示 + 削除続行 | **削除成功** |
| 認証失敗 | 401 | エラースロー | **削除スキップ** |
| レート制限超過 | 403 | エラースロー | **削除スキップ** |
| GitHub API 障害 | 500 | エラースロー | **削除スキップ** |
| その他エラー | - | エラースロー | **削除スキップ** |

**ロールバック戦略**:
- GitHub Issue クローズを**最初に実行**（失敗時に状態が変更されない）
- データベース削除・ファイル削除は**Issue クローズ成功後のみ実行**
- イベント発火は**すべて成功後のみ実行**

### 7.2. データモデル

本機能はデータモデルの変更を伴いません。既存のテーブル構造をそのまま使用します。

#### 関連テーブル

**specs テーブル**:
```typescript
export interface SpecsTable {
  id: Generated<string>;           // UUID
  name: string;
  description: string | null;
  phase: SpecPhase;
  branch_name: string;
  created_at: ColumnType<Date>;
  updated_at: ColumnType<Date>;
}
```

**github_sync テーブル**:
```typescript
export interface GitHubSyncTable {
  id: Generated<string>;
  entity_type: GitHubEntityType;   // 'spec', 'task', 'issue'
  entity_id: string;                // spec.id
  github_id: string;                // GitHub Issue ID
  github_number: number;            // GitHub Issue 番号
  created_at: ColumnType<Date>;
  updated_at: ColumnType<Date>;
}
```

**クエリ**:
```typescript
// GitHub Issue 情報の取得
const githubSync = await db
  .selectFrom('github_sync')
  .selectAll()
  .where('entity_type', '=', 'spec')
  .where('entity_id', '=', spec.id)
  .executeTakeFirst();
```

### 7.3. API 設計

#### 7.3.1 deleteSpec 関数のインターフェース

```typescript
export interface DeleteSpecOptions {
  color?: boolean;                  // カラー出力の有効化（デフォルト: true）
  skipConfirmation?: boolean;       // 確認プロンプトのスキップ（デフォルト: false）
  closeGitHubIssue?: boolean;       // GitHub Issue を自動クローズ（デフォルト: true に変更）
}

export async function deleteSpec(
  specIdPrefix: string,
  options: DeleteSpecOptions = {}
): Promise<void>
```

**変更点**:
- `closeGitHubIssue` のデフォルト値を `false` から `true` に変更

#### 7.3.2 GitHub API 呼び出し

**使用するメソッド**: `GitHubIssues.close()`

```typescript
// src/integrations/github/issues.ts:145-154
async close(owner: string, repo: string, issueNumber: number): Promise<IssueResponse> {
  return this.update({
    owner,
    repo,
    issueNumber,
    state: 'closed',
  });
}
```

**内部的な実装**:
- GitHub REST API の `PATCH /repos/{owner}/{repo}/issues/{issue_number}` を呼び出し
- `state: 'closed'` を設定

### 7.4. セキュリティ考慮事項

#### 7.4.1 認証情報の管理

- **GITHUB_TOKEN**: 環境変数 `.env` で管理（コードに埋め込まない）
- **トークン未設定時**: エラーメッセージを表示して削除処理をスキップ
- **トークン検証**: GitHub API 呼び出し時にトークンの有効性を自動検証

#### 7.4.2 権限チェック

- **必要な権限**: `repo` スコープ（Issue の読み書き権限）
- **権限不足時**: 401 エラーをキャッチして適切なエラーメッセージを表示

#### 7.4.3 レート制限対策

- **レート制限**: 認証あり 5,000 requests/hour、認証なし 60 requests/hour
- **レート制限超過時**: 403 エラーをキャッチして削除処理をスキップ
- **推奨**: GitHub Actions の `GITHUB_TOKEN` を使用してレート制限を緩和

### 7.5. テスト戦略

#### 7.5.1 単体テスト

**テストファイル**: `tests/commands/spec/delete.test.ts`

**テストケース**:

1. **基本的な削除機能**:
   - デフォルト値で GitHub Issue が自動クローズされること
   - 確認プロンプトで "y" を入力した場合、削除が実行されること
   - データベースとファイルシステムから削除されること

2. **GitHub Issue クローズ機能**:
   - デフォルト（オプションなし）で GitHub Issue がクローズされること
   - `--close-github-issue` 指定時も正常に動作すること（後方互換性）
   - GITHUB_TOKEN 未設定時、エラーメッセージが表示されること
   - GitHub 設定未設定時、エラーメッセージが表示されること
   - GitHub Issue が存在しない場合（404）、警告表示後に削除続行すること
   - GitHub API エラー（401、403、500）時、削除処理がスキップされること

3. **エラーハンドリング**:
   - 存在しない仕様書 ID を指定した場合、エラーがスローされること
   - プロジェクト未初期化の場合、エラーがスローされること

#### 7.5.2 統合テスト

**テストシナリオ**:

1. **完全な削除フロー**:
   - 仕様書作成 → GitHub Issue 作成 → 仕様書削除（自動クローズ）を一連の流れで実行
   - GitHub Issue がクローズされていることを確認
   - データベースとファイルシステムから削除されていることを確認

2. **エラー時のロールバック**:
   - GitHub API エラーを意図的に発生させる
   - 削除処理がスキップされること
   - データベースとファイルシステムが変更されていないことを確認

#### 7.5.3 手動テスト

**検証項目**:

1. 確認プロンプトのメッセージが「GitHub Issue がクローズされる」旨を表示すること
2. スラッシュコマンドのドキュメント（`spec-delete.md`）が更新されていること
3. GitHub Issue が実際にクローズされること（GitHub UI で確認）

---

## 8. 実装計画

### 8.1. 実装ステップ

1. **デフォルト値の変更** (`src/commands/spec/delete.ts:64`):
   - `closeGitHubIssue = false` → `closeGitHubIssue = true` に変更

2. **ドキュメント更新** (`src/slash-commands/spec-delete.md`):
   - 「GitHub Issue を自動クローズ（将来実装予定）」を削除
   - 「デフォルトで GitHub Issue がクローズされる」旨を追記
   - 使用例を更新（オプションなしでクローズされることを明記）

3. **テストコードの実装** (`tests/commands/spec/delete.test.ts`):
   - デフォルト動作のテストケース追加
   - 後方互換性のテストケース追加

4. **動作確認**:
   - `npm run sync:dogfood` でソースコード同期
   - 実際の仕様書削除で GitHub Issue がクローズされることを確認
   - エラーハンドリングの動作確認

### 8.2. 影響範囲

**変更が必要なファイル**:
- `src/commands/spec/delete.ts` - デフォルト値変更（1行）
- `src/slash-commands/spec-delete.md` - ドキュメント更新
- `tests/commands/spec/delete.test.ts` - テストケース追加

**変更が不要なファイル**:
- `src/integrations/github/issues.ts` - GitHub API クライアント（変更なし）
- `src/core/workflow/github-integration.ts` - イベントハンドラー（変更なし）
- `src/core/database/schema.ts` - データベーススキーマ（変更なし）

### 8.3. リスク管理

| リスク | 影響 | 対策 |
|---|---|---|
| GitHub API レート制限超過 | 削除処理がスキップされる | エラーメッセージで適切に通知、ユーザーが再試行可能 |
| GITHUB_TOKEN 未設定 | 削除処理がスキップされる | エラーメッセージで設定方法を案内 |
| Issue が既にクローズ済み | 404 エラー | 警告表示後に削除続行（既存の動作を維持） |
| 後方互換性の破壊 | 既存ユーザーの混乱 | `--close-github-issue` オプションを維持 |
