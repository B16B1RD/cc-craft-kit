# /cft:spec-delete コマンドの見直し

**仕様書 ID:** 1c541601-53b6-46fa-a900-d06b8a035fc7
**フェーズ:** completed
**作成日時:** 2025-11-25 14:30
**更新日時:** 2025/11/25 16:05:00

---

## 1. 背景と目的

### 背景

現在、多くの部分がスクリプトで実現されていて、なかなか仕様通りに動作していない。プロンプト指示だと簡単にできることができていない。たいていの処理は、プロンプト指示の方が上手くいく。カスタムスラッシュコマンド→スキル→サブエージェントの構成が上手く実現できていない。改めて、Claude Code のカスタムスラッシュコマンド、スキル、サブエージェントの各機能の仕様についてよく考えて、スクリプトを使わずに仕様を実現できるか再設計して欲しい。スクリプトは最終手段です。ただし、スキル内のスクリプトは OK です。

### 目的

`/cft:spec-delete` コマンドを「プロンプトファースト原則」に従って再設計する。現在スクリプト側に集中している UI 処理・結果表示・エラー解析をプロンプト側に移行し、スクリプトは DB 操作・GitHub API・イベント発火など必須処理のみに限定する。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発（SDD）を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] プロンプト側で削除対象の情報表示・確認フローを制御できる
- [ ] スクリプトは DB 操作・GitHub API・イベント発火のみに限定される
- [ ] `/cft:spec-phase` や `/cft:spec-create` と同様の設計パターンに統一される

### 機能要件

- [ ] 仕様書 ID の部分一致検索（最小 8 文字）に対応
- [ ] `--yes` オプションで確認プロンプトをスキップ可能
- [ ] `--close-github-issue` オプションで GitHub Issue を自動クローズ（デフォルト有効）
- [ ] 削除前に対象情報（ID、名前、フェーズ、GitHub Issue 番号）を表示
- [ ] 削除後に成功メッセージと次のアクションを提示
- [ ] エラー時に原因と復旧手順を表示

### 非機能要件

- [ ] スラッシュコマンド（.md）がメインの制御フローを担当
- [ ] スクリプト（.ts）は JSON 出力のみで UI 処理を含まない
- [ ] CLAUDE.md の「プロンプトファースト原則」に準拠

---

## 4. 制約条件

- スクリプト実装が必須な処理:
  - データベース操作（Kysely によるトランザクション管理）
  - GitHub API 呼び出し（Octokit の認証・レート制限管理）
  - イベント発火（EventBus の初期化・ハンドラー登録）
- プロンプト側で実装すべき処理:
  - 削除前の情報表示
  - 確認プロンプト（`--yes` オプション処理）
  - 結果表示・エラー解析
  - ガイダンスメッセージ

---

## 5. 依存関係

- `src/commands/spec/resolve-id.ts` - 仕様書 ID 解決スクリプト
- `src/commands/spec/delete.ts` - 削除実行スクリプト（要リファクタリング）
- `src/core/database/connection.ts` - データベース接続
- `src/integrations/github/issues.ts` - GitHub Issue 操作
- `src/core/workflow/event-bus.ts` - イベントバス

---

## 6. 参考情報

- `/cft:spec-phase` 実装: `src/slash-commands/spec-phase.md`（プロンプトベース成功例）
- `/cft:spec-create` 実装: `src/slash-commands/spec-create.md`（プロンプトベース成功例）
- CLAUDE.md「プロンプトファースト原則」セクション
- 現在の実装: `src/slash-commands/spec-delete.md`, `src/commands/spec/delete.ts`

---

## 7. 設計詳細

### 7.1. アーキテクチャ設計

#### 現在の問題点

現在の `delete.ts` はスクリプト駆動型（282行の単一ファイル）で、以下の責務が混在している:

1. ID 解決・情報取得
2. ユーザー確認（readline）
3. GitHub Issue クローズ
4. DB 操作
5. ファイル削除
6. イベント発火
7. 結果表示・エラー処理

#### 新しいアーキテクチャ

**プロンプトファースト型**に再設計し、以下の 3 層に分離:

```
┌─────────────────────────────────────────────────────────────┐
│  Prompt 層 (spec-delete.md)                                 │
│  - 制御フロー管理                                            │
│  - ユーザー確認（AskUserQuestion）                           │
│  - 結果表示・エラー解析                                      │
│  - ガイダンスメッセージ                                      │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Query 層 (delete-query.ts)                                 │
│  - 仕様書 ID 解決                                            │
│  - 削除前情報取得                                            │
│  - JSON 出力のみ                                             │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Execute 層 (delete-execute.ts)                             │
│  - GitHub Issue クローズ                                     │
│  - DB レコード削除                                           │
│  - ファイル削除                                              │
│  - イベント発火（spec.deleted）                              │
│  - JSON 出力のみ                                             │
└─────────────────────────────────────────────────────────────┘
```

#### スクリプトの JSON 出力仕様

##### delete-query.ts

```typescript
interface DeleteQueryOutput {
  success: boolean;
  spec?: {
    id: string;                          // 完全な仕様書 ID
    name: string;                        // 仕様書名
    phase: string;                       // 現在のフェーズ
    branch_name: string | null;          // 関連ブランチ
    github_issue_number: number | null;  // GitHub Issue 番号
    file_path: string;                   // 削除対象ファイルパス
  };
  error?: string;                        // エラーメッセージ
}
```

##### delete-execute.ts

```typescript
interface DeleteExecuteOutput {
  success: boolean;
  deletedSpecId?: string;
  deletedSpecName?: string;
  deletedPhase?: string;
  githubIssueNumber?: number | null;
  githubIssueStatus?: 'closed' | 'warning' | 'skipped';
  // 'closed': 正常にクローズ
  // 'warning': Issue が見つからず（404）、削除は続行
  // 'skipped': --close-github-issue=false
  error?: string;
}
```

### 7.2. プロンプト層の制御フロー

```markdown
### Step 1: 引数解析
- $1: 仕様書 ID（部分一致、最低 8 文字）
- --yes: 確認スキップフラグ
- --close-github-issue: GitHub Issue クローズフラグ（デフォルト: true）

### Step 2: 削除対象情報の取得
Bash: npx tsx .cc-craft-kit/commands/spec/delete-query.ts "$1"
→ JSON 出力を解析し、SPEC_* 変数に格納

### Step 3: 削除前の情報表示
⚠️ 削除対象:
  仕様書 ID: $SPEC_ID
  名前: $SPEC_NAME
  フェーズ: $PHASE
  GitHub Issue: #$GITHUB_ISSUE_NUMBER
  ファイル: $FILE_PATH

### Step 4: ユーザー確認
--yes フラグなし → AskUserQuestion で確認
--yes フラグあり → 自動的に Step 5 へ

### Step 5: 削除実行
Bash: npx tsx .cc-craft-kit/commands/spec/delete-execute.ts "$SPEC_ID" [--close-github-issue=true/false]

### Step 6: 結果表示
成功時:
  ✓ 仕様書を削除しました: $SPEC_NAME
  GitHub Issue #$GITHUB_ISSUE_NUMBER をクローズしました

エラー時:
  ❌ エラーメッセージ
  復旧手順を提示
```

### 7.3. GitHub Issue クローズのエラーハンドリング

| エラー | 処理 | 理由 |
|--------|------|------|
| 404（Issue 見つからず） | 警告表示、削除続行 | DB と GitHub の不整合は許容 |
| 401（認証失敗） | 中断 | 設定修正が必要 |
| 403（レート制限） | 中断 | 一時的なエラー |
| 500（API 障害） | 中断 | 再試行が必要 |

### 7.4. テスト戦略

#### 単体テスト

| テストファイル | 対象 | カバレッジ目標 |
|----------------|------|----------------|
| `tests/commands/spec/delete-query.test.ts` | Query 層 | 90% |
| `tests/commands/spec/delete-execute.test.ts` | Execute 層 | 90% |

#### テストケース（delete-query.ts）

1. **正常系**
   - 完全一致の仕様書 ID で情報取得
   - 部分一致（8文字以上）で情報取得
   - GitHub Issue 番号ありの場合
   - GitHub Issue 番号なしの場合

2. **異常系**
   - 存在しない仕様書 ID
   - 8文字未満の ID
   - 複数候補がある場合（曖昧な ID）

#### テストケース（delete-execute.ts）

1. **正常系**
   - DB レコード削除成功
   - ファイル削除成功
   - GitHub Issue クローズ成功
   - `--close-github-issue=false` でスキップ

2. **異常系**
   - GitHub Issue 404（警告のみ、削除続行）
   - GitHub Issue 401/403/500（中断）
   - DB 削除失敗（ロールバック）
   - ファイル削除失敗

#### モック化対象

- `getDatabase()` - インメモリ DB
- GitHub API（Octokit）- nock または Jest mock
- `fs.unlink` - ファイル操作
- `eventBus.emit` - イベント発火

### 7.5. ファイル構成

```
src/
├── commands/
│   └── spec/
│       ├── delete-query.ts      # 新規: Query 層
│       ├── delete-execute.ts    # 新規: Execute 層
│       └── delete.ts            # 廃止予定（削除）
├── slash-commands/
│   └── spec-delete.md           # リファクタリング: Prompt 層
└── ...

tests/
├── commands/
│   └── spec/
│       ├── delete-query.test.ts   # 新規
│       └── delete-execute.test.ts # 新規
└── ...
```

---

## 8. 実装タスクリスト

### スクリプト実装

- [x] Query 層スクリプト (`delete-query.ts`) を作成
  - ID 解決（部分一致、8文字以上）
  - 削除前情報取得（JSON 出力）
- [x] Execute 層スクリプト (`delete-execute.ts`) を作成
  - GitHub Issue クローズ（オプション）
  - DB レコード削除
  - ファイル削除
  - イベント発火（spec.deleted）
  - JSON 出力のみ

### プロンプト実装

- [x] Prompt 層 (`spec-delete.md`) をリファクタリング
  - 制御フロー管理
  - ユーザー確認（AskUserQuestion）
  - 結果表示・エラー解析
  - ガイダンスメッセージ

### テスト

- [x] Query 層の単体テスト (`delete-query.test.ts`) を作成
- [x] Execute 層の単体テスト (`delete-execute.test.ts`) を作成

### クリーンアップ

- [x] 旧 `delete.ts` を削除
- [x] 同期・型チェック・リントを実行

---

## Pull Request

- https://github.com/B16B1RD/cc-craft-kit/pull/365
