# 構成見直し

**仕様書 ID:** f8e8dcf5-1334-4be2-a587-4da2fc6ef3d9
**フェーズ:** design
**作成日時:** 2025/12/05 12:00:00
**更新日時:** 2025/12/05 20:37:00

---

## 1. 背景と目的

### 背景

kiro や cc-sdd  と同様に、カスタムスラッシュコマンド、スキル、サブエージェントのみで構成させたい

### 目的

cc-craft-kit のアーキテクチャを見直し、TypeScript スクリプト層を最小化して、kiro や cc-sdd と同様にカスタムスラッシュコマンド（.md）、スキル（.md）、サブエージェント（.md）のみで構成されるプロンプトファーストなツールキットに再構築する。

---

## 2. 対象ユーザー

- cc-craft-kit を使用する開発者
- Claude Code でプロンプトファースト開発を実践したいユーザー
- 仕様駆動開発（SDD）ワークフローを採用するチーム

---

## 3. 受け入れ基準

### 必須要件

- [ ] 現在の 43 個の CLI コマンド（src/commands/**/*.ts）を精査し、必須なもの以外を削除またはプロンプト層に統合
- [ ] DB 操作（Kysely）、GitHub API（Octokit）、EventBus の 3 要素は最小スクリプトとして維持
- [ ] スラッシュコマンド（24個）、スキル（4個）、サブエージェント（3個）でほぼ全機能をカバー

### 機能要件

- [ ] TypeScript サブエージェント実装（6個）をマークダウン定義に移行検討
- [ ] TypeScript スキル実装（4個）をマークダウン定義に移行検討
- [ ] 出力フォーマット処理（utils/output.ts）をプロンプト層に統合
- [ ] ステートレスな CLI コマンドを削除し、処理をスラッシュコマンド内に直接記述

### 非機能要件

- [ ] npm run sync:dogfood の同期対象を削減し、ビルドプロセスを簡素化
- [ ] コードベースの総行数を現在の 6,693 行から大幅に削減
- [ ] 新規機能追加時は原則としてマークダウン定義のみで完結

---

## 4. 制約条件

### 技術的制約

- **DB 層（Kysely）**: 25+ のコマンドが DB 操作を含むため、完全なプロンプト化は不可能。最小スクリプトとして維持が必須
- **GitHub API（Octokit）**: 認証・エラーハンドリングが複雑なため、スクリプト層で継続
- **EventBus（イベント駆動）**: フェーズ移行時の自動処理に必要。15+ のハンドラーが登録済み
- **ファイル監視（Chokidar）**: watch.ts でバックグラウンド実行が必要

### 設計原則

- プロンプトファースト原則を厳格に適用
- スクリプトは「DB操作」「外部API」「イベント駆動」「ファイル監視」の 4 用途に限定

---

## 5. 依存関係

### 削除不可能なコア依存

- `src/core/database/**` - Kysely によるDB接続・スキーマ・マイグレーション
- `src/core/workflow/event-bus.ts` - イベント駆動エンジン
- `src/integrations/github/**` - Octokit による GitHub 連携

### 削除候補の依存

- `src/core/subagents/impl/**` - TypeScript サブエージェント実装（マークダウン化検討）
- `src/core/skills/impl/**` - TypeScript スキル実装（マークダウン化検討）
- `src/commands/utils/output.ts` - 出力フォーマット（プロンプト層に移行）

### 参照先ツール

- kiro: https://kiro.dev （Amazon の仕様駆動開発ツール）
- cc-sdd: cc-craft-kit の前身プロジェクト

---

## 6. 参考情報

- `agent_docs/PROMPT_FIRST_PRINCIPLE.md` - プロンプトファースト原則の詳細
- `docs/ARCHITECTURE.md` - 現在のアーキテクチャ概要
- `src/slash-commands/spec-create.md` - 45ステップの自動実行フロー例（参考実装）
- `src/skills/pr-creator/SKILL.md` - スキル定義の参考例
- `src/agents/test-generator.md` - サブエージェント定義の参考例（293行）

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
現在のアーキテクチャ:
┌─────────────────────────────────────────────────────────────┐
│ Claude Code User                                            │
└────────────────────────────┬────────────────────────────────┘
                             │
         ┌───────────────────┼───────────────────┐
         ▼                   ▼                   ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│ Slash Commands  │  │ Skills          │  │ Agents          │
│ (24個 .md)      │  │ (4個 .md)       │  │ (3個 .md)       │
└────────┬────────┘  └────────┬────────┘  └────────┬────────┘
         │                    │                    │
         └───────────────────┬┴────────────────────┘
                             ▼
┌─────────────────────────────────────────────────────────────┐
│ CLI Commands Layer (43個 .ts) ← 問題：冗長な中間層          │
│ ├─ spec/*.ts (12個)                                         │
│ ├─ task/*.ts (2個)                                          │
│ ├─ github/*.ts (6個)                                        │
│ ├─ knowledge/*.ts (4個)                                     │
│ ├─ quality/*.ts (3個)                                       │
│ └─ utils/*.ts (8個)                                         │
└────────┬────────────────────┬───────────────────────────────┘
         │                    │
         ▼                    ▼
┌─────────────────┐  ┌─────────────────┐
│ Core Layer      │  │ Integrations    │
│ ├─ Database     │  │ └─ GitHub API   │
│ ├─ EventBus     │  └─────────────────┘
│ └─ Subagents/   │
│    Skills impl  │
└─────────────────┘
```

```
目標アーキテクチャ（プロンプトファースト）:
┌─────────────────────────────────────────────────────────────┐
│ Claude Code User                                            │
└────────────────────────────┬────────────────────────────────┘
                             │
         ┌───────────────────┼───────────────────┐
         ▼                   ▼                   ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│ Slash Commands  │  │ Skills          │  │ Agents          │
│ (24個 .md)      │  │ (4個 .md)       │  │ (3個 .md)       │
│ 拡張：直接処理  │  │ 全て .md 定義   │  │ 全て .md 定義   │
└────────┬────────┘  └────────┬────────┘  └────────┬────────┘
         │                    │                    │
         └───────────────────┬┴────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│ Minimal CLI Layer (20-25個 .ts) ← 最小化                    │
│ ├─ spec/*.ts (8個) - DB操作のみ                             │
│ ├─ task/*.ts (2個) - DB操作のみ                             │
│ ├─ github/*.ts (6個) - API操作のみ                          │
│ └─ knowledge/*.ts (4個) - DB操作のみ                        │
└────────┬────────────────────┬───────────────────────────────┘
         │                    │
         ▼                    ▼
┌─────────────────┐  ┌─────────────────┐
│ Core Layer      │  │ Integrations    │
│ ├─ Database     │  │ └─ GitHub API   │
│ └─ EventBus     │  └─────────────────┘
│ (subagents/     │
│  skills impl    │
│  削除)          │
└─────────────────┘
```

#### 設計方針

1. **プロンプトファースト原則の厳格適用**
   - Claude Code ツール（Read, Write, Edit, Bash, Task）で完結する処理はスラッシュコマンド内に直接記述
   - TypeScript スクリプトは「DB操作」「外部API」「イベント駆動」の 3 用途に限定

2. **中間層の排除**
   - 出力フォーマット（output.ts）→ プロンプト層で Markdown 生成
   - バリデーション（validation.ts）→ プロンプト層で直接検証
   - ステートレスコマンド → スラッシュコマンド内に統合

3. **マークダウン定義への完全移行**
   - TypeScript サブエージェント（7個）→ `.claude/agents/*.md`
   - TypeScript スキル（5個）→ `.claude/skills/*/SKILL.md`

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 | 優先度 |
|---------|---------|--------|
| `src/commands/utils/output.ts` | 削除（プロンプト層に移行） | 高 |
| `src/commands/agent/list.ts` | 削除（スラッシュコマンドに統合） | 高 |
| `src/commands/agent/create.ts` | 削除（スラッシュコマンドに統合） | 高 |
| `src/commands/skill/list.ts` | 削除（スラッシュコマンドに統合） | 高 |
| `src/commands/skill/create.ts` | 削除（スラッシュコマンドに統合） | 高 |
| `src/core/subagents/impl/*.ts` | 削除（マークダウン化） | 中 |
| `src/core/skills/impl/*.ts` | 削除（マークダウン化、github-issue-sync.ts のみ保持） | 中 |
| `src/slash-commands/custom-tools.md` | 拡張（list/create 処理を内包） | 高 |
| `scripts/sync-dogfood.ts` | 同期対象を削減 | 低 |

#### CLI コマンド削除・保持判定

**削除対象（18個）:**

| コマンド | 理由 | 移行先 |
|---------|------|--------|
| `agent/list.ts` | 固定リスト出力 | スラッシュコマンド |
| `agent/create.ts` | テンプレート生成 | スラッシュコマンド |
| `skill/list.ts` | 固定リスト出力 | スラッシュコマンド |
| `skill/create.ts` | テンプレート生成 | スラッシュコマンド |
| `utils/output.ts` | フォーマット処理 | プロンプト層 |
| `utils/validation.ts` | バリデーション | プロンプト層 |
| `subagents/impl/requirements-analyzer.ts` | キーワード抽出 | Bash + grep |
| `subagents/impl/architect-designer.ts` | 設計指導 | マークダウンエージェント |
| `subagents/impl/code-generator.ts` | コード生成 | Task + code-reviewer |
| `subagents/impl/code-reviewer.ts` | コードレビュー | 既存エージェント |
| `subagents/impl/task-breakdowner.ts` | タスク分割 | スラッシュコマンド |
| `subagents/impl/test-creator.ts` | テスト生成 | 既存エージェント |
| `subagents/impl/documentation-writer.ts` | ドキュメント作成 | Task |
| `skills/impl/architecture-diagram-generator.ts` | 図生成 | マークダウンスキル |
| `skills/impl/test-coverage-reporter.ts` | カバレッジ | Bash + npm test |
| `skills/impl/code-quality-analyzer.ts` | 品質分析 | code-reviewer |
| `skills/impl/requirements-doc-generator.ts` | 仕様書生成 | マークダウンスキル |
| `quality/check.ts`, `quality/generate.ts` | 品質検証 | Bash ツール |

**保持対象（25個）:**

| コマンド | 理由 |
|---------|------|
| `spec/list.ts` | DB 読み取り |
| `spec/get.ts` | DB 読み取り |
| `spec/resolve-id.ts` | DB 検索 |
| `spec/register.ts` | DB 書き込み |
| `spec/update.ts` | DB 更新 |
| `spec/update-phase.ts` | DB 更新 + EventBus |
| `spec/update-pr.ts` | DB 更新 |
| `spec/delete-query.ts` | DB 読み取り |
| `spec/delete-execute.ts` | DB 削除 + EventBus |
| `task/start.ts` | DB 更新 |
| `task/done.ts` | DB 更新 + EventBus |
| `knowledge/record.ts` | DB 書き込み + EventBus |
| `knowledge/progress.ts` | DB 書き込み + EventBus |
| `knowledge/error.ts` | DB 書き込み + EventBus |
| `knowledge/tip.ts` | DB 書き込み + EventBus |
| `github/init.ts` | DB 書き込み + GitHub API |
| `github/issue-create.ts` | DB 書き込み + GitHub API |
| `github/sync.ts` | DB 更新 + GitHub API |
| `github/create-sub-issues.ts` | DB 読み取り + GitHub API |
| `github/project-add.ts` | DB 更新 + GitHub API |
| `github/pr-cleanup.ts` | GitHub API + Git + DB 更新 |
| `status/info.ts` | DB 読み取り |
| `sync/check.ts` | DB 読み取り + ファイル検証 |
| `sync/repair.ts` | DB 修復 |
| `watch.ts` | ファイル監視 + EventBus |

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| エージェント一覧表示 | `agent/list.ts` | Glob + Read で動的取得 | `/cft:custom-tools` |
| エージェント作成 | `agent/create.ts` | Write ツールでテンプレート生成 | `/cft:custom-tools` |
| スキル一覧表示 | `skill/list.ts` | Glob + Read で動的取得 | `/cft:custom-tools` |
| スキル作成 | `skill/create.ts` | Write ツールでテンプレート生成 | `/cft:custom-tools` |
| 出力フォーマット | `output.ts` | Markdown テーブル + 絵文字 | 各スラッシュコマンド |
| バリデーション | `validation.ts` | プロンプト内条件分岐 | 各スラッシュコマンド |
| コードレビュー | `code-reviewer.ts` | Task(code-reviewer) | 各スラッシュコマンド |
| テスト生成 | `test-creator.ts` | Task(test-generator) | 各スラッシュコマンド |
| アーキテクチャ図 | `architecture-diagram-generator.ts` | Read + Mermaid 生成 | マークダウンスキル |
| 要件書生成 | `requirements-doc-generator.ts` | Read + Write | マークダウンスキル |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| スラッシュコマンド拡張 | `custom-tools.md` の list/create 処理 | 手動実行テスト |
| CLI コマンド削除 | 削除後も機能が維持されること | `npm test` |
| マークダウンエージェント | Task ツールでの呼び出し | 手動実行テスト |
| マークダウンスキル | Skill ツールでの呼び出し | 手動実行テスト |
| sync:dogfood | 同期対象削減後の動作 | `npm run sync:dogfood` |
| 型チェック | TypeScript エラーなし | `npm run typecheck` |
| ESLint | リントエラーなし | `npm run lint` |

### 7.5 移行計画

#### Phase 1: 低リスク削減（即座実施）

1. `output.ts` に依存するコマンドの出力処理をプロンプト層に移行
2. `agent/list.ts`, `skill/list.ts`, `agent/create.ts`, `skill/create.ts` を削除
3. `/cft:custom-tools` スラッシュコマンドを拡張して list/create 機能を内包
4. `utils/validation.ts` の機能をプロンプト層に移行

**削減目標: ~570行（約8.5%）**

#### Phase 2: TypeScript スキル/サブエージェントのマークダウン化

1. `architecture-diagram-generator.ts` → `.claude/skills/architecture-diagram/SKILL.md`
2. `requirements-doc-generator.ts` → `.claude/skills/requirements-doc/SKILL.md`
3. `test-coverage-reporter.ts` → Task(test-generator) に委譲
4. `code-quality-analyzer.ts` → Task(code-reviewer) に委譲
5. TypeScript サブエージェント 7 個をマークダウン定義に移行

**削減目標: ~3,550行（追加約53%）**

#### Phase 3: 最終整理

1. `src/core/subagents/impl/` ディレクトリ削除
2. `src/core/skills/impl/` ディレクトリ整理（`github-issue-sync.ts` のみ保持）
3. `scripts/sync-dogfood.ts` の同期対象を更新
4. ドキュメント更新（`ARCHITECTURE.md`, `PROMPT_FIRST_PRINCIPLE.md`）

**最終削減目標: 6,693行 → 4,000-4,500行（33-40% 削減）**

---

## 8. 実装タスクリスト

### Phase 1: 低リスク削減

- [ ] output.ts の依存関係を調査し、各コマンドの出力処理をプロンプト層に移行 (#822)
- [ ] agent/list.ts を削除し、/cft:custom-tools に一覧表示機能を統合 (#823)
- [ ] agent/create.ts を削除し、/cft:custom-tools にテンプレート生成機能を統合 (#824)
- [ ] skill/list.ts を削除し、/cft:custom-tools に一覧表示機能を統合 (#825)
- [ ] skill/create.ts を削除し、/cft:custom-tools にテンプレート生成機能を統合 (#826)
- [ ] utils/validation.ts の機能をプロンプト層に移行 (#827)
- [ ] Phase 1 完了後の型チェック・ESLint・テスト実行 (#828)

### Phase 2: TypeScript スキル/サブエージェントのマークダウン化

- [ ] architecture-diagram-generator.ts をマークダウンスキルに変換 (#829)
- [ ] requirements-doc-generator.ts をマークダウンスキルに変換 (#830)
- [ ] test-coverage-reporter.ts を削除し Task(test-generator) に委譲 (#831)
- [ ] code-quality-analyzer.ts を削除し Task(code-reviewer) に委譲 (#832)
- [ ] requirements-analyzer.ts をマークダウンエージェントに変換 (#833)
- [ ] architect-designer.ts をマークダウンエージェントに変換 (#834)
- [ ] code-generator.ts を削除し既存エージェントに委譲 (#835)
- [ ] code-reviewer.ts を削除し既存エージェントに委譲 (#836)
- [ ] task-breakdowner.ts を削除しスラッシュコマンドに統合 (#837)
- [ ] test-creator.ts を削除し既存エージェントに委譲 (#838)
- [ ] documentation-writer.ts を削除し Task に委譲 (#839)
- [ ] Phase 2 完了後の型チェック・ESLint・テスト実行 (#840)

### Phase 3: 最終整理

- [ ] src/core/subagents/impl/ ディレクトリを削除 (#841)
- [ ] src/core/skills/impl/ ディレクトリを整理（github-issue-sync.ts のみ保持） (#842)
- [ ] scripts/sync-dogfood.ts の同期対象を更新 (#843)
- [ ] ARCHITECTURE.md を更新 (#844)
- [ ] PROMPT_FIRST_PRINCIPLE.md を更新 (#845)
- [ ] 最終テスト実行と CI パス確認 (#846)
