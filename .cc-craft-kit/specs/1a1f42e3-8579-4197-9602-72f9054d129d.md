# implementation フェーズ完了時、GitHub Projects の Issue のステータスが Done になっている

**仕様書 ID:** 1a1f42e3-8579-4197-9602-72f9054d129d
**フェーズ:** implementation
**作成日時:** 2025/12/04 18:45:00
**更新日時:** 2025/12/04 14:39:43

---

## 1. 背景と目的

### 背景

cc-craft-kit では、仕様書のフェーズが `completed` に遷移した際、GitHub Projects 上の Issue ステータスが自動的に「Done」に更新される機能が既に実装されている。しかし、ユーザーから「implementation フェーズ完了時に Done になっていてほしい」という要望があり、現状のフロー（implementation → review → completed）とユーザー期待のギャップがある可能性がある。

**調査が必要な仮説:**
GitHub Projects には、親 Issue に紐づくすべての Sub Issue がクローズされると、親 Issue のステータスが自動的に「Done」に変更される機能がある可能性がある。この場合、cc-craft-kit 側の明示的なステータス更新ではなく、GitHub 側の自動化機能によって Done になっている可能性がある。

### 目的

implementation フェーズ完了時（または completed フェーズ遷移時）に、GitHub Projects の Issue ステータスが確実に「Done」に更新されることを保証し、ユーザーが期待するワークフローを実現する

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者。特に GitHub Projects でタスク管理を行っているチーム

---

## 3. 受け入れ基準

### 必須要件

- [ ] completed フェーズへの遷移時に `spec.phase_changed` イベントが発火される
- [ ] GitHub Projects の Issue ステータスが「Done」に更新される
- [ ] ステータス更新が検証され、成功メッセージが表示される

### 機能要件

- [ ] `DynamicStatusMapper` が `completed` フェーズを「Done」にマッピングする
- [ ] `projects.updateProjectStatus()` で GraphQL リクエストが送信される
- [ ] `verifyProjectStatusUpdate()` で最大 3 回のリトライが実行される
- [ ] GitHub Issue がコメント付きでクローズされる

### 非機能要件

- [ ] 「Done」ステータスが存在しない場合、フォールバック（「In Progress」）が使用される
- [ ] GitHub API レート制限に達した場合、適切にリトライされる
- [ ] Project が追加されていない場合、処理がスキップされる（エラーではない）

---

## 4. 制約条件

- GitHub API レート制限（60 回/時）の考慮が必要
- GitHub Projects V2 の動的ステータスフィールドに依存
- `GITHUB_TOKEN` 環境変数が設定されていること
- GitHub Projects に「Done」ステータスが存在すること（または statusMapping でカスタマイズ）

---

## 5. 依存関係

- `src/commands/spec/update-phase.ts` - フェーズ更新スクリプト
- `src/core/workflow/github-integration.ts` - GitHub 連携イベントハンドラー
- `src/integrations/github/projects.ts` - GitHub Projects 操作
- `src/integrations/github/phase-status-mapper.ts` - フェーズ→ステータスマッピング
- `src/core/config/github-status-config.ts` - ステータス設定管理
- `/cft:github-init` で GitHub 統合が初期化されていること
- `github_sync` テーブルに Project Item ID が登録されていること

---

## 6. 参考情報

- GitHub Projects V2 API: https://docs.github.com/en/graphql/reference/objects#projectv2
- 既存実装: `src/core/workflow/github-integration.ts:208-603`
- フェーズ遷移フロー: implementation → review → completed → Done

### 6.1 調査結果（2025/12/04）

#### 仮説検証結果

**仮説**: 「GitHub Projects には、親 Issue に紐づくすべての Sub Issue がクローズされると、親 Issue のステータスが自動的に「Done」に変更される機能がある」

**検証結果**: ❌ **そのような機能は存在しない**

GitHub Projects V2 の調査により、以下が確認されました:

1. **Sub Issues の進捗表示機能**のみが存在
   - 「Sub-issue progress」フィールドで進捗バーを表示
   - 「Parent issue」フィールドで親子関係を表示
   - **表示機能のみ**であり、親 Issue のステータスを自動変更する機能ではない

2. **デフォルトで有効な Built-in Workflows**
   - **Issue/PR クローズ時**: Project ステータスが自動的に「Done」に設定
   - **PR マージ時**: Project ステータスが自動的に「Done」に設定
   - **Auto-close issue workflow**（2024年4月追加）: ステータスを「Done」に変更すると Issue を自動クローズ

3. **cc-craft-kit との競合リスク**: **低い**
   - cc-craft-kit の実装順序（ステータス更新 → Issue クローズ）は適切
   - GitHub API の冪等性により、重複処理が発生してもエラーにならない

#### 結論

- 親 Issue の Done ステータス更新は cc-craft-kit 側の明示的な処理（`completed` フェーズ遷移時）でのみ行われる
- Sub Issue がすべてクローズされても、親 Issue のステータスは自動変更されない
- ユーザーが期待する「implementation フェーズ完了時に Done」を実現するには、completed フェーズへの遷移が必要

### 6.2 既存実装の動作確認（2025/12/04）

#### completed フェーズ遷移時の処理フロー

既存実装 `src/core/workflow/github-integration.ts` の動作を確認した結果:

**1. Project ステータス更新（行 368-471）**
- `github_sync` テーブルから `projectSync` を取得 ✓
- `DynamicStatusMapper.mapPhaseToStatusWithFallback('completed')` で `'Done'` にマッピング ✓
- `projects.updateProjectStatus()` で GraphQL リクエストを送信 ✓
- `projects.verifyProjectStatusUpdate()` で最大 3 回のリトライを実行 ✓

**2. Issue クローズ処理（行 536-595）**
- `pr-cleanup` 処理の実行（ブランチ削除、DB 更新） ✓
- 完了コメントの追加 ✓
- `issues.close()` で Issue をクローズ ✓

#### 結論

既存実装は正しく動作することを確認。completed フェーズへの遷移時に:
1. Project ステータスが「Done」に更新される
2. リトライ機能が実装されている
3. Issue が完了コメント付きでクローズされる

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
ユーザー操作
    ↓
/cft:spec-phase <spec-id> completed
    ↓
update-phase.ts: DB の phase を更新
    ↓
spec.phase_changed イベント発火
    ↓
github-integration.ts: イベントハンドラー起動
    ↓
┌─────────────────────────────────────────────┐
│ Project ステータス更新                        │
│  1. github_sync から projectSync 取得        │
│  2. DynamicStatusMapper で 'Done' にマッピング │
│  3. projects.updateProjectStatus() 実行      │
│  4. verifyProjectStatusUpdate() で検証       │
└─────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────┐
│ Issue クローズ処理                           │
│  1. pr-cleanup 実行（ブランチ削除）            │
│  2. Issue に完了コメント追加                  │
│  3. Issue をクローズ                         │
└─────────────────────────────────────────────┘
```

#### 設計方針

既存のイベント駆動アーキテクチャを活用。`spec.phase_changed` イベントハンドラー内で、すべてのフェーズ遷移に対応した Project ステータス更新が既に実装済み。

本仕様では以下の 2 点を検証・確認する:
1. 既存実装が正しく動作していることのテスト追加
2. GitHub Projects 側の自動化機能との整合性確認

#### 処理フロー詳細

**completed フェーズ遷移時**:
```
1. update-phase.ts
   - DB の phase カラムを 'completed' に更新
   - spec.phase_changed イベント発火
     - oldPhase: 'review' (または 'implementation')
     - newPhase: 'completed'

2. github-integration.ts (行 368-471)
   - github_sync テーブルから project アイテム取得
   - DynamicStatusMapper.mapPhaseToStatusWithFallback('completed')
     → 'Done' を返却
   - projects.updateProjectStatus() で GraphQL 実行
   - verifyProjectStatusUpdate() で検証（最大 3 回リトライ）

3. github-integration.ts (行 536-595)
   - pr-cleanup 実行（ブランチ削除、DB 更新）
   - Issue に完了コメント追加
   - issues.update() で Issue をクローズ
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| なし（調査で既存実装が正しく動作することを確認） | 既存コードの動作確認のみ |
| `tests/integration/github-projects-status.test.ts` | E2E テスト追加 |

#### 既存実装の確認ポイント

1. **DynamicStatusMapper の動作確認**
   - `completed` → `'Done'` のマッピングが正しく行われること
   - フォールバック（'In Progress'）が適切に機能すること

2. **Project ステータス更新の動作確認**
   - `github_sync` テーブルから正しく `projectSync` を取得
   - `updateProjectStatus()` で GraphQL リクエストが送信される
   - `verifyProjectStatusUpdate()` で最大 3 回のリトライが実行される

3. **Issue クローズ処理の動作確認**
   - 完了コメントが追加される
   - Issue がクローズされる

### 7.3 機能マッピング

| 機能 | 現在の実装 | 確認事項 | 実装場所 |
|-----|----------|---------|---------|
| フェーズ→ステータスマッピング | DynamicStatusMapper で 'completed' → 'Done' | 動作確認のみ | `phase-status-mapper.ts:132-134` |
| Project ステータス更新 | updateProjectStatus() で GraphQL 実行 | 動作確認のみ | `projects.ts:384-430` |
| ステータス更新検証 | verifyProjectStatusUpdate() で最大 3 回リトライ | 動作確認のみ | `projects.ts:562-607` |
| Issue クローズ | issues.update() でクローズ | 動作確認のみ | `github-integration.ts:536-595` |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| DynamicStatusMapper | 'completed' → 'Done' マッピング | ユニットテスト |
| updateProjectStatus | GraphQL リクエスト送信 | モック + 統合テスト |
| verifyProjectStatusUpdate | リトライ動作 | ユニットテスト |
| E2E フロー | completed 遷移→ステータス更新→Issue クローズ | 手動テスト |

### 7.5 移行計画

#### Phase 1: 調査・検証

1. GitHub Projects の Workflow 設定を確認
2. 既存実装の動作テストを実施
3. 仮説（GitHub 自動化機能）の検証

#### Phase 2: テスト追加（必要に応じて）

1. DynamicStatusMapper のユニットテスト追加
2. E2E テストシナリオの追加

---

## 8. 実装タスクリスト

### Phase 1: 調査・検証

- [x] GitHub Projects の Workflow 自動化設定を確認し、cc-craft-kit との競合有無を検証 (#648)
- [x] completed フェーズ遷移時の Project ステータス更新動作を確認 (#649)
- [ ] DynamicStatusMapper で completed が Done にマッピングされることをテスト (#650)
- [ ] verifyProjectStatusUpdate のリトライ動作をテストコードで確認 (#651)

### Phase 2: ドキュメント・テスト整備

- [ ] E2E テストシナリオをドキュメント化 (#652)
- [ ] 動作確認結果を仕様書に追記して完了 (#653)
