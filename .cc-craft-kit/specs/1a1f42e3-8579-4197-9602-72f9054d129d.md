# implementation フェーズ完了時、GitHub Projects の Issue のステータスが Done になっている

**仕様書 ID:** 1a1f42e3-8579-4197-9602-72f9054d129d
**フェーズ:** requirements
**作成日時:** 2025/12/04 18:45:00
**更新日時:** 2025/12/04 18:45:00

---

## 1. 背景と目的

### 背景

cc-craft-kit では、仕様書のフェーズが `completed` に遷移した際、GitHub Projects 上の Issue ステータスが自動的に「Done」に更新される機能が既に実装されている。しかし、ユーザーから「implementation フェーズ完了時に Done になっていてほしい」という要望があり、現状のフロー（implementation → review → completed）とユーザー期待のギャップがある可能性がある。

### 目的

implementation フェーズ完了時（または completed フェーズ遷移時）に、GitHub Projects の Issue ステータスが確実に「Done」に更新されることを保証し、ユーザーが期待するワークフローを実現する

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者。特に GitHub Projects でタスク管理を行っているチーム

---

## 3. 受け入れ基準

### 必須要件

- [ ] completed フェーズへの遷移時に `spec.phase_changed` イベントが発火される
- [ ] GitHub Projects の Issue ステータスが「Done」に更新される
- [ ] ステータス更新が検証され、成功メッセージが表示される

### 機能要件

- [ ] `DynamicStatusMapper` が `completed` フェーズを「Done」にマッピングする
- [ ] `projects.updateProjectStatus()` で GraphQL リクエストが送信される
- [ ] `verifyProjectStatusUpdate()` で最大 3 回のリトライが実行される
- [ ] GitHub Issue がコメント付きでクローズされる

### 非機能要件

- [ ] 「Done」ステータスが存在しない場合、フォールバック（「In Progress」）が使用される
- [ ] GitHub API レート制限に達した場合、適切にリトライされる
- [ ] Project が追加されていない場合、処理がスキップされる（エラーではない）

---

## 4. 制約条件

- GitHub API レート制限（60 回/時）の考慮が必要
- GitHub Projects V2 の動的ステータスフィールドに依存
- `GITHUB_TOKEN` 環境変数が設定されていること
- GitHub Projects に「Done」ステータスが存在すること（または statusMapping でカスタマイズ）

---

## 5. 依存関係

- `src/commands/spec/update-phase.ts` - フェーズ更新スクリプト
- `src/core/workflow/github-integration.ts` - GitHub 連携イベントハンドラー
- `src/integrations/github/projects.ts` - GitHub Projects 操作
- `src/integrations/github/phase-status-mapper.ts` - フェーズ→ステータスマッピング
- `src/core/config/github-status-config.ts` - ステータス設定管理
- `/cft:github-init` で GitHub 統合が初期化されていること
- `github_sync` テーブルに Project Item ID が登録されていること

---

## 6. 参考情報

- GitHub Projects V2 API: https://docs.github.com/en/graphql/reference/objects#projectv2
- 既存実装: `src/core/workflow/github-integration.ts:208-603`
- フェーズ遷移フロー: implementation → review → completed → Done
