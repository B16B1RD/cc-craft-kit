---
id: "40ba9a94-c219-4796-95fe-b9203779c3a7"
name: "フェーズ移行時（特にcomp？）仕様書が削除されたりデータベースから削除されたりする"
phase: "completed"
branch_name: "main"
github_issue_number: null
pr_url: null
created_at: "2025-11-19T15:42:50Z"
updated_at: "2025-11-19T15:56:25Z"
---

# フェーズ移行時（特にcomp？）仕様書が削除されたりデータベースから削除されたりする


## 1. 背景と目的

### 背景

ユーザーが `/cft:spec-phase <spec-id> comp` を実行した際に、以下の問題が発生しました:

1. **仕様書がデータベースから見つからない**: `Error: Spec not found: 3534eb82-40aa-4876-b596-097422fb3977`
2. **仕様書一覧に表示されない**: `/cft:spec-list impl` で 0 件表示
3. **GitHub Issue のステータスが更新されない可能性**: completed フェーズ移行時に Issue がクローズされるべき

**調査結果:**

- フェーズ更新コマンド（`src/commands/spec/phase.ts`）には仕様書を削除するコードは存在しない
- GitHub 統合ハンドラー（`src/core/workflow/github-integration.ts:433-463`）には Issue をクローズする処理はあるが、仕様書を削除する処理はない
- 本番コードには `deleteFrom('specs')` を実行するコードは存在しない（テストコードのみ）

**考えられる原因:**

1. **データベース接続の問題**: 複数の Claude Code インスタンスが異なるデータベースファイルを参照している
2. **テスト実行時の副作用**: 統合テスト実行後にデータベースが初期化されている
3. **データベース破損**: WAL モードの問題やファイルシステムの問題
4. **キャッシュの問題**: `getDatabase()` のキャッシュが古いインスタンスを返している

### 目的

フェーズ移行時（特に completed フェーズ）に仕様書がデータベースから消失する問題の根本原因を特定し、修正する。

**具体的な目標:**

1. フェーズ移行後も仕様書がデータベースに正常に保持される
2. `/cft:spec-list` で正しく仕様書が表示される
3. GitHub Issue のステータスが正しく更新される
4. データベースの整合性が保たれる
---

## 2. 対象ユーザー

- cc-craft-kit を使用して開発を行うすべての開発者
- 複数の Claude Code インスタンスを同時に使用する開発者
- テストを実行した後にメインの開発作業を継続する開発者
---

## 3. 受け入れ基準

### 必須要件

- [ ] フェーズ移行（特に completed フェーズ）後も仕様書がデータベースに保持される
- [ ] `/cft:spec-list` コマンドで completed フェーズの仕様書が正しく表示される
- [ ] completed フェーズ移行時に GitHub Issue が自動的にクローズされる
- [ ] データベースの整合性チェック機能が正常に動作する

### 機能要件

- [ ] データベース接続の診断コマンドを追加（`/cft:db-info`）
  - 使用中のデータベースファイルパス
  - データベースファイルサイズ
  - 総仕様書数
  - フェーズ別仕様書数
- [ ] 複数の Claude Code インスタンスが同じデータベースファイルを参照していることを確認
- [ ] テスト実行後にデータベース接続をリセットする仕組みを追加
- [ ] `getDatabase()` のキャッシュが正しく動作することを検証

### 非機能要件

- [ ] データベース操作のトランザクション整合性を保証
- [ ] WAL モードでの同時アクセス制御が正しく機能
- [ ] データベースファイルの破損を検出する機能
- [ ] エラーログに十分な診断情報を記録
---

## 4. 制約条件

### 既存コードの制約

- データベース接続は `getDatabase()` で管理されている
- WAL モードが有効で、複数プロセスからの同時アクセスをサポート
- `busy_timeout` は 5000ms に設定済み
- バックアップは週 1 回自動実行される

### 互換性の制約

- 既存のデータベーススキーマを変更しない
- 既存のコマンドの動作を変更しない
- テストコードのクリーンアップ処理を壊さない
---

## 5. 依存関係

### 既存モジュール

- `src/core/database/connection.ts` - データベース接続管理
- `src/core/database/schema.ts` - スキーマ定義
- `src/commands/spec/phase.ts` - フェーズ更新コマンド
- `src/core/workflow/github-integration.ts` - GitHub 統合
- `tests/integrations/event-logging.test.ts` - イベントログ統合テスト

### 関連する仕様書

- ログ記録の強化（3534eb82）- この問題の発見に至った仕様書
---

## 6. 参考情報

### データベース接続の実装

- `src/core/database/connection.ts` - シングルトンパターンによる接続管理
- SQLite WAL モード: https://www.sqlite.org/wal.html
- Kysely ドキュメント: https://kysely.dev/

### 問題の発生経緯

1. `/cft:spec-phase 3534eb82 comp` を実行
2. `Error: Spec not found: 3534eb82` エラーが発生
3. `/cft:spec-list impl` で 0 件表示
4. データベース内に仕様書が存在しないことを確認
---

## 7. 設計

### 7.1 アーキテクチャ設計

#### 問題の根本原因の特定

データベース接続の診断機能を追加して、以下の情報を取得する：

1. **現在使用中のデータベースファイルパス**
2. **データベースファイルの存在確認**
3. **データベースファイルサイズ**
4. **総仕様書数とフェーズ別集計**
5. **WAL ファイルの状態**

#### データベース接続診断コマンド

新しいコマンド `/cft:db-info` を追加し、以下の情報を表示する：

```
# Database Connection Info

Database Path: /path/to/.cc-craft-kit/cc-craft-kit.db
Database Size: 1.2 MB
WAL Mode: Enabled
WAL File: /path/to/.cc-craft-kit/cc-craft-kit.db-wal (123 KB)

Total Specifications: 5

Specifications by Phase:
  requirements: 1
  design: 1
  tasks: 0
  implementation: 2
  completed: 1

Recent Activity:
  Last updated: 2025/11/19 15:44:58
  Last created: 2025/11/19 15:42:50
```

### 7.2 データモデル設計

既存のスキーマを変更せず、診断情報を取得するためのクエリを追加する。

#### 診断クエリ

```typescript
// 総仕様書数
const totalSpecs = await db
  .selectFrom('specs')
  .select(db.fn.count('id').as('count'))
  .executeTakeFirst();

// フェーズ別集計
const specsByPhase = await db
  .selectFrom('specs')
  .select(['phase', db.fn.count('id').as('count')])
  .groupBy('phase')
  .execute();

// 最新の活動
const latestActivity = await db
  .selectFrom('specs')
  .select(['created_at', 'updated_at'])
  .orderBy('updated_at', 'desc')
  .limit(1)
  .executeTakeFirst();
```

### 7.3 API 設計

#### 新しいコマンド: `/cft:db-info`

**ファイル**: `src/commands/db/info.ts`

**インターフェース**:

```typescript
export async function showDatabaseInfo(
  options: OutputOptions = { format: 'table', color: true }
): Promise<void>;
```

**実行内容**:

1. データベースファイルパスを取得
2. ファイルの存在確認とサイズ取得
3. WAL ファイルの状態確認
4. 総仕様書数を取得
5. フェーズ別集計を取得
6. 最新の活動日時を取得
7. 結果をフォーマットして表示

### 7.4 エラーハンドリング設計

#### データベースファイルが見つからない場合

```typescript
if (!existsSync(dbPath)) {
  console.error('❌ Database file not found:', dbPath);
  console.error('Project may not be initialized or database file was deleted.');
  console.error('Run /cft:init to initialize the project.');
  process.exit(1);
}
```

#### データベース接続エラー

```typescript
try {
  const db = getDatabase();
  // クエリ実行
} catch (error) {
  console.error('❌ Failed to connect to database:', error.message);
  console.error('Database file may be corrupted.');
  console.error('Check the database file at:', dbPath);
  process.exit(1);
}
```

### 7.5 実装対象ファイル

#### 新規作成ファイル

1. **`src/commands/db/info.ts`** - データベース診断コマンド実装
2. **`src/slash-commands/db-info.md`** - スラッシュコマンド定義

#### 変更が必要なファイル

なし（既存ファイルの変更は不要）

### 7.6 テスト設計

#### 単体テスト

**ファイル**: `tests/commands/db/info.test.ts`

**テストケース**:

1. データベースファイルが存在する場合、正しい情報を表示する
2. データベースファイルが存在しない場合、エラーメッセージを表示する
3. WAL ファイルが存在する場合、サイズを表示する
4. 仕様書が 0 件の場合、"No specifications" と表示する

#### 統合テスト

**ファイル**: `tests/integrations/db-diagnostics.test.ts`

**テストシナリオ**:

1. プロジェクト初期化後、`/cft:db-info` を実行して正しい情報が表示される
2. 仕様書を作成後、総仕様書数が増加する
3. フェーズ移行後、フェーズ別集計が正しく更新される
---

## 8. 実装タスクリスト

### タスク 1: データベース診断コマンド `/cft:db-info` の実装

**目的**: データベース接続の状態を診断するコマンドを実装

**実装内容**:

- `src/commands/db/info.ts` ファイルを新規作成
- データベースファイルパスの取得と表示
- データベースファイルサイズの取得
- WAL ファイルの状態確認
- 総仕様書数の取得
- フェーズ別集計の取得
- 最新の活動日時の取得
- 結果を表形式でフォーマット

**受け入れ基準**:

- [ ] `/cft:db-info` を実行するとデータベースファイルパスが表示される
- [ ] データベースファイルサイズが MB 単位で表示される
- [ ] WAL モードが有効であることが表示される
- [ ] 総仕様書数が正しく表示される
- [ ] フェーズ別の仕様書数が表形式で表示される
- [ ] 最新の活動日時が表示される

**工数見積**: 2 時間
---

### タスク 2: スラッシュコマンド定義ファイル `src/slash-commands/db-info.md` の作成

**目的**: `/cft:db-info` スラッシュコマンドの定義ファイルを作成

**実装内容**:

- `src/slash-commands/db-info.md` ファイルを新規作成
- コマンドの説明を記述
- 使用例を記述
- 実行するコマンド (`npx tsx .cc-craft-kit/commands/db/info.ts`) を記述

**受け入れ基準**:

- [ ] スラッシュコマンド定義ファイルが作成される
- [ ] コマンドの説明が明確に記述される
- [ ] 使用例が記述される

**工数見積**: 30 分
---

### タスク 3: 単体テスト `tests/commands/db/info.test.ts` の作成

**目的**: データベース診断コマンドの単体テストを作成

**実装内容**:

- `tests/commands/db/info.test.ts` ファイルを新規作成
- データベースファイルが存在する場合のテスト
- データベースファイルが存在しない場合のエラーハンドリングテスト
- WAL ファイルが存在する場合のテスト
- 仕様書が 0 件の場合のテスト

**受け入れ基準**:

- [ ] 全テストケースが実装される
- [ ] 全テストがパスする
- [ ] モックを使用してデータベースをテストする

**工数見積**: 2 時間
---

### タスク 4: 統合テスト `tests/integrations/db-diagnostics.test.ts` の作成

**目的**: データベース診断機能の統合テストを作成

**実装内容**:

- `tests/integrations/db-diagnostics.test.ts` ファイルを新規作成
- プロジェクト初期化後の診断情報表示テスト
- 仕様書作成後の総仕様書数増加テスト
- フェーズ移行後のフェーズ別集計更新テスト

**受け入れ基準**:

- [ ] 全テストシナリオが実装される
- [ ] 全テストがパスする
- [ ] 実際のデータベース操作を使用してテストする

**工数見積**: 2 時間
---

### タスク 5: completed フェーズ移行後の仕様書保持を検証

**目的**: completed フェーズ移行後も仕様書がデータベースに保持されることを検証

**実装内容**:

- 新しい仕様書を作成
- completed フェーズに移行
- `/cft:spec-list completed` で仕様書が表示されることを確認
- データベースに仕様書レコードが存在することを確認
- GitHub Issue がクローズされることを確認

**受け入れ基準**:

- [ ] completed フェーズ移行後も仕様書がデータベースに保持される
- [ ] `/cft:spec-list completed` で仕様書が表示される
- [ ] GitHub Issue が自動的にクローズされる

**工数見積**: 1 時間
---

### タスク 6: ドッグフーディング環境への同期

**目的**: 実装したコマンドをドッグフーディング環境に同期

**実装内容**:

- `npm run sync:dogfood` を実行
- TypeScript/ESLint チェック実行
- テスト実行

**受け入れ基準**:

- [ ] ドッグフーディング環境への同期が成功する
- [ ] TypeScript コンパイルエラーが 0 件
- [ ] ESLint 警告が 0 件
- [ ] 全テストがパスする

**工数見積**: 30 分
---

### タスクの依存関係

```
タスク 1: db-info コマンド実装
    ↓
タスク 2: スラッシュコマンド定義作成
    ↓
タスク 3: 単体テスト作成
    ↓
タスク 4: 統合テスト作成
    ↓
タスク 5: completed フェーズ検証
    ↓
タスク 6: ドッグフーディング同期
```

### 総工数見積

**合計**: 8 時間（約 1 日間）
