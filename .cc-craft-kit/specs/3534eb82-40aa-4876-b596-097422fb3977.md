# ログ記録の強化

**仕様書 ID:** 3534eb82-40aa-4876-b596-097422fb3977
**フェーズ:** completed
**作成日時:** 2025/11/18 15:04:11
**更新日時:** 2025/11/19 16:19:37

---

## 1. 背景と目的

### 背景

現在、cc-craft-kit のイベントハンドラー（`src/core/workflow/github-integration.ts`、`src/core/workflow/git-integration.ts` など）内で発生したエラーは、`console.warn` または `console.error` でのみ出力されており、`logs` テーブルに記録されていません。

これにより、以下の問題が発生しています:

1. **エラーの追跡困難** - コマンド実行時の標準出力にエラーが表示されないため、問題の原因特定が困難
2. **履歴の欠如** - エラー発生の履歴がデータベースに残らず、同じエラーが繰り返し発生しても気づけない
3. **デバッグ効率の低下** - GitHub Projects ステータス更新失敗などの問題が発生しても、ログがないため原因調査に時間がかかる

**具体例:**

Sub Issue 機能実装時、フェーズ移行後に GitHub Projects のステータスが更新されない問題が発生しました。イベントハンドラー内で `console.warn` のみが実行されており、エラーが `logs` テーブルに記録されていなかったため、問題の発見が遅れました。

### 目的

イベントハンドラー内で発生したすべてのエラー、警告、重要な情報を `logs` テーブルに記録することで、以下を実現します:

1. **エラーの可視化** - `/cft:status` コマンドで最近のエラーを確認可能に
2. **問題の早期発見** - エラーログを定期的に確認して、潜在的な問題を早期発見
3. **トラブルシューティングの効率化** - エラー発生時の詳細情報（スタックトレース、イベントデータ等）をログに記録
4. **統計分析** - エラー発生頻度やパターンを分析して、システム改善に活用

---

## 2. 対象ユーザー

- cc-craft-kit を使用して開発を行う開発者
- プロジェクト管理者（エラーログを確認して問題を早期発見したいユーザー）
- cc-craft-kit のメンテナー（バグ報告時のログ情報を活用したいユーザー）

---

## 3. 受け入れ基準

### 必須要件

- [ ] イベントハンドラー内の `console.error` をすべて `logs` テーブルへの記録に置き換える
- [ ] イベントハンドラー内の `console.warn` をすべて `logs` テーブルへの記録に置き換える
- [ ] エラーログには以下の情報を含める:
  - イベント名（`spec.created`, `spec.phase_changed` など）
  - エラーメッセージ
  - スタックトレース（可能な場合）
  - イベントデータ（`specId`, `taskId`, `oldPhase`, `newPhase` など）
- [ ] `/cft:status` コマンドで最近のエラーログ（直近 10 件）を表示

### 機能要件

- [ ] `src/core/errors/error-handler.ts` の `ErrorHandler` クラスを使用してログ記録
- [ ] エラーレベルを適切に設定（`debug`, `info`, `warn`, `error`）
- [ ] GitHub API エラーには `ExternalAPIError` クラスを使用
- [ ] データベースエラーには `DatabaseError` クラスを使用
- [ ] 各イベントハンドラーで統一的なエラーハンドリングパターンを採用
- [ ] デバッグモード（環境変数 `DEBUG=1`）で詳細ログを出力

### 非機能要件

- [ ] ログ記録がイベント処理のパフォーマンスに影響を与えない（非同期記録）
- [ ] ログテーブルの肥大化を防ぐため、古いログを定期的に削除するメカニズムを検討
- [ ] センシティブ情報（GitHub トークンなど）をログに記録しない

---

## 4. 制約条件

### 既存コードの制約

- イベントハンドラーは `src/core/workflow/github-integration.ts` と `src/core/workflow/git-integration.ts` に分散している
- `console.warn` / `console.error` が約 20 箇所存在する
- 後方互換性を保つため、既存のイベントハンドラーの動作を変更しない

### データベースの制約

- `logs` テーブルのスキーマは既に定義済み
- `timestamp` カラムは自動生成される

---

## 5. 依存関係

### 既存モジュール

- `src/core/errors/error-handler.ts` - ErrorHandler クラス
- `src/core/database/schema.ts` - logs テーブルのスキーマ定義
- `src/core/workflow/event-bus.ts` - イベントバス
- `src/commands/status.ts` - プロジェクト状況表示（ログ表示機能を追加）

### 関連する仕様書

- Sub Issue を活用 (0fd42810) - この仕様の実装中に発見された問題

---

## 6. 参考情報

### 既存のエラーハンドリング実装

- `src/core/errors/error-handler.ts` - ErrorHandler クラスの実装
- `src/core/errors/types.ts` - エラー型定義（AppError, ExternalAPIError, DatabaseError など）

### 現在の問題箇所

- `src/core/workflow/github-integration.ts:166` - Project 追加失敗時の console.warn
- `src/core/workflow/github-integration.ts:266` - Project ステータス更新失敗時の console.warn
- `src/core/workflow/github-integration.ts:300` - Sub Issue 作成失敗時の console.warn
- `src/core/workflow/git-integration.ts` - Git コミット失敗時の console.warn

### ログ記録のベストプラクティス

- エラーログには必ず `spec_id` または `task_id` を含める
- GitHub API エラーには HTTP ステータスコードとレスポンスボディを含める
- スタックトレースは `metadata` フィールドに JSON 形式で記録

---

## 7. 設計

### 7.1 アーキテクチャ設計

#### ログ記録フロー

```
イベント発火
    ↓
イベントハンドラー実行
    ↓
エラー発生
    ↓
ErrorHandler.log() 呼び出し
    ↓
logs テーブルに記録
    ↓
（DEBUG=1 の場合）console.error で詳細出力
```

#### コンポーネント構成

1. **ErrorHandler クラス** (`src/core/errors/error-handler.ts`)
   - 既存のログ記録メソッドを使用
   - `log(level, message, metadata)` メソッドでログテーブルに記録
   - 非同期処理でパフォーマンス影響を最小化

2. **イベントハンドラー** (`src/core/workflow/*.ts`)
   - `console.error` / `console.warn` を ErrorHandler に置き換え
   - try-catch ブロックでエラーをキャッチしてログ記録
   - イベントデータ（specId, taskId など）をログのメタデータに含める

3. **status コマンド** (`src/commands/status.ts`)
   - 最近のログ（直近 10 件）を表示する機能を追加
   - エラーログを優先的に表示（error → warn → info → debug）

### 7.2 データモデル設計

#### logs テーブル（既存）

| カラム | 型 | 説明 |
|--------|-------|------|
| id | UUID | ログID（主キー） |
| timestamp | DATETIME | ログ記録日時（自動生成） |
| level | TEXT | ログレベル（debug/info/warn/error） |
| message | TEXT | ログメッセージ |
| spec_id | UUID | 関連する仕様書ID（nullable） |
| task_id | UUID | 関連するタスクID（nullable） |
| metadata | TEXT | 追加情報（JSON形式） |

#### メタデータフィールドの構造

**GitHub API エラーの場合:**

```json
{
  "event": "spec.phase_changed",
  "error": {
    "type": "ExternalAPIError",
    "statusCode": 404,
    "response": "Project not found",
    "stack": "Error: ...\n  at ..."
  },
  "context": {
    "specId": "3534eb82-40aa-4876-b596-097422fb3977",
    "oldPhase": "requirements",
    "newPhase": "design"
  }
}
```

**Git コミットエラーの場合:**

```json
{
  "event": "spec.phase_changed",
  "error": {
    "type": "GitError",
    "command": "git commit",
    "exitCode": 1,
    "stderr": "error: ...",
    "stack": "Error: ...\n  at ..."
  },
  "context": {
    "specId": "3534eb82-40aa-4876-b596-097422fb3977",
    "phase": "completed"
  }
}
```

### 7.3 API 設計

#### ErrorHandler.log() メソッドの使用例

```typescript
// イベントハンドラー内でのエラーログ記録
try {
  await updateProjectStatus(projectId, issueNumber, newPhase);
} catch (error) {
  await ErrorHandler.log(
    'error',
    `Failed to update GitHub Project status: ${error.message}`,
    {
      event: 'spec.phase_changed',
      error: {
        type: error.constructor.name,
        statusCode: error.statusCode,
        response: error.response,
        stack: error.stack,
      },
      context: {
        specId,
        oldPhase,
        newPhase,
        projectId,
        issueNumber,
      },
    }
  );
}
```

#### 警告ログの記録

```typescript
// GitHub Project が設定されていない場合の警告
if (!projectId) {
  await ErrorHandler.log(
    'warn',
    'GitHub Project is not configured for this spec',
    {
      event: 'spec.phase_changed',
      context: {
        specId,
        phase: newPhase,
      },
    }
  );
  return;
}
```

### 7.4 エラーハンドリングパターン

#### 統一的なエラーハンドリング

すべてのイベントハンドラーで以下のパターンを採用します。

```typescript
eventBus.on('event.name', async (data) => {
  try {
    // イベント処理ロジック
    await processEvent(data);

    // 成功ログ（info レベル）
    await ErrorHandler.log('info', 'Event processed successfully', {
      event: 'event.name',
      context: { ...data },
    });
  } catch (error) {
    // エラーログ（error レベル）
    await ErrorHandler.log('error', `Failed to process event: ${error.message}`, {
      event: 'event.name',
      error: {
        type: error.constructor.name,
        message: error.message,
        stack: error.stack,
      },
      context: { ...data },
    });

    // デバッグモードでコンソール出力
    if (process.env.DEBUG === '1') {
      console.error(`[event.name] Error:`, error);
    }
  }
});
```

### 7.5 パフォーマンス設計

#### 非同期ログ記録

ログ記録は非同期処理（`await ErrorHandler.log()`）で実行し、イベント処理のパフォーマンスに影響を与えないようにします。

#### ログの定期削除（将来対応）

古いログを定期的に削除するメカニズムは、以下の方針で実装を検討します:

- ログ保持期間: 30 日間
- 削除タイミング: 毎日深夜 0 時（cron ジョブまたはスケジューラー）
- 削除対象: `timestamp` が 30 日以前のレコード

```sql
DELETE FROM logs WHERE timestamp < datetime('now', '-30 days');
```

### 7.6 セキュリティ設計

#### センシティブ情報の除外

以下の情報はログに記録しません:

- GitHub トークン（`GITHUB_TOKEN` 環境変数）
- API キー
- パスワード
- プライベートリポジトリのコード内容

メタデータに含める前に、センシティブ情報をフィルタリングする関数を用意します。

```typescript
function sanitizeMetadata(metadata: Record<string, unknown>): Record<string, unknown> {
  const sanitized = { ...metadata };

  // センシティブキーワードを含むフィールドを削除
  const sensitiveKeys = ['token', 'password', 'apiKey', 'secret'];

  Object.keys(sanitized).forEach((key) => {
    if (sensitiveKeys.some((sensitive) => key.toLowerCase().includes(sensitive))) {
      delete sanitized[key];
    }
  });

  return sanitized;
}
```

### 7.7 実装対象ファイル

#### 変更が必要なファイル

1. **`src/core/workflow/github-integration.ts`**
   - `console.error` / `console.warn` を ErrorHandler に置き換え（約 15 箇所）
   - イベントハンドラー内のエラーハンドリングを統一

2. **`src/core/workflow/git-integration.ts`**
   - `console.warn` を ErrorHandler に置き換え（約 5 箇所）
   - Git コミットエラーをログに記録

3. **`src/commands/status.ts`**
   - 最近のログ（直近 10 件）を表示する機能を追加
   - エラーログを優先的に表示

4. **`src/core/errors/error-handler.ts`**
   - `sanitizeMetadata()` 関数を追加（センシティブ情報除外）

#### 新規作成ファイル

なし（既存ファイルの修正のみ）

### 7.8 テスト設計

#### 単体テスト

- ErrorHandler.log() のテスト（メタデータのサニタイズ確認）
- イベントハンドラーのエラーハンドリングテスト（ログ記録確認）

#### 統合テスト

- フェーズ移行時の GitHub Projects ステータス更新エラーログ記録テスト
- Git コミット失敗時のエラーログ記録テスト
- `/cft:status` コマンドでのエラーログ表示テスト

#### テストシナリオ例

1. GitHub Project が存在しない場合、エラーログが記録されることを確認
2. Git リポジトリが未初期化の場合、警告ログが記録されることを確認
3. `/cft:status` コマンドで最近のエラーログ（直近 10 件）が表示されることを確認

---

## 8. 実装タスクリスト

### タスク1: ErrorHandler にセンシティブ情報除外機能を追加

**目的**: ログに GitHub トークンなどのセンシティブ情報が記録されないようにする

**実装内容**:
- `src/core/errors/error-handler.ts` に `sanitizeMetadata()` 静的メソッドを追加
- センシティブキーワード（token, password, apiKey, secret）を含むフィールドを削除
- `log()` メソッド内で `sanitizeMetadata()` を自動的に呼び出す

**受け入れ基準**:
- センシティブキーワードを含むフィールドがログに記録されない
- 通常のメタデータは正常に記録される

**工数見積**: 2 時間

---

### タスク2: github-integration.ts のエラーハンドリングを ErrorHandler に置き換え

**目的**: GitHub 統合イベントハンドラー内のすべてのエラーをログテーブルに記録する

**実装内容**:
- `src/core/workflow/github-integration.ts` 内の `console.error` / `console.warn` を ErrorHandler に置き換え（約 15 箇所）
- イベント名、エラー詳細、コンテキスト情報をメタデータに含める
- 統一的なエラーハンドリングパターンを適用

**受け入れ基準**:
- すべての `console.error` / `console.warn` が ErrorHandler に置き換えられている
- エラーログに `event`、`error`、`context` フィールドが含まれている
- GitHub API エラーには HTTP ステータスコードとレスポンスが記録される

**工数見積**: 4 時間

---

### タスク3: git-integration.ts のエラーハンドリングを ErrorHandler に置き換え

**目的**: Git 統合イベントハンドラー内のすべてのエラーをログテーブルに記録する

**実装内容**:
- `src/core/workflow/git-integration.ts` 内の `console.warn` を ErrorHandler に置き換え（約 5 箇所）
- Git コミット失敗時のエラー詳細（コマンド、終了コード、stderr）をメタデータに記録
- 統一的なエラーハンドリングパターンを適用

**受け入れ基準**:
- すべての `console.warn` が ErrorHandler に置き換えられている
- エラーログに Git コマンド、終了コード、stderr が記録される

**工数見積**: 2 時間

---

### タスク4: status コマンドにエラーログ表示機能を追加

**目的**: `/cft:status` コマンドで最近のエラーログを確認できるようにする

**実装内容**:
- `src/commands/status.ts` にエラーログ取得ロジックを追加
- 最近のログ（直近 10 件）を優先度順（error → warn → info → debug）で表示
- ログレベル、タイムスタンプ、メッセージを表形式で表示

**受け入れ基準**:
- `/cft:status` コマンドの出力に「Recent Error Logs」セクションが追加される
- 直近 10 件のエラーログが表示される
- エラーログが優先度順にソートされている

**工数見積**: 3 時間

---

### タスク5: 単体テストを作成（ErrorHandler のサニタイズ機能テスト）

**目的**: センシティブ情報除外機能が正しく動作することを確認する

**実装内容**:
- `tests/core/errors/error-handler.test.ts` にサニタイズ機能のテストを追加
- センシティブキーワードを含むフィールドが削除されることを検証
- 通常のメタデータが保持されることを検証

**受け入れ基準**:
- `sanitizeMetadata()` のテストが追加される
- すべてのテストがパスする

**工数見積**: 1 時間

---

### タスク6: 統合テストを作成（イベントハンドラーのログ記録テスト）

**目的**: イベントハンドラー内のエラーログが正しく記録されることを確認する

**実装内容**:
- `tests/integrations/event-logging.test.ts` に統合テストを追加
- GitHub Projects ステータス更新失敗時のエラーログ記録をテスト
- Git コミット失敗時のエラーログ記録をテスト
- `/cft:status` コマンドでエラーログが表示されることをテスト

**受け入れ基準**:
- 統合テストがすべてパスする
- エラーログが正しく `logs` テーブルに記録される
- `/cft:status` コマンドでエラーログが正しく表示される

**工数見積**: 3 時間

---

### タスクの依存関係

```
タスク1（ErrorHandler サニタイズ機能追加）
    ↓
タスク2（github-integration.ts の置き換え）
    ↓
タスク3（git-integration.ts の置き換え）
    ↓
タスク4（status コマンドのログ表示機能追加）
    ↓
タスク5（単体テスト作成）
    ↓
タスク6（統合テスト作成）
```

### 総工数見積

**合計**: 15 時間（約 2 日間）
