---
id: "b1098fbd-2d4c-464d-8831-7cebc42c1f0d"
name: ".env の GITHUB_DEFAULT_BASE_BRANCH は不要では？"
phase: "completed"
branch_name: "main"
github_issue_number: null
pr_url: null
created_at: "2025-11-24T04:21:31.166Z"
updated_at: "2025-11-24T13:49:52Z"
---

# .env の GITHUB_DEFAULT_BASE_BRANCH は不要では？


## 1. 背景と目的

### 背景

各ブランチは、BASE_BRANCH から派生して作る。このため、PR は必ず BASE_BRANCH にマージされなければならない。間違っているだろうか。

### 目的

`GITHUB_DEFAULT_BASE_BRANCH` は不要であり、`BASE_BRANCH` に統合すべきである。仕様駆動開発では、すべての仕様書ブランチは同じベースブランチから派生し、同じベースブランチにマージされるべきである。`GITHUB_DEFAULT_BASE_BRANCH` を廃止し、`BASE_BRANCH` のみを使用するように実装を修正する。
---

## 2. 対象ユーザー

- **cc-craft-kit 開発者**: ブランチ戦略と環境変数の設計を理解する必要がある開発者
- **プロジェクトメンテナー**: `.env.example` のドキュメント管理を行う担当者
- **エンドユーザー（開発者）**: cc-craft-kit を使用して仕様駆動開発を行う開発者
---

## 3. 受け入れ基準

### 必須要件

- [ ] `GITHUB_DEFAULT_BASE_BRANCH` のすべての使用箇所を特定する
- [ ] `GITHUB_DEFAULT_BASE_BRANCH` を `BASE_BRANCH` に置き換える
- [ ] `GitHubConfig` インターフェースから `defaultBaseBranch` プロパティを削除する
- [ ] `.env.example` から `GITHUB_DEFAULT_BASE_BRANCH` を削除する

### 機能要件

- [ ] PR 作成処理で `BASE_BRANCH` を使用するように修正する
- [ ] hotfix ブランチの場合は引き続き `main` へ PR を作成する（特殊処理は維持）
- [ ] ブランチ作成処理は変更不要（すでに `BASE_BRANCH` を使用している）
- [ ] すべてのテストケースを更新する

### 非機能要件

- [ ] 既存のユーザーへの影響を最小化する（`GITHUB_DEFAULT_BASE_BRANCH` が設定されていても無視される）
- [ ] 型チェックがすべて通る
- [ ] すべてのテストが通る
- [ ] ドキュメントが明確である
---

## 4. 制約条件

- **仕様駆動開発の原則**: すべての仕様書ブランチは `BASE_BRANCH` から派生し、`BASE_BRANCH` にマージされる
- **hotfix の特殊処理**: hotfix ブランチのみ、`main` へ PR を作成する（例外として維持）
- **ブランチ戦略**: GitHub Flow + develop ブランチのモデルに準拠する
- **型安全性**: TypeScript の型システムで環境変数を管理する（`GitHubConfig` インターフェース）
- **デフォルト値**: `BASE_BRANCH` のデフォルト値は `develop`
- **保護ブランチ**: `main`, `develop` は保護ブランチとして扱う
---

## 5. 依存関係

### 修正が必要なファイル

- `src/core/config/github-config.ts` - `defaultBaseBranch` プロパティを削除
- `src/core/workflow/branch-management.ts` - PR 作成時に `baseBranch` を使用するように修正
- `tests/core/config/github-config.test.ts` - `defaultBaseBranch` 関連のテストを削除
- `tests/core/workflow/branch-management-pr-creation.test.ts` - PR 作成テストを更新
- `.env.example` - `GITHUB_DEFAULT_BASE_BRANCH` の記述を削除

### 修正不要なファイル

- `src/core/git/branch-creation.ts` - すでに `BASE_BRANCH` を使用している
- `src/commands/spec/create.ts` - すでに `BASE_BRANCH` を使用している

### 関連仕様書

- **570644e2-814c-4f8b-a42b-b5f654e610e4**: 「開発キットが .env の BASE_BRANCH や GITHUB_DEFAULT_BASE_BRANCH を参照していない」（completed フェーズ）
  - この仕様で `BASE_BRANCH` と `GITHUB_DEFAULT_BASE_BRANCH` の実装が完了している

### 依存コンポーネント

- **EventBus**: フェーズ遷移時のイベント処理
- **Kysely**: データベース操作（仕様書レコード管理）
- **child_process**: Git コマンド実行（ブランチ作成、切り替え）
---

## 6. 参考情報

### 問題点の分析

#### 現在の実装の問題

現在の実装では、以下のように環境変数が分離されています:

| 環境変数 | 用途 | 使用タイミング |
|---|---|---|
| `BASE_BRANCH` | ブランチ作成の起点 | `/cft:spec-create` 実行時 |
| `GITHUB_DEFAULT_BASE_BRANCH` | PR のマージ先 | `completed` フェーズ移行時 |

**問題点:**

```
BASE_BRANCH=develop で feature/spec-xxx を作成
  ↓
GITHUB_DEFAULT_BASE_BRANCH=staging へ PR 作成
  ↓
問題: develop から派生したブランチを staging にマージしようとする
      → ブランチ戦略が破綻する
```

#### 正しい設計

**仕様駆動開発の原則**: 仕様書ブランチは派生元に戻るべき

```
BASE_BRANCH=develop で feature/spec-xxx を作成
  ↓
develop へ PR 作成（派生元に戻る）
  ↓
正しい: 仕様書は BASE_BRANCH から派生し、BASE_BRANCH にマージされる
```

#### 結論

**`GITHUB_DEFAULT_BASE_BRANCH` は不要。`BASE_BRANCH` に統合する。**

### 修正後の実装パターン

**ブランチ作成処理** (`src/core/git/branch-creation.ts:131`):
```typescript
// 変更なし（すでに BASE_BRANCH を使用）
execFileSync('git', ['branch', branchName, baseBranch], { stdio: 'pipe' });
```

**PR 作成処理** (`src/core/workflow/branch-management.ts:109`):
```typescript
// 修正前
const baseBranch = isHotfixBranch(currentBranch) ? 'main' : config.defaultBaseBranch;

// 修正後
const baseBranch = isHotfixBranch(currentBranch) ? 'main' : config.baseBranch;
```

### 関連 GitHub Issue

- [#338](https://github.com/B16B1RD/cc-craft-kit/issues/338): この仕様の実装タスク
---

## 7. 設計詳細

### 7.1. アーキテクチャ設計

#### 環境変数の統合

**修正前**:
```
BASE_BRANCH (ブランチ作成時の派生元)
    ↓
GITHUB_DEFAULT_BASE_BRANCH (PR 作成時のマージ先)
```

**修正後**:
```
GITHUB_DEFAULT_BASE_BRANCH (ブランチ作成時の派生元 = PR 作成時のマージ先)
```

#### 仕様駆動開発の原則

すべての仕様書ブランチは同じベースブランチから派生し、同じベースブランチにマージされる。

```
GITHUB_DEFAULT_BASE_BRANCH=develop

/cft:spec-create
  ↓
feature/spec-xxx を develop から作成
  ↓
completed フェーズ移行時
  ↓
develop へ PR 作成
```

**例外処理: hotfix ブランチ**

hotfix ブランチのみ、常に `main` へ PR を作成する。

```typescript
const baseBranch = isHotfixBranch(currentBranch) ? 'main' : config.defaultBaseBranch;
```

### 7.2. データモデル

#### GitHubConfig インターフェースの変更

**修正前** (`src/core/config/github-config.ts:10-21`):
```typescript
export interface GitHubConfig {
  owner: string | null;
  repo: string | null;
  baseBranch: string;  // 削除対象
  defaultBaseBranch: string;
  protectedBranches: string[];
}
```

**修正後**:
```typescript
export interface GitHubConfig {
  owner: string | null;
  repo: string | null;
  defaultBaseBranch: string;  // baseBranch を削除
  protectedBranches: string[];
}
```

#### 環境変数の読み込み

**修正前** (`src/core/config/github-config.ts:31-41`):
```typescript
export function getGitHubConfig(): GitHubConfig {
  return {
    owner: process.env.GITHUB_OWNER?.trim() || null,
    repo: process.env.GITHUB_REPO?.trim() || null,
    baseBranch: process.env.BASE_BRANCH?.trim() || 'develop',  // 削除
    defaultBaseBranch: process.env.GITHUB_DEFAULT_BASE_BRANCH?.trim() || 'develop',
    protectedBranches: process.env.PROTECTED_BRANCHES?.split(',')
      .map((b) => b.trim())
      .filter(Boolean) || ['main', 'develop'],
  };
}
```

**修正後**:
```typescript
export function getGitHubConfig(): GitHubConfig {
  return {
    owner: process.env.GITHUB_OWNER?.trim() || null,
    repo: process.env.GITHUB_REPO?.trim() || null,
    defaultBaseBranch: process.env.GITHUB_DEFAULT_BASE_BRANCH?.trim() || 'develop',
    protectedBranches: process.env.PROTECTED_BRANCHES?.split(',')
      .map((b) => b.trim())
      .filter(Boolean) || ['main', 'develop'],
  };
}
```

### 7.3. API の仕様

該当なし（外部 API は変更しない）

### 7.4. セキュリティ考慮事項

#### 環境変数の後方互換性

**方針**: 既存のユーザーが `BASE_BRANCH` を `.env` に設定していても、無視される（エラーは発生しない）

**理由**:
- 環境変数は `process.env` から直接読み込まれるため、未使用の環境変数が設定されていても問題ない
- `BASE_BRANCH` を参照しているコードがなければ、設定されていても影響しない

#### ブランチ保護

**保護ブランチでの動作**:
- `main`, `develop` ブランチでは PR 作成をスキップ
- 保護ブランチリストは環境変数 `PROTECTED_BRANCHES` で設定可能

### 7.5. テスト戦略

#### 単体テスト

1. **GitHubConfig のテスト** (`tests/core/config/github-config.test.ts`):
   - ✅ `defaultBaseBranch` の読み込みテスト（既存）
   - ❌ `baseBranch` のテスト削除（行22-52）
   - ✅ 統合シナリオテストの修正（行120-149）

2. **PR 作成処理のテスト** (`tests/core/workflow/branch-management-pr-creation.test.ts`):
   - ✅ hotfix ブランチの特殊処理テスト（既存、行354-437）
   - ✅ `GITHUB_DEFAULT_BASE_BRANCH` が設定されている場合のテスト（既存、行439-531）
   - ✅ 保護ブランチチェック（既存、行639-821）
   - ✅ モック返却値の修正（行79-84）

#### テストカバレッジ

- 目標: 80%以上
- 既存テストの修正のみで達成可能

#### 実行コマンド

```bash
# すべてのテストを実行
npm test

# カバレッジを確認
npm run test:coverage

# 型チェック
npx tsc --noEmit

# リント
npm run lint
```
---

### 7.6. 実装の影響範囲

#### 修正が必要なファイル（4ファイル）

| ファイル | 修正内容 | 行番号 |
|---------|---------|--------|
| `src/core/config/github-config.ts` | `baseBranch` プロパティ削除 | 15-16, 35 |
| `src/core/git/branch-creation.ts` | `baseBranch` → `defaultBaseBranch` に変更 | 115, 131 |
| `tests/core/config/github-config.test.ts` | `baseBranch` テストケース削除 | 22-52 |
| `tests/core/workflow/branch-management-pr-creation.test.ts` | モック返却値修正 | 79-84 |

#### 修正不要なファイル（2ファイル）

| ファイル | 理由 |
|---------|------|
| `src/commands/spec/create.ts` | すでに `BASE_BRANCH` を使用（環境変数のみ） |
| `src/core/workflow/branch-management.ts` | すでに `defaultBaseBranch` を使用 |

#### 削除対象（1ファイル）

| ファイル | 削除内容 |
|---------|---------|
| `.env.example` | `BASE_BRANCH` の記述と コメント |
---

### 7.7. 移行ガイド

#### ユーザー向けドキュメント

**影響を受けるユーザー**:
- `.env` に `BASE_BRANCH` を設定しているユーザー

**移行手順**:
1. `.env` から `BASE_BRANCH` の行を削除（任意、設定されていても無視される）
2. `GITHUB_DEFAULT_BASE_BRANCH` を確認（未設定の場合はデフォルト `develop` が使用される）

**例**:

```bash
# 修正前の .env
BASE_BRANCH=develop
GITHUB_DEFAULT_BASE_BRANCH=develop

# 修正後の .env
GITHUB_DEFAULT_BASE_BRANCH=develop  # BASE_BRANCH は削除（任意）
```

#### 後方互換性

- `BASE_BRANCH` が設定されていても、エラーは発生しない
- `GITHUB_DEFAULT_BASE_BRANCH` が未設定の場合は `develop` がデフォルト
---

## 8. 実装タスクリスト

### コア実装タスク

- [ ] **タスク 1**: GitHubConfig インターフェースから baseBranch プロパティを削除する
  - ファイル: `src/core/config/github-config.ts:15-16`
  - 内容: `baseBranch: string;` の行を削除

- [ ] **タスク 2**: getGitHubConfig 関数から baseBranch の読み込み処理を削除する
  - ファイル: `src/core/config/github-config.ts:35`
  - 内容: `baseBranch: process.env.BASE_BRANCH?.trim() || 'develop',` の行を削除

- [ ] **タスク 3**: src/core/git/branch-creation.ts で baseBranch を defaultBaseBranch に変更する
  - ファイル: `src/core/git/branch-creation.ts:115, 131`
  - 内容: `config.baseBranch` を `config.defaultBaseBranch` に置換

### テストタスク

- [ ] **タスク 4**: tests/core/config/github-config.test.ts から baseBranch テストケースを削除する
  - ファイル: `tests/core/config/github-config.test.ts:22-52`
  - 内容: `baseBranch` 関連のテストケースを削除

- [ ] **タスク 5**: tests/core/workflow/branch-management-pr-creation.test.ts のモック返却値を修正する
  - ファイル: `tests/core/workflow/branch-management-pr-creation.test.ts:79-84`
  - 内容: `baseBranch` を `defaultBaseBranch` に変更

### ドキュメントタスク

- [ ] **タスク 6**: .env.example から BASE_BRANCH の記述を削除する
  - ファイル: `.env.example`
  - 内容: `BASE_BRANCH=develop` の行とコメントを削除

### 品質チェックタスク

- [ ] **タスク 7**: 型チェックを実行して型エラーがないことを確認する
  - コマンド: `npx tsc --noEmit`

- [ ] **タスク 8**: すべてのテストを実行して通ることを確認する
  - コマンド: `npm test`

- [ ] **タスク 9**: ESLint を実行してコード品質を確認する
  - コマンド: `npm run lint`

### 実装順序

1. コア実装タスク (タスク 1-3)
2. テストタスク (タスク 4-5)
3. ドキュメントタスク (タスク 6)
4. 品質チェックタスク (タスク 7-9)

### 依存関係

- タスク 2 は タスク 1 の完了後に実行可能
- タスク 4-5 は タスク 1-3 の完了後に実行可能
- タスク 7-9 は すべてのタスク完了後に実行
