# implementation フェーズ完了時、未コミットのものがある

**仕様書 ID:** 842ac6b3-0ccc-46c2-9840-11bbfb89a58d
**フェーズ:** design
**作成日時:** 2025/11/23 20:47:51
**更新日時:** 2025/11/23 20:59:01

---

## 1. 背景と目的

### 背景

現在、cc-craft-kit では `implementation` フェーズから `completed` フェーズへ移行する際に、自動コミット機能が働いているものの、**仕様書ファイルのみがコミット対象**となっている。

**根本原因**:
- `src/core/workflow/git-integration.ts` の `getCommitTargets()` 関数が、仕様書ファイル (`.cc-craft-kit/specs/{spec-id}.md`) のみを返却している
- そのため、実装コード (`src/`, `tests/`) や設定ファイルなどは未コミット状態で残る

この問題は、以下の既存仕様書でも指摘されている:
- `.cc-craft-kit/specs/efef7d78-6e0b-4e6a-a5ec-0856e4012b76.md` (getCommitTargetsの返り値修正)

**影響範囲**:
- 開発者が意図せず未コミットファイルを残したまま、PR を作成してしまう
- Git ステータスが混乱し、どのファイルがコミットされたのか分かりにくくなる
- フェーズごとの変更履歴が追跡できなくなる

### 目的

implementation フェーズ完了時（`completed` フェーズ移行時）に、**全変更ファイルを自動コミット**する仕組みを実装し、未コミットファイルが残らないようにする。

**設計方針**:
1. **プロンプトファースト**: プロンプトで実現できることはプロンプトで実現する
2. **スキル/サブエージェント活用**: スキルやサブエージェントで実現できないかよく検討する
3. **スクリプト実装は最終手段**: 既存の TypeScript スクリプト修正が必要な場合のみ実施

**成功基準**:
- `implementation → completed` 時、実装コードを含む全変更ファイルがコミットされる
- 既存の E2E テスト (`tests/e2e/phase-transition-commit.test.ts`) がすべて通過する
- Git ステータスがクリーンな状態になる

---

## 2. 対象ユーザー

cc-craft-kit を使用する**開発者**（特に Claude Code を利用して仕様駆動開発を実践する開発者）

**具体的なユースケース**:
- 仕様書を作成し、implementation フェーズで実装コードを追加した後、completed フェーズに移行する際、全変更ファイルが自動コミットされることを期待する
- フェーズ遷移時に、手動で `git add .` や `git commit` を実行する必要がなくなる
- PR 作成前に、未コミットファイルが残っていないかチェックする手間を削減できる

---

## 3. 受け入れ基準

### 必須要件

- [ ] `implementation → completed` フェーズ移行時、**全変更ファイル**（仕様書ファイル + 実装コード + テスト + 設定ファイル）が自動コミットされる
- [ ] 既存の E2E テスト (`tests/e2e/phase-transition-commit.test.ts`) がすべて通過する
- [ ] コミット後、`git status` がクリーンな状態（未コミット変更なし）になる

### 機能要件

- [ ] `getCommitTargets(specId)` 関数が、仕様書ファイルのみではなく全変更ファイル (`['.']`) を返却する
- [ ] `.gitignore` で除外されたファイルは、自動的にコミット対象から除外される
- [ ] コミットメッセージは既存の規則に従う（`feat: {仕様書名} を実装完了`）
- [ ] フェーズ遷移時の自動コミットが失敗した場合、ステージングをロールバックし、フェーズ遷移は成功させる（既存の動作を維持）

### 非機能要件

- [ ] セキュリティ: `spawnSync` を使用したシェルインジェクション対策を維持する
- [ ] パフォーマンス: `git add .` によるコミット対象決定が、大規模リポジトリでも許容可能な速度で完了する
- [ ] 互換性: 既存のイベント駆動アーキテクチャ（`spec.phase_changed` イベント）を維持する
- [ ] テストカバレッジ: 修正箇所の単体テスト、E2E テストがすべて通過する

---

## 4. 制約条件

### 技術的制約

1. **既存インターフェース維持**
   - `handlePhaseChangeCommit()`, `handleSpecCreatedCommit()` のシグネチャ変更不可
   - 既存のイベント駆動アーキテクチャ（EventBus）を維持する

2. **セキュリティ対策維持**
   - `spawnSync` 使用によるシェルインジェクション対策
   - UUID バリデーション（`getCommitTargets()` の引数検証）
   - `.gitignore` 除外処理の継続

3. **エラーハンドリング**
   - Git リポジトリ未初期化時: 警告表示 + スキップ
   - コミット失敗時: ステージングロールバック (`git reset HEAD`)
   - フェーズ変更は成功させる（コミット失敗でもフェーズ遷移は完了）

### 設計制約

1. **プロンプトファースト原則**
   - プロンプトで実現できることはプロンプトで実現する
   - スクリプト実装は最終手段とする

2. **スキル/サブエージェント活用**
   - 既存のスキル（`git-operations`, `typescript-eslint` など）で実現できないか検討する
   - サブエージェント（`code-reviewer`, `refactoring-assistant`）の活用を優先する

3. **TypeScript スクリプト実装の条件**
   - データベース操作が必要
   - イベント発火・ハンドラー登録が必要
   - 複雑な Zod スキーマ検証が必要
   - 型安全性が重要（TypeScript の型推論が必要）

### 運用上の制約

1. **テストカバレッジ維持**
   - 既存テスト (`tests/e2e/phase-transition-commit.test.ts`) がすべて通過すること
   - 修正箇所の単体テストを追加すること

2. **コード品質維持**
   - ESLint ルール準拠
   - TypeScript strict mode
   - 命名規則: camelCase (変数・関数), PascalCase (クラス・型)

---

## 5. 依存関係

### 既存仕様書

- **efef7d78-6e0b-4e6a-a5ec-0856e4012b76**: `getCommitTargets()` の返り値修正
  - 本仕様書と同じ問題を解決する仕様書
  - 実装済みの場合、重複を避けるため、本仕様書は不要となる可能性がある

### 既存コンポーネント

1. **src/core/workflow/git-integration.ts**
   - `getCommitTargets(specId: string)`: コミット対象ファイル決定（修正対象）
   - `gitCommit(files: string[], message: string)`: Git コミット実行
   - `handlePhaseChangeCommit()`: フェーズ変更時の自動コミット
   - `handleSpecCreatedCommit()`: 仕様書作成時の自動コミット

2. **src/core/workflow/event-bus.ts**
   - `EventBus`: イベント駆動アーキテクチャの中核
   - `spec.phase_changed` イベントが発火され、`handlePhaseChangeCommit()` が呼び出される

3. **src/commands/spec/phase.ts**
   - `/cft:spec-phase` コマンドの実装
   - フェーズ変更時に `spec.phase_changed` イベントを発火

### テストケース

1. **tests/e2e/phase-transition-commit.test.ts**
   - フェーズ遷移時の自動コミット処理の E2E テスト
   - `implementation → completed` 時の期待値: `['.']` (全変更ファイル)

2. **tests/core/workflow/git-integration.test.ts**
   - `getCommitTargets()` 関数の単体テスト
   - 修正後の期待値: `['.']`

---

## 6. 参考情報

### 関連ファイル

- `src/core/workflow/git-integration.ts:165-174` - `getCommitTargets()` 関数（修正対象）
- `tests/core/workflow/git-integration.test.ts:318-387` - 単体テスト（期待値更新が必要）
- `tests/e2e/phase-transition-commit.test.ts:316-331` - E2E テスト（既に `['.']` を期待）

### 既存の実装パターン

**コミットメッセージ規約** (Conventional Commits):
- `feat:` - 新機能
- `fix:` - バグ修正
- `refactor:` - リファクタリング

**Git コマンド実行パターン**:
```typescript
import { spawnSync } from 'node:child_process';

const result = spawnSync('git', ['add', ...files], {
  encoding: 'utf-8',
  stdio: ['ignore', 'pipe', 'pipe'],
});

if (result.status !== 0) {
  throw new Error(`git command failed: ${result.stderr}`);
}
```

### 想定される実装アプローチ

**アプローチ 1: スクリプト修正（推奨）**
- `getCommitTargets()` の返り値を `['.']` に変更
- 既存テストの期待値を更新
- 影響範囲: 最小限

**アプローチ 2: プロンプトベース（検討中）**
- スラッシュコマンド `.cc-craft-kit/commands/spec/phase.md` でコミット処理をオーバーライド
- 課題: イベント駆動アーキテクチャとの整合性を保つ必要がある

**アプローチ 3: スキル活用（検討中）**
- `git-operations` スキルを拡張して、フェーズ遷移時のコミット処理をカスタマイズ
- 課題: 既存のイベントハンドラーとの競合を避ける必要がある
