# GitHub Issue 本文・変更履歴コメントの同期が機能しない

**仕様書 ID:** ece5f26c-a4f4-439e-b402-167f8d08e33f
**フェーズ:** completed
**作成日時:** 2025/11/25 16:30:00
**更新日時:** 2025/11/25 17:25:00

---

## 1. 背景と目的

### 背景

spec.phase_changed イベント時に Issue 本文が更新されず、変更履歴コメントも追加されない問題を修正する。

GitHub Issue #368 で設計された以下の機能が実際には動作していない:

1. **Issue 本文の同期**: フェーズ変更時に Issue 本文が仕様書ファイルで更新されない
2. **変更履歴コメント（`📝 仕様書更新`）**: `spec.updated` イベントによる変更履歴コメントが追加されない

### 目的

- Issue 本文を常に最新の仕様書内容で同期する
- フェーズ変更時にも変更履歴コメントを追加する

---

## 2. 対象ユーザー

- cc-craft-kit を使用して仕様駆動開発を行う開発者
- GitHub Issue で進捗を確認するプロジェクト管理者

---

## 3. 受け入れ基準

### 必須要件

- [ ] フェーズ変更時に Issue 本文が仕様書ファイルの内容で更新される
- [ ] フェーズ変更時に変更履歴コメントが追加される

### 機能要件

- [ ] `spec.phase_changed` ハンドラーで仕様書ファイルを正しく読み込む
- [ ] `spec.phase_changed` ハンドラーで Issue 本文を更新する
- [ ] `spec.phase_changed` ハンドラーで変更履歴コメント（📝 仕様書更新）を追加する

### 非機能要件

- [ ] デバッグログを追加して問題の原因を特定できる
- [ ] エラーハンドリングを強化して失敗時に適切なメッセージを表示する

---

## 4. 制約条件

- プロンプトファースト原則に従い、可能な限りプロンプトベースで実装すること
- 既存の cc-craft-kit アーキテクチャに準拠すること
- GitHub API v3/v4 の仕様に準拠すること

---

## 5. 依存関係

- `src/core/workflow/github-integration.ts` - GitHub 統合のイベントハンドラー
- `src/integrations/github/changelog-writer.ts` - 変更履歴コメント生成
- `src/integrations/github/issues.ts` - GitHub Issues API ラッパー

---

## 6. 参考情報

- GitHub Issue #368: GitHub Issue の運用見直し
- 計画ファイル: `/home/autum/.claude/plans/lexical-scribbling-wolf.md`

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
┌─────────────────────────────────────────────────────────────────────┐
│                      cc-craft-kit イベントフロー                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  /cft:spec-phase コマンド                                           │
│       │                                                             │
│       ▼                                                             │
│  ┌─────────────────────┐                                           │
│  │ spec/update-phase.ts │ ─── DB 更新 + イベント発火                │
│  └─────────────────────┘                                           │
│       │                                                             │
│       │ spec.phase_changed イベント                                 │
│       ▼                                                             │
│  ┌─────────────────────────────────────────────────┐               │
│  │        github-integration.ts ハンドラー          │               │
│  ├─────────────────────────────────────────────────┤               │
│  │ ✅ Issue タイトル更新（フェーズ反映）            │               │
│  │ ✅ Issue ラベル更新（phase:xxx）                │               │
│  │ ✅ フェーズ移行コメント（🔄）                   │               │
│  │ ❌ Issue 本文更新 ← 修正対象                    │               │
│  │ ❌ 変更履歴コメント（📝）← 修正対象             │               │
│  └─────────────────────────────────────────────────┘               │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

#### 設計方針

**アプローチ: 直接修正（推奨）**

`spec.phase_changed` ハンドラー内に `spec.updated` ハンドラーと同様のロジックを追加する。

- イベント連鎖（`spec.updated` イベント発火）は複雑化の原因となるため採用しない
- 単一ハンドラー内で処理を完結させる

#### 処理フロー詳細

```
spec.phase_changed イベント受信
       │
       ▼
┌────────────────────────────────┐
│ 1. 前置条件チェック             │
│    - GitHub トークン確認        │
│    - GitHub 設定確認            │
│    - 仕様書情報取得             │
│    - Issue 番号存在確認         │
└────────────────────────────────┘
       │
       ▼
┌────────────────────────────────┐
│ 2. 仕様書ファイル読み込み       │
│    - specPath から readFileSync │
│    - エラー時は警告ログ出力     │
└────────────────────────────────┘
       │
       ▼
┌────────────────────────────────┐
│ 3. 既存 Issue 内容取得          │
│    - issues.get() で取得        │
│    - body を oldContent として保存 │
└────────────────────────────────┘
       │
       ▼
┌────────────────────────────────┐
│ 4. 変更検出                     │
│    - detectChanges(old, new)    │
│    - セクション追加/削除/変更   │
└────────────────────────────────┘
       │
       ▼
┌────────────────────────────────┐
│ 5. Issue 更新                   │
│    - title: フェーズ反映        │
│    - labels: phase:xxx          │
│    - body: 仕様書全文 ← 追加    │
└────────────────────────────────┘
       │
       ▼
┌────────────────────────────────┐
│ 6. フェーズ移行コメント追加     │
│    - 🔄 フェーズ移行            │
│    - oldPhase → newPhase        │
└────────────────────────────────┘
       │
       ▼
┌────────────────────────────────┐
│ 7. 変更履歴コメント追加（条件付き）│
│    - changes.length > 0 の場合のみ │
│    - 📝 仕様書更新               │
│    - buildChangelogComment() 使用 │
└────────────────────────────────┘
       │
       ▼
┌────────────────────────────────┐
│ 8. Project ステータス更新       │
│    - 既存ロジック維持           │
└────────────────────────────────┘
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/core/workflow/github-integration.ts` | `spec.phase_changed` ハンドラーに Issue 本文更新 + 変更履歴コメント追加ロジックを実装 |
| `tests/core/workflow/github-integration.test.ts` | `spec.phase_changed` ハンドラーのテストケース追加 |

#### 必要なインポート追加

```typescript
import { detectChanges, buildChangelogComment } from '../../integrations/github/changelog-writer.js';
```

#### 修正箇所

`github-integration.ts` の `spec.phase_changed` ハンドラー（170-440行目付近）:

1. **Issue 本文更新の強化**（197-216行目）
   - `issues.get()` で既存 Issue 内容を取得
   - `detectChanges()` で変更検出
   - `issues.update()` に `body` パラメータを必ず含める

2. **変更履歴コメント追加**（フェーズ移行コメントの後）
   - `changes.length > 0` の場合のみ
   - `buildChangelogComment()` でコメント生成
   - `issues.addComment()` でコメント追加

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| Issue 本文更新 | ファイル読み込みのみ（body が undefined になる可能性） | 既存 Issue 取得 → 変更検出 → 必ず body を含めて更新 | `github-integration.ts:197-216` |
| 変更履歴コメント | 未実装（`spec.updated` イベントでのみ動作） | `detectChanges()` + `buildChangelogComment()` で実装 | `github-integration.ts:220-240`（新規追加） |
| エラーハンドリング | `console.error()` のみ | `logError()` 統一 + デバッグログ追加 | `github-integration.ts:170-440` |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| Issue 本文更新 | フェーズ変更時に Issue 本文が仕様書内容で更新される | モック `issues.update()` の `body` パラメータ確認 |
| 変更履歴コメント | 変更がある場合に 📝 仕様書更新 コメントが追加される | モック `issues.addComment()` の呼び出し確認 |
| 変更なし | 変更がない場合は変更履歴コメントが追加されない | モック `issues.addComment()` が 1 回のみ（フェーズ移行コメントのみ） |
| エラーハンドリング | ファイル読み込み失敗時に適切な警告ログ | ログ出力確認 |

### 7.5 移行計画

#### Phase 1: 実装

1. `github-integration.ts` に `detectChanges`, `buildChangelogComment` をインポート
2. `spec.phase_changed` ハンドラーに既存 Issue 取得ロジック追加
3. `detectChanges()` で変更検出
4. `issues.update()` の `body` パラメータを必ず設定
5. 変更履歴コメント追加ロジック実装
6. デバッグログ追加

#### Phase 2: テスト

1. 単体テスト追加（`github-integration.test.ts`）
2. `npm run typecheck` で型チェック
3. `npm run lint` で ESLint チェック
4. `npm test` で全テスト実行

#### Phase 3: 検証

1. `npm run sync:dogfood` でビルド同期
2. 手動テスト実施（実際にフェーズ変更して GitHub Issue 確認）
3. Issue 本文が更新されることを確認
4. 変更履歴コメント（📝 仕様書更新）が追加されることを確認

---

## 8. 実装タスクリスト

### Phase 1: 実装

- [x] `detectChanges`, `buildChangelogComment` をインポート追加
- [x] `spec.phase_changed` ハンドラーで既存 Issue 内容を取得
- [x] `detectChanges()` で変更検出を実装
- [x] `issues.update()` に `body` パラメータを必ず含める
- [x] 変更履歴コメント（📝 仕様書更新）追加ロジック実装
- [x] デバッグログを追加

### Phase 2: テスト

- [x] 単体テストを追加（`github-integration.test.ts`）
- [x] `npm run typecheck` で型チェック
- [x] `npm run lint` で ESLint チェック
- [x] `npm test` で全テスト実行

### Phase 3: 検証

- [x] `npm run sync:dogfood` でビルド同期
- [ ] 手動テスト実施（実際にフェーズ変更して GitHub Issue 確認）
- [ ] Issue 本文が更新されることを確認
- [ ] 変更履歴コメント（📝 仕様書更新）が追加されることを確認
