# /cft:spec-create でブランチを作成する際、カレントブランチから作成される

**仕様書 ID:** 79695221-d46e-48a5-8ef6-1b30a5c38b3c
**フェーズ:** requirements
**作成日時:** 2025/11/24 16:08:36
**更新日時:** 2025/11/24 16:08:36

---

## 1. 背景と目的

### 背景

ユーザーから「/cft:spec-create でブランチを作成する際、カレントブランチから作成される」という問題報告がありました。

**コードベース解析の結果:**

実装コード（`src/core/git/branch-creation.ts:129-131`）を調査した結果、以下が判明:

```typescript
execFileSync('git', ['branch', branchName, defaultBaseBranch], { stdio: 'pipe' });
```

- ブランチ作成時に `defaultBaseBranch`（BASE_BRANCH 環境変数またはデフォルトの 'develop'）をベースに指定
- Git コマンドの引数順序も正確（`git branch <新ブランチ> <開始点>`）
- ユニットテストと E2E テストで動作を検証済み

**問題の可能性:**

1. **BASE_BRANCH 環境変数が未設定**: `.env` ファイルに BASE_BRANCH が定義されていない場合、デフォルトの 'develop' が使用される
2. **ユーザーの認識違い**: カレントブランチと develop を混同している可能性
3. **古いバージョンでの問題**: 過去のバージョンでは問題があったが、最新版では修正済み
4. **実装の説明不足**: ブランチ作成時に BASE_BRANCH から派生することが明示されていない

### 目的

ブランチ作成処理の動作を明確化し、ユーザーが意図しないブランチから派生することを防止します。具体的には:

1. ブランチ作成時に BASE_BRANCH から派生することをログで明示
2. BASE_BRANCH 環境変数の設定状況を検証
3. ドキュメント（README.md、QUICK_START.md）でブランチ作成の動作を明記
4. 万が一、カレントブランチから派生するケースがあれば修正

---

## 2. 対象ユーザー

- **cc-craft-kit を使用する開発者**: `/cft:spec-create` コマンドでブランチを作成するユーザー
- **開発キット保守担当者**: ブランチ作成処理の正確性を保証する必要がある開発者
- **新規ユーザー**: ブランチ作成の動作を理解する必要があるユーザー

---

## 3. 受け入れ基準

### 必須要件

- [ ] ブランチ作成時に BASE_BRANCH から派生することを確認するログを追加（`src/core/git/branch-creation.ts`）
- [ ] BASE_BRANCH 環境変数の設定状況を検証し、未設定時に警告を表示
- [ ] 実装コードの動作を再検証し、カレントブランチから派生するケースがないことを確認
- [ ] ユニットテストと E2E テストで BASE_BRANCH からの派生を検証

### 機能要件

- [ ] `/cft:spec-create` 実行時に「Creating branch from BASE_BRANCH (develop)」というログを表示
- [ ] BASE_BRANCH 環境変数が未設定の場合、警告メッセージを表示（デフォルト: develop）
- [ ] ブランチ作成後、どのブランチから派生したかを確認できる情報を表示
- [ ] ドキュメント（README.md、QUICK_START.md）でブランチ作成の動作を明記

### 非機能要件

- [ ] 既存のブランチ作成処理に影響を与えない（後方互換性）
- [ ] ログレベルを適切に設定（`info` レベル）
- [ ] テストカバレッジが維持される（追加されたコードがテストでカバーされる）
- [ ] ユーザーがブランチ作成の動作を理解しやすいドキュメントを提供

---

## 4. 制約条件

- **Git コマンドの制約**: `git branch <新ブランチ> <開始点>` の引数順序は変更できない
- **環境変数のデフォルト値**: BASE_BRANCH が未設定の場合、デフォルトの 'develop' が使用される
- **後方互換性**: 既存のブランチ作成処理（保護ブランチチェック、feature/spec- プレフィックス）を維持する必要がある
- **ログ出力の制約**: ログが多すぎるとユーザーが混乱するため、必要最小限にする
- **テストカバレッジ**: ブランチ作成処理はテストで検証されており、新しいログ追加も検証する必要がある

---

## 5. 依存関係

### 修正対象ファイル

1. **`src/core/git/branch-creation.ts`** (199行)
   - `createSpecBranch()` 関数にログ追加
   - BASE_BRANCH から派生することを明示するメッセージ
   - 129-131行: ブランチ作成処理の直前にログ追加

2. **`src/core/config/github-config.ts`** (62行)
   - `getGitHubConfig()` 関数で BASE_BRANCH の設定状況を検証
   - 未設定時に警告を表示（オプション）

3. **`src/commands/spec/create.ts`** (301行)
   - ブランチ作成後にどのブランチから派生したかを表示
   - 145-149行: ブランチ作成結果の表示を改善

4. **ドキュメントの更新**
   - `README.md` - ブランチ作成の動作を明記
   - `docs/QUICK_START.md` - BASE_BRANCH 環境変数の説明を追加

5. **テストファイルの更新**
   - `tests/core/git/branch-creation.test.ts` - ログ出力の検証を追加
   - `tests/e2e/branch-creation.test.ts` - E2E テストでログを確認

### 関連コンポーネント

- **Git ブランチ操作**: `src/core/git/branch-cache.ts` (カレントブランチの取得)
- **GitHub 統合**: `src/core/workflow/github-integration.ts` (PR 作成時の BASE_BRANCH 使用)
- **環境変数**: `.env.example` (BASE_BRANCH の定義)
- **ブランチ命名規則**: `src/core/git/branch-naming.ts` (ブランチ名の生成)

---

## 6. 参考情報

### 実装パターン

- **Git コマンドの引数順序**: `git branch <新ブランチ> <開始点>` が正しい順序
- **環境変数のデフォルト値**: `process.env.BASE_BRANCH?.trim() || 'develop'` でデフォルト値を設定
- **ログ出力**: `console.log()` ではなく、ロガー（`src/core/logger/`）を使用することを推奨
- **テストの検証**: ブランチ作成処理はモック化して、`execFileSync` の呼び出しを検証

### コードベース解析結果

Explore サブエージェントで調査した結果、以下が判明しました:

1. **実装は正確**: `src/core/git/branch-creation.ts:129-131` で `defaultBaseBranch` から派生するコードが実装済み
2. **テストで検証済み**: ユニットテストと E2E テストで BASE_BRANCH からの派生を検証
3. **問題の可能性**: BASE_BRANCH 環境変数が未設定、ユーザーの認識違い、古いバージョンでの問題、実装の説明不足

詳細は、Explore サブエージェントの分析レポートを参照してください。

### Git コマンドの動作

| コマンド | 動作 | 開始点 |
|---|---|---|
| `git checkout -b <新ブランチ>` | **カレントブランチから派生** | カレントブランチ |
| `git branch <新ブランチ> <開始点>` | **指定された開始点から派生** | 指定された開始点 |

cc-craft-kit では後者（`git branch <新ブランチ> <開始点>`）を使用しており、BASE_BRANCH から派生します。

### 修正方針の選択肢

**A. ログ追加（推奨）**: ブランチ作成時に BASE_BRANCH から派生することを明示
**B. 環境変数検証**: BASE_BRANCH が未設定の場合に警告を表示
**C. ドキュメント改善**: README.md、QUICK_START.md でブランチ作成の動作を明記

本仕様では、A と C を組み合わせた修正を推奨します。

### 関連ドキュメント

- **CLAUDE.md**: プロジェクト規約（Git ワークフロー基本方針）
- **.env.example**: BASE_BRANCH 環境変数の定義
- **README.md**: プロジェクト概要とセットアップガイド
- **docs/QUICK_START.md**: クイックスタートガイド
