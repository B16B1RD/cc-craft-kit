# /cft:spec-pahse <id> completed の処理見直し

**仕様書 ID:** 394bf0cc-13ac-454a-ad52-d8dbeb753b31
**フェーズ:** requirements
**作成日時:** 2025/11/24 22:58:28
**更新日時:** 2025/11/24 22:58:28

---

## 1. 背景と目的

### 背景

現在、多くの部分がスクリプトで実現されていて、なかなか仕様通りに動作していない。プロンプト指示だと簡単にできることができていない。PR の作成は、プロンプト指示の方が上手くいく。カスタムスラッシュコマンド→スキル→サブエージェントの構成が上手く実現できていない。改めて、Claude Code のカスタムスラッシュコマンド、スキル、サブエージェントの各機能の仕様についてよく考えて、スクリプトを使わずに仕様を実現できるか再設計して欲しい。スクリプトは最終手段です。

### 目的

`/cft:spec-phase <id> completed` コマンドの PR 自動作成処理を、スクリプト実装からプロンプト指示ベースの実装に再設計し、Claude Code の「プロンプトファースト原則」に従った形に改善する。

---

## 2. 対象ユーザー

**cc-craft-kit を使用する開発者**

- 仕様駆動開発（SDD）で開発を行うソフトウェアエンジニア
- カスタムスラッシュコマンドを実装・メンテナンスする開発者
- プロンプトファースト原則に基づいた開発フローを理解したい開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-phase <id> completed` 実行時、PR が自動作成されること
- [ ] PR 作成処理はプロンプト指示ベース（`spec-phase.md` に記述）で実現されること
- [ ] スクリプト実装は最小限（データベース操作、イベント発火のみ）に留めること

### 機能要件

- [ ] Git 状態確認（未コミット変更検出）がプロンプト指示で実現されること
- [ ] ブランチプッシュ（リモートにない場合）が Bash ツール経由で実行されること
- [ ] PR タイトル・本文が仕様書内容から自動生成されること
- [ ] PR 作成が GitHub CLI（`gh pr create`）経由で実行されること
- [ ] PR URL が仕様書ファイルに記録されること
- [ ] PR 番号がデータベース（`github_sync` テーブル）に記録されること
- [ ] エラー発生時、適切なエラーメッセージが表示されること

### 非機能要件

- [ ] プロンプト指示が可視化され、メンテナンスしやすいこと
- [ ] イベントハンドラーに依存せず、プロンプト指示で制御可能であること
- [ ] GitHub CLI のインストールが前提条件として明示されていること
- [ ] 既存の成功しているパターン（`spec-create.md` のブランチ復帰処理）を参考にすること

---

## 4. 制約条件

### 技術的制約

1. **データベース操作の制約**
   - プロンプト指示から直接データベース操作は不可
   - Kysely による型安全なデータベース操作はスクリプト経由で実施
   - トランザクション管理が必要な処理はスクリプト実装が必須

2. **GitHub API 呼び出しの制約**
   - Octokit（GitHub SDK）を使用する場合はスクリプト実装が必須
   - GitHub CLI（`gh` コマンド）を使用する場合はプロンプト指示で実現可能
   - GitHub CLI のインストールが前提条件

3. **Claude Code ツールの制約**
   - カスタムスラッシュコマンド (.md): データベース操作・GitHub API 呼び出し不可
   - スキル: 実行可能なコードではなく、知識・手順の記述
   - サブエージェント (Task ツール): データベース操作・GitHub API 呼び出し不可

4. **イベント駆動処理の制約**
   - イベント発火（`eventBus.emit`）はスクリプト経由で実施
   - イベントハンドラー内でのツール起動（Task/Skill）は非推奨（プロンプト指示による制御が困難）

### プロジェクト固有の制約

1. **プロンプトファースト原則**
   - 「プロンプトで済ませられることはプロンプトで済ませる」（CLAUDE.md:109）
   - スクリプト実装は判断基準チェックリストで1つ以上該当する場合のみ

2. **既存の成功パターンの踏襲**
   - `spec-create.md` のブランチ復帰処理（Bash ツール経由）
   - `code-review.md` のサブエージェント起動パターン
   - `lint-check.md` のスキル起動 + 自動修正パターン

3. **後方互換性**
   - 既存の `github_sync` テーブルスキーマを維持
   - 既存のイベントハンドラー（`branch-management.ts`）の削除を伴う可能性
   - PR 作成後の Backlog 同期処理（存在する場合）との整合性

---

## 5. 依存関係

### 既存のコンポーネント

1. **`src/slash-commands/spec-phase.md`**
   - 現在の completed フェーズ移行処理の仕様
   - 再設計対象のファイル

2. **`src/commands/spec/phase.ts`**
   - フェーズ遷移スクリプト
   - データベース更新、イベント発火を担当
   - 再設計後も最小限の役割で維持

3. **`src/core/workflow/branch-management.ts`**
   - 現在の PR 自動作成処理（イベントハンドラー方式）
   - `handlePullRequestCreationOnCompleted()` 関数（114-230 行）
   - 再設計後は削除または大幅に簡素化

4. **`src/integrations/github/pull-request.ts`**
   - 現在の PR 作成処理（Octokit 使用）
   - `createPullRequest()` 関数
   - 再設計後は GitHub CLI に置き換え（削除可能）

5. **`.claude/skills/pr-creator/SKILL.md`**
   - PR 作成スキルの定義
   - 再設計後、プロンプト指示から起動する可能性

### 参考にする成功パターン

1. **`src/slash-commands/spec-create.md`**
   - フェーズ 0〜5 の明確なステップ定義（103-265 行）
   - ブランチ復帰処理（Bash ツール経由、223-265 行）

2. **`src/slash-commands/code-review.md`**
   - Glob ツールでファイルパターン解決
   - Task ツールでサブエージェント起動

3. **`src/slash-commands/lint-check.md`**
   - Skill ツールでスキル起動
   - Bash ツールで自動修正

### 外部依存

1. **GitHub CLI (`gh` コマンド)**
   - PR 作成（`gh pr create`）
   - PR 情報取得（`gh pr view`）
   - インストール必須

2. **Git コマンド**
   - ブランチプッシュ（`git push -u origin <branch-name>`）
   - Git 状態確認（`git status --porcelain`）

3. **データベース (`github_sync` テーブル)**
   - PR 番号の記録
   - スクリプト経由でアクセス

---

## 6. 参考情報

### コードベース解析結果

**Explore サブエージェントによる解析結果**（2025/11/24 実施）:

#### 現在の問題点

- completed フェーズ移行処理がイベントハンドラー方式に依存
- スクリプト層で実装された PR 作成処理（Octokit 使用）
- プロンプト指示が機能しない理由: イベントハンドラー経由で実行されるため、プロンプト指示による制御が困難
- pr-creator スキルが存在するが自動起動されない

#### 再設計の指針

**推奨する構成**: カスタムスラッシュコマンド → スクリプト（最小限） → プロンプト指示（PR 作成フロー）

**実装フロー**:
1. `spec-phase.md` でスクリプト実行（データベース更新、イベント発火）
2. completed フェーズ検出（スクリプト出力から `newPhase: completed` を検出）
3. プロンプト指示で PR 作成フロー開始:
   - Git 状態確認（`git status --porcelain`）
   - 仕様書ファイル読み込み（Read ツール）
   - PR タイトル・本文生成（仕様書から自動生成）
   - ブランチプッシュ（`git push -u origin <branch-name>`）
   - PR 作成（`gh pr create --title "..." --body "..." --base "..."`）
   - PR URL の記録（Edit ツールで仕様書ファイルに追記）
   - PR 番号のデータベース記録（スクリプト経由）

### 関連仕様書

- （今後、関連仕様書が作成された場合に追記）

### 外部リンク

- [Claude Code 公式ドキュメント](https://github.com/anthropics/claude-code)
- [GitHub CLI ドキュメント](https://cli.github.com/manual/)
- [cc-craft-kit ARCHITECTURE.md](../docs/ARCHITECTURE.md)
