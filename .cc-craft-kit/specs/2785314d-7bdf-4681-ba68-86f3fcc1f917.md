# /cft:spec-create 実行時、.env の BASE_BRANCH から feature/spec-xxx ブランチを作成していない

**仕様書 ID:** 2785314d-7bdf-4681-ba68-86f3fcc1f917
**フェーズ:** completed
**作成日時:** 2025/11/27 12:00:00
**更新日時:** 2025/11/27 15:38:00

---

## 1. 背景と目的

### 背景

現在の `/cft:spec-create` コマンドは、実行時のカレントブランチから feature/spec-xxx ブランチを作成している。しかし、`.env` ファイルで `BASE_BRANCH` が設定されている場合は、その設定値から分岐するべきである。

### 目的

`.env` の `BASE_BRANCH` 設定を尊重し、指定されたベースブランチから feature/spec-xxx ブランチを作成するように修正する。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [x] `.env` に `BASE_BRANCH` が設定されている場合、その値をベースブランチとして使用する
- [x] `BASE_BRANCH` が未設定の場合は、現在のブランチから分岐する（既存動作を維持）

### 機能要件

- [x] `.env` ファイルから `BASE_BRANCH` 環境変数を読み取る
- [x] `BASE_BRANCH` が設定されている場合、`git branch <new-branch> <BASE_BRANCH>` を実行
- [x] `BASE_BRANCH` が存在しないブランチを指す場合、適切なエラーメッセージを表示

### 非機能要件

- [x] 既存のテストが引き続きパスする
- [x] エラーメッセージは日本語で表示

---

## 4. 制約条件

- プロンプトファースト原則に従い、可能な限りプロンプト（.md）で実装する
- スクリプト変更が必要な場合は最小限に留める

---

## 5. 依存関係

- `/cft:spec-create` スラッシュコマンド定義（`src/slash-commands/spec-create.md`）
- `.env` ファイル設定

---

## 6. 参考情報

- `.env.example` の `BASE_BRANCH` 設定例
- 現在のブランチ作成ロジック（Step 4, Step 5）

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
┌─────────────────────────────────────────────────────────────┐
│                    /cft:spec-create                         │
├─────────────────────────────────────────────────────────────┤
│  Step 1-4: 入力検証・仕様書ID生成・保護ブランチ判定        │
├─────────────────────────────────────────────────────────────┤
│  Step 4.5 (新規): ベースブランチの決定                      │
│    └─ .env から BASE_BRANCH を読み込み                      │
│    └─ デフォルト値: develop                                 │
├─────────────────────────────────────────────────────────────┤
│  Step 5 (修正): ブランチ作成・切り替え                      │
│    └─ BASE_BRANCH から新ブランチを派生                      │
├─────────────────────────────────────────────────────────────┤
│  Step 6-10: 仕様書生成・DB登録・要件定義実行               │
└─────────────────────────────────────────────────────────────┘
```

#### 設計方針

- **プロンプトファースト原則**: スクリプト（.ts）修正不要、プロンプト（.md）のみで実装
- **既存パターン流用**: `spec-phase.md` の環境変数読み込みパターンを活用
- **後方互換性**: `BASE_BRANCH` 未設定時はデフォルト値 `develop` を使用

#### 処理フロー詳細

```
現在のブランチ (任意)
        │
        ▼
┌─────────────────────────────────────┐
│ Step 4.5: ベースブランチの決定      │
│   grep '^BASE_BRANCH=' .env         │
│   BASE_BRANCH=${BASE_BRANCH:-develop}│
└─────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────┐
│ Step 5: ブランチ作成                │
│   git branch "$BRANCH_NAME" "$BASE_BRANCH" │
│   git checkout "$BRANCH_NAME"        │
└─────────────────────────────────────┘
        │
        ▼
feature/spec-xxx ブランチ (BASE_BRANCH から派生)
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/slash-commands/spec-create.md` | Step 4.5 追加、Step 5 修正 |
| `tests/slash-commands/spec-create.test.ts` | BASE_BRANCH 参照テスト追加 |

#### 環境変数読み込みパターン

```bash
# .env からベースブランチを取得（デフォルト: develop）
BASE_BRANCH=$(grep '^BASE_BRANCH=' .env 2>/dev/null | cut -d'=' -f2 | tr -d '"' | xargs)
BASE_BRANCH=${BASE_BRANCH:-develop}

echo "ベースブランチ: $BASE_BRANCH"
```

#### ブランチ作成パターン

```bash
# BASE_BRANCH の存在確認
if ! git rev-parse --verify "$BASE_BRANCH" > /dev/null 2>&1; then
  echo "❌ ベースブランチ '$BASE_BRANCH' が見つかりません"
  echo "   .env の BASE_BRANCH 設定を確認してください"
  # 処理中断
fi

# BASE_BRANCH からブランチを派生
git branch "$BRANCH_NAME" "$BASE_BRANCH"

# ブランチに切り替え
git checkout "$BRANCH_NAME"
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| ベースブランチ取得 | なし（現在のブランチを使用） | `.env` から `BASE_BRANCH` 読み込み | Step 4.5（新規） |
| ブランチ作成 | `git branch "$BRANCH_NAME"` | `git branch "$BRANCH_NAME" "$BASE_BRANCH"` | Step 5 |
| デフォルト値 | なし | `develop` | Step 4.5 |
| エラーハンドリング | 既存ブランチ確認のみ | `BASE_BRANCH` 存在確認追加 | Step 5 |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| Step 4.5 存在確認 | `BASE_BRANCH` 読み込みロジックが存在するか | コンテンツ検索 |
| Step 5 修正確認 | ブランチ作成時に `BASE_BRANCH` を参照するか | コンテンツ検索 |
| デフォルト値 | `develop` がデフォルトとして設定されているか | コンテンツ検索 |
| エラーハンドリング | `BASE_BRANCH` 存在確認ロジックがあるか | コンテンツ検索 |

### 7.5 移行計画

#### Phase 1: プロンプト修正

1. `src/slash-commands/spec-create.md` に Step 4.5 を追加
2. `src/slash-commands/spec-create.md` の Step 5 を修正
3. エラーハンドリングセクションを更新

#### Phase 2: テスト追加

1. `tests/slash-commands/spec-create.test.ts` に BASE_BRANCH テストを追加
2. `npm test` で全テスト合格確認

#### Phase 3: 同期・検証

1. `npm run sync:dogfood` で `.cc-craft-kit/` へ同期
2. 手動確認（各ブランチから `/cft:spec-create` を実行）

---

## 8. 実装タスクリスト

### Phase 1: プロンプト修正

- [x] `src/slash-commands/spec-create.md` に Step 4.5（ベースブランチの決定）を追加
- [x] `src/slash-commands/spec-create.md` の Step 5 を修正（BASE_BRANCH から派生）
- [x] エラーハンドリングセクションに BASE_BRANCH 関連のエラーを追加

### Phase 2: テスト追加

- [x] `tests/slash-commands/spec-create.test.ts` に BASE_BRANCH 参照テストを追加
- [x] `npm test` で全テスト合格確認

### Phase 3: 同期・検証

- [x] `npm run sync:dogfood` で同期
- [ ] 手動確認: develop ブランチから `/cft:spec-create` を実行
- [ ] 手動確認: feature ブランチから `/cft:spec-create` を実行（develop から派生することを確認）
