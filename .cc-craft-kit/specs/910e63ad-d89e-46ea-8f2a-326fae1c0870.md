# /cft:spec-create 時のブランチ作成運用仕様の見直し

**仕様書 ID:** 910e63ad-d89e-46ea-8f2a-326fae1c0870
**フェーズ:** design
**作成日時:** 2025/11/22 15:30:42
**更新日時:** 2025/11/22 15:37:18

---

## 1. 背景と目的

### 背景

現在の `/cft:spec-create` コマンドは、実行時に新しいブランチを作成し、そのブランチに切り替えた状態で仕様書を作成します。しかし、以下の課題があります。

#### 現在の課題

1. **ブランチ切り替え忘れによるリスク**
   - ブランチ作成後、そのブランチで作業を続けることが前提となっている
   - 開発者がブランチを切り替え忘れると、意図しないブランチでコミットしてしまう可能性がある

2. **保護ブランチでの実行制限**
   - main や develop ブランチで実行した場合、保護ブランチに直接コミットするリスクがある
   - 現在は自動的に `feature/spec-` プレフィックス付きブランチを作成しているが、実行後も新しいブランチに留まる

3. **データベース整合性の懸念**
   - ブランチ作成に失敗した場合、仕様書ファイルとデータベースレコードが不整合になる可能性がある
   - ロールバック処理が不完全な場合、孤立したレコードやファイルが残る

#### 改善の方向性

- **ブランチ作成後、元のブランチに自動的に戻る**仕様に変更することで、意図しないブランチでの作業を防止
- どのブランチで `/cft:spec-create` を実行しても問題なく動作する柔軟性を確保
- データベースとファイルシステムの整合性を維持するため、エラー時のロールバック処理を強化

### 目的

- `/cft:spec-create` コマンドを任意のブランチで実行可能にし、ブランチ運用の柔軟性を向上させる
- 保護ブランチ (main/develop) での直接作業を防ぎ、誤操作によるリスクを低減する
- ブランチ作成後の挙動を明確化し、開発者の混乱を防ぐ
- データベース整合性を維持し、ブランチとデータベースレコードの一貫性を保証する

---

## 2. 対象ユーザー

- cc-craft-kit を使用するすべての開発者
- 特に、保護ブランチ (main/develop) からの仕様書作成を試みるユーザー
- ブランチ切り替えの手間を削減したい開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] main ブランチから `/cft:spec-create` を実行した場合、`feature/spec-<短縮ID>` ブランチが自動作成される
- [ ] develop ブランチから `/cft:spec-create` を実行した場合、`feature/spec-<短縮ID>` ブランチが自動作成される
- [ ] feature/* ブランチから `/cft:spec-create` を実行した場合、`spec/<短縮ID>` ブランチが自動作成される
- [ ] ブランチ作成後、元のブランチに自動的に戻る
- [ ] データベースレコードの `branch_name` に作成されたブランチ名が正しく記録される
- [ ] ブランチ作成に失敗した場合、仕様書ファイルとデータベースレコードが適切にロールバックされる

### 機能要件

- [ ] 保護ブランチのリストは環境変数 `PROTECTED_BRANCHES` でカスタマイズ可能
- [ ] カスタムブランチ名を指定した場合、`spec/<短縮ID>-<カスタム名>` または `feature/spec-<短縮ID>-<カスタム名>` が作成される
- [ ] ブランチ作成後、コンソールに「Created branch: <ブランチ名>, switched back to <元のブランチ>」のようなメッセージを表示する

### 非機能要件

- [ ] ブランチ作成処理は 5 秒以内に完了すること
- [ ] Git コマンド実行時のエラーハンドリングが適切に実装されていること
- [ ] 既存の単体テスト・E2E テストがすべて合格すること
- [ ] 新しい挙動に対応する単体テストが追加されていること

---

## 4. 制約条件

### 技術的制約

- Git リポジトリが初期化されている環境でのみ動作する
- 環境変数 `PROTECTED_BRANCHES` が設定されていない場合、デフォルトで `main,develop` が保護対象となる
- ブランチ名のサニタイゼーションにより、16 進数以外の文字は削除される

### 運用制約

- ブランチ作成時に同名のブランチが既に存在する場合、エラーとなる（上書きしない）
- 元のブランチに戻る際、未コミット変更がある場合でもブランチ切り替えを強制しない（Git のデフォルト挙動に従う）

---

## 5. 依存関係

### 関連仕様書

- (既存の関連仕様書があれば記載)

### 関連モジュール

- `src/core/git/branch-creation.ts` - ブランチ作成ロジック
- `src/core/git/branch-cache.ts` - ブランチキャッシュ機構
- `src/commands/spec/create.ts` - 仕様書作成コマンド
- `src/core/database/connection.ts` - データベース接続管理

### 環境変数

- `PROTECTED_BRANCHES` - 保護対象ブランチのカンマ区切りリスト（デフォルト: `main,develop`）

---

## 6. 参考情報

- [CLAUDE.md#ブランチ管理](CLAUDE.md#ブランチ管理) - 既存のブランチ管理仕様
- GitHub Flow + develop ブランチモデル - プロジェクトのブランチ戦略
- `src/core/git/branch-creation.ts` - 既存のブランチ作成実装
- `tests/core/git/branch-creation.test.ts` - 既存の単体テスト
