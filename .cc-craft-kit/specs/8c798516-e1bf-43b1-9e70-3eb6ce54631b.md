# 各フェーズ完了時に未コミットのものがあるときがある

**仕様書 ID:** 8c798516-e1bf-43b1-9e70-3eb6ce54631b
**フェーズ:** design
**作成日時:** 2025/11/23 19:10:36
**更新日時:** 2025/11/23 19:15:24

---

## 1. 背景と目的

### 背景

現在の cc-craft-kit では、フェーズ遷移時（例: `requirements` → `design`）に `git-integration.ts` の `handlePhaseChangeCommit()` が自動コミットを実行します。しかし、以下のケースで未コミットファイルが残る問題が確認されています:

1. **`git add .` による広範囲なステージング**: `.gitignore` チェックが不完全なため、意図しないファイルがステージングされる可能性
2. **非同期イベント処理のタイミング**: 複数イベントが短時間に発火した場合、コミット漏れが発生する可能性
3. **未追跡ファイルの扱い**: `checkGitStatus()` は未追跡ファイルも検出するが、コミット対象の判定が曖昧

この問題により、フェーズ遷移後に手動でコミットが必要になり、開発者の作業効率が低下しています。

### 目的

フェーズ遷移時に以下を実現することで、開発者の作業効率を向上させます:

1. **確実な自動コミット**: フェーズ遷移時に、仕様書ファイルとそれに関連する変更のみを確実にコミット
2. **意図しないファイルの除外**: `.gitignore` ルールに準拠し、自動生成ファイルやビルド成果物を除外
3. **未コミット警告**: 自動コミット後も未コミットファイルが残る場合、明確な警告メッセージを表示

---

## 2. 対象ユーザー

**プライマリユーザー**: cc-craft-kit を使用する開発者

- 仕様駆動開発（SDD）フローを採用しているプロジェクトのメンバー
- Claude Code を使用して、仕様書管理と Git 連携を自動化したいユーザー

**ユーザーストーリー**:
- 開発者として、フェーズ遷移時に未コミットファイルが残らないようにしたい
- 開発者として、自動コミット対象のファイルが明確に制御されていてほしい
- 開発者として、意図しないファイルが誤コミットされないようにしたい

---

## 3. 受け入れ基準

### 必須要件

- [ ] フェーズ遷移時、仕様書ファイル（`.cc-craft-kit/specs/<spec-id>.md`）の変更が確実に自動コミットされる
- [ ] `.gitignore` ルールに準拠し、除外対象ファイルが自動コミットされない
- [ ] 自動コミット後も未コミットファイルが残る場合、警告メッセージが表示される

### 機能要件

- [ ] `git add .` ではなく、対象ファイルを明示的に指定する実装に変更
- [ ] `.gitignore` チェックロジックの改善（`git check-ignore` を使用）
- [ ] 未コミットファイルの検出精度向上（未追跡ファイルとステージング済みファイルを区別）
- [ ] 自動コミット失敗時のエラーメッセージ改善（具体的なファイル名を表示）

### 非機能要件

- [ ] **エラー耐性**: 自動コミット失敗時もフェーズ遷移は継続する（現行仕様を維持）
- [ ] **パフォーマンス**: `git status` の実行回数を最小化（フェーズ遷移前後に各1回のみ）
- [ ] **後方互換性**: 既存のイベントハンドラー登録フローを維持

---

## 4. 制約条件

### 技術的制約

- **Git クライアント**: `spawnSync('git', ...)` で同期実行（非同期化は不可）
- **エラーハンドリング**: 自動コミット失敗時もフェーズ遷移は継続する必要がある（ロールバックしない）
- **イベント駆動**: `spec.phase_changed` イベントのハンドラーとして実装（既存アーキテクチャを維持）

### 設計制約

- **単一責任**: `git-integration.ts` にコミット処理を集約（他モジュールでの Git 操作は禁止）
- **DI パターン**: `getEventBusAsync()` でイベントバスを取得し、ハンドラー登録
- **型安全性**: TypeScript strict mode を維持（`any` 型は禁止）

### 運用制約

- **Git リポジトリ必須**: `isGitRepository()` が `false` の場合、自動コミットをスキップ
- **保護ブランチ**: `main`, `develop` ブランチでは直接コミット不可（既存のブランチ保護ルールを維持）

---

## 5. 依存関係

### 内部モジュール

- **`src/core/workflow/git-integration.ts`**: 修正対象の主要ファイル
  - `handlePhaseChangeCommit()` の改善
  - `checkGitStatus()` の精度向上
  - `gitCommit()` の引数検証強化
- **`src/core/workflow/event-bus.ts`**: イベントハンドラー登録フロー（変更なし）
- **`src/commands/spec/phase.ts`**: フェーズ遷移コマンド（変更なし）

### 外部依存

- **Git 2.0+**: `git check-ignore`, `git status --porcelain` コマンドを使用

### 関連仕様書

- なし（既存の仕様書に類似機能なし）

---

## 6. 参考情報

### 関連ファイル

- `src/core/workflow/git-integration.ts:268-323` - `handlePhaseChangeCommit()` 実装
- `src/core/workflow/git-integration.ts:43-106` - `checkGitStatus()` 実装
- `CLAUDE.md` - コーディング規約とセキュリティ基本原則

### 参考資料

- [Git Documentation - check-ignore](https://git-scm.com/docs/git-check-ignore)
- [Git Documentation - status --porcelain](https://git-scm.com/docs/git-status)

### 既存の問題点

1. **`git add .` の危険性**: `.gitignore` チェックが不完全なため、意図しないファイルがステージングされる
2. **非同期処理のタイミング**: `getEventBusAsync()` で登録待機するが、短時間に複数イベントが発火した場合のコミット漏れ
3. **エラーログの不足**: 自動コミット失敗時のエラーメッセージが不明瞭
