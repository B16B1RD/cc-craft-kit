---
id: "8c798516-e1bf-43b1-9e70-3eb6ce54631b"
name: "各フェーズ完了時に未コミットのものがあるときがある"
phase: "completed"
branch_name: "main"
github_issue_number: null
pr_url: null
created_at: "2025-11-23T10:10:36.957Z"
updated_at: "2025-11-23T19:35:29Z"
---

# 各フェーズ完了時に未コミットのものがあるときがある


## 1. 背景と目的

### 背景

現在の cc-craft-kit では、フェーズ遷移時（例: `requirements` → `design`）に
`git-integration.ts` の `handlePhaseChangeCommit()` が自動コミットを実行します。
しかし、以下のケースで未コミットファイルが残る問題が確認されています:

1. **`git add .` による広範囲なステージング**: `.gitignore` チェックが不完全なため、意図しないファイルがステージングされる可能性
2. **非同期イベント処理のタイミング**: 複数イベントが短時間に発火した場合、コミット漏れが発生する可能性
3. **未追跡ファイルの扱い**: `checkGitStatus()` は未追跡ファイルも検出するが、コミット対象の判定が曖昧

この問題により、フェーズ遷移後に手動でコミットが必要になり、開発者の作業効率が低下しています。

### 目的

フェーズ遷移時に以下を実現することで、開発者の作業効率を向上させます:

1. **確実な自動コミット**: フェーズ遷移時に、仕様書ファイルとそれに関連する変更のみを確実にコミット
2. **意図しないファイルの除外**: `.gitignore` ルールに準拠し、自動生成ファイルやビルド成果物を除外
3. **未コミット警告**: 自動コミット後も未コミットファイルが残る場合、明確な警告メッセージを表示
---

## 2. 対象ユーザー

**プライマリユーザー**: cc-craft-kit を使用する開発者

- 仕様駆動開発（SDD）フローを採用しているプロジェクトのメンバー
- Claude Code を使用して、仕様書管理と Git 連携を自動化したいユーザー

**ユーザーストーリー**:

- 開発者として、フェーズ遷移時に未コミットファイルが残らないようにしたい
- 開発者として、自動コミット対象のファイルが明確に制御されていてほしい
- 開発者として、意図しないファイルが誤コミットされないようにしたい
---

## 3. 受け入れ基準

### 必須要件

- [ ] フェーズ遷移時、仕様書ファイル（`.cc-craft-kit/specs/<spec-id>.md`）の変更が確実に自動コミットされる
- [ ] `.gitignore` ルールに準拠し、除外対象ファイルが自動コミットされない
- [ ] 自動コミット後も未コミットファイルが残る場合、警告メッセージが表示される

### 機能要件

- [ ] `git add .` ではなく、対象ファイルを明示的に指定する実装に変更
- [ ] `.gitignore` チェックロジックの改善（`git check-ignore` を使用）
- [ ] 未コミットファイルの検出精度向上（未追跡ファイルとステージング済みファイルを区別）
- [ ] 自動コミット失敗時のエラーメッセージ改善（具体的なファイル名を表示）

### 非機能要件

- [ ] **エラー耐性**: 自動コミット失敗時もフェーズ遷移は継続する（現行仕様を維持）
- [ ] **パフォーマンス**: `git status` の実行回数を最小化（フェーズ遷移前後に各1回のみ）
- [ ] **後方互換性**: 既存のイベントハンドラー登録フローを維持
---

## 4. 制約条件

### 技術的制約

- **Git クライアント**: `spawnSync('git', ...)` で同期実行（非同期化は不可）
- **エラーハンドリング**: 自動コミット失敗時もフェーズ遷移は継続する必要がある（ロールバックしない）
- **イベント駆動**: `spec.phase_changed` イベントのハンドラーとして実装（既存アーキテクチャを維持）

### 設計制約

- **単一責任**: `git-integration.ts` にコミット処理を集約（他モジュールでの Git 操作は禁止）
- **DI パターン**: `getEventBusAsync()` でイベントバスを取得し、ハンドラー登録
- **型安全性**: TypeScript strict mode を維持（`any` 型は禁止）

### 運用制約

- **Git リポジトリ必須**: `isGitRepository()` が `false` の場合、自動コミットをスキップ
- **保護ブランチ**: `main`, `develop` ブランチでは直接コミット不可（既存のブランチ保護ルールを維持）
---

## 5. 依存関係

### 内部モジュール

- **`src/core/workflow/git-integration.ts`**: 修正対象の主要ファイル
  - `handlePhaseChangeCommit()` の改善
  - `checkGitStatus()` の精度向上
  - `gitCommit()` の引数検証強化
- **`src/core/workflow/event-bus.ts`**: イベントハンドラー登録フロー（変更なし）
- **`src/commands/spec/phase.ts`**: フェーズ遷移コマンド（変更なし）

### 外部依存

- **Git 2.0+**: `git check-ignore`, `git status --porcelain` コマンドを使用

### 関連仕様書

- なし（既存の仕様書に類似機能なし）
---

## 6. 参考情報

### 関連ファイル

- `src/core/workflow/git-integration.ts:268-323` - `handlePhaseChangeCommit()` 実装
- `src/core/workflow/git-integration.ts:43-106` - `checkGitStatus()` 実装
- `CLAUDE.md` - コーディング規約とセキュリティ基本原則

### 参考資料

- [Git Documentation - check-ignore](https://git-scm.com/docs/git-check-ignore)
- [Git Documentation - status --porcelain](https://git-scm.com/docs/git-status)

### 既存の問題点

1. **`git add .` の危険性**: `.gitignore` チェックが不完全なため、意図しないファイルがステージングされる
2. **非同期処理のタイミング**: `getEventBusAsync()` で登録待機するが、短時間に複数イベントが発火した場合のコミット漏れ
3. **エラーログの不足**: 自動コミット失敗時のエラーメッセージが不明瞭
---

## 7. 設計詳細

### 7.1. アーキテクチャ設計

#### プロンプトファースト原則に基づく設計方針

CLAUDE.md の「スクリプトとプロンプトの使い分け指針」に従い、以下の方針で実装します:

1. **プロンプトベースで実現**: スラッシュコマンド `/cft:spec-phase` の改善
2. **最小限のスクリプト変更**: `getCommitTargets()` のみ修正
3. **既存機能の活用**: `checkGitStatus()`, `getIgnoredFiles()` は変更不要

#### 全体フロー

```text
[フェーズ遷移コマンド実行: /cft:spec-phase <spec-id> <phase>]
  ↓
[1. スクリプト実行: phase.ts]
  ├── spec.phase_changed イベント発火
  ├── handlePhaseChangeCommit() 実行（自動コミット）
  └── フェーズ遷移完了メッセージ表示
  ↓
[2. プロンプトベース処理（スラッシュコマンド）]
  ├── Bash ツールで git status 実行
  ├── 未コミットファイルがある場合
  │    ├── Read ツールで仕様書ファイルパス確認
  │    ├── 警告メッセージ表示（ファイルリスト付き）
  │    └── 手動コミット案内（git add <spec-file> && git commit）
  └── GitHub Issue 更新案内（/cft:spec-update）
```

#### 実装方針の詳細

##### 1. プロンプトベース実装（スラッシュコマンド: `src/slash-commands/spec-phase.md`）

**追加する処理**:

スラッシュコマンドのプロンプトに以下のセクションを追加:

- Git 状態確認: `git status --porcelain` を実行
- 未コミットファイルの検出: 出力が空でない場合、未コミットファイルが存在
- 警告メッセージ表示: ファイルリスト付きで警告を表示
- 次のステップ案内: GitHub Issue 更新、次のフェーズ移行

**メリット**:

- スクリプト変更が最小限（保守性向上）
- Claude Code の Read/Bash ツールを活用（柔軟性）
- ユーザーへのフィードバックが明確（UX 向上）

##### 2. 最小限のスクリプト変更（`src/core/workflow/git-integration.ts`）

**変更対象**: `getCommitTargets()` 関数のみ

**修正内容**:

```typescript
function getCommitTargets(specId: string): string[] {
  validateSpecId(specId);
  // 現状: ['.'] → 全変更をコミット対象（危険）
  // 改善後: 仕様書ファイルのみを対象
  return [`.cc-craft-kit/specs/${specId}.md`];
}
```

**変更しない関数**:

- `checkGitStatus()`: 既存実装で十分正確
- `getIgnoredFiles()`: 終了コード処理は既に適切
- `handlePhaseChangeCommit()`: イベントハンドラーは変更不要

**理由**: 既存の実装は既に堅牢で、追加のエラーハンドリングは不要

#### モジュール構成

```text
[スクリプト層]
src/core/workflow/git-integration.ts
  ├── getCommitTargets() ← 修正対象（1 行のみ）
  ├── checkGitStatus() ← 変更なし
  ├── getIgnoredFiles() ← 変更なし
  └── handlePhaseChangeCommit() ← 変更なし

[プロンプト層]
src/slash-commands/spec-phase.md
  └── フェーズ移行後の未コミットチェック ← 追加
```

#### イベント駆動アーキテクチャの維持

- `spec.phase_changed` イベントのハンドラーとして実装（変更なし）
- `registerGitIntegrationHandlers()` でハンドラー登録（変更なし）
- エラーが発生してもフェーズ遷移は継続（既存仕様を維持）
---

### 7.2. データモデル

**データベース変更なし**: 既存のスキーマで対応可能
---

### 7.3. API の仕様

**外部 API 呼び出しなし**: Git コマンドのみを使用
---

### 7.4. セキュリティ考慮事項

#### 既存のセキュリティ機構を活用

今回の変更は `getCommitTargets()` の 1 行修正のみであり、以下の既存セキュリティ機構はすべて維持されます:

- **シェルインジェクション対策**: `spawnSync()` による安全な Git コマンド実行（既存実装）
- **センシティブ情報の除外**: `getErrorHandler()` による自動サニタイゼーション（既存実装）
- **保護ブランチ確認**: `isProtectedBranch()` による `main`, `develop` ブランチの保護（既存実装）
- **Git リポジトリ確認**: `isGitRepository()` による非 Git 環境での誤動作防止（既存実装）

#### 新規追加のセキュリティ考慮

- **コミット対象ファイルの明示化**: `['.']` ではなく `.cc-craft-kit/specs/<spec-id>.md` を明示的に指定することで、意図しないファイルのコミットを防止
---

### 7.5. テスト戦略

#### 単体テスト

**テストファイル**: `tests/core/workflow/git-integration.test.ts`

**追加が必要なテストケース**:

1. **`getCommitTargets()` のテスト**
   - 正常系: 有効な spec-id → `.cc-craft-kit/specs/<spec-id>.md` を返す
   - 異常系: 無効な spec-id → エラーをスロー

**既存テストケース（変更不要）**:

- `checkGitStatus()`: 既存の 6 ケース（正常系 4 + 異常系 2）
- `hasUncommittedChanges()`: 既存の 6 ケース（正常系 3 + 異常系 3）

#### モック化方法

既存のモック化パターンを踏襲:

```typescript
jest.mock('node:child_process');
const mockSpawnSync = spawnSync as jest.MockedFunction<typeof spawnSync>;

beforeEach(() => {
  jest.clearAllMocks();
});

it('should return spec file path', () => {
  const result = getCommitTargets('8c798516-e1bf-43b1-9e70-3eb6ce54631b');
  expect(result).toEqual(['.cc-craft-kit/specs/8c798516-e1bf-43b1-9e70-3eb6ce54631b.md']);
});

it('should throw error for invalid spec-id', () => {
  expect(() => getCommitTargets('invalid-id')).toThrow();
});
```

#### E2E テスト（プロンプトベース）

**テストシナリオ**:

1. フェーズ遷移コマンド実行
2. 自動コミット成功確認
3. プロンプトによる未コミットチェック実行
4. 警告メッセージ表示確認（該当する場合）

**注意**:

- E2E テストでは Git 操作を完全にモック化
- プロンプトベースの処理は手動テスト推奨（Claude Code の Read/Bash ツール依存）
---

## 8. 実装タスクリスト

### 8.1. スクリプト変更(最小限)

- [ ] `src/core/workflow/git-integration.ts` の `getCommitTargets()` を修正
  - 現状: `return ['.']`
  - 改善後: `return [".cc-craft-kit/specs/${specId}.md"]`

### 8.2. テスト追加

- [ ] `tests/core/workflow/git-integration.test.ts` に `getCommitTargets()` のテストケースを追加
  - 正常系: 有効な spec-id → `.cc-craft-kit/specs/<spec-id>.md` を返す
  - 異常系: 無効な spec-id → エラーをスロー

### 8.3. プロンプトベース実装

- [ ] `src/slash-commands/spec-phase.md` にフェーズ移行後の未コミットチェック処理を追加
  - Bash ツールで `git status --porcelain` 実行
  - 未コミットファイルがある場合、警告メッセージ表示(ファイルリスト付き)
  - 手動コミット案内(`git add <spec-file> && git commit`)
  - GitHub Issue 更新案内(`/cft:spec-update`)

### 8.4. 品質保証

- [ ] 全テストを実行して既存機能が壊れていないことを確認(`npm test`)
- [ ] TypeScript 型チェック(`npx tsc --noEmit`)と ESLint(`npm run lint`)を実行
