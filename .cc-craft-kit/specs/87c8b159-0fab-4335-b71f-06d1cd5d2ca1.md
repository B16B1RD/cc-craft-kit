# /cft:spec-delete で仕様書に関連する GitHub Issue 自動クローズされない

**仕様書 ID:** 87c8b159-0fab-4335-b71f-06d1cd5d2ca1
**フェーズ:** completed
**作成日時:** 2025/11/23 15:56:53
**更新日時:** 2025/11/23 16:32:25

---

## 1. 背景と目的

### 背景

現在、`/cft:spec-delete` コマンドで仕様書を削除した際、以下の問題が発生しています:

1. **GitHub Issue が自動クローズされない**
   - データベースと仕様書ファイルは削除されるが、関連する GitHub Issue は開いたまま残る
   - ユーザーが手動で Issue をクローズする必要があり、運用負荷が高い

2. **GitHub Projects のステータスが Done にならない**
   - 仕様書削除時に GitHub Projects ボードのステータスが自動更新されない
   - プロジェクト管理の一貫性が失われる

### 目的

`/cft:spec-delete` コマンド実行時に、以下を自動化することで開発者の運用負荷を削減し、GitHub との統合を強化する:

1. 関連する GitHub Issue を自動的にクローズ
2. GitHub Projects のステータスを自動的に "Done" に更新
3. デフォルトで有効化し、オプションで無効化できるようにする

---

## 2. 対象ユーザー

- **cc-craft-kit を使用する開発者**
  - 仕様書を削除する際に、GitHub Issue も同時に整理したいユーザー
  - GitHub Projects でプロジェクト進捗を管理しているユーザー
  - 手動での Issue クローズ作業を削減したいユーザー

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-delete` コマンド実行時、関連する GitHub Issue がデフォルトで自動クローズされること
- [ ] GitHub Issue が存在しない場合（404エラー）でも、警告表示後に仕様書削除が正常に完了すること
- [ ] GitHub API エラー（401, 403, 500等）時、仕様書削除がスキップされ、エラーメッセージが表示されること
- [ ] 既存の `--yes` オプションとの互換性が維持されること

### 機能要件

- [ ] `deleteSpec()` 関数の `closeGitHubIssue` オプションのデフォルト値を `false` から `true` に変更
- [ ] 確認プロンプトに「GitHub Issue がクローズされる」旨の警告を表示（既存実装を活用）
- [ ] GitHub Issue クローズ処理を、データベース削除・ファイル削除の前に実行（ロールバック戦略）
- [ ] スラッシュコマンドのドキュメント (`spec-delete.md`) を更新し、デフォルト動作を明記
- [ ] 後方互換性のため、`--close-github-issue` オプションは引き続き動作すること

### 非機能要件

- [ ] GitHub API のレート制限に配慮したエラーハンドリング（既存実装を活用）
- [ ] GITHUB_TOKEN 未設定時の適切なエラーメッセージ表示
- [ ] TypeScript strict mode に準拠したコード品質
- [ ] 既存のテストケース（`delete.test.ts`）への影響がないこと

---

## 4. 制約条件

### 技術的制約

- **GitHub API レート制限**: 認証あり 5,000 requests/hour、認証なし 60 requests/hour
- **必要な権限**: `GITHUB_TOKEN` に `repo` スコープが必要（Issue の読み書き権限）
- **TypeScript strict mode**: `any` 型禁止、`unknown` または具体的な型定義を使用
- **データベース接続**: `getDatabase()` を使用し、`config` パラメータは指定しない

### 環境依存の制約

- **GITHUB_TOKEN**: 環境変数 `.env` から読み込み。未設定時はエラーメッセージを表示
- **GitHub 設定**: `.cc-craft-kit/config.json` に `owner` と `repo` が設定されていること

### 後方互換性の制約

- 既存の `--close-github-issue` オプションは引き続き動作すること
- 既存の `--yes` オプションとの組み合わせも正常に動作すること

---

## 5. 依存関係

### 既存モジュール

- **`src/commands/spec/delete.ts`**: 仕様書削除のコアロジック（64行目のデフォルト値を変更）
- **`src/integrations/github/issues.ts`**: GitHub Issue クローズ API（`GitHubIssues.close()` メソッド）
- **`src/core/workflow/event-bus.ts`**: イベント駆動アーキテクチャ（`spec.deleted` イベント）
- **`src/core/database/schema.ts`**: データベーススキーマ（`specs` テーブル、`github_sync` テーブル）

### 外部ライブラリ

- **`@octokit/rest`** (v22.0.1): GitHub REST API クライアント
- **`kysely`**: TypeScript ORM（SQLite）
- **`eventemitter2`** (v6.4.9): イベントエミッター

### 設定ファイル

- **`.cc-craft-kit/config.json`**: GitHub 設定（owner, repo）
- **`.env`**: 環境変数（GITHUB_TOKEN）

### 関連仕様書

- 既存の仕様書削除機能（`/cft:spec-delete`）
- GitHub Issue 自動作成機能（`/cft:github-issue-create`）
- GitHub Projects 統合機能

---

## 6. 参考情報

### 実装ファイル

- **`src/commands/spec/delete.ts:64`**: デフォルト値変更箇所
  - 変更前: `const { color = true, skipConfirmation = false, closeGitHubIssue = false } = options;`
  - 変更後: `const { color = true, skipConfirmation = false, closeGitHubIssue = true } = options;`

- **`src/commands/spec/delete.ts:151-228`**: GitHub Issue クローズ処理（既存実装）

- **`src/core/workflow/github-integration.ts:384-414`**: completed フェーズでの Issue クローズパターン（参考実装）

### 関連ドキュメント

- **CLAUDE.md**: プロジェクト規約（TypeScript コーディング規約、データベース接続ルール）
- **src/slash-commands/spec-delete.md**: スラッシュコマンドのドキュメント（更新対象）

### GitHub API ドキュメント

- [GitHub REST API - Update an issue](https://docs.github.com/en/rest/issues/issues#update-an-issue)
- [Octokit REST API - issues.update()](https://octokit.github.io/rest.js/v22#issues-update)

---

## 7. 設計詳細

### 7.1. アーキテクチャ設計

#### 処理フロー

```
ユーザー入力: /cft:spec-delete <spec-id> [--yes]
        ↓
┌──────────────────────────────────────────┐
│ deleteSpec() 関数 (delete.ts:64)          │
│ - 引数パース                              │
│ - デフォルト値適用 (closeGitHubIssue=true)│
│ - バリデーション                          │
└──────────────────────────────────────────┘
        ↓
┌──────────────────────────────────────────┐
│ 確認プロンプト (delete.ts:113-142)       │
│ - 削除対象の情報表示                      │
│ - 「GitHub Issue がクローズされる」警告   │
│ - ユーザー確認 (y/N)                     │
└──────────────────────────────────────────┘
        ↓
┌──────────────────────────────────────────┐
│ GitHub Issue クローズ (delete.ts:151)    │
│ - GITHUB_TOKEN 確認                      │
│ - GitHub 設定確認（owner/repo）          │
│ - issues.close() API 呼び出し            │
│ - エラーハンドリング (404は警告のみ)     │
└──────────────────────────────────────────┘
        ↓ [成功]
┌──────────────────────────────────────────┐
│ DB削除 (delete.ts:230)                   │
│ - specs テーブルからレコード削除          │
└──────────────────────────────────────────┘
        ↓
┌──────────────────────────────────────────┐
│ ファイル削除 (delete.ts:233-237)        │
│ - .cc-craft-kit/specs/<id>.md 削除      │
└──────────────────────────────────────────┘
        ↓
┌──────────────────────────────────────────┐
│ イベント発火 (delete.ts:239-246)        │
│ - spec.deleted イベント発火              │
└──────────────────────────────────────────┘
```

#### ロールバック戦略

GitHub API エラー時のデータ整合性を保つため、以下の順序で処理を実行:

1. **GitHub Issue クローズ** (最初に実行)
   - 失敗時: データベースとファイルは削除されない（ロールバック不要）
   - 404エラー: 警告表示後、削除を続行

2. **データベース削除** (Issue クローズ成功後)
   - 失敤時: ファイル削除とイベント発火はスキップ

3. **ファイル削除** (データベース削除成功後)

4. **イベント発火** (すべて成功後)

#### 変更箇所

**ファイル**: `src/commands/spec/delete.ts`

**変更行**: 64行目

```typescript
// 変更前
const { color = true, skipConfirmation = false, closeGitHubIssue = false } = options;

// 変更後
const { color = true, skipConfirmation = false, closeGitHubIssue = true } = options;
```

**影響範囲**: デフォルト値のみ変更。既存のロジックは変更なし。

### 7.2. データモデル

#### 関連テーブル

**specs テーブル** (`src/core/database/schema.ts`):
```typescript
export interface SpecsTable {
  id: Generated<string>;           // UUID (仕様書ID)
  name: string;                    // 仕様書名
  description: string | null;
  phase: SpecPhase;                // フェーズ
  branch_name: string;
  created_at: ColumnType<Date>;
  updated_at: ColumnType<Date>;
}
```

**github_sync テーブル** (GitHub との同期情報):
```typescript
export interface GitHubSyncTable {
  id: Generated<string>;
  entity_type: GitHubEntityType;   // 'spec', 'task', 'issue', 'project', 'sub_issue'
  entity_id: string;               // spec.id
  github_id: string;               // GitHub Issue ID
  github_number: number | null;    // GitHub Issue 番号 ← クローズ対象
  github_node_id: string | null;
  last_synced_at: ColumnType<Date>;
  sync_status: 'success' | 'failed' | 'pending';
}
```

#### データ取得クエリ

```typescript
const githubSync = await db
  .selectFrom('github_sync')
  .selectAll()
  .where('entity_type', '=', 'spec')
  .where('entity_id', '=', spec.id)
  .executeTakeFirst();
```

### 7.3. API 仕様

#### GitHub Issue クローズ API

**使用クラス**: `GitHubIssues` (`src/integrations/github/issues.ts`)

```typescript
export class GitHubIssues {
  async close(owner: string, repo: string, issueNumber: number): Promise<IssueResponse> {
    return this.update({
      owner,
      repo,
      issueNumber,
      state: 'closed',  // 状態を 'closed' に設定
    });
  }
}
```

**内部実装**: GitHub REST API `PATCH /repos/{owner}/{repo}/issues/{issue_number}` を呼び出し

**リクエストパラメータ**:
- `owner`: リポジトリオーナー (`.cc-craft-kit/config.json` から取得)
- `repo`: リポジトリ名 (`.cc-craft-kit/config.json` から取得)
- `issueNumber`: Issue 番号 (`github_sync.github_number` から取得)
- `state`: "closed"

**レスポンス**: `IssueResponse` オブジェクト

**エラーコード**:
| コード | 状態 | 処理 |
|---|---|---|
| 200 | 成功 | 削除続行 |
| 404 | Issue が存在しない | 警告表示 + 削除続行 |
| 401 | 認証失敗 | エラースロー + 削除スキップ |
| 403 | レート制限超過 | エラースロー + 削除スキップ |
| 500 | GitHub API 障害 | エラースロー + 削除スキップ |

### 7.4. セキュリティ考慮事項

#### 認証情報の管理

- **GITHUB_TOKEN**: 環境変数 `.env` から読み込み
  - 未設定時: エラーメッセージ表示して削除スキップ
  - トークンは `process.env.GITHUB_TOKEN` で取得
  - トークンをログやエラーメッセージに出力しない

#### 権限管理

- **必要なスコープ**: `repo` (Issue の読み書き権限)
- **検証**: GitHub API 呼び出し時に自動的に権限チェック（401/403エラー）

#### データ整合性

- **ロールバック戦略**: GitHub API エラー時、データベースとファイルは削除されない
- **トランザクション**: データベース削除は単一トランザクション内で実行

### 7.5. テスト戦略

#### 単体テスト

**ファイル**: `tests/commands/spec/delete.test.ts`

**現在の状態**: `describe.skip()` でスキップ中（`import.meta` 問題）

**推奨テストケース**:

1. **基本的な削除機能**
   - デフォルト（オプションなし）で GitHub Issue がクローズされること
   - 確認プロンプトで "y" を入力した場合、削除が実行されること

2. **GitHub Issue クローズ機能**
   - GITHUB_TOKEN 未設定時、エラーメッセージが表示されること
   - GitHub Issue が存在しない場合（404）、警告表示後に削除続行すること
   - GitHub API エラー（401、403、500）時、削除処理がスキップされること

3. **後方互換性**
   - `--close-github-issue` 指定時も正常に動作すること
   - `--yes` オプションとの組み合わせが正常に動作すること

#### 統合テスト

- GitHub API のモック化（レート制限回避）
- データベースは `:memory:` モードでテスト
- Git 操作は必ずモック化（テスト実行時にブランチが変更されることを防止）

#### 手動テスト

1. **正常系**:
   ```bash
   /cft:spec-delete <spec-id>
   # → GitHub Issue がクローズされることを確認
   ```

2. **GitHub Issue が存在しない場合**:
   ```bash
   # GitHub Issue を手動削除後
   /cft:spec-delete <spec-id>
   # → 警告表示後、削除が完了することを確認
   ```

3. **GITHUB_TOKEN 未設定**:
   ```bash
   unset GITHUB_TOKEN
   /cft:spec-delete <spec-id>
   # → エラーメッセージが表示され、削除がスキップされることを確認
   ```

---

## 8. 実装タスクリスト

### 実装フェーズのタスク

#### 1. delete.ts:64のデフォルト値をcloseGitHubIssue=trueに変更

**優先度**: 高
**依存関係**: なし

**実装内容**:
- `src/commands/spec/delete.ts:64` の `closeGitHubIssue` のデフォルト値を `false` から `true` に変更

**変更箇所**:
```typescript
// 変更前
const { color = true, skipConfirmation = false, closeGitHubIssue = false } = options;

// 変更後
const { color = true, skipConfirmation = false, closeGitHubIssue = true } = options;
```

**受け入れ基準**:
- デフォルト値が `true` に変更されていること
- TypeScript の型チェックが通ること

---

#### 2. 確認プロンプトのメッセージを更新してGitHub Issueクローズの警告を追加

**優先度**: 高
**依存関係**: タスク1完了後

**実装内容**:
- `src/commands/spec/delete.ts:113-142` の確認プロンプトメッセージを更新
- 既存の警告メッセージに「GitHub Issue もクローズされます」旨を追記

**変更箇所**:
```typescript
const message = `以下の仕様書を削除しますか?

名前: ${spec.name}
フェーズ: ${spec.phase}
${githubSync ? `GitHub Issue: #${githubSync.github_number} (クローズされます)` : ''}

この操作は取り消せません。`;
```

**受け入れ基準**:
- GitHub Issue が存在する場合、確認プロンプトに「クローズされます」と表示されること
- 既存の `--yes` オプションでプロンプトがスキップされること

---

#### 3. spec-delete.mdドキュメントを更新してデフォルト動作を明記

**優先度**: 中
**依存関係**: タスク1、2完了後

**実装内容**:
- `src/slash-commands/spec-delete.md` を更新
- デフォルトで GitHub Issue がクローズされる旨を明記
- `--close-github-issue` オプションの説明を「デフォルトで有効」と修正

**変更箇所**:
- 「## 引数」セクションに追記
- 「## 実行内容」セクションに追記

**受け入れ基準**:
- ドキュメントにデフォルト動作が明記されていること
- 使用例が更新されていること

---

#### 4. 型チェックとESLint検証を実行

**優先度**: 高
**依存関係**: タスク1、2、3完了後

**実装内容**:
- `npx tsc --noEmit` で型エラーがないか確認
- `npm run lint` で ESLint 警告がないか確認
- エラーがあれば修正

**受け入れ基準**:
- 型エラーがゼロであること
- ESLint 警告がゼロであること

---

#### 5. 単体テストを生成・更新

**優先度**: 中
**依存関係**: タスク4完了後

**実装内容**:
- `test-generator` サブエージェントで単体テストを生成
- 既存の `delete.test.ts` を更新（現在 `describe.skip()` でスキップ中）
- 以下のテストケースを追加:
  - デフォルトで GitHub Issue がクローズされること
  - 404エラー時、警告表示後に削除続行すること
  - GitHub API エラー時、削除処理がスキップされること

**受け入れ基準**:
- テストカバレッジが 80% 以上であること
- GitHub API はモック化されていること

---

#### 6. コードレビューを実施

**優先度**: 中
**依存関係**: タスク5完了後

**実装内容**:
- `code-reviewer` サブエージェントでコード品質を検証
- セキュリティ、パフォーマンス、可読性をチェック
- 指摘事項があれば修正

**受け入れ基準**:
- コードレビューで重大な問題が検出されないこと
- CLAUDE.md のコーディング規約に準拠していること
