# /cft:spec-delete で仕様書に関連する GitHub Issue 自動クローズされない

**仕様書 ID:** 87c8b159-0fab-4335-b71f-06d1cd5d2ca1
**フェーズ:** design
**作成日時:** 2025/11/23 15:56:53
**更新日時:** 2025/11/23 16:00:52

---

## 1. 背景と目的

### 背景

現在、`/cft:spec-delete` コマンドで仕様書を削除した際、以下の問題が発生しています:

1. **GitHub Issue が自動クローズされない**
   - データベースと仕様書ファイルは削除されるが、関連する GitHub Issue は開いたまま残る
   - ユーザーが手動で Issue をクローズする必要があり、運用負荷が高い

2. **GitHub Projects のステータスが Done にならない**
   - 仕様書削除時に GitHub Projects ボードのステータスが自動更新されない
   - プロジェクト管理の一貫性が失われる

### 目的

`/cft:spec-delete` コマンド実行時に、以下を自動化することで開発者の運用負荷を削減し、GitHub との統合を強化する:

1. 関連する GitHub Issue を自動的にクローズ
2. GitHub Projects のステータスを自動的に "Done" に更新
3. デフォルトで有効化し、オプションで無効化できるようにする

---

## 2. 対象ユーザー

- **cc-craft-kit を使用する開発者**
  - 仕様書を削除する際に、GitHub Issue も同時に整理したいユーザー
  - GitHub Projects でプロジェクト進捗を管理しているユーザー
  - 手動での Issue クローズ作業を削減したいユーザー

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-delete` コマンド実行時、関連する GitHub Issue がデフォルトで自動クローズされること
- [ ] GitHub Issue が存在しない場合（404エラー）でも、警告表示後に仕様書削除が正常に完了すること
- [ ] GitHub API エラー（401, 403, 500等）時、仕様書削除がスキップされ、エラーメッセージが表示されること
- [ ] 既存の `--yes` オプションとの互換性が維持されること

### 機能要件

- [ ] `deleteSpec()` 関数の `closeGitHubIssue` オプションのデフォルト値を `false` から `true` に変更
- [ ] 確認プロンプトに「GitHub Issue がクローズされる」旨の警告を表示（既存実装を活用）
- [ ] GitHub Issue クローズ処理を、データベース削除・ファイル削除の前に実行（ロールバック戦略）
- [ ] スラッシュコマンドのドキュメント (`spec-delete.md`) を更新し、デフォルト動作を明記
- [ ] 後方互換性のため、`--close-github-issue` オプションは引き続き動作すること

### 非機能要件

- [ ] GitHub API のレート制限に配慮したエラーハンドリング（既存実装を活用）
- [ ] GITHUB_TOKEN 未設定時の適切なエラーメッセージ表示
- [ ] TypeScript strict mode に準拠したコード品質
- [ ] 既存のテストケース（`delete.test.ts`）への影響がないこと

---

## 4. 制約条件

### 技術的制約

- **GitHub API レート制限**: 認証あり 5,000 requests/hour、認証なし 60 requests/hour
- **必要な権限**: `GITHUB_TOKEN` に `repo` スコープが必要（Issue の読み書き権限）
- **TypeScript strict mode**: `any` 型禁止、`unknown` または具体的な型定義を使用
- **データベース接続**: `getDatabase()` を使用し、`config` パラメータは指定しない

### 環境依存の制約

- **GITHUB_TOKEN**: 環境変数 `.env` から読み込み。未設定時はエラーメッセージを表示
- **GitHub 設定**: `.cc-craft-kit/config.json` に `owner` と `repo` が設定されていること

### 後方互換性の制約

- 既存の `--close-github-issue` オプションは引き続き動作すること
- 既存の `--yes` オプションとの組み合わせも正常に動作すること

---

## 5. 依存関係

### 既存モジュール

- **`src/commands/spec/delete.ts`**: 仕様書削除のコアロジック（64行目のデフォルト値を変更）
- **`src/integrations/github/issues.ts`**: GitHub Issue クローズ API（`GitHubIssues.close()` メソッド）
- **`src/core/workflow/event-bus.ts`**: イベント駆動アーキテクチャ（`spec.deleted` イベント）
- **`src/core/database/schema.ts`**: データベーススキーマ（`specs` テーブル、`github_sync` テーブル）

### 外部ライブラリ

- **`@octokit/rest`** (v22.0.1): GitHub REST API クライアント
- **`kysely`**: TypeScript ORM（SQLite）
- **`eventemitter2`** (v6.4.9): イベントエミッター

### 設定ファイル

- **`.cc-craft-kit/config.json`**: GitHub 設定（owner, repo）
- **`.env`**: 環境変数（GITHUB_TOKEN）

### 関連仕様書

- 既存の仕様書削除機能（`/cft:spec-delete`）
- GitHub Issue 自動作成機能（`/cft:github-issue-create`）
- GitHub Projects 統合機能

---

## 6. 参考情報

### 実装ファイル

- **`src/commands/spec/delete.ts:64`**: デフォルト値変更箇所
  - 変更前: `const { color = true, skipConfirmation = false, closeGitHubIssue = false } = options;`
  - 変更後: `const { color = true, skipConfirmation = false, closeGitHubIssue = true } = options;`

- **`src/commands/spec/delete.ts:151-228`**: GitHub Issue クローズ処理（既存実装）

- **`src/core/workflow/github-integration.ts:384-414`**: completed フェーズでの Issue クローズパターン（参考実装）

### 関連ドキュメント

- **CLAUDE.md**: プロジェクト規約（TypeScript コーディング規約、データベース接続ルール）
- **src/slash-commands/spec-delete.md**: スラッシュコマンドのドキュメント（更新対象）

### GitHub API ドキュメント

- [GitHub REST API - Update an issue](https://docs.github.com/en/rest/issues/issues#update-an-issue)
- [Octokit REST API - issues.update()](https://octokit.github.io/rest.js/v22#issues-update)
