# GitHub Issue が作成されているにも関わらず未作成と誤認する

**仕様書 ID:** 8da79499-caee-4034-8e58-bc5fb9938843
**フェーズ:** requirements
**作成日時:** 2025/11/30 14:30:00
**更新日時:** 2025/11/30 14:30:00

---

## 1. 背景と目的

### 背景

cc-craft-kit では、仕様書作成時に `spec.created` イベントを発火し、GitHub Integration が自動的に GitHub Issue を作成する機能がある。しかし、GitHub Issue が実際に GitHub 上に作成されているにも関わらず、`/cft:status` コマンドや仕様書一覧で「Issue 未作成」と表示されるケースが報告されている。

原因として以下が考えられる:
1. **github_sync テーブルへの INSERT 失敗**: Issue API は成功したが、DB への記録が失敗
2. **UNIQUE 制約違反**: 重複 INSERT 試行時の例外がハンドリングされていない
3. **トランザクション境界の不整合**: Issue 作成と DB 更新が異なるトランザクションで実行される
4. **非トークン環境での警告スキップ**: `GITHUB_TOKEN` 未設定時の静かな return

### 目的

GitHub Issue の作成状態を正確に追跡し、Issue 作成済みにも関わらず「未作成」と誤認する問題を解消する。

---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者（GitHub 連携機能を利用するユーザー）

---

## 3. 受け入れ基準

### 必須要件

- [ ] GitHub Issue 作成成功時、必ず `github_sync` テーブルにレコードが記録される
- [ ] `/cft:status` コマンドで表示される Issue 状態が実際の GitHub 状態と一致する

### 機能要件

- [ ] Issue 作成と `github_sync` INSERT がアトミックに実行される（トランザクション整合性）
- [ ] UNIQUE 制約違反時に適切なエラーハンドリングが行われる
- [ ] Issue 作成成功・DB INSERT 失敗時のリカバリーロジックが実装される
- [ ] 既存の「Issue 未作成」仕様書に対する検証・修復機能が提供される

### 非機能要件

- [ ] Issue 作成処理のログが十分に出力される（デバッグ可能）
- [ ] パフォーマンスに影響を与えない（トランザクション範囲の最小化）

---

## 4. 制約条件

- SQLite (Kysely ORM) のトランザクション機能を使用
- GitHub API (Octokit) のレート制限を考慮
- 既存のイベント駆動アーキテクチャ（EventEmitter2）を維持
- 後方互換性を保持（既存の `github_sync` レコードを破壊しない）

---

## 5. 依存関係

- `src/integrations/github/sync.ts` - GitHub 同期メイン処理
- `src/integrations/github/issues.ts` - GitHub Issues API ラッパー
- `src/core/workflow/github-integration.ts` - イベントハンドラー
- `src/core/database/schema.ts` - `github_sync` テーブル定義
- `src/core/database/helpers.ts` - `getSpecWithGitHubInfo()` クエリ

---

## 6. 参考情報

- `src/integrations/github/ensure-issue.ts` - 既存の Issue 確認・リカバリー機能
- `src/core/sync/github-sync-checker.ts` - GitHub 同期状態チェッカー
- マイグレーション 007: `github_sync` テーブルの UNIQUE 制約追加
