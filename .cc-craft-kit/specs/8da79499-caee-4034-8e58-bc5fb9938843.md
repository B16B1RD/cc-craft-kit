# GitHub Issue が作成されているにも関わらず未作成と誤認する

**仕様書 ID:** 8da79499-caee-4034-8e58-bc5fb9938843
**フェーズ:** implementation
**作成日時:** 2025/11/30 14:30:00
**更新日時:** 2025/11/30 14:35:00

---

## 1. 背景と目的

### 背景

cc-craft-kit では、仕様書作成時に `spec.created` イベントを発火し、GitHub Integration が自動的に GitHub Issue を作成する機能がある。しかし、GitHub Issue が実際に GitHub 上に作成されているにも関わらず、`/cft:status` コマンドや仕様書一覧で「Issue 未作成」と表示されるケースが報告されている。

原因として以下が考えられる:
1. **github_sync テーブルへの INSERT 失敗**: Issue API は成功したが、DB への記録が失敗
2. **UNIQUE 制約違反**: 重複 INSERT 試行時の例外がハンドリングされていない
3. **トランザクション境界の不整合**: Issue 作成と DB 更新が異なるトランザクションで実行される
4. **非トークン環境での警告スキップ**: `GITHUB_TOKEN` 未設定時の静かな return

### 目的

GitHub Issue の作成状態を正確に追跡し、Issue 作成済みにも関わらず「未作成」と誤認する問題を解消する。

---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者（GitHub 連携機能を利用するユーザー）

---

## 3. 受け入れ基準

### 必須要件

- [ ] GitHub Issue 作成成功時、必ず `github_sync` テーブルにレコードが記録される
- [ ] `/cft:status` コマンドで表示される Issue 状態が実際の GitHub 状態と一致する

### 機能要件

- [ ] Issue 作成と `github_sync` INSERT がアトミックに実行される（トランザクション整合性）
- [ ] UNIQUE 制約違反時に適切なエラーハンドリングが行われる
- [ ] Issue 作成成功・DB INSERT 失敗時のリカバリーロジックが実装される
- [ ] 既存の「Issue 未作成」仕様書に対する検証・修復機能が提供される

### 非機能要件

- [ ] Issue 作成処理のログが十分に出力される（デバッグ可能）
- [ ] パフォーマンスに影響を与えない（トランザクション範囲の最小化）

---

## 4. 制約条件

- SQLite (Kysely ORM) のトランザクション機能を使用
- GitHub API (Octokit) のレート制限を考慮
- 既存のイベント駆動アーキテクチャ（EventEmitter2）を維持
- 後方互換性を保持（既存の `github_sync` レコードを破壊しない）

---

## 5. 依存関係

- `src/integrations/github/sync.ts` - GitHub 同期メイン処理
- `src/integrations/github/issues.ts` - GitHub Issues API ラッパー
- `src/core/workflow/github-integration.ts` - イベントハンドラー
- `src/core/database/schema.ts` - `github_sync` テーブル定義
- `src/core/database/helpers.ts` - `getSpecWithGitHubInfo()` クエリ

---

## 6. 参考情報

- `src/integrations/github/ensure-issue.ts` - 既存の Issue 確認・リカバリー機能
- `src/core/sync/github-sync-checker.ts` - GitHub 同期状態チェッカー
- マイグレーション 007: `github_sync` テーブルの UNIQUE 制約追加

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```text
┌─────────────────┐     spec.created     ┌─────────────────────────────┐
│ Slash Command   │ ──────────────────→ │ github-integration.ts       │
│ (spec-create)   │                      │ handleSpecCreated()         │
└─────────────────┘                      └──────────────┬──────────────┘
                                                        │
                                                        ▼
                                         ┌─────────────────────────────┐
                                         │ sync.ts                     │
                                         │ GitHubSyncService           │
                                         │ syncSpecToIssue()           │
                                         └──────────────┬──────────────┘
                                                        │
                    ┌───────────────────────────────────┼───────────────────────────────────┐
                    │                                   │                                   │
                    ▼                                   ▼                                   ▼
         ┌─────────────────────┐           ┌─────────────────────┐           ┌─────────────────────┐
         │ 1. 重複チェック      │           │ 2. Issue 作成       │           │ 3. DB 記録          │
         │ (github_sync SELECT)│           │ (GitHub API)        │           │ (github_sync INSERT)│
         └─────────────────────┘           └─────────────────────┘           └─────────────────────┘
                    │                                   │                                   │
                    │ ⚠️ 問題点:                        │ ✓ 成功                            │ ⚠️ 問題点:
                    │ sync_status='success'            │ Issue #XX 作成                    │ UNIQUE 制約違反時
                    │ のみをチェック                   │                                   │ エラーハンドリングなし
                    └───────────────────────────────────┴───────────────────────────────────┘
```

#### 設計方針

**問題の根本原因:**

1. **重複チェックの条件が不完全**: `sync_status = 'success'` のレコードのみをチェックしているため、`pending` や `failed` 状態のレコードが見落とされる
2. **INSERT エラーハンドリング不足**: UNIQUE 制約違反時に例外がスローされるが、catch されていない
3. **API と DB の非同期特性**: GitHub API 成功後に DB INSERT が失敗すると、Issue は存在するが DB に記録されない状態になる

**修正アプローチ:**

- **UNIQUE 制約を信頼**: レコード存在 = 処理済みと見なす
- **INSERT 失敗時は UPDATE で対応**: UNIQUE 違反時のフォールバック
- **重複チェック条件をシンプル化**: `sync_status` 条件を削除

#### 処理フロー詳細（修正後）

```text
syncSpecToIssue() 呼び出し
       │
       ▼
┌─────────────────────────────────────────────────────┐
│ 1. 重複チェック（修正後）                            │
│    SELECT * FROM github_sync                        │
│    WHERE entity_type='spec' AND entity_id=?        │
│    ※ sync_status 条件を削除                         │
└─────────────────────────────────────────────────────┘
       │
       ├─── レコード存在 → エラー「既に Issue が作成されています」
       │
       ▼ レコードなし
┌─────────────────────────────────────────────────────┐
│ 2. GitHub Issue 作成                                │
│    await this.issues.create(...)                    │
└─────────────────────────────────────────────────────┘
       │
       ▼ Issue #XX 作成成功
┌─────────────────────────────────────────────────────┐
│ 3. DB 記録（修正後: try-catch 追加）                 │
│    try {                                            │
│      INSERT INTO github_sync ...                    │
│    } catch (UNIQUE 制約違反) {                      │
│      UPDATE github_sync SET ... WHERE ...           │
│    }                                                │
└─────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────┐
│ 4. specs テーブル更新                               │
│    UPDATE specs SET updated_at = NOW()              │
└─────────────────────────────────────────────────────┘
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/integrations/github/sync.ts` | 重複チェック条件の修正、INSERT エラーハンドリング追加 |
| `tests/integrations/github/duplicate-issue-prevention.test.ts` | テストケース修正（sync_status='failed' 再利用テスト削除） |

#### 修正詳細

**修正 1: 重複チェック条件の修正 (`sync.ts` L59-72)**

```typescript
// 修正前
const existingSync = await this.db
  .selectFrom('github_sync')
  .where('entity_type', '=', 'spec')
  .where('entity_id', '=', params.specId)
  .where('sync_status', '=', 'success')  // ← この条件を削除
  .selectAll()
  .executeTakeFirst();

// 修正後
const existingSync = await this.db
  .selectFrom('github_sync')
  .where('entity_type', '=', 'spec')
  .where('entity_id', '=', params.specId)
  .selectAll()
  .executeTakeFirst();
```

**修正 2: INSERT エラーハンドリング追加 (`sync.ts` recordSyncLog())**

```typescript
// 修正前
} else {
  await this.db
    .insertInto('github_sync')
    .values({
      id: randomUUID(),
      ...syncData,
    })
    .execute();
}

// 修正後
} else {
  try {
    await this.db
      .insertInto('github_sync')
      .values({
        id: randomUUID(),
        ...syncData,
      })
      .execute();
  } catch (error) {
    // UNIQUE 制約違反 → UPDATE で対応
    if (error instanceof Error && error.message.includes('UNIQUE constraint failed')) {
      await this.db
        .updateTable('github_sync')
        .set(syncData)
        .where('entity_type', '=', syncData.entity_type)
        .where('entity_id', '=', syncData.entity_id)
        .execute();
    } else {
      throw error;
    }
  }
}
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| 重複チェック | `sync_status='success'` のみ確認 | レコード存在で判定 | `sync.ts` L59-72 |
| INSERT エラー | 例外スロー（未処理） | UNIQUE 違反時は UPDATE | `sync.ts` recordSyncLog() |
| 状態表示 | `github_sync` レコードの存在で判定 | 変更なし（正常動作化） | `helpers.ts` |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| 重複チェック | `sync_status` に関わらずレコード存在で重複検出 | `duplicate-issue-prevention.test.ts` 修正 |
| INSERT エラー | UNIQUE 制約違反時に UPDATE で上書き | 新規テストケース追加 |
| リカバリー | 既存の「Issue 未作成」仕様書の修復 | 手動テスト |

### 7.5 移行計画

#### Phase 1: コア修正

1. `sync.ts` の重複チェック条件を修正
2. `sync.ts` の `recordSyncLog()` に INSERT エラーハンドリング追加

#### Phase 2: テスト修正

1. `duplicate-issue-prevention.test.ts` の `sync_status='failed'` 再利用テストケースを修正
2. 新規テストケース追加（UNIQUE 制約違反時の UPDATE フォールバック）

#### Phase 3: 検証

1. 全テスト通過確認
2. 手動テスト（Issue 作成 → DB 確認 → 再実行でエラー確認）

---

## 8. 実装タスクリスト

### Phase 1: コア修正

- [ ] `sync.ts` の重複チェック条件から `sync_status='success'` を削除
- [ ] `sync.ts` の `recordSyncLog()` に UNIQUE 制約違反時のエラーハンドリングを追加

### Phase 2: テスト修正

- [ ] `duplicate-issue-prevention.test.ts` の `sync_status='failed'` 再利用テストケースを修正
- [ ] UNIQUE 制約違反時の UPDATE フォールバックテストを追加

### Phase 3: 検証

- [ ] `npm test` で全テスト通過を確認
- [ ] `npm run typecheck` で型エラーなしを確認
