# develop ブランチの CI テスト失敗を修正

**仕様書 ID:** 5a9e63cd-943d-400f-892e-24168cf5a74c
**フェーズ:** implementation
**作成日時:** 2025/11/21 21:55:32
**更新日時:** 2025/11/21 22:05:24

---

## 1. 背景と目的

### 背景

develop ブランチで CI テストが失敗しており、プルリクエストのマージがブロックされています。

**失敗しているテスト:**

1. **tests/core/git/branch-cache.test.ts** (9 件のテスト)
   - Git コマンドのモック化が不完全
   - 実際の Git ブランチ（例: `spec/37131bb4`）を読み取ってしまう
   - テストが期待するモックされたブランチ名（例: `feature/test-branch`）と一致しない

   **エラー例:**

   ```text
   Expected: "feature/test-branch"
   Received: "spec/37131bb4"
   ```

2. **tests/e2e/branch-and-pr-workflow.test.ts**
   - `TypeError: SQLite3 can only bind numbers, strings, bigints, buffers, and null`
   - `updateSpecPhase` 関数が不正な型の値を SQLite にバインドしようとしている
   - JavaScript のオブジェクトや配列を直接バインドしている可能性

   **エラー例:**

   ```text
   updateSpecPhase error: TypeError: SQLite3 can only bind numbers, strings, bigints, buffers, and null
   at SqliteConnection.executeQuery
   ```

### 目的

CI テストを修正し、develop ブランチからのプルリクエストが正常にマージできるようにする。

---

## 2. 対象ユーザー

- **cc-craft-kit 開発者** - プルリクエストを作成する開発者
- **プロジェクトメンテナー** - CI の健全性を維持する管理者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `tests/core/git/branch-cache.test.ts` の 9 件のテストがすべて通過する
- [ ] `tests/e2e/branch-and-pr-workflow.test.ts` の SQLite バインディングエラーが解消される
- [ ] CI の全テストスイートが通過する

### 機能要件

#### 問題 1: branch-cache.test.ts の Git モック問題

- [ ] `execSync` のモックを正しく実装し、実際の Git コマンドが実行されないようにする
- [ ] テストケースごとにモックの戻り値を適切に設定する
- [ ] テスト実行前にブランチキャッシュをクリアする

#### 問題 2: branch-and-pr-workflow.test.ts の SQLite バインディングエラー

- [ ] `updateSpecPhase` 関数を調査し、SQLite にバインドする値の型を確認する
- [ ] オブジェクトや配列を直接バインドしている箇所を特定し、適切な型に変換する
- [ ] 必要に応じて JSON.stringify() を使用して文字列化する

### 非機能要件

- [ ] 既存のテストロジックを変更せず、モックの実装のみを修正する
- [ ] テストの実行時間に影響を与えない
- [ ] 他のテストに副作用を与えない

---

## 4. 制約条件

- Jest のモック機能を使用すること
- 実際の Git コマンドを実行しないこと
- SQLite のバインディング制約に従うこと（numbers, strings, bigints, buffers, null のみ）

---

## 5. 依存関係

**影響を受けるファイル:**

- `tests/core/git/branch-cache.test.ts` - Git モックの修正
- `tests/e2e/branch-and-pr-workflow.test.ts` - SQLite バインディングエラーの修正
- `src/core/git/branch-cache.ts` - テスト対象（変更不要）

**関連する CI ワークフロー:**

- `.github/workflows/ci.yml` - CI テストの実行

---

## 6. 参考情報

**関連 PR:**

- PR #257 - 整合性チェックのブランチフィルタリング実装（この問題により CI が失敗）

**CI 実行ログ:**

- <https://github.com/B16B1RD/cc-craft-kit/actions/runs/19570693671>

**エラーログの抜粋:**

```text
FAIL tests/core/git/branch-cache.test.ts
  ● branch-cache › getCurrentBranch › should return current branch name from git command
    expect(received).toBe(expected)
    Expected: "feature/test-branch"
    Received: "spec/37131bb4"

FAIL tests/e2e/branch-and-pr-workflow.test.ts
  updateSpecPhase error: TypeError: SQLite3 can only bind numbers, strings, bigints, buffers, and null
```

---

## 8. 実装タスクリスト

### 問題 1: branch-cache.test.ts の Git モック修正

- [ ] **タスク 1**: `tests/core/git/branch-cache.test.ts` のテストを読み込んで問題を分析する
  - 現在のモック実装を確認
  - 実際の Git コマンドが実行されている箇所を特定
  - 期待される動作を理解

- [ ] **タスク 2**: `branch-cache.test.ts` で `execSync` のモックを正しく実装する
  - `child_process.execSync` を Jest でモック化
  - テストケースごとに適切な戻り値を設定
  - 実際の Git コマンドが実行されないことを確認

- [ ] **タスク 3**: `branch-cache.test.ts` でブランチキャッシュをクリアするロジックを追加する
  - 各テストケースの前に `clearBranchCache()` を呼び出す
  - キャッシュが原因でテストが失敗しないようにする

- [ ] **タスク 4**: `branch-cache.test.ts` の 9 件のテストが通過することを確認する
  - `npm test tests/core/git/branch-cache.test.ts` を実行
  - すべてのテストが通過することを確認

### 問題 2: branch-and-pr-workflow.test.ts の SQLite バインディングエラー修正

- [ ] **タスク 5**: `tests/e2e/branch-and-pr-workflow.test.ts` のテストを読み込んで SQLite バインディングエラーを分析する
  - エラーが発生している箇所を特定
  - `updateSpecPhase` 関数の呼び出し箇所を確認
  - どの値が不正な型でバインドされているかを特定

- [ ] **タスク 6**: `updateSpecPhase` 関数でオブジェクトや配列を直接バインドしている箇所を特定して修正する
  - 不正な型の値を文字列化（`JSON.stringify()`）または適切な型に変換
  - SQLite のバインディング制約（numbers, strings, bigints, buffers, null のみ）に従う
  - 必要に応じて関数のシグネチャを修正

- [ ] **タスク 7**: `branch-and-pr-workflow.test.ts` の SQLite バインディングエラーが解消されることを確認する
  - `npm test tests/e2e/branch-and-pr-workflow.test.ts` を実行
  - SQLite バインディングエラーが出ないことを確認

### 統合テスト

- [ ] **タスク 8**: CI の全テストスイートを実行して通過することを確認する
  - `npm test` を実行
  - すべてのテストが通過することを確認
  - CI で失敗していたテストが修正されていることを確認
