# develop ブランチの CI テスト失敗を修正

**仕様書 ID:** 5a9e63cd-943d-400f-892e-24168cf5a74c
**フェーズ:** design
**作成日時:** 2025/11/21 21:55:32
**更新日時:** 2025/11/21 21:56:59

---

## 1. 背景と目的

### 背景

develop ブランチで CI テストが失敗しており、プルリクエストのマージがブロックされています。

**失敗しているテスト:**

1. **tests/core/git/branch-cache.test.ts** (9 件のテスト)
   - Git コマンドのモック化が不完全
   - 実際の Git ブランチ（例: `spec/37131bb4`）を読み取ってしまう
   - テストが期待するモックされたブランチ名（例: `feature/test-branch`）と一致しない

   **エラー例:**

   ```text
   Expected: "feature/test-branch"
   Received: "spec/37131bb4"
   ```

2. **tests/e2e/branch-and-pr-workflow.test.ts**
   - `TypeError: SQLite3 can only bind numbers, strings, bigints, buffers, and null`
   - `updateSpecPhase` 関数が不正な型の値を SQLite にバインドしようとしている
   - JavaScript のオブジェクトや配列を直接バインドしている可能性

   **エラー例:**

   ```text
   updateSpecPhase error: TypeError: SQLite3 can only bind numbers, strings, bigints, buffers, and null
   at SqliteConnection.executeQuery
   ```

### 目的

CI テストを修正し、develop ブランチからのプルリクエストが正常にマージできるようにする。

---

## 2. 対象ユーザー

- **cc-craft-kit 開発者** - プルリクエストを作成する開発者
- **プロジェクトメンテナー** - CI の健全性を維持する管理者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `tests/core/git/branch-cache.test.ts` の 9 件のテストがすべて通過する
- [ ] `tests/e2e/branch-and-pr-workflow.test.ts` の SQLite バインディングエラーが解消される
- [ ] CI の全テストスイートが通過する

### 機能要件

#### 問題 1: branch-cache.test.ts の Git モック問題

- [ ] `execSync` のモックを正しく実装し、実際の Git コマンドが実行されないようにする
- [ ] テストケースごとにモックの戻り値を適切に設定する
- [ ] テスト実行前にブランチキャッシュをクリアする

#### 問題 2: branch-and-pr-workflow.test.ts の SQLite バインディングエラー

- [ ] `updateSpecPhase` 関数を調査し、SQLite にバインドする値の型を確認する
- [ ] オブジェクトや配列を直接バインドしている箇所を特定し、適切な型に変換する
- [ ] 必要に応じて JSON.stringify() を使用して文字列化する

### 非機能要件

- [ ] 既存のテストロジックを変更せず、モックの実装のみを修正する
- [ ] テストの実行時間に影響を与えない
- [ ] 他のテストに副作用を与えない

---

## 4. 制約条件

- Jest のモック機能を使用すること
- 実際の Git コマンドを実行しないこと
- SQLite のバインディング制約に従うこと（numbers, strings, bigints, buffers, null のみ）

---

## 5. 依存関係

**影響を受けるファイル:**

- `tests/core/git/branch-cache.test.ts` - Git モックの修正
- `tests/e2e/branch-and-pr-workflow.test.ts` - SQLite バインディングエラーの修正
- `src/core/git/branch-cache.ts` - テスト対象（変更不要）

**関連する CI ワークフロー:**

- `.github/workflows/ci.yml` - CI テストの実行

---

## 6. 参考情報

**関連 PR:**

- PR #257 - 整合性チェックのブランチフィルタリング実装（この問題により CI が失敗）

**CI 実行ログ:**

- <https://github.com/B16B1RD/cc-craft-kit/actions/runs/19570693671>

**エラーログの抜粋:**

```text
FAIL tests/core/git/branch-cache.test.ts
  ● branch-cache › getCurrentBranch › should return current branch name from git command
    expect(received).toBe(expected)
    Expected: "feature/test-branch"
    Received: "spec/37131bb4"

FAIL tests/e2e/branch-and-pr-workflow.test.ts
  updateSpecPhase error: TypeError: SQLite3 can only bind numbers, strings, bigints, buffers, and null
```
