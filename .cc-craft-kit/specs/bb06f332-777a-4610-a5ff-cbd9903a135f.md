# サブエージェントとスキルの導入

**仕様書 ID:** bb06f332-777a-4610-a5ff-cbd9903a135f
**フェーズ:** completed
**作成日時:** 2025/11/17 14:39:28
**更新日時:** 2025/11/17 16:51:50

---

## 1. 背景と目的

### 背景

開発キットのワークフロー内でのコードレビューやリファクタリングなどサブエージェントで実行できるタスクがあると思われる。また、そのサブエージェントの実装にあたっては、スキルと組み合わせると良さそうである（サブエージェントからスキルを利用する形）。サブエージェントとスキルについて調査し、導入したい。

### 目的

Takumi 開発キットにサブエージェントとスキルシステムを導入し、開発ワークフロー内での特定タスク（コードレビュー、リファクタリング、テスト生成など）を専門化されたエージェントに委譲できるようにする。これにより、メイン会話のコンテキストを肥大化させずに、複雑なタスクを効率的に処理できる。

---

## 2. 対象ユーザー

- **Takumi 利用者**: 開発ワークフロー内で専門的なタスクを実行したい開発者
- **Takumi 拡張開発者**: カスタムサブエージェントやスキルを作成してワークフローを拡張したい開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] サブエージェント定義ファイル（`.claude/agents/`）の作成と読み込み機能
- [ ] スキル定義ファイル（`.claude/skills/`）の作成と読み込み機能
- [ ] サブエージェントからスキルを利用できる統合機能
- [ ] プロジェクトレベルとユーザーレベルの両方のサブエージェント/スキルをサポート

### 機能要件

- [ ] コードレビュー用サブエージェントの実装
  - コード品質チェック
  - セキュリティ脆弱性検出
  - ベストプラクティス提案
- [ ] リファクタリング用サブエージェントの実装
  - コードの構造改善提案
  - DRY 原則違反の検出
  - パフォーマンス最適化提案
- [ ] テスト生成用サブエージェントの実装
  - 単体テストの自動生成
  - カバレッジ分析
  - エッジケース検出
- [ ] スキルシステムの実装
  - TypeScript/ESLint スキル
  - Git 操作スキル
  - データベーススキーマ検証スキル
- [ ] サブエージェント管理コマンド
  - `/cft:agent-create <name> <description>` - 新規サブエージェント作成
  - `/cft:agent-list` - サブエージェント一覧表示
  - `/cft:skill-create <name> <description>` - 新規スキル作成
  - `/cft:skill-list` - スキル一覧表示

### 非機能要件

- [ ] サブエージェントは独立したコンテキストで動作し、メイン会話を汚染しない
- [ ] スキルは必要に応じて段階的に読み込まれる（プログレッシブディスクロージャ）
- [ ] サブエージェント定義ファイルは Git 管理可能（チーム共有）
- [ ] ドキュメント整備（サブエージェント/スキル作成ガイド）

---

## 4. 制約条件

- サブエージェントは他のサブエージェントを生成できない（無限ネスト防止）
- サブエージェントは毎回クリーンな状態で起動される（ステートレス）
- スキル名は小文字英数字とハイフンのみ（最大 64 文字）
- スキル説明は最大 1024 文字

---

## 5. 依存関係

- **Claude Code のサブエージェントシステム**: `.claude/agents/` ディレクトリ構造
- **Claude Code のスキルシステム**: `.claude/skills/` ディレクトリ構造
- **既存の Takumi コマンド基盤**: スラッシュコマンドとの統合

---

## 6. 参考情報

### Claude Code 公式ドキュメント

- [Subagents Documentation](https://code.claude.com/docs/en/sub-agents.md)
- [Skills Documentation](https://code.claude.com/docs/en/skills.md)
- [Plugins Documentation](https://code.claude.com/docs/en/plugins.md)

### 主要な技術要素

**サブエージェント:**
- Markdown ファイル（YAML frontmatter）で定義
- 専用のシステムプロンプト、ツールアクセス、モデル指定が可能
- 自動委譲または明示的呼び出しに対応

**スキル:**
- `SKILL.md` ファイル + オプションのサポートファイル
- Claude が自律的に使用タイミングを判断
- 複数スキルの組み合わせが可能

**プラグイン:**
- サブエージェントとスキルを 1 つのパッケージとして配布可能
- `.claude-plugin/plugin.json` で定義
- マーケットプレイス経由での共有に対応

---

## 8. 実装タスクリスト

### 基本機能（必須要件）

1. **サブエージェント定義ファイルの読み込み機能を実装**
   - `.claude/agents/` ディレクトリからサブエージェント定義を読み込む
   - YAML frontmatter パーサーを実装
   - プロジェクトレベルとユーザーレベルの両方をサポート
   - 工数: 3-4 時間

2. **スキル定義ファイルの読み込み機能を実装**
   - `.claude/skills/` ディレクトリからスキル定義を読み込む
   - `SKILL.md` ファイルのパース機能を実装
   - サポートファイルの読み込み機能を実装
   - 工数: 2-3 時間

3. **サブエージェントからスキルを利用できる統合機能を実装**
   - サブエージェントコンテキストにスキルを注入
   - スキル呼び出しインターフェースを実装
   - 工数: 3-4 時間

4. **プロジェクトレベルとユーザーレベルの両方のサブエージェント/スキルサポートを実装**
   - 優先順位: プロジェクトレベル > ユーザーレベル
   - 重複時の上書きロジック
   - 工数: 2-3 時間

### サンプルサブエージェント作成（機能要件）

5. **コードレビュー用サブエージェントを作成**
   - コード品質チェック機能
   - セキュリティ脆弱性検出機能
   - ベストプラクティス提案機能
   - 工数: 4-5 時間

6. **リファクタリング用サブエージェントを作成**
   - コード構造改善提案機能
   - DRY 原則違反検出機能
   - パフォーマンス最適化提案機能
   - 工数: 4-5 時間

7. **テスト生成用サブエージェントを作成**
   - 単体テスト自動生成機能
   - カバレッジ分析機能
   - エッジケース検出機能
   - 工数: 4-5 時間

### サンプルスキル作成（機能要件）

8. **TypeScript/ESLint スキルを作成**
   - TypeScript コンパイルエラー解析
   - ESLint ルール適用
   - 工数: 2-3 時間

9. **Git 操作スキルを作成**
   - Git コマンド実行ヘルパー
   - ブランチ管理、コミット履歴解析
   - 工数: 2-3 時間

10. **データベーススキーマ検証スキルを作成**
    - Kysely スキーマ検証
    - マイグレーションファイル解析
    - 工数: 2-3 時間

### 管理コマンド（機能要件）

11. **サブエージェント管理コマンド（agent-create, agent-list）を実装**
    - `/cft:agent-create <name> <description>` - 新規サブエージェント作成
    - `/cft:agent-list` - サブエージェント一覧表示
    - 工数: 3-4 時間

12. **スキル管理コマンド（skill-create, skill-list）を実装**
    - `/cft:skill-create <name> <description>` - 新規スキル作成
    - `/cft:skill-list` - スキル一覧表示
    - 工数: 3-4 時間

### ドキュメント整備（非機能要件）

13. **ドキュメント整備（サブエージェント/スキル作成ガイド）**
    - サブエージェント作成ガイド
    - スキル作成ガイド
    - ベストプラクティス集
    - 工数: 3-4 時間

### 見積もり総計

- **基本機能**: 10-14 時間
- **サンプルサブエージェント**: 12-15 時間
- **サンプルスキル**: 6-9 時間
- **管理コマンド**: 6-8 時間
- **ドキュメント**: 3-4 時間
- **合計**: 37-50 時間
