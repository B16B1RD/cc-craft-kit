# 仕様書の探索方法に問題あり

**仕様書 ID:** a8a4d1bd-8790-44c7-9af6-a16d67aa8cab
**フェーズ:** implementation
**作成日時:** 2025/12/01 18:38:00
**更新日時:** 2025/12/01 10:18:04

---

## 1. 背景と目的

### 背景

`/cft:spec-phase` コマンド実行時に、仕様書ファイルの探索方法に問題がある。具体的には以下のような状況が発生した:

1. `develop` ブランチから `/cft:spec-phase <id> design` を実行
2. `resolve-id.ts` が DB から仕様書情報を取得し、`spec.branch_name` と `spec.spec_path` を返却
3. Bash で `git checkout "$BRANCH_NAME"` を実行してブランチを切り替え
4. Read ツールで仕様書ファイル（`SPEC_PATH`）を読み込もうとする
5. **Claude が「ファイルが見つからない」と誤解し、「DB には登録されているので、まず仕様書ファイルを作成する必要がある」と判断**

実際には、仕様書ファイルは作業ブランチ（`feature/spec-xxx` など）に存在しており、ブランチ切り替え後は正常に読み込める。問題は、Claude がプロンプト層で Bash 実行結果（ブランチ切り替え）を認識せず、現在のブランチ状態を把握できていないことにある。

### 目的

Claude がプロンプト実行時にブランチ状態を正しく認識し、仕様書ファイルが存在するブランチに切り替わっていることを理解した上でファイル読み込みを行うようにする。これにより、「ファイルを作成する必要がある」という誤解を防止する。

---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者（Claude Code を通じて仕様駆動開発を行うユーザー）

---

## 3. 受け入れ基準

### 必須要件

- [ ] ブランチ切り替え後、Claude がブランチ状態を正しく認識すること
- [ ] 仕様書ファイルが存在するブランチで Read ツールを実行した際、ファイルが正常に読み込まれること

### 機能要件

- [ ] `/cft:spec-phase` コマンドで、ブランチ切り替え後に「ファイルが見つからない」という誤解が発生しないこと
- [ ] ブランチ切り替え成功時に、切り替え先ブランチ名が明示的に表示されること
- [ ] 仕様書ファイル読み込み前に、現在のブランチ状態を確認するステップが追加されること

### 非機能要件

- [ ] プロンプトファースト原則に従い、スクリプト層の変更を最小限に抑えること
- [ ] 既存の処理フローとの互換性を維持すること

---

## 4. 制約条件

- プロンプトファースト原則に従い、プロンプト層（.md ファイル）の変更で対応する
- 仕様書ファイルは作業ブランチ（feature/spec-xxx, fix/spec-xxx など）にのみ存在する
- ベースブランチ（develop）には仕様書ファイルが存在しない可能性がある
- Bash ツール実行後のブランチ状態は、同一メッセージ内の後続ツール実行に反映される

---

## 5. 依存関係

### 変更対象ファイル

- `.cc-craft-kit/slash-commands/spec-phase.md` - フェーズ移行コマンド（Step 3 ブランチ切り替え処理）

### 関連コンポーネント

- `src/commands/spec/resolve-id.ts` - 仕様書 ID 解決スクリプト
- `.cc-craft-kit/slash-commands/spec-create.md` - 仕様書作成コマンド（参考）

---

## 6. 参考情報

- `/cft:spec-phase` コマンドの処理フロー（spec-phase.md Step 3）
- 問題発生時のログ抜粋:
  ```
  ● 仕様書ファイルが見つからないようです。DBには登録されているので、まず仕様書ファイルを作成する必要があります。
    データベースから仕様書情報を取得してファイルを生成します。

  ● Bash(npx tsx .cc-craft-kit/commands/spec/get.ts "0b6eb481")
    ⎿  ブランチを切り替えて仕様書を表示しますか？
         1. はい - ブランチを切り替えて表示
         2. いいえ - 現在のブランチに留まる

  ● 仕様書ファイルは別のブランチ（feature/spec-0b6eb481-create-pr-as-draft）に存在するようです。まずブランチを切
    り替えます。
  ```

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
/cft:spec-phase 実行フロー
│
├─ Step 1: フェーズ名の正規化
├─ Step 2: 仕様書 ID の解決（resolve-id.ts）
├─ Step 3: ブランチ切り替え
│   ├─ 3.1: ベースブランチの取得
│   ├─ 3.2: ブランチ存在確認・自動作成
│   └─ 3.3: ★【新規】ブランチ切り替え成功確認
├─ Step 3.5: GitHub Issue 連携状態確認
├─ Step 4: バリデーション（Read ツール）← ここで誤解が発生していた
├─ Step 5: DB 更新
├─ Step 6: Markdown ファイル更新
├─ Step 7: 自動コミット
├─ Step 8: フェーズ固有の後処理
└─ Step 9: git status チェック
```

#### 設計方針

**問題の根本原因:**
Bash ツール実行後のブランチ状態変化が、後続の Step 4（Read ツール）で不透明になることにより、Claude が「ファイルが見つからない可能性がある」と誤解してしまう。

**解決アプローチ:**
Step 3.2 の後に「Step 3.3: ブランチ切り替え成功確認」を追加し、`git rev-parse --abbrev-ref HEAD` で現在のブランチを確認・出力する。これにより Claude が「ブランチが正しく切り替わった」ことを明示的に認識できる。

#### 処理フロー詳細

```
改善前:
Step 3.2: git checkout "$BRANCH_NAME" → 成功
Step 4: Read ツールで SPEC_PATH を読み込み → 「ファイルが見つからない」と誤解

改善後:
Step 3.2: git checkout "$BRANCH_NAME" → 成功
Step 3.3: git rev-parse --abbrev-ref HEAD で確認 → 「✓ ブランチを切り替えました: feature/spec-xxx」
Step 4: Read ツールで SPEC_PATH を読み込み → 正常に読み込み
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `.cc-craft-kit/slash-commands/spec-phase.md` | Step 3.2 の後に「Step 3.3: ブランチ切り替え成功確認」を追加 |
| `src/slash-commands/spec-phase.md` | 同期元ファイルも同様に修正 |

#### 追加する Step 3.3 の詳細

```markdown
### Step 3.3: ブランチ切り替え成功確認

Bash ツールで以下を実行:

```bash
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$CURRENT_BRANCH" = "$BRANCH_NAME" ]; then
  echo "✓ ブランチを切り替えました: $CURRENT_BRANCH"
  echo ""
  echo "以下の仕様書ファイルを読み込みます:"
  echo "  $SPEC_PATH"
else
  echo "❌ ブランチの切り替えに失敗しました"
  echo ""
  echo "期待するブランチ: $BRANCH_NAME"
  echo "実際のブランチ: $CURRENT_BRANCH"
  exit 1
fi
```

**エラー時メッセージ:**

```
❌ ブランチ切り替え後の状態確認に失敗しました

ブランチ: $BRANCH_NAME
現在のブランチ: $CURRENT_BRANCH

対処方法:
1. 手動でブランチを確認: git branch -v
2. 手動で切り替え: git checkout "$BRANCH_NAME"
3. 再実行: /cft:spec-phase $SPEC_ID $NEW_PHASE
```
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| ブランチ切り替え | Step 3.2 で `git checkout` のみ | Step 3.2 + Step 3.3 で確認ステップ追加 | spec-phase.md |
| ブランチ状態表示 | なし | 切り替え成功時に明示的に表示 | spec-phase.md Step 3.3 |
| エラーハンドリング | 切り替え失敗時のみ | 切り替え成功確認を追加 | spec-phase.md Step 3.3 |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| ブランチ切り替え成功 | Step 3.3 で正しいブランチ名が表示されること | 手動テスト: `/cft:spec-phase <id> design` を実行 |
| ファイル読み込み成功 | Step 4 でファイルが正常に読み込まれること | 手動テスト: 「ファイルが見つからない」エラーが発生しないこと |
| エラーケース | ブランチ切り替え失敗時にエラーメッセージが表示されること | 手動テスト: 存在しないブランチでテスト |

### 7.5 移行計画

#### Phase 1: プロンプト層の修正

1. `src/slash-commands/spec-phase.md` に Step 3.3 を追加
2. `npm run sync:dogfood` で `.cc-craft-kit/` に同期
3. 動作確認

---

## 8. 実装タスクリスト

### Phase 1: プロンプト層の修正

- [x] `src/slash-commands/spec-phase.md` に Step 3.3（ブランチ切り替え成功確認）を追加
- [x] `npm run sync:dogfood` で同期を実行
- [ ] 動作確認: `/cft:spec-phase <id> design` を実行して正常動作を確認
