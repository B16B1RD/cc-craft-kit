# 仕様書の探索方法に問題あり

**仕様書 ID:** a8a4d1bd-8790-44c7-9af6-a16d67aa8cab
**フェーズ:** requirements
**作成日時:** 2025/12/01 18:38:00
**更新日時:** 2025/12/01 18:38:00

---

## 1. 背景と目的

### 背景

`/cft:spec-phase` コマンド実行時に、仕様書ファイルの探索方法に問題がある。具体的には以下のような状況が発生した:

1. `develop` ブランチから `/cft:spec-phase <id> design` を実行
2. `resolve-id.ts` が DB から仕様書情報を取得し、`spec.branch_name` と `spec.spec_path` を返却
3. Bash で `git checkout "$BRANCH_NAME"` を実行してブランチを切り替え
4. Read ツールで仕様書ファイル（`SPEC_PATH`）を読み込もうとする
5. **Claude が「ファイルが見つからない」と誤解し、「DB には登録されているので、まず仕様書ファイルを作成する必要がある」と判断**

実際には、仕様書ファイルは作業ブランチ（`feature/spec-xxx` など）に存在しており、ブランチ切り替え後は正常に読み込める。問題は、Claude がプロンプト層で Bash 実行結果（ブランチ切り替え）を認識せず、現在のブランチ状態を把握できていないことにある。

### 目的

Claude がプロンプト実行時にブランチ状態を正しく認識し、仕様書ファイルが存在するブランチに切り替わっていることを理解した上でファイル読み込みを行うようにする。これにより、「ファイルを作成する必要がある」という誤解を防止する。

---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者（Claude Code を通じて仕様駆動開発を行うユーザー）

---

## 3. 受け入れ基準

### 必須要件

- [ ] ブランチ切り替え後、Claude がブランチ状態を正しく認識すること
- [ ] 仕様書ファイルが存在するブランチで Read ツールを実行した際、ファイルが正常に読み込まれること

### 機能要件

- [ ] `/cft:spec-phase` コマンドで、ブランチ切り替え後に「ファイルが見つからない」という誤解が発生しないこと
- [ ] ブランチ切り替え成功時に、切り替え先ブランチ名が明示的に表示されること
- [ ] 仕様書ファイル読み込み前に、現在のブランチ状態を確認するステップが追加されること

### 非機能要件

- [ ] プロンプトファースト原則に従い、スクリプト層の変更を最小限に抑えること
- [ ] 既存の処理フローとの互換性を維持すること

---

## 4. 制約条件

- プロンプトファースト原則に従い、プロンプト層（.md ファイル）の変更で対応する
- 仕様書ファイルは作業ブランチ（feature/spec-xxx, fix/spec-xxx など）にのみ存在する
- ベースブランチ（develop）には仕様書ファイルが存在しない可能性がある
- Bash ツール実行後のブランチ状態は、同一メッセージ内の後続ツール実行に反映される

---

## 5. 依存関係

### 変更対象ファイル

- `.cc-craft-kit/slash-commands/spec-phase.md` - フェーズ移行コマンド（Step 3 ブランチ切り替え処理）

### 関連コンポーネント

- `src/commands/spec/resolve-id.ts` - 仕様書 ID 解決スクリプト
- `.cc-craft-kit/slash-commands/spec-create.md` - 仕様書作成コマンド（参考）

---

## 6. 参考情報

- `/cft:spec-phase` コマンドの処理フロー（spec-phase.md Step 3）
- 問題発生時のログ抜粋:
  ```
  ● 仕様書ファイルが見つからないようです。DBには登録されているので、まず仕様書ファイルを作成する必要があります。
    データベースから仕様書情報を取得してファイルを生成します。

  ● Bash(npx tsx .cc-craft-kit/commands/spec/get.ts "0b6eb481")
    ⎿  ブランチを切り替えて仕様書を表示しますか？
         1. はい - ブランチを切り替えて表示
         2. いいえ - 現在のブランチに留まる

  ● 仕様書ファイルは別のブランチ（feature/spec-0b6eb481-create-pr-as-draft）に存在するようです。まずブランチを切
    り替えます。
  ```
