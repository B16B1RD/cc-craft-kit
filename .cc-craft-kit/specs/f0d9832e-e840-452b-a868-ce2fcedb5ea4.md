# GitHub Projects の status 再見直し

**仕様書 ID:** f0d9832e-e840-452b-a868-ce2fcedb5ea4
**フェーズ:** implementation
**作成日時:** 2025/12/03 00:00:00
**更新日時:** 2025/12/03 17:30:00

---

## 1. 背景と目的

### 背景

現在の cc-craft-kit では、仕様書のフェーズと GitHub Projects のステータスマッピングが以下の仕様に則っていない：

- **Todo**: タスク未開始 → `/cft:spec-create` 時
- **In Progress**: タスク作業中 → design フェーズおよび implementation フェーズ
- **In Review**: PR 作成済み、レビュー待ち → completed フェーズ時
- **Done**: タスク完了 → `/cft:pr-cleanup` 時

現行実装では `implementation → "In Review"` となっており、実装中なのにレビュー待ちと表示される不整合がある。また、`/cft:spec-phase <id> completed` と `/cft:pr-cleanup` コマンドの役割分担が不明確で、ステータス更新のタイミングが曖昧になっている。

### 目的

GitHub Projects のステータス管理を見直し、フェーズとステータスの対応関係を明確化する。`/cft:spec-phase` と `/cft:pr-cleanup` コマンドの役割を整理し、ユーザーにとって直感的なワークフローを実現する。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] フェーズと GitHub Projects ステータスのマッピングが仕様通りに動作すること
- [ ] `/cft:spec-create` 実行時に GitHub Projects ステータスが「Todo」になること
- [ ] design/implementation フェーズで GitHub Projects ステータスが「In Progress」になること
- [ ] completed フェーズで GitHub Projects ステータスが「In Review」になること
- [ ] `/cft:pr-cleanup` 実行時に GitHub Projects ステータスが「Done」になること

### 機能要件

- [ ] `github-status-config.ts` のデフォルトマッピングを修正すること
- [ ] `/cft:spec-phase` と `/cft:pr-cleanup` の役割を明確に分離すること
- [ ] フェーズ遷移時のステータス更新ロジックを見直すこと
- [ ] 後方互換性を維持しながらマッピングを変更すること

### 非機能要件

- [ ] 既存の仕様書に影響を与えないこと（後方互換性）
- [ ] ドキュメント（README、ARCHITECTURE.md）を更新すること

---

## 4. 制約条件

- 既存の `config.json` によるカスタムマッピング機能は維持する
- `tasks` フェーズは非推奨だが後方互換性のためサポートを継続する
- GitHub Projects API のリトライ・検証ロジックは変更しない
- イベント駆動アーキテクチャ（EventBus）を維持する

---

## 5. 依存関係

### 関連ファイル

- `src/core/config/github-status-config.ts` - ステータスマッピング定義
- `src/integrations/github/phase-status-mapper.ts` - 動的マッパー実装
- `src/commands/spec/phase.ts` - `/cft:spec-phase` エントリポイント
- `src/commands/spec/update-phase.ts` - フェーズ更新ロジック
- `src/core/workflow/github-integration.ts` - GitHub 統合イベントハンドラー
- `src/integrations/github/projects.ts` - GitHub Projects API 実装
- `src/commands/github/pr-cleanup.ts` - PR マージ後処理

### 関連コンポーネント

- EventBus（`spec.phase_changed` イベント）
- DynamicStatusMapper（設定ベースのマッピング）
- GitHub Projects API

---

## 6. 参考情報

- 現行のステータスマッピング: `requirements → Todo`, `design → In Progress`, `implementation → In Review`, `completed → Done`
- 提案マッピング: `requirements → Todo`, `design → In Progress`, `implementation → In Progress`, `completed → In Review`, `pr-cleanup → Done`

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        フェーズ遷移とステータス更新フロー                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  /cft:spec-create ──→ requirements ──→ GitHub Projects: "Todo"          │
│          │                                                               │
│          ▼                                                               │
│  /cft:spec-phase ──→ design ──→ GitHub Projects: "In Progress"          │
│          │                                                               │
│          ▼                                                               │
│  /cft:spec-phase ──→ implementation ──→ GitHub Projects: "In Progress"  │
│          │                                                               │
│          ▼                                                               │
│  /cft:spec-phase ──→ completed ──→ GitHub Projects: "In Review"         │
│          │                 │                                             │
│          │                 └─→ PR 自動作成（pr-creator スキル）           │
│          │                                                               │
│          ▼                                                               │
│  /cft:pr-cleanup ──→ spec.pr_merged イベント ──→ GitHub Projects: "Done" │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 設計方針

1. **既存のイベント駆動アーキテクチャを維持**
   - `spec.phase_changed` イベントでフェーズ変更時のステータス更新
   - `spec.pr_merged` イベントで PR マージ後のステータス更新

2. **設定の優先度を維持**
   - config.json のカスタム設定 > デフォルト設定
   - 後方互換性のためレガシー3段階モデルもサポート

3. **最小限の変更で実現**
   - DEFAULT_STATUS_MAPPING の値変更のみ
   - 新規コード追加は `spec.pr_merged` ハンドラの拡張のみ

#### 処理フロー詳細

**フェーズ変更時（spec.phase_changed）:**
```
1. /cft:spec-phase コマンド実行
2. update-phase.ts で DB 更新
3. EventBus が spec.phase_changed イベント発火
4. github-integration.ts のハンドラが受信
5. DynamicStatusMapper でフェーズ → ステータス変換
6. projects.ts の updateProjectStatus() で GitHub 更新
7. verifyProjectStatusUpdate() で更新確認（リトライ付き）
```

**PR マージ後（spec.pr_merged）:**
```
1. /cft:pr-cleanup コマンド実行
2. pr-cleanup.ts で DB 更新（merged_at, merged_pr_url）
3. EventBus が spec.pr_merged イベント発火
4. github-integration.ts のハンドラが受信
5. ステータスを直接 "Done" に更新（マッピング不要）
6. projects.ts の updateProjectStatus() で GitHub 更新
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/core/config/github-status-config.ts` | DEFAULT_STATUS_MAPPING の `implementation` を `'In Review'` → `'In Progress'` に、`completed` を `'Done'` → `'In Review'` に変更 |
| `src/core/workflow/github-integration.ts` | `spec.pr_merged` イベントハンドラに GitHub Projects ステータス更新処理を追加 |
| `tests/core/config/github-status-config.test.ts` | マッピング変更に伴うテスト更新 |
| `tests/integrations/github/phase-status-mapper.test.ts` | マッピング変更に伴うテスト更新 |
| `docs/GITHUB_PROJECTS.md` | ステータスマッピング表の更新 |

#### コード変更詳細

**github-status-config.ts (64-70行目):**
```typescript
// Before
export const DEFAULT_STATUS_MAPPING: StatusMapping = {
  requirements: 'Todo',
  design: 'In Progress',
  tasks: 'In Progress',
  implementation: 'In Review',
  completed: 'Done',
};

// After
export const DEFAULT_STATUS_MAPPING: StatusMapping = {
  requirements: 'Todo',
  design: 'In Progress',
  tasks: 'In Progress',
  implementation: 'In Progress',  // 変更
  completed: 'In Review',          // 変更
};
```

**github-integration.ts（spec.pr_merged ハンドラ拡張）:**
```typescript
// 既存の spec.pr_merged ハンドラに追加
eventBus.on('spec.pr_merged', async (event) => {
  // ... 既存の処理 ...

  // GitHub Projects ステータスを 'Done' に更新
  const projectSync = await db
    .selectFrom('github_project_sync')
    .selectAll()
    .where('spec_id', '=', event.data.specId)
    .executeTakeFirst();

  if (projectSync?.github_id) {
    await projects.updateProjectStatus({
      owner: githubConfig.owner,
      projectNumber,
      itemId: projectSync.github_id,
      status: 'Done',
    });
  }
});
```

### 7.3 機能マッピング

| フェーズ/トリガー | 現在のステータス | 新しいステータス | 実装場所 |
|-----------------|----------------|-----------------|---------|
| requirements | Todo | Todo（変更なし） | DEFAULT_STATUS_MAPPING |
| design | In Progress | In Progress（変更なし） | DEFAULT_STATUS_MAPPING |
| tasks | In Progress | In Progress（変更なし） | DEFAULT_STATUS_MAPPING |
| implementation | In Review | **In Progress** | DEFAULT_STATUS_MAPPING |
| completed | Done | **In Review** | DEFAULT_STATUS_MAPPING |
| spec.pr_merged | N/A | **Done** | github-integration.ts |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| DEFAULT_STATUS_MAPPING | implementation が 'In Progress' を返す | github-status-config.test.ts |
| DEFAULT_STATUS_MAPPING | completed が 'In Review' を返す | github-status-config.test.ts |
| mapPhaseToStatus() | 全フェーズが正しいステータスを返す | phase-status-mapper.test.ts |
| spec.pr_merged ハンドラ | PR マージ後に 'Done' が設定される | github-integration.test.ts |

### 7.5 移行計画

#### Phase 1: ステータスマッピング更新

1. `github-status-config.ts` の DEFAULT_STATUS_MAPPING を修正
2. 関連するユニットテストを更新
3. npm run typecheck && npm run lint で検証

#### Phase 2: PR マージ後処理の実装

1. `github-integration.ts` の `spec.pr_merged` ハンドラを拡張
2. Projects ステータス更新ロジックを追加
3. 統合テストを追加

#### Phase 3: ドキュメント更新とリリース

1. `docs/GITHUB_PROJECTS.md` のマッピング表を更新
2. 変更履歴をまとめ、リリースノートを準備

---

## 8. 実装タスクリスト

### Phase 1: ステータスマッピング更新

- [x] DEFAULT_STATUS_MAPPING の implementation を 'In Progress' に変更 (#592)
- [x] DEFAULT_STATUS_MAPPING の completed を 'In Review' に変更 (#593)
- [x] github-status-config.test.ts のテスト期待値を更新 (#594)
- [x] phase-status-mapper.test.ts のテスト期待値を更新 (#595)

### Phase 2: PR マージ後処理の実装

- [x] github-integration.ts の spec.pr_merged ハンドラに Projects ステータス更新を追加 (#596)
- [ ] 統合テスト（github-integration.test.ts）に PR マージ後のステータス更新テストを追加 (#597)

### Phase 3: ドキュメント更新

- [ ] docs/GITHUB_PROJECTS.md のステータスマッピング表を更新 (#598)
