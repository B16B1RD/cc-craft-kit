# Git 管理対象のファイル編集作業は統合ブランチ以外で実施

**仕様書 ID:** 5de3f83b-76ef-4a5f-9489-e03c92d55027
**フェーズ:** tasks
**作成日時:** 2025/11/20 7:42:46
**更新日時:** 2025/11/20 7:54:14

---

## 1. 背景と目的

### 背景

main ブランチや develop ブランチなどの統合ブランチでは作業しない。必ず適切なブランチを作成して作業する。統合ブランチは .env などで指定させるとよい。指定がない場合は、main or master がデフォルトブランチとする。PR は必ず統合ブランチへのマージとすること。

### 目的

Git 管理対象のファイル編集作業において、統合ブランチ（main、develop など）での直接編集を防止し、適切なブランチ戦略を強制することで、以下を実現する。

- コードレビューの品質向上（PR による変更履歴の可視化）
- 統合ブランチの安定性維持
- チーム開発における競合リスクの低減
- ブランチ戦略の一貫性確保

---

## 2. 対象ユーザー

- cc-craft-kit を使用してファイル編集する開発者
- Edit ツール、Write ツールを使用するすべての Claude Code セッション

---

## 3. 受け入れ基準

### 必須要件

- [ ] `.env` ファイルで統合ブランチを指定可能（`PROTECTED_BRANCHES` 環境変数、カンマ区切りで複数指定: `main,develop`）
- [ ] `PROTECTED_BRANCHES` が未指定の場合、デフォルト値が適用される（以下の優先順位で決定）
  1. `git symbolic-ref refs/remotes/origin/HEAD` でリモートのデフォルトブランチを取得
  2. 取得失敗時は `main` を優先、`main` が存在しない場合は `master` を使用
- [ ] 統合ブランチでファイル編集を試みた場合、エラーメッセージを表示して編集を中断する
- [ ] 適切な作業ブランチの作成を促すガイダンスを提供する

### 機能要件

- [ ] 現在のブランチを検出する機能（`git rev-parse --abbrev-ref HEAD`）
- [ ] 統合ブランチのリストを `.env` から読み込む機能
- [ ] Edit ツール、Write ツール実行前のブランチチェック機能
- [ ] ブランチチェック失敗時の適切なエラーメッセージ表示
  - エラーメッセージ例:

    ```text
    エラー: 統合ブランチ 'main' での直接編集は禁止されている。

    適切な作業ブランチを作成すること:
      git checkout -b feature/<機能名>
      git checkout -b fix/<修正内容>

    統合ブランチ: main, develop
    ```

- [ ] 推奨作業ブランチ名の提案機能
  - エラーメッセージ内に、現在の仕様書のフェーズに基づいたブランチ名候補を表示
  - 例: 仕様書が `implementation` フェーズの場合、`feature/<spec-name>` を提案
- [ ] PR 作成時にベースブランチが統合ブランチであることを確認し、異なる場合は警告を表示する（強制ではなく推奨レベル）

### 非機能要件

- [ ] ブランチチェックの実行時間は 100ms 以内（`git rev-parse` コマンドの実行時間を計測、平均値で評価）
  - 理由: ファイル編集の UX を損なわないため、体感遅延を最小化
- [ ] Git コマンド実行失敗時の適切なフォールバック処理
- [ ] 既存のファイル編集ワークフローに影響を与えない実装
  - Edit ツール、Write ツールの実行前にブランチチェックを挿入
  - チェック失敗時のみエラーをスロー、成功時は既存の処理をそのまま実行
  - 既存のテストが全て通過することを確認
- [ ] ユーザーフレンドリーなエラーメッセージ（日本語対応）

---

## 4. 制約条件

- Git リポジトリが初期化されていること（`.git` ディレクトリが存在）
- Git コマンドが実行可能な環境であること
- Node.js の `child_process` モジュールが使用可能であること
- `.env` ファイルの読み込みに `dotenv` パッケージを使用
- 既存の Edit ツール、Write ツールの動作に影響を与えないこと
- Claude Code のフック機能との互換性を維持すること

---

## 5. 依存関係

### 既存コンポーネント

- **Git 統合機能** (`src/core/workflow/git-integration.ts`)
  - ブランチ検出機能を拡張
- **環境変数管理** (`.env`)
  - 新規環境変数 `PROTECTED_BRANCHES` の追加
- **エラーハンドリング** (`src/core/errors/`)
  - 新規エラークラス `ProtectedBranchError` の追加

### 外部依存

- `dotenv`: 環境変数読み込み
- `child_process`: Git コマンド実行

---

## 6. 参考情報

### 関連ドキュメント

- [CLAUDE.md - Git ワークフロー基本方針](/home/autum/Projects/personal/cc-craft-kit/CLAUDE.md#git-ワークフロー基本方針)
- [BRANCH_PROTECTION.md - ブランチ保護ルール](/home/autum/Projects/personal/cc-craft-kit/docs/BRANCH_PROTECTION.md)
- [GitHub Flow](https://docs.github.com/ja/get-started/quickstart/github-flow)

### 実装参考

- GitHub Actions のブランチ保護チェック
- Git hooks を使用したローカルブランチ保護
- `husky` + `lint-staged` のブランチチェックパターン

---

## 7. 設計

### 7.1 アーキテクチャ設計

#### コンポーネント構成

```text
┌─────────────────────────────────────┐
│  Claude Code Tools (Edit, Write)   │
├─────────────────────────────────────┤
│  Branch Validation Layer            │
│  - validateBranch()                 │
│  - suggestWorkingBranch()           │
├─────────────────────────────────────┤
│  Branch Guard Core                  │
│  - getCurrentBranch()               │
│  - getProtectedBranches()           │
│  - isProtectedBranch()              │
├─────────────────────────────────────┤
│  Config Layer                       │
│  - loadProtectedBranches()          │
│  - getDefaultBranch()               │
├─────────────────────────────────────┤
│  Git Command Executor               │
│  - execGitCommand()                 │
└─────────────────────────────────────┘
```

#### データフロー

1. **Edit/Write ツール実行時**
   - ユーザーが Edit ツールまたは Write ツールを実行
   - ツールは `validateBranch()` を呼び出し
   - `validateBranch()` は `getCurrentBranch()` で現在のブランチを取得
   - `getProtectedBranches()` で保護対象ブランチのリストを取得
   - `isProtectedBranch()` でブランチチェック実施
   - 保護対象ブランチの場合、`ProtectedBranchError` をスロー
   - エラー内に `suggestWorkingBranch()` で生成したブランチ名候補を含める

2. **環境変数読み込みフロー**
   - `loadProtectedBranches()` が `.env` から `PROTECTED_BRANCHES` を読み込み
   - 環境変数未設定の場合、`getDefaultBranch()` を呼び出し
   - Git コマンドでリモートのデフォルトブランチを取得
   - 取得失敗時は `main` → `master` の優先順位で決定

### 7.2 API 設計

#### Branch Guard Core API

```typescript
interface BranchGuard {
  /**
   * 現在のブランチ名を取得
   * @throws GitCommandError Git コマンド実行失敗時
   */
  getCurrentBranch(): Promise<string>;

  /**
   * 保護対象ブランチのリストを取得
   * @returns 保護対象ブランチ名の配列
   */
  getProtectedBranches(): Promise<string[]>;

  /**
   * 指定されたブランチが保護対象かチェック
   * @param branch - チェック対象のブランチ名
   * @returns 保護対象の場合 true
   */
  isProtectedBranch(branch: string): Promise<boolean>;

  /**
   * ブランチチェックを実行
   * @throws ProtectedBranchError 保護対象ブランチでの操作時
   */
  validateBranch(): Promise<void>;

  /**
   * 推奨作業ブランチ名を提案
   * @param specPhase - 仕様書のフェーズ（任意）
   * @returns 推奨ブランチ名の配列
   */
  suggestWorkingBranch(specPhase?: string): string[];
}
```

#### Config API

```typescript
interface ProtectedBranchConfig {
  /**
   * 環境変数から保護対象ブランチを読み込み
   * @returns 保護対象ブランチ名の配列
   */
  loadProtectedBranches(): Promise<string[]>;

  /**
   * デフォルトブランチを自動検出
   * @returns デフォルトブランチ名
   */
  getDefaultBranch(): Promise<string>;
}
```

#### Error API

```typescript
class ProtectedBranchError extends AppError {
  constructor(
    branch: string,
    protectedBranches: string[],
    suggestions: string[]
  ) {
    const message = `
エラー: 統合ブランチ '${branch}' での直接編集は禁止されている。

適切な作業ブランチを作成すること:
${suggestions.map((s) => `  git checkout -b ${s}`).join('\n')}

統合ブランチ: ${protectedBranches.join(', ')}
    `.trim();

    super('PROTECTED_BRANCH_ERROR', message);
  }
}
```

### 7.3 データモデル設計

#### 環境変数スキーマ

```bash
# .env
# 保護対象ブランチ（カンマ区切りで複数指定）
PROTECTED_BRANCHES=main,develop,staging
```

#### 設定オブジェクト

```typescript
interface BranchGuardConfig {
  /** 保護対象ブランチのリスト */
  protectedBranches: string[];
  /** デフォルトブランチの検出方法 */
  defaultBranchDetection: 'auto' | 'manual';
  /** キャッシュ有効期限（ミリ秒） */
  cacheTTL: number;
}
```

### 7.4 パフォーマンス設計

#### キャッシュ戦略

- **現在のブランチ名**: セッション単位でキャッシュ（ブランチ切り替えは稀）
- **保護対象ブランチリスト**: 環境変数読み込み後はメモリにキャッシュ
- **Git コマンド実行**: タイムアウト 100ms、非同期実行

#### パフォーマンス目標

| 処理 | 目標時間 |
|---|---|
| `getCurrentBranch()` | < 50ms |
| `getProtectedBranches()` | < 10ms（キャッシュヒット時） |
| `isProtectedBranch()` | < 5ms |
| `validateBranch()` | < 100ms（全体） |

### 7.5 エラーハンドリング設計

#### エラー種別と対処

| エラー | 原因 | 対処 |
|---|---|---|
| `ProtectedBranchError` | 保護対象ブランチでの編集 | エラーメッセージ表示、操作中断 |
| `GitCommandError` | Git コマンド実行失敗 | フォールバック（`.git` ディレクトリ未検出など） |
| `ConfigLoadError` | 環境変数読み込み失敗 | デフォルト値使用 |

#### フォールバック戦略

1. **Git リポジトリ未初期化の場合**: ブランチチェックをスキップ（警告のみ）
2. **環境変数未設定の場合**: デフォルトブランチを自動検出
3. **デフォルトブランチ検出失敗の場合**: `main` → `master` の優先順位で決定

### 7.6 セキュリティ設計

#### バリデーション

- ブランチ名のサニタイゼーション（コマンドインジェクション対策）
- 環境変数の検証（不正な値の除外）

#### 権限チェック

- Git コマンド実行権限の確認
- ファイルシステムアクセス権限の確認

---

## 8. 実装計画

### フェーズ1: コアロジック実装

- [ ] ブランチ検出機能の実装（`src/core/git/branch-guard.ts`）
- [ ] 環境変数読み込み機能の実装（`src/core/config/protected-branches.ts`）
- [ ] エラークラス `ProtectedBranchError` の追加（`src/core/errors/protected-branch-error.ts`）

### フェーズ2: Edit/Write ツールとの統合

- [ ] Edit ツールへのブランチチェック追加（`src/tools/edit/branch-validation.ts`）
- [ ] Write ツールへのブランチチェック追加（`src/tools/write/branch-validation.ts`）
- [ ] エラーメッセージのローカライズ（日本語対応）

### フェーズ3: テスト・検証

- [ ] 単体テスト実装（`tests/core/git/branch-guard.test.ts`）
- [ ] E2E テスト実装（統合ブランチでの編集失敗を検証）
- [ ] パフォーマンステスト（100ms 以内を確認）

### フェーズ4: ドキュメント整備

- [ ] README.md への機能説明追加
- [ ] CLAUDE.md へのガイドライン追加
- [ ] `.env.example` への `PROTECTED_BRANCHES` 追加
- [ ] トラブルシューティングセクション追加
