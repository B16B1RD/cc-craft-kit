# /cft:spec-create 時ブランチ切り替えのタイミングが不適切

**仕様書 ID:** 80f20bec-294a-42da-a7df-9ff23cfaaf89
**フェーズ:** design
**作成日時:** 2025/11/23 14:43:09
**更新日時:** 2025/11/23 14:54:37

---

## 1. 背景と目的

### 背景

現在の `/cft:spec-create` コマンドの実装では、以下の問題が発生しています:

1. **処理フローのタイミング問題**:
   - TypeScript スクリプト (`src/commands/spec/create.ts`) が仕様書を作成し、ブランチを `feature/spec-<短縮ID>` に切り替える
   - 仕様書ファイル作成と Git 自動コミット完了後、**即座に develop ブランチに戻る** (216-226行目)
   - その後、スラッシュコマンド定義 (`src/slash-commands/spec-create.md`) の自動完成フロー（フェーズ 1〜4）が実行される

2. **自動完成フローが意図しないブランチで実行される**:
   - フェーズ 3 の仕様書自動完成（Edit ツール）が、**develop ブランチ上で実行される**
   - 本来は `feature/spec-<短縮ID>` ブランチで編集されるべき

3. **Git 履歴の整合性が失われる**:
   - 仕様書作成コミットは feature ブランチに記録される（Git自動コミット）
   - 仕様書編集は develop ブランチに記録される（Claude Code が自動的にコミット）
   - 結果として、仕様書ファイルが feature ブランチと develop ブランチの両方に存在し、履歴が分断される

### 目的

TypeScript スクリプトとスラッシュコマンド定義のブランチ切り替えタイミングを最適化し、以下を実現する:

1. **自動完成フローが正しいブランチ上で実行される**: フェーズ 1〜4 が `feature/spec-<短縮ID>` ブランチ上で完了する
2. **Git 履歴の整合性を保つ**: 仕様書作成から自動完成まで、すべてのコミットが feature ブランチに記録される
3. **開発者の混乱を防ぐ**: ブランチ切り替えのタイミングが明確で、予測可能な動作を提供する
4. **CLAUDE.md の設計原則を維持**: 「プロンプトで済ませられることはプロンプトで済ませる」原則を守る

---

## 2. 対象ユーザー

- **cc-craft-kit を使用する開発者**: `/cft:spec-create` コマンドを使用して仕様書を作成する開発者
- **特に影響を受けるユーザー**: 仕様書の自動完成フロー（v0.4.0 以降）を使用する開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] TypeScript スクリプト (`src/commands/spec/create.ts`) の 216-226行目（元のブランチに戻る処理）を削除またはオプション化する
- [ ] スラッシュコマンド定義 (`src/slash-commands/spec-create.md`) のフェーズ 4 完了後に、元のブランチへの復帰処理を追加する
- [ ] 自動完成フロー（フェーズ 1〜4）がすべて `feature/spec-<短縮ID>` ブランチ上で実行されることを確認する

### 機能要件

- [ ] **TypeScript スクリプトの修正**:
  - `src/commands/spec/create.ts` の 216-226行目を削除
  - または、環境変数 `AUTO_SWITCH_BACK=0` でブランチ復帰を無効化するオプションを追加

- [ ] **スラッシュコマンド定義の修正**:
  - フェーズ 4 完了後（または自動完成フローがスキップされた場合も）に、Bash ツールで元のブランチに復帰する処理を追加
  - 元のブランチ名を記録する仕組みを実装（TypeScript スクリプトの出力から解析、またはファイルに記録）

- [ ] **エラーハンドリング**:
  - ブランチ切り替え失敗時のエラーメッセージを改善
  - 自動完成フローがスキップされた場合も、ブランチ復帰処理が実行されることを保証

### 非機能要件

- [ ] **互換性**: 既存の仕様書作成フローに影響を与えない（デグレードなし）
- [ ] **保守性**: ブランチ管理ロジックが明確で、将来的な変更が容易である
- [ ] **テスタビリティ**: 単体テストでブランチ切り替えのタイミングを検証できる
- [ ] **ドキュメント**: CLAUDE.md の「スクリプトとプロンプトの使い分け指針」に準拠していることを明記

---

## 4. 制約条件

### 技術的制約

1. **Claude Code の制約**:
   - TypeScript 内から Claude Tools (Edit, Task, AskUserQuestion) を直接呼び出すことはできない
   - 自動完成フロー（Explore、Edit、code-reviewer）はスラッシュコマンド定義で実行する必要がある

2. **Git 操作の制約**:
   - ブランチ切り替えは `child_process.execFileSync()` を使用し、シェルインジェクション対策を実施する
   - ブランチキャッシュ (`src/core/git/branch-cache.ts`) をクリアする必要がある

3. **イベント駆動アーキテクチャの制約**:
   - `spec.created` イベント発火後、Git自動コミットが完了するまで待機する（`await`）
   - ブランチ切り替えは、イベントハンドラー完了後に行う必要がある

### 設計原則

1. **CLAUDE.md の「スクリプトとプロンプトの使い分け指針」を遵守**:
   - データベース操作・イベント発火は TypeScript スクリプトで実装
   - 自動完成フロー（Explore、Edit、code-reviewer）はスラッシュコマンド定義で実装

2. **最小限の修正**:
   - 既存のアーキテクチャ（イベント駆動、モジュラーモノリス）を維持
   - TypeScript スクリプトとスラッシュコマンド定義の責務境界を明確にする

### 互換性

1. **既存の仕様書作成フローとの互換性を維持**:
   - フェーズ 1〜4 がスキップされた場合（手動で仕様書を編集する場合）も正常に動作する
   - 環境変数でブランチ復帰を制御できるようにする（既存の動作を変更しない）

---

## 5. 依存関係

### コアコンポーネント

1. **`src/commands/spec/create.ts`** (仕様書作成コマンド):
   - ブランチ作成・切り替えロジック（216-226行目）を修正
   - データベース操作、イベント発火、仕様書ファイル生成を担当

2. **`src/slash-commands/spec-create.md`** (スラッシュコマンド定義):
   - 自動完成フロー（フェーズ 0〜4）を定義
   - フェーズ 4 完了後にブランチ復帰処理を追加

3. **`src/core/git/branch-creation.ts`** (ブランチ作成):
   - `createSpecBranch()` 関数でブランチ名生成・作成を担当
   - 修正は不要

4. **`src/core/git/branch-cache.ts`** (ブランチキャッシュ):
   - `getCurrentBranch()`, `clearBranchCache()` を使用
   - 修正は不要

5. **`src/core/workflow/event-bus.ts`** (イベントバス):
   - `spec.created` イベント発火を担当
   - 修正は不要

6. **`src/core/workflow/git-integration.ts`** (Git統合):
   - `spec.created` イベントハンドラーで Git 自動コミットを実行
   - 修正は不要

### 既存仕様書

- 関連する既存仕様書なし（新規問題）

### 外部依存

- **Node.js `child_process` モジュール**: Git 操作に使用
- **Git**: バージョン管理システム

---

## 6. 参考情報

### コードベース解析結果

- **現在の処理フロー**: Explore サブエージェントによる分析で、`src/commands/spec/create.ts` の 216-226行目でブランチが即座に戻ることを確認
- **推奨修正案**: 案1（ブランチ切り替え遅延）
  - TypeScript スクリプトの 216-226行目を削除
  - スラッシュコマンド定義の最後にブランチ切り替え処理を追加

### 関連ドキュメント

- **CLAUDE.md**: プロジェクト規約、スクリプトとプロンプトの使い分け指針
- **docs/ARCHITECTURE.md**: アーキテクチャ設計、イベント駆動アーキテクチャの説明

### 関連コードファイル

- `src/commands/spec/create.ts:216-226` - 問題箇所（元のブランチに戻る処理）
- `src/slash-commands/spec-create.md:107-114` - フェーズ 0（仕様書の基本作成）
- `src/slash-commands/spec-create.md:177-188` - フェーズ 3（仕様書の自動完成）
- `src/core/git/branch-creation.ts` - ブランチ作成ロジック
- `src/core/git/branch-cache.ts` - ブランチキャッシュ管理

### テスト戦略

- **単体テスト**: `tests/commands/spec/create.test.ts` でブランチ切り替えのタイミングを検証
- **統合テスト**: 実際の仕様書作成フローで、自動完成が正しいブランチ上で実行されることを確認
