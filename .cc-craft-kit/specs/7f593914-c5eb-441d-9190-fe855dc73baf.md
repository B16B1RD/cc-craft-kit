# comp フェーズで feature ブランチの作成に失敗し、ユーザーに手動削除するように求めてしまう

**仕様書 ID:** 7f593914-c5eb-441d-9190-fe855dc73baf
**フェーズ:** completed
**作成日時:** 2025/11/30 12:00:00
**更新日時:** 2025/11/30 14:10:00

---

## 1. 背景と目的

### 背景

completed フェーズへの移行時に feature ブランチの作成に失敗するケースが報告された。失敗した際にユーザーに「手動でブランチを削除してください」と求めてしまうが、プロンプトで再度ブランチ削除を依頼すると正常に削除できた。

コミット `82cdc35`（2025/11/21）で `branch-management.ts` から `handleBranchCreationOnImplementation()` を削除したが、`spec-phase.md` にブランチ存在確認・自動作成フォールバック処理が追加されていない可能性がある。これがデグレードの原因と推測される。

### 目的

completed フェーズへの移行時に、feature ブランチが存在しない場合でも適切にハンドリングし、ユーザーに不正確な手動操作を求めないようにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者（特に `/cft:spec-phase <spec-id> completed` コマンドを使用するユーザー）

---

## 3. 受け入れ基準

### 必須要件

- [ ] completed フェーズ移行時にブランチが存在しない場合、適切なエラーハンドリングが実行される
- [ ] ブランチ操作失敗時に、実際のエラー原因に基づいた適切なガイダンスが表示される

### 機能要件

- [ ] completed フェーズ移行前にブランチ存在確認を実行
- [ ] ブランチが存在しない場合、ベースブランチから自動作成を試行
- [ ] 自動作成に失敗した場合、具体的なエラー原因と対処方法を表示

### 非機能要件

- [ ] 既存の正常フロー（ブランチが存在する場合）の動作に影響を与えない
- [ ] エラーメッセージは日本語で、具体的な対処手順を含む

---

## 4. 制約条件

- プロンプトファースト原則に従い、可能な限り `spec-phase.md` のプロンプト層で実装
- `branch-management.ts` へのイベントハンドラー追加は最終手段
- 既存の `switchBranch()` ロジック（`branch-switching.ts`）は変更しない（影響範囲を限定）

---

## 5. 依存関係

### 関連ファイル

- `src/slash-commands/spec-phase.md` - フェーズ遷移プロンプト（主な修正対象）
- `src/core/git/branch-switching.ts` - ブランチ切り替えロジック
- `src/core/workflow/branch-management.ts` - ブランチ管理（空、現状ハンドラーなし）
- `src/core/workflow/git-integration.ts` - イベントハンドラー

### 関連仕様

- なし

---

## 6. 参考情報

- コミット `82cdc35`（2025/11/21）: ブランチ自動作成ロジック削除
- `spec-phase.md` Step 3（行60-66）: ブランチ切り替え処理

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
┌─────────────────────────────────────────────────────────────┐
│                    spec-phase.md                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Step 3: ブランチ切り替え（修正対象）                │   │
│  │  ├─ 3.1 ブランチ存在確認                           │   │
│  │  ├─ 3.2 ブランチ自動作成（フォールバック）         │   │
│  │  ├─ 3.3 ブランチ切り替え実行                       │   │
│  │  └─ 3.4 エラーハンドリング                         │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Bash ツール                              │
│  - git rev-parse --verify (存在確認)                        │
│  - git branch (作成)                                        │
│  - git checkout (切り替え)                                  │
└─────────────────────────────────────────────────────────────┘
```

#### 設計方針

- **プロンプトファースト原則**: すべての実装を `spec-phase.md` で完結
- **既存パターン流用**: `spec-create.md` のブランチ作成フローを参考
- **フォールバック設計**: ブランチ不在時は自動作成を試行
- **ユーザーフレンドリー**: エラー時は具体的な手動操作コマンドを提示

#### 処理フロー詳細

```
Step 3 開始
    │
    ▼
BRANCH_NAME が null?
    │
    ├─ Yes → ブランチ操作スキップ → Step 4 へ
    │
    └─ No
        │
        ▼
    ブランチ存在確認
    git rev-parse --verify "$BRANCH_NAME"
        │
        ├─ 存在する → ブランチ切り替え → Step 4 へ
        │
        └─ 存在しない
            │
            ▼
        ベースブランチから自動作成
        git branch "$BRANCH_NAME" "$BASE_BRANCH"
            │
            ├─ 成功 → ブランチ切り替え → Step 4 へ
            │
            └─ 失敗
                │
                ▼
            エラーメッセージ表示
            + 手動操作ガイダンス
            → 処理中断
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/slash-commands/spec-phase.md` | Step 3 にブランチ存在確認・自動作成・エラーハンドリングを追加 |

#### 実装詳細

**修正箇所**: Step 3（行60-66）を以下のように置換

```markdown
### Step 3: ブランチ切り替え

`BRANCH_NAME` が null でない場合、以下の処理を実行:

#### 3.1 ベースブランチの取得

Bash ツールで `.env` から `BASE_BRANCH` を取得:

```bash
BASE_BRANCH=$(grep '^BASE_BRANCH=' .env 2>/dev/null | cut -d'=' -f2 | tr -d '"' || echo "develop")
echo "ベースブランチ: $BASE_BRANCH"
```

#### 3.2 ブランチ存在確認・自動作成

Bash ツールで実行:

```bash
# ブランチが存在するか確認
if git rev-parse --verify "$BRANCH_NAME" > /dev/null 2>&1; then
  echo "✓ ブランチ '$BRANCH_NAME' が見つかりました"
else
  echo "⚠️ ブランチ '$BRANCH_NAME' が見つかりません。自動作成を試みます..."

  # ベースブランチの存在確認
  if ! git rev-parse --verify "$BASE_BRANCH" > /dev/null 2>&1; then
    echo "❌ ベースブランチ '$BASE_BRANCH' が見つかりません"
    exit 1
  fi

  # ベースブランチから自動作成
  if git branch "$BRANCH_NAME" "$BASE_BRANCH"; then
    echo "✓ ブランチを作成しました: $BRANCH_NAME (from $BASE_BRANCH)"
  else
    echo "❌ ブランチ作成に失敗しました"
    exit 1
  fi
fi

# ブランチに切り替え
git checkout "$BRANCH_NAME"
```

**エラーハンドリング:**

- **ブランチが存在しない + 自動作成成功**: 処理続行
- **ベースブランチが存在しない**: 以下のエラーメッセージを表示して処理中断

```
❌ ブランチ操作に失敗しました

ブランチ: $BRANCH_NAME
ベースブランチ: $BASE_BRANCH (存在しません)

対処方法:
1. .env の BASE_BRANCH 設定を確認
2. ベースブランチをフェッチ: git fetch origin $BASE_BRANCH:$BASE_BRANCH
3. 再実行: /cft:spec-phase $SPEC_ID $NEW_PHASE
```

- **ブランチ作成失敗**: 以下のエラーメッセージを表示して処理中断

```
❌ ブランチ作成に失敗しました

ブランチ: $BRANCH_NAME

対処方法:
1. 同名ブランチが存在しないか確認: git branch -a | grep "$BRANCH_NAME"
2. 手動でブランチを作成: git branch "$BRANCH_NAME" "$BASE_BRANCH"
3. 再実行: /cft:spec-phase $SPEC_ID $NEW_PHASE
```

- **ブランチ切り替え失敗**: 以下のエラーメッセージを表示して処理中断

```
❌ ブランチ切り替えに失敗しました

ブランチ: $BRANCH_NAME

対処方法:
1. 未コミットの変更を確認: git status
2. 変更をスタッシュ: git stash
3. 手動で切り替え: git checkout "$BRANCH_NAME"
4. 再実行: /cft:spec-phase $SPEC_ID $NEW_PHASE
```
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| ブランチ存在確認 | なし | `git rev-parse --verify` で確認 | spec-phase.md Step 3.2 |
| ブランチ自動作成 | なし（削除済み） | `git branch` でベースから作成 | spec-phase.md Step 3.2 |
| エラーハンドリング | 不十分 | 具体的なエラー原因と対処方法を表示 | spec-phase.md Step 3 |
| ブランチ切り替え | `git checkout` のみ | 存在確認・作成後に切り替え | spec-phase.md Step 3.2 |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| 正常系: ブランチ存在 | 既存ブランチへの切り替え | 手動テスト: 仕様書作成後にフェーズ移行 |
| 正常系: ブランチ不在 | 自動作成後に切り替え | 手動テスト: ブランチ削除後にフェーズ移行 |
| エラー系: ベースブランチ不在 | エラーメッセージ表示 | 手動テスト: BASE_BRANCH を無効値に設定 |
| エラー系: 作成失敗 | エラーメッセージ表示 | 手動テスト: 権限なしディレクトリで実行 |
| 既存フロー影響なし | BRANCH_NAME が null | 手動テスト: branch_name が空の仕様書でフェーズ移行 |

### 7.5 移行計画

#### Phase 1: Step 3 の修正

1. `src/slash-commands/spec-phase.md` の Step 3 セクションを修正
2. ブランチ存在確認ロジックを追加
3. ブランチ自動作成フォールバックを追加
4. エラーハンドリングを追加

#### Phase 2: 同期とテスト

1. `npm run sync:dogfood` で `.cc-craft-kit/` へ同期
2. 手動テストで正常系・エラー系を検証
3. 既存フローへの影響がないことを確認

---

## 8. 実装タスクリスト

### Phase 1: Step 3 の修正

- [x] spec-phase.md の Step 3 にベースブランチ取得処理を追加
- [x] spec-phase.md の Step 3 にブランチ存在確認・自動作成ロジックを追加
- [x] spec-phase.md の Step 3 にエラーハンドリング（3パターン）を追加

### Phase 2: 同期とテスト

- [x] `npm run sync:dogfood` で同期
- [x] 正常系テスト: ブランチ存在時のフェーズ移行
- [x] 正常系テスト: ブランチ不在時の自動作成
- [x] エラー系テスト: ベースブランチ不在時のエラー表示
