# comp フェーズで feature ブランチの作成に失敗し、ユーザーに手動削除するように求めてしまう

**仕様書 ID:** 7f593914-c5eb-441d-9190-fe855dc73baf
**フェーズ:** requirements
**作成日時:** 2025/11/30 12:00:00
**更新日時:** 2025/11/30 12:00:00

---

## 1. 背景と目的

### 背景

completed フェーズへの移行時に feature ブランチの作成に失敗するケースが報告された。失敗した際にユーザーに「手動でブランチを削除してください」と求めてしまうが、プロンプトで再度ブランチ削除を依頼すると正常に削除できた。

コミット `82cdc35`（2025/11/21）で `branch-management.ts` から `handleBranchCreationOnImplementation()` を削除したが、`spec-phase.md` にブランチ存在確認・自動作成フォールバック処理が追加されていない可能性がある。これがデグレードの原因と推測される。

### 目的

completed フェーズへの移行時に、feature ブランチが存在しない場合でも適切にハンドリングし、ユーザーに不正確な手動操作を求めないようにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者（特に `/cft:spec-phase <spec-id> completed` コマンドを使用するユーザー）

---

## 3. 受け入れ基準

### 必須要件

- [ ] completed フェーズ移行時にブランチが存在しない場合、適切なエラーハンドリングが実行される
- [ ] ブランチ操作失敗時に、実際のエラー原因に基づいた適切なガイダンスが表示される

### 機能要件

- [ ] completed フェーズ移行前にブランチ存在確認を実行
- [ ] ブランチが存在しない場合、ベースブランチから自動作成を試行
- [ ] 自動作成に失敗した場合、具体的なエラー原因と対処方法を表示

### 非機能要件

- [ ] 既存の正常フロー（ブランチが存在する場合）の動作に影響を与えない
- [ ] エラーメッセージは日本語で、具体的な対処手順を含む

---

## 4. 制約条件

- プロンプトファースト原則に従い、可能な限り `spec-phase.md` のプロンプト層で実装
- `branch-management.ts` へのイベントハンドラー追加は最終手段
- 既存の `switchBranch()` ロジック（`branch-switching.ts`）は変更しない（影響範囲を限定）

---

## 5. 依存関係

### 関連ファイル

- `src/slash-commands/spec-phase.md` - フェーズ遷移プロンプト（主な修正対象）
- `src/core/git/branch-switching.ts` - ブランチ切り替えロジック
- `src/core/workflow/branch-management.ts` - ブランチ管理（空、現状ハンドラーなし）
- `src/core/workflow/git-integration.ts` - イベントハンドラー

### 関連仕様

- なし

---

## 6. 参考情報

- コミット `82cdc35`（2025/11/21）: ブランチ自動作成ロジック削除
- `spec-phase.md` Step 3（行60-66）: ブランチ切り替え処理
