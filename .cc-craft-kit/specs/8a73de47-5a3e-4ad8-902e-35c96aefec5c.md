---
id: "8a73de47-5a3e-4ad8-902e-35c96aefec5c"
name: "/cft:status が正しく動作しない"
phase: "implementation"
branch_name: "fix/spec-8a73de47-status-not-working-correctly"
github_issue_number: null
pr_url: null
created_at: "2025-12-06T12:00:00.000Z"
updated_at: "2025-12-06T22:32:00.000Z"
---

# /cft:status が正しく動作しない

## 1. 背景と目的

### 背景

`/cft:status` コマンド実行時に複数のエラーが発生している:

1. **Bash コマンドの構文エラー**: `for` ループや `while read` を使用したシェルスクリプトが正しく解釈されない
   - 変数展開が空文字列になる
   - パイプとループの組み合わせでファイルパスが消失

2. **仕様書フォーマットの混在**: 195件の仕様書に2つのフォーマットが混在
   - **YAML フロントマター形式** (193件): `---` で囲まれた YAML ヘッダー
   - **独自フォーマット** (2件): `**フェーズ:**` などの Markdown 形式

3. **phase 行の不正値**: 1件の仕様書で `phase: <requirements|design|implementation|review|completed>` というテンプレート文字列がそのまま残っている

### 目的

1. `/cft:status` コマンドが正常に動作するようにする
2. 仕様書フォーマットを YAML フロントマター形式に統一する
3. 不正な phase 値を持つ仕様書を修正する

---

## 2. 対象ユーザー

cc-craft-kit を使用してプロジェクト管理を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [x] `/cft:status` コマンドがエラーなく実行できる
- [x] 全ての仕様書が YAML フロントマター形式に統一されている
- [x] 不正な phase 値を持つ仕様書が修正されている

### 機能要件

- [x] Bash コマンドの構文エラーが解消される
- [x] 独自フォーマット（`**フェーズ:**` 形式）の仕様書が YAML フロントマター形式に移行される
- [x] phase フィールドに有効な値のみが設定されている

### 非機能要件

- [x] 既存の仕様書データ（内容）が失われない
- [x] 移行スクリプトが再実行可能である

---

## 4. 制約条件

- 移行は非破壊的に行う（バックアップを作成）
- 既存のブランチ構造を維持する

---

## 5. 依存関係

- `.cc-craft-kit/specs/` 内の全仕様書ファイル
- `/cft:status` コマンド定義（`.claude/commands/cft/status.md`）

---

## 6. 参考情報

### 問題のある仕様書

**独自フォーマット（2件）:**
- `d29e6a8c-b249-4f84-9444-f988347ebcb1.md`
- `7ae68b97-e109-439f-ba52-afe3737132e8.md`

**不正な phase 値（1件）:**
- phase が `<requirements|design|implementation|review|completed>` のままの仕様書

### 現在のフェーズ分布

| フェーズ | 件数 |
|---------|------|
| completed | 187 |
| review | 5 |
| requirements | 1 |
| design | 1 |
| 不正値 | 1 |

### 発生したエラー例

```
/bin/bash: eval: 行 1: 予期しないトークン `basename' 周辺に構文エラーがあります
```

```
head: '' を 読み込み用に開くことが出来ません: そのようなファイルやディレクトリはありません
```

---

## 7. 設計詳細

### 7.1 問題の原因分析

#### 独自フォーマットの仕様書（2件）

| ファイル | 現在の形式 |
|---------|-----------|
| `d29e6a8c-b249-4f84-9444-f988347ebcb1.md` | `**仕様書 ID:**`, `**フェーズ:**` 形式 |
| `7ae68b97-e109-439f-ba52-afe3737132e8.md` | `**仕様書 ID:**`, `**フェーズ:**` 形式 |

#### 不正な phase 値（1件）

| ファイル | 問題 |
|---------|------|
| `035d4de4-2be1-4843-b464-bd220bc779e4.md` | テンプレート値がそのまま残存 |

### 7.2 解決アプローチ

1. **独自フォーマット → YAML フロントマター変換**
   - カスタムフォーマットのメタデータを抽出
   - YAML フロントマター形式に変換して先頭に挿入
   - 本文はそのまま維持

2. **不正な phase 値の修正**
   - テンプレート値を正しいフェーズ値に置換

### 7.3 変換仕様

**変換前（カスタムフォーマット）:**
```markdown
# タイトル

**仕様書 ID:** uuid
**フェーズ:** completed
**作成日時:** 2025/12/05 16:30:00
**更新日時:** 2025/12/05 21:30:00
```

**変換後（YAML フロントマター）:**
```markdown
---
id: "uuid"
name: "タイトル"
phase: "completed"
branch_name: "develop"
github_issue_number: null
pr_url: null
created_at: "2025-12-05T16:30:00Z"
updated_at: "2025-12-05T21:30:00Z"
---

# タイトル
```

---

## 8. タスクリスト

### Phase 1: カスタムフォーマット仕様書の移行

- [x] `d29e6a8c-b249-4f84-9444-f988347ebcb1.md` を YAML フロントマター形式に変換
- [x] `7ae68b97-e109-439f-ba52-afe3737132e8.md` を YAML フロントマター形式に変換

### Phase 2: 不正な phase 値の修正

- [x] `035d4de4-2be1-4843-b464-bd220bc779e4.md` の phase 値を修正（すでに正しい形式）

### Phase 3: 動作検証

- [x] `/cft:status` コマンドがエラーなく実行できることを確認
- [x] 仕様書のフェーズ別集計が正確であることを確認
