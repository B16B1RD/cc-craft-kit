# GitHub Issue が作成・更新されなかったり、GitHub Projects に反映されなかったりする

**仕様書 ID:** b9240743-0475-45c1-9dda-03cf409019d7
**フェーズ:** completed
**作成日時:** 2025/11/18 16:24:42
**更新日時:** 2025/11/18 17:20:26

---

## 1. 背景と目的

### 背景

cc-craft-kit は仕様書作成時およびフェーズ変更時に GitHub Issue を自動作成・更新し、GitHub Projects に反映する機能を提供しています。しかし、現在以下の問題が発生しています:

1. `/cft:spec-create` コマンド実行時に GitHub Issue が作成されない
2. `/cft:spec-phase` コマンド実行時に GitHub Issue が更新されない
3. GitHub Projects にアイテムが追加されない

デバッグログを確認したところ、以下のエラーが発生していることが判明しました:

```
Failed to register handlers: Error: tsyringe requires a reflect polyfill.
Please add 'import "reflect-metadata"' to the top of your entry point.
```

**根本原因:**
1. `src/integrations/github/sub-issues.ts`が`tsyringe`の`@injectable()`デコレーターを使用
2. しかし、実際には DI コンテナを使用せず、`new SubIssueManager(db)`で直接インスタンス化している
3. tsyringe モジュールの読み込み時に reflect-metadata の存在をチェックするが、reflect-metadata は`devDependencies`に配置されているため、本番実行時に利用できない
4. イベントハンドラー登録時に`SubIssueManager`をインポートするため、エラーが発生してハンドラー登録に失敗

### 目的

reflect-metadata を`dependencies`に移動し、GitHub 統合機能のイベントハンドラーが正常に登録されるようにする。または、使用していない`@injectable()`デコレーターを削除する。

---

## 2. 対象ユーザー

cc-craft-kit を使用するすべての開発者、特に以下のようなユーザー:

- GitHub 統合機能を使用したい開発者
- 仕様書と GitHub Issue を自動連携させたい開発者
- GitHub Projects でタスク管理を行いたい開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-create` 実行時に GitHub Issue が自動作成される
- [ ] `/cft:spec-phase` 実行時に GitHub Issue が自動更新される
- [ ] GitHub Projects にアイテムが自動追加される
- [ ] イベントハンドラーが正常に登録される（`Failed to register handlers`エラーが発生しない）

### 機能要件（解決策A: reflect-metadata を dependencies に移動）

- [ ] `package.json`の`devDependencies`から`dependencies`に reflect-metadata を移動
- [ ] `src/integrations/github/sub-issues.ts`の先頭に`import 'reflect-metadata'`を追加
- [ ] イベントハンドラー登録エラーが発生しない
- [ ] GitHub Issue 作成時に Issue 番号がコンソールに表示される
- [ ] GitHub Projects 追加時に Project 番号がコンソールに表示される

### 機能要件（解決策B: 未使用のデコレーターを削除）

- [ ] `src/integrations/github/sub-issues.ts`から`@injectable()`デコレーターを削除
- [ ] `src/integrations/github/sub-issues.ts`から`import { injectable } from 'tsyringe'`を削除
- [ ] イベントハンドラー登録エラーが発生しない
- [ ] GitHub Issue 作成時に Issue 番号がコンソールに表示される
- [ ] GitHub Projects 追加時に Project 番号がコンソールに表示される

### 非機能要件

- [ ] パフォーマンスへの影響が最小限（起動時間のオーバーヘッドが 100ms 以内）
- [ ] 既存のテストスイートがすべてパスする
- [ ] 既存のコードとの互換性を維持

---

## 4. 制約条件

- reflect-metadata は tsyringe の `@injectable()` デコレーター使用時の必須依存関係
- tsyringe モジュールの読み込み時に reflect-metadata の存在がチェックされる
- `SubIssueManager` クラスは現在 DI コンテナを使用せず、`new` で直接インスタンス化されている
- reflect-metadata を devDependencies から dependencies に移動すると、本番環境でのパッケージサイズが増加する（約 300KB）

---

## 5. 依存関係

### 直接影響を受けるファイル

- `src/integrations/github/sub-issues.ts` - `@injectable()`デコレーターを使用
- `src/core/workflow/github-integration.ts` - `SubIssueManager`をインポートしてインスタンス化
- `src/core/workflow/event-bus.ts` - イベントハンドラー登録時に`github-integration.ts`をインポート
- `package.json` - reflect-metadata の依存関係定義

### 間接的に影響を受けるコマンド

イベントハンドラー登録に失敗することで、以下のコマンドの GitHub 統合機能が動作しません:

- `/cft:spec-create` - GitHub Issue 自動作成が失敗
- `/cft:spec-phase` - GitHub Issue 更新が失敗
- `/cft:knowledge-progress` - 進捗記録の GitHub コメント追加が失敗
- `/cft:knowledge-error` - エラー記録の GitHub コメント追加が失敗
- `/cft:knowledge-tip` - Tips 記録の GitHub コメント追加が失敗

### 依存する仕様

- なし（バグ修正）

---

## 6. 参考情報

- **tsyringe 公式ドキュメント:**
  - reflect-metadata の必要性: https://github.com/microsoft/tsyringe#installation
- **reflect-metadata パッケージ:**
  - npm: https://www.npmjs.com/package/reflect-metadata
- **TypeScript Decorators:**
  - Reflect Metadata: https://www.typescriptlang.org/docs/handbook/decorators.html

---

## 7. 実装方針

### 推奨解決策: B（未使用のデコレーターを削除）

`SubIssueManager`クラスは実際に DI コンテナを使用していないため、`@injectable()`デコレーターと tsyringe のインポートを削除することを推奨します。これにより:

- reflect-metadata の依存関係が不要になる
- パッケージサイズが増加しない
- コードがシンプルになる

#### 修正対象ファイル

**`src/integrations/github/sub-issues.ts`:**

```typescript
// 削除する行
import { injectable } from 'tsyringe';

// ...

// 削除するデコレーター
@injectable()  // ← この行を削除
export class SubIssueManager {
  // ...
}
```

修正後:

```typescript
import { graphql } from '@octokit/graphql';
import type { Kysely } from 'kysely';
import type { Database } from '../../core/database/schema.js';
// import { injectable } from 'tsyringe'; ← 削除
import { z } from 'zod';

// ...

// @injectable() ← 削除
export class SubIssueManager {
  private graphqlClientCache: Map<string, ReturnType<typeof graphql.defaults>> = new Map();

  constructor(private db: Kysely<Database>) {}
  // ...
}
```

### 代替解決策: A（reflect-metadata を dependencies に移動）

将来的に DI コンテナを使用する予定がある場合は、この解決策を選択します。

#### 修正対象ファイル

**1. `package.json`:**

```json
{
  "dependencies": {
    "reflect-metadata": "^0.2.2"  // devDependencies から移動
  },
  "devDependencies": {
    // "reflect-metadata": "^0.2.2" ← 削除
  }
}
```

**2. `src/integrations/github/sub-issues.ts`:**

ファイルの先頭に追加:

```typescript
import 'reflect-metadata';
import { graphql } from '@octokit/graphql';
// ...
```

### 検証方法

#### 共通の検証手順

1. **デバッグモードで仕様書を作成:**
   ```bash
   DEBUG=1 npx tsx .cc-craft-kit/commands/spec/create.ts "テスト仕様書" "GitHub Issue自動作成テスト"
   ```

2. **エラーメッセージが表示されないことを確認:**
   ```
   # このエラーが出ないことを確認
   Failed to register handlers: Error: tsyringe requires a reflect polyfill.
   ```

3. **GitHub Issue が自動作成されることを確認:**
   ```
   ✓ GitHub Issue created automatically: #123
     URL: https://github.com/owner/repo/issues/123
   ✓ Added to GitHub Project #1
   ```

4. **GitHubリポジトリで実際にIssueが作成されたか確認:**
   - https://github.com/B16B1RD/takumi/issues を開く
   - 新しい Issue が作成されていることを確認
   - Issue の内容が仕様書と一致することを確認

5. **GitHub Projectsで確認:**
   - https://github.com/users/B16B1RD/projects/1 を開く
   - アイテムが追加されていることを確認

#### 解決策Bの追加検証

6. **tsyringeへの依存が削除されたことを確認:**
   ```bash
   grep -r "import.*tsyringe" src/integrations/github/sub-issues.ts
   # 何も出力されないことを確認
   ```

7. **テストがパスすることを確認:**
   ```bash
   npm test src/integrations/github/sub-issues.test.ts
   ```

---

## 8. 設計詳細

### 8.1 アーキテクチャ設計

#### 問題の根本原因

1. **tsyringe の `@injectable()` デコレーター使用**
   - `src/integrations/github/sub-issues.ts:4` で `import { injectable } from 'tsyringe'`
   - `src/integrations/github/sub-issues.ts:38` で `@injectable()` デコレーター使用
   - しかし、実際には DI コンテナを使わず `new SubIssueManager(db)` で直接インスタンス化（`src/core/workflow/github-integration.ts:354`, `737`）

2. **reflect-metadata の依存関係が devDependencies に配置**
   - `package.json:77` で `reflect-metadata` が `devDependencies` に配置
   - tsyringe モジュールの読み込み時に reflect-metadata の存在をチェック
   - 本番実行時（`npx tsx`）では devDependencies が利用できないため、エラーが発生

3. **イベントハンドラー登録の失敗**
   - `src/core/workflow/event-bus.ts` の `getEventBusAsync()` 内で `registerGitHubIntegrationHandlers()` を呼び出し
   - `src/core/workflow/github-integration.ts` が `SubIssueManager` をインポート
   - tsyringe モジュールの読み込み時にエラーが発生し、ハンドラー登録に失敗

#### 解決策の比較

| 項目 | 解決策 A: reflect-metadata を移動 | 解決策 B: デコレーターを削除 |
|---|---|---|
| **変更内容** | `package.json` で dependencies に移動 | `@injectable()` と `import` を削除 |
| **変更ファイル数** | 2 ファイル | 1 ファイル |
| **パッケージサイズ** | +300KB | 変更なし |
| **メリット** | 将来的な DI 対応が容易 | シンプル、サイズ増加なし |
| **デメリット** | パッケージサイズ増加 | DI 対応時に再修正が必要 |
| **推奨度** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

**結論: 解決策 B を推奨**

理由:
- `SubIssueManager` クラスは現在 DI コンテナを使用していない
- 将来的に DI が必要になった場合に再度追加すればよい
- パッケージサイズを最小限に保てる

### 8.2 API/インターフェース設計

#### 影響を受けるファイル

```
src/integrations/github/sub-issues.ts (修正対象)
├── import { injectable } from 'tsyringe';  // 削除
└── @injectable()                            // 削除

src/core/workflow/github-integration.ts (変更なし)
├── new SubIssueManager(db) (line 354)      // 既に DI 未使用
└── new SubIssueManager(db) (line 737)      // 既に DI 未使用
```

#### 修正内容

**`src/integrations/github/sub-issues.ts` の変更差分:**

```diff
  import { graphql } from '@octokit/graphql';
  import type { Kysely } from 'kysely';
  import type { Database } from '../../core/database/schema.js';
- import { injectable } from 'tsyringe';
  import { z } from 'zod';

  /**
   * Sub Issue Manager
   * GitHub の Sub Issue 機能を使用してタスクを管理
   */
- @injectable()
  export class SubIssueManager {
    private graphqlClientCache: Map<string, ReturnType<typeof graphql.defaults>> = new Map();

    constructor(private db: Kysely<Database>) {}
    // ...
  }
```

#### エラーハンドリング

1. **イベントハンドラー登録時のエラー**
   - 現在: tsyringe のモジュール読み込みエラーでハンドラー登録に失敗
   - 修正後: エラーなく正常に登録される

2. **GitHub API 呼び出しエラー**
   - 変更なし（既存のエラーハンドリングを維持）

### 8.3 データモデル設計

#### データベーススキーマへの影響

**変更なし**

今回の修正は TypeScript のデコレーター削除のみのため、データベーススキーマへの影響はありません。

#### github_sync テーブルの利用

```typescript
// Sub Issue の同期記録（変更なし）
await db
  .insertInto('github_sync')
  .values({
    id: randomUUID(),
    entity_type: 'sub_issue',
    entity_id: taskId,
    github_id: `${owner}/${repo}`,
    github_number: issueNumber,
    github_node_id: nodeId,
    last_synced_at: new Date().toISOString(),
    sync_status: 'success',
    error_message: null,
  })
  .execute();
```

### 8.4 パフォーマンス設計

#### 起動時間への影響

| 項目 | 修正前 | 修正後 | 差分 |
|---|---|---|---|
| tsyringe モジュール読み込み | エラーで失敗 | 読み込まない | ⬇️ 高速化 |
| reflect-metadata 読み込み | なし（devDependencies） | なし | ➡️ 変わらず |
| イベントハンドラー登録 | 失敗 | 成功 | ⬆️ 改善 |

**期待される効果:**
- モジュール読み込みエラーが解消され、起動時間が短縮される
- イベントハンドラーが正常に登録され、GitHub 統合機能が動作する

### 8.5 セキュリティ設計

#### セキュリティへの影響

**変更なし**

今回の修正はデコレーターの削除のみのため、セキュリティへの影響はありません。

#### GitHub トークンの取り扱い

```typescript
// 既存のトークン管理（変更なし）
const githubToken = process.env.GITHUB_TOKEN;
if (!githubToken) {
  // トークン未設定時はスキップ
  return;
}
```

### 8.6 テスト設計

#### 単体テストの検証項目

1. **`SubIssueManager` クラスのインスタンス化**
   - `new SubIssueManager(db)` が正常に動作する
   - tsyringe のエラーが発生しない

2. **イベントハンドラーの登録**
   - `registerGitHubIntegrationHandlers()` が正常に完了する
   - `spec.created` イベントで GitHub Issue が作成される
   - `spec.phase_changed` イベントで GitHub Issue が更新される

3. **Sub Issue の作成**
   - `createSubIssuesFromTaskList()` が正常に動作する
   - GitHub API が正しく呼び出される

#### E2E テストのシナリオ

1. **仕様書作成時の GitHub Issue 自動作成**
   ```bash
   /cft:spec-create "テスト仕様書" "GitHub Issue 自動作成テスト"
   ```
   - 期待結果: GitHub Issue が自動作成される
   - エラーログに `Failed to register handlers` が出力されない

2. **フェーズ変更時の GitHub Issue 更新**
   ```bash
   /cft:spec-phase <spec-id> design
   ```
   - 期待結果: GitHub Issue のラベルが更新される
   - フェーズ移行のコメントが追加される

3. **tasks フェーズ移行時の Sub Issue 作成**
   ```bash
   /cft:spec-phase <spec-id> tasks
   ```
   - 期待結果: Sub Issue が自動作成される
   - GitHub Projects にアイテムが追加される

---

## 9. 実装タスクリスト

### タスク分解

設計セクションで推奨した **解決策 B（未使用のデコレーターを削除）** に基づいて、以下のタスクに分解します。

#### タスク 1: `@injectable()` デコレーターの削除

**ファイル:** `src/integrations/github/sub-issues.ts`

**作業内容:**
- 38 行目の `@injectable()` デコレーターを削除

**受け入れ基準:**
- デコレーターが削除され、`export class SubIssueManager` の直前に何も存在しないこと

---

#### タスク 2: tsyringe インポートの削除

**ファイル:** `src/integrations/github/sub-issues.ts`

**作業内容:**
- 4 行目の `import { injectable } from 'tsyringe';` を削除

**受け入れ基準:**
- tsyringe のインポート文が削除されていること
- ファイル内に tsyringe への参照が存在しないこと

---

#### タスク 3: イベントハンドラー登録の検証

**作業内容:**
- デバッグモードで仕様書作成コマンドを実行
- イベントハンドラー登録時にエラーが発生しないことを確認

**検証コマンド:**
```bash
DEBUG=1 npx tsx .cc-craft-kit/commands/spec/create.ts "テスト仕様書" "GitHub Issue自動作成テスト"
```

**受け入れ基準:**
- `Failed to register handlers: Error: tsyringe requires a reflect polyfill.` エラーが出力されないこと
- イベントハンドラーが正常に登録されること

---

#### タスク 4: GitHub Issue 自動作成の検証

**作業内容:**
- 実際に仕様書を作成して GitHub Issue が自動作成されることを確認

**検証コマンド:**
```bash
/cft:spec-create "GitHub統合テスト" "Issue自動作成のテスト"
```

**受け入れ基準:**
- GitHub Issue が自動作成されること
- コンソールに `✓ GitHub Issue created automatically: #<number>` が表示されること
- GitHub Projects にアイテムが追加されること
- https://github.com/B16B1RD/takumi/issues で Issue が確認できること

---

#### タスク 5: テストスイートの実行

**作業内容:**
- 既存のテストスイートを実行して、すべてパスすることを確認

**検証コマンド:**
```bash
npm test
```

**受け入れ基準:**
- すべてのテストがパスすること
- 型エラーが発生しないこと（`npx tsc --noEmit`）
- ESLint 警告が発生しないこと（`npm run lint`）

---

### 実装順序

1. **タスク 1** → **タスク 2**: コード修正（`src/integrations/github/sub-issues.ts`）
2. **タスク 3**: イベントハンドラー登録の検証
3. **タスク 4**: GitHub Issue 自動作成の E2E テスト
4. **タスク 5**: テストスイート実行

### 依存関係

- タスク 1 とタスク 2 は並行実行可能（同一ファイルの異なる行）
- タスク 3 はタスク 1, 2 完了後に実行
- タスク 4 はタスク 3 完了後に実行
- タスク 5 はタスク 4 完了後に実行

---