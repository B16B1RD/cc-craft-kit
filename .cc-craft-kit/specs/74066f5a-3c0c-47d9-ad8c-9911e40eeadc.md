# /cft:status でデータベース整合性の警告が表示される

**仕様書 ID:** 74066f5a-3c0c-47d9-ad8c-9911e40eeadc
**フェーズ:** design
**作成日時:** 2025/11/21 22:23:27
**更新日時:** 2025/11/21 22:34:59

---

## 1. 背景と目的

### 背景

`/cft:status` コマンド実行時に以下の警告が表示される問題が発生しています。

```
⚠️  Database integrity warnings:
  - Found 2 spec file(s) not registered in database
```

開発キットを通してしか仕様書や Issue は作成していないため、本来このような警告は発生しないはずです。可能性としては、別ブランチにあるはずのものを考慮していないか、開発キットの処理漏れにより本当に整合性不一致が起きているかが考えられます。

### 調査結果

#### 問題のファイル

以下の 2 つの仕様書ファイルが「DB に登録されていない」として誤検知されています:

1. `2507c382-628a-4fa9-bfad-41e1951d9292.md` - "GitHub Issue の重複作成を防止する仕組みの実装" (develop ブランチ)
2. `2572db2e-b86c-46b2-8116-c72f46150252.md` - "completed フェーズ移行時に予期しないブランチが作成されるバグを修正" (develop ブランチ)

#### データベースレコードの状態

```sql
SELECT id, name, branch_name FROM specs WHERE id IN ('2507c382...', '2572db2e...');

-- 結果: 両方とも branch_name='develop' として正しく登録されている
```

#### 根本原因

整合性チェックのロジック (`src/core/validators/database-integrity-checker.ts`) に**ブランチフィルタリングの不整合**があります:

1. **186-188行目**: 許可リスト `allowedBranches = [currentBranch, 'main', 'develop']` を作成
2. **204-210行目**: **「ファイルはあるがDBレコードがない」チェック**で、**ファイル側のブランチを考慮していない**
3. **213-229行目**:「DB レコードはあるがファイルがない」チェックでは、219 行で `if (!allowedBranches.includes(branch_name))` によりブランチフィルタリングを適用

**問題の詳細:**

現在のブランチが `feature/spec-74066f5a-fix-database-integrity-warnings` の場合:
- `develop` ブランチで作成された仕様書ファイルが `.cc-craft-kit/specs/` に存在
- データベースには `develop` ブランチとして正しく登録されている
- しかし、整合性チェックの 204-210 行目で、**ファイル側のブランチを考慮せず**、すべてのファイルを「DB に登録されていない」と誤判定

**なぜ repair-database.ts が一時的に成功するのか:**

修復スクリプトはデータベースレコードを見つけて `[UPDATE]` または `[ADD]` で同期するため、実際にはレコードが存在していても「修復」として処理されます。しかし、次回の整合性チェックでは再び同じ警告が出ます。

### 目的

整合性チェックのロジックに**ファイル側のブランチフィルタリング**を追加し、別ブランチで作成された仕様書ファイルを誤検知しないようにすることで、正確なデータベース整合性チェックを実現します。

---

## 2. 対象ユーザー

- cc-craft-kit を使用するすべての開発者
- 特に、複数のブランチで作業している開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `src/core/validators/database-integrity-checker.ts` の 204-210 行目に、ファイル側のブランチフィルタリングを追加する
- [ ] 別ブランチで作成された仕様書ファイルが誤検知されないことを確認する
- [ ] 現在のブランチ、`main`、`develop` ブランチで作成された仕様書ファイルは正常に検出される

### 機能要件

- [ ] データベースレコードから `branch_name` を取得し、ブランチフィルタリングを適用する
- [ ] `checkDatabaseIntegrity` 関数の 204-210 行目に、`allowedBranches` によるフィルタリングを追加
- [ ] 別ブランチのファイルは `missingInDb` に含めず、スキップする

### 非機能要件

- [ ] 既存のテストがすべてパスすること
- [ ] 以下のテストケースを追加し、ブランチフィルタリングが正しく動作することを検証:
  - **Case 1**: 現在のブランチが `feature/test` の場合、`develop` ブランチで作成された仕様書ファイルが誤検知されないこと
  - **Case 2**: 現在のブランチが `develop` の場合、`feature/test` ブランチで作成された仕様書ファイルが誤検知されないこと
  - **Case 3**: 現在のブランチが `feature/test` の場合、`main` および `develop` ブランチで作成された仕様書ファイルは正常に検出されること
  - **Case 4**: データベースレコードが存在しない真の不整合ファイルは、ブランチに関係なく検出されること
- [ ] パフォーマンスに影響を与えないこと
  - ファイルスキャンの実行時間が修正前と比較して 10% 以上増加しないこと
  - 100 個の仕様書ファイルをスキャンした場合でも、1 秒以内に完了すること

---

## 4. 制約条件

### 技術的制約

- データベースレコードに `branch_name` フィールドが存在しない場合（NULL）の後方互換性を保つ
  - `branch_name` が NULL の場合は、現在のブランチで作成されたものとみなし、誤検知しない
- Git リポジトリが初期化されていない環境でもエラーにならないこと

### 設計制約

- 既存の `parseSpecFile` および `validateMetadata` 関数のインターフェースを変更しない
- `SpecMetadata` 型に `branch_name` フィールドを追加する必要がある場合は、オプショナルプロパティとする

---

## 5. 依存関係

### 依存するコンポーネント

- `src/core/validators/spec-file-validator.ts` - 仕様書ファイルのパース処理
- `src/core/git/branch-cache.ts` - 現在のブランチ名の取得
- `src/commands/spec/create.ts` - 仕様書作成時にファイルに `branch_name` を記録する処理

### 関連する仕様書

- `7d86e424-19dc-4820-84c5-f7cb4aea9ac3.md` - "整合性チェックが別ブランチの仕様書を誤検知する問題を修正" (completed)
  - **前回の修正内容**: `src/core/validators/database-integrity-checker.ts:213-229` で、「DB レコードはあるがファイルがない」チェックにブランチフィルタリングを追加
  - **本仕様書との関連**: 前回の修正では DB 側のみで、ファイル側（204-210 行目）のフィルタリングが不足していたため、本仕様書で追加修正を実施
  - **実装時の注意**: 213-229 行目のロジックを参考にして、204-210 行目にも同様のブランチフィルタリングを追加すること

---

## 6. 参考情報

### コードの場所

- `src/core/validators/database-integrity-checker.ts:204-210` - 修正が必要な箇所
- `src/core/validators/spec-file-validator.ts` - パース処理の実装
- `tests/core/validators/database-integrity-checker.test.ts` - テストケースの追加先

### 関連ドキュメント

- `CLAUDE.md` - ブランチ管理の仕様
- `docs/ARCHITECTURE.md` - アーキテクチャ設計

### 現在の仕様書ファイルフォーマットの確認

現在の仕様書ファイル（`.cc-craft-kit/specs/*.md`）には、メタデータとして以下のフィールドが含まれています:

- `仕様書 ID`
- `フェーズ`
- `作成日時`
- `更新日時`

**ブランチ名は現在記録されていません。**

そのため、アプローチ 1 を実装する場合は、以下の作業が必要です:

1. 仕様書ファイルフォーマットに `ブランチ名` フィールドを追加
2. `src/commands/spec/create.ts` で仕様書作成時にブランチ名を記録
3. 既存の仕様書ファイルへの後方互換性を考慮（ブランチ名がない場合は警告せず、スキップ）

### 解決策の概要

**アプローチ1: 仕様書ファイルにブランチ名を記録する**

1. `src/commands/spec/create.ts` で仕様書作成時に `branch_name` をファイルのメタデータに記録
2. `src/core/validators/spec-file-validator.ts` でパース時に `branch_name` を取得
3. `src/core/validators/database-integrity-checker.ts` の 204-210 行目で、ファイルの `branch_name` が `allowedBranches` に含まれない場合はスキップ

**アプローチ2: データベースレコードとの突合せでフィルタリング（推奨）**

1. 204-210 行目で、`dbRecordMap` を参照してファイル ID に対応するレコードが存在するか確認
2. レコードが存在し、かつ `branch_name` が `allowedBranches` に含まれない場合はスキップ
3. ファイルにメタデータを追加する必要がないため、実装が簡単

**推奨: アプローチ2を採用**

理由:
- ファイル形式の変更が不要（後方互換性が保たれる）
- 実装が簡単で、影響範囲が小さい
- データベースレコードが正しい場合にのみ動作するため、データ整合性が高い

### アプローチ2の実装詳細

以下のロジックで実装します:

**1. 183行目の直後に、ブランチ情報を含むマップを作成**

現在の実装では、`dbRecordMap` は `Map<string, string>` (ID → name) のみを保持していますが、ブランチ情報も必要なため、以下のように変更します。

```typescript
// 3. データベースレコードの取得
const dbRecords = await db.selectFrom('specs').select(['id', 'name', 'branch_name']).execute();
const dbRecordMap = new Map(dbRecords.map((r) => [r.id, r])); // { id, name, branch_name } を保持
```

**2. 204-210行目のロジックを修正**

```typescript
// 4. 整合性チェック
// 4-1. ファイルはあるがDBレコードがない（ブランチフィルタリング適用）
for (const [id, metadata] of fileMetadataMap) {
  const dbRecord = dbRecordMap.get(id);

  // データベースレコードが存在し、かつブランチが許可リストに含まれない場合はスキップ
  if (dbRecord && !allowedBranches.includes(dbRecord.branch_name)) {
    continue; // 別ブランチの仕様書なのでスキップ
  }

  // データベースレコードが存在しない場合は、本当にDBに登録されていない
  if (!dbRecord) {
    missingInDb.push({
      filePath: join(specsDir, `${id}.md`),
      metadata,
    });
  }
}
```

**3. ロジックの意図**

- データベースレコードが存在し、かつブランチが許可リストに含まれない場合 → 別ブランチの仕様書なのでスキップ
- データベースレコードが存在しない場合 → 本当に DB に登録されていないので `missingInDb` に追加
- データベースレコードが存在し、かつブランチが許可リストに含まれる場合 → 正常なので何もしない

### 実装チェックリスト

以下の順序で実装を進めてください:

1. [ ] `src/core/validators/database-integrity-checker.ts:183-210` の修正
   - `dbRecordMap` の構造を変更（ID → name から ID → { id, name, branch_name } へ）
   - 204-210 行目にブランチフィルタリングを追加

2. [ ] テストケースの追加
   - `tests/core/validators/database-integrity-checker.test.ts` に 4 つのテストケースを追加

3. [ ] 既存テストの実行
   - `npm test` で既存のテストがすべてパスすることを確認

4. [ ] 実際の環境での検証
   - `/cft:status` を実行し、警告が出ないことを確認
   - 複数のブランチで仕様書を作成し、整合性チェックが正しく動作することを確認

5. [ ] パフォーマンステスト
   - 100 個の仕様書ファイルをスキャンし、実行時間が 1 秒以内であることを確認

6. [ ] コードレビュー
   - `/cft:code-review` で最終チェック


---

## 7. 変更履歴

| 日時 | 変更内容 | 変更者 |
|---|---|---|
| 2025/11/21 22:23:27 | 初版作成 | Claude |
| 2025/11/21 22:30:00 | code-reviewer サブエージェントのレビュー結果を反映 | Claude |

