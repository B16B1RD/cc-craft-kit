---
id: "ad40f55a-7b2e-42ba-a380-d12c72f2e820"
name: "/cft:status コマンドの処理改善"
phase: "design"
branch_name: "fix/spec-ad40f55a-improve-status-command"
github_issue_number: null
pr_url: null
created_at: "2025-12-06T09:30:00.000Z"
updated_at: "2025-12-06T10:15:00.000Z"
---

# /cft:status コマンドの処理改善

## 1. 背景と目的

### 背景

`/cft:status` コマンド実行時に複数の問題が発生している：

1. **Bash の for/while ループが正しく動作しない**
   - `for file in .cc-craft-kit/specs/*.md; do head -10 "$file" ...` のようなループで、空文字列がファイル名として渡されエラーが大量発生
   - `head: '' を 読み込み用に開くことが出来ません` というエラーが大量に出力される
   - Claude Code の Bash ツールがシェルの for ループを正しく展開できない制限がある

2. **grep の誤検出**
   - `grep -l 'phase: "implementation"'` がファイル全体を検索するため、YAML フロントマター以外の本文中の文字列も検出
   - 例：030af17a（実際は completed）が implementation として誤検出された

3. **確認の問い合わせが多い**
   - 処理中に何度も確認が求められて煩わしい
   - 複雑な処理フロー（27 ステップ）が原因

4. **--verbose オプションの参照先が存在しない**
   - `.cc-craft-kit/meta/` ディレクトリは存在しない

### 目的

`/cft:status` コマンドを改善し、エラーなく高速に実行できるようにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] Bash ループのエラーが発生しない
- [ ] フェーズの集計が正確（本文の誤検出がない）
- [ ] 他ブランチの仕様書も正しく収集できる
- [ ] 処理中の確認ダイアログが最小限になる

### 機能要件

- [ ] --verbose オプションを削除
- [ ] Grep ツールを使用した行頭マッチでフェーズを集計
- [ ] 並列実行可能な操作を明示
- [ ] 処理フローを 5 ステップに簡略化

### 非機能要件

- [ ] 処理時間が現行より短縮される
- [ ] エラーメッセージが表示されない

---

## 4. 制約条件

- Claude Code の Bash ツールでは for/while ループが正しく動作しない
- grep はファイル全体を検索対象にするため、行頭マッチが必要
- 他ブランチの仕様書収集は必須（未完了仕様書は他ブランチにあることが多い）

---

## 5. 依存関係

- `.claude/commands/cft/status.md` のみを修正
- 他のスラッシュコマンドへの影響なし

---

## 6. 参考情報

- 問題発生時の会話ログ（本チケット作成時に分析済み）
- 計画ファイル: `/home/autum/.claude/plans/glowing-snacking-spindle.md`

---

## 7. 設計詳細

### 7.1 問題の根本原因

| 問題 | 根本原因 |
|------|----------|
| Bash for ループエラー | Claude Code の Bash ツールがシェルの for/while ループを正しく展開できない |
| grep 誤検出 | ファイル全体を検索対象にしているため、本文中の文字列も検出 |
| 確認ダイアログ多発 | 27 ステップの複雑な処理フローで多数のツール呼び出し |
| --verbose エラー | 参照先 `.cc-craft-kit/meta/` ディレクトリが存在しない |

### 7.2 解決アプローチ

1. **Bash ループ回避**: for/while ループを使わず、各ブランチ・ファイルに対して個別のツール呼び出し
2. **Grep ツール活用**: 行頭マッチ `^phase: "..."$` で YAML フロントマターのみを対象
3. **処理フロー簡略化**: 27 ステップ → 5 ステップに削減
4. **--verbose 削除**: 存在しないディレクトリへの参照を削除

### 7.3 新しい処理フロー

```
Step 1: 基本情報の取得（並列実行可能）
├─ Read: .cc-craft-kit/config.json
├─ Glob: .cc-craft-kit/specs/*.md
├─ Bash: git branch --show-current
└─ Bash: git for-each-ref --format='%(refname:short)' refs/heads/ | grep 'spec-'

Step 2: 現在ブランチの仕様書を集計（並列実行可能）
├─ Grep: ^phase: "requirements"$
├─ Grep: ^phase: "design"$
├─ Grep: ^phase: "implementation"$
├─ Grep: ^phase: "review"$
└─ Grep: ^phase: "completed"$ (count)

Step 3: 他ブランチの仕様書を取得
├─ 各ブランチについて git ls-tree でファイル一覧取得
└─ 各ファイルについて git show | head -15 で YAML フロントマター取得

Step 4: GitHub 連携状態の確認
└─ gh repo view で確認

Step 5: 結果の表示
└─ 指定フォーマットで出力
```

### 7.4 Grep パターン仕様

| フェーズ | パターン | output_mode |
|----------|----------|-------------|
| requirements | `^phase: "requirements"$` | files_with_matches |
| design | `^phase: "design"$` | files_with_matches |
| implementation | `^phase: "implementation"$` | files_with_matches |
| review | `^phase: "review"$` | files_with_matches |
| completed | `^phase: "completed"$` | count |

### 7.5 他ブランチ収集の制約

- Bash の for ループは使用禁止
- 各ブランチに対して個別に `git ls-tree` を実行
- 各ファイルに対して個別に `git show` を実行
- 重複排除: 同じ ID の仕様書は `updated_at` が新しい方を採用

---

## 8. 実装タスクリスト

- [ ] --verbose オプションと関連セクション（Step V1, V2）を削除
- [ ] 引数説明から --verbose を削除
- [ ] Step 1.5 のサブステップを Step 1〜3 に再構成
- [ ] Bash for/while ループを個別ツール呼び出しに変更
- [ ] Grep ツールの使用を明示（行頭マッチパターン）
- [ ] 並列実行可能な操作を明示
- [ ] 出力フォーマットを維持しつつ処理フローを簡略化
