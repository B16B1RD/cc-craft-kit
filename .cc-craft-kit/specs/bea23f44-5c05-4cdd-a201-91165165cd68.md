# completed 時の自動 PR 作成でエラーが発生する

**仕様書 ID:** bea23f44-5c05-4cdd-a201-91165165cd68
**フェーズ:** completed
**作成日時:** 2025/11/22 12:25:17
**更新日時:** 2025/11/22 13:05:19

---

## 1. 背景と目的

### 背景

**問題の症状:**

completed フェーズ移行時 (`/cft:spec-phase <spec-id> completed`) に、以下の警告メッセージが表示される。

> ⚠️ Failed to create pull request
>
> Please create a PR manually

しかし、実際には以下の動作が確認されている。

1. 上記の警告メッセージが表示される
2. その直後、PR 作成が成功し、以下のメッセージが表示される

   ```text
   ✓ Pull request created: https://github.com/owner/repo/pull/123
   ```

**矛盾点:**

- エラーメッセージが表示されているにもかかわらず、PR 作成は成功している
- GitHub クライアントは正常に初期化されているため、「未初期化」というエラーメッセージは不正確

**想定される原因:**

1. `branch-management.ts:143` の catch ブロックで、すべてのエラーに対して一律のメッセージを表示している
2. `createPullRequest()` のエラーハンドリングで、例外を throw せず `{ success: false, error: ... }` を返すため、catch ブロックに到達しない
3. `branch-management.ts:131-133` の条件分岐で、`result.success === false` の場合に警告メッセージを表示する。その後も処理は継続される可能性がある

### 目的

completed フェーズ移行時に、誤った「GitHub クライアント未初期化」エラーメッセージが表示される問題を解決し、正しいエラーハンドリングとユーザーへのフィードバックを実現する。

---

## 2. 対象ユーザー

- cc-craft-kit を使用してフェーズ駆動開発を行う開発者
- completed フェーズ移行時に自動 PR 作成機能を利用するユーザー

---

## 3. 受け入れ基準

### 必須要件

- [ ] completed フェーズ移行時に、GitHub クライアント未初期化の場合は適切なエラーメッセージが表示される
- [ ] GitHub クライアントが正常に初期化されている場合は、誤ったエラーメッセージが表示されない
- [ ] PR 作成が成功した場合、成功メッセージのみが表示される

### 機能要件

- [ ] `createPullRequest()` のエラーハンドリングで、"GitHub client not initialized" エラーを正しく判定できる
- [ ] PR 作成失敗時のエラーメッセージは、失敗原因を明確に示す
- [ ] GitHub クライアント初期化状態を事前チェックする機能を実装する

### 非機能要件

- [ ] PR 作成失敗時でも、フェーズ変更は完了する（現行の動作を維持）
- [ ] エラーログに十分な情報が記録される（デバッグ可能な状態）
- [ ] ユーザーへのエラーメッセージは、次のアクションを明示する

---

## 4. 制約条件

- GitHub クライアント初期化は `/cft:github-init` コマンドで事前に実行されている必要がある
- PR 作成失敗時でも、フェーズ変更は成功させる（既存の動作を維持）
- エラーメッセージの表示ロジックは、`src/core/workflow/branch-management.ts` に実装されている

---

## 5. 依存関係

- `src/core/workflow/branch-management.ts` - PR 自動作成のイベントハンドラー
- `src/integrations/github/pull-request.ts` - PR 作成ロジック
- `src/integrations/github/client.ts` - GitHub クライアント管理
- `src/core/workflow/event-bus.ts` - イベント駆動アーキテクチャの基盤

---

## 6. 参考情報

- `src/core/workflow/branch-management.ts:106-145` - PR 自動作成処理
- `src/integrations/github/pull-request.ts:94-156` - `createPullRequest()` 実装
- `src/integrations/github/client.ts:90-95` - `getGitHubClient()` 実装
- CLAUDE.md - Git 自動コミット機能のドキュメント

---

## 7. 設計

### 7.1. 問題の根本原因

**コードレビュー結果:**

1. **`createPullRequest()` は例外を throw しない**
   - `pull-request.ts:149-155` で try-catch により、すべての例外を `{ success: false, error: ... }` として返却
   - `getGitHubClient()` が throw した例外もキャッチされる

2. **`branch-management.ts:131-133` の警告メッセージ**
   - `result.success === false` の場合、警告メッセージを表示
   - しかし、この警告メッセージには `result.error` の内容が含まれていない
   - ユーザーはエラーの詳細を確認できない

3. **`branch-management.ts:134-145` の catch ブロック**
   - `createPullRequest()` は例外を throw しないため、このブロックには到達しない
   - 到達するのは、データベースエラーなど別の例外が発生した場合のみ

4. **エラーメッセージと実際の動作の矛盾**
   - ユーザーが報告した「エラーメッセージ表示後に PR 作成成功」は、以下のシナリオで発生する可能性がある：
     - `createPullRequest()` が最初 `{ success: false }` を返す（警告表示）
     - その後、何らかの理由で再度実行され成功する
   - しかし、現在のコードではこのような再実行ロジックは存在しない

**結論:**

ユーザーが報告した問題は、以下の原因により発生している。

- `result.error` の内容が表示されないため、エラーの詳細が不明
- GitHub クライアント未初期化エラーと他のエラーが区別されない
- エラーログに十分な情報が記録されない

### 7.2. 解決策の設計

#### 7.2.1. エラーメッセージの改善

**変更対象:** `src/core/workflow/branch-management.ts:131-133`

**Before:**

```typescript
console.warn('\n⚠️  Failed to create pull request:', result.error);
console.warn('   Please create a PR manually\n');
```

**After:**

```typescript
console.warn('\n⚠️  Failed to create pull request');

// エラー原因を詳細に表示
if (result.error) {
  console.warn(`   Reason: ${result.error}`);
}

// エラーの種類に応じた案内を表示
if (result.error?.includes('not initialized')) {
  console.warn('   Please run: /cft:github-init <owner> <repo>');
} else if (result.error?.includes('Repository owner or name not found')) {
  console.warn('   Please set GITHUB_OWNER and GITHUB_REPO in .env');
} else {
  console.warn('   Please create a PR manually\n');
}
```

#### 7.2.2. GitHub クライアント初期化の事前チェック

**変更対象:** `src/core/workflow/branch-management.ts:106` の前に追加。

**追加コード:**

```typescript
// GitHub クライアント初期化状態を事前チェック
try {
  getGitHubClient();
} catch (error) {
  console.warn('\n⚠️  GitHub client not initialized');
  console.warn('   Please run: /cft:github-init <owner> <repo>');
  console.warn('   Skipping automatic PR creation\n');
  return; // PR作成をスキップ
}
```

**効果:**

- GitHub クライアント未初期化の場合、`createPullRequest()` を呼び出す前に検出できる
- 適切なエラーメッセージと次のアクションを表示できる
- 無駄な処理を削減できる

#### 7.2.3. エラーログの強化

**変更対象:** `src/integrations/github/pull-request.ts:149-155`

**Before:**

```typescript
} catch (error) {
  const errorMessage = error instanceof Error ? error.message : String(error);
  return {
    success: false,
    error: errorMessage,
  };
}
```

**After:**

```typescript
} catch (error) {
  const errorMessage = error instanceof Error ? error.message : String(error);

  // エラーログを記録
  const errorHandler = getErrorHandler();
  const errorObj = error instanceof Error ? error : new Error(String(error));
  await errorHandler.handle(errorObj, {
    event: 'github.pr_create_failed',
    specId: options.specId,
    branchName: options.branchName,
    baseBranch: options.baseBranch || 'develop',
  });

  return {
    success: false,
    error: errorMessage,
  };
}
```

**効果:**

- PR 作成失敗時のエラーログが記録される
- デバッグ時に詳細な情報を確認できる

### 7.3. データフロー

```text
[spec.phase_changed イベント発火]
         |
         v
[handleCompletedPhaseChange() 実行]
         |
         v
[GitHub クライアント初期化チェック] ← 新規追加
         |
    OK   |   NG
         |   |
         |   v
         |   [警告メッセージ表示]
         |   [処理をスキップ]
         |
         v
[createPullRequest() 呼び出し]
         |
    成功  |   失敗
         |   |
         |   v
         |   [エラーログ記録] ← 強化
         |   [詳細なエラーメッセージ表示] ← 改善
         |
         v
[PR URL を Issue に記録]
         |
         v
[github_sync テーブル更新]
```

### 7.4. エラーメッセージ仕様

| エラー種別 | エラーメッセージ | 次のアクション案内 |
|---|---|---|
| GitHub クライアント未初期化 | `⚠️ GitHub client not initialized` | `Please run: /cft:github-init <owner> <repo>` |
| リポジトリ情報不足 | `⚠️ Repository owner or name not found` | `Please set GITHUB_OWNER and GITHUB_REPO in .env` |
| その他のエラー | `⚠️ Failed to create pull request` + 詳細 | `Please create a PR manually` |

### 7.5. テスト戦略

#### 7.5.1. 単体テスト

**テストケース:**

1. **GitHub クライアント未初期化の場合**
   - `getGitHubClient()` が例外を throw
   - 適切なエラーメッセージが表示される
   - `createPullRequest()` が呼び出されない

2. **リポジトリ情報不足の場合**
   - `createPullRequest()` が `{ success: false, error: "Repository owner or name not found" }` を返す
   - 適切なエラーメッセージが表示される

3. **PR 作成成功の場合**
   - `createPullRequest()` が `{ success: true, pullRequestUrl: "...", pullRequestNumber: 123 }` を返す
   - 成功メッセージのみが表示される

#### 7.5.2. E2E テスト

**シナリオ:**

1. completed フェーズ移行時、GitHub クライアント未初期化でエラーメッセージが表示される
2. `/cft:github-init` でクライアントを初期化後、再度 completed フェーズ移行時に PR が作成される

### 7.6. 実装方針

1. **エラーメッセージの改善** - 最優先
   - `branch-management.ts:131-133` を修正
   - `result.error` の内容を詳細に表示
   - エラー種別に応じた案内を追加

2. **GitHub クライアント初期化の事前チェック** - 高優先度
   - `branch-management.ts:106` の前に追加
   - `getGitHubClient()` を呼び出して初期化状態を確認

3. **エラーログの強化** - 中優先度
   - `pull-request.ts:149-155` を修正
   - エラーハンドラーでログを記録

4. **テストの追加** - 低優先度
   - 単体テストと E2E テストを実装

---

## 8. 実装タスクリスト

### 8.1. エラーメッセージの改善（最優先）

**対象ファイル:** `src/core/workflow/branch-management.ts`

**タスク:**

1. `branch-management.ts:131-133` の警告メッセージを修正
   - `result.error` の内容を詳細に表示
   - エラー種別に応じた案内を追加（GitHub クライアント未初期化、リポジトリ情報不足、その他）

**受け入れ基準:**

- [ ] PR 作成失敗時に、エラーの詳細が表示される
- [ ] エラー種別に応じた次のアクション案内が表示される
- [ ] GitHub クライアント未初期化エラーと他のエラーが区別される

### 8.2. GitHub クライアント初期化の事前チェック（高優先度）

**対象ファイル:** `src/core/workflow/branch-management.ts`

**タスク:**

1. `branch-management.ts:106` の前に、GitHub クライアント初期化チェックを追加
   - `getGitHubClient()` を呼び出して初期化状態を確認
   - 未初期化の場合は警告メッセージを表示し、処理をスキップ

**受け入れ基準:**

- [ ] GitHub クライアント未初期化の場合、`createPullRequest()` を呼び出さない
- [ ] 適切なエラーメッセージと次のアクション案内が表示される

### 8.3. エラーログの強化（中優先度）

**対象ファイル:** `src/integrations/github/pull-request.ts`

**タスク:**

1. `pull-request.ts:149-155` の catch ブロックを修正
   - `getErrorHandler()` でエラーハンドラーを取得
   - `errorHandler.handle()` でエラーログを記録

**受け入れ基準:**

- [ ] PR 作成失敗時にエラーログが記録される
- [ ] エラーログに仕様書 ID、ブランチ名、ベースブランチが含まれる

### 8.4. 単体テストの追加（低優先度）

**対象ファイル:** `tests/core/workflow/branch-management.test.ts`（新規作成）

**タスク:**

1. GitHub クライアント未初期化の場合のテストを追加
2. リポジトリ情報不足の場合のテストを追加
3. PR 作成成功の場合のテストを追加

**受け入れ基準:**

- [ ] 各テストケースが正しく動作する
- [ ] カバレッジが 80% 以上

### 8.5. ドッグフーディング環境への同期（必須）

**タスク:**

1. `npm run sync:dogfood` で `.cc-craft-kit/` へ変更を同期

**受け入れ基準:**

- [ ] `src/` と `.cc-craft-kit/` のファイルハッシュが一致する
