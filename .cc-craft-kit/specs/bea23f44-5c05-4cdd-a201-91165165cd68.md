# completed 時の自動 PR 作成でエラーが発生する

**仕様書 ID:** bea23f44-5c05-4cdd-a201-91165165cd68
**フェーズ:** requirements
**作成日時:** 2025/11/22 12:25:17
**更新日時:** 2025/11/22 12:25:17

---

## 1. 背景と目的

### 背景

**問題の症状:**

completed フェーズ移行時 (`/cft:spec-phase <spec-id> completed`) に、以下の警告メッセージが表示される。

> ⚠️ Failed to create pull request
>
> Please create a PR manually

しかし、実際には以下の動作が確認されている。

1. 上記の警告メッセージが表示される
2. その直後、PR 作成が成功し、以下のメッセージが表示される

   ```text
   ✓ Pull request created: https://github.com/owner/repo/pull/123
   ```

**矛盾点:**

- エラーメッセージが表示されているにもかかわらず、PR 作成は成功している
- GitHub クライアントは正常に初期化されているため、「未初期化」というエラーメッセージは不正確

**想定される原因:**

1. `branch-management.ts:143` の catch ブロックで、すべてのエラーに対して一律のメッセージを表示している
2. `createPullRequest()` のエラーハンドリングで、例外を throw せず `{ success: false, error: ... }` を返すため、catch ブロックに到達しない
3. `branch-management.ts:131-133` の条件分岐で、`result.success === false` の場合に警告メッセージを表示する。その後も処理は継続される可能性がある

### 目的

completed フェーズ移行時に、誤った「GitHub クライアント未初期化」エラーメッセージが表示される問題を解決し、正しいエラーハンドリングとユーザーへのフィードバックを実現する。

---

## 2. 対象ユーザー

- cc-craft-kit を使用してフェーズ駆動開発を行う開発者
- completed フェーズ移行時に自動 PR 作成機能を利用するユーザー

---

## 3. 受け入れ基準

### 必須要件

- [ ] completed フェーズ移行時に、GitHub クライアント未初期化の場合は適切なエラーメッセージが表示される
- [ ] GitHub クライアントが正常に初期化されている場合は、誤ったエラーメッセージが表示されない
- [ ] PR 作成が成功した場合、成功メッセージのみが表示される

### 機能要件

- [ ] `createPullRequest()` のエラーハンドリングで、"GitHub client not initialized" エラーを正しく判定できる
- [ ] PR 作成失敗時のエラーメッセージは、失敗原因を明確に示す
- [ ] GitHub クライアント初期化状態を事前チェックする機能を実装する

### 非機能要件

- [ ] PR 作成失敗時でも、フェーズ変更は完了する（現行の動作を維持）
- [ ] エラーログに十分な情報が記録される（デバッグ可能な状態）
- [ ] ユーザーへのエラーメッセージは、次のアクションを明示する

---

## 4. 制約条件

- GitHub クライアント初期化は `/cft:github-init` コマンドで事前に実行されている必要がある
- PR 作成失敗時でも、フェーズ変更は成功させる（既存の動作を維持）
- エラーメッセージの表示ロジックは、`src/core/workflow/branch-management.ts` に実装されている

---

## 5. 依存関係

- `src/core/workflow/branch-management.ts` - PR 自動作成のイベントハンドラー
- `src/integrations/github/pull-request.ts` - PR 作成ロジック
- `src/integrations/github/client.ts` - GitHub クライアント管理
- `src/core/workflow/event-bus.ts` - イベント駆動アーキテクチャの基盤

---

## 6. 参考情報

- `src/core/workflow/branch-management.ts:106-145` - PR 自動作成処理
- `src/integrations/github/pull-request.ts:94-156` - `createPullRequest()` 実装
- `src/integrations/github/client.ts:90-95` - `getGitHubClient()` 実装
- CLAUDE.md - Git 自動コミット機能のドキュメント
