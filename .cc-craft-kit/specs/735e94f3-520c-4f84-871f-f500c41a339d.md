---
id: "735e94f3-520c-4f84-871f-f500c41a339d"
name: "インストールで失敗する"
phase: "completed"
branch_name: "develop"
github_issue_number: null
pr_url: null
created_at: "2025-12-04T06:13:05.926Z"
updated_at: "2025-12-04 17:56:57"
---

# インストールで失敗する


## 1. 背景と目的

### 背景

以下のようにインストールで失敗します。
$ curl -fsSL https://raw.githubusercontent.com/B16B1RD/cc-craft-kit/main/scripts/install.sh | sh
cc-craft-kit のインストールを開始します...

環境をチェックしています...
✓ 環境チェック完了
GitHub Releases から最新バージョンを取得しています...
✓ 最新バージョン: v0.1.7
アーカイブを . に展開しています...
tar (child): \033[0;34mcc-craft-kit v0.1.7 をダウンロードしています...\033[0m\n\033[0;32m✓ ダウンロード完了\033[0m\n/tmp/tmp.Q2CfYwEHCB: open 不能: そのようなファイルやディレクトリはありません
tar (child): Error is not recoverable: exiting now
tar: Child returned status 2
tar: Error is not recoverable: exiting now
エラー: アーカイブの展開に失敗しました。

### 目的

install.sh スクリプトのバグを修正し、`curl | sh` でのパイプ実行時に正常にインストールが完了するようにする。
---

## 2. 対象ユーザー

cc-craft-kit を新規インストールするユーザー
---

## 3. 受け入れ基準

### 必須要件

- [ ] `curl -fsSL ... | sh` でインストールが正常に完了すること
- [ ] tar 展開時に ANSI エスケープシーケンスがファイル名として解釈されないこと

### 機能要件

- [ ] `download_archive()` 関数が正しいファイルパスのみを返すこと
- [ ] ログ出力（info, success, error）は stderr に出力されること
- [ ] パイプ経由での実行時もカラー表示が正常に動作すること

### 非機能要件

- [ ] 対話的実行（直接実行）時の動作が変更されないこと
- [ ] エラーメッセージが分かりやすいこと
---

## 4. 制約条件

- POSIX sh 互換を維持すること
- 既存のインストールフローを大幅に変更しないこと
- bash, zsh, sh などの主要シェルで動作すること
---

## 5. 依存関係

- `scripts/install.sh` - メインのインストールスクリプト
- 前回の修正 PR #619（アーカイブ構造問題）との整合性
---

## 6. 参考情報

- 関連仕様書: `7771d1e1-fea7-4631-b4b9-3a5fa07e4fbc`（インストーラーでエラー - completed）
- 問題の原因: `download_archive()` 関数内の `info()` 出力が stdout にも出力され、関数の戻り値キャプチャ時に ANSI エスケープシーケンスが混入している
---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
install.sh
├── 出力関数層
│   ├── error()   → stderr（現状 OK）
│   ├── warn()    → stderr（現状 OK）
│   ├── info()    → stdout ⚠️ 問題あり
│   └── success() → stdout ⚠️ 問題あり
│
├── 機能関数層
│   ├── check_prerequisites()
│   ├── fetch_latest_version()
│   ├── download_archive()  ← 戻り値キャプチャで問題発生
│   ├── extract_archive()
│   └── verify_installation()
│
└── main()
    └── ARCHIVE_FILE=$(download_archive) ← ANSIコード混入
```

#### 設計方針

POSIX シェル規約に準拠し、情報・成功メッセージを stderr に出力するよう変更する。

- **info()**: stdout → stderr へリダイレクト
- **success()**: stdout → stderr へリダイレクト

この変更により、関数の戻り値キャプチャ時に ANSI エスケープシーケンスが混入しなくなる。

#### 処理フロー詳細

```
パイプ実行時: curl -fsSL ... | sh
                    ↓
              main() 実行
                    ↓
         download_archive() 呼び出し
                    ↓
    ┌─────────────────────────────────────┐
    │  info() 出力: stderr へ (修正後)    │
    │  curl でダウンロード                │
    │  success() 出力: stderr へ (修正後) │
    │  echo "$TEMP_FILE": stdout のみ     │
    └─────────────────────────────────────┘
                    ↓
    ARCHIVE_FILE = "/tmp/tmp.XXXXXX" (純粋なパス)
                    ↓
         extract_archive() 成功
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| scripts/install.sh:49-51 | info() 関数を stderr 出力に変更 |
| scripts/install.sh:54-56 | success() 関数を stderr 出力に変更 |

#### 修正内容

**info() 関数（49-51行）:**
```bash
# 変更前
info() {
  printf "${BLUE}%s${NC}\n" "$1"
}

# 変更後
info() {
  printf "${BLUE}%s${NC}\n" "$1" >&2
}
```

**success() 関数（54-56行）:**
```bash
# 変更前
success() {
  printf "${GREEN}✓ %s${NC}\n" "$1"
}

# 変更後
success() {
  printf "${GREEN}✓ %s${NC}\n" "$1" >&2
}
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| info ログ出力 | stdout | stderr | install.sh:49-51 |
| success ログ出力 | stdout | stderr | install.sh:54-56 |
| download_archive 戻り値 | ANSIコード混入 | 純粋なパス | 自動的に解決 |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| パイプ実行 | インストール成功 | `curl -fsSL ... \| sh` |
| 直接実行 | インストール成功 | `sh scripts/install.sh` |
| カラー表示 | stderr でカラー表示 | 目視確認 |
| 戻り値 | ANSIコード未混入 | `TEMP=$(download_archive); echo "$TEMP"` |

### 7.5 移行計画

#### Phase 1: 出力関数の修正

1. info() 関数を stderr 出力に変更
2. success() 関数を stderr 出力に変更

#### Phase 2: 動作検証

1. パイプ実行でインストールが完了することを確認
2. 直接実行でインストールが完了することを確認
3. カラー表示が正常に動作することを確認
---

## 8. 実装タスクリスト

### Phase 1: 出力関数の修正

- [x] info() 関数を stderr 出力に変更 (#657)
- [x] success() 関数を stderr 出力に変更 (#658)

### Phase 2: 動作検証

- [x] パイプ実行でインストール成功を確認 (#659)
- [x] 直接実行でインストール成功を確認 (#660)
---

## Pull Request

- https://github.com/B16B1RD/cc-craft-kit/pull/661
