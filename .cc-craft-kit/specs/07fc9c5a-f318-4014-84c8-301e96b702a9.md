# /cft:spec-create 時自動コミットされない

**仕様書 ID:** 07fc9c5a-f318-4014-84c8-301e96b702a9
**フェーズ:** requirements
**作成日時:** 2025/11/21 20:50:49
**更新日時:** 2025/11/21 20:50:49

---

## 1. 背景と目的

### 背景

現在、`/cft:spec-create` コマンドで仕様書を作成した際、以下の問題が発生しています。

1. **Git 自動コミットが実行されない**
   - `/cft:spec-phase` コマンドでフェーズ移行時は Git 自動コミットが実行される
   - しかし、`/cft:spec-create` コマンドでは自動コミットが実行されない
   - ユーザーが手動で `git add` と `git commit` を実行する必要がある

2. **一貫性のないユーザー体験**
   - フェーズ移行時は自動コミットされるのに、仕様書作成時は手動コミットが必要
   - この非一貫性により、ユーザー混乱の可能性がある

3. **コミット漏れのリスク**
   - 手動コミットを忘れると、仕様書ファイルがコミットされず、データベース不整合の原因になる

### 目的

`/cft:spec-create` コマンド実行時に、仕様書ファイルを自動的に Git コミットし、フェーズ移行時と一貫したユーザー体験を提供する。

---

## 2. 対象ユーザー

- **cc-craft-kit 開発者** - 仕様書を作成するすべてのユーザー
- **プロジェクト管理者** - Git リポジトリの整合性を維持したいユーザー

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-create` コマンド実行時に、仕様書ファイルが自動的に Git コミットされる
- [ ] コミットメッセージが適切な形式で生成される（`feat: <仕様書名> の要件定義を完了`）
- [ ] 既存の `/cft:spec-phase` コマンドの自動コミット機能と同じロジックを使用する

### 機能要件

- [ ] 仕様書の作成が完了後、`spec.created` イベントが発火される
- [ ] Git 統合ハンドラーが `spec.created` イベントをリッスンし、自動コミットを実行する
- [ ] コミットメッセージに仕様書名が含まれる
- [ ] コミット成功/失敗のログが記録される
- [ ] Git リポジトリが初期化されていない場合は、警告のみ表示してスキップする

### 非機能要件

- [ ] 既存のテストケースが全て通過する
- [ ] 新しい自動コミット機能のテストケースを追加する
- [ ] パフォーマンスへの影響がない（コミット処理は非同期で実行）

---

## 4. 制約条件

- 既存の Git 統合ハンドラーのロジックを再利用する（重複実装を避ける）
- `spec.created` イベントが既に発火されていることが前提（実装確認が必要）
- Git リポジトリが初期化されていない環境でもエラーにならない
- pre-commit フックが失敗した場合でも、仕様書の作成自体は成功する

### エラーメッセージ仕様

| 状況 | メッセージ | ログレベル |
|---|---|---|
| Git 未初期化 | "⚠️ Git リポジトリが初期化されていません。手動でコミットしてください。" | warn |
| pre-commit フック失敗 | "⚠️ Git コミットに失敗しました。pre-commit フックを確認してください。" | warn |
| Git コマンドエラー | "❌ Git コミット中にエラーが発生しました" | error |
| コミット成功 | "✅ 仕様書ファイルを Git コミットしました" | info |

---

## 5. 依存関係

**既存コンポーネント:**

- `src/commands/spec/create.ts` - `/cft:spec-create` コマンド実装
- `src/core/workflow/git-integration.ts` - Git 統合ハンドラー
- `src/core/workflow/event-bus.ts` - イベントバス（`spec.created` イベント）
- `src/core/events/types.ts` - イベント型定義

**関連仕様:**

- Git 自動コミット機能（`CLAUDE.md` セクション: Git 自動コミット機能）

---

## 6. 参考情報

**関連実装:**

- `src/core/workflow/git-integration.ts:1-100` - 既存の Git 自動コミット実装
- `src/commands/spec/create.ts:100-200` - 仕様書作成ロジック

**関連ドキュメント:**

- `CLAUDE.md` - Git 自動コミット機能の仕様

**現在の動作:**

- `/cft:spec-phase` コマンドでフェーズ移行時は、`spec.phase_changed` イベントが発火され、Git 統合ハンドラーが自動コミットを実行
- `/cft:spec-create` コマンドでは、`spec.created` イベントが発火されるが、Git 統合ハンドラーがこのイベントをリッスンしていない可能性がある

**確認が必要な実装:**

1. `src/commands/spec/create.ts` で `spec.created` イベントが発火されているか
2. `src/core/workflow/git-integration.ts` で `spec.created` イベントのハンドラーが登録されているか
3. 登録されていない場合は、ハンドラーを追加する必要がある

**既存の `spec.created` イベントハンドラー:**

- `src/core/workflow/github-integration.ts` で `spec.created` イベントを購読し、GitHub Issue を自動作成
- 新しい Git 自動コミット機能が GitHub 統合に影響を与えないか検証が必要
- イベントハンドラーの実行順序: GitHub Issue 作成 → Git 自動コミット（新規追加）

---

## 7. ユースケース

### ケース 1: 標準的な仕様書作成（Git 初期化済み）

**前提条件:**

- Git リポジトリが初期化されている
- 現在のブランチ: `feature/new-feature`

**操作:**

```bash
/cft:spec-create "新機能の実装" "新機能の説明"
```

**期待される結果:**

1. 仕様書ファイル作成: `.cc-craft-kit/specs/<spec-id>.md`
2. データベースレコード作成: `specs` テーブルに挿入
3. GitHub Issue 自動作成
4. Git 自動コミット実行
5. コミット成功メッセージ表示: "✅ 仕様書ファイルを Git コミットしました"

### ケース 2: Git 未初期化環境

**前提条件:**

- Git リポジトリが初期化されていない

**操作:**

```bash
/cft:spec-create "新機能の実装" "新機能の説明"
```

**期待される結果:**

1. 仕様書ファイル作成: 成功
2. データベースレコード作成: 成功
3. Git 自動コミット: スキップ
4. 警告メッセージ表示: "⚠️ Git リポジトリが初期化されていません。手動でコミットしてください。"

### ケース 3: pre-commit フック失敗

**前提条件:**

- Git リポジトリが初期化されている
- pre-commit フックが設定されており、失敗する設定になっている

**操作:**

```bash
/cft:spec-create "新機能の実装" "新機能の説明"
```

**期待される結果:**

1. 仕様書ファイル作成: 成功
2. データベースレコード作成: 成功
3. GitHub Issue 自動作成: 成功
4. Git 自動コミット: 失敗（pre-commit フックによる拒否）
5. 警告メッセージ表示: "⚠️ Git コミットに失敗しました。pre-commit フックを確認してください。"
