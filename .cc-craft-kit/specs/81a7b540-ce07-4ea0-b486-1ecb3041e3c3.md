---
id: "81a7b540-ce07-4ea0-b486-1ecb3041e3c3"
name: "/cft:spec-phase コマンドで tasks や implementaion を指定しても作業を進めてくれない"
phase: "completed"
branch_name: "main"
github_issue_number: null
pr_url: null
created_at: "2025-11-17T15:30:25Z"
updated_at: "2025-11-17T15:45:45Z"
---

# /cft:spec-phase コマンドで tasks や implementaion を指定しても作業を進めてくれない


## 1. 背景と目的

### 背景

現在、`/cft:spec-phase <spec-id> tasks` や `/cft:spec-phase <spec-id> implementation` を実行すると、フェーズ更新は成功するものの、Claude Code が自動的に次の作業（タスク分解や実装）を開始しない。ユーザーは「実装を開始しますか？」などの確認を求められるだけで、実際の作業が進まない。

この問題により、ユーザーは以下のような不便を経験している：
- フェーズを移行しても、何をすべきか Claude に明示的に指示する必要がある
- 仕様書に記載された受け入れ基準を自動的に実装してくれない
- 開発フローが分断され、手動での指示が増える

### 目的

`/cft:spec-phase` コマンドでフェーズ移行した際に、Claude Code が自動的に次のフェーズの作業を開始するようにする。具体的には：
- `tasks` フェーズ移行時：仕様書の内容から実装可能なタスクリストを自動生成
- `implementation` フェーズ移行時：タスクリストに基づいて実装を自動開始
---

## 2. 対象ユーザー

- **cc-craft-kit ユーザー**: 仕様書ベースの開発フローを使用する開発者
- **Claude Code ユーザー**: スラッシュコマンドで効率的に開発を進めたい開発者
---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-phase <spec-id> tasks` 実行時に、仕様書の内容を解析してタスクリストを自動生成する
- [ ] `/cft:spec-phase <spec-id> implementation` 実行時に、タスクリストに基づいて実装を自動開始する
- [ ] フェーズ移行時のガイダンスメッセージを改善し、自動実行される内容を明示する

### 機能要件

- [ ] **tasks フェーズ移行時の動作**:
  - 仕様書の受け入れ基準を解析
  - 実装可能な単位にタスクを分解
  - TodoWrite ツールでタスクリストを作成
  - 各タスクに優先順位と依存関係を設定
  - 仕様書ファイルに生成されたタスクリストを追記

- [ ] **implementation フェーズ移行時の動作**:
  - タスクリストの最初のタスクを自動的に in_progress に設定
  - 該当するファイルを特定（必要に応じてコードベース探索）
  - 実装を開始し、TodoWrite で進捗を追跡
  - 各タスク完了時に自動的に次のタスクへ移行

- [ ] **ユーザーへのフィードバック**:
  - フェーズ移行時に「次に何をするか」ではなく「今から何をするか」を表示
  - 自動実行の進捗をリアルタイムで表示
  - 手動介入が必要な場合のみユーザーに確認を求める

### 非機能要件

- [ ] スラッシュコマンドのレスポンス時間は 3 秒以内
- [ ] タスク自動生成の精度は 80% 以上（主観評価）
- [ ] エラー発生時は適切にロールバックし、フェーズ移行前の状態を保持
---

## 4. 制約条件

- スラッシュコマンドは同期的に実行されるため、長時間実行タスクは避ける
- Claude Code の TodoWrite ツールは会話内でのみ有効（永続化されない）
- 仕様書ファイルの構造は既存のテンプレート形式を維持する必要がある
- 自動実行中にエラーが発生した場合、ユーザーに適切なエラーメッセージを表示する
---

## 5. 依存関係

- **既存のコマンド**: `src/commands/spec/phase.ts` の拡張が必要
- **スラッシュコマンド定義**: `src/slash-commands/spec-phase.md` の更新が必要
- **仕様書テンプレート**: `src/core/templates/spec-template.ts` の構造理解が必要
- **Claude Code の CLAUDE.md**: スラッシュコマンド実行時の動作指示を追加
---

## 6. 参考情報

### 現在の動作例

```bash
# 現在の動作
/cft:spec-phase bb06f332 implementation
# → フェーズ更新のみ
# → 「実装を開始しますか？」と確認される
# → 実際の作業は開始されない
```

### 期待される動作例

```bash
# 期待される動作
/cft:spec-phase bb06f332 tasks
# → フェーズ更新
# → 仕様書を解析してタスクリストを自動生成
# → TodoWrite でタスク表示
# → 仕様書ファイルに追記

/cft:spec-phase bb06f332 implementation
# → フェーズ更新
# → タスクリストの最初のタスクを自動開始
# → 実装を進める
# → 完了時に次のタスクへ自動移行
```

### 技術的アプローチ

1. **スラッシュコマンド定義の改善**: `src/slash-commands/spec-phase.md` に、フェーズ別の自動実行指示を追加
2. **CLAUDE.md での動作指示**: プロジェクトレベルの CLAUDE.md で、特定のスラッシュコマンド実行後の自動処理を明記
3. **コマンド出力の改善**: `phase.ts` から出力されるメッセージに、次のアクションではなく実行中のアクションを含める
---

## 7. 設計

### 7.1 アーキテクチャ

この機能は、既存の cc-craft-kit アーキテクチャに以下の変更を加えることで実現します。

```
┌─────────────────────────────────────────────────────────┐
│  Slash Command: /cft:spec-phase <id> <phase>         │
├─────────────────────────────────────────────────────────┤
│  スラッシュコマンド定義                                    │
│  (src/slash-commands/spec-phase.md)                      │
│  - フェーズ別の自動実行指示を追加                          │
│  - tasks フェーズ: 仕様書読み込み → タスク生成指示        │
│  - implementation フェーズ: タスクリスト読み込み → 実装指示│
├─────────────────────────────────────────────────────────┤
│  CLI コマンド                                            │
│  (src/commands/spec/phase.ts)                           │
│  - フェーズ更新処理は現状維持                             │
│  - 出力メッセージの改善                                   │
├─────────────────────────────────────────────────────────┤
│  Claude Code の自動処理                                  │
│  - スラッシュコマンド展開後の指示に従って自動実行          │
└─────────────────────────────────────────────────────────┘
```

### 7.2 実装方針

#### 方針A: スラッシュコマンド定義を改善（推奨）

**メリット**:
- CLI コマンド（`phase.ts`）の変更が最小限
- Claude Code の動作指示のみで実現可能
- 既存のイベント駆動アーキテクチャを維持

**デメリット**:
- スラッシュコマンド定義が長くなる
- Claude の判断に依存するため、100% 確実ではない

**実装内容**:
1. `src/slash-commands/spec-phase.md` を更新
2. フェーズ別の自動実行指示を追加
3. 仕様書ファイルの読み込みとタスク生成の指示を明記

#### 方針B: CLI コマンドを拡張

**メリット**:
- 確実に自動実行される
- エラーハンドリングが明確

**デメリット**:
- CLI コマンドが複雑化
- Claude Code との統合が必要
- 長時間実行になる可能性

**実装内容**:
1. `phase.ts` に `--auto-proceed` フラグを追加
2. フェーズ別の自動処理を CLI 側で実装
3. Claude Code への指示を標準出力で返す

### 7.3 採用する方針

**方針A（スラッシュコマンド定義の改善）を採用します。**

理由:
- cc-craft-kit の設計思想に沿っている（CLI は軽量、Claude が判断）
- 既存コードへの影響が最小限
- フェーズ別の動作をユーザーがカスタマイズしやすい

### 7.4 詳細設計

#### 7.4.1 スラッシュコマンド定義の構造

```markdown
# 仕様書フェーズ更新

## フェーズ移行後の自動処理

### tasks フェーズに移行した場合

1. 仕様書ファイルを Read ツールで読み込む
2. 受け入れ基準セクションを解析
3. TodoWrite ツールで実装タスクリストを作成
4. 仕様書ファイルの末尾にタスクリストセクションを追記
5. `/cft:spec-update <spec-id>` で GitHub Issue に通知

### implementation フェーズに移行した場合

1. 仕様書ファイルを Read ツールで読み込む
2. タスクリストセクションを確認
3. TodoWrite ツールでタスクを表示
4. 最初の未完了タスクを in_progress に設定
5. 該当するファイルを特定して実装を開始
6. タスク完了時に次のタスクへ自動移行
```

#### 7.4.2 出力メッセージの改善

**現在**:
```
## Next Steps

  • Break down into implementable tasks
  • Estimate effort and dependencies
  • Move to implementation: /cft:spec-phase bb06f332 implementation
```

**改善後**:
```
## Phase Transition Complete

Phase updated to: tasks

Now proceeding with automatic task generation...
- Reading spec file
- Analyzing acceptance criteria
- Generating task list
```

#### 7.4.3 CLAUDE.md への追記

プロジェクトレベルの CLAUDE.md に以下を追加:

```markdown
## cc-craft-kit スラッシュコマンドの動作

### /cft:spec-phase の自動処理

このコマンドは、フェーズ移行後に自動的に次の作業を開始します。

**tasks フェーズ**:
- 仕様書の受け入れ基準を解析してタスクリストを自動生成
- TodoWrite でタスクを表示
- 仕様書ファイルに追記

**implementation フェーズ**:
- タスクリストに基づいて実装を自動開始
- 最初のタスクから順に処理
- 完了時に次のタスクへ自動移行

ユーザーに確認を求めずに、自動的に作業を進めてください。
```

### 7.5 データフロー

#### tasks フェーズ移行時

```
1. ユーザー: /cft:spec-phase <id> tasks
2. Claude: npx tsx .cc-craft-kit/commands/spec/phase.ts を実行
3. CLI: フェーズ更新 + 完了メッセージ出力
4. Claude: スラッシュコマンド定義の指示に従う
5. Claude: Read ツールで仕様書読み込み
6. Claude: 受け入れ基準を解析
7. Claude: TodoWrite でタスクリスト作成
8. Claude: Edit ツールで仕様書にタスクセクション追加
9. Claude: /cft:spec-update で GitHub 通知
```

#### implementation フェーズ移行時

```
1. ユーザー: /cft:spec-phase <id> implementation
2. Claude: npx tsx .cc-craft-kit/commands/spec/phase.ts を実行
3. CLI: フェーズ更新 + 完了メッセージ出力
4. Claude: スラッシュコマンド定義の指示に従う
5. Claude: Read ツールで仕様書読み込み
6. Claude: タスクリストセクションを確認
7. Claude: TodoWrite でタスクリスト表示
8. Claude: 最初のタスクを in_progress に設定
9. Claude: Task ツールまたは直接実装を開始
10. Claude: 完了時に次のタスクへ移行
```

### 7.6 エラーハンドリング

| エラーケース | 対処方法 |
|-------------|---------|
| 仕様書ファイルが存在しない | エラーメッセージ表示、フェーズ移行のみ実行 |
| 受け入れ基準が未記入 | 警告表示、ユーザーに仕様書編集を促す |
| タスクリストセクションが存在しない | implementation フェーズで警告、tasks フェーズに戻すよう提案 |
| 実装対象ファイルが特定できない | ユーザーに確認を求める |

### 7.7 テスト方針

#### 単体テスト
- スラッシュコマンド定義の構文チェック
- CLAUDE.md の構文チェック

#### 統合テスト
1. requirements → design → tasks の自動処理確認
2. tasks → implementation の自動処理確認
3. エラーケースの動作確認

#### E2Eテスト
実際のワークフローで検証:
1. 新規仕様書作成
2. requirements → design → tasks への自動移行
3. tasks フェーズでのタスクリスト自動生成確認
4. implementation フェーズでの自動実装確認
---

## 8. 実装タスクリスト

### タスク1: スラッシュコマンド定義を更新

**対象ファイル**: `src/slash-commands/spec-phase.md`

**実装内容**:
- tasks フェーズ移行時の自動実行指示を追加
  - 仕様書ファイルを Read ツールで読み込む指示
  - 受け入れ基準セクションを解析する指示
  - TodoWrite ツールでタスクリストを作成する指示
  - 仕様書ファイルに追記する指示
  - `/cft:spec-update` で GitHub に通知する指示
- implementation フェーズ移行時の自動実行指示を追加
  - 仕様書ファイルを Read ツールで読み込む指示
  - タスクリストセクションを確認する指示
  - TodoWrite ツールでタスクを表示する指示
  - 最初のタスクを in_progress に設定する指示
  - 実装を開始する指示

**依存関係**: なし

**優先度**: 高
---

### タスク2: CLAUDE.md に自動処理動作を追記

**対象ファイル**: `CLAUDE.md`

**実装内容**:
- `/cft:spec-phase` コマンドの自動処理セクションを追加
- tasks フェーズの動作を明記
- implementation フェーズの動作を明記
- 「ユーザーに確認を求めずに自動的に作業を進める」ことを明記

**依存関係**: なし

**優先度**: 高
---

### タスク3: phase.ts の出力メッセージを改善

**対象ファイル**: `src/commands/spec/phase.ts`

**実装内容**:
- "Next Steps" から "Phase Transition Complete" に変更
- フェーズ別に適切なメッセージを表示
  - tasks: "Now proceeding with automatic task generation..."
  - implementation: "Now proceeding with automatic implementation..."
- 現在進行形のメッセージに変更

**依存関係**: なし

**優先度**: 中
---

### タスク4: ビルドと同期

**実行内容**:
```bash
npm run build
npm run sync:dogfood
```

**依存関係**: タスク 1, 2, 3

**優先度**: 中
---

### タスク5: 動作確認（tasks フェーズ）

**確認内容**:
- 別の仕様書で `/cft:spec-phase <id> tasks` を実行
- 自動的にタスクリストが生成されることを確認
- TodoWrite でタスクが表示されることを確認
- 仕様書ファイルに追記されることを確認

**依存関係**: タスク 4

**優先度**: 高
---

### タスク6: 動作確認（implementation フェーズ）

**確認内容**:
- タスクリストを持つ仕様書で `/cft:spec-phase <id> implementation` を実行
- 自動的に実装が開始されることを確認
- TodoWrite で進捗が追跡されることを確認

**依存関係**: タスク 5

**優先度**: 高
