# /cft:spec-create で仕様書の作成場所が間違っている

**仕様書 ID:** 82e22ad3-7697-4fb5-8079-6b0343528234
**フェーズ:** tasks
**作成日時:** 2025/11/23 01:45:00
**更新日時:** 2025/11/23 01:46:54

---

## 1. 背景と目的

### 背景

現在の `/cft:spec-create` コマンドには以下の問題があります。

1. **ブランチ作成後に切り替えない**: `createSpecBranch()` がブランチを作成するが、`git checkout` で切り替えていない
2. **仕様書ファイルが元のブランチに作成される**: develop ブランチで実行すると、仕様書ファイルが develop ブランチに作成されてしまう
3. **コミットが元のブランチに作成される**: 仕様書のコミットも develop ブランチに作成される
4. **元のブランチに戻る処理がない**: 作業完了後、元のブランチに戻らない

これにより、仕様書が間違ったブランチに配置され、Git 履歴が混乱する。

### 目的

`/cft:spec-create` コマンド実行時に、以下の正しい動作フローを実現します。

1. 仕様書用のブランチを作成
2. **作成したブランチに切り替える** (`git checkout`)
3. **そのブランチ内で**仕様書ファイルを作成
4. **そのブランチ内で**仕様書をコミット
5. **元のブランチに戻る** (`git checkout <元のブランチ>`)

これにより、仕様書が正しいブランチに配置され、Git 履歴が整理された状態で保たれる。

---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者（プロジェクトの管理者・コントリビューター）

---

## 3. 受け入れ基準

### 必須要件

- [ ] ブランチ作成後、自動的にそのブランチに切り替わること (`git checkout`)
- [ ] 仕様書ファイルが作成されたブランチ内へ配置されること
- [ ] 仕様書のコミットが作成されたブランチに作成されること
- [ ] コミット後、自動的に元のブランチに戻ること

### 機能要件

- [ ] `src/commands/spec/create.ts` の `createSpec()` 関数を修正し、ブランチ切り替え処理を追加すること
- [ ] ブランチ切り替えに失敗した場合、適切なエラーメッセージを表示してロールバックすること
- [ ] エラー時のロールバック処理で、元のブランチへ確実に戻ること

### 非機能要件

- [ ] 既存のテストがすべてパスすること
- [ ] 型チェック (`npx tsc --noEmit`) がエラーなく通ること
- [ ] ロールバック処理が適切に動作し、中途半端な状態を残さないこと

---

## 4. 制約条件

- 既存の `createSpecBranch()` の実装は変更しない（ブランチ作成のみを担当）
- `createSpec()` 関数内でブランチ切り替え処理を追加する
- Git コマンドは `execFileSync()` を使用する
- ブランチキャッシュは切り替え後に必ずクリアする (`clearBranchCache()`)

---

## 5. 依存関係

- `src/core/git/branch-creation.ts` - `createSpecBranch()` 関数
- `src/core/git/branch-cache.ts` - `getCurrentBranch()`, `clearBranchCache()` 関数
- `src/core/workflow/event-bus.ts` - `spec.created` イベント

---

## 6. 参考情報

- 関連 Issue: #300 (自動作成される予定)
- 関連コード: `src/commands/spec/create.ts:139-157` (ブランチ作成処理)

---

## 7. 設計

### 7.1 アーキテクチャ設計

#### 全体フロー

```text
┌─────────────────────────────────────────────────────────┐
│ /cft:spec-create コマンド実行                           │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│ 1. 元のブランチ名を保存 (getCurrentBranch())            │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│ 2. 仕様書用ブランチ作成 (createSpecBranch())            │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│ 3. 作成したブランチへ切り替え (git checkout)           │
│    ※ 失敗した場合はエラーでロールバック                │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│ 4. ブランチキャッシュをクリア (clearBranchCache())     │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│ 5. 仕様書ファイルを作成 (fs.writeFileSync())            │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│ 6. 仕様書をコミット (git add + git commit)             │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│ 7. 元のブランチに戻る (git checkout)                    │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│ 8. ブランチキャッシュをクリア (clearBranchCache())     │
└─────────────────────────────────────────────────────────┘
```

#### エラー時のロールバックフロー

```text
┌─────────────────────────────────────────────────────────┐
│ エラー発生 (ブランチ切り替え失敗など)                  │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│ 1. 元のブランチに戻る (git checkout)                    │
│    ※ try-catch で確実に実行                             │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│ 2. 作成したブランチを削除 (git branch -D)               │
│    ※ 既に切り替えてファイルを作成していた場合          │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│ 3. ブランチキャッシュをクリア (clearBranchCache())     │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│ 4. エラーメッセージを表示して終了                      │
└─────────────────────────────────────────────────────────┘
```

### 7.2 実装設計

#### 7.2.1 修正対象ファイル

- **`src/commands/spec/create.ts`**: `createSpec()` 関数にブランチ切り替え処理を追加

#### 7.2.2 コード修正内容

##### 現在のコード（問題箇所）

```typescript
// src/commands/spec/create.ts:139-157
try {
  // ブランチを作成（ただし切り替えない）
  const branchName = await createSpecBranch({
    specId: spec.id,
    specName: input.name,
  });

  // 仕様書ファイルを作成（元のブランチ上で作成される）
  const specFilePath = join(SPECS_DIR, `${spec.id}.md`);
  writeFileSync(specFilePath, specMarkdown, 'utf-8');

  // コミット（元のブランチにコミットされる）
  execFileSync('git', ['add', specFilePath]);
  execFileSync('git', ['commit', '-m', `feat: ${input.name} の要件定義を完了`]);

  // イベント発行
  await eventBus.emit('spec.created', { specId: spec.id });
}
```

##### 修正後のコード

```typescript
// src/commands/spec/create.ts:139-172
import { getCurrentBranch, clearBranchCache } from '../../core/git/branch-cache.js';

// 元のブランチを保存
const originalBranch = getCurrentBranch();
let branchName: string | undefined;

try {
  // 1. ブランチを作成
  branchName = await createSpecBranch({
    specId: spec.id,
    specName: input.name,
  });

  // 2. 作成したブランチへ切り替え
  try {
    execFileSync('git', ['checkout', branchName], { stdio: 'inherit' });
  } catch (checkoutError) {
    throw new DatabaseError(
      `ブランチの切り替えに失敗しました: ${branchName}`,
      checkoutError instanceof Error ? checkoutError : undefined
    );
  }

  // 3. ブランチキャッシュをクリア
  clearBranchCache();

  // 4. 仕様書ファイルを作成（作成したブランチ上で作成）
  const specFilePath = join(SPECS_DIR, `${spec.id}.md`);
  writeFileSync(specFilePath, specMarkdown, 'utf-8');

  // 5. コミット（作成したブランチにコミット）
  execFileSync('git', ['add', specFilePath]);
  execFileSync('git', ['commit', '-m', `feat: ${input.name} の要件定義を完了`]);

  // 6. 元のブランチに戻る
  execFileSync('git', ['checkout', originalBranch], { stdio: 'inherit' });

  // 7. ブランチキャッシュをクリア
  clearBranchCache();

  // イベント発行
  await eventBus.emit('spec.created', { specId: spec.id });
} catch (error) {
  // エラー時のロールバック処理
  try {
    // 元のブランチに戻る
    execFileSync('git', ['checkout', originalBranch], { stdio: 'inherit' });
    clearBranchCache();

    // 作成したブランチが存在する場合は削除
    if (branchName) {
      try {
        execFileSync('git', ['branch', '-D', branchName], { stdio: 'inherit' });
      } catch {
        // ブランチ削除失敗は無視（既に削除されている可能性）
      }
    }
  } catch {
    // ロールバック処理のエラーは無視（元のエラーを優先）
  }

  throw error;
}
```

### 7.3 データモデル

変更なし（データベーススキーマに影響なし）

### 7.4 API 設計

変更なし（内部実装の修正のみで、公開 API に影響なし）

### 7.5 シーケンス図

```text
ユーザー                CLI                 Git                 ファイルシステム
  │                      │                   │                   │
  │  /cft:spec-create    │                   │                   │
  │─────────────────────>│                   │                   │
  │                      │                   │                   │
  │                      │ getCurrentBranch()│                   │
  │                      │──────────────────>│                   │
  │                      │<──────────────────│                   │
  │                      │ "develop"         │                   │
  │                      │                   │                   │
  │                      │ createSpecBranch()│                   │
  │                      │──────────────────>│                   │
  │                      │<──────────────────│                   │
  │                      │ "spec/82e22ad3"   │                   │
  │                      │                   │                   │
  │                      │ git checkout spec/82e22ad3            │
  │                      │──────────────────>│                   │
  │                      │<──────────────────│                   │
  │                      │                   │                   │
  │                      │ clearBranchCache()│                   │
  │                      │──────────────────>│                   │
  │                      │<──────────────────│                   │
  │                      │                   │                   │
  │                      │        writeFileSync(specFile)        │
  │                      │──────────────────────────────────────>│
  │                      │<──────────────────────────────────────│
  │                      │                   │                   │
  │                      │ git add + git commit                  │
  │                      │──────────────────>│                   │
  │                      │<──────────────────│                   │
  │                      │                   │                   │
  │                      │ git checkout develop                  │
  │                      │──────────────────>│                   │
  │                      │<──────────────────│                   │
  │                      │                   │                   │
  │                      │ clearBranchCache()│                   │
  │                      │──────────────────>│                   │
  │                      │<──────────────────│                   │
  │                      │                   │                   │
  │  Success             │                   │                   │
  │<─────────────────────│                   │                   │
```

### 7.6 セキュリティ設計

#### 7.6.1 Git コマンドインジェクション対策

- `execFileSync()` を使用してコマンドインジェクションを防止
- ブランチ名は `createSpecBranch()` が安全に生成したものを使用
- ユーザー入力（仕様書名）は直接 Git コマンドに渡さない

#### 7.6.2 エラー時の状態保証

- `try-catch` で確実にロールバック処理を実行
- 元のブランチへの切り替え失敗時も、エラーメッセージで明確に通知

---

## 8. 実装タスクリスト（tasks フェーズで自動生成予定）

このセクションは、仕様書が `tasks` フェーズに移行した際に自動的に生成されます。
