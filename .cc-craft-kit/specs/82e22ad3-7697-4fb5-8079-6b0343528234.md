# /cft:spec-create で仕様書の作成場所が間違っている

**仕様書 ID:** 82e22ad3-7697-4fb5-8079-6b0343528234
**フェーズ:** design
**作成日時:** 2025/11/23 01:45:00
**更新日時:** 2025/11/23 01:45:19

---

## 1. 背景と目的

### 背景

現在の `/cft:spec-create` コマンドには以下の問題があります。

1. **ブランチ作成後に切り替えない**: `createSpecBranch()` がブランチを作成するが、`git checkout` で切り替えていない
2. **仕様書ファイルが元のブランチに作成される**: develop ブランチで実行すると、仕様書ファイルが develop ブランチに作成されてしまう
3. **コミットが元のブランチに作成される**: 仕様書のコミットも develop ブランチに作成される
4. **元のブランチに戻る処理がない**: 作業完了後、元のブランチに戻らない

これにより、仕様書が間違ったブランチに配置され、Git 履歴が混乱する。

### 目的

`/cft:spec-create` コマンド実行時に、以下の正しい動作フローを実現します。

1. 仕様書用のブランチを作成
2. **作成したブランチに切り替える** (`git checkout`)
3. **そのブランチ内で**仕様書ファイルを作成
4. **そのブランチ内で**仕様書をコミット
5. **元のブランチに戻る** (`git checkout <元のブランチ>`)

これにより、仕様書が正しいブランチに配置され、Git 履歴が整理された状態で保たれる。

---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者（プロジェクトの管理者・コントリビューター）

---

## 3. 受け入れ基準

### 必須要件

- [ ] ブランチ作成後、自動的にそのブランチに切り替わること (`git checkout`)
- [ ] 仕様書ファイルが作成されたブランチ内へ配置されること
- [ ] 仕様書のコミットが作成されたブランチに作成されること
- [ ] コミット後、自動的に元のブランチに戻ること

### 機能要件

- [ ] `src/commands/spec/create.ts` の `createSpec()` 関数を修正し、ブランチ切り替え処理を追加すること
- [ ] ブランチ切り替えに失敗した場合、適切なエラーメッセージを表示してロールバックすること
- [ ] エラー時のロールバック処理で、元のブランチへ確実に戻ること

### 非機能要件

- [ ] 既存のテストがすべてパスすること
- [ ] 型チェック (`npx tsc --noEmit`) がエラーなく通ること
- [ ] ロールバック処理が適切に動作し、中途半端な状態を残さないこと

---

## 4. 制約条件

- 既存の `createSpecBranch()` の実装は変更しない（ブランチ作成のみを担当）
- `createSpec()` 関数内でブランチ切り替え処理を追加する
- Git コマンドは `execFileSync()` を使用する
- ブランチキャッシュは切り替え後に必ずクリアする (`clearBranchCache()`)

---

## 5. 依存関係

- `src/core/git/branch-creation.ts` - `createSpecBranch()` 関数
- `src/core/git/branch-cache.ts` - `getCurrentBranch()`, `clearBranchCache()` 関数
- `src/core/workflow/event-bus.ts` - `spec.created` イベント

---

## 6. 参考情報

- 関連 Issue: #300 (自動作成される予定)
- 関連コード: `src/commands/spec/create.ts:139-157` (ブランチ作成処理)
