# completed フェーズで仕様書が更新される

**仕様書 ID:** 65ca2193-85b9-43fb-ad2f-476454e6bd23
**フェーズ:** requirements
**作成日時:** 2025/12/05 00:02:25
**更新日時:** 2025/12/05 00:02:25

---

## 1. 背景と目的

### 背景

completed フェーズは PR マージ後の後処理として実行される。この時点で git 管理のリソース（仕様書 .md ファイル等）を変更すると、以下の問題が発生する:

1. **変更が PR に含まれない**: PR マージ後のコミットは、そのブランチにのみ存在し、ベースブランチ（develop/main）には反映されない
2. **ブランチ削除で消失**: completed フェーズではブランチ削除も実行されるため、コミットした変更がそのまま失われる
3. **履歴追跡が困難**: PR に含まれない変更は、コードレビューを経ずに履歴に残る

実際の問題発生例（仕様書 2feaa5bf の完了時）:
```
git commit -m "feat: CI が失敗する PR が作成される の完了を完了"
```
このコミットは作業ブランチに作成されたが、その直後にブランチが削除されるため意味がない。

### 目的

completed フェーズ移行時に仕様書ファイルの更新・コミット（Step 6・Step 7）をスキップし、PR マージ後に不要な変更が行われないようにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] completed フェーズ移行時に仕様書ファイルが変更されない
- [ ] completed フェーズ移行時に git commit が実行されない

### 機能要件

- [ ] spec-phase.md の completed フェーズ処理で Step 6（Markdown 更新）をスキップする
- [ ] spec-phase.md の completed フェーズ処理で Step 7（自動コミット）をスキップする
- [ ] review フェーズ移行時に仕様書のフェーズを「completed」に更新する（PR に含める）
- [ ] DB のフェーズ更新（update-phase.ts）は引き続き実行する

### 非機能要件

- [ ] 他のフェーズ（requirements → design → implementation → review）の動作に影響しない
- [ ] プロンプトファースト原則に従った実装

---

## 4. 制約条件

- プロンプトファースト原則: spec-phase.md のみ修正（TypeScript 変更不要）
- completed フェーズでは以下のみ実行:
  - DB 更新（update-phase.ts）
  - pr-cleanup 処理（ブランチ削除）
  - GitHub Issue クローズ
  - GitHub Projects ステータス更新
- 仕様書ファイルの「フェーズ: completed」更新は review フェーズの PR に含める

---

## 5. 依存関係

- `src/slash-commands/spec-phase.md` - フェーズ遷移ロジック（修正対象）
- `src/commands/spec/update-phase.ts` - DB 更新（変更不要）
- `src/core/workflow/github-integration.ts` - GitHub 統合処理（変更不要、既に正しい動作）
- `src/integrations/github/pr-cleanup.ts` - PR 後処理（変更不要）

---

## 6. 参考情報

- 仕様書 2feaa5bf-2257-4c65-a4c0-0e770274a811: CI が失敗する PR が作成される（完了時に問題発生）
- 仕様書 7a42a7d3: completed フェーズ移行時にブランチ削除が失敗する（関連問題）
- spec-phase.md 行 717-763: completed フェーズ移行時の処理（修正対象）
