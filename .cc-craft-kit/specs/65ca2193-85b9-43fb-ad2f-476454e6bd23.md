# completed フェーズで仕様書が更新される

**仕様書 ID:** 65ca2193-85b9-43fb-ad2f-476454e6bd23
**フェーズ:** implementation
**作成日時:** 2025/12/05 00:02:25
**更新日時:** 2025/12/05 02:23:15

---

## 1. 背景と目的

### 背景

completed フェーズは PR マージ後の後処理として実行される。この時点で git 管理のリソース（仕様書 .md ファイル等）を変更すると、以下の問題が発生する:

1. **変更が PR に含まれない**: PR マージ後のコミットは、そのブランチにのみ存在し、ベースブランチ（develop/main）には反映されない
2. **ブランチ削除で消失**: completed フェーズではブランチ削除も実行されるため、コミットした変更がそのまま失われる
3. **履歴追跡が困難**: PR に含まれない変更は、コードレビューを経ずに履歴に残る

実際の問題発生例（仕様書 2feaa5bf の完了時）:
```
git commit -m "feat: CI が失敗する PR が作成される の完了を完了"
```
このコミットは作業ブランチに作成されたが、その直後にブランチが削除されるため意味がない。

### 目的

completed フェーズ移行時に仕様書ファイルの更新・コミット（Step 6・Step 7）をスキップし、PR マージ後に不要な変更が行われないようにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] completed フェーズ移行時に仕様書ファイルが変更されない
- [ ] completed フェーズ移行時に git commit が実行されない

### 機能要件

- [ ] spec-phase.md の completed フェーズ処理で Step 6（Markdown 更新）をスキップする
- [ ] spec-phase.md の completed フェーズ処理で Step 7（自動コミット）をスキップする
- [ ] review フェーズ移行時に仕様書のフェーズを「completed」に更新する（PR に含める）
- [ ] DB のフェーズ更新（update-phase.ts）は引き続き実行する

### 非機能要件

- [ ] 他のフェーズ（requirements → design → implementation → review）の動作に影響しない
- [ ] プロンプトファースト原則に従った実装

---

## 4. 制約条件

- プロンプトファースト原則: spec-phase.md のみ修正（TypeScript 変更不要）
- completed フェーズでは以下のみ実行:
  - DB 更新（update-phase.ts）
  - pr-cleanup 処理（ブランチ削除）
  - GitHub Issue クローズ
  - GitHub Projects ステータス更新
- 仕様書ファイルの「フェーズ: completed」更新は review フェーズの PR に含める

---

## 5. 依存関係

- `src/slash-commands/spec-phase.md` - フェーズ遷移ロジック（修正対象）
- `src/commands/spec/update-phase.ts` - DB 更新（変更不要）
- `src/core/workflow/github-integration.ts` - GitHub 統合処理（変更不要、既に正しい動作）
- `src/integrations/github/pr-cleanup.ts` - PR 後処理（変更不要）

---

## 6. 参考情報

- 仕様書 2feaa5bf-2257-4c65-a4c0-0e770274a811: CI が失敗する PR が作成される（完了時に問題発生）
- 仕様書 7a42a7d3: completed フェーズ移行時にブランチ削除が失敗する（関連問題）
- spec-phase.md 行 717-763: completed フェーズ移行時の処理（修正対象）

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
/cft:spec-phase <spec-id> <phase>
        │
        ▼
┌───────────────────────────────────────────────────────┐
│  spec-phase.md（プロンプト層）                          │
│                                                       │
│  Step 1-4: ID解決・ブランチ切替・バリデーション        │
│  Step 5: DB更新（update-phase.ts）                    │
│  Step 6: Markdown更新 ← completed時スキップ           │
│  Step 7: 自動コミット ← completed時スキップ           │
│  Step 8: フェーズ固有後処理                           │
│          ├─ review: PR作成 + フェーズ先行更新         │
│          └─ completed: GitHub統合のみ（ファイル操作なし）│
└───────────────────────────────────────────────────────┘
        │
        ▼ イベント発火
┌───────────────────────────────────────────────────────┐
│  github-integration.ts（TypeScript層）                │
│                                                       │
│  completed イベント受信時:                            │
│  - pr-cleanup処理（ブランチ削除）                     │
│  - GitHub Issue クローズ                              │
│  - Projects ステータス更新（Done）                    │
└───────────────────────────────────────────────────────┘
```

#### 設計方針

1. **completed フェーズでの Step 6・7 スキップ**: PR マージ後のファイル変更を防止
2. **review フェーズでの事前更新**: 仕様書のフェーズを `completed` に先行更新し、PR に含める
3. **プロンプトファースト原則**: spec-phase.md のみ修正、TypeScript 変更不要

#### 処理フロー詳細

**従来のフロー（問題あり）:**
```
review → completed 遷移時:
  Step 5: DB更新（phase = completed）
  Step 6: 仕様書更新（**フェーズ:** completed）← PR外
  Step 7: git commit ← ブランチ削除で消失
  Step 8: pr-cleanup（ブランチ削除）
```

**新しいフロー（修正後）:**
```
implementation → review 遷移時:
  Step 5: DB更新（phase = review）
  Step 6: 仕様書更新（**フェーズ:** review）
  Step 7: git commit
  Step 8: PR作成
        + 仕様書フェーズを completed に先行更新 ← PR に含む
        + git commit --amend でPRコミットに追加

review → completed 遷移時:
  Step 5: DB更新（phase = completed）
  Step 6: スキップ ← 既にPRで更新済み
  Step 7: スキップ ← ファイル変更なし
  Step 8: pr-cleanup・Issue クローズ
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/slash-commands/spec-phase.md` | Step 6・7 の条件分岐追加、review フェーズ処理に先行更新追加 |

#### 修正箇所の詳細

**修正箇所 1: Step 6 に条件分岐追加**

Step 6 の冒頭に以下の条件を追加:
```markdown
> **重要**: `NEW_PHASE` が `completed` の場合、このステップをスキップします。
> 仕様書の completed フェーズ更新は review フェーズの PR に含まれています。

`NEW_PHASE` が `completed` の場合は Step 7 へスキップ。
```

**修正箇所 2: Step 7 に条件分岐追加**

Step 7 の冒頭に以下の条件を追加:
```markdown
> **重要**: `NEW_PHASE` が `completed` の場合、このステップをスキップします。

`NEW_PHASE` が `completed` の場合は Step 8 へスキップ。
```

**修正箇所 3: review フェーズ処理に先行更新追加**

review フェーズ移行処理（Step 8）に以下を追加:
```markdown
7. **仕様書フェーズの先行更新**（PR に含める）:
   - Edit ツールで仕様書（`$SPEC_PATH`）を更新:
     - 検索: `**フェーズ:** review`
     - 置換: `**フェーズ:** completed`
   - git add && git commit --amend --no-edit で PR コミットに追加
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| Step 6 Markdown 更新 | 全フェーズで実行 | completed 時スキップ | spec-phase.md Step 6 |
| Step 7 自動コミット | 全フェーズで実行 | completed 時スキップ | spec-phase.md Step 7 |
| フェーズ先行更新 | なし | review 時に completed に更新 | spec-phase.md Step 8 review 処理 |
| DB 更新 | 全フェーズで実行 | 変更なし | update-phase.ts |
| pr-cleanup | completed 時に実行 | 変更なし | github-integration.ts |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| completed スキップ | completed 遷移時に Step 6・7 がスキップされる | 手動テスト: /cft:spec-phase で completed に遷移し、git log で確認 |
| review 先行更新 | review 遷移時に仕様書が completed に更新される | 手動テスト: PR の diff で仕様書フェーズが completed であることを確認 |
| 他フェーズ影響なし | requirements→design 等は従来通り動作 | 手動テスト: 各フェーズ遷移で仕様書・コミットが正常に作成される |

### 7.5 移行計画

#### Phase 1: Step 6・7 の条件分岐追加

1. spec-phase.md の Step 6 冒頭に completed スキップ条件を追加
2. spec-phase.md の Step 7 冒頭に completed スキップ条件を追加

#### Phase 2: review フェーズ処理の拡張

1. review フェーズ処理に仕様書フェーズ先行更新ロジックを追加
2. git commit --amend で PR コミットに含める処理を追加

#### Phase 3: 動作確認

1. 各フェーズ遷移の動作確認
2. PR 作成・マージ・completed 遷移の E2E 確認

---

## 8. 実装タスクリスト

### Phase 1: Step 6・7 の条件分岐追加

- [x] Step 6 に completed スキップ条件を追加 (#770)
- [ ] Step 7 に completed スキップ条件を追加 (#771)

### Phase 2: review フェーズ処理の拡張

- [ ] review フェーズ処理に仕様書フェーズ先行更新ロジックを追加 (#772)

### Phase 3: 動作確認

- [ ] npm run sync:dogfood で同期 (#773)
- [ ] 動作確認（手動テスト） (#774)
