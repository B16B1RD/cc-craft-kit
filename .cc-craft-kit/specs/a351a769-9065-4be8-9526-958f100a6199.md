# フェーズ移行時に不要なブランチが複数作成される問題を修正

**仕様書 ID:** a351a769-9065-4be8-9526-958f100a6199
**フェーズ:** requirements
**作成日時:** 2025/11/21 13:57:27
**更新日時:** 2025/11/21 13:57:27

---

## 1. 背景と目的

### 背景

現在、cc-craft-kit では次のタイミングでブランチが作成されます。

1. `/cft:spec-create` 実行時 - 仕様書用のブランチを作成（正常）
2. `/cft:spec-phase <id> implementation` 実行時 - `handleBranchCreationOnImplementation` により再度ブランチを作成（問題）

この結果、1 つの仕様書に対して複数のブランチが作成され、次の問題が発生しています。

- 不要なローカルブランチの蓄積
- どのブランチで作業すべきか混乱
- ブランチ管理の煩雑化

特に、`spec.phase_changed` イベント発火時に `handleBranchCreationOnImplementation` が複数回実行されるケースがあります。
同一フェーズ移行で 3 つのブランチが同時作成される異常な動作も確認されています。

### 目的

フェーズ移行時の不要なブランチ作成を防止し、1 つの仕様書につき 1 つのブランチのみが作成されるよう修正します。

---

## 2. 対象ユーザー

- cc-craft-kit を使用してソフトウェア開発する開発者
- 複数の仕様書を同時に管理する開発チーム

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-create` 実行時のみブランチが作成されること
- [ ] `/cft:spec-phase <id> implementation` 実行時にブランチが作成されないこと
- [ ] 1 つの仕様書に対して 1 つのブランチのみが存在すること

### 機能要件

- [ ] `handleBranchCreationOnImplementation` の動作を修正または削除
- [ ] 既にブランチが存在する場合はスキップする判定ロジックの実装
- [ ] イベントハンドラーの重複実行を防ぐ仕組みの実装

### 非機能要件

- [ ] 既存の仕様書に影響を与えないこと
- [ ] ブランチ作成ロジックのテストを追加すること
- [ ] 修正後、不要なブランチが作成されないことを E2E テストで検証すること

---

## 4. 制約条件

- 保護ブランチ（main, develop）から直接作業する場合の救済措置として設計された `handleBranchCreationOnImplementation` を削除または無効化する
- Git リポジトリ未初期化の環境でもエラーが発生しないこと

---

## 5. 依存関係

- `src/core/workflow/branch-management.ts` - ブランチ自動作成ロジック
- `src/core/workflow/event-bus.ts` - イベントハンドラー登録
- `src/core/git/branch-creation.ts` - ブランチ作成関数
- `src/commands/spec/create.ts` - 仕様書作成時のブランチ作成

---

## 6. 参考情報

- GitHub Issue #246: <https://github.com/B16B1RD/cc-craft-kit/issues/246>
- 関連コード: `src/core/workflow/branch-management.ts:149-242` (`handleBranchCreationOnImplementation`)
- 関連コード: `src/core/workflow/branch-management.ts:382-406` (`registerBranchManagementHandlers`)
