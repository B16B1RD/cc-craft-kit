# フェーズ移行時に不要なブランチが複数作成される問題を修正

**仕様書 ID:** a351a769-9065-4be8-9526-958f100a6199
**フェーズ:** implementation
**作成日時:** 2025/11/21 13:57:27
**更新日時:** 2025/11/21 18:36:14

---

## 1. 背景と目的

### 背景

現在、cc-craft-kit では次のタイミングでブランチが作成されます。

1. `/cft:spec-create` 実行時 - 仕様書用のブランチを作成（正常）
2. `/cft:spec-phase <id> implementation` 実行時 - `handleBranchCreationOnImplementation` により再度ブランチを作成（問題）

この結果、1 つの仕様書に対して複数のブランチが作成され、次の問題が発生しています。

- 不要なローカルブランチの蓄積
- どのブランチで作業すべきか混乱
- ブランチ管理の煩雑化

特に、`spec.phase_changed` イベント発火時に `handleBranchCreationOnImplementation` が複数回実行されるケースがあります。
同一フェーズ移行で 3 つのブランチが同時作成される異常な動作も確認されています。

### 目的

フェーズ移行時の不要なブランチ作成を防止し、1 つの仕様書につき 1 つのブランチのみが作成されるよう修正します。

---

## 2. 対象ユーザー

- cc-craft-kit を使用してソフトウェア開発する開発者
- 複数の仕様書を同時に管理する開発チーム

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-create` 実行時のみブランチが作成されること
- [ ] `/cft:spec-phase <id> implementation` 実行時にブランチが作成されないこと
- [ ] 1 つの仕様書に対して 1 つのブランチのみが存在すること

### 機能要件

- [ ] `handleBranchCreationOnImplementation` の動作を修正または削除
- [ ] 既にブランチが存在する場合はスキップする判定ロジックの実装
- [ ] イベントハンドラーの重複実行を防ぐ仕組みの実装

### 非機能要件

- [ ] 既存の仕様書に影響を与えないこと
- [ ] ブランチ作成ロジックのテストを追加すること
- [ ] 修正後、不要なブランチが作成されないことを E2E テストで検証すること

---

## 4. 制約条件

- 保護ブランチ（main, develop）から直接作業する場合の救済措置として設計された `handleBranchCreationOnImplementation` を削除または無効化する
- Git リポジトリ未初期化の環境でもエラーが発生しないこと

---

## 5. 依存関係

- `src/core/workflow/branch-management.ts` - ブランチ自動作成ロジック
- `src/core/workflow/event-bus.ts` - イベントハンドラー登録
- `src/core/git/branch-creation.ts` - ブランチ作成関数
- `src/commands/spec/create.ts` - 仕様書作成時のブランチ作成

---

## 6. 参考情報

- GitHub Issue #246: <https://github.com/B16B1RD/cc-craft-kit/issues/246>
- 関連コード: `src/core/workflow/branch-management.ts:149-242` (`handleBranchCreationOnImplementation`)
- 関連コード: `src/core/workflow/branch-management.ts:382-406` (`registerBranchManagementHandlers`)

---

## 7. 設計

### 7.1. アーキテクチャ設計

#### 現状の問題点

現在の実装では、以下の 2 箇所でブランチが作成されます。

1. **仕様書作成時** (`src/commands/spec/create.ts:141-149`)
   - `createSpecBranch(id, customBranchName)` を呼び出し
   - 保護ブランチ（main, develop）から実行した場合、`feature/spec-<短縮ID>` を自動作成
   - 作業ブランチから実行した場合、`spec/<短縮ID>` を作成

2. **implementation フェーズ移行時** (`src/core/workflow/branch-management.ts:149-242`)
   - `handleBranchCreationOnImplementation` が `spec.phase_changed` イベントで発火
   - 保護ブランチにいる場合のみ、新しいブランチを作成
   - 意図: 保護ブランチから直接作業する場合の救済措置

##### 問題の根本原因

- 仕様書作成時に既にブランチが作成されているため、implementation フェーズ移行時の救済措置は不要
- しかし、`handleBranchCreationOnImplementation` は保護ブランチチェックのみ実施し、**既にブランチが作成済みかどうかを確認していない**
- その結果、保護ブランチにいる場合、仕様書作成時と implementation フェーズ移行時の両方でブランチが作成される

##### 複数ブランチ作成のシナリオ

1. main ブランチで `/cft:spec-create` 実行
   - `feature/spec-12345678` ブランチが作成され、自動的にチェックアウト
2. main ブランチに手動で戻る（`git checkout main`）
3. `/cft:spec-phase <id> implementation` 実行
   - 現在のブランチが main（保護ブランチ）
   - `handleBranchCreationOnImplementation` が新しいブランチを作成
   - `feature-<仕様書名>` ブランチが追加作成される

#### 修正方針

##### 採用する設計: イベントハンドラーの削除

`handleBranchCreationOnImplementation` を完全に削除し、ブランチ作成は仕様書作成時のみに統一します。

##### 理由

1. **仕様書作成時の保護ブランチ対応が既に完了している**
   - `createSpecBranch` は保護ブランチから実行時、`feature/spec-` プレフィックス付きブランチを自動作成
   - 救済措置は既に実装済みのため、implementation フェーズでの追加対応は不要

2. **ユーザーが手動で保護ブランチに戻るケースは想定外**
   - 仕様書作成時にブランチが作成されるため、ユーザーは作業ブランチに留まるべき
   - 保護ブランチに戻ってフェーズ移行する動作は、ワークフロー違反

3. **シンプルな設計**
   - ブランチ作成タイミングを 1 箇所に統一することで、コードの複雑性を削減
   - テストとメンテナンスが容易

##### 代替案として検討したが却下した設計

- **案1: 既存ブランチチェックの追加**
  - `handleBranchCreationOnImplementation` に、仕様書の `branch_name` が存在する場合はスキップするロジックを追加
  - 却下理由: 保護ブランチに戻るワークフロー自体が異常なため、救済措置を残す必要がない

- **案2: イベントハンドラーの重複実行防止**
  - `once` メソッドを使用してハンドラーを 1 回のみ実行
  - 却下理由: 根本原因は複数回実行ではなく、不要なブランチ作成ロジックの存在

#### 影響範囲

##### 削除対象

- `src/core/workflow/branch-management.ts:149-242` - `handleBranchCreationOnImplementation` 関数
- `src/core/workflow/branch-management.ts:391-397` - イベントハンドラー登録処理

##### 変更なし

- `src/commands/spec/create.ts` - 仕様書作成時のブランチ作成は維持
- `src/core/git/branch-creation.ts` - ブランチ作成ロジックは維持
- `handleProtectedBranchWarning` - 保護ブランチ警告は維持（警告のみでブランチ作成なし）

### 7.2. API 設計

#### 削除する関数

```typescript
// src/core/workflow/branch-management.ts

/**
 * 削除: implementation フェーズ移行時のブランチ自動作成
 */
async function handleBranchCreationOnImplementation(
  event: WorkflowEvent<{ oldPhase: string; newPhase: string }>,
  db: Kysely<Database>
): Promise<void> {
  // この関数全体を削除
}
```

#### 修正する関数

```typescript
// src/core/workflow/branch-management.ts

/**
 * ブランチ管理イベントハンドラーを登録
 *
 * 修正前: 3つのハンドラーを登録
 * 修正後: 2つのハンドラーのみ登録（ブランチ自動作成を削除）
 */
export function registerBranchManagementHandlers(eventBus: EventBus, db: Kysely<Database>): void {
  // 保護ブランチ警告（維持）
  eventBus.on<{ oldPhase: string; newPhase: string }>(
    'spec.phase_changed',
    async (event: WorkflowEvent<{ oldPhase: string; newPhase: string }>) => {
      await handleProtectedBranchWarning(event, db);
    }
  );

  // ❌ 削除: ブランチ自動作成ハンドラー
  // eventBus.on<{ oldPhase: string; newPhase: string }>(
  //   'spec.phase_changed',
  //   async (event: WorkflowEvent<{ oldPhase: string; newPhase: string }>) => {
  //     await handleBranchCreationOnImplementation(event, db);
  //   }
  // );

  // PR自動作成（維持）
  eventBus.on<{ oldPhase: string; newPhase: string }>(
    'spec.phase_changed',
    async (event: WorkflowEvent<{ oldPhase: string; newPhase: string }>) => {
      await handlePullRequestCreationOnCompleted(event, db);
    }
  );
}
```

### 7.3. データモデル

データベーススキーマの変更は不要です。既存の `specs` テーブルの `branch_name` フィールドをそのまま使用します。

#### 変更なし

- `specs.branch_name` - 仕様書作成時に記録されたブランチ名を保持

### 7.4. セキュリティ考慮事項

#### コマンドインジェクション対策

- `createSpecBranch` 関数の UUID フォーマット検証を維持
- `execSync` の `stdio: 'pipe'` オプションを維持し、エラーメッセージの漏洩を防止

#### ロールバック処理

- `handleBranchCreationOnImplementation` の削除により、ロールバック処理も不要になる
- 仕様書作成時のロールバック処理は維持（`src/commands/spec/create.ts`）

### 7.5. テスト戦略

#### 単体テスト

1. **イベントハンドラー登録のテスト** (`tests/core/workflow/branch-management.test.ts`)
   - `registerBranchManagementHandlers` が 2 つのハンドラーのみ登録することを確認
   - `handleBranchCreationOnImplementation` が呼び出されないことを確認

2. **ブランチ作成のテスト** (`tests/core/git/branch-creation.test.ts`)
   - 既存のテストを維持
   - 保護ブランチから `feature/spec-` プレフィックス付きブランチが作成されることを確認

#### E2E テスト

1. **仕様書作成からフェーズ移行までのフロー** (`tests/e2e/spec-branch-creation.test.ts`)
   - 保護ブランチ（main）から仕様書作成
   - implementation フェーズに移行
   - ブランチが 1 つのみ作成されることを確認
   - `git branch` コマンドでローカルブランチ一覧を取得し、`spec-` プレフィックスのブランチが 1 つのみ存在することを検証

2. **複数仕様書の同時作成** (`tests/e2e/multiple-specs.test.ts`)
   - 3 つの仕様書を連続作成
   - 各仕様書を implementation フェーズに移行
   - 各仕様書に対してブランチが 1 つのみ作成されることを確認

### 7.6. 移行計画

#### 既存仕様書への影響

##### 影響なし

- 既に作成された仕様書のブランチは維持される
- `specs.branch_name` フィールドは変更されない
- 既存の仕様書を implementation フェーズに移行しても、新しいブランチは作成されない

#### ロールアウト手順

1. **コード修正**
   - `handleBranchCreationOnImplementation` 関数を削除
   - `registerBranchManagementHandlers` からハンドラー登録を削除

2. **テスト実行**
   - 単体テストで回帰を確認
   - E2E テストでブランチ作成が 1 回のみ実行されることを確認

3. **ドキュメント更新**
   - `CLAUDE.md` のブランチ管理セクションを更新
   - GitHub Issue #246 にクローズコメントを記載

4. **リリース**
   - `src/` を編集後、`npm run sync:dogfood` で同期
   - `/cft:spec-phase <id> completed` で完了
   - Git コミット、PR 作成

### 7.7. パフォーマンス考慮事項

#### 改善点

- `handleBranchCreationOnImplementation` の削除により、implementation フェーズ移行時の Git コマンド実行が削減される
- イベントハンドラーの数が 3 つから 2 つに減少し、イベント処理のオーバーヘッドが削減される

#### 影響

- 仕様書作成時のブランチ作成パフォーマンスは変わらず
- フェーズ移行時のパフォーマンスが向上

---

## 8. 実装タスクリスト

### タスク1: handleBranchCreationOnImplementation 関数を削除

**ファイル**: `src/core/workflow/branch-management.ts`

**作業内容**:

- 149-242 行目の `handleBranchCreationOnImplementation` 関数を削除
- 関数内の依存関数（`isProtectedBranch`, `generateBranchName`, `branchExists`, `checkoutBranch`, `createBranchFromBase` など）が他の箇所で使用されているか確認
- 使用されていない場合は、関連するヘルパー関数も削除を検討

**受け入れ基準**:

- `handleBranchCreationOnImplementation` 関数が存在しないこと
- 型エラーが発生しないこと

### タスク2: registerBranchManagementHandlers からブランチ自動作成ハンドラー登録を削除

**ファイル**: `src/core/workflow/branch-management.ts`

**作業内容**:

- 391-397 行目のイベントハンドラー登録処理を削除
- `registerBranchManagementHandlers` が 2 つのハンドラー（保護ブランチ警告、PR 自動作成）のみを登録することを確認

**受け入れ基準**:

- `registerBranchManagementHandlers` が 2 つのハンドラーのみ登録すること
- 型エラーが発生しないこと

### タスク3: 単体テストでハンドラー登録数を検証

**ファイル**: `tests/core/workflow/branch-management.test.ts`

**作業内容**:

- `registerBranchManagementHandlers` が 2 つのハンドラーのみ登録することをテスト
- `handleBranchCreationOnImplementation` が呼び出されないことをテスト
- イベントバスのモックを使用して、`spec.phase_changed` イベント発火時にブランチ作成が実行されないことを確認

**受け入れ基準**:

- テストが成功すること
- カバレッジが維持されること

### タスク4: E2Eテストで保護ブランチからのブランチ作成フローを検証

**ファイル**: `tests/e2e/spec-branch-creation.test.ts`（新規作成）

**作業内容**:

- 保護ブランチ（main）から仕様書作成
- implementation フェーズに移行
- `git branch` コマンドでローカルブランチ一覧を取得
- `spec-` または `feature/spec-` プレフィックスのブランチが 1 つのみ存在することを検証

**受け入れ基準**:

- テストが成功すること
- ブランチが 1 つのみ作成されることが確認できること

### タスク5: E2Eテストで複数仕様書のブランチ作成を検証

**ファイル**: `tests/e2e/multiple-specs.test.ts`（新規作成）

**作業内容**:

- 3 つの仕様書を連続作成
- 各仕様書を implementation フェーズに移行
- 各仕様書に対してブランチが 1 つのみ作成されることを検証
- ブランチ名が重複していないことを確認

**受け入れ基準**:

- テストが成功すること
- 各仕様書に対してブランチが 1 つのみ作成されること

### タスク6: ドッグフーディング環境へ同期

**コマンド**: `npm run sync:dogfood`

**作業内容**:

- `src/` の変更を `.cc-craft-kit/` へ同期
- `npm run check:sync` で整合性を確認

**受け入れ基準**:

- `npm run check:sync` でエラーが出ないこと
- `.cc-craft-kit/core/workflow/branch-management.ts` に変更が反映されていること

### タスク7: 全テスト実行と回帰確認

**コマンド**: `npm test`

**作業内容**:

- 全テストを実行
- 既存のテストが成功すること
- 新規追加したテストが成功すること
- カバレッジが維持されていること（現在: functions 34%）

**受け入れ基準**:

- すべてのテストが成功すること
- カバレッジが 34%以上維持されること
