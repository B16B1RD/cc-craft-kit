# フェーズ移行時に不要なブランチが複数作成される問題を修正

**仕様書 ID:** a351a769-9065-4be8-9526-958f100a6199
**フェーズ:** tasks
**作成日時:** 2025/11/21 13:57:27
**更新日時:** 2025/11/21 19:28:42

---

## 1. 背景と目的

### 背景

現在、cc-craft-kit では次のタイミングでブランチが作成されます。

1. `/cft:spec-create` 実行時 - 仕様書用のブランチを作成（正常）
2. `/cft:spec-phase <id> implementation` 実行時 - `handleBranchCreationOnImplementation` により再度ブランチを作成（問題）

この結果、1 つの仕様書に対して複数のブランチが作成され、次の問題が発生しています。

- 不要なローカルブランチの蓄積
- どのブランチで作業すべきか混乱
- ブランチ管理の煩雑化

特に、`spec.phase_changed` イベント発火時に `handleBranchCreationOnImplementation` が複数回実行されるケースがあります。
同一フェーズ移行で 3 つのブランチが同時作成される異常な動作も確認されています。

### 目的

フェーズ移行時の不要なブランチ作成を防止し、1 つの仕様書につき 1 つのブランチのみが作成されるよう修正します。

---

## 2. 対象ユーザー

- cc-craft-kit を使用してソフトウェア開発する開発者
- 複数の仕様書を同時に管理する開発チーム

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-create` 実行時のみブランチが作成されること
- [ ] `/cft:spec-phase <id> implementation` 実行時にブランチが作成されないこと
- [ ] 1 つの仕様書に対して 1 つのブランチのみが存在すること

### 機能要件

- [ ] `handleBranchCreationOnImplementation` の動作を修正または削除
- [ ] 既にブランチが存在する場合はスキップする判定ロジックの実装
- [ ] イベントハンドラーの重複実行を防ぐ仕組みの実装

### 非機能要件

- [ ] 既存の仕様書に影響を与えないこと
- [ ] ブランチ作成ロジックのテストを追加すること
- [ ] 修正後、不要なブランチが作成されないことを E2E テストで検証すること

---

## 4. 制約条件

- 保護ブランチ（main, develop）から直接作業する場合の救済措置として設計された `handleBranchCreationOnImplementation` を削除または無効化する
- Git リポジトリ未初期化の環境でもエラーが発生しないこと

---

## 5. 依存関係

- `src/core/workflow/branch-management.ts` - ブランチ自動作成ロジック
- `src/core/workflow/event-bus.ts` - イベントハンドラー登録
- `src/core/git/branch-creation.ts` - ブランチ作成関数
- `src/commands/spec/create.ts` - 仕様書作成時のブランチ作成

---

## 6. 参考情報

- GitHub Issue #246: <https://github.com/B16B1RD/cc-craft-kit/issues/246>
- 関連コード: `src/core/workflow/branch-management.ts:149-242` (`handleBranchCreationOnImplementation`)
- 関連コード: `src/core/workflow/branch-management.ts:382-406` (`registerBranchManagementHandlers`)

---

## 7. 技術仕様

### 問題の原因

#### 1. ブランチ作成のタイミングが重複

現在の実装では、以下の 2 箇所でブランチ作成が行われています。

1. **仕様書作成時** (`src/commands/spec/create.ts:143-144`)
   - `createSpecBranch(id)` または `createSpecBranch(id, options.branchName)` を実行
   - 保護ブランチ（main, develop）から実行した場合、`feature/spec-<短縮ID>` または `feature/spec-<短縮ID>-<カスタム名>` ブランチを自動作成
   - それ以外のブランチから実行した場合、`spec/<短縮ID>` または `spec/<短縮ID>-<カスタム名>` ブランチを作成
   - **想定動作**: 仕様書ごとに 1 つのブランチを作成

2. **フェーズ移行時** (`src/core/workflow/branch-management.ts:149-242`)
   - `spec.phase_changed` イベント（tasks → implementation）で `handleBranchCreationOnImplementation` が実行
   - 現在のブランチが保護ブランチの場合、`generateBranchName(spec.name)` で新しいブランチを作成
   - **問題**: 仕様書作成時に既にブランチが作成されているため、再度ブランチが作成される

#### 2. ブランチ命名規則の不一致

| 関数 | ブランチ名形式 | 例 |
|---|---|---|
| `createSpecBranch` (仕様書作成時) | `spec/<短縮ID>` または `spec/<短縮ID>-<カスタム名>` | `spec/a351a769` |
| `generateBranchName` (フェーズ移行時) | 仕様書名から生成 | `feature/fix-unexpected-branch-creation` |

異なる命名規則により、同一仕様書に対して複数のブランチが作成されます。

#### 3. イベントハンドラーの重複実行

`registerBranchManagementHandlers` では、`spec.phase_changed` イベントに 3 つのハンドラーが登録されています（`branch-management.ts:382-406`）。

```typescript
// spec.phase_changed → 保護ブランチ警告（tasks → implementation）
eventBus.on('spec.phase_changed', async (event) => {
  await handleProtectedBranchWarning(event, db);
});

// spec.phase_changed → ブランチ自動作成（tasks → implementation）
eventBus.on('spec.phase_changed', async (event) => {
  await handleBranchCreationOnImplementation(event, db);
});

// spec.phase_changed → PR自動作成（implementation → completed）
eventBus.on('spec.phase_changed', async (event) => {
  await handlePullRequestCreationOnCompleted(event, db);
});
```

`spec.phase_changed` イベントが発火されると、上記 3 つのハンドラーがすべて実行されます。`handleBranchCreationOnImplementation` は条件分岐で `tasks → implementation` のみ処理しますが、イベントハンドラーの登録自体は重複しています。

### 解決策

#### 案1: `handleBranchCreationOnImplementation` の削除（推奨）

**方針**: 仕様書作成時のブランチ作成のみを維持し、フェーズ移行時のブランチ作成を完全に削除する。

**メリット**:

- ブランチ作成ロジックが 1 箇所に集約される
- 複数ブランチ作成の問題が根本的に解決される
- コードがシンプルになり、保守性が向上する

**デメリット**:

- 保護ブランチから仕様書作成せずにフェーズ移行した場合、ブランチが作成されない
- ただし、現在の運用では仕様書作成時に必ずブランチが作成されるため、実質的な影響なし

**実装方針**:

1. `src/core/workflow/branch-management.ts:149-242` の `handleBranchCreationOnImplementation` 関数を削除
2. `src/core/workflow/branch-management.ts:391-397` のイベントハンドラー登録を削除
3. `handleProtectedBranchWarning` も不要になるため削除を検討（別途議論）

#### 案2: ブランチ存在チェックの強化

**方針**: フェーズ移行時に、仕様書作成時に作成されたブランチが存在するかチェックし、既に存在する場合はスキップする。

**メリット**:

- 保護ブランチから直接フェーズ移行した場合の救済措置として機能する
- 既存のブランチが存在する場合は再作成されない

**デメリット**:

- ブランチ命名規則の不一致により、チェックが複雑になる
- `createSpecBranch` が生成するブランチ名（`spec/<短縮ID>`）と、`generateBranchName` が生成するブランチ名（仕様書名ベース）が一致しないため、チェックロジックが複雑化
- コードの複雑性が増す

**実装方針**:

1. `handleBranchCreationOnImplementation` の先頭で、仕様書作成時に作成されたブランチの存在をチェック
2. ブランチ名は `specs.branch_name` カラムから取得（既に記録されている）
3. ブランチが既に存在する場合は `console.log` でスキップメッセージを表示し、関数を終了

### 推奨案

**案1（`handleBranchCreationOnImplementation` の削除）** を推奨します。

理由は以下の通りです。

- cc-craft-kit の運用では、仕様書作成時に必ずブランチが作成される
- 保護ブランチでの作業を防ぐために、v0.2.0 で `createSpecBranch` に保護ブランチ検出機能が追加された
- フェーズ移行時のブランチ作成は、保護ブランチでの直接作業を想定した救済措置だが、現在の運用では不要
- ブランチ作成ロジックを 1 箇所に集約することで、保守性が向上する

### 実装手順

1. **`handleBranchCreationOnImplementation` の削除**
   - `src/core/workflow/branch-management.ts:149-242` を削除

2. **イベントハンドラー登録の削除**
   - `src/core/workflow/branch-management.ts:391-397` を削除

3. **テストの追加**
   - `tests/core/workflow/branch-management.test.ts` に以下のテストを追加
     - 仕様書作成時に 1 つのブランチのみが作成されること
     - フェーズ移行（tasks → implementation）時にブランチが作成されないこと
   - E2E テスト `tests/e2e/branch-creation.test.ts` を追加
     - 仕様書作成 → フェーズ移行（tasks → implementation）のフローで、1 つのブランチのみが存在することを検証

4. **ドキュメント更新**
   - `CLAUDE.md` の「ブランチ管理」セクションを更新
   - フェーズ移行時のブランチ作成が削除されたことを明記

### 影響範囲

- **削除されるファイル**: なし
- **変更されるファイル**:
  - `src/core/workflow/branch-management.ts` - `handleBranchCreationOnImplementation` と対応するイベントハンドラー登録を削除
- **追加されるファイル**:
  - `tests/core/workflow/branch-management.test.ts` - ブランチ作成ロジックのテスト
  - `tests/e2e/branch-creation.test.ts` - E2E テスト

### リスク

- **低リスク**: 現在の運用では、仕様書作成時に必ずブランチが作成されるため、フェーズ移行時のブランチ作成削除による影響はほぼない
- **移行期間**: 既存の仕様書（フェーズ移行時に作成されたブランチを持つ）は、そのまま使用可能（削除は不要）

---

## 8. UI/UX 仕様

### コマンド実行時の出力

#### `/cft:spec-create` 実行時

```bash
$ /cft:spec-create "新機能の実装"

✓ Created and switched to new branch 'spec/a351a769'
✓ Specification 'a351a769' created successfully

Next actions:
  • View the spec: /cft:spec-get a351a769
  • Edit the spec: /home/user/project/.cc-craft-kit/specs/a351a769-9065-4be8-9526-958f100a6199.md
  • Move to design phase: /cft:spec-phase a351a769 design
```

#### `/cft:spec-phase <id> implementation` 実行時

修正前（ブランチが再作成される）の出力例。

```bash
$ /cft:spec-phase a351a769 implementation

✓ Created and switched to new branch 'feature/new-feature-implementation'
✓ Phase updated: requirements → implementation
```

修正後（ブランチは作成されない）の出力例。

```bash
$ /cft:spec-phase a351a769 implementation

✓ Phase updated: requirements → implementation
✓ Committed changes: feat: 新機能の実装 の実装を開始
```

### エラーメッセージ

#### 保護ブランチから仕様書作成時

```bash
$ /cft:spec-create "新機能の実装"

ℹ Currently on protected branch 'main'. Creating feature branch...
✓ Created and switched to new branch 'feature/spec-a351a769'
✓ Specification 'a351a769' created successfully
```

---

## 9. テスト計画

### 単体テスト

#### `tests/core/workflow/branch-management.test.ts`

```typescript
describe('Branch Management', () => {
  it('仕様書作成時に1つのブランチのみが作成されること', async () => {
    // 仕様書作成
    const specId = await createSpec('テスト仕様書');

    // ブランチ数確認
    const branches = execSync('git branch --list "spec/*"', { encoding: 'utf-8' })
      .split('\n')
      .filter((b) => b.trim());

    expect(branches.length).toBe(1);
    expect(branches[0]).toContain(`spec/${specId.substring(0, 8)}`);
  });

  it('フェーズ移行時にブランチが作成されないこと', async () => {
    // 仕様書作成
    const specId = await createSpec('テスト仕様書');

    // ブランチ数確認（作成直後）
    const branchesBefore = execSync('git branch --list "spec/*"', { encoding: 'utf-8' })
      .split('\n')
      .filter((b) => b.trim());

    // フェーズ移行
    await updateSpecPhase(specId, 'implementation');

    // ブランチ数確認（フェーズ移行後）
    const branchesAfter = execSync('git branch --list "spec/*"', { encoding: 'utf-8' })
      .split('\n')
      .filter((b) => b.trim());

    // ブランチ数が変わらないことを確認
    expect(branchesAfter.length).toBe(branchesBefore.length);
  });
});
```

### E2Eテスト

#### `tests/e2e/branch-creation.test.ts`

```typescript
describe('E2E: Branch Creation', () => {
  it('仕様書作成からフェーズ移行まで1つのブランチのみが存在すること', async () => {
    // 1. 仕様書作成
    const { stdout } = execSync('npx tsx .cc-craft-kit/commands/spec/create.ts "E2Eテスト仕様書"', {
      encoding: 'utf-8',
    });

    // 仕様書 ID 抽出
    const specIdMatch = stdout.match(/Specification '([a-f0-9]{8})'/);
    expect(specIdMatch).not.toBeNull();
    const specId = specIdMatch![1];

    // 2. ブランチ数確認（作成直後）
    const branchesBefore = execSync('git branch --list "spec/*"', { encoding: 'utf-8' })
      .split('\n')
      .filter((b) => b.trim());

    expect(branchesBefore.length).toBe(1);

    // 3. フェーズ移行（requirements → design → tasks → implementation）
    execSync(`npx tsx .cc-craft-kit/commands/spec/phase.ts ${specId} design`, { stdio: 'ignore' });
    execSync(`npx tsx .cc-craft-kit/commands/spec/phase.ts ${specId} tasks`, { stdio: 'ignore' });
    execSync(`npx tsx .cc-craft-kit/commands/spec/phase.ts ${specId} implementation`, { stdio: 'ignore' });

    // 4. ブランチ数確認（フェーズ移行後）
    const branchesAfter = execSync('git branch --list "spec/*"', { encoding: 'utf-8' })
      .split('\n')
      .filter((b) => b.trim());

    // ブランチ数が変わらないことを確認
    expect(branchesAfter.length).toBe(1);
    expect(branchesAfter[0]).toBe(branchesBefore[0]);
  });
});
```

### テスト観点

| テストケース | 期待結果 |
|---|---|
| 仕様書作成時のブランチ作成 | `spec/<短縮ID>` ブランチが1つ作成される |
| 保護ブランチからの仕様書作成 | `feature/spec-<短縮ID>` ブランチが1つ作成される |
| フェーズ移行（tasks → implementation） | 新しいブランチは作成されない |
| 複数の仕様書作成 | 各仕様書に対して1つずつブランチが作成される |
| Git未初期化環境での仕様書作成 | エラーメッセージが表示され、ブランチは作成されない |
