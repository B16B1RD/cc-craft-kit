# 整合性チェックが別ブランチの仕様書を誤検知する問題を修正

**仕様書 ID:** 7d86e424-19dc-4820-baa0-79d45a158020
**フェーズ:** requirements
**作成日時:** 2025/11/21 18:05:44
**更新日時:** 2025/11/21 18:05:44

---

## 1. 背景と目的

### 背景

cc-craft-kit は各仕様書を作成したブランチに紐づけて管理する設計ですが、現在の整合性チェック（`IntegrityChecker`）は以下の問題があります。

1. **現在のブランチにファイルが物理的に存在するかだけをチェック**
   - データベースには全ブランチの仕様書レコードが保存されている
   - 別ブランチで作成された仕様書ファイルは Git の仕組み上、現在のブランチでは見えない
   - これは正常な状態だが、整合性チェックが「ファイルが存在しない」とエラー報告する

2. **`branch_name` カラムを考慮していない**
   - データベースの `specs.branch_name` カラムに作成元ブランチが記録されている
   - 整合性チェックはこの情報を無視している

**具体例：**

```bash
# develop ブランチで /cft:status 実行
$ git checkout develop
$ /cft:status

⚠️  Database integrity warnings:
     - Found 2 database record(s) without corresponding file

# しかし実際には別ブランチに存在
$ git branch --list "spec/2572db2e*"
  spec/2572db2e-fix-unexpected-branch-creation
```

### 目的

整合性チェックロジックを改善し、別ブランチの仕様書を正常と判定することで、誤検知をなくす。

---

## 2. 対象ユーザー

- **cc-craft-kit 開発者** - 複数ブランチで仕様書を管理する開発者
- **プロジェクト管理者** - `/cft:status` で正確なプロジェクト状況を把握したいユーザー

---

## 3. 受け入れ基準

### 必須要件

- [ ] 整合性チェックが `branch_name` カラムを考慮して、別ブランチの仕様書を正常と判定する
- [ ] 現在のブランチ、`main`、`develop` に属する仕様書のみファイル存在チェックを実施する
- [ ] 別ブランチの仕様書は「ファイルが存在しない」エラーを出さない

### 機能要件

- [ ] `IntegrityChecker.check()` メソッドを修正し、以下のロジックを実装：

  ```typescript
  const currentBranch = getCurrentBranch();
  const allowedBranches = [currentBranch, 'main', 'develop'];

  if (!allowedBranches.includes(record.branch_name)) {
    // 別ブランチの仕様書なので、ファイルチェックをスキップ
    continue;
  } else if (!fileExists(specPath)) {
    // 現在のブランチなのにファイルがない → エラー
    errors.push("ファイルが存在しない");
  }
  ```

- [ ] `/cft:status` 実行時に誤検知がゼロになる
- [ ] `repair-database.ts` スクリプトも同様のロジックを適用

### 非機能要件

- [ ] 既存のテストケースが全て通過する
- [ ] 新しい整合性チェックロジックのテストケースを追加
- [ ] パフォーマンスへの影響がない（ブランチチェックは軽量な文字列比較）

---

## 4. 制約条件

- Git リポジトリが初期化されていること（`getCurrentBranch()` が正常に動作する）
- データベースの `specs.branch_name` カラムが `NOT NULL` であること
- ブランチキャッシュが正しく動作していること

---

## 5. 依存関係

**既存コンポーネント:**

- `src/core/sync/integrity-checker.ts` - 整合性チェックロジック
- `src/core/git/branch-cache.ts` - ブランチキャッシュ機構
- `src/scripts/repair-database.ts` - 修復スクリプト
- `src/commands/status.ts` - `/cft:status` コマンド

**データベーススキーマ:**

- `specs.branch_name` カラム（NOT NULL 制約あり）

---

## 6. 参考情報

**関連ドキュメント:**

- `CLAUDE.md` - ブランチ管理の仕様（セクション: ブランチ管理）
- `src/core/sync/integrity-checker.ts:1-200` - 現在の整合性チェック実装

**関連 Issue:**

- GitHub Issue #250 - 本仕様書の追跡用 Issue

**ブランチフィルタリングの仕様:**

cc-craft-kit のブランチフィルタリングルールは以下の通りです。

| 現在のブランチ | 表示される仕様書 |
|---|---|
| `main` | `main` と `develop` で作成された仕様書のみ |
| `develop` | `main` と `develop` で作成された仕様書のみ |
| `feature/test` | `main`, `develop`, `feature/test` で作成された仕様書 |

この仕様では、整合性チェックもこの同じルールを適用することで、一貫性を保ちます。
