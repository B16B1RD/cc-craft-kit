# 整合性チェックが別ブランチの仕様書を誤検知する問題を修正

**仕様書 ID:** 7d86e424-19dc-4820-baa0-79d45a158020
**フェーズ:** completed
**作成日時:** 2025/11/21 18:05:44
**更新日時:** 2025/11/21 21:33:06

---

## 1. 背景と目的

### 背景

cc-craft-kit は各仕様書を作成したブランチに紐づけて管理する設計ですが、現在の整合性チェック（`IntegrityChecker`）は以下の問題があります。

1. **現在のブランチにファイルが物理的に存在するかだけをチェック**
   - データベースには全ブランチの仕様書レコードが保存されている
   - 別ブランチで作成された仕様書ファイルは Git の仕組み上、現在のブランチでは見えない
   - これは正常な状態だが、整合性チェックが「ファイルが存在しない」とエラー報告する

2. **`branch_name` カラムを考慮していない**
   - データベースの `specs.branch_name` カラムに作成元ブランチが記録されている
   - 整合性チェックはこの情報を無視している

**具体例：**

```bash
# develop ブランチで /cft:status 実行
$ git checkout develop
$ /cft:status

⚠️  Database integrity warnings:
     - Found 2 database record(s) without corresponding file

# しかし実際には別ブランチに存在
$ git branch --list "spec/2572db2e*"
  spec/2572db2e-fix-unexpected-branch-creation
```

### 目的

整合性チェックロジックを改善し、別ブランチの仕様書を正常と判定することで、誤検知をなくす。

---

## 2. 対象ユーザー

- **cc-craft-kit 開発者** - 複数ブランチで仕様書を管理する開発者
- **プロジェクト管理者** - `/cft:status` で正確なプロジェクト状況を把握したいユーザー

---

## 3. 受け入れ基準

### 必須要件

- [ ] 整合性チェックが `branch_name` カラムを考慮して、別ブランチの仕様書を正常と判定する
- [ ] 現在のブランチ、`main`、`develop` に属する仕様書のみファイル存在チェックを実施する
- [ ] 別ブランチの仕様書は「ファイルが存在しない」エラーを出さない

### 機能要件

- [ ] `IntegrityChecker.check()` メソッドを修正し、以下のロジックを実装：

  ```typescript
  const currentBranch = getCurrentBranch();
  const allowedBranches = [currentBranch, 'main', 'develop'];

  if (!allowedBranches.includes(record.branch_name)) {
    // 別ブランチの仕様書なので、ファイルチェックをスキップ
    continue;
  } else if (!fileExists(specPath)) {
    // 現在のブランチなのにファイルがない → エラー
    errors.push("ファイルが存在しない");
  }
  ```

- [ ] `/cft:status` 実行時に誤検知がゼロになる
- [ ] `repair-database.ts` スクリプトも同様のロジックを適用

### 非機能要件

- [ ] 既存のテストケースが全て通過する
- [ ] 新しい整合性チェックロジックのテストケースを追加
- [ ] パフォーマンスへの影響がない（ブランチチェックは軽量な文字列比較）

---

## 4. 制約条件

- Git リポジトリが初期化されていること（`getCurrentBranch()` が正常に動作する）
- データベースの `specs.branch_name` カラムが `NOT NULL` であること
- ブランチキャッシュが正しく動作していること

---

## 5. 依存関係

**既存コンポーネント:**

- `src/core/sync/integrity-checker.ts` - 整合性チェックロジック
- `src/core/git/branch-cache.ts` - ブランチキャッシュ機構
- `src/scripts/repair-database.ts` - 修復スクリプト
- `src/commands/status.ts` - `/cft:status` コマンド

**データベーススキーマ:**

- `specs.branch_name` カラム（NOT NULL 制約あり）

---

## 6. 参考情報

**関連ドキュメント:**

- `CLAUDE.md` - ブランチ管理の仕様（セクション: ブランチ管理）
- `src/core/sync/integrity-checker.ts:1-200` - 現在の整合性チェック実装

**関連 Issue:**

- GitHub Issue #250 - 本仕様書の追跡用 Issue

**ブランチフィルタリングの仕様:**

cc-craft-kit のブランチフィルタリングルールは以下の通りです。

| 現在のブランチ | 表示される仕様書 |
|---|---|
| `main` | `main` と `develop` で作成された仕様書のみ |
| `develop` | `main` と `develop` で作成された仕様書のみ |
| `feature/test` | `main`, `develop`, `feature/test` で作成された仕様書 |

この仕様では、整合性チェックもこの同じルールを適用することで、一貫性を保ちます。

---

## 7. 詳細設計

### 7.1. アーキテクチャ

**影響範囲:**

```text
┌─────────────────────────────────────────┐
│  /cft:status コマンド                   │
│  (.cc-craft-kit/commands/status.ts)     │
└────────────┬────────────────────────────┘
             │
             ↓
┌─────────────────────────────────────────┐
│  IntegrityChecker                       │
│  (src/core/sync/integrity-checker.ts)   │
│  ┌────────────────────────────────────┐ │
│  │ check() メソッド                   │ │
│  │ - getCurrentBranch() 追加          │ │
│  │ - allowedBranches フィルタリング   │ │
│  └────────────────────────────────────┘ │
└─────────────────────────────────────────┘
             │
             ↓
┌─────────────────────────────────────────┐
│  BranchCache                            │
│  (src/core/git/branch-cache.ts)         │
│  - getCurrentBranch(): string           │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│  repair-database.ts                     │
│  (src/scripts/repair-database.ts)       │
│  - 同じブランチフィルタリングロジックを適用 │
└─────────────────────────────────────────┘
```

### 7.2. データフロー

```text
1. /cft:status 実行
   ↓
2. IntegrityChecker.check() 呼び出し
   ↓
3. getCurrentBranch() でカレントブランチ取得
   例: "feature/test"
   ↓
4. allowedBranches を算出
   ["feature/test", "main", "develop"]
   ↓
5. データベースの全レコードをループ
   for (const record of dbRecords) {
     if (!allowedBranches.includes(record.branch_name)) {
       // 別ブランチの仕様書 → ファイルチェックをスキップ
       continue;
     }

     if (!existsSync(specPath)) {
       // 現在のブランチなのにファイルがない → エラー
       errors.push(...);
     }
   }
   ↓
6. 整合性チェック結果を返却
   - 別ブランチの仕様書は「正常」と判定
   - 現在のブランチの仕様書のみファイル存在チェック
```

### 7.3. 実装詳細

#### 7.3.1. IntegrityChecker.check() メソッドの修正

**現在の実装 (src/core/sync/integrity-checker.ts):**

```typescript
export class IntegrityChecker {
  async check(): Promise<IntegrityCheckResult> {
    const dbRecords = await this.db
      .selectFrom('specs')
      .selectAll()
      .execute();

    for (const record of dbRecords) {
      const specPath = this.getSpecPath(record.id);

      // 問題: ブランチを考慮せずファイルをチェック
      if (!existsSync(specPath)) {
        errors.push({
          type: 'missing_file',
          specId: record.id,
          message: 'Database record without corresponding file',
        });
      }
    }

    return { valid: errors.length === 0, errors };
  }
}
```

**修正後の実装:**

```typescript
import { getCurrentBranch } from '../git/branch-cache.js';

export class IntegrityChecker {
  async check(): Promise<IntegrityCheckResult> {
    const dbRecords = await this.db
      .selectFrom('specs')
      .selectAll()
      .execute();

    // 現在のブランチ + 共通ブランチ (main, develop)
    const currentBranch = getCurrentBranch();
    const allowedBranches = [currentBranch, 'main', 'develop'];

    for (const record of dbRecords) {
      const specPath = this.getSpecPath(record.id);

      // ブランチフィルタリング: 別ブランチの仕様書はチェックをスキップ
      if (!allowedBranches.includes(record.branch_name)) {
        continue; // 別ブランチの仕様書なので正常と判定
      }

      // 現在のブランチに属する仕様書のみファイル存在チェック
      if (!existsSync(specPath)) {
        errors.push({
          type: 'missing_file',
          specId: record.id,
          branchName: record.branch_name,
          message: `Database record without corresponding file (branch: ${record.branch_name})`,
        });
      }
    }

    return { valid: errors.length === 0, errors };
  }
}
```

#### 7.3.2. repair-database.ts スクリプトの修正

**修正箇所:**

`src/scripts/repair-database.ts` の整合性チェック部分にも同じロジックを適用します。

```typescript
import { getCurrentBranch } from '../core/git/branch-cache.js';

async function checkIntegrity() {
  const currentBranch = getCurrentBranch();
  const allowedBranches = [currentBranch, 'main', 'develop'];

  for (const record of dbRecords) {
    // 別ブランチの仕様書はスキップ
    if (!allowedBranches.includes(record.branch_name)) {
      continue;
    }

    // 現在のブランチの仕様書のみチェック
    if (!existsSync(specPath)) {
      console.warn(`Missing file: ${record.id}`);
    }
  }
}
```

### 7.4. エラーメッセージの改善

**変更前:**

```text
⚠️  Database integrity warnings:
     - Found 2 database record(s) without corresponding file
```

**変更後 (ブランチ情報を含める):**

```text
⚠️  Database integrity warnings:
     - Found 2 database record(s) without corresponding file

Database records without files (in current branch: feature/test):
  - 5d1250ea-d837-4f09-9827-d0612ffe7f26
    Name: spec-get コマンドが GitHub Issue を重複作成するバグを修正
    Branch: feature/test (← 現在のブランチなのにファイルがない)
```

### 7.5. テスト設計

#### 7.5.1. 単体テスト (tests/core/sync/integrity-checker.test.ts)

**新規テストケース:**

```typescript
describe('IntegrityChecker - ブランチフィルタリング', () => {
  it('別ブランチの仕様書は「ファイルが存在しない」エラーを出さない', async () => {
    // Arrange: develop ブランチで実行中
    mockGetCurrentBranch.mockReturnValue('develop');

    // データベースに feature ブランチの仕様書レコードを作成
    await db.insertInto('specs').values({
      id: 'test-id',
      name: 'Test Spec',
      branch_name: 'feature/test', // 別ブランチ
      phase: 'requirements',
    }).execute();

    // feature ブランチの仕様書ファイルは存在しない (Git の仕組み上正常)

    // Act
    const result = await checker.check();

    // Assert: エラーが出ないこと
    expect(result.valid).toBe(true);
    expect(result.errors).toHaveLength(0);
  });

  it('現在のブランチの仕様書でファイルが存在しない場合はエラーを出す', async () => {
    // Arrange: develop ブランチで実行中
    mockGetCurrentBranch.mockReturnValue('develop');

    // データベースに develop ブランチの仕様書レコードを作成
    await db.insertInto('specs').values({
      id: 'test-id',
      name: 'Test Spec',
      branch_name: 'develop', // 現在のブランチ
      phase: 'requirements',
    }).execute();

    // ファイルは存在しない (異常)

    // Act
    const result = await checker.check();

    // Assert: エラーが出ること
    expect(result.valid).toBe(false);
    expect(result.errors).toHaveLength(1);
    expect(result.errors[0].type).toBe('missing_file');
  });

  it('main/develop ブランチの仕様書は常にチェック対象になる', async () => {
    // Arrange: feature ブランチで実行中
    mockGetCurrentBranch.mockReturnValue('feature/test');

    // main ブランチの仕様書レコードを作成
    await db.insertInto('specs').values({
      id: 'test-id',
      name: 'Test Spec',
      branch_name: 'main', // 共通ブランチ
      phase: 'requirements',
    }).execute();

    // ファイルは存在しない (異常)

    // Act
    const result = await checker.check();

    // Assert: エラーが出ること (main は常にチェック対象)
    expect(result.valid).toBe(false);
    expect(result.errors).toHaveLength(1);
  });
});
```

#### 7.5.2. E2E テスト (tests/e2e/branch-filtering.test.ts)

**新規テストケース:**

```typescript
describe('/cft:status - ブランチフィルタリング', () => {
  it('別ブランチの仕様書は誤検知されない', async () => {
    // 1. develop ブランチで仕様書を作成
    execSync('git checkout develop');
    execSync('/cft:spec-create "Test Spec in Develop"');

    // 2. feature ブランチに切り替え
    execSync('git checkout -b feature/test');

    // 3. /cft:status 実行
    const output = execSync('/cft:status').toString();

    // 4. 誤検知がないことを確認
    expect(output).not.toContain('Found X database record(s) without corresponding file');
  });
});
```

### 7.6. 非機能要件

#### 7.6.1. パフォーマンス

- **ブランチ名の取得**: `getCurrentBranch()` はキャッシュされているため、1 回の Git コマンド実行のみ
- **ブランチフィルタリング**: 文字列比較のみ（配列の includes チェック）で高速
- **オーダー**: O(n) のループ処理は変わらず、追加コストは negligible

#### 7.6.2. 後方互換性

- **データベーススキーマ変更なし**: 既存の `specs.branch_name` カラムを使用
- **API 変更なし**: `IntegrityChecker` の公開 API は変更なし
- **既存テストの影響**: 既存テストは全て通過する（ブランチモックの追加のみ）

### 7.7. ロールアウトプラン

1. **Phase 1: IntegrityChecker の修正**
   - `src/core/sync/integrity-checker.ts` の修正
   - 単体テストの追加・実行

2. **Phase 2: repair-database.ts の修正**
   - `src/scripts/repair-database.ts` の修正
   - E2E テストの追加・実行

3. **Phase 3: 検証**
   - 全テストスイートを実行して通過を確認
   - develop ブランチで `/cft:status` を実行して誤検知がゼロになることを確認

4. **Phase 4: completed フェーズへ移行**
   - `/cft:spec-phase 7d86e424 completed` で完了

---

## 8. 実装タスクリスト

### Phase 1: IntegrityChecker の修正

- [ ] **タスク 1**: `IntegrityChecker.check()` メソッドにブランチフィルタリングロジックを追加
  - `src/core/sync/integrity-checker.ts` を修正
  - `getCurrentBranch()` をインポート
  - `allowedBranches = [currentBranch, 'main', 'develop']` を追加
  - ループ内でブランチフィルタリングを実装

### Phase 2: repair-database.ts の修正

- [ ] **タスク 2**: `repair-database.ts` スクリプトにブランチフィルタリングロジックを追加
  - `src/scripts/repair-database.ts` を修正
  - IntegrityChecker と同じロジックを適用

### Phase 3: エラーメッセージの改善

- [ ] **タスク 3**: エラーメッセージにブランチ情報を含めるように改善
  - エラーオブジェクトに `branchName` フィールドを追加
  - エラー出力時に現在のブランチ情報を表示

### Phase 4: テストの追加

- [ ] **タスク 4**: IntegrityChecker の単体テストを追加（3 件のテストケース）
  - `tests/core/sync/integrity-checker.test.ts` を作成/更新
  - テストケース 1: 別ブランチの仕様書はエラーを出さない
  - テストケース 2: 現在のブランチの仕様書でファイルが存在しない場合はエラーを出す
  - テストケース 3: main/develop ブランチの仕様書は常にチェック対象になる

- [ ] **タスク 5**: ブランチフィルタリングの E2E テストを追加
  - `tests/e2e/branch-filtering.test.ts` を作成
  - ブランチ切り替え時の誤検知がないことを確認

### Phase 5: 検証

- [ ] **タスク 6**: 全テストスイートを実行して既存テストが通過することを確認
  - `npm test` を実行
  - カバレッジレポートを確認

- [ ] **タスク 7**: `/cft:status` を実行して誤検知がゼロになることを検証
  - develop ブランチで実行
  - 別ブランチの仕様書が「ファイルが存在しない」エラーを出さないことを確認
