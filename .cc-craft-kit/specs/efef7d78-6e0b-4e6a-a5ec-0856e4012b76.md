# 各フェーズ完了時未コミット状態のものがある（特に仕様書）

**仕様書 ID:** efef7d78-6e0b-4e6a-a5ec-0856e4012b76
**フェーズ:** tasks
**作成日時:** 2025/11/22 21:55:59
**更新日時:** 2025/11/23 10:59:53

---

## 1. 背景と目的

### 背景

現在、cc-craft-kit では各フェーズ完了時に自動コミットが実行されるが、以下の問題が発生している:

1. **仕様書ファイルが未コミット状態になる**: `src/core/workflow/git-integration.ts` の `getCommitTargets()` 関数では、`completed` フェーズ以外は仕様書ファイル (`.cc-craft-kit/specs/{spec-id}.md`) のみをコミット対象としている（183行目）
2. **その他のファイルも未コミット状態になる可能性**: タスク分解フェーズや設計フェーズで追加したドキュメントやコード変更が、`completed` フェーズまでコミットされない
3. **Git ステータスの混乱**: フェーズ移行のたびに `git status` で未コミット変更が蓄積され、開発者が混乱する

### 目的

各フェーズ完了時に、そのフェーズで変更されたすべてのファイルを確実にコミットし、Git の作業ツリーをクリーンな状態に保つ。

---

## 2. 対象ユーザー

- cc-craft-kit を使用して仕様駆動開発を実践する開発者
- フェーズ移行時の自動コミット機能を利用する開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] 各フェーズ完了時に、未コミットの変更がすべて自動コミットされる
- [ ] `requirements`, `design`, `tasks`, `implementation`, `completed` の全フェーズで動作する
- [ ] Git リポジトリでない場合は、エラーを出さずにスキップする

### 機能要件

- [ ] `getCommitTargets()` 関数を修正し、すべてのフェーズで全変更ファイル (`.`) をコミット対象とする
- [ ] コミットメッセージは従来通り、フェーズに応じた適切なメッセージを生成する
- [ ] `.gitignore` で除外されているファイルは、コミット対象から自動的に除外される

### 非機能要件

- [ ] 既存のテストがすべて通過する
- [ ] `git-integration.ts` のコード品質を維持する
- [ ] エラーハンドリングが適切に実装されている

---

## 4. 制約条件

- 既存の自動コミット機能 (`handlePhaseChangeCommit`, `handleSpecCreatedCommit`) のインターフェースは変更しない
- Git コマンドの実行には `spawnSync` を使用し、シェルインジェクション対策を維持する
- フェーズ移行時のイベント駆動アーキテクチャは変更しない

---

## 5. 依存関係

- `src/core/workflow/git-integration.ts`: 自動コミット処理の実装
- `src/core/workflow/event-bus.ts`: イベント駆動アーキテクチャ
- `tests/e2e/phase-transition-commit.test.ts`: フェーズ移行時のコミット動作テスト

---

## 6. 参考情報

- コード箇所: `src/core/workflow/git-integration.ts:167-184` (`getCommitTargets()` 関数)
- 関連する Git ステータスチェック処理: `src/core/workflow/git-integration.ts:44-107` (`checkGitStatus()` 関数)

---

## 7. 詳細設計

### 7.1 アーキテクチャ設計

本修正は、既存のイベント駆動アーキテクチャを維持したまま、Git 自動コミット処理の対象範囲を拡張します。

```
┌─────────────────────────────────────────────────────────────────┐
│                      フェーズ移行処理                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. SpecService.updatePhase(specId, newPhase)                  │
│       │                                                         │
│       ├─→ データベース更新 (specs.phase)                        │
│       ├─→ Markdown ファイル更新 (.cc-craft-kit/specs/{id}.md)  │
│       │                                                         │
│       └─→ EventBus.emit('spec.phase_changed', { ... })         │
│                │                                                │
│                ▼                                                │
│  2. GitIntegration.handlePhaseChangeCommit()                   │
│       │                                                         │
│       ├─→ checkGitStatus()                                     │
│       │     ├─ リポジトリ存在確認                               │
│       │     └─ 未コミット変更の確認                             │
│       │                                                         │
│       ├─→ getCommitTargets(phase, specId) [修正対象]            │
│       │     │                                                   │
│       │     ├─ completed フェーズ: ['.']                        │
│       │     └─ その他フェーズ: ['.'] (修正後)                   │
│       │                                                         │
│       └─→ gitCommit(files, message)                            │
│             ├─ git add <files>                                 │
│             ├─ git commit -m <message>                         │
│             └─ 失敗時 git reset HEAD でロールバック             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 修正内容

#### 7.2.1 `getCommitTargets()` 関数の修正

**修正前:**
```typescript
function getCommitTargets(phase: Phase, specId: string): string[] {
  // specIdのバリデーション（UUID形式）
  const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
  if (!uuidPattern.test(specId)) {
    throw new Error(`Invalid spec ID format: ${specId}`);
  }

  if (phase === 'completed') {
    // completedフェーズでは全変更をコミット
    return ['.'];
  }

  // パストラバーサル対策
  const safeSpecId = path.basename(specId);

  // その他のフェーズでは仕様書ファイルのみ
  return [`.cc-craft-kit/specs/${safeSpecId}.md`];
}
```

**修正後:**
```typescript
function getCommitTargets(phase: Phase, specId: string): string[] {
  // specIdのバリデーション（UUID形式）
  const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
  if (!uuidPattern.test(specId)) {
    throw new Error(`Invalid spec ID format: ${specId}`);
  }

  // 全フェーズで全変更をコミット
  return ['.'];
}
```

**変更点:**
1. `completed` フェーズのみ全変更をコミットする分岐を削除
2. すべてのフェーズで `['.']` を返すようにシンプル化
3. パストラバーサル対策のコード（`path.basename(specId)`）は不要になるため削除

**削除される理由:**
- `specId` のバリデーションで UUID 形式チェックを実施しているため、パストラバーサルのリスクは既に防止されている
- `['.']` を返す場合、個別のファイルパスを構築する必要がないため、`path.basename()` は不要

### 7.3 データフロー設計

#### 7.3.1 修正前のデータフロー

```
requirements → design
  ├─ コミット対象: .cc-craft-kit/specs/{id}.md のみ
  └─ その他の変更ファイルは未コミット状態で残る

design → tasks
  ├─ コミット対象: .cc-craft-kit/specs/{id}.md のみ
  └─ 設計フェーズで追加したドキュメントは未コミット状態で残る

tasks → implementation
  ├─ コミット対象: .cc-craft-kit/specs/{id}.md のみ
  └─ タスク分解フェーズで追加したファイルは未コミット状態で残る

implementation → completed
  ├─ コミット対象: . (全変更ファイル)
  └─ 蓄積された全未コミット変更をまとめてコミット
```

#### 7.3.2 修正後のデータフロー

```
requirements → design
  ├─ コミット対象: . (全変更ファイル)
  └─ 仕様書ファイルとその他の変更をすべてコミット

design → tasks
  ├─ コミット対象: . (全変更ファイル)
  └─ 設計フェーズで追加したドキュメント、コードをすべてコミット

tasks → implementation
  ├─ コミット対象: . (全変更ファイル)
  └─ タスク分解フェーズで追加したファイルをすべてコミット

implementation → completed
  ├─ コミット対象: . (全変更ファイル)
  └─ 実装完了時の変更をすべてコミット
```

**メリット:**
- 各フェーズ完了時に Git 作業ツリーがクリーンになる
- フェーズごとに変更内容が明確に記録される
- 未コミット変更の蓄積による混乱を防止

### 7.4 エラーハンドリング設計

既存のエラーハンドリング機構を維持します。

| エラーケース | 処理内容 |
|-------------|---------|
| Git リポジトリでない | `checkGitStatus()` で検出し、警告メッセージを表示してスキップ |
| 未コミット変更なし | `checkGitStatus()` で検出し、情報メッセージを表示してスキップ |
| `git add` 失敗 | エラーメッセージをログに記録し、コミット処理を中断 |
| `git commit` 失敗 | `git reset HEAD` でステージングをロールバックし、エラーメッセージを記録 |
| UUID 形式不正 | `getCommitTargets()` で例外をスローし、呼び出し元でキャッチ |

**変更なし:**
- エラーハンドリングロジックは既存の実装をそのまま維持
- セキュリティ機構（UUID バリデーション、`.gitignore` チェック）も維持

### 7.5 セキュリティ設計

#### 7.5.1 既存のセキュリティ機構（維持）

| 項目 | 実装内容 |
|------|---------|
| シェルインジェクション対策 | `spawnSync()` で引数を配列として渡し、シェル経由の実行を回避 |
| パストラバーサル対策 | UUID 形式バリデーションで不正なパスを防止 |
| `.gitignore` 遵守 | `getIgnoredFiles()` で除外ファイルを確認し、コミット対象から除外 |

#### 7.5.2 修正による影響

**影響なし:**
- `['.']` を使用することで、Git の標準的な動作を利用
- `.gitignore` に記載されたファイルは自動的に除外される
- UUID バリデーションにより、`specId` の安全性は保証済み

**削除されるコード:**
```typescript
// パストラバーサル対策（不要になる）
const safeSpecId = path.basename(specId);
```

**削除理由:**
- UUID 形式チェックで既にパストラバーサルを防止
- `['.']` を返す場合、個別ファイルパスを構築しないため、対策不要

### 7.6 パフォーマンス設計

#### 7.6.1 Git コマンド実行回数

**修正前・修正後ともに同じ:**
1. `git status --porcelain` (未コミット変更確認)
2. `git add .` (変更ファイルのステージング)
3. `git commit -m <message>` (コミット実行)

**影響:**
- コマンド実行回数に変化なし
- パフォーマンスへの影響なし

#### 7.6.2 `.gitignore` チェック処理

**修正前:**
```typescript
// 個別ファイル指定時のみ .gitignore チェック
const ignoredFiles = new Set(getIgnoredFiles(files));
const filesToAdd = files.filter((file) => !ignoredFiles.has(file));
```

**修正後:**
```typescript
// git add . の場合は .gitignore チェックをスキップ
if (files.length === 1 && files[0] === '.') {
  const addResult = spawnSync('git', ['add', '.'], {
    stdio: ['ignore', 'pipe', 'pipe'],
  });
  // ...
}
```

**パフォーマンス改善:**
- `git add .` の場合、`.gitignore` チェック処理をスキップ
- Git が自動的に除外ファイルを判定するため、処理が高速化

### 7.7 テスト設計

#### 7.7.1 修正が必要なテストケース

**ファイル:** `tests/e2e/phase-transition-commit.test.ts`

**修正対象テスト:**
- `requirements → design: 仕様書ファイルのみコミット` (277行目)
- `design → tasks: 仕様書ファイルのみコミット` (286行目)
- `tasks → implementation: 仕様書ファイルのみコミット` (303行目)
- `completed以外: 仕様書ファイルのみコミット` (335行目)

**修正内容:**
```typescript
// 修正前
expectCommitTargetsToBe([`.cc-craft-kit/specs/${specId}.md`]);

// 修正後
expectCommitTargetsToBe(['.']);
```

**テストケース名も変更:**
```typescript
// 修正前
test('requirements → design: 仕様書ファイルのみコミット', async () => {

// 修正後
test('requirements → design: 全変更ファイルをコミット', async () => {
```

#### 7.7.2 テストカバレッジ

**既存テストで検証される内容:**
- 各フェーズ移行時に自動コミットが実行されること
- コミットメッセージが正しいこと
- 未コミット変更がない場合にスキップされること
- Git リポジトリでない場合にスキップされること
- コミット失敗時にロールバックが実行されること

**追加テストは不要:**
- 既存のテストケースを修正するだけで、新機能のテストカバレッジを維持できる

### 7.8 後方互換性設計

#### 7.8.1 破壊的変更の有無

**破壊的変更なし:**
- `getCommitTargets()` は内部関数であり、外部 API ではない
- `handlePhaseChangeCommit()` のインターフェースは変更なし
- イベント駆動アーキテクチャは変更なし

#### 7.8.2 既存機能への影響

**影響あり（意図的な動作変更）:**
- `completed` フェーズ以外でも全変更がコミットされる

**影響なし:**
- コミットメッセージの生成ロジック
- エラーハンドリング
- GitHub 統合機能

### 7.9 実装手順

1. **`src/core/workflow/git-integration.ts` の修正**
   - `getCommitTargets()` 関数を修正
   - 不要なコード（`path.basename()` 呼び出し）を削除

2. **テストケースの修正**
   - `tests/e2e/phase-transition-commit.test.ts` のアサーションを更新
   - テストケース名を更新

3. **型チェックとリント実行**
   - `npx tsc --noEmit` で型エラーがないことを確認
   - `npm run lint` でコードスタイルを確認

4. **テスト実行**
   - `npm test` で全テストが通過することを確認

5. **動作確認**
   - 実際にフェーズ移行を実行し、全変更がコミットされることを確認
   - `git log` でコミットメッセージが正しいことを確認

---
