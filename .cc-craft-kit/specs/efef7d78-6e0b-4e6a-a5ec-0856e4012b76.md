# 各フェーズ完了時未コミット状態のものがある（特に仕様書）

**仕様書 ID:** efef7d78-6e0b-4e6a-a5ec-0856e4012b76
**フェーズ:** requirements
**作成日時:** 2025/11/22 21:55:59
**更新日時:** 2025/11/23 10:53:43

---

## 1. 背景と目的

### 背景

現在、cc-craft-kit では各フェーズ完了時に自動コミットが実行されるが、以下の問題が発生している:

1. **仕様書ファイルが未コミット状態になる**: `src/core/workflow/git-integration.ts` の `getCommitTargets()` 関数では、`completed` フェーズ以外は仕様書ファイル (`.cc-craft-kit/specs/{spec-id}.md`) のみをコミット対象としている（183行目）
2. **その他のファイルも未コミット状態になる可能性**: タスク分解フェーズや設計フェーズで追加したドキュメントやコード変更が、`completed` フェーズまでコミットされない
3. **Git ステータスの混乱**: フェーズ移行のたびに `git status` で未コミット変更が蓄積され、開発者が混乱する

### 目的

各フェーズ完了時に、そのフェーズで変更されたすべてのファイルを確実にコミットし、Git の作業ツリーをクリーンな状態に保つ。

---

## 2. 対象ユーザー

- cc-craft-kit を使用して仕様駆動開発を実践する開発者
- フェーズ移行時の自動コミット機能を利用する開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] 各フェーズ完了時に、未コミットの変更がすべて自動コミットされる
- [ ] `requirements`, `design`, `tasks`, `implementation`, `completed` の全フェーズで動作する
- [ ] Git リポジトリでない場合は、エラーを出さずにスキップする

### 機能要件

- [ ] `getCommitTargets()` 関数を修正し、すべてのフェーズで全変更ファイル (`.`) をコミット対象とする
- [ ] コミットメッセージは従来通り、フェーズに応じた適切なメッセージを生成する
- [ ] `.gitignore` で除外されているファイルは、コミット対象から自動的に除外される

### 非機能要件

- [ ] 既存のテストがすべて通過する
- [ ] `git-integration.ts` のコード品質を維持する
- [ ] エラーハンドリングが適切に実装されている

---

## 4. 制約条件

- 既存の自動コミット機能 (`handlePhaseChangeCommit`, `handleSpecCreatedCommit`) のインターフェースは変更しない
- Git コマンドの実行には `spawnSync` を使用し、シェルインジェクション対策を維持する
- フェーズ移行時のイベント駆動アーキテクチャは変更しない

---

## 5. 依存関係

- `src/core/workflow/git-integration.ts`: 自動コミット処理の実装
- `src/core/workflow/event-bus.ts`: イベント駆動アーキテクチャ
- `tests/e2e/phase-transition-commit.test.ts`: フェーズ移行時のコミット動作テスト

---

## 6. 参考情報

- コード箇所: `src/core/workflow/git-integration.ts:167-184` (`getCommitTargets()` 関数)
- 関連する Git ステータスチェック処理: `src/core/workflow/git-integration.ts:44-107` (`checkGitStatus()` 関数)
