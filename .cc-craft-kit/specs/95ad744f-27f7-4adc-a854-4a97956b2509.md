---
id: "95ad744f-27f7-4adc-a854-4a97956b2509"
name: "/cft:spec-phase のフェーズ引数を省略形で指定可能にする"
phase: "completed"
branch_name: "main"
github_issue_number: null
pr_url: null
created_at: "2025-11-18T16:17:13Z"
updated_at: "2025-11-18T18:23:17Z"
---

# /cft:spec-phase のフェーズ引数を省略形で指定可能にする


## 1. 背景と目的

### 背景

現在、`/cft:spec-phase` コマンドでフェーズを変更する際、フェーズ名を完全に入力する必要があります（例: `requirements`, `implementation`, `tasks`）。開発効率を向上させるため、省略形での指定を可能にする必要があります。

### 目的

フェーズ引数に省略形を導入し、コマンド入力の利便性を向上させることで、開発者の生産性を高めます。
---

## 2. 対象ユーザー

cc-craft-kit を使用するすべての開発者、特に以下のようなユーザー:

- 頻繁にフェーズ変更コマンドを実行する開発者
- コマンド入力の効率化を求める開発者
- CLI ツールの使いやすさを重視する開発者
---

## 3. 受け入れ基準

### 必須要件

- [ ] `requirements` → `req` で指定可能
- [ ] `implementation` → `impl`（推奨）または `imp`（後方互換性）で指定可能
- [ ] `tasks` → `task` で指定可能
- [ ] `design` → `des` で指定可能
- [ ] `completed` → `comp` で指定可能
- [ ] 完全なフェーズ名での指定も引き続きサポート

### 機能要件

- [ ] 省略形と完全形のマッピングロジックを実装
- [ ] 無効な省略形が指定された場合、以下のエラーメッセージを表示:
  ```
  エラー: 無効なフェーズ指定 '<入力値>' です。

  有効なフェーズ:
    - requirements (省略形: req)
    - design (省略形: des)
    - tasks (省略形: task)
    - implementation (省略形: impl, imp)
    - completed (省略形: comp)
  ```
- [ ] 大文字小文字を区別しない（`REQ`, `Req`, `req` すべて有効）
- [ ] `/cft:spec-phase <spec-id> <phase>` コマンドで省略形をサポート

### 非機能要件

- [ ] 既存のコードとの後方互換性を維持
- [ ] エラーメッセージは日本語で分かりやすく表示
- [ ] パフォーマンスへの影響がないこと（マッピング処理は軽量）

### テスト要件

- [ ] 単体テストでカバレッジ 100%を達成
- [ ] 以下のテストケースを実装:
  - **正常系:**
    - 完全なフェーズ名での指定（`requirements`, `design`, etc.）
    - 各省略形での指定（`req`, `des`, `task`, `impl`, `imp`, `comp`）
    - 大文字小文字混在パターン（`REQ`, `Req`, `ImPl`）
  - **異常系:**
    - 存在しないフェーズ名（`invalid`, `xxx`）
    - 空文字列
    - 数値のみの入力
    - 特殊文字を含む入力
  - **エッジケース:**
    - 前後に空白を含む入力（`" req "`, `"impl "`）
    - 部分一致する誤入力（`imple`, `require`）
---

## 4. 制約条件

- 省略形は既存のフェーズ名（`requirements`, `design`, `tasks`, `implementation`, `completed`）に対してのみ定義
- 省略形の衝突を避けるため、各フェーズの省略形はユニークでなければならない
- TypeScript の型安全性を維持（フェーズ型は `SpecPhase` 型で管理）
---

## 5. 依存関係

### 既存コンポーネント

- `src/commands/spec/phase.ts` - フェーズ変更コマンドの実装
- `src/core/database/types.ts` - `SpecPhase` 型定義
- `src/slash-commands/spec-phase.md` - スラッシュコマンド定義

### 更新が必要なドキュメント

- `src/slash-commands/spec-phase.md` - スラッシュコマンド定義に省略形の使用例を追加
- `docs/QUICK_START.md` - クイックスタートガイドに省略形の説明を追加
- `README.md` - コマンドリファレンスセクションに省略形の一覧を追加

### 依存する仕様

- なし（独立した機能追加）
---

## 6. 参考情報

- **Git エイリアス設計:**
  - Git の省略形慣習（`co` → `checkout`, `st` → `status`）
  - 参考: https://git-scm.com/book/en/v2/Git-Basics-Git-Aliases
- **CLI ベストプラクティス:**
  - POSIX CLI 規約
  - 12 Factor CLI Apps: https://medium.com/@jdxcode/12-factor-cli-apps-dd3c227a0e46
- **TypeScript 型安全性:**
  - Branded Types パターン
  - Discriminated Unions の活用
---

## 7. 実装方針

### マッピングロジック

フェーズの省略形マッピングは以下の方法で実装します:

```typescript
// src/core/workflow/phase-mapping.ts
const PHASE_ALIASES: Record<string, SpecPhase> = {
  'req': 'requirements',
  'des': 'design',
  'task': 'tasks',
  'impl': 'implementation',
  'imp': 'implementation',
  'comp': 'completed',
} as const;

export function normalizePhase(input: string): SpecPhase {
  const normalized = input.toLowerCase().trim();
  return PHASE_ALIASES[normalized] ?? normalized as SpecPhase;
}
```

### 変更対象ファイル

1. **新規作成:** `src/core/workflow/phase-mapping.ts`
   - フェーズ正規化関数の実装

2. **修正:** `src/commands/spec/phase.ts`
   - `normalizePhase()` 関数を使用してフェーズ引数を処理

3. **修正:** `src/slash-commands/spec-phase.md`
   - ドキュメントに省略形の使用例を追加
---

## 8. 設計詳細

### 8.1 アーキテクチャ設計

#### 設計方針

フェーズ省略形の実装は、以下の設計原則に従います:

1. **シンプルさ**: マッピングロジックは単純明快に保つ
2. **型安全性**: TypeScript の型システムを活用して実行時エラーを防ぐ
3. **拡張性**: 将来的な新フェーズ追加に柔軟に対応
4. **後方互換性**: 既存の完全形フェーズ名を引き続きサポート

#### アーキテクチャ図

```
┌─────────────────────────────────────────┐
│  /cft:spec-phase <spec-id> <phase>      │
│  (Slash Command)                        │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│  src/commands/spec/phase.ts             │
│  - validatePhase() を呼び出し            │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│  src/commands/utils/validation.ts       │
│  - normalizePhase() を呼び出し           │
│  - 正規化されたフェーズ名で検証          │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│  src/core/workflow/phase-mapping.ts     │
│  - PHASE_ALIASES マッピング              │
│  - normalizePhase() 実装                 │
└─────────────────────────────────────────┘
```

### 8.2 API/インターフェース設計

#### 新規作成: `src/core/workflow/phase-mapping.ts`

```typescript
/**
 * フェーズの省略形マッピング
 */

import type { Phase } from '../../commands/utils/validation.js';

/**
 * フェーズ省略形のマッピングテーブル
 */
export const PHASE_ALIASES: Record<string, Phase> = {
  'req': 'requirements',
  'des': 'design',
  'task': 'tasks',
  'impl': 'implementation',
  'imp': 'implementation',  // 後方互換性
  'comp': 'completed',
} as const;

/**
 * フェーズ省略形を正規化
 *
 * @param input - ユーザー入力のフェーズ名（省略形または完全形）
 * @returns 正規化されたフェーズ名
 *
 * @example
 * normalizePhase('req') // => 'requirements'
 * normalizePhase('REQ') // => 'requirements'
 * normalizePhase('requirements') // => 'requirements'
 * normalizePhase(' impl ') // => 'implementation'
 */
export function normalizePhase(input: string): string {
  // 大文字小文字を統一し、前後の空白を削除
  const normalized = input.toLowerCase().trim();

  // エイリアスマッピングを確認
  return PHASE_ALIASES[normalized] ?? normalized;
}

/**
 * 有効なフェーズ省略形のヘルプメッセージを生成
 *
 * @returns フェーズ省略形の一覧を含むヘルプメッセージ
 */
export function getPhaseAliasesHelp(): string {
  return `有効なフェーズ:
  - requirements (省略形: req)
  - design (省略形: des)
  - tasks (省略形: task)
  - implementation (省略形: impl, imp)
  - completed (省略形: comp)`;
}
```

#### 修正: `src/commands/utils/validation.ts`

**変更内容:**

```typescript
import { normalizePhase, getPhaseAliasesHelp } from '../../core/workflow/phase-mapping.js';

/**
 * フェーズ名検証（省略形対応）
 */
export function validatePhase(phase: string): Phase {
  // 省略形を正規化
  const normalizedPhase = normalizePhase(phase);

  if (!VALID_PHASES.includes(normalizedPhase as Phase)) {
    const errorMessage = `エラー: 無効なフェーズ指定 '${phase}' です。\n\n${getPhaseAliasesHelp()}`;
    throw createInvalidPhaseError(errorMessage);
  }

  return normalizedPhase as Phase;
}
```

#### エラーハンドリング

**無効なフェーズ指定時のエラーメッセージ:**

```
エラー: 無効なフェーズ指定 'xxx' です。

有効なフェーズ:
  - requirements (省略形: req)
  - design (省略形: des)
  - tasks (省略形: task)
  - implementation (省略形: impl, imp)
  - completed (省略形: comp)
```

### 8.3 データモデル設計

#### フェーズマッピングテーブル

| 省略形 | 完全形 | 備考 |
|--------|--------|------|
| `req` | `requirements` | 主要省略形 |
| `des` | `design` | 主要省略形 |
| `task` | `tasks` | 単数形を許容 |
| `impl` | `implementation` | 主要省略形 |
| `imp` | `implementation` | 後方互換性（3文字） |
| `comp` | `completed` | 主要省略形 |

#### 型定義

既存の `Phase` 型はそのまま維持:

```typescript
export type Phase =
  | 'requirements'
  | 'design'
  | 'tasks'
  | 'implementation'
  | 'completed';
```

### 8.4 パフォーマンス設計

#### 処理フロー

1. **入力受付**: ユーザーがフェーズ引数を入力（例: `req`）
2. **正規化**: `normalizePhase()` で小文字化・トリム・マッピング（O(1)）
3. **検証**: `validatePhase()` で `VALID_PHASES` 配列をチェック（O(n)、n=5）
4. **データベース更新**: フェーズ更新処理

**期待される性能:**
- 正規化処理: < 1ms
- 検証処理: < 1ms
- 合計オーバーヘッド: < 2ms（無視できるレベル）

### 8.5 セキュリティ設計

#### 入力検証

1. **大文字小文字の正規化**: インジェクション攻撃を防止
2. **空白のトリム**: 意図しない入力を排除
3. **ホワイトリスト検証**: `VALID_PHASES` による厳密な検証

#### セキュリティリスク

- **リスク**: なし（フェーズ名は固定の列挙値のみ許可）
- **対策**: ホワイトリスト方式により、予期しない値は完全にブロック

### 8.6 テスト設計

#### 単体テストケース

**ファイル:** `tests/core/workflow/phase-mapping.test.ts`

```typescript
describe('normalizePhase', () => {
  describe('正常系', () => {
    it('完全なフェーズ名をそのまま返す', () => {
      expect(normalizePhase('requirements')).toBe('requirements');
      expect(normalizePhase('design')).toBe('design');
      expect(normalizePhase('tasks')).toBe('tasks');
      expect(normalizePhase('implementation')).toBe('implementation');
      expect(normalizePhase('completed')).toBe('completed');
    });

    it('省略形を完全形に変換する', () => {
      expect(normalizePhase('req')).toBe('requirements');
      expect(normalizePhase('des')).toBe('design');
      expect(normalizePhase('task')).toBe('tasks');
      expect(normalizePhase('impl')).toBe('implementation');
      expect(normalizePhase('imp')).toBe('implementation');
      expect(normalizePhase('comp')).toBe('completed');
    });

    it('大文字小文字を区別しない', () => {
      expect(normalizePhase('REQ')).toBe('requirements');
      expect(normalizePhase('Req')).toBe('requirements');
      expect(normalizePhase('ImPl')).toBe('implementation');
    });

    it('前後の空白を削除する', () => {
      expect(normalizePhase(' req ')).toBe('requirements');
      expect(normalizePhase('  impl  ')).toBe('implementation');
    });
  });

  describe('異常系', () => {
    it('無効なフェーズ名はそのまま返す（後続の検証でエラー）', () => {
      expect(normalizePhase('invalid')).toBe('invalid');
      expect(normalizePhase('xxx')).toBe('xxx');
    });
  });
});
```

**ファイル:** `tests/commands/utils/validation.test.ts`

```typescript
describe('validatePhase', () => {
  describe('正常系', () => {
    it('完全なフェーズ名を受け入れる', () => {
      expect(validatePhase('requirements')).toBe('requirements');
      expect(validatePhase('design')).toBe('design');
    });

    it('省略形を受け入れて正規化する', () => {
      expect(validatePhase('req')).toBe('requirements');
      expect(validatePhase('impl')).toBe('implementation');
    });
  });

  describe('異常系', () => {
    it('無効なフェーズ名でエラーを投げる', () => {
      expect(() => validatePhase('invalid')).toThrow('無効なフェーズ指定');
    });

    it('空文字列でエラーを投げる', () => {
      expect(() => validatePhase('')).toThrow('無効なフェーズ指定');
    });
  });
});
```

#### E2E テストケース

**シナリオ 1: 省略形でのフェーズ変更**

```bash
# テスト準備
/cft:spec-create "省略形テスト" "省略形のE2Eテスト"

# 省略形でフェーズ変更
/cft:spec-phase <spec-id> des
# 期待: design フェーズに移行

/cft:spec-phase <spec-id> impl
# 期待: implementation フェーズに移行

/cft:spec-phase <spec-id> comp
# 期待: completed フェーズに移行
```

**シナリオ 2: 無効な省略形のエラー処理**

```bash
/cft:spec-phase <spec-id> xxx
# 期待: エラーメッセージ表示（省略形一覧を含む）
```
---

## 9. 実装タスクリスト

### タスク分解

設計セクションで定義したアーキテクチャに基づいて、以下のタスクに分解します。

#### タスク 1: フェーズマッピングモジュールの作成

**ファイル:** `src/core/workflow/phase-mapping.ts`（新規作成）

**作業内容:**
- `PHASE_ALIASES` マッピングテーブルを定義
- `normalizePhase()` 関数を実装
- `getPhaseAliasesHelp()` 関数を実装

**受け入れ基準:**
- 省略形から完全形へのマッピングが正しく動作する
- 大文字小文字を区別しない
- 前後の空白をトリムする
- TypeScript の型安全性を維持
---

#### タスク 2: バリデーションロジックの修正

**ファイル:** `src/commands/utils/validation.ts`（修正）

**作業内容:**
- `phase-mapping.ts` から `normalizePhase()` と `getPhaseAliasesHelp()` をインポート
- `validatePhase()` 関数に省略形正規化ロジックを追加
- エラーメッセージにヘルプテキストを含める

**受け入れ基準:**
- 省略形が正規化されてから検証される
- 無効なフェーズ指定時に分かりやすいエラーメッセージが表示される
- 既存の完全形フェーズ名も引き続き動作する
---

#### タスク 3: 単体テストの作成（phase-mapping）

**ファイル:** `tests/core/workflow/phase-mapping.test.ts`（新規作成）

**作業内容:**
- `normalizePhase()` の正常系テストケースを実装
- `normalizePhase()` の異常系テストケースを実装
- `getPhaseAliasesHelp()` のテストケースを実装

**受け入れ基準:**
- カバレッジ 100%を達成
- すべてのテストケースがパスする
---

#### タスク 4: 単体テストの追加（validation）

**ファイル:** `tests/commands/utils/validation.test.ts`（修正）

**作業内容:**
- `validatePhase()` の省略形テストケースを追加
- 大文字小文字混在のテストケースを追加
- 前後空白のテストケースを追加

**受け入れ基準:**
- 省略形が正しく受け入れられる
- 無効な省略形でエラーが投げられる
---

#### タスク 5: E2E テストの実行

**作業内容:**
- 実際に `/cft:spec-phase <spec-id> req` などのコマンドを実行
- 省略形が正しく動作することを確認
- 無効な省略形でエラーメッセージが表示されることを確認

**検証コマンド:**
```bash
/cft:spec-create "省略形テスト" "E2Eテスト用"
/cft:spec-phase <spec-id> des  # design に移行
/cft:spec-phase <spec-id> task # tasks に移行
/cft:spec-phase <spec-id> impl # implementation に移行
/cft:spec-phase <spec-id> comp # completed に移行
```

**受け入れ基準:**
- すべての省略形が正しく動作する
- GitHub Issue のフェーズラベルが正しく更新される
---

#### タスク 6: ドキュメント更新

**ファイル:** `src/slash-commands/spec-phase.md`（修正）

**作業内容:**
- 省略形の使用例を追加
- 有効な省略形の一覧を追加

**受け入れ基準:**
- ドキュメントが最新の機能を反映している
- ユーザーが省略形を簡単に理解できる
---

### 実装順序

1. **タスク 1** → **タスク 2**: コア機能の実装
2. **タスク 3** → **タスク 4**: 単体テストの実装
3. **タスク 5**: E2E テスト
4. **タスク 6**: ドキュメント更新

### 依存関係

- タスク 2 はタスク 1 完了後に実行
- タスク 3, 4 はタスク 1, 2 完了後に並行実行可能
- タスク 5 はタスク 1, 2 完了後に実行
- タスク 6 は独立して実行可能
---
