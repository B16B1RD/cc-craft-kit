# /cft:spec-create で、要件定義が自動実行されていない？

**仕様書 ID:** c723782f-c1fa-4a57-b880-bc4d2cbb2cf0
**フェーズ:** completed
**作成日時:** 2025/11/27 12:05:00
**更新日時:** 2025/11/27 19:07:00

---

## 1. 背景と目的

### 背景

`/cft:spec-create` 実行後のガイダンスメッセージを見ると次のステップとして、「1. 仕様書を編集して要件を定義する」となっている。本来自動で要件を定義する仕様としているので、これはおかしい。

現在のスラッシュコマンド定義（spec-create.md）では、Step 8（コードベース解析）と Step 9（仕様書の自動完成）がオプションとなっており、条件に該当しない場合はテンプレート状態のまま仕様書が保存される。また、成功メッセージのテンプレートも「1. 仕様書を編集して要件を定義する」となっており、自動完成が行われた場合でも同じメッセージが表示される。

### 目的

1. `/cft:spec-create` 実行時に、仕様書の要件定義を自動的に行う
2. 成功メッセージを自動完成の有無に応じて適切に変更する

---

## 2. 対象ユーザー

cc-craft-kit を使用して仕様駆動開発を行う開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-create` 実行時に、仕様書の要件定義（背景・目的・受け入れ基準など）が自動的に生成される
- [ ] ユーザーが入力した仕様書名と説明から、適切な要件定義が推論される

### 機能要件

- [ ] Step 8（コードベース解析）をオプションではなく必須にする、または条件を緩和する
- [ ] Step 9（仕様書の自動完成）を必ず実行する
- [ ] 成功メッセージの「次のステップ」を自動完成の有無に応じて変更する
  - 自動完成した場合: 「1. 仕様書の内容を確認・調整する」
  - 自動完成しなかった場合: 「1. 仕様書を編集して要件を定義する」

### 非機能要件

- [ ] 自動生成された要件定義は、後から手動で編集可能
- [ ] 自動生成に失敗した場合でも、テンプレート状態で仕様書は作成される

---

## 4. 制約条件

- プロンプトファースト原則に従い、スラッシュコマンド定義（.md）の修正で対応する
- スクリプト変更は不要（DB 登録処理は現状のまま）

---

## 5. 依存関係

- `/cft:spec-create` スラッシュコマンド定義（`src/slash-commands/spec-create.md`）
- 仕様書テンプレート

---

## 6. 参考情報

- 現在の spec-create.md の Step 8, Step 9 の実行条件
- 成功メッセージテンプレートの内容

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
/cft:spec-create 実行フロー（修正後）

Step 1-7: 現状維持（UUID生成 → ブランチ作成 → ファイル作成 → DB登録）
    │
    ▼
Step 8: コードベース解析（必須化）
    │ Task ツール → Explore サブエージェント
    │ ・修正対象ファイル特定
    │ ・類似機能パターン調査
    ▼
Step 9: 仕様書の自動完成（必須化）
    │ Edit ツール
    │ ・背景と目的を自動生成
    │ ・制約条件を自動生成
    │ ・依存関係を自動生成
    ▼
Step 10: 成功メッセージ（条件分岐）
    ├─ 自動完成成功: 「内容を確認・調整する」案内
    └─ 自動完成失敗: 「要件を定義する」案内
```

#### 設計方針

1. **Step 8 の実行条件を削除** - 常にコードベース解析を実行する
2. **Step 9 を Step 8 の結果に関係なく実行** - 解析結果がある場合は活用、ない場合はユーザー入力から推論
3. **成功メッセージの条件分岐** - Step 9 の成否に応じてメッセージを変更

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/slash-commands/spec-create.md` | Step 8-9 の実行条件削除、成功メッセージの条件分岐追加 |

#### Step 8 の修正内容

**Before（現状）:**
- 実行条件: 技術キーワード含有 OR `AUTO_ANALYZE_SPEC=1`
- 条件に該当しない場合: スキップ

**After（修正後）:**
- 実行条件: **なし（常に実行）**
- エラー時: 警告を表示して Step 9 へ進む（仕様書は作成される）

#### Step 9 の修正内容

**Before（現状）:**
- 実行条件: Step 8 が実行された場合のみ
- 置換ロジック: 不明確

**After（修正後）:**
- 実行条件: **なし（常に実行）**
- 置換ロジック:
  1. `(背景を記述してください)` → ユーザー入力 + 解析結果
  2. `(制約条件を記述してください)` → 技術スタック情報
  3. `(依存関係を記述してください)` → 関連モジュール情報

#### 成功メッセージの条件分岐

**Case 1: 自動完成成功**
```
次のステップ:
  1. 自動生成された内容を確認・調整する
  2. 設計フェーズに移行: /cft:spec-phase <短縮ID> design
```

**Case 2: 自動完成失敗（解析エラー等）**
```
⚠️ 自動要件定義に失敗しました。手動で編集してください。

次のステップ:
  1. 仕様書を編集して要件を定義する
  2. 設計フェーズに移行: /cft:spec-phase <短縮ID> design
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| Step 8 実行条件 | キーワード判定/環境変数 | 常に実行 | spec-create.md 197-227行目 |
| Step 9 実行条件 | Step 8 実行時のみ | 常に実行 | spec-create.md 229-242行目 |
| 成功メッセージ | 固定テンプレート | 条件分岐 | spec-create.md 259-278行目 |
| エラーハンドリング | 簡易 | 段階別メッセージ | spec-create.md 新規追加 |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| Step 8 自動実行 | 任意の仕様書名でコードベース解析が実行される | `/cft:spec-create "テスト仕様" "説明"` 実行 |
| Step 9 自動完成 | 背景・制約・依存関係が自動生成される | 生成された仕様書ファイルの内容確認 |
| 成功メッセージ分岐 | 自動完成の成否に応じたメッセージ表示 | 正常系/異常系で出力確認 |
| エラーハンドリング | 解析失敗時も仕様書が作成される | ネットワークエラー等をシミュレート |

### 7.5 移行計画

#### Phase 1: Step 8-9 の実行条件削除

1. Step 8 の実行条件（技術キーワード判定、環境変数チェック）を削除
2. Step 9 の実行条件（Step 8 依存）を削除
3. エラーハンドリングを追加（解析失敗時も処理継続）

#### Phase 2: 成功メッセージの条件分岐

1. Step 9 の成否を記録する仕組みを追加
2. 成功メッセージテンプレートを条件分岐に変更
3. 自動完成失敗時の警告メッセージを追加

---

## 8. 実装タスクリスト

### Phase 1: Step 8-9 の実行条件削除

- [x] Step 8 の実行条件を削除し、常に実行するように変更
- [x] Step 9 の実行条件を削除し、常に実行するように変更
- [x] Step 8 のエラーハンドリングを追加（失敗時も処理継続）

### Phase 2: 成功メッセージの条件分岐

- [x] 成功メッセージを自動完成の成否に応じて分岐
- [x] 自動完成失敗時の警告メッセージを追加
- [x] 動作確認テストを実施
