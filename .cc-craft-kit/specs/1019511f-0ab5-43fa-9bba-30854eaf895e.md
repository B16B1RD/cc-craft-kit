---
id: "1019511f-0ab5-43fa-9bba-30854eaf895e"
name: "/cft:spec phase completed 実行後もフェーズが review のまま"
phase: "implementation"
branch_name: "fix/spec-1019511f-phase-not-updated-to-completed"
github_issue_number: null
pr_url: null
created_at: "2025-12-07T07:50:00.000Z"
updated_at: "2025-12-07T08:10:00.000Z"
---

# /cft:spec phase completed 実行後もフェーズが review のまま

## 1. 背景と目的

### 背景

`/cft:spec phase <spec-id> completed` コマンドを実行しても、仕様書のフェーズが `completed` に更新されず、`review` のままになるバグが発生している。

具体的には、以下の4件の仕様書で問題が確認された:
- 035d4de4: 構成見直し
- 09b2c271: /cft:status と /cft:spec list で他ブランチの仕様書が表示されない
- 2bd1d231: completed フェーズ移行時にブランチ切り替えが行われない
- 843775ce: タスク完了時に対応する Sub Issue がクローズされない

### 目的

`/cft:spec phase <spec-id> completed` コマンド実行時に、仕様書のフェーズが確実に `completed` に更新されるようにする。

## 2. 現状の問題点

1. `/cft:spec phase` コマンドの実装に問題がある可能性
2. フェーズ更新処理が正しく実行されていない
3. ファイルへの書き込みが失敗している可能性

## 3. 調査項目

- [ ] `/cft:spec phase` コマンドの実装を確認
- [ ] フェーズ更新時のファイル書き込み処理を確認
- [ ] エラーハンドリングを確認

## 4. 期待される動作

1. `/cft:spec phase <spec-id> completed` 実行時
2. 仕様書ファイルの `phase:` フィールドが `"completed"` に更新される
3. `updated_at` が現在時刻に更新される
4. 成功メッセージが表示される

---

## 5. 原因分析

### 根本原因

`/cft:spec phase` コマンドは `.claude/commands/cft/spec.md` で定義されたプロンプトベースのコマンドである。このコマンドは Claude Code が解釈して実行するため、以下の問題が発生しうる:

1. **completed フェーズ時の後処理による中断**: completed フェーズへの移行時には以下の後処理が定義されている:
   - ベースブランチへの切り替え (`git checkout develop`)
   - 作業ブランチの削除 (`git branch -D`)
   - GitHub Issue のクローズ (`gh issue close`)

2. **ブランチ切り替え前のコミット漏れ**: フェーズ更新後、`git add` と `git commit` を実行する前にブランチを切り替えると、変更が失われる。

3. **仕様書ファイルが作業ブランチにある**: completed フェーズ移行時、仕様書ファイルは作業ブランチに存在するが、develop に切り替えた後は仕様書が見えなくなる。

### 推定される発生シナリオ

1. `/cft:spec phase <id> completed` 実行
2. 仕様書ファイルの phase を "completed" に更新（Edit ツール）
3. **コミットせずに** develop ブランチに切り替え
4. 作業ブランチを削除
5. → 変更がコミットされていないため、仕様書は review のまま

---

## 6. 対象ユーザー

cc-craft-kit を使用してプロジェクト管理を行う開発者

---

## 7. 設計詳細

### 7.1 修正対象ファイル

- `.claude/commands/cft/spec.md` の「サブコマンド: phase」セクション

### 7.2 修正内容

**Step 6: 自動コミット** と **Step 7: フェーズ固有の後処理** の順序を明確化し、コミットが確実に実行されるようにする。

#### 現状の問題点

現在の spec.md では以下の順序で処理が記述されている:
1. Step 5: 仕様書ファイル更新
2. Step 6: 自動コミット
3. Step 7: フェーズ固有の後処理（completed の場合はブランチ切り替え・削除）

しかし、プロンプトベースの実装では、Claude Code がこの順序を厳密に守らない場合がある。

#### 修正案

completed フェーズの後処理について、以下の順序を明示的に強調する:

```markdown
**completed フェーズ:**

**重要**: 以下の順序で必ず実行すること。順序を変えてはならない。

1. **まず仕様書ファイルの変更をコミット**:
   ```bash
   git add ".cc-craft-kit/specs/$SPEC_ID.md"
   git commit -m "feat: $SPEC_NAME を完了"
   ```

2. **次にベースブランチに切り替え**:
   ```bash
   git checkout develop
   git pull origin develop
   ```

3. **最後にローカル作業ブランチを削除**:
   ```bash
   git branch -D "$BRANCH_NAME"
   ```

4. **GitHub Issue がある場合はクローズ**:
   ```bash
   gh issue close $GITHUB_ISSUE_NUMBER --comment "✅ 仕様書が完了しました"
   ```
```

### 7.3 受け入れ基準

- [ ] `/cft:spec phase <id> completed` 実行後、仕様書の phase が "completed" に更新されている
- [ ] 変更が git に正しくコミットされている
- [ ] develop ブランチに正常に切り替わっている

---

## 8. 実装タスクリスト

- [ ] `.claude/commands/cft/spec.md` の completed フェーズ後処理セクションを修正
- [ ] コミット順序を明示的に強調する文言を追加
- [ ] 動作確認テスト
