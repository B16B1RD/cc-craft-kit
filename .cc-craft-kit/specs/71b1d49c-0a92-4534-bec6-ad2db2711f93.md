# 本リポジトリの .cc-craft-kit/ に無駄なファイルがある

**仕様書 ID:** 71b1d49c-0a92-4534-bec6-ad2db2711f93
**フェーズ:** implementation
**作成日時:** 2025/12/04 19:18:00
**更新日時:** 2025/12/04 21:16:00

---

## 1. 背景と目的

### 背景

タイトル通りだが、この状況を鑑みるに、他にも無駄なファイルがある気がする。徹底的に調査し、修正する。

### 目的

.cc-craft-kit/ ディレクトリおよびリポジトリ全体から不要なファイルを特定・削除し、プロジェクトの整理と保守性を向上させる。また、今後不要ファイルが蓄積しないよう sync:dogfood のロジックを改善する。

---

## 2. 対象ユーザー

cc-craft-kit を使用・開発する開発者

---

## 3. 受け入れ基準

### 必須要件

- [ ] .cc-craft-kit/ 内の明確な廃棄物ファイル（空の DB ファイル、テストアーカイブ）を削除する
- [ ] src/scripts/ 内の開発用スクリプトを適切に整理する（dev/ サブディレクトリへの移動または削除）
- [ ] sync:dogfood のロジックを修正し、不要な同期・削除サイクルを解消する

### 機能要件

- [ ] .cc-craft-kit/cc-craft-kit-new.db（空ファイル）を削除する
- [ ] .cc-craft-kit/cc-craft-kit-recovered.db（空ファイル）を削除する
- [ ] .cc-craft-kit/test-archive.tar.gz（テスト残骸）を削除する
- [ ] src/scripts/ 内の開発用スクリプト 9 個を src/scripts/dev/ に移動または削除する
- [ ] sync-dogfood.ts から scripts ディレクトリの同期処理を除外または改善する
- [ ] cleanDevScripts() 関数の役割を見直す

### 非機能要件

- [ ] 削除対象ファイルを .gitignore に追加し、今後のコミットを防止する
- [ ] ARCHITECTURE.md を更新し、ディレクトリ構成の明確化を行う

---

## 4. 制約条件

- 既存の仕様書データ（.cc-craft-kit/specs/*.md）は削除対象外とする
- アクティブな DB ファイル（cc-craft-kit.db, cc-craft-kit.db-shm, cc-craft-kit.db-wal）は削除しない
- config.json は GitHub 設定キャッシュとして必要なため削除しない
- sync:dogfood の基本的な動作（src/ → .cc-craft-kit/ への同期）は維持する

---

## 5. 依存関係

- src/scripts/sync-dogfood.ts - 同期ロジックの修正対象
- CLAUDE.md - ディレクトリ構成の記載確認
- docs/ARCHITECTURE.md - 期待されるディレクトリ構造の定義

---

## 6. 参考情報

- sync:dogfood コマンドの実装: src/scripts/sync-dogfood.ts
- 削除対象パターン: add-*, check-*, cleanup-*, close-*, delete-*, fix-*, import-*, migrate-*, monitor-*, rebuild-*, repair-*, run-*, sync-github-*, test-*, update-*
- 発見された不要ファイル:
  - .cc-craft-kit/cc-craft-kit-new.db (0B)
  - .cc-craft-kit/cc-craft-kit-recovered.db (0B)
  - .cc-craft-kit/test-archive.tar.gz (1.7MB)

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
src/scripts/sync-dogfood.ts
         │
         ├─ syncSourceToCcCraftKit()  ← src/ → .cc-craft-kit/
         ├─ syncSlashCommands()       ← src/slash-commands/ → .claude/commands/cft/
         ├─ syncSkills()              ← src/skills/ → .claude/skills/
         ├─ syncAgents()              ← src/agents/ → .claude/agents/
         ├─ cleanDevScripts()         ← 開発スクリプト削除（既存）
         └─ cleanUnusedFiles() [NEW]  ← 不要ファイル削除（新規追加）
                   │
                   ▼
         .cc-craft-kit/
         ├─ cc-craft-kit-new.db       → 削除対象
         ├─ cc-craft-kit-recovered.db → 削除対象
         └─ test-archive.tar.gz       → 削除対象
```

#### 設計方針

1. **既存パターン踏襲**: `cleanDevScripts()` と同様のパターンマッチ削除方式を採用
2. **明示的な削除リスト**: 正規表現ではなく固定のファイル名リストで安全性を確保
3. **dry-run 対応**: 既存の `--dry-run` オプションと連携

#### 処理フロー詳細

```
syncAll()
    │
    ├─ syncSourceToCcCraftKit()
    ├─ syncSlashCommands()
    ├─ syncSkills()
    ├─ syncAgents()
    ├─ cleanDevScripts()        ← scripts/ の開発用スクリプト削除
    └─ cleanUnusedFiles() [NEW] ← .cc-craft-kit/ 直下の不要ファイル削除
           │
           ├─ cc-craft-kit-new.db の削除
           ├─ cc-craft-kit-recovered.db の削除
           └─ test-archive.tar.gz の削除
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/scripts/sync-dogfood.ts` | `cleanUnusedFiles()` 関数の追加、`syncAll()` への統合 |
| `.gitignore` | 不要ファイルパターンの追加 |
| `CLAUDE.md` | `.cc-craft-kit/` ディレクトリ構成の更新 |
| `docs/ARCHITECTURE.md` | ディレクトリ構成の明確化 |

#### cleanUnusedFiles() 関数の仕様

```typescript
// 削除対象ファイルリスト（固定）
const UNUSED_FILES = [
  'cc-craft-kit-new.db',
  'cc-craft-kit-recovered.db',
  'test-archive.tar.gz',
];

async function cleanUnusedFiles(): Promise<number> {
  // .cc-craft-kit/ 直下の上記ファイルを削除
  // dry-run 対応
  // 削除したファイル数を返却
}
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| 空の DB ファイル削除 | なし | `cleanUnusedFiles()` で削除 | `sync-dogfood.ts:480-520` |
| テストアーカイブ削除 | なし | `cleanUnusedFiles()` で削除 | `sync-dogfood.ts:480-520` |
| 不要ファイル再生成防止 | なし | `.gitignore` に追加 | `.gitignore` |
| ドキュメント整備 | 不完全 | 実際の構造を反映 | `CLAUDE.md`, `docs/ARCHITECTURE.md` |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| `cleanUnusedFiles()` | 対象ファイルが削除されること | 手動実行 + ファイル存在確認 |
| dry-run モード | ファイルが削除されないこと | `--dry-run` オプション実行 |
| 既存機能への影響 | `syncAll()` が正常動作すること | `npm run sync:dogfood` 実行 |

### 7.5 移行計画

#### Phase 1: 不要ファイルの削除

1. `.cc-craft-kit/cc-craft-kit-new.db` を削除
2. `.cc-craft-kit/cc-craft-kit-recovered.db` を削除
3. `.cc-craft-kit/test-archive.tar.gz` を削除

#### Phase 2: sync-dogfood.ts の改善

1. `cleanUnusedFiles()` 関数を追加
2. `syncAll()` に `cleanUnusedFiles()` を統合
3. 動作確認

#### Phase 3: 再発防止策

1. `.gitignore` に不要ファイルパターンを追加
2. CLAUDE.md の更新
3. docs/ARCHITECTURE.md の更新

---

## 8. 実装タスクリスト

### Phase 1: 不要ファイルの削除

- [x] .cc-craft-kit/cc-craft-kit-new.db を削除する (#714)
- [x] .cc-craft-kit/cc-craft-kit-recovered.db を削除する (#715)
- [x] .cc-craft-kit/test-archive.tar.gz を削除する (#716)

### Phase 2: sync-dogfood.ts の改善

- [x] cleanUnusedFiles() 関数を追加する (#717)
- [x] syncAll() に cleanUnusedFiles() を統合する (#718)
- [ ] npm run sync:dogfood で動作確認する (#719)

### Phase 3: 再発防止策

- [ ] .gitignore に不要ファイルパターンを追加する (#720)
- [ ] CLAUDE.md のディレクトリ構成を更新する (#721)
- [ ] docs/ARCHITECTURE.md のディレクトリ構成を更新する (#722)
