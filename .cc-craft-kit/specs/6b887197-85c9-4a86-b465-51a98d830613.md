---
id: "6b887197-85c9-4a86-b465-51a98d830613"
name: "Git 自動コミット時のエラーを解消"
phase: "completed"
branch_name: "main"
github_issue_number: null
pr_url: null
created_at: "2025-11-18T19:50:33Z"
updated_at: "2025-11-18T20:05:14Z"
---

# Git 自動コミット時のエラーを解消


## 1. 背景と目的

### 背景

フェーズ変更時の Git 自動コミット機能において、`.cc-craft-kit/specs/<spec-id>.md` をコミットしようとすると、以下のエラーが発生します。

```
Command failed: git add .cc-craft-kit/specs/<spec-id>.md
The following paths are ignored by one of your .gitignore files:
.cc-craft-kit
hint: Use -f if you really want to add them.
```

**根本原因:**
- `.gitignore` で `.cc-craft-kit/` ディレクトリ全体が除外されている（35 行目）
- Git 自動コミット機能（`src/core/workflow/git-integration.ts`）が `.gitignore` を考慮せずに `git add` を実行している
- ドッグフーディング環境では `.cc-craft-kit/` は Git 管理外だが、自動コミット機能がこれを前提としていない

### 目的

Git 自動コミット機能を改善し、`.gitignore` で除外されたファイルに対してエラーを発生させない設計に変更します。

**具体的な改善:**
1. `git add` 実行前に、対象ファイルが `.gitignore` で除外されているかをチェック
2. 除外されている場合は、静かにスキップ（エラー出力なし）
3. コミット対象ファイルが 0 件の場合も、エラーとせずに正常終了
---

## 2. 対象ユーザー

- cc-craft-kit の開発者（ドッグフーディング環境）
- cc-craft-kit をプロジェクトに導入しているユーザー
---

## 3. 受け入れ基準

### 必須要件

- [ ] `.gitignore` で除外されたファイルに対して `git add` を実行した場合、終了コード 0 で終了する
- [ ] フェーズ変更時の Git 自動コミット機能が、`.gitignore` を考慮してコミット対象を決定し、除外されたファイルのみの場合は「コミット対象なし」のログを出力する
- [ ] コミット対象ファイルが 0 件の場合、`{ success: true, skipped: true }` を返し、エラーログを出力しない

### 機能要件（テストケース付き）

- [ ] `git check-ignore` コマンドで対象ファイルが除外されているかをチェックする
  - **テスト**: `.gitignore` に記載された `.cc-craft-kit/` ファイルが除外されることを検証
- [ ] 除外されているファイルはコミット対象から除外し、警告やエラーを出力しない
  - **テスト**: `.cc-craft-kit/specs/*.md` のみのコミット時、`skipped: true` が返される
- [ ] コミット対象ファイルが存在する場合のみ、`git add` と `git commit` を実行する
  - **テスト**: completed フェーズでの全ファイルコミットが正常に実行される
- [ ] 既存の Git 自動コミット機能の動作（completed フェーズでの全ファイルコミット）を維持する
  - **テスト**: リグレッションテストで既存動作を検証
- [ ] シェルインジェクション攻撃を防ぐ
  - **テスト**: 悪意のあるファイル名 (`$(whoami)`, `; rm -rf /`) での動作検証
- [ ] パストラバーサル攻撃を防ぐ
  - **テスト**: `specId = '../../../etc/passwd'` でバリデーションエラーがスローされる

### 非機能要件

- [ ] Git コマンドの終了コードを適切にハンドリングし、エラーと正常終了を区別する
  - `git check-ignore` の終了コード 0（除外あり）、1（除外なし）、128 以上（エラー）を正しく処理
- [ ] ログ出力が適切で、以下の情報を含む:
  - コミット対象ファイル数
  - 除外されたファイル数（デバッグログ）
  - スキップ理由（コミット対象なし）
- [ ] パフォーマンス: 10 ファイル以下の場合、Git コマンド実行時間が 1 秒以内
---

## 4. 制約条件

- Git コマンドが利用可能な環境であること
- `.gitignore` ファイルが存在し、適切に設定されていること
- 既存の Git 自動コミット機能のワークフロー（イベント駆動）を維持すること
---

## 5. 依存関係

### コードレベル

- `src/core/workflow/git-integration.ts` - Git 自動コミット機能の実装
- `src/core/workflow/event-bus.ts` - イベント駆動アーキテクチャ
- `src/core/errors/error-handler.ts` - エラーハンドリング
- `node:child_process` - `spawnSync` による安全なコマンド実行
- `node:path` - パストラバーサル対策

### システムレベル

- Git 2.x 以上（`git check-ignore` コマンドサポート）
- `.gitignore` ファイルが存在し、適切に設定されていること
- ファイルシステムへの書き込み権限
---

## 6. 参考情報

### 現在のエラー発生箇所

`src/core/workflow/git-integration.ts:67` の `git add` 実行部分

```typescript
execSync(addCommand, { stdio: 'pipe' });
```

### 改善案（セキュリティ対策版）

**重要:** `execSync` による文字列補間は**シェルインジェクション脆弱性**のリスクがあるため、`spawnSync` を使用します。

```typescript
import { spawnSync } from 'node:child_process';
import path from 'node:path';

/**
 * ファイルが .gitignore で除外されているかチェック
 */
function getIgnoredFiles(files: string[]): string[] {
  if (files.length === 0) return [];

  const result = spawnSync('git', ['check-ignore', ...files], {
    encoding: 'utf-8',
    stdio: ['ignore', 'pipe', 'pipe'],
  });

  // 終了コード 0: 除外されたファイルがある
  // 終了コード 1: 除外されたファイルがない（正常）
  // 終了コード 128以上: Gitエラー
  if (result.status !== null && result.status >= 128) {
    throw new Error(`git check-ignore failed: ${result.stderr}`);
  }

  return result.stdout.trim().split('\n').filter(Boolean);
}

/**
 * コミット対象ファイルの決定（パストラバーサル対策版）
 */
function getCommitTargets(phase: Phase, specId: string): string[] {
  // specIdのバリデーション（UUID形式）
  const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
  if (!uuidPattern.test(specId)) {
    throw new Error(`Invalid spec ID format: ${specId}`);
  }

  if (phase === 'completed') {
    return ['.'];
  }

  // パストラバーサル対策
  const safeSpecId = path.basename(specId);
  return [`.cc-craft-kit/specs/${safeSpecId}.md`];
}

/**
 * Gitコミット実行（セキュリティ対策版）
 */
async function gitCommit(
  files: string[],
  message: string
): Promise<{ success: boolean; skipped?: boolean; error?: string }> {
  try {
    // git add . の場合は特別処理
    if (files.length === 1 && files[0] === '.') {
      const addResult = spawnSync('git', ['add', '.'], {
        stdio: ['ignore', 'pipe', 'pipe'],
      });

      if (addResult.status !== 0) {
        return { success: false, error: addResult.stderr.toString() };
      }
    } else {
      // .gitignore チェック
      const ignoredFiles = new Set(getIgnoredFiles(files));
      const filesToAdd = files.filter(file => !ignoredFiles.has(file));

      if (filesToAdd.length === 0) {
        // コミット対象なし、正常終了
        return { success: true, skipped: true };
      }

      // git add 実行（シェルインジェクション対策）
      const addResult = spawnSync('git', ['add', ...filesToAdd], {
        stdio: ['ignore', 'pipe', 'pipe'],
      });

      if (addResult.status !== 0) {
        return { success: false, error: addResult.stderr.toString() };
      }
    }

    // git commit 実行（エスケープ不要）
    const commitResult = spawnSync('git', ['commit', '-m', message], {
      stdio: ['ignore', 'pipe', 'pipe'],
    });

    if (commitResult.status !== 0) {
      return { success: false, error: commitResult.stderr.toString() };
    }

    return { success: true };
  } catch (error) {
    const errorMessage = error instanceof Error ? error.message : String(error);
    return { success: false, error: errorMessage };
  }
}
```

### Git コマンドリファレンス

- `git check-ignore <file>`: ファイルが `.gitignore` で除外されているかチェック
- `git add`: ステージングエリアにファイルを追加
---

## 7. セキュリティ考慮事項

### シェルインジェクション対策

**問題:** 現在の実装（`execSync` による文字列補間）では、ファイル名に悪意のあるコマンドが含まれている場合、シェルインジェクション攻撃が可能です。

**攻撃例:**
```typescript
const files = [".cc-craft-kit/specs/$(rm -rf /).md"];
execSync(`git add ${files.join(' ')}`);
// → サブシェルで rm -rf / が実行される危険性
```

**対策:**
- `execSync` の代わりに `spawnSync` を使用し、配列形式の引数で Git コマンドを実行
- ファイルパスはバリデーション後に使用（UUID 形式の検証）
- コミットメッセージはエスケープ不要（配列引数を使用）

### パストラバーサル対策

**問題:** `specId` がユーザー入力から来る場合、`../../../etc/passwd` のような攻撃が可能です。

**対策:**
- `specId` は UUID 形式に限定し、`path.basename()` で安全化
- ファイルパスの正規化を実施（`path.normalize()`）

### テストケース

実装時に以下のセキュリティテストを実施すること:

```typescript
describe('セキュリティテスト', () => {
  it('シェルインジェクション攻撃を防ぐ', async () => {
    const maliciousFiles = ['.cc-craft-kit/$(whoami).md', '; rm -rf /'];
    // 例外がスローされず、コマンドが実行されないことを検証
  });

  it('パストラバーサル攻撃を防ぐ', async () => {
    const maliciousSpecId = '../../../etc/passwd';
    // バリデーションエラーがスローされることを検証
  });
});
```
---

## 8. 実装タスクリスト

### Phase 1: セキュリティ対策（最優先）

- [ ] `getIgnoredFiles` 関数を実装（`git check-ignore` による除外チェック）
  - `spawnSync` を使用してシェルインジェクション対策
  - 終了コード 0（除外あり）、1（除外なし）、128 以上（エラー）を正しく処理
- [ ] `getCommitTargets` 関数に `specId` の UUID バリデーションを追加
  - UUID 形式チェック（正規表現）
  - `path.basename()` によるパストラバーサル対策
- [ ] `gitCommit` 関数を `execSync` から `spawnSync` に置き換え（シェルインジェクション対策）
  - `git add` コマンドを配列形式の引数で実行
  - `git commit` コマンドを配列形式の引数で実行（コミットメッセージのエスケープ不要）

### Phase 2: .gitignore 対応

- [ ] `gitCommit` 関数に `.gitignore` チェック処理を追加
  - `getIgnoredFiles` を呼び出して除外ファイルを取得
  - 除外されていないファイルのみをコミット対象に設定
- [ ] コミット対象 0 件の場合の正常終了処理を実装
  - `{ success: true, skipped: true }` を返す
  - エラーログを出力しない

### Phase 3: テストカバレッジ向上

- [ ] セキュリティテストを作成（シェルインジェクション、パストラバーサル）
  - 悪意のあるファイル名 (`$(whoami)`, `; rm -rf /`) での動作検証
  - `specId = '../../../etc/passwd'` でバリデーションエラーがスローされることを検証
- [ ] 既存機能のリグレッションテストを作成
  - completed フェーズでの全ファイルコミットが正常に実行される
  - `.cc-craft-kit/specs/*.md` のみのコミット時、`skipped: true` が返される

### Phase 4: ログ出力とパフォーマンス

- [ ] ログ出力の改善（コミット対象数、除外数、スキップ理由）
  - デバッグログで除外されたファイル数を出力
  - コミット対象なしの場合、スキップ理由を出力
- [ ] 実装完了後の動作確認（フェーズ変更時のエラーが解消されることを確認）
  - `/cft:spec-phase` コマンドでエラーが発生しないことを検証
  - Git 自動コミット機能が正常に動作することを確認
