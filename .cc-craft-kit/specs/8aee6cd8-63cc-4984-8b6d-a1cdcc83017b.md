# /cft:spec-delete で仕様書に対応する GitHub Issue がクローズされない

**仕様書 ID:** 8aee6cd8-63cc-4984-8b6d-a1cdcc83017b
**フェーズ:** design
**作成日時:** 2025/11/23 16:42:52
**更新日時:** 2025/11/23 16:53:09

---

## 1. 背景と目的

### 背景

何度か修正指示を出しているが一向に直らない。仕様書に対応する GitHub Issue をクローズし、かつその Issue の GitHub Projects のステータスを Done に変更して欲しい。

### 目的

`/cft:spec-delete` コマンドで仕様書を削除した際、関連する GitHub Issue を自動的にクローズし、さらに GitHub Projects のステータスを "Done" に変更することで、仕様管理と GitHub 上の Issue 管理を一貫性のあるものにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者（特に仕様駆動開発を実践し、GitHub Issue と GitHub Projects で進捗管理をしているチーム）

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-delete` コマンド実行時、関連する GitHub Issue が自動的にクローズされること
- [ ] GitHub Issue クローズ時、GitHub Projects のステータスが "Done" に自動的に変更されること
- [ ] GitHub API エラー（404、401、403、500など）発生時も、仕様書の削除処理自体は完了すること

### 機能要件

- [ ] `spec.deleted` イベントハンドラーを実装し、イベント駆動で GitHub Issue クローズ処理を実行すること
- [ ] GitHub Issue クローズ前に、削除理由をコメントとして記録すること（削除日時、フェーズ、仕様書パスを含む）
- [ ] GitHub Projects のステータス変更は、`GitHubProjects.updateProjectStatus()` メソッドを使用すること
- [ ] GitHub Issue クローズ処理は、既存の `GitHubIssues.close()` メソッドを使用すること
- [ ] `github_sync` テーブルから Issue 番号と Project Item ID を取得すること

### 非機能要件

- [ ] GitHub API エラー時は、適切なログレベル（warn/error）でログを記録すること
- [ ] Issue が存在しない（404エラー）場合は、警告を表示して処理を続行すること
- [ ] 認証エラー（401/403）やサーバーエラー（500）の場合は、ユーザーに分かりやすいエラーメッセージを表示すること

---

## 4. 制約条件

### 技術的制約

- EventEmitter2 を使用したイベント駆動アーキテクチャに従うこと
- Octokit REST API および GraphQL API を使用すること
- Kysely の型安全性を維持すること（データベース操作）
- 既存の `GitHubIssues.close()` および `GitHubProjects.updateProjectStatus()` メソッドを再利用すること

### 設計上の制約

- `spec.deleted` イベントハンドラーは `src/core/workflow/github-integration.ts` に実装すること
- `delete.ts` の責務を削減し、削除処理に集中させること
- 既存の `spec.phase_changed` イベントハンドラーとの一貫性を保つこと

---

## 5. 依存関係

### 既存モジュール

- `src/core/workflow/event-bus.ts` - EventBus の初期化とイベントハンドラー登録
- `src/integrations/github/issues.ts` - `GitHubIssues.close()` メソッド
- `src/integrations/github/projects.ts` - `GitHubProjects.updateProjectStatus()` メソッド
- `src/core/database/schema.ts` - `github_sync` テーブルのスキーマ定義
- `src/commands/spec/delete.ts` - 仕様書削除処理（`spec.deleted` イベント発火）

### 既存実装の参考

- `src/core/workflow/github-integration.ts:384-414` - completed フェーズで Issue を自動クローズする実装
- `src/core/workflow/github-integration.ts:236-333` - `spec.phase_changed` イベントで Project ステータスを更新する実装

---

## 6. 参考情報

### コードベース解析結果

- **現在の実装状況**: GitHub Issue クローズ処理は実装済み（`delete.ts:159-234`）だが、GitHub Projects ステータス変更処理が未実装
- **推奨実装方針**: イベント駆動アーキテクチャ（`spec.deleted` イベントハンドラー）を採用し、既存の `spec.phase_changed` イベントハンドラーとの一貫性を保つ

### GitHub API ドキュメント

- [Octokit REST API - Update an issue](https://docs.github.com/en/rest/issues/issues?apiVersion=2022-11-28#update-an-issue)
- [GitHub GraphQL API - updateProjectV2ItemFieldValue](https://docs.github.com/en/graphql/reference/mutations#updateprojectv2itemfieldvalue)
