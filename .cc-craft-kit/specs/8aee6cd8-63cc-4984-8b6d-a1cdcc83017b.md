# /cft:spec-delete で仕様書に対応する GitHub Issue がクローズされない

**仕様書 ID:** 8aee6cd8-63cc-4984-8b6d-a1cdcc83017b
**フェーズ:** tasks
**作成日時:** 2025/11/23 16:42:52
**更新日時:** 2025/11/23 16:55:28

---

## 1. 背景と目的

### 背景

何度か修正指示を出しているが一向に直らない。仕様書に対応する GitHub Issue をクローズし、かつその Issue の GitHub Projects のステータスを Done に変更して欲しい。

### 目的

`/cft:spec-delete` コマンドで仕様書を削除した際、関連する GitHub Issue を自動的にクローズし、さらに GitHub Projects のステータスを "Done" に変更することで、仕様管理と GitHub 上の Issue 管理を一貫性のあるものにする。

---

## 2. 対象ユーザー

cc-craft-kit を使用する開発者（特に仕様駆動開発を実践し、GitHub Issue と GitHub Projects で進捗管理をしているチーム）

---

## 3. 受け入れ基準

### 必須要件

- [ ] `/cft:spec-delete` コマンド実行時、関連する GitHub Issue が自動的にクローズされること
- [ ] GitHub Issue クローズ時、GitHub Projects のステータスが "Done" に自動的に変更されること
- [ ] GitHub API エラー（404、401、403、500など）発生時も、仕様書の削除処理自体は完了すること

### 機能要件

- [ ] `spec.deleted` イベントハンドラーを実装し、イベント駆動で GitHub Issue クローズ処理を実行すること
- [ ] GitHub Issue クローズ前に、削除理由をコメントとして記録すること（削除日時、フェーズ、仕様書パスを含む）
- [ ] GitHub Projects のステータス変更は、`GitHubProjects.updateProjectStatus()` メソッドを使用すること
- [ ] GitHub Issue クローズ処理は、既存の `GitHubIssues.close()` メソッドを使用すること
- [ ] `github_sync` テーブルから Issue 番号と Project Item ID を取得すること

### 非機能要件

- [ ] GitHub API エラー時は、適切なログレベル（warn/error）でログを記録すること
- [ ] Issue が存在しない（404エラー）場合は、警告を表示して処理を続行すること
- [ ] 認証エラー（401/403）やサーバーエラー（500）の場合は、ユーザーに分かりやすいエラーメッセージを表示すること

---

## 4. 制約条件

### 技術的制約

- EventEmitter2 を使用したイベント駆動アーキテクチャに従うこと
- Octokit REST API および GraphQL API を使用すること
- Kysely の型安全性を維持すること（データベース操作）
- 既存の `GitHubIssues.close()` および `GitHubProjects.updateProjectStatus()` メソッドを再利用すること

### 設計上の制約

- `spec.deleted` イベントハンドラーは `src/core/workflow/github-integration.ts` に実装すること
- `delete.ts` の責務を削減し、削除処理に集中させること
- 既存の `spec.phase_changed` イベントハンドラーとの一貫性を保つこと

---

## 5. 依存関係

### 既存モジュール

- `src/core/workflow/event-bus.ts` - EventBus の初期化とイベントハンドラー登録
- `src/integrations/github/issues.ts` - `GitHubIssues.close()` メソッド
- `src/integrations/github/projects.ts` - `GitHubProjects.updateProjectStatus()` メソッド
- `src/core/database/schema.ts` - `github_sync` テーブルのスキーマ定義
- `src/commands/spec/delete.ts` - 仕様書削除処理（`spec.deleted` イベント発火）

### 既存実装の参考

- `src/core/workflow/github-integration.ts:384-414` - completed フェーズで Issue を自動クローズする実装
- `src/core/workflow/github-integration.ts:236-333` - `spec.phase_changed` イベントで Project ステータスを更新する実装

---

## 6. 参考情報

### コードベース解析結果

- **現在の実装状況**: GitHub Issue クローズ処理は実装済み（`delete.ts:159-234`）だが、GitHub Projects ステータス変更処理が未実装
- **推奨実装方針**: イベント駆動アーキテクチャ（`spec.deleted` イベントハンドラー）を採用し、既存の `spec.phase_changed` イベントハンドラーとの一貫性を保つ

### GitHub API ドキュメント

- [Octokit REST API - Update an issue](https://docs.github.com/en/rest/issues/issues?apiVersion=2022-11-28#update-an-issue)
- [GitHub GraphQL API - updateProjectV2ItemFieldValue](https://docs.github.com/en/graphql/reference/mutations#updateprojectv2itemfieldvalue)

---

## 7. 設計詳細

### 7.1. アーキテクチャ設計

本機能は、イベント駆動アーキテクチャに基づき、仕様書削除時の GitHub 連携処理を実装します。

#### 処理フロー

```
/cft:spec-delete コマンド実行
  ↓
delete.ts: GitHub Issue をクローズ（既存実装）
  ↓
delete.ts: spec.deleted イベント発火
  ↓
github-integration.ts: spec.deleted イベントハンドラー（新規実装）
  ↓
GitHub Projects ステータスを "Done" に更新
```

#### 既存実装との一貫性

- `spec.phase_changed` イベントハンドラー（`github-integration.ts:384-414`）と同じパターンを採用
- `GitHubProjects.updateProjectStatus()` と `verifyProjectStatusUpdate()` を再利用
- エラーハンドリングとリトライロジックを統一

#### 設計方針

1. **関心の分離**
   - `delete.ts`: 仕様書削除処理とイベント発火のみに専念
   - `github-integration.ts`: GitHub 連携処理（Issue クローズ、Project ステータス更新）

2. **エラー分離**
   - Issue クローズ失敗: 削除処理を中断（既存実装）
   - Project ステータス更新失敗: 警告を表示して削除処理を続行（新規実装）

3. **冪等性**
   - 同じ仕様書を複数回削除しても安全（404エラーを適切にハンドリング）
   - GitHub API エラー時もデータベースの一貫性を保証

### 7.2. データモデル

#### github_sync テーブル

既存のスキーマを使用します（変更なし）。

```typescript
interface GitHubSync {
  entity_id: string;        // 仕様書ID (spec.id)
  entity_type: 'issue' | 'project' | 'milestone';
  github_id: string;        // Issue番号 (entity_type='issue') / Project Item ID (entity_type='project')
  github_number?: number;   // Issue番号 (entity_type='issue' の場合のみ)
  created_at: string;
  updated_at: string;
}
```

#### 必要なデータ取得

1. **Issue 番号**: `github_sync` テーブルから取得（`entity_type='issue'`）
2. **Project Item ID**: `github_sync` テーブルから取得（`entity_type='project'`）

### 7.3. API 仕様

#### spec.deleted イベント

**イベント名**: `spec.deleted`

**ペイロード**:

```typescript
interface SpecDeletedEvent {
  specId: string;
  data: {
    name: string;
    phase: Phase;
    specPath: string;
    deletedAt: string;
  };
}
```

**発火タイミング**: `delete.ts` で仕様書削除完了後

#### GitHub Projects API

**使用メソッド**:

```typescript
// Project ステータス更新
await projects.updateProjectStatus({
  owner: string,
  projectNumber: number,
  itemId: string,        // Project Item ID (github_sync.github_id)
  status: 'Done'         // 削除時は常に "Done"
});

// ステータス更新検証
await projects.verifyProjectStatusUpdate({
  owner: string,
  projectNumber: number,
  itemId: string,
  expectedStatus: 'Done',
  maxRetries: 3
});
```

### 7.4. セキュリティ考慮事項

#### 認証情報の保護

- `GITHUB_TOKEN` は環境変数（`.env`）から取得
- トークンをログに出力しない
- エラーメッセージにトークンを含めない

#### エラーハンドリング

| エラー | 対応 | ログレベル |
|--------|------|-----------|
| 404 (Issue not found) | 警告を表示して処理続行 | warn |
| 401/403 (認証エラー) | エラーメッセージを表示して処理中断 | error |
| 500 (GitHub API 障害) | エラーメッセージを表示して処理中断 | error |
| その他のエラー | エラーメッセージを表示して処理続行 | warn |

#### レート制限対策

- `verifyProjectStatusUpdate()` のリトライ処理を活用
- レート制限エラー発生時は、適切なメッセージを表示
- 削除処理自体は継続（GitHub 連携は後で手動対応可能）

### 7.5. テスト戦略

#### 単体テスト (`tests/core/workflow/github-integration.test.ts`)

1. **spec.deleted イベントハンドラー**
   - ✅ Project ステータスが "Done" に更新されること
   - ✅ github_sync テーブルから Project Item ID が正しく取得されること
   - ✅ `updateProjectStatus()` が正しいパラメータで呼び出されること
   - ✅ `verifyProjectStatusUpdate()` が実行されること
   - ✅ 検証成功時、成功メッセージが表示されること
   - ✅ 検証失敗時、警告メッセージが表示されること

2. **エラーハンドリング**
   - ✅ 404エラー時、警告を表示して処理を続行すること
   - ✅ 401/403エラー時、エラーメッセージを表示すること
   - ✅ 500エラー時、エラーメッセージを表示すること
   - ✅ レート制限エラー時、警告を表示すること

3. **github_sync テーブルのデータ取得**
   - ✅ Project Item ID が存在する場合、ステータス更新が実行されること
   - ✅ Project Item ID が存在しない場合、ステータス更新がスキップされること

#### 統合テスト (`tests/integrations/github/sync.test.ts`)

1. **仕様書削除から GitHub 連携までの E2E テスト**
   - ✅ `/cft:spec-delete` コマンド実行
   - ✅ spec.deleted イベント発火
   - ✅ GitHub Issue クローズ（既存実装）
   - ✅ GitHub Projects ステータス更新（新規実装）

2. **エラー発生時の動作確認**
   - ✅ GitHub API エラー発生時も、仕様書削除処理が完了すること
   - ✅ エラーログが適切に記録されること

#### モック戦略

- `GitHubClient`: モック化（Octokit の API 呼び出し）
- `GitHubProjects.updateProjectStatus()`: モック化
- `GitHubProjects.verifyProjectStatusUpdate()`: モック化
- データベース: `:memory:` モード

---
