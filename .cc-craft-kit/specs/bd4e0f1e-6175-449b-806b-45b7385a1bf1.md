# ステータスの見直し

**仕様書 ID:** bd4e0f1e-6175-449b-806b-45b7385a1bf1
**フェーズ:** completed
**作成日時:** 2025/12/03 12:00:00
**更新日時:** 2025/12/04 00:15:00

---

## 1. 背景と目的

### 背景

GitHub Projects で Issue を管理するにあたって、Todo→In Progress→In Review→Done としたい。また、デフォルトは英語名称とするが、名称はカスタマイズ可能としたい。

### 目的

GitHub Projects との連携において、ステータスワークフローを「Todo → In Progress → In Review → Done」の 4 段階に拡張し、ステータス名称をカスタマイズ可能にすることで、チームの運用に合わせた柔軟な Issue 管理を実現する。

---

## 2. 対象ユーザー

cc-craft-kit を使用し、GitHub Projects で Issue/仕様書を管理する開発者

---

## 3. 受け入れ基準

### 必須要件

- [x] ステータスが 4 段階（Todo, In Progress, In Review, Done）に対応している
- [x] デフォルトのステータス名称は英語（Todo, In Progress, In Review, Done）
- [x] ステータス名称は config.json でカスタマイズ可能
- [x] 既存の 3 段階ステータス（Todo, In Progress, Done）との後方互換性を維持

### 機能要件

- [x] GitHub Projects 初期化時に利用可能なステータスオプションを自動検出
- [x] Spec フェーズから GitHub ステータスへのマッピングを config.json で設定可能
- [x] In Review ステータスが存在しない Project でも動作する（フォールバック）
- [x] ステータス設定のバリデーション機能

### 非機能要件

- [x] GraphQL クエリのレート制限に配慮（キャッシュ機構）
- [x] 設定変更時に既存 Issue のステータスに影響を与えない

---

## 4. 制約条件

- GitHub Projects V2 API（GraphQL）のみサポート（REST API では非対応）
- ステータスオプション名は GitHub Projects 側の設定に依存（cc-craft-kit 側で新規作成は不可）
- Kysely スキーマの SpecPhase 型は変更しない（内部フェーズと GitHub ステータスは分離）

---

## 5. 依存関係

**既存コンポーネント:**
- `src/integrations/github/phase-status-mapper.ts` - 動的マッピングへ改修
- `src/integrations/github/projects.ts` - ステータスフィールド名のパラメータ化
- `src/integrations/github/sync.ts` - 新マッピング層の利用
- `src/commands/github/init.ts` - ステータス自動検出機能追加
- `.cc-craft-kit/config.json` - statusConfig セクション追加

**新規コンポーネント:**
- `src/core/config/github-status-config.ts` - ステータス設定管理モジュール

---

## 6. 参考情報

- GitHub Projects V2 API ドキュメント
- 既存実装: `src/integrations/github/phase-status-mapper.ts`
- 設定管理パターン: `src/core/config/github-config.ts`

---

## 7. 設計詳細

### 7.1 アーキテクチャ設計

#### 全体構成

```
┌─────────────────────────────────────────────────────────────────┐
│                        cc-craft-kit                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌────────────────────────────────────┐ │
│  │   config.json   │───▶│  GitHubStatusConfigService         │ │
│  │  (statusConfig) │    │  - loadStatusConfig()              │ │
│  └─────────────────┘    │  - validateStatusConfig()          │ │
│                         │  - getAvailableStatuses()          │ │
│                         └───────────────┬────────────────────┘ │
│                                         │                       │
│                                         ▼                       │
│  ┌─────────────────┐    ┌────────────────────────────────────┐ │
│  │ Spec Phase      │───▶│  DynamicStatusMapper               │ │
│  │ (requirements,  │    │  - mapPhaseToStatus(phase)         │ │
│  │  design, impl,  │    │  - isValidStatus(status)           │ │
│  │  completed)     │    └───────────────┬────────────────────┘ │
│  └─────────────────┘                    │                       │
│                                         ▼                       │
│                         ┌────────────────────────────────────┐ │
│                         │  GitHubProjects                    │ │
│                         │  - updateProjectStatus()           │ │
│                         │  - getProjectFields()              │ │
│                         │  - detectAvailableStatuses()       │ │
│                         └───────────────┬────────────────────┘ │
│                                         │                       │
│                                         ▼                       │
│                         ┌────────────────────────────────────┐ │
│                         │  GitHub Projects V2 API (GraphQL)  │ │
│                         └────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 設計方針

1. **設定駆動型マッピング**: ステータスマッピングをハードコードから config.json ベースの動的設定へ移行
2. **後方互換性優先**: 既存の 3 段階ステータスを持つプロジェクトでも動作保証
3. **フォールバック機構**: In Review ステータスが存在しない場合は In Progress へフォールバック
4. **分離原則**: 内部フェーズ（SpecPhase）と外部ステータス（GitHub Projects）を明確に分離

#### 処理フロー詳細

**ステータス更新フロー:**

```
1. spec.phase 更新イベント発火
       │
       ▼
2. GitHubStatusConfigService.loadStatusConfig()
   - config.json から statusConfig 読み込み
   - キャッシュされていればキャッシュを使用
       │
       ▼
3. DynamicStatusMapper.mapPhaseToStatus(phase)
   - フェーズ → ステータス名 変換
   - config.statusMapping を参照
       │
       ▼
4. GitHubProjects.updateProjectStatus()
   - statusFieldName を config から取得
   - 該当ステータスが存在するか確認
   - 存在しない場合はフォールバック処理
       │
       ▼
5. GitHub GraphQL API 呼び出し
```

### 7.2 実装方針

#### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/core/config/github-status-config.ts` | **新規作成**: ステータス設定管理サービス |
| `src/integrations/github/phase-status-mapper.ts` | DynamicStatusMapper クラス追加、既存関数は後方互換として維持 |
| `src/integrations/github/projects.ts` | updateProjectStatus() のパラメータ化、detectAvailableStatuses() 追加 |
| `src/integrations/github/sync.ts` | DynamicStatusMapper を使用するよう更新 |
| `src/commands/github/init.ts` | ステータス自動検出・config.json 更新機能追加 |
| `.cc-craft-kit/config.json` | statusConfig セクションの型定義と初期値 |
| `tests/integrations/github/phase-status-mapper.test.ts` | DynamicStatusMapper のテスト追加 |

#### 新規インターフェース定義

```typescript
// src/core/config/github-status-config.ts

/** フェーズ → ステータス マッピング */
export interface StatusMapping {
  requirements: string;    // デフォルト: "Todo"
  design: string;          // デフォルト: "In Progress"
  tasks: string;           // デフォルト: "In Progress" (非推奨フェーズ)
  implementation: string;  // デフォルト: "In Review"
  completed: string;       // デフォルト: "Done"
}

/** GitHub ステータス設定 */
export interface GitHubStatusConfig {
  statusFieldName: string;           // デフォルト: "Status"
  statusMapping: StatusMapping;      // フェーズ → ステータス名 マッピング
  availableStatuses: string[];       // 利用可能なステータス一覧（自動検出）
  fallbackStatus: string;            // フォールバック先ステータス
  autoDetect: boolean;               // 初期化時に自動検出するか
  cachedAt: string | null;           // キャッシュ日時
}

/** デフォルト設定 */
export const DEFAULT_STATUS_CONFIG: GitHubStatusConfig = {
  statusFieldName: 'Status',
  statusMapping: {
    requirements: 'Todo',
    design: 'In Progress',
    tasks: 'In Progress',
    implementation: 'In Review',
    completed: 'Done',
  },
  availableStatuses: ['Todo', 'In Progress', 'In Review', 'Done'],
  fallbackStatus: 'In Progress',
  autoDetect: true,
  cachedAt: null,
};
```

### 7.3 機能マッピング

| 機能 | 現在の実装 | 新しい実装 | 実装場所 |
|-----|----------|----------|---------|
| ステータスマッピング | 固定 3 段階 | 設定可能 4 段階 | `phase-status-mapper.ts` |
| ステータスフィールド名 | "Status" ハードコード | パラメータ化 | `projects.ts` |
| ステータス検出 | なし | GitHub API から自動検出 | `projects.ts`, `init.ts` |
| 設定管理 | なし | config.json の statusConfig | `github-status-config.ts` |
| フォールバック | なし | In Review → In Progress | `projects.ts` |

### 7.4 テスト戦略

| テスト対象 | テスト内容 | 検証方法 |
|----------|----------|---------|
| GitHubStatusConfigService | 設定読み込み・バリデーション | ユニットテスト |
| DynamicStatusMapper | 4 段階マッピング・カスタムマッピング | ユニットテスト |
| updateProjectStatus() | パラメータ化されたステータス更新 | モックテスト |
| detectAvailableStatuses() | GraphQL レスポンス解析 | モックテスト |
| フォールバック処理 | In Review 未存在時の動作 | 統合テスト |
| 後方互換性 | 既存 3 段階プロジェクトでの動作 | 統合テスト |

### 7.5 移行計画

#### Phase 1: 設定管理モジュール作成

1. `src/core/config/github-status-config.ts` を新規作成
2. インターフェース定義と基本関数実装
3. ユニットテスト作成

#### Phase 2: DynamicStatusMapper 実装

1. `phase-status-mapper.ts` に DynamicStatusMapper クラス追加
2. 既存の `mapPhaseToStatus()` 関数は後方互換として維持
3. テスト追加

#### Phase 3: projects.ts のパラメータ化

1. `updateProjectStatus()` に statusFieldName パラメータ追加
2. `detectAvailableStatuses()` メソッド追加
3. フォールバック処理実装
4. テスト更新

#### Phase 4: GitHub 初期化コマンド拡張

1. `init.ts` でステータス自動検出機能追加
2. config.json への statusConfig 保存
3. 既存設定との整合性確認

#### Phase 5: 同期サービス統合

1. `sync.ts` を DynamicStatusMapper 使用に更新
2. 統合テスト実施

---

## 8. 実装タスクリスト

### Phase 1: 設定管理モジュール作成

- [x] GitHubStatusConfig インターフェースと DEFAULT_STATUS_CONFIG を定義 (#564)
- [x] loadStatusConfig() 関数を実装（config.json から読み込み） (#565)
- [x] validateStatusConfig() 関数を実装（設定値のバリデーション） (#566)
- [x] ユニットテストを作成 (#567)

### Phase 2: DynamicStatusMapper 実装

- [x] DynamicStatusMapper クラスを実装 (#568)
- [x] 既存の mapPhaseToStatus() を後方互換として維持しつつ新クラスへ移行 (#569)
- [x] isValidStatus() 型ガード関数を拡張 (#570)
- [x] DynamicStatusMapper のユニットテストを追加 (#571)

### Phase 3: projects.ts のパラメータ化

- [x] updateProjectStatus() に statusFieldName パラメータを追加 (#572)
- [x] detectAvailableStatuses() メソッドを追加 (#573)
- [x] フォールバック処理を実装（In Review → In Progress） (#574)
- [x] 既存テストを更新・新規テスト追加 (#575)

### Phase 4: GitHub 初期化コマンド拡張

- [x] init.ts でステータス自動検出ロジックを追加 (#576)
- [x] 検出したステータスを config.json に保存 (#577)
- [x] 初期化時のユーザーガイダンスを更新 (#578)

### Phase 5: 同期サービス統合

- [x] sync.ts を DynamicStatusMapper 使用に更新 (#579)
- [x] 統合テストを実施 (#580)
- [x] ドキュメント更新（README、設定例） (#581)
