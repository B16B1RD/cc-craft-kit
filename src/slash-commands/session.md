---
description: "セッション管理（start/end）"
argument-hint: "<subcommand> [spec-id]"
---

# セッション管理コマンド

開発セッションの開始と終了を管理する統合コマンドです。

## サブコマンド

| サブコマンド | 説明 | 使用例 |
|-------------|------|--------|
| `start` | 開発セッションを開始 | `/cft:session start [spec-id]` |
| `end` | 開発セッションを終了 | `/cft:session end [spec-id]` |

---

## サブコマンド: start

開発セッションを開始し、コンテキストを読み込みます。

### 引数

- `$2` (オプション): 仕様書 ID（部分一致可、最低 8 文字）

### 実行フロー（spec-id 指定あり）

#### Step 1: 仕様書解決

Glob + Read で仕様書ファイルを特定し、YAML フロントマターを解析。

#### Step 2: ブランチ切り替え

```bash
git checkout "$BRANCH_NAME"
```

#### Step 3: コンテキスト表示

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚀 セッション開始
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

仕様書: $SPEC_NAME
ID: $SPEC_ID (短縮: ${SPEC_ID:0:8})
フェーズ: $PHASE
ブランチ: $BRANCH_NAME
GitHub Issue: #$GITHUB_ISSUE_NUMBER

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### Step 4: タスクリスト読み込み（implementation フェーズの場合）

仕様書の「## 8. 実装タスクリスト」セクションを読み込み、TodoWrite に登録。

```
📋 タスク一覧

| # | 状態 | タスク |
|---|------|--------|
| 1 | ✓ | タスク 1 |
| 2 | → | タスク 2 (現在) |
| 3 |   | タスク 3 |

進捗: 1/3 完了
```

#### Step 5: 修正対象ファイル表示（design/implementation フェーズの場合）

仕様書の「## 7. 設計詳細 → 7.2 実装方針 → 修正対象ファイル」を表示。

```
📁 修正対象ファイル

- src/core/foo.ts
- src/services/bar.ts
- src/integrations/baz.ts
```

#### Step 6: 次のアクション案内

フェーズに応じた次のアクションを案内:

**requirements フェーズ:**
```
次のステップ:
- 要件を編集: 仕様書ファイルを直接編集
- 設計フェーズへ: /cft:spec phase $SPEC_ID design
```

**design フェーズ:**
```
次のステップ:
- 設計を確認: 仕様書の「## 7. 設計詳細」を確認
- 実装開始: /cft:spec phase $SPEC_ID impl
```

**implementation フェーズ:**
```
次のステップ:
- 現在のタスクを実装
- タスク完了後: /cft:task done <task-number>
- 全タスク完了後: /cft:spec phase $SPEC_ID review
```

**review フェーズ:**
```
次のステップ:
- PR を確認
- レビュー対応
- マージ後: /cft:spec phase $SPEC_ID done
```

### 実行フロー（spec-id 指定なし）

プロジェクト全体の状況を表示。

#### Step 1: 仕様書一覧取得

Glob + Read で全仕様書を取得し、フェーズ別に集計。

#### Step 2: 状況表示

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 プロジェクト状況
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

フェーズ別仕様書数:
- requirements: N 件
- design: N 件
- implementation: N 件
- review: N 件
- completed: N 件

合計: N 件

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

実装中の仕様書:

| ID (短縮) | 名前 | フェーズ |
|-----------|------|---------|
| abc12345 | 機能A | implementation |
| def67890 | 機能B | design |

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

次のステップ:
- 仕様書を選んでセッション開始: /cft:session start <spec-id>
- 新規仕様書作成: /cft:spec create "名前" "説明"
```

---

## サブコマンド: end

開発セッションを終了し、状態を保存します。

### 引数

- `$2` (オプション): 仕様書 ID（部分一致可、最低 8 文字）

### 実行フロー

#### Step 1: 未コミット変更確認

```bash
git status --porcelain
```

#### Step 2: 自動コミット確認（未コミット変更がある場合）

AskUserQuestion ツールで確認:

```
未コミットの変更があります:

[git status の出力]

どうしますか？

オプション:
- 自動コミットして終了
- コミットせずに終了
- キャンセル
```

#### Step 3: 自動コミット（選択時）

```bash
git add -A
git commit -m "wip: セッション終了時の自動コミット"
```

#### Step 4: 進捗サマリー表示

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🏁 セッション終了
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

仕様書: $SPEC_NAME
フェーズ: $PHASE

セッション中の変更:
- コミット数: N
- 変更ファイル数: N

タスク進捗（implementation フェーズの場合）:
- 完了: N/M タスク

次回のセッション再開:
  /cft:session start $SPEC_ID
```

---

## エラーハンドリング

### 仕様書が見つからない

```
❌ 仕様書が見つかりません: $SPEC_ID_PREFIX

確認事項:
- 仕様書 ID は最低 8 文字必要です
- /cft:spec list で仕様書一覧を確認してください
```

### ブランチ切り替え失敗

```
❌ ブランチ切り替えに失敗しました

ブランチ: $BRANCH_NAME

確認事項:
- 未コミットの変更がないか: git status
- 変更をスタッシュ: git stash
- 手動で切り替え: git checkout $BRANCH_NAME
```

---

## 使用例

```bash
# 特定の仕様書でセッション開始
/cft:session start abc12345

# プロジェクト状況確認
/cft:session start

# セッション終了
/cft:session end abc12345
/cft:session end
```
