name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate Structure

    steps:
      - uses: actions/checkout@v4

      - name: Validate required directories exist
        run: |
          echo "Checking required directories..."

          # Check .claude/commands/cft/
          if [ ! -d ".claude/commands/cft" ]; then
            echo "❌ Missing .claude/commands/cft/"
            exit 1
          fi
          echo "✅ .claude/commands/cft/ exists"

          # Check .claude/skills/
          if [ ! -d ".claude/skills" ]; then
            echo "❌ Missing .claude/skills/"
            exit 1
          fi
          echo "✅ .claude/skills/ exists"

          # Check .claude/agents/
          if [ ! -d ".claude/agents" ]; then
            echo "❌ Missing .claude/agents/"
            exit 1
          fi
          echo "✅ .claude/agents/ exists"

          # Check .cc-craft-kit/
          if [ ! -d ".cc-craft-kit" ]; then
            echo "❌ Missing .cc-craft-kit/"
            exit 1
          fi
          echo "✅ .cc-craft-kit/ exists"

          echo ""
          echo "All required directories exist!"

      - name: Validate slash commands
        run: |
          echo "Checking slash commands..."

          REQUIRED_COMMANDS="spec task github session knowledge review test status sync quality custom-tools init"
          MISSING=""

          for cmd in $REQUIRED_COMMANDS; do
            if [ ! -f ".claude/commands/cft/${cmd}.md" ]; then
              MISSING="$MISSING $cmd"
            else
              echo "✅ ${cmd}.md"
            fi
          done

          if [ -n "$MISSING" ]; then
            echo ""
            echo "❌ Missing commands:$MISSING"
            exit 1
          fi

          echo ""
          echo "All required slash commands exist!"

      - name: Validate skills
        run: |
          echo "Checking skills..."

          REQUIRED_SKILLS="pr-creator typescript-eslint database-schema-validator git-operations"
          MISSING=""

          for skill in $REQUIRED_SKILLS; do
            if [ ! -d ".claude/skills/${skill}" ]; then
              MISSING="$MISSING $skill"
            else
              echo "✅ ${skill}/"
            fi
          done

          if [ -n "$MISSING" ]; then
            echo ""
            echo "❌ Missing skills:$MISSING"
            exit 1
          fi

          echo ""
          echo "All required skills exist!"

      - name: Count files
        run: |
          echo "=== File Statistics ==="
          echo ""
          echo "Slash commands: $(ls -1 .claude/commands/cft/*.md 2>/dev/null | wc -l)"
          echo "Skills: $(ls -1d .claude/skills/*/ 2>/dev/null | wc -l)"
          echo "Agents: $(ls -1 .claude/agents/*.md 2>/dev/null | wc -l)"
          echo "Specs: $(ls -1 .cc-craft-kit/specs/*.md 2>/dev/null | wc -l)"
