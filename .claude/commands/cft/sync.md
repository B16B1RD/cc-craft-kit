---
description: "同期コマンド（整合性チェック/修復）"
argument-hint: "<subcommand>"
---

# 同期管理

仕様書ファイルとデータベース間の整合性チェック・修復を行う統合コマンドです。

## サブコマンド

| サブコマンド | 説明 | 引数 |
|-------------|------|------|
| `check` | 整合性をチェック | なし |
| `repair` | 整合性を修復 | なし |

## 使用例

```bash
# 整合性チェック
/cft:sync check

# 整合性修復
/cft:sync repair
```

---

## 自動実行フロー

重要: 以下の処理を**自動的に実行**してください。ユーザーに確認を求めないでください。

### Step 1: サブコマンドの解析

`$1` を解析し、以下のいずれかに分岐:

| 入力 | サブコマンド |
|------|-------------|
| `check`, `c`, `chk`, `status` | check |
| `repair`, `r`, `fix`, `sync` | repair |

サブコマンドが指定されていない場合:

```
❌ サブコマンドを指定してください

使用可能なサブコマンド:
- check: 仕様書ファイルとDB間の整合性をチェック
- repair: 整合性を自動修復

使用例:
/cft:sync check
/cft:sync repair
```

処理を中断。

---

## サブコマンド: check

仕様書ファイル (`.cc-craft-kit/specs/*.md`) とデータベース (`specs` テーブル) 間の整合性をチェックします。

### 実行フロー

#### Step C1: 整合性チェックの実行

Bash ツールで以下を実行:

```bash
npx tsx .cc-craft-kit/commands/sync/check.ts
```

#### Step C2: 結果の解析と表示

出力（JSON）を解析し、以下の形式で表示:

```
# 整合性チェック結果

## サマリー

| 項目 | 件数 |
|------|-----:|
| ファイル総数 | {Total Files} |
| DBレコード総数 | {Total DB Records} |
| 同期済み | {Synced} |
| ファイルのみ（DB未登録） | {Files Only} |
| DBのみ（ファイル削除済み） | {DB Only} |
| メタデータ不一致 | {Mismatch} |

## 同期率

[████████████████████] {Sync Rate}%

{同期率が100%の場合}
✓ すべての仕様書が正常に同期されています

{同期率が100%未満の場合}
⚠️ 整合性に問題があります

### ファイルのみ（DB未登録）
{Files Only のリスト}

### DBのみ（ファイル削除済み）
{DB Only のリスト}

### メタデータ不一致
{Mismatch のリスト}

## 次のアクション

修復が必要な場合:
/cft:sync repair
```

---

## サブコマンド: repair

仕様書ファイルとデータベース間の整合性を自動修復します。

### 修復ルール

| 状態 | 修復アクション |
|------|---------------|
| ファイルのみ存在 | データベースにインポート（新規挿入） |
| DBのみ存在 | 警告表示（手動確認を推奨） |
| メタデータ不一致 | ファイルのデータを優先してDB更新 |

### 実行フロー

#### Step R1: 修復の実行

Bash ツールで以下を実行:

```bash
npx tsx .cc-craft-kit/commands/sync/repair.ts
```

#### Step R2: 結果の解析と表示

出力（JSON）を解析し、以下の形式で表示:

```
# 同期修復結果

## 修復アクション

| アクション | 件数 |
|----------|-----:|
| インポート（新規） | {Imported} |
| 更新（メタデータ） | {Updated} |
| スキップ | {Skipped} |
| 失敗 | {Failed} |

{インポートがある場合}
### インポートされた仕様書
{インポートされた仕様書のリスト}

{更新がある場合}
### 更新された仕様書
{更新された仕様書のリスト}

{失敗がある場合}
### 失敗した仕様書
{失敗した仕様書のリスト}
⚠️ 失敗した仕様書は手動で確認してください

{DBのみ存在するものがある場合}
### 注意: DBのみ存在
以下の仕様書はデータベースにのみ存在し、ファイルが見つかりません:
{DBのみの仕様書リスト}

対処方法:
- 意図的に削除した場合: データベースからも削除してください
- 誤って削除した場合: バックアップから復元してください

## 修復後の同期率

[████████████████████] {Sync Rate}%

{同期率が100%の場合}
✓ すべての仕様書が正常に同期されています

{同期率が100%未満の場合}
⚠️ 一部の仕様書で手動対応が必要です

## 次のアクション

- 整合性を再確認: /cft:sync check
- 仕様書一覧を確認: /cft:spec-list
```

---

## エラーハンドリング

### データベースに接続できない場合

```
❌ データベースに接続できません

確認事項:
- .cc-craft-kit/cc-craft-kit.db ファイルが存在するか確認
- マイグレーションが実行されているか確認: npm run db:migrate
```

### specs ディレクトリが存在しない場合

```
⚠️ 仕様書ディレクトリが見つかりません

ディレクトリ: .cc-craft-kit/specs/

cc-craft-kit を初期化してください:
/cft:init <project-name>
```

### 修復中にエラーが発生した場合

```
⚠️ 一部の仕様書の修復に失敗しました

失敗した仕様書:
- {spec-id}: {エラーメッセージ}

手動で確認・修復してください。
```

---

## 出力指標の説明

| 指標 | 説明 |
|------|------|
| Total Files | `.cc-craft-kit/specs/` ディレクトリ内の `.md` ファイル数 |
| Total DB Records | `specs` テーブルのレコード数 |
| Synced | ファイルとDBで正常に対応している仕様書数 |
| Files Only | ファイルは存在するがDBに未登録の仕様書 |
| DB Only | DBにレコードがあるがファイルが存在しない仕様書 |
| Mismatch | ファイルとDBでメタデータ（名前、フェーズ等）が異なる仕様書 |
| Sync Rate | `Synced / max(Total Files, Total DB Records) * 100` |

---

## 補足

### ファイル優先の理由

整合性修復時にファイルのデータを優先する理由:

1. **バージョン管理**: 仕様書ファイルは Git で管理されており、履歴を追跡可能
2. **可読性**: Markdown ファイルは人間が直接編集・確認しやすい
3. **Single Source of Truth**: ファイルを正とすることで、データの一貫性を保証

### 定期的なチェック推奨

以下のタイミングで整合性チェックを推奨:

- Git ブランチ切り替え後
- 仕様書ファイルの手動編集後
- データベースマイグレーション後
- チーム間での作業同期時
